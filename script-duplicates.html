<!-- script-duplicates.html -->
<script>
  /**
   * @module script-duplicates
   * @description é‡è¤‡å–®å­—è™•ç†æ¨¡çµ„ï¼šè‡ªå‹•è™•ç†é€šçŸ¥ã€é‡è¤‡å–®å­—æ¨¡æ…‹æ¡†ã€
   *   å‰ç«¯è¨˜æ†¶é«”ä¸­è‡ªå‹•åˆä½µ/ä¿ç•™ã€å¾Œç«¯ Google Sheet é‡è¤‡åˆªé™¤èˆ‡åˆä½µã€
   *   è™•ç†çµæœé¡¯ç¤ºèˆ‡å¾ŒçºŒé‡æ–°è¼‰å…¥ã€‚
   *
   * @dependencies script-core.html (FlashcardApp, APP_CONSTANTS)
   * @provides FlashcardApp.prototype: showAutoProcessingNotification,
   *   showDuplicateModal, skipDuplicates, processDuplicatesInMemory,
   *   processAllDuplicates, confirmDuplicateAction, finishDuplicateProcessing ...
   */

  // é‡è¤‡è™•ç†ç›¸é—œï¼ˆå®Œæ•´ç‰ˆæœ¬ï¼‰
  FlashcardApp.prototype.showAutoProcessingNotification = function(results) {
    console.log('é¡¯ç¤ºè‡ªå‹•è™•ç†é€šçŸ¥:', results);
    
    // å‰µå»ºé€šçŸ¥å…ƒç´ 
    var notification = document.createElement('div');
    notification.className = 'auto-processing-notification';
    notification.innerHTML = 
      '<div class="notification-content">' +
        '<h3>âœ… é‡è¤‡å–®å­—å·²è‡ªå‹•è™•ç†</h3>' +
        '<p>åœ¨è¨˜æ†¶é«”ä¸­è™•ç†äº† ' + results.successCount + '/' + results.totalCount + ' å€‹é‡è¤‡å–®å­—</p>' +
        '<p class="memory-notice">ğŸ“ åŸå§‹Google Sheetæœªè¢«ä¿®æ”¹ï¼Œåƒ…åœ¨æœ¬æ¬¡ä½¿ç”¨ä¸­å»é‡</p>' +
        '<button id="close-notification" class="notification-close">Ã—</button>' +
      '</div>';
    
    document.body.appendChild(notification);
    
    var self = this;
    
    // è‡ªå‹•é—œé–‰é€šçŸ¥
    setTimeout(function() {
      notification.classList.add('fade-out');
      setTimeout(function() {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, APP_CONSTANTS.NOTIFICATION_FADE_MS);
    }, APP_CONSTANTS.NOTIFICATION_DURATION_MS);
    
    // æ‰‹å‹•é—œé–‰é€šçŸ¥
    var closeBtn = document.getElementById('close-notification');
    if (closeBtn) {
      closeBtn.addEventListener('click', function() {
        notification.classList.add('fade-out');
        setTimeout(function() {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, APP_CONSTANTS.NOTIFICATION_FADE_MS);
      });
    }
    
    // é¡¯ç¤ºå‹•ç•«
    setTimeout(function() {
      notification.classList.add('show');
    }, 100);
  };
  
  FlashcardApp.prototype.showDuplicateModal = function() {
    console.log('é¡¯ç¤ºé‡è¤‡è™•ç†æ¨¡æ…‹æ¡†');
    
    // æ¸…ç†ä¸­æ–‡èªéŸ³ç­‰å¾…å®šæ™‚å™¨
    if (this.chineseWaitInterval) {
      clearInterval(this.chineseWaitInterval);
      this.chineseWaitInterval = null;
    }
    
    // åœæ­¢ä»»ä½•æ­£åœ¨æ’­æ”¾çš„èªéŸ³
    if (this.speechSynthesis) {
      this.speechSynthesis.cancel();
    }
    
    // æ¸…é™¤ä»»ä½•ç¾æœ‰çš„è¨ˆæ™‚å™¨
    this._clearDisplayTimer();
    
    var modal = document.getElementById('duplicate-words-modal');
    if (modal) {
      // é‡ç½® modal-body çš„ HTML å…§å®¹ç‚ºåŸå§‹ç‹€æ…‹
      var modalBody = modal.querySelector('.modal-body');
      if (modalBody) {
        modalBody.innerHTML = 
          '<div class="duplicate-info">' +
            '<p id="duplicate-summary">æ‰¾åˆ° <span id="duplicate-count">0</span> çµ„é‡è¤‡å–®å­—ï¼Œè«‹é¸æ“‡è™•ç†æ–¹å¼ï¼š</p>' +
          '</div>' +
          '<div class="duplicate-word-container" id="duplicate-word-container">' +
            '<!-- é‡è¤‡å–®å­—é …ç›®å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->' +
          '</div>' +
          '<div class="duplicate-actions" id="duplicate-actions" style="display: none;">' +
            '<div class="current-duplicate-info">' +
              '<h3>è™•ç†å–®å­—ï¼š<strong id="current-duplicate-english"></strong></h3>' +
              '<div id="duplicate-options-container">' +
                '<!-- è™•ç†é¸é …å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->' +
              '</div>' +
            '</div>' +
          '</div>';
      }
      
      // é‡ç½® modal-footer çš„ HTML å…§å®¹ç‚ºåŸå§‹ç‹€æ…‹
      var modalFooter = modal.querySelector('.modal-footer');
      if (modalFooter) {
        modalFooter.innerHTML = 
          '<button id="skip-duplicates" class="secondary-btn">è·³éï¼Œç¨å¾Œè™•ç†</button>' +
          '<button id="process-all-duplicates" class="primary-btn">é–‹å§‹è™•ç†</button>' +
          '<button id="confirm-duplicate-action" class="primary-btn" style="display: none;">ç¢ºèªæ“ä½œ</button>' +
          '<button id="next-duplicate" class="primary-btn" style="display: none;">ä¸‹ä¸€å€‹</button>';
        modalFooter.style.display = '';
      }
      
      openModalById(this, 'duplicate-words-modal');
      
      // æ›´æ–°é‡è¤‡å–®å­—æ•¸é‡
      var duplicateCountElement = document.getElementById('duplicate-count');
      if (duplicateCountElement) {
        duplicateCountElement.textContent = this.duplicateWords.length;
      }
      
      // æ¸²æŸ“é‡è¤‡å–®å­—æ¸…å–®
      this.renderDuplicateWordsList();
      
      this.setupDuplicateModalEvents();
    }
  };
  
  FlashcardApp.prototype.setupDuplicateModalEvents = function() {
    var self = this;
    
    // è·³éè™•ç†æŒ‰éˆ•
    var skipBtn = document.getElementById('skip-duplicates');
    if (skipBtn) {
      skipBtn.addEventListener('click', function() {
        self.skipDuplicates();
      });
    }
    
    // é–‹å§‹è™•ç†æŒ‰éˆ•
    var processBtn = document.getElementById('process-all-duplicates');
    if (processBtn) {
      processBtn.addEventListener('click', function() {
        self.processAllDuplicates();
      });
    }
    
    // ç¢ºèªæ“ä½œæŒ‰éˆ•
    var confirmBtn = document.getElementById('confirm-duplicate-action');
    if (confirmBtn) {
      confirmBtn.addEventListener('click', function() {
        self.confirmDuplicateAction();
      });
    }
    
    // ä¸‹ä¸€å€‹æŒ‰éˆ•
    var nextBtn = document.getElementById('next-duplicate');
    if (nextBtn) {
      nextBtn.addEventListener('click', function() {
        self.nextDuplicate();
      });
    }
    
    // é—œé–‰æŒ‰éˆ•
    var closeBtn = document.getElementById('close-duplicate-modal');
    if (closeBtn) {
      closeBtn.addEventListener('click', function() {
        self.closeDuplicateModal();
      });
    }
  };
  
  FlashcardApp.prototype.closeDuplicateModal = function() {
    closeModalById(this, 'duplicate-words-modal');
  };
  
  // è·³éé‡è¤‡è™•ç†ï¼ˆè‡ªå‹•è™•ç†ï¼‰
  FlashcardApp.prototype.skipDuplicates = function() {
    console.log('è·³éé‡è¤‡è™•ç† - åŸ·è¡Œæœ¬åœ°è‡ªå‹•è™•ç†é‚è¼¯ï¼ˆåƒ…è¨˜æ†¶é«”è™•ç†ï¼‰');
    
    try {
      var result = this.processDuplicatesInMemory(this.words, this.duplicateWords);
        
        if (result.success) {
          // æ›´æ–°ç•¶å‰å–®å­—é™£åˆ—
          this.words = result.processedWords;
          
          // é¡¯ç¤ºæˆåŠŸçµæœ
        var modal = document.getElementById('duplicate-words-modal');
        var modalBody = modal.querySelector('.modal-body');
        var modalFooter = modal.querySelector('.modal-footer');
          modalFooter.style.display = 'none';
          
        var successCount = result.successCount || 0;
        var totalCount = result.totalCount || 0;
        var removedCount = result.removedCount || 0;
        
        modalBody.innerHTML = 
          '<div class="auto-processing-result success">' +
            '<h3>âœ… è‡ªå‹•è™•ç†å®Œæˆï¼</h3>' +
            '<p>æˆåŠŸè™•ç† ' + successCount + '/' + totalCount + ' å€‹é‡è¤‡å–®å­—</p>' +
            '<p>åŸå§‹å–®å­—æ•¸é‡ï¼š' + result.originalCount + 'ï¼Œè™•ç†å¾Œæ•¸é‡ï¼š' + result.processedCount + '</p>' +
            '<p>å·²ç§»é™¤é‡è¤‡é …ç›®ï¼š' + removedCount + ' å€‹</p>' +
            '<p class="sheet-modify-notice">âœ… Google Sheetæœªè¢«ä¿®æ”¹ï¼Œåƒ…åœ¨è¨˜æ†¶é«”ä¸­è™•ç†</p>' +
            '<button id="finish-auto-processing" class="primary-btn">å®Œæˆ</button>' +
          '</div>';
        
        var self = this;
        document.getElementById('finish-auto-processing').addEventListener('click', function() {
          self.closeDuplicateModal();
          self.setupEventListeners();
          self.applySettings();
          self.startNewRound();
          });
        } else {
          throw new Error(result.error || 'è™•ç†å¤±æ•—');
        }
      } catch (error) {
      console.error('æœ¬åœ°è™•ç†å¤±æ•—:', error);
      alert('è‡ªå‹•è™•ç†å¤±æ•—ï¼š' + error.message);
      }
  };
    
  // åœ¨è¨˜æ†¶é«”ä¸­è™•ç†é‡è¤‡å–®å­—
  FlashcardApp.prototype.processDuplicatesInMemory = function(allWords, duplicates) {
      try {
        console.log('åœ¨å‰ç«¯è¨˜æ†¶é«”ä¸­è‡ªå‹•è™•ç†é‡è¤‡å–®å­—ï¼Œç¸½æ•¸:', duplicates.length);
        
      var results = [];
      var wordsToRemove = []; // è¨˜éŒ„è¦å¾è¨˜æ†¶é«”ä¸­ç§»é™¤çš„å–®å­—ID
      var wordsToModify = {}; // è¨˜éŒ„è¦ä¿®æ”¹å®šç¾©çš„å–®å­—IDå’Œæ–°å®šç¾©
      
      for (var i = 0; i < duplicates.length; i++) {
        var duplicate = duplicates[i];
          console.log('è™•ç†é‡è¤‡å–®å­—:', duplicate.english, 'æ˜¯å¦ç›¸åŒå®šç¾©:', duplicate.isSameDefinition);
          
          if (duplicate.isSameDefinition) {
            // ä¸­æ–‡æ„ç¾©ç›¸åŒï¼šä¿ç•™ç¬¬ä¸€å€‹å·¥ä½œè¡¨çš„ï¼Œç§»é™¤å…¶ä»–
          var keepWord = duplicate.words[0];
          var removeWords = duplicate.words.slice(1);
            
            console.log('ç›¸åŒå®šç¾©ï¼Œä¿ç•™ç¬¬ä¸€å€‹å·¥ä½œè¡¨:', keepWord.sheetName);
            
            // è¨˜éŒ„è¦ç§»é™¤çš„å–®å­—ID
          for (var j = 0; j < removeWords.length; j++) {
            wordsToRemove.push(removeWords[j].id);
          }
            
            results.push({
              english: duplicate.english,
              action: 'keep_first',
              success: true,
              keptSheet: keepWord.sheetName,
              removedCount: removeWords.length
            });
          } else {
            // ä¸­æ–‡æ„ç¾©ä¸åŒï¼šåˆä½µå®šç¾©åˆ°ç¬¬ä¸€å€‹å·¥ä½œè¡¨çš„å–®å­—
          var targetWord = duplicate.words[0];
          var mergeWords = duplicate.words.slice(1);
            
            console.log('ä¸åŒå®šç¾©ï¼Œåˆä½µåˆ°ç¬¬ä¸€å€‹å·¥ä½œè¡¨:', targetWord.sheetName);
            
            // æº–å‚™åˆä½µå¾Œçš„å®šç¾©
          var allDefinitions = [];
          for (var k = 0; k < duplicate.words.length; k++) {
            allDefinitions.push((k + 1) + '. ' + duplicate.words[k].chinese.trim());
          }
          var mergedDefinition = allDefinitions.join('\n');
            
            // è¨˜éŒ„è¦ä¿®æ”¹çš„å–®å­—
          wordsToModify[targetWord.id] = mergedDefinition;
            
            // è¨˜éŒ„è¦ç§»é™¤çš„å–®å­—ID
          for (var l = 0; l < mergeWords.length; l++) {
            wordsToRemove.push(mergeWords[l].id);
          }
            
            results.push({
              english: duplicate.english,
              action: 'merge_to_first',
              success: true,
              targetSheet: targetWord.sheetName,
              mergedDefinition: mergedDefinition,
              removedCount: mergeWords.length
            });
          }
        }
        
        // è™•ç†å–®å­—é™£åˆ—ï¼šç§»é™¤é‡è¤‡é …ç›®ä¸¦ä¿®æ”¹å®šç¾©
      var processedWords = [];
      for (var m = 0; m < allWords.length; m++) {
        var word = allWords[m];
        
        if (wordsToRemove.indexOf(word.id) !== -1) {
            // è·³éè¦ç§»é™¤çš„å–®å­—
            continue;
          }
          
        if (wordsToModify.hasOwnProperty(word.id)) {
            // ä¿®æ”¹å®šç¾©
          var modifiedWord = {};
          for (var key in word) {
            if (word.hasOwnProperty(key)) {
              modifiedWord[key] = word[key];
            }
          }
          modifiedWord.chinese = wordsToModify[word.id];
            processedWords.push(modifiedWord);
          } else {
            // ä¿æŒåŸæ¨£
            processedWords.push(word);
          }
        }
        
      var successCount = results.filter(function(r) { return r.success; }).length;
      var removedCount = wordsToRemove.length;
        
        return {
          success: true,
          results: results,
          successCount: successCount,
        totalCount: duplicates.length,
        removedCount: removedCount,
          originalCount: allWords.length,
          processedCount: processedWords.length,
        processedWords: processedWords
        };
      
      } catch (error) {
      console.error('è¨˜æ†¶é«”è™•ç†éŒ¯èª¤:', error);
        return {
          success: false,
        error: error.message || 'è™•ç†éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤'
      };
    }
  };
  
  // é–‹å§‹è™•ç†æ‰€æœ‰é‡è¤‡
  FlashcardApp.prototype.processAllDuplicates = function() {
    console.log('é–‹å§‹è™•ç†é‡è¤‡');
    if (this.duplicateWords.length > 0) {
      this.currentDuplicateIndex = 0;
      this.duplicateProcessingResults = [];
      this.selectDuplicateWord(0);
    }
  };
  
  // æ¸²æŸ“é‡è¤‡å–®å­—æ¸…å–®
  FlashcardApp.prototype.renderDuplicateWordsList = function() {
    var container = document.getElementById('duplicate-word-container');
    if (!container) return;
    
    container.innerHTML = '';
    
    for (var i = 0; i < this.duplicateWords.length; i++) {
      var duplicate = this.duplicateWords[i];
      var wordItem = document.createElement('div');
      wordItem.className = 'duplicate-word-item';
      wordItem.setAttribute('data-index', i);
      
      var wordHeader = document.createElement('div');
      wordHeader.className = 'duplicate-word-header';
      wordHeader.innerHTML = '<strong>' + duplicate.english + '</strong> (' + 
        (duplicate.isSameDefinition ? 'ç›¸åŒå®šç¾©' : 'ä¸åŒå®šç¾©') + ')';
      
      var wordSources = document.createElement('div');
      wordSources.className = 'duplicate-word-sources';
      
      for (var j = 0; j < duplicate.words.length; j++) {
        var word = duplicate.words[j];
        var sourceItem = document.createElement('div');
        sourceItem.className = 'duplicate-source-item';
        sourceItem.innerHTML = '<span class="source-sheet">' + word.sheetName + '</span>: ' + word.chinese;
        wordSources.appendChild(sourceItem);
      }
      
      wordItem.appendChild(wordHeader);
      wordItem.appendChild(wordSources);
      
      var self = this;
      (function(index) {
        wordItem.addEventListener('click', function() {
          self.selectDuplicateWord(index);
        });
      })(i);
      
      container.appendChild(wordItem);
    }
  };
  
  // é¸æ“‡è¦è™•ç†çš„é‡è¤‡å–®å­—
  FlashcardApp.prototype.selectDuplicateWord = function(index) {
    console.log('é¸æ“‡é‡è¤‡å–®å­—ï¼Œç´¢å¼•:', index);
    
    // æ¸…é™¤ä¹‹å‰çš„é¸ä¸­ç‹€æ…‹
    var items = document.querySelectorAll('.duplicate-word-item');
    for (var i = 0; i < items.length; i++) {
      items[i].classList.remove('selected');
    }
    
    // é¸ä¸­ç•¶å‰é …ç›®
    var selectedItem = document.querySelector('[data-index="' + index + '"]');
    if (selectedItem) {
      selectedItem.classList.add('selected');
    }
    
    this.currentDuplicateIndex = index;
    
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    var processBtn = document.getElementById('process-all-duplicates');
    var confirmBtn = document.getElementById('confirm-duplicate-action');
    var nextBtn = document.getElementById('next-duplicate');
    
    if (processBtn) processBtn.style.display = 'none';
    if (confirmBtn) {
      confirmBtn.style.display = 'inline-block';
      confirmBtn.disabled = false;
      confirmBtn.textContent = 'ç¢ºèªæ“ä½œ';
    }
    if (nextBtn) nextBtn.style.display = 'none';
    
    // é¡¯ç¤ºè™•ç†é¸é …
    this.showDuplicateOptions(this.duplicateWords[index]);
  };
  
  // é¡¯ç¤ºé‡è¤‡å–®å­—è™•ç†é¸é …
  FlashcardApp.prototype.showDuplicateOptions = function(duplicate) {
    var actionsDiv = document.getElementById('duplicate-actions');
    var englishSpan = document.getElementById('current-duplicate-english');
    var optionsContainer = document.getElementById('duplicate-options-container');
    
    if (!englishSpan || !optionsContainer) return;
    
    englishSpan.textContent = duplicate.english;
    optionsContainer.innerHTML = '';
    actionsDiv.style.display = 'block';
    
    if (duplicate.isSameDefinition) {
      // å®šç¾©ç›¸åŒï¼šé¸æ“‡ä¿ç•™å“ªä¸€å€‹
      var keepOption = document.createElement('div');
      keepOption.className = 'duplicate-option';
      keepOption.innerHTML = 
        '<div class="option-header">' +
          '<input type="radio" name="duplicate-action" value="keep" class="option-radio" checked>' +
          '<span class="option-title">ä¿ç•™å…¶ä¸­ä¸€å€‹ï¼Œåˆªé™¤å…¶ä»–</span>' +
        '</div>' +
        '<div class="option-description">é¸æ“‡è¦ä¿ç•™çš„å·¥ä½œè¡¨ç‰ˆæœ¬ï¼Œå…¶ä»–ç‰ˆæœ¬å°‡è¢«æ°¸ä¹…åˆªé™¤</div>' +
        '<div class="merge-target-selection" id="keep-target-selection"></div>';
      
      var targetSelection = keepOption.querySelector('#keep-target-selection');
      for (var i = 0; i < duplicate.words.length; i++) {
        var word = duplicate.words[i];
        var targetOption = document.createElement('div');
        targetOption.className = 'merge-target-option';
        targetOption.innerHTML = 
          '<input type="radio" name="keep-target" value="' + i + '" class="merge-target-radio" ' + 
          (i === 0 ? 'checked' : '') + '>' +
          '<span class="merge-target-label">ä¿ç•™ ' + word.sheetName + ': ' + word.chinese + '</span>';
        
        (function(option) {
          targetOption.addEventListener('click', function(e) {
            if (e.target.type !== 'radio') {
              var radio = option.querySelector('input[type="radio"]');
              if (radio) radio.checked = true;
            }
          });
        })(targetOption);
        
        targetSelection.appendChild(targetOption);
      }
      
      optionsContainer.appendChild(keepOption);
          } else {
      // å®šç¾©ä¸åŒï¼šä¿ç•™ä¸€å€‹æˆ–åˆä½µ
      var keepOption = document.createElement('div');
      keepOption.className = 'duplicate-option';
      keepOption.innerHTML = 
        '<div class="option-header">' +
          '<input type="radio" name="duplicate-action" value="keep" class="option-radio" checked>' +
          '<span class="option-title">ä¿ç•™å…¶ä¸­ä¸€å€‹ï¼Œåˆªé™¤å…¶ä»–</span>' +
        '</div>' +
        '<div class="option-description">é¸æ“‡è¦ä¿ç•™çš„å·¥ä½œè¡¨ç‰ˆæœ¬ï¼Œå…¶ä»–ç‰ˆæœ¬å°‡è¢«æ°¸ä¹…åˆªé™¤</div>' +
        '<div class="merge-target-selection" id="keep-target-selection"></div>';
      
      var targetSelection = keepOption.querySelector('#keep-target-selection');
      for (var j = 0; j < duplicate.words.length; j++) {
        var word = duplicate.words[j];
        var targetOption = document.createElement('div');
        targetOption.className = 'merge-target-option';
        targetOption.innerHTML = 
          '<input type="radio" name="keep-target" value="' + j + '" class="merge-target-radio" ' + 
          (j === 0 ? 'checked' : '') + '>' +
          '<span class="merge-target-label">ä¿ç•™ ' + word.sheetName + ': ' + word.chinese + '</span>';
        
        (function(option) {
          targetOption.addEventListener('click', function(e) {
            if (e.target.type !== 'radio') {
              var radio = option.querySelector('input[type="radio"]');
              if (radio) radio.checked = true;
            }
          });
        })(targetOption);
        
        targetSelection.appendChild(targetOption);
      }
      
      var mergeOption = document.createElement('div');
      mergeOption.className = 'duplicate-option';
      mergeOption.innerHTML = 
        '<div class="option-header">' +
          '<input type="radio" name="duplicate-action" value="merge" class="option-radio">' +
          '<span class="option-title">åˆä½µæ‰€æœ‰å®šç¾©</span>' +
        '</div>' +
        '<div class="option-description">å°‡æ‰€æœ‰å®šç¾©åˆä½µåˆ°é¸å®šçš„å·¥ä½œè¡¨ä¸­ï¼Œå…¶ä»–ç‰ˆæœ¬å°‡è¢«åˆªé™¤</div>' +
        '<div class="merge-target-selection" id="merge-target-selection"></div>';
      
      var mergeTargetSelection = mergeOption.querySelector('#merge-target-selection');
      for (var k = 0; k < duplicate.words.length; k++) {
        var word = duplicate.words[k];
        var targetOption = document.createElement('div');
        targetOption.className = 'merge-target-option';
        targetOption.innerHTML = 
          '<input type="radio" name="merge-target" value="' + k + '" class="merge-target-radio" ' + 
          (k === 0 ? 'checked' : '') + '>' +
          '<span class="merge-target-label">åˆä½µåˆ° ' + word.sheetName + '</span>';
        
        (function(option) {
          targetOption.addEventListener('click', function(e) {
            if (e.target.type !== 'radio') {
              var radio = option.querySelector('input[type="radio"]');
              if (radio) radio.checked = true;
            }
          });
        })(targetOption);
        
        mergeTargetSelection.appendChild(targetOption);
      }
      
      optionsContainer.appendChild(keepOption);
      optionsContainer.appendChild(mergeOption);
    }
  };
    
    // ç¢ºèªè™•ç†ç•¶å‰é‡è¤‡é …ç›®
  FlashcardApp.prototype.confirmDuplicateAction = function() {
    var confirmBtn = document.getElementById('confirm-duplicate-action');
      if (confirmBtn && confirmBtn.disabled) {
        console.log('è™•ç†å·²åœ¨é€²è¡Œä¸­ï¼Œå¿½ç•¥é‡è¤‡èª¿ç”¨');
        return;
      }
  
    console.log('ç¢ºèªè™•ç†é‡è¤‡å–®å­—');
      
    var duplicate = this.duplicateWords[this.currentDuplicateIndex];
    var actionRadio = document.querySelector('input[name="duplicate-action"]:checked');
      
      if (!actionRadio) {
        alert('è«‹é¸æ“‡è™•ç†æ–¹å¼');
        return;
      }
      
    var action = actionRadio.value;
    var targetIndex = 0;
      
      if (action === 'keep') {
      var targetRadio = document.querySelector('input[name="keep-target"]:checked');
        if (targetRadio) {
          targetIndex = parseInt(targetRadio.value);
        }
      } else if (action === 'merge') {
      var targetRadio = document.querySelector('input[name="merge-target"]:checked');
        if (targetRadio) {
          targetIndex = parseInt(targetRadio.value);
        }
      }
      
      // é¡¯ç¤ºè™•ç†ä¸­ç‹€æ…‹
      this.showProcessingIndicator();
      
      // æº–å‚™è™•ç†åƒæ•¸
    var targetWord = duplicate.words[targetIndex];
    var otherWords = duplicate.words.filter(function(word, index) { return index !== targetIndex; });
      
      console.log('ç›®æ¨™å–®å­—:', targetWord);
      console.log('è¦åˆªé™¤çš„å–®å­—:', otherWords);
      
      // è¨­ç½®è¶…æ™‚æ©Ÿåˆ¶ï¼Œé˜²æ­¢æ°¸ä¹…å¡ä½
    var self = this;
    var timeoutId = setTimeout(function() {
        console.error('è™•ç†è¶…æ™‚');
      self.showProcessingResult(false, 'è™•ç†è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥å¾Œé‡è©¦');
      }, APP_CONSTANTS.DUPLICATE_TIMEOUT_MS);
      
      // å®šç¾©æˆåŠŸè™•ç†å‡½æ•¸
    var handleSuccess = function(result) {
        clearTimeout(timeoutId);
        console.log('è™•ç†æˆåŠŸå›èª¿è¢«è§¸ç™¼ï¼Œçµæœ:', result);
      
      var isSuccess = false;
      var deletedCount = 0;
      var errorMessage = '';
        
        if (result === true || result === 'true') {
          isSuccess = true;
          deletedCount = otherWords.length;
        } else if (result && typeof result === 'object') {
          isSuccess = result.success === true || result.success === 'true';
          deletedCount = result.deletedCount || otherWords.length;
          errorMessage = result.error || '';
        } else if (result && result.toString().toLowerCase() === 'success') {
          isSuccess = true;
          deletedCount = otherWords.length;
        } else {
          console.warn('æœªçŸ¥çš„çµæœæ ¼å¼ï¼Œå˜—è©¦è§£æ:', result);
        isSuccess = !!result;
          deletedCount = isSuccess ? otherWords.length : 0;
        }
        
        console.log('è§£æå¾Œçš„çµæœ - æˆåŠŸ:', isSuccess, 'åˆªé™¤æ•¸é‡:', deletedCount);
        
        if (isSuccess) {
        var message = action === 'merge' 
          ? 'æˆåŠŸåˆä½µåˆ° ' + targetWord.sheetName + 'ï¼Œåˆªé™¤äº† ' + deletedCount + ' å€‹é‡è¤‡é …ç›®'
          : 'æˆåŠŸä¿ç•™ ' + targetWord.sheetName + ' ä¸­çš„å–®å­—ï¼Œåˆªé™¤äº† ' + deletedCount + ' å€‹é‡è¤‡é …ç›®';
        
        self.showProcessingResult(true, message);
        self.duplicateProcessingResults.push({
          duplicate: self.duplicateWords[self.currentDuplicateIndex],
            action: action,
            success: true,
            result: { success: true, deletedCount: deletedCount }
          });
        } else {
        var failureMessage = errorMessage || 'è™•ç†çµæœæ ¼å¼éŒ¯èª¤æˆ–æœªæˆåŠŸ';
        self.showProcessingResult(false, failureMessage);
        self.duplicateProcessingResults.push({
          duplicate: self.duplicateWords[self.currentDuplicateIndex],
            action: action,
            success: false,
            error: failureMessage
          });
        }
      };
      
      // å®šç¾©å¤±æ•—è™•ç†å‡½æ•¸
    var handleFailure = function(error) {
        clearTimeout(timeoutId);
        console.error('è™•ç†å¤±æ•—:', error);
        
      var errorMessage = error && error.message ? error.message : 'æœªçŸ¥éŒ¯èª¤';
      self.showProcessingResult(false, 'è™•ç†å¤±æ•—ï¼š' + errorMessage);
      self.duplicateProcessingResults.push({
        duplicate: self.duplicateWords[self.currentDuplicateIndex],
          action: action,
          success: false,
          error: errorMessage
        });
      };
      
      // æª¢æŸ¥å¿…è¦çš„åƒæ•¸
      if (!this.sheetSettings.sheetId) {
        handleFailure(new Error('Google Sheet ID æœªè¨­å®š'));
        return;
      }
      
      if (!targetWord || !targetWord.sheetName) {
        handleFailure(new Error('ç›®æ¨™å–®å­—è³‡æ–™ä¸å®Œæ•´'));
        return;
      }
      
      // æª¢æŸ¥ Google Apps Script æ˜¯å¦å¯ç”¨
      if (typeof google === 'undefined' || !google.script || !google.script.run) {
        handleFailure(new Error('Google Apps Script ç’°å¢ƒä¸å¯ç”¨'));
        return;
      }
      
      try {
        if (action === 'keep') {
          // ä¿ç•™ä¸€å€‹ï¼Œåˆªé™¤å…¶ä»–
          console.log('èª¿ç”¨ handleDuplicateWordKeepOne');
          google.script.run
            .withSuccessHandler(handleSuccess)
            .withFailureHandler(handleFailure)
            .handleDuplicateWordKeepOne(this.sheetSettings.sheetId, targetWord, otherWords);
        } else if (action === 'merge') {
          // åˆä½µå®šç¾©
          console.log('èª¿ç”¨ handleDuplicateWordMerge');
          google.script.run
            .withSuccessHandler(handleSuccess)
            .withFailureHandler(handleFailure)
            .handleDuplicateWordMerge(this.sheetSettings.sheetId, targetWord, otherWords);
        }
      } catch (error) {
        console.error('èª¿ç”¨ Google Apps Script æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        handleFailure(error);
      }
  };
    
    // é¡¯ç¤ºè™•ç†ä¸­æŒ‡ç¤ºå™¨
  FlashcardApp.prototype.showProcessingIndicator = function() {
    var optionsContainer = document.getElementById('duplicate-options-container');
    optionsContainer.innerHTML = 
      '<div class="processing-indicator">' +
        '<div class="processing-spinner"></div>' +
        '<span class="processing-text">è™•ç†ä¸­...</span>' +
      '</div>';
    
    var confirmBtn = document.getElementById('confirm-duplicate-action');
      if (confirmBtn) {
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'è™•ç†ä¸­...';
      }
      
    var nextBtn = document.getElementById('next-duplicate');
      if (nextBtn) {
        nextBtn.style.display = 'none';
      }
  };
    
    // é¡¯ç¤ºè™•ç†çµæœ
  FlashcardApp.prototype.showProcessingResult = function(success, message) {
    var optionsContainer = document.getElementById('duplicate-options-container');
    optionsContainer.innerHTML = 
      '<div class="' + (success ? 'duplicate-result-success' : 'duplicate-result-error') + '">' +
        message +
      '</div>';
    
      if (success) {
      // å¾é‡è¤‡æ¸…å–®ä¸­ç§»é™¤é€™å€‹é …ç›®
        this.duplicateWords.splice(this.currentDuplicateIndex, 1);
        
        // èª¿æ•´ç•¶å‰ç´¢å¼•
        if (this.currentDuplicateIndex >= this.duplicateWords.length) {
          this.currentDuplicateIndex = this.duplicateWords.length - 1;
        }
        
        // é‡æ–°æ¸²æŸ“é‡è¤‡æ¸…å–®
        this.renderDuplicateWordsList();
        
        // æ›´æ–°é‡è¤‡æ•¸é‡é¡¯ç¤º
      var duplicateCount = document.getElementById('duplicate-count');
        if (duplicateCount) {
          duplicateCount.textContent = this.duplicateWords.length;
        }
      }
      
      // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    var confirmBtn = document.getElementById('confirm-duplicate-action');
    var nextBtn = document.getElementById('next-duplicate');
      
    if (confirmBtn) confirmBtn.style.display = 'none';
    if (nextBtn) {
      nextBtn.style.display = 'inline-block';
      nextBtn.disabled = false;
      
      if (this.duplicateWords.length === 0) {
        nextBtn.textContent = 'å®Œæˆè™•ç†';
      } else if (this.currentDuplicateIndex >= this.duplicateWords.length - 1) {
        nextBtn.textContent = 'å®Œæˆè™•ç†';
      } else {
        nextBtn.textContent = 'ä¸‹ä¸€å€‹';
      }
    }
  };
    
    // è™•ç†ä¸‹ä¸€å€‹é‡è¤‡é …ç›®
  FlashcardApp.prototype.nextDuplicate = function() {
    console.log('è™•ç†ä¸‹ä¸€å€‹é‡è¤‡é …ç›®');
      
      if (this.duplicateWords.length === 0 || this.currentDuplicateIndex >= this.duplicateWords.length) {
        this.finishDuplicateProcessing();
      } else {
      var confirmBtn = document.getElementById('confirm-duplicate-action');
      var nextBtn = document.getElementById('next-duplicate');
      
      if (confirmBtn) {
        confirmBtn.style.display = 'inline-block';
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'ç¢ºèªæ“ä½œ';
      }
      if (nextBtn) nextBtn.style.display = 'none';
      
      this.selectDuplicateWord(this.currentDuplicateIndex);
      }
  };
    
    // å®Œæˆé‡è¤‡è™•ç†
  FlashcardApp.prototype.finishDuplicateProcessing = function() {
      console.log('å®Œæˆé‡è¤‡è™•ç†');
      
      // é¡¯ç¤ºè™•ç†æ‘˜è¦
    var successCount = this.duplicateProcessingResults ? 
      this.duplicateProcessingResults.filter(function(r) { return r.success; }).length : 0;
    var totalCount = this.duplicateProcessingResults ? this.duplicateProcessingResults.length : 0;
      
    alert('é‡è¤‡è™•ç†å®Œæˆï¼\næˆåŠŸè™•ç†: ' + successCount + '/' + totalCount + ' å€‹é‡è¤‡é …ç›®');
      
      // é—œé–‰Modal
      this.closeDuplicateModal();
      
      // é‡æ–°è¼‰å…¥å–®å­—ï¼ˆä»¥åæ˜ æ›´æ”¹ï¼‰
      this.reloadWordsAfterDuplicateProcessing();
  };
    
    // é‡è¤‡è™•ç†å¾Œé‡æ–°è¼‰å…¥å–®å­—
  FlashcardApp.prototype.reloadWordsAfterDuplicateProcessing = function() {
      console.log('é‡è¤‡è™•ç†å¾Œé‡æ–°è¼‰å…¥å–®å­—');
      
      // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    var loadingDiv = document.getElementById('loading');
    var flashcardDiv = document.getElementById('flashcard');
    if (loadingDiv) loadingDiv.style.display = 'flex';
    if (flashcardDiv) flashcardDiv.style.display = 'none';
    
    // é‡æ–°è¼‰å…¥å–®å­—
    var self = this;
    this.loadWords(false, function(hasDuplicates) {
      self.setupEventListeners();
      self.applySettings();
      
      if (!hasDuplicates) {
        self.startNewRound();
      }
      
      if (loadingDiv) loadingDiv.style.display = 'none';
      if (flashcardDiv) flashcardDiv.style.display = 'flex';
    });
  };
  
</script>

<!-- script.html -->
<script>
  // ES5兼容版本 FlashcardApp for iPad4
  (function() {
    'use strict';
    
    // ES5 Polyfills
    if (!Array.prototype.forEach) {
      Array.prototype.forEach = function(callback, thisArg) {
        for (var i = 0; i < this.length; i++) {
          callback.call(thisArg, this[i], i, this);
        }
      };
    }
    
    if (!Array.prototype.filter) {
      Array.prototype.filter = function(callback, thisArg) {
        var result = [];
        for (var i = 0; i < this.length; i++) {
          if (callback.call(thisArg, this[i], i, this)) {
            result.push(this[i]);
          }
        }
        return result;
      };
    }
    
    if (!Array.prototype.map) {
      Array.prototype.map = function(callback, thisArg) {
        var result = [];
        for (var i = 0; i < this.length; i++) {
          result.push(callback.call(thisArg, this[i], i, this));
        }
        return result;
      };
    }
    
    if (!Array.prototype.find) {
      Array.prototype.find = function(callback, thisArg) {
        for (var i = 0; i < this.length; i++) {
          if (callback.call(thisArg, this[i], i, this)) {
            return this[i];
          }
        }
        return undefined;
      };
    }
    
    if (!Array.prototype.includes) {
      Array.prototype.includes = function(searchElement) {
        for (var i = 0; i < this.length; i++) {
          if (this[i] === searchElement) {
            return true;
          }
        }
        return false;
      };
    }
  })();
  
  // 全域 FlashcardApp
  function FlashcardApp() {
    // 初始化屬性
    this.words = [];
    this.currentWords = [];
    this.currentIndex = 0;
      this.showingChinese = false;
      this.isTransitioning = false;
      this.isProcessingClick = false;
    this.displayTimer = null;
    this.speechSynthesis = window.speechSynthesis;
    this.removedWords = [];
    this.navigationHistory = [];
      this.pendingRemoval = null;
    this.isPaused = false;
    this.userPaused = false;
    this.pausedTimestamp = null;
    this.remainingTime = 0;
    
    // 語音啟用狀態（適用於舊版瀏覽器）
    this.speechActivated = false;
    this.isLegacyBrowser = false;
    
    // 設定
    this.settings = {
      delayTime: 4.5,
      fontSize: 96,
      reverseMode: false,
      fontFamily: 'system-default',
      delaySpeechInNormalMode: false
    };
    
    // 字型映射表（iPad 4 兼容）
    this.fontFamilyMap = {
      'system-default': "'Microsoft JhengHei', 'PingFang TC', 'Helvetica Neue', Arial, sans-serif",
      'microsoft-yahei': "'Microsoft JhengHei', 'Microsoft YaHei', 'SimHei', 'Arial Unicode MS', Arial, sans-serif",
      'songti': "'STSong', 'SimSun', 'Times New Roman', serif",
      'kaiti': "'STKaiti', 'KaiTi', 'BiauKai', 'Times New Roman', serif",
      'arial': "Arial, 'Helvetica Neue', Helvetica, sans-serif",
      'helvetica': "'Helvetica Neue', Helvetica, Arial, sans-serif",
      'times': "'Times New Roman', Times, serif",
      'courier': "'Courier New', Courier, monospace",
      'verdana': "Verdana, Geneva, sans-serif"
    };
    
    this.voiceSettings = {
      enabled: true,
      rate: 0.8,
      pitch: 1,
      volume: 1,
      lang: 'en-US',
      voiceURI: '',
      japaneseLang: 'ja-JP',
      japaneseVoiceURI: ''
    };
    
    this.sheetSettings = {
      sheetId: '',
      selectedSheets: []
    };
    
    // 功能狀態
    this.difficultWords = [];
    this.showDifficultOnly = false;
    this.availableSheets = [];
    this.listenersSetup = false;
    this.currentSpreadsheetName = null;
    this.duplicateWords = [];
    this.currentDuplicateIndex = 0;
    this.duplicateProcessingResults = [];
    this.progressTimer = null;
    
    // 圖片預加載管理
    this.preloadedImages = {};
    this.currentPreloadingImage = null;

    // 防止螢幕關閉相關
    this.wakeLock = null;
    this.noSleepVideo = null;
    this.keepScreenAwake = false;
    
    // 測驗相關屬性
    this.quizState = {
      isActive: false,
      type: 'quick', // 'quick' or 'full'
      questions: [],
      currentQuestionIndex: 0,
      selectedAnswer: null,
      answers: [],
      score: 0,
      startTime: null,
      endTime: null
    };
    
    // 啟動初始化
    this.init();
  }
  
  // 初始化方法
  FlashcardApp.prototype.init = function() {
    console.log('=== FlashcardApp 初始化開始 (ES5版本) ===');
    try {
      console.log('載入基本設定...');
      this.loadSettings();
      this.loadSheetSettings();
      
      console.log('Sheet 設定:', this.sheetSettings);
      
      // 檢測瀏覽器是否需要語音交互
      this.detectLegacyBrowser();
      
      console.log('設定事件監聽器...');
      this.setupEventListeners();
      
      // 檢查是否有已設定的 Google Sheet
      if (this.sheetSettings.sheetId && this.sheetSettings.selectedSheets.length > 0) {
        console.log('發現已設定的 Google Sheet，載入單字...');
        var self = this;
        this.loadWords(true, function(hasDuplicates) {
          self.handleLoadingComplete(hasDuplicates);
        });
        } else {
        console.log('沒有找到 Google Sheet 設定，顯示設定畫面');
        this.handleLoadingComplete(false, true);
        return;
      }
      
      console.log('=== FlashcardApp 初始化完成 ===');
    } catch (error) {
      console.error('初始化錯誤:', error);
      this.showError();
    }
    
    // 初始化按鈕狀態
    this.updateVoiceButtonState();
    this.updatePauseButtonState();
    
    // 啟用防止螢幕關閉功能
    this.enableKeepScreenAwake();
  };
  
  // 檢測舊版瀏覽器
  FlashcardApp.prototype.detectLegacyBrowser = function() {
    var userAgent = navigator.userAgent;
    var isIOS = /iPad|iPhone|iPod/.test(userAgent);
    var iosVersion = null;
    var isOldChrome = false;
    
    if (isIOS) {
      var match = userAgent.match(/OS (\d+)_/);
      if (match) {
        iosVersion = parseInt(match[1]);
      }
    }
    
    // 檢測舊版Chrome（版本低於80）
    var chromeMatch = userAgent.match(/Chrome\/(\d+)/);
    if (chromeMatch) {
      var chromeVersion = parseInt(chromeMatch[1]);
      isOldChrome = chromeVersion < 80;
    }
    
    // 檢測需要用戶交互才能播放語音的瀏覽器：
    // 1. iPad/iOS 10及以下版本
    // 2. 舊版Chrome（版本低於80）
    // 3. Safari 12及以下版本
    this.isLegacyBrowser = (isIOS && iosVersion && iosVersion <= 10) || 
                          isOldChrome ||
                          userAgent.indexOf('Safari') !== -1 && userAgent.indexOf('Chrome') === -1 && 
                          userAgent.match(/Version\/(\d+)/) && parseInt(userAgent.match(/Version\/(\d+)/)[1]) <= 12;
    
    // 新版瀏覽器自動啟用語音
    if (!this.isLegacyBrowser) {
      this.speechActivated = true;
    }
    
    console.log('瀏覽器檢測結果:', {
      userAgent: userAgent,
      isIOS: isIOS,
      iosVersion: iosVersion,
      isOldChrome: isOldChrome,
      isLegacyBrowser: this.isLegacyBrowser,
      speechActivated: this.speechActivated
    });
  };
  
  // 處理載入完成
  FlashcardApp.prototype.handleLoadingComplete = function(hasDuplicates, shouldOpenSettings) {
    if (this.isLegacyBrowser && !this.speechActivated) {
      // 舊版瀏覽器顯示語音啟用按鈕
      this.showSpeechActivation();
    } else {
      // 新版瀏覽器或已啟用語音，直接進入主畫面
      this.hideLoading();
      this.applySettings();
      
      if (shouldOpenSettings) {
        this.openSheetSettings();
      } else if (!hasDuplicates) {
        this.startNewRound();
      }
    }
  };
  
  // 載入設定
  FlashcardApp.prototype.loadSettings = function() {
    try {
      var savedSettings = JSON.parse(localStorage.getItem('flashcard-settings') || '{}');
      for (var key in savedSettings) {
        if (savedSettings.hasOwnProperty(key) && this.settings.hasOwnProperty(key)) {
          this.settings[key] = savedSettings[key];
        }
      }
      
      var savedVoiceSettings = JSON.parse(localStorage.getItem('flashcard-voice-settings') || '{}');
      for (var key in savedVoiceSettings) {
        if (savedVoiceSettings.hasOwnProperty(key) && this.voiceSettings.hasOwnProperty(key)) {
          this.voiceSettings[key] = savedVoiceSettings[key];
        }
      }
    } catch (e) {
      console.log('載入設定失敗，使用預設值');
    }
  };
  
  // 載入Sheet設定
  FlashcardApp.prototype.loadSheetSettings = function() {
    try {
      var savedSheetSettings = JSON.parse(localStorage.getItem('flashcard-sheet-settings') || '{}');
      for (var key in savedSheetSettings) {
        if (savedSheetSettings.hasOwnProperty(key) && this.sheetSettings.hasOwnProperty(key)) {
          this.sheetSettings[key] = savedSheetSettings[key];
        }
      }
    } catch (e) {
      console.log('載入Sheet設定失敗');
    }
  };
  
  // 儲存設定
  FlashcardApp.prototype.saveSettings = function() {
    localStorage.setItem('flashcard-settings', JSON.stringify(this.settings));
    localStorage.setItem('flashcard-voice-settings', JSON.stringify(this.voiceSettings));
  };
  
  // 儲存Sheet設定
  FlashcardApp.prototype.saveSheetSettings = function() {
    localStorage.setItem('flashcard-sheet-settings', JSON.stringify(this.sheetSettings));
  };
  
  // 應用設定
  FlashcardApp.prototype.applySettings = function() {
    var englishWord = document.getElementById('english-word');
    var chineseWord = document.getElementById('chinese-word');
    var loadingText = document.querySelector('#loading p');
    
    // 應用字體大小
    if (englishWord) englishWord.style.fontSize = this.settings.fontSize + 'px';
    if (chineseWord) chineseWord.style.fontSize = this.settings.fontSize + 'px';
    if (loadingText) loadingText.style.fontSize = this.settings.fontSize + 'px';
    
    // 應用字型
    this.applyFontFamily();
    
    var delaySlider = document.getElementById('delay-setting');
    var fontSizeSlider = document.getElementById('font-size-setting');
    var fontFamilySelect = document.getElementById('font-family-setting');
    var reverseToggle = document.getElementById('reverse-setting');
    var delaySpeechToggle = document.getElementById('delay-speech-setting');
    var delayValue = document.getElementById('delay-value');
    var fontSizeValue = document.getElementById('font-size-value');
    
    if (delaySlider && delayValue) {
      delaySlider.value = this.settings.delayTime;
      // 修復浮點數精度問題
      var step = parseFloat(delaySlider.step) || 0.5;
      var decimalPlaces = step.toString().indexOf('.') !== -1 ? step.toString().split('.')[1].length : 0;
      var formattedDelayTime = parseFloat(this.settings.delayTime.toFixed(decimalPlaces));
      delayValue.textContent = formattedDelayTime;
    }
    if (fontSizeSlider && fontSizeValue) {
      fontSizeSlider.value = this.settings.fontSize;
      fontSizeValue.textContent = this.settings.fontSize + 'px';
    }
    if (fontFamilySelect) {
      fontFamilySelect.value = this.settings.fontFamily;
    }
    if (reverseToggle) reverseToggle.checked = this.settings.reverseMode;
    if (delaySpeechToggle) delaySpeechToggle.checked = this.settings.delaySpeechInNormalMode;
    
    // 更新字型預覽
    this.updateFontPreview();
    
    // 應用圖片縮放設定（永遠使用不裁切模式）
    this.applyImageFitMode();
  };
  
  // 應用圖片縮放設定（永遠使用不裁切模式）
  FlashcardApp.prototype.applyImageFitMode = function() {
    var flashcardDiv = document.getElementById('flashcard');
    if (flashcardDiv) {
      // 永遠使用contain模式（不裁切）
      flashcardDiv.classList.add('image-fit-contain');
      flashcardDiv.classList.remove('image-fit-cover');
    }
  };
  
  // 應用字型設定
  FlashcardApp.prototype.applyFontFamily = function() {
    var fontFamily = this.fontFamilyMap[this.settings.fontFamily] || this.fontFamilyMap['system-default'];
    
    // 應用到主要元素
    var elements = [
      document.getElementById('english-word'),
      document.getElementById('chinese-word'),
      document.querySelector('#loading p'),
      document.body // 應用到整個body作為fallback
    ];
    
    for (var i = 0; i < elements.length; i++) {
      if (elements[i]) {
        elements[i].style.fontFamily = fontFamily;
      }
    }
    
    console.log('已應用字型:', this.settings.fontFamily, '→', fontFamily);
  };
  
  // 更新字型預覽
  FlashcardApp.prototype.updateFontPreview = function() {
    var previewEnglish = document.querySelector('.preview-english');
    var previewChinese = document.querySelector('.preview-chinese');
    var fontFamily = this.fontFamilyMap[this.settings.fontFamily] || this.fontFamilyMap['system-default'];
    
    if (previewEnglish) {
      previewEnglish.style.fontFamily = fontFamily;
    }
    if (previewChinese) {
      previewChinese.style.fontFamily = fontFamily;
    }
  };
  
  // 判斷是否在測驗進行中
  FlashcardApp.prototype.isQuizInProgress = function() {
    var progressScreen = document.getElementById('quiz-progress-screen');
    return progressScreen && progressScreen.style.display !== 'none';
  };
  
  // 保護select元素不受全域事件干擾
  FlashcardApp.prototype.protectSelectElement = function(selectElement) {
    if (!selectElement) return;
    
    console.log('為select元素添加保護:', selectElement.id || selectElement.className);
    
    // 阻止所有可能導致問題的事件冒泡
    var eventsToProtect = ['click', 'mousedown', 'mouseup', 'focus', 'blur'];
    
    for (var i = 0; i < eventsToProtect.length; i++) {
      var eventType = eventsToProtect[i];
      
      (function(eventName) {
        selectElement.addEventListener(eventName, function(e) {
          console.log('Select ' + eventName + ' 事件，阻止冒泡');
          e.stopPropagation();
          
          // 對於focus事件，確保select獲得焦點
          if (eventName === 'focus') {
            console.log('Select獲得焦點');
          }
          // 對於blur事件，記錄失去焦點
          else if (eventName === 'blur') {
            console.log('Select失去焦點');
          }
        }, true); // 使用捕獲階段
      })(eventType);
    }
    
    // 特別處理鍵盤事件
    selectElement.addEventListener('keydown', function(e) {
      console.log('Select keydown 事件:', e.keyCode);
      e.stopPropagation();
      // 不調用preventDefault，讓select正常處理鍵盤輸入
    }, true);
    
    selectElement.addEventListener('keyup', function(e) {
      e.stopPropagation();
    }, true);
    
    // 確保select元素有正確的樣式
    selectElement.style.position = 'relative';
    selectElement.style.zIndex = '2100';
  };
  
  // 載入單字
  FlashcardApp.prototype.loadWords = function(isInitialLoad, callback) {
    var self = this;
    callback = callback || function() {};
    
    // 清理先前預加載的圖片缓存
    this.preloadedImages = {};
    this.currentPreloadingImage = null;
    
    if (this.sheetSettings.sheetId && this.sheetSettings.selectedSheets.length > 0) {
      var autoHandle = isInitialLoad;
      
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('載入結果:', result);
          
          if (result && result.words && result.words.length > 0) {
            self.words = result.words;
            self.difficultWords = self.words.filter(function(w) { return w.difficult; }).map(function(w) { return w.id; });
            
            if (result.autoHandled) {
              console.log('重複單字已自動處理:', result.autoResults);
              if (result.autoResults && result.autoResults.successCount > 0) {
                self.showAutoProcessingNotification(result.autoResults);
              }
              callback(false);
            } else if (result.hasDuplicates && result.duplicates.length > 0) {
              console.log('發現重複單字需要手動處理:', result.duplicates);
              self.duplicateWords = result.duplicates;
              self.currentDuplicateIndex = 0;
              self.duplicateProcessingResults = [];
              
              if (document.readyState === 'complete') {
                self.showDuplicateModal();
      } else {
                window.addEventListener('load', function() {
                  self.showDuplicateModal();
                });
              }
              callback(true);
        return;
            } else {
              callback(false);
            }
          } else {
            throw new Error('沒有找到單字資料');
          }
        })
        .withFailureHandler(function(error) {
          console.error('載入單字失敗:', error);
          self.showError();
        })
        .getWordsFromSheetsWithDuplicateDetection(this.sheetSettings.sheetId, this.sheetSettings.selectedSheets, autoHandle);
    } else {
      google.script.run
        .withSuccessHandler(function(words) {
          if (words && words.length > 0) {
            self.words = words;
            self.difficultWords = words.filter(function(w) { return w.difficult; }).map(function(w) { return w.id; });
            callback(false);
          } else {
            throw new Error('沒有找到單字資料');
          }
        })
        .withFailureHandler(function(error) {
          console.error('載入單字失敗:', error);
          self.showError();
        })
        .getWordsFromSheet();
    }
  };
  
  // 設置事件監聽器
  FlashcardApp.prototype.setupEventListeners = function() {
    console.log('設置事件監聽器...');
  
    if (this.listenersSetup) {
      console.log('事件監聽器已設置，跳過重複設置');
        return;
      }
      
    this.setupCoreListeners();
    this.setupMenuListeners();
    this.setupModalListeners();
    this.setupKeyboardListeners();
    this.setupProgressAndExportListeners();
  
    this.listenersSetup = true;
    console.log('所有事件監聽器設置完成');
  };
  
  // 核心監聽器
  FlashcardApp.prototype.setupCoreListeners = function() {
    var self = this;
    
    var flashcardDiv = document.getElementById('flashcard');
    var nextBtn = document.getElementById('next-btn');
    var prevBtn = document.getElementById('prev-btn');
    
    // 在整個flashcard區域添加點擊事件，但排除下方區域
    if (flashcardDiv) {
      flashcardDiv.addEventListener('click', function(e) { 
        self.handleFlashcardClick(e); 
      });
    }
    if (nextBtn) {
      nextBtn.addEventListener('click', function() { self.nextWord(); });
    }
    if (prevBtn) {
      prevBtn.addEventListener('click', function() { self.previousWord(); });
    }
    // 移除 restartBtn 的直接事件綁定，因為它已經在選單委派事件中處理了
    
    // 新增按鈕事件監聽器
    var voiceToggleBtn = document.getElementById('voice-toggle-btn');
    var pauseBtn = document.getElementById('pause-btn');
    var restoreBtn = document.getElementById('restore-btn');
    
    if (voiceToggleBtn) {
      voiceToggleBtn.addEventListener('click', function() { self.toggleVoice(); });
    }
    if (pauseBtn) {
      pauseBtn.addEventListener('click', function() { self.togglePause(); });
    }
    if (restoreBtn) {
      restoreBtn.addEventListener('click', function() { self.cancelRemoval(); });
    }
    
    // 為暫停指示器添加點擊事件，讓用戶可以點擊"已暫停"來結束暫停
    var pausedIndicator = document.getElementById('paused-indicator');
    if (pausedIndicator) {
      pausedIndicator.addEventListener('click', function(e) { 
        // 阻止事件冒泡，避免觸發 flashcard 的點擊事件
        if (e.stopPropagation) {
          e.stopPropagation();
        } else {
          e.cancelBubble = true; // IE8 及更早版本
        }
        
        if (self.userPaused) {
          self.togglePause(); 
        }
      });
    }
    

  };
  
  // 選單監聽器
  FlashcardApp.prototype.setupMenuListeners = function() {
    console.log('設定選單事件監聽器...');
    
    var self = this;
    var menuBtn = document.getElementById('menu-btn');
    var menuDropdown = document.getElementById('menu-dropdown');
    
    if (!menuBtn || !menuDropdown) {
      console.error('找不到選單元素');
      return;
    }
    
        // 使用委派事件監聽
    document.addEventListener('click', function(e) {
      // 檢查是否點擊了select相關元素，如果是則不處理任何選單邏輯
      var target = e.target;
      var isSelectRelated = false;
      
      // 向上遍歷DOM樹檢查是否點擊了select或其相關元素
      var element = target;
      while (element && element !== document.body) {
        if (element.tagName === 'SELECT' || 
            element.tagName === 'OPTION' ||
            (element.classList && (
              element.classList.contains('modal') ||
              element.classList.contains('modal-content') ||
              element.classList.contains('setting-control') ||
              element.classList.contains('font-preview')))) {
          isSelectRelated = true;
          break;
        }
        element = element.parentElement;
      }
      
      // 如果點擊的是select相關元素，直接返回，不處理選單邏輯
      if (isSelectRelated) {
        console.log('點擊了select相關元素，跳過選單處理');
        return;
      }
      
      // 處理選單按鈕點擊
      if (e.target.id === 'menu-btn' || e.target.closest('#menu-btn')) {
        console.log('選單按鈕被點擊');
        e.stopPropagation();
        self.toggleMenu();
        return;
      }
      
      // 處理選單項目點擊
      if (e.target.closest('#menu-dropdown')) {
        console.log('點擊選單下拉選項');
        e.stopPropagation();

        if (e.target.id === 'restart-btn') {
          console.log('重新開始按鈕被點擊');
          self.closeMenu();
          self.confirmRestart();
        } else if (e.target.id === 'fullscreen-btn') {
          console.log('全螢幕按鈕被點擊');
          self.closeMenu();
          self.toggleFullscreen();
        } else if (e.target.id === 'sheet-settings-btn') {
          console.log('Google Sheet 設定按鈕被點擊');
          self.closeMenu();
          self.openSheetSettings();
        } else if (e.target.id === 'voice-settings-btn') {
          console.log('語音設定按鈕被點擊');
          self.closeMenu();
          self.openVoiceSettings();
        } else if (e.target.id === 'settings-btn') {
          console.log('設定按鈕被點擊');
          self.closeMenu();
          self.openSettings();
        } else if (e.target.id === 'export-btn') {
          console.log('匯出按鈕被點擊');
          self.closeMenu();
          self.openExportModal();
        } else if (e.target.id === 'quick-quiz-btn') {
          console.log('快速測驗按鈕被點擊');
          self.closeMenu();
          self.startQuiz('quick');
        } else if (e.target.id === 'full-quiz-btn') {
          console.log('完整測驗按鈕被點擊');
          self.closeMenu();
          self.startQuiz('full');
        }
        return;
      }

      // 點擊其他地方關閉選單（但排除select相關元素）
      self.closeMenu();
    });
  
    console.log('選單事件監聽器設定完成');
  };
  

  
  // 顯示語音啟用界面
  FlashcardApp.prototype.showSpeechActivation = function() {
    console.log('顯示語音啟用界面 (舊版瀏覽器)');
    var activationContainer = document.getElementById('speech-activation-container');
    if (activationContainer) {
      activationContainer.style.display = 'block';
    }
    
    // 設置語音啟用按鈕事件
    var activateBtn = document.getElementById('activate-speech-btn');
    var self = this;
    if (activateBtn) {
      activateBtn.addEventListener('click', function() {
        self.activateSpeech();
      });
    }
  };
  
  // 啟用語音功能
  FlashcardApp.prototype.activateSpeech = function() {
    console.log('用戶點擊啟用語音按鈕');
    
    // 測試語音功能是否可用
    try {
      var testUtterance = new SpeechSynthesisUtterance('');
      testUtterance.volume = 0; // 靜音測試
      this.speechSynthesis.speak(testUtterance);
      
      this.speechActivated = true;
      console.log('語音功能已啟用');
      
      // 隱藏語音啟用界面
      var activationContainer = document.getElementById('speech-activation-container');
      if (activationContainer) {
        activationContainer.style.display = 'none';
      }
      
      // 進入主畫面
      this.hideLoading();
      this.applySettings();
      
      if (this.sheetSettings.sheetId && this.sheetSettings.selectedSheets.length > 0) {
        this.startNewRound();
      } else {
        this.openSheetSettings();
      }
      
    } catch (error) {
      console.error('語音啟用失敗:', error);
      alert('語音功能啟用失敗，但程式仍可正常使用');
      this.speechActivated = false;
      
      // 仍然進入主畫面
      var activationContainer = document.getElementById('speech-activation-container');
      if (activationContainer) {
        activationContainer.style.display = 'none';
      }
      this.hideLoading();
      this.applySettings();
      
      if (this.sheetSettings.sheetId && this.sheetSettings.selectedSheets.length > 0) {
        this.startNewRound();
      } else {
        this.openSheetSettings();
      }
    }
  };
  
  // 隱藏載入畫面
  FlashcardApp.prototype.hideLoading = function() {
    var loadingDiv = document.getElementById('loading');
    var flashcardDiv = document.getElementById('flashcard');
    if (loadingDiv) loadingDiv.style.display = 'none';
    if (flashcardDiv) flashcardDiv.style.display = 'flex';
    
    // 更新按鈕狀態
    this.updateVoiceButtonState();
    this.updatePauseButtonState();
    this.updateFullscreenButtonText();
  };
  
  // 顯示錯誤
  FlashcardApp.prototype.showError = function() {
    var loadingDiv = document.getElementById('loading');
    var errorDiv = document.getElementById('error');
    if (loadingDiv) loadingDiv.style.display = 'none';
    if (errorDiv) errorDiv.style.display = 'block';
  };
  
  // 開始新回合
  FlashcardApp.prototype.startNewRound = function() {
    this.shuffleArray(this.words);
    if (this.showDifficultOnly) {
      this.currentWords = this.words.filter(function(w) { 
        return this.difficultWords.includes(w.id); 
      }, this);
        } else {
      this.currentWords = this.words.slice();
    }
    this.currentIndex = 0;
    this.removedWords = [];
    this.navigationHistory = [];
    this.pendingRemoval = null;
    this.userPaused = false;
    this.isPaused = false;
    this.hideRestoreButton();
          
          if (this.currentWords.length === 0) {
      if (this.showDifficultOnly) {
        alert('沒有不熟單字！');
        this.showDifficultOnly = false;
        var checkbox = document.getElementById('show-difficult-only');
        if (checkbox) checkbox.checked = false;
        this.currentWords = this.words.slice();
          }
        }
        
        this.displayCurrentWord();
        this.updateButtonStates();
    this.updateVoiceButtonState();
    this.updatePauseButtonState();
    this.updateFullscreenButtonText();
    this.renderDifficultStar();
  };
  
  // 洗牌
  FlashcardApp.prototype.shuffleArray = function(array) {
    for (var i = array.length - 1; i > 0; i--) {
      var j = Math.floor(Math.random() * (i + 1));
      var temp = array[i];
      array[i] = array[j];
      array[j] = temp;
    }
  };
  
  // 顯示當前單字
  FlashcardApp.prototype.displayCurrentWord = function() {
    if (this.currentWords.length === 0) {
      this.startNewRound();
      return;
    }
    
    var currentWord = this.currentWords[this.currentIndex];
    var englishElement = document.getElementById('english-word');
    var chineseElement = document.getElementById('chinese-word');
    this.showingChinese = false;
    this.isTransitioning = false;
    this.isProcessingClick = false;
      this.pendingRemoval = null;
      this.hideRestoreButton();
      
      if (this.displayTimer) {
        clearTimeout(this.displayTimer);
      }
      
    englishElement.classList.remove('show');
    chineseElement.classList.remove('show');
    
    englishElement.style.color = '';
    chineseElement.style.color = '';
    
    // 先清除背景圖片（圖片將在中文翻譯出現時才顯示）
    var flashcardDiv = document.getElementById('flashcard');
    if (flashcardDiv) {
      flashcardDiv.style.backgroundImage = '';
      flashcardDiv.classList.remove('has-image');
    }
    
    var self = this;
    setTimeout(function() {
      var firstElement = document.getElementById('english-word');
      
      if (self.settings.reverseMode) {
        firstElement.textContent = currentWord.chinese;
      } else {
        firstElement.textContent = currentWord.english;
        // 只有在未啟用延遲發音時才立即播放語音
        if (!self.settings.delaySpeechInNormalMode) {
          setTimeout(function() {
            self.speakWord(currentWord.english);
          }, 500);
        }
      }
      firstElement.classList.add('show');
      
      // 預加載當前單字的圖片（如果有的話）
      if (currentWord.image && currentWord.image !== '') {
        self.preloadImage(currentWord.image);
      }
      
      // 預加載下一個單字的圖片（提前準備）
      var nextIndex = (self.currentIndex + 1) % self.currentWords.length;
      var nextWord = self.currentWords[nextIndex];
      if (nextWord && nextWord.image && nextWord.image !== '') {
        self.preloadImage(nextWord.image);
      }
  
      self.displayTimer = setTimeout(function() {
        self.showSecondPartAndScheduleNext();
      }, self.settings.delayTime * 1000);
      
    }, 100);
    
    this.renderDifficultStar();
    this.updateProgress();
    this.updateButtonStates();
  };
  
  // 更新進度
  FlashcardApp.prototype.updateProgress = function() {
    var progressText = document.getElementById('progress-text');
    if (progressText) {
      var current = this.currentIndex + 1;
      var total = this.currentWords.length;
      progressText.textContent = current + '/' + total;
    }
  };
  
  // 更新按鈕狀態
  FlashcardApp.prototype.updateButtonStates = function() {
    var prevBtn = document.getElementById('prev-btn');
    if (prevBtn) {
      var isFirstWord = this.currentIndex === 0;
      var hasPendingRemoval = this.pendingRemoval !== null;
      prevBtn.disabled = (isFirstWord && !hasPendingRemoval) || this.navigationHistory.length === 0;
    }
  };
  
  // 切換選單
  FlashcardApp.prototype.toggleMenu = function() {
    console.log('toggleMenu 被調用');
    var menuBtn = document.getElementById('menu-btn');
    var menuDropdown = document.getElementById('menu-dropdown');
    
    if (!menuBtn || !menuDropdown) {
      console.error('選單元素不存在，無法切換');
        return;
      }
      
    var isOpen = menuDropdown.classList.contains('show');
    console.log('選單目前狀態:', isOpen ? '開啟' : '關閉');
    
    if (isOpen) {
      this.closeMenu();
    } else {
      console.log('開啟選單');
      menuBtn.classList.add('active');
      menuDropdown.classList.add('show');
    }
  };
  
  // 關閉選單
  FlashcardApp.prototype.closeMenu = function() {
    console.log('closeMenu 被調用');
    var menuBtn = document.getElementById('menu-btn');
    var menuDropdown = document.getElementById('menu-dropdown');
    
    if (menuBtn && menuDropdown) {
      console.log('關閉選單');
      menuBtn.classList.remove('active');
      menuDropdown.classList.remove('show');
    }
  };
  

  
  // 模態框監聽器
  FlashcardApp.prototype.setupModalListeners = function() {
    var self = this;
    
    // 主設定模態框
    var settingsModal = document.getElementById('settings-modal');
    var closeSettings = document.getElementById('close-settings');
    var saveSettings = document.getElementById('save-settings');
    var resetSettings = document.getElementById('reset-settings');
    var delaySlider = document.getElementById('delay-setting');
    var fontSizeSlider = document.getElementById('font-size-setting');
    
    if (closeSettings) {
      closeSettings.addEventListener('click', function() { self.closeSettings(); });
    }
    if (saveSettings) {
      saveSettings.addEventListener('click', function() { self.saveSettingsAndClose(); });
    }
    if (resetSettings) {
      resetSettings.addEventListener('click', function() { self.resetSettings(); });
    }
    if (settingsModal) {
      settingsModal.addEventListener('click', function(e) {
        // 檢查點擊目標，排除select元素及其相關元素
        var target = e.target;
        var isSelectRelated = false;
        
        // 向上遍歷DOM樹檢查是否點擊了select或其相關元素
        var element = target;
        while (element && element !== settingsModal) {
          if (element.tagName === 'SELECT' || 
              element.tagName === 'OPTION' ||
              element.classList.contains('setting-control') ||
              element.classList.contains('font-preview')) {
            isSelectRelated = true;
            break;
          }
          element = element.parentElement;
        }
        
        // 只有點擊模態框背景且不是select相關元素時才關閉
        if (e.target === settingsModal && !isSelectRelated) {
          self.closeSettings();
        }
      });
    }
    
    // 修復：設定滑桿實時更新
    if (delaySlider) {
      delaySlider.addEventListener('input', function(e) {
        var delayValue = document.getElementById('delay-value');
        if (delayValue) {
          // 修復浮點數精度問題
          var value = parseFloat(e.target.value);
          var step = parseFloat(e.target.step) || 0.5;
          var decimalPlaces = step.toString().indexOf('.') !== -1 ? step.toString().split('.')[1].length : 0;
          var formattedValue = parseFloat(value.toFixed(decimalPlaces));
          delayValue.textContent = formattedValue;
        }
      });
      
      // 增強觸控體驗：點擊軌道直接設置值
      this.enhanceSliderInteraction(delaySlider, 'delay-value');
    }
    
    if (fontSizeSlider) {
      fontSizeSlider.addEventListener('input', function(e) {
        var fontSizeValue = document.getElementById('font-size-value');
        if (fontSizeValue) {
          fontSizeValue.textContent = e.target.value + 'px';
        }
        // 即時預覽字體大小
        var englishWord = document.getElementById('english-word');
        var chineseWord = document.getElementById('chinese-word');
        var previewEnglish = document.querySelector('.preview-english');
        var previewChinese = document.querySelector('.preview-chinese');
        
        if (englishWord) englishWord.style.fontSize = e.target.value + 'px';
        if (chineseWord) chineseWord.style.fontSize = e.target.value + 'px';
        if (previewEnglish) previewEnglish.style.fontSize = Math.max(16, e.target.value * 0.2) + 'px';
        if (previewChinese) previewChinese.style.fontSize = Math.max(14, e.target.value * 0.18) + 'px';
      });
      
      // 增強觸控體驗：點擊軌道直接設置值
      this.enhanceSliderInteraction(fontSizeSlider, 'font-size-value', 'px');
    }
    
    // 字型選擇器事件監聽
    var fontFamilySelect = document.getElementById('font-family-setting');
    if (fontFamilySelect) {
      var self = this;
      
      // 保護select元素不受全域事件干擾
      this.protectSelectElement(fontFamilySelect);
      
      fontFamilySelect.addEventListener('change', function(e) {
        console.log('字型選擇改變:', e.target.value);
        
        // 即時預覽字型效果
        var selectedFont = e.target.value;
        var fontFamily = self.fontFamilyMap[selectedFont] || self.fontFamilyMap['system-default'];
        
        // 更新主要元素的字型
        var englishWord = document.getElementById('english-word');
        var chineseWord = document.getElementById('chinese-word');
        if (englishWord) englishWord.style.fontFamily = fontFamily;
        if (chineseWord) chineseWord.style.fontFamily = fontFamily;
        
        // 更新預覽
        var previewEnglish = document.querySelector('.preview-english');
        var previewChinese = document.querySelector('.preview-chinese');
        if (previewEnglish) previewEnglish.style.fontFamily = fontFamily;
        if (previewChinese) previewChinese.style.fontFamily = fontFamily;
      });
    }
    
    // Google Sheet 設定模態框
    var sheetSettingsModal = document.getElementById('sheet-settings-modal');
    var closeSheetSettings = document.getElementById('close-sheet-settings');
    var cancelSheetSettings = document.getElementById('cancel-sheet-settings');
    var saveSheetSettings = document.getElementById('save-sheet-settings');
    var loadSheetsBtn = document.getElementById('load-sheets-btn');
    
    if (closeSheetSettings) {
      closeSheetSettings.addEventListener('click', function() { self.closeSheetSettings(); });
    }
    if (cancelSheetSettings) {
      cancelSheetSettings.addEventListener('click', function() { self.closeSheetSettings(); });
    }
    if (saveSheetSettings) {
      saveSheetSettings.addEventListener('click', function() { self.saveSheetSettingsAndClose(); });
    }
    if (loadSheetsBtn) {
      loadSheetsBtn.addEventListener('click', function() { self.loadSheetsList(); });
    }
    if (sheetSettingsModal) {
      sheetSettingsModal.addEventListener('click', function(e) {
        // 檢查點擊目標，排除select元素及其相關元素
        var target = e.target;
        var isSelectRelated = false;
        
        var element = target;
        while (element && element !== sheetSettingsModal) {
          if (element.tagName === 'SELECT' || 
              element.tagName === 'OPTION' ||
              element.classList.contains('setting-control')) {
            isSelectRelated = true;
            break;
          }
          element = element.parentElement;
        }
        
        if (e.target === sheetSettingsModal && !isSelectRelated) {
          self.closeSheetSettings();
        }
      });
    }
    
    // 語音設定模態框
    var voiceSettingsModal = document.getElementById('voice-settings-modal');
    var closeVoiceSettings = document.getElementById('close-voice-settings');
    var cancelVoiceSettings = document.getElementById('cancel-voice-settings');
    var saveVoiceSettings = document.getElementById('save-voice-settings');
    var voiceRateSlider = document.getElementById('voice-rate-setting');
    
    if (closeVoiceSettings) {
      closeVoiceSettings.addEventListener('click', function() { self.closeVoiceSettings(); });
    }
    if (cancelVoiceSettings) {
      cancelVoiceSettings.addEventListener('click', function() { self.closeVoiceSettings(); });
    }
    if (saveVoiceSettings) {
      saveVoiceSettings.addEventListener('click', function() { self.saveVoiceSettingsAndClose(); });
    }
    if (voiceSettingsModal) {
      voiceSettingsModal.addEventListener('click', function(e) {
        // 檢查點擊目標，排除select元素及其相關元素（與主設定模態框相同的邏輯）
        var target = e.target;
        var isSelectRelated = false;
        
        var element = target;
        while (element && element !== voiceSettingsModal) {
          if (element.tagName === 'SELECT' || 
              element.tagName === 'OPTION' ||
              element.classList.contains('setting-control')) {
            isSelectRelated = true;
            break;
          }
          element = element.parentElement;
        }
        
        if (e.target === voiceSettingsModal && !isSelectRelated) {
          self.closeVoiceSettings();
        }
      });
    }
    if (voiceRateSlider) {
      voiceRateSlider.addEventListener('input', function(e) {
        var voiceRateValue = document.getElementById('voice-rate-value');
        if (voiceRateValue) {
          // 修復浮點數精度問題
          var value = parseFloat(e.target.value);
          var step = parseFloat(e.target.step) || 0.1;
          var decimalPlaces = step.toString().indexOf('.') !== -1 ? step.toString().split('.')[1].length : 0;
          var formattedValue = parseFloat(value.toFixed(decimalPlaces));
          voiceRateValue.textContent = formattedValue;
        }
      });
      
      // 增強觸控體驗：點擊軌道直接設置值
      this.enhanceSliderInteraction(voiceRateSlider, 'voice-rate-value');
    }
    
    // 匯出模態框
    var exportModal = document.getElementById('export-modal');
    if (exportModal) {
      exportModal.addEventListener('click', function(e) {
        // 檢查點擊目標，排除select元素及其相關元素
        var target = e.target;
        var isSelectRelated = false;
        
        var element = target;
        while (element && element !== exportModal) {
          if (element.tagName === 'SELECT' || 
              element.tagName === 'OPTION' ||
              element.classList.contains('setting-control')) {
            isSelectRelated = true;
            break;
          }
          element = element.parentElement;
        }
        
        if (e.target === exportModal && !isSelectRelated) {
          self.closeExportModal();
        }
      });
    }
    
    // 覆寫確認模態框
    var overwriteModal = document.getElementById('overwrite-confirm-modal');
    if (overwriteModal) {
      overwriteModal.addEventListener('click', function(e) {
        // 檢查點擊目標，排除select元素及其相關元素
        var target = e.target;
        var isSelectRelated = false;
        
        var element = target;
        while (element && element !== overwriteModal) {
          if (element.tagName === 'SELECT' || 
              element.tagName === 'OPTION' ||
              element.classList.contains('setting-control')) {
            isSelectRelated = true;
            break;
          }
          element = element.parentElement;
        }
        
        if (e.target === overwriteModal && !isSelectRelated) {
          self.closeOverwriteConfirmModal();
        }
      });
    }
    
    // 測驗模態框
    this.setupQuizListeners();
  };
  
    // 鍵盤監聽器 - iPad 4 兼容版本
  FlashcardApp.prototype.setupKeyboardListeners = function() {
    var self = this;
    
    // iPad 4 兼容性改進：確保 body 元素可以接收鍵盤事件
    var body = document.body;
    
    // 設置 tabindex 屬性，讓 body 可以被聚焦
    body.setAttribute('tabindex', '0');
    
    // 自動聚焦到 body 元素
    body.focus();
    
    // 加入點擊事件監聽器，確保點擊後重新聚焦到 body（但排除表單控件）
    body.addEventListener('click', function(e) {
      // 檢查點擊目標是否為表單控件
      var target = e.target;
      if (target && (
          target.tagName === 'SELECT' ||
          target.tagName === 'OPTION' ||
          target.tagName === 'INPUT' ||
          target.tagName === 'TEXTAREA' ||
          target.contentEditable === 'true'
      )) {
        console.log('點擊了表單控件，不重新聚焦到body:', target.tagName);
        return; // 不重新聚焦，讓表單控件保持焦點
      }
      
      // 檢查是否點擊了表單控件的容器
      var element = target;
      while (element && element !== body) {
        if (element.classList && (
            element.classList.contains('setting-control') ||
            element.classList.contains('font-preview')
        )) {
          console.log('點擊了表單控件容器，不重新聚焦到body');
          return;
        }
        element = element.parentElement;
      }
      
      body.focus();
    });
    
      // 鍵盤事件處理函數 - 使用 ES5 兼容語法
  function handleKeyDown(e) {
    // 取得按鍵信息，兼容舊版瀏覽器
    e = e || window.event;
    var keyCode = e.keyCode || e.which;
    var code = e.code || '';
    var key = e.key || '';
    
    // 檢查當前焦點是否在select元素或其他表單控件上
    var activeElement = document.activeElement;
    if (activeElement && (
        activeElement.tagName === 'SELECT' ||
        activeElement.tagName === 'INPUT' ||
        activeElement.tagName === 'TEXTAREA' ||
        activeElement.contentEditable === 'true'
    )) {
      console.log('焦點在表單控件上，跳過鍵盤快捷鍵處理:', activeElement.tagName);
      return; // 不處理任何鍵盤快捷鍵，讓表單控件正常工作
    }
    
    // B 鍵 (keyCode 66) - 暫停/繼續功能，在任何狀態下都能使用
    if (keyCode === 66 || code === 'KeyB') {
      // 防止預設行為
      if (e.preventDefault) {
        e.preventDefault();
      } else {
        e.returnValue = false; // IE8 及更早版本
      }
      
      self.togglePause();
      return;
    }
    
    // 如果已暫停，除了 B 鍵外不處理其他按鍵
    if (self.isPaused) return;
    
    // 處理特殊按鍵對應
    var keyActions = {};
    
    // Enter 鍵 (keyCode 13, 或 iPad 4 的 UIKeyInputUpArrow)
    if (keyCode === 13 || code === 'Enter' || key === 'UIKeyInputUpArrow') {
      keyActions['action'] = function() { self.toggleDifficultCurrentWord(); };
    }
    // 空格鍵 (keyCode 32, 或 iPad 4 的 UIKeyInputDownArrow)
    else if (keyCode === 32 || code === 'Space' || key === 'UIKeyInputDownArrow') {
      keyActions['action'] = function() { self.onWordClick(); };
    }
    // 左方向鍵 (keyCode 37, ArrowLeft, 或 iPad 4 的 UIKeyInputLeftArrow)
    else if (keyCode === 37 || code === 'ArrowLeft' || key === 'UIKeyInputLeftArrow') {
      keyActions['action'] = function() { self.previousWord(); };
    }
    // 上方向鍵 (keyCode 38, ArrowUp)
    else if (keyCode === 38 || code === 'ArrowUp') {
      keyActions['action'] = function() { self.previousWord(); };
    }
    // 右方向鍵 (keyCode 39, ArrowRight, 或 iPad 4 的 UIKeyInputRightArrow)
    else if (keyCode === 39 || code === 'ArrowRight' || key === 'UIKeyInputRightArrow') {
      keyActions['action'] = function() { self.nextWord(); };
    }
    // 下方向鍵 (keyCode 40)
    else if (keyCode === 40 || code === 'ArrowDown') {
      keyActions['action'] = function() { self.nextWord(); };
    }
    // Escape 鍵 (keyCode 27)
    else if (keyCode === 27 || code === 'Escape') {
      keyActions['action'] = function() {
        self.closeSettings();
        self.closeVoiceSettings();
        self.closeExportModal();
        self.closeOverwriteConfirmModal();
        self.closeDuplicateModal();
        self.closeMenu();
      };
    }
    // F5 鍵 (keyCode 116) 跟 S 鍵 (keyCode 83)  - 標注不熟單字
    else if (keyCode === 116 || code === 'F5' || keyCode === 83 || code === 'KeyS') {
      keyActions['action'] = function() { self.toggleDifficultCurrentWord(); };
    }

      // 執行對應的動作
      if (keyActions['action']) {
        // 防止預設行為
        if (e.preventDefault) {
          e.preventDefault();
        } else {
          e.returnValue = false; // IE8 及更早版本
        }
        
        keyActions['action']();
      }
    }
    
    // 監聽整個 document 的鍵盤事件
    document.addEventListener('keydown', handleKeyDown);
    
    console.log('鍵盤事件監聽器已設置 (iPad 4 兼容版本)');
  };
  
  // 進度區和匯出監聽器
  FlashcardApp.prototype.setupProgressAndExportListeners = function() {
    console.log('設置進度區和匯出事件監聽器...');
    var self = this;
  
    // 修復：進度區點擊標註/取消不熟單字
    var progressArea = document.getElementById('progress-area');
    if (progressArea) {
      // 移除舊的事件監聽器
      var newProgressArea = progressArea.cloneNode(true);
      progressArea.parentNode.replaceChild(newProgressArea, progressArea);
  
      newProgressArea.addEventListener('click', function() {
        console.log('進度區被點擊，切換困難單字狀態');
        self.toggleDifficultCurrentWord();
      });
      console.log('進度區事件監聽器設置完成');
      } else {
      console.error('找不到 progress-area 元素');
    }
  
    // 只顯示不熟單字checkbox
    var showDifficultCheckbox = document.getElementById('show-difficult-only');
    if (showDifficultCheckbox) {
      showDifficultCheckbox.addEventListener('change', function(e) {
        console.log('切換只顯示不熟單字:', e.target.checked);
        self.showDifficultOnly = e.target.checked;
        self.filterWordsByDifficult();
      });
      console.log('不熟單字過濾器事件監聽器設置完成');
    } else {
      console.error('找不到 show-difficult-only 元素');
    }
  
    // 匯出相關事件
    var closeExportModal = document.getElementById('close-export-modal');
    var cancelExport = document.getElementById('cancel-export');
    var confirmExport = document.getElementById('confirm-export');
  
    if (closeExportModal) {
      closeExportModal.addEventListener('click', function() { self.closeExportModal(); });
    }
    if (cancelExport) {
      cancelExport.addEventListener('click', function() { self.closeExportModal(); });
    }
    if (confirmExport) {
      confirmExport.addEventListener('click', function() { self.confirmExport(); });
    }
  
    console.log('匯出相關事件監聽器設置完成');
    
    // 隱藏控制按鈕事件監聽器
    this.setupHiddenControlListeners();
  };
  
  // 設置隱藏控制按鈕監聽器
  FlashcardApp.prototype.setupHiddenControlListeners = function() {
    console.log('設置隱藏控制按鈕事件監聽器...');
    var self = this;
    

    
    
    

    
    console.log('隱藏控制按鈕事件監聽器設置完成');
  };
  

  

  

  

  

  

  
  // 開啟設定
  FlashcardApp.prototype.openSettings = function() {
    var settingsModal = document.getElementById('settings-modal');
    if (settingsModal) {
      settingsModal.style.display = 'flex';
      this.pauseTimer();
      this.applySettings();
    }
  };
  
  // 關閉設定
  FlashcardApp.prototype.closeSettings = function(shouldRedisplay) {
    var settingsModal = document.getElementById('settings-modal');
    if (settingsModal) {
      settingsModal.style.display = 'none';
      this.resumeTimer();
      
      if (shouldRedisplay) {
        this.redisplayCurrentWord();
      }
    }
  };
  
  // 儲存設定並關閉
  FlashcardApp.prototype.saveSettingsAndClose = function() {
    var delaySlider = document.getElementById('delay-setting');
    var fontSizeSlider = document.getElementById('font-size-setting');
    var fontFamilySelect = document.getElementById('font-family-setting');
    var reverseToggle = document.getElementById('reverse-setting');
    var delaySpeechToggle = document.getElementById('delay-speech-setting');
    
    var oldReverseMode = this.settings.reverseMode;
    var oldFontFamily = this.settings.fontFamily;
    
    if (delaySlider) this.settings.delayTime = parseFloat(delaySlider.value);
    if (fontSizeSlider) this.settings.fontSize = parseInt(fontSizeSlider.value);
    if (fontFamilySelect) this.settings.fontFamily = fontFamilySelect.value;
    if (reverseToggle) this.settings.reverseMode = reverseToggle.checked;
    if (delaySpeechToggle) this.settings.delaySpeechInNormalMode = delaySpeechToggle.checked;
    
    this.saveSettings();
    this.applySettings();
    this.closeSettings();
    
    // 如果翻譯模式或字型改變，重新顯示當前單字
    if (oldReverseMode !== this.settings.reverseMode || oldFontFamily !== this.settings.fontFamily) {
      this.redisplayCurrentWord();
    }
  };
  
  // 重置設定
  FlashcardApp.prototype.resetSettings = function() {
    this.settings = {
      delayTime: 3,
      fontSize: 96,
      reverseMode: false,
      fontFamily: 'system-default',
      delaySpeechInNormalMode: false
    };
    this.voiceSettings = {
      enabled: true,
      rate: 0.8,
      pitch: 1,
      volume: 1,
      lang: 'en-US',
      voiceURI: '',
      japaneseLang: 'ja-JP',
      japaneseVoiceURI: ''
    };
    this.applySettings();
      this.saveSettings();
    this.closeSettings();
  };
  
  // 暫停計時器
  FlashcardApp.prototype.pauseTimer = function() {
    this.isPaused = true;
    
    if (this.displayTimer) {
      clearTimeout(this.displayTimer);
      this.displayTimer = null;
    }

  };
  
  // 恢復計時器
  FlashcardApp.prototype.resumeTimer = function() {
    // 只有在用戶沒有手動暫停的情況下才恢復計時器
    if (!this.userPaused) {
      this.isPaused = false;
    }
    
    var self = this;
    if (!this.isPaused) {
      if (this.showingChinese) {
        this.displayTimer = setTimeout(function() {
          self.nextWord();
        }, this.settings.delayTime * 1000);
      } else if (!this.isTransitioning && !this.isProcessingClick) {
        var currentWord = this.currentWords[this.currentIndex];
        if (currentWord) {
          this.displayTimer = setTimeout(function() {
            self.showSecondPartAndScheduleNext();
          }, this.settings.delayTime * 1000);
        }
      }
    }
    
    // 更新UI狀態
    this.updatePauseButtonState();
  };
  
  // 開啟Google Sheet設定
  FlashcardApp.prototype.openSheetSettings = function() {
    console.log('開啟 Google Sheet 設定畫面');
    var modal = document.getElementById('sheet-settings-modal');
    if (modal) {
      modal.style.display = 'flex';
      
      var sheetIdInput = document.getElementById('sheet-id-input');
      if (sheetIdInput) {
        sheetIdInput.value = this.sheetSettings.sheetId || '';
      }
      
      var sheetsGroup = document.getElementById('sheets-selection-group');
      if (sheetsGroup) {
      sheetsGroup.style.display = 'none';
      }
      
      var saveBtn = document.getElementById('save-sheet-settings');
      if (saveBtn) {
      saveBtn.disabled = true;
      }
      
      this.pauseTimer();
    }
  };
  
  // 關閉Google Sheet設定
  FlashcardApp.prototype.closeSheetSettings = function() {
    var modal = document.getElementById('sheet-settings-modal');
    if (modal) {
      modal.style.display = 'none';
      this.resumeTimer();
    }
  };
  
  // 標註困難單字
  FlashcardApp.prototype.toggleDifficultCurrentWord = function() {
    if (this.currentWords.length === 0) return;
    
    var currentWord = this.currentWords[this.currentIndex];
      if (!currentWord) return;
      
    var id = currentWord.id;
    var isDifficult = this.difficultWords.includes(id);
    
      if (isDifficult) {
      this.difficultWords = this.difficultWords.filter(function(did) { return did !== id; });
        } else {
        this.difficultWords.push(id);
      }
      
      // 後端同步
      if (typeof google !== 'undefined' && google.script && google.script.run) {
      var rowIndex = currentWord.originalRowIndex;
        if (rowIndex === undefined) {
        rowIndex = this.words.findIndex(function(w) {
          return w.english === currentWord.english && w.chinese === currentWord.chinese;
        });
        }
        
        if (rowIndex !== -1) {
        var sheetId = this.sheetSettings.sheetId;
        var sheetName = currentWord.sheetName || 'Sheet1';
        var markValue = isDifficult ? '' : '*';
          console.log('標註單字:', currentWord.english, '行索引:', rowIndex, '標記值:', markValue);
          google.script.run.markWordAsDifficult(sheetId, sheetName, rowIndex, markValue);
        }
      }
  
    // 處理「只顯示不熟單字」模式
      if (this.showDifficultOnly && isDifficult) {
        this.currentWords.splice(this.currentIndex, 1);
        
        if (this.currentIndex >= this.currentWords.length) {
          this.currentIndex = 0;
        }
        
        if (this.currentWords.length === 0) {
          alert('恭喜！沒有不熟單字了！');
          this.showDifficultOnly = false;
        var checkbox = document.getElementById('show-difficult-only');
        if (checkbox) checkbox.checked = false;
          this.startNewRound();
        } else {
          this.displayCurrentWord();
        }
      } else {
        this.renderDifficultStar();
      }
  };
  
  // 渲染困難星星
  FlashcardApp.prototype.renderDifficultStar = function() {
    var currentWord = this.currentWords[this.currentIndex];
    var star = document.getElementById('difficult-star');
    if (star && currentWord && this.difficultWords.includes(currentWord.id)) {
        star.classList.add('visible');
    } else if (star) {
        star.classList.remove('visible');
      }
  };
    
  // 過濾困難單字
  FlashcardApp.prototype.filterWordsByDifficult = function() {
      if (this.showDifficultOnly) {
      var self = this;
      this.currentWords = this.words.filter(function(w) { return self.difficultWords.includes(w.id); });
        this.currentIndex = 0;
      } else {
      this.currentWords = this.words.slice();
        this.currentIndex = 0;
      }
      this.displayCurrentWord();
  };
  
  // 處理flashcard點擊事件（檢查點擊位置）
  FlashcardApp.prototype.handleFlashcardClick = function(event) {
    // 檢查點擊是否發生在控制按鈕或選單上（ES5兼容版本）
    var target = event.target;
    
    // 向上遍历DOM树检查是否点击了控制元素
    var element = target;
    while (element && element !== event.currentTarget) {
      if (element.classList && (
          element.classList.contains('controls-wrapper') ||
          element.classList.contains('progress') ||
          element.classList.contains('restore-btn-container') ||
          element.classList.contains('paused-indicator') ||
          element.classList.contains('paused-content') ||
          element.classList.contains('paused-icon') ||
          element.classList.contains('paused-text') ||
          element.tagName === 'BUTTON')) {
        return; // 如果點擊的是控制元素，不處理
      }
      element = element.parentElement;
    }
    
    // 計算下方安全區域的高度
    var flashcardRect = event.currentTarget.getBoundingClientRect();
    var clickY = event.clientY;
    var flashcardBottom = flashcardRect.bottom;
    
    // 動態計算下方安全區域高度
    var progressElement = document.getElementById('progress-area');
    var controlsWrapper = document.querySelector('.controls-wrapper');
    var safeAreaHeight = 120; // 默認高度
    
    // 嘗試動態計算實際高度
    try {
      var progressHeight = progressElement ? progressElement.offsetHeight + 20 : 40; // 包含padding
      var controlsHeight = controlsWrapper ? controlsWrapper.offsetHeight + 20 : 60; // 包含padding
      safeAreaHeight = Math.max(progressHeight, controlsHeight) + 20; // 額外的安全邊距
    } catch (e) {
      console.log('無法動態計算安全區域高度，使用默認值');
    }
    
    var safeAreaTop = flashcardBottom - safeAreaHeight;
    
    // 如果點擊位置在下方安全區域內，不觸發刪除功能
    if (clickY >= safeAreaTop) {
      console.log('點擊位置在安全區域內(Y:' + clickY + ', 安全區域起始:' + safeAreaTop + ')，不觸發刪除功能');
      return;
    }
    
    console.log('點擊位置在有效區域內(Y:' + clickY + ', 安全區域起始:' + safeAreaTop + ')，觸發刪除功能');
    // 觸發單字點擊事件
    this.onWordClick();
  };
  
  // 單字點擊事件（刪除單字功能）
  FlashcardApp.prototype.onWordClick = function() {
    if (this.isTransitioning || this.isPaused) return;
    
    if (this.currentWords.length <= 1) {
      var sections = document.querySelectorAll('.card-section');
      for (var i = 0; i < sections.length; i++) {
        sections[i].style.backgroundColor = 'rgba(255, 100, 100, 0.3)';
        (function(section) {
          setTimeout(function() {
            section.style.backgroundColor = '';
          }, 300);
        })(sections[i]);
      }
      return;
    }
    
    var currentWord = this.currentWords[this.currentIndex];
    var englishElement = document.getElementById('english-word');
    var chineseElement = document.getElementById('chinese-word');
    
    var isAlreadyMarked = englishElement.style.color === 'rgb(102, 102, 102)' || 
                        englishElement.style.color === '#666666';
    
    if (isAlreadyMarked) {
      this.nextWord();
        return;
      }
      
    this.isProcessingClick = true;
    
    if (this.displayTimer) {
      clearTimeout(this.displayTimer);
    }
    
    if (!this.showingChinese) {
      var secondText = this.settings.reverseMode ? currentWord.english : currentWord.chinese;
      chineseElement.textContent = secondText;
      chineseElement.classList.add('show');
      this.showingChinese = true;
      
      // 同時顯示圖片（如果有的話）- 使用預加載的圖片
      var flashcardDiv = document.getElementById('flashcard');
      var hasImage = currentWord.image && currentWord.image !== '';
      if (hasImage) {
        // 由於圖片已經預加載，可以直接設定，無需等待
        flashcardDiv.style.backgroundImage = 'url(' + currentWord.image + ')';
        flashcardDiv.classList.add('has-image');
      } else {
        flashcardDiv.style.backgroundImage = '';
        flashcardDiv.classList.remove('has-image');
      }
      
      if (this.settings.reverseMode) {
        var self = this;
        setTimeout(function() {
          self.speakWord(currentWord.english);
        }, 500);
      } else if (this.settings.delaySpeechInNormalMode) {
        // 在正常模式下，如果啟用了延遲發音，則在用戶點擊顯示中文翻譯時播放英文語音
        var self = this;
        setTimeout(function() {
          self.speakWord(currentWord.english);
        }, 500);
      }
    }
    
    englishElement.style.color = '#666666';
    chineseElement.style.color = '#666666';
    
    var sections = document.querySelectorAll('.card-section');
    for (var i = 0; i < sections.length; i++) {
      sections[i].classList.add('clicked');
      (function(section) {
        setTimeout(function() { 
          section.classList.remove('clicked'); 
        }, 500);
      })(sections[i]);
    }
    
    this.pendingRemoval = {
      word: currentWord,
      index: this.currentIndex,
      originalEnglishColor: englishElement.style.color,
      originalChineseColor: chineseElement.style.color
    };
    
    this.showRestoreButton();
    this.updateButtonStates();
    
    var self = this;
    this.displayTimer = setTimeout(function() {
      self.confirmRemoval();
    }, this.settings.delayTime * 1000);
  };
  
  // 確認移除單字
  FlashcardApp.prototype.confirmRemoval = function() {
    if (!this.pendingRemoval) return;
    
    var word = this.pendingRemoval.word;
    var index = this.pendingRemoval.index;
    
    this.removedWords.push(word);
    this.currentWords.splice(index, 1);
    
    if (this.currentIndex >= this.currentWords.length) {
      this.currentIndex = 0;
    }
    
    this.pendingRemoval = null;
    this.hideRestoreButton();
    
    if (this.currentWords.length === 0) {
      this.startNewRound();
    } else {
      this.displayCurrentWord();
    }
    
    this.isProcessingClick = false;
    this.updateButtonStates();
  };
  
  // 取消移除
  FlashcardApp.prototype.cancelRemoval = function() {
    if (!this.pendingRemoval) return;
    
    var englishElement = document.getElementById('english-word');
    var chineseElement = document.getElementById('chinese-word');
    
    englishElement.style.color = '';
    chineseElement.style.color = '';
    
    this.pendingRemoval = null;
    this.hideRestoreButton();
    
    if (this.displayTimer) {
      clearTimeout(this.displayTimer);
    }
    
    this.isProcessingClick = false;
    this.updateButtonStates();
    
    var self = this;
    if (this.showingChinese) {
      this.displayTimer = setTimeout(function() {
        self.nextWord();
      }, this.settings.delayTime * 1000);
      } else {
      this.displayTimer = setTimeout(function() {
        self.showSecondPartAndScheduleNext();
      }, this.settings.delayTime * 1000);
    }
  };
  
  // 顯示恢復按鈕
  FlashcardApp.prototype.showRestoreButton = function() {
    var restoreBtnContainer = document.getElementById('restore-btn-container');
    if (restoreBtnContainer) {
      restoreBtnContainer.style.display = 'block';
    }
  };
  
  // 隱藏恢復按鈕
  FlashcardApp.prototype.hideRestoreButton = function() {
    var restoreBtnContainer = document.getElementById('restore-btn-container');
    if (restoreBtnContainer) {
      restoreBtnContainer.style.display = 'none';
    }
  };
  
  // 顯示第二部分並安排下一個
  FlashcardApp.prototype.showSecondPartAndScheduleNext = function() {
    if (this.isPaused || this.showingChinese || !this.currentWords[this.currentIndex]) {
      return;
    }
  
        if (this.displayTimer) {
      clearTimeout(this.displayTimer);
    }
    
    // 清除中文延遲顯示計時器
    if (this.chineseDelayTimer) {
      clearTimeout(this.chineseDelayTimer);
      this.chineseDelayTimer = null;
    }

    var currentWord = this.currentWords[this.currentIndex];
    var chineseElement = document.getElementById('chinese-word');
    var flashcardDiv = document.getElementById('flashcard');
    
    // 設定背景圖片（圖片佔滿整個畫面）- 使用預加載的圖片
    var hasImage = currentWord.image && currentWord.image !== '';
    if (hasImage) {
      // 由於圖片已經預加載，可以直接設定，無需等待
      flashcardDiv.style.backgroundImage = 'url(' + currentWord.image + ')';
      flashcardDiv.classList.add('has-image');
    } else {
      flashcardDiv.style.backgroundImage = '';
      flashcardDiv.classList.remove('has-image');
    }
    
    var self = this;
    var secondText = this.settings.reverseMode ? currentWord.english : currentWord.chinese;
    
    // 圖片和中文同時顯示（移除延遲）
    chineseElement.textContent = secondText;
    chineseElement.classList.add('show');
    this.showingChinese = true;
    
    // 設定下一個單字的計時器
    this.displayTimer = setTimeout(function() {
      self.nextWord();
    }, this.settings.delayTime * 1000);
    
    if (this.settings.reverseMode) {
      setTimeout(function() {
        self.speakWord(currentWord.english);
      }, 500);
    } else if (this.settings.delaySpeechInNormalMode) {
      // 在正常模式下，如果啟用了延遲發音，則在中文翻譯出現時播放英文語音
      setTimeout(function() {
        self.speakWord(currentWord.english);
      }, 500);
    }
  };
  
  // 預加載圖片方法
  FlashcardApp.prototype.preloadImage = function(imageUrl, callback) {
    if (!imageUrl || imageUrl === '') {
      if (callback) callback(false);
      return;
    }
    
    // 如果已經預加載過，直接回調
    if (this.preloadedImages[imageUrl]) {
      if (callback) callback(true);
      return;
    }
    
    var self = this;
    var img = new Image();
    
    img.onload = function() {
      self.preloadedImages[imageUrl] = true;
      if (callback) callback(true);
    };
    
    img.onerror = function() {
      console.warn('圖片預加載失敗:', imageUrl);
      if (callback) callback(false);
    };
    
    img.src = imageUrl;
    this.currentPreloadingImage = img;
  };
  
  // 增強滑塊交互體驗（ES5兼容版本）
  FlashcardApp.prototype.enhanceSliderInteraction = function(slider, valueElementId, unit) {
    if (!slider) return;
    
    var self = this;
    unit = unit || '';
    
    // 計算點擊位置對應的值
    function calculateValueFromClick(event, sliderElement) {
      var rect = sliderElement.getBoundingClientRect();
      var clickX = event.clientX || (event.touches && event.touches[0] ? event.touches[0].clientX : 0);
      var sliderX = clickX - rect.left;
      var sliderWidth = rect.width;
      
      // 確保點擊位置在滑塊範圍內
      if (sliderX < 0) sliderX = 0;
      if (sliderX > sliderWidth) sliderX = sliderWidth;
      
      // 計算百分比
      var percentage = sliderX / sliderWidth;
      
      // 根據滑塊的min、max、step計算值
      var min = parseFloat(sliderElement.min);
      var max = parseFloat(sliderElement.max);
      var step = parseFloat(sliderElement.step) || 1;
      
      var rawValue = min + (max - min) * percentage;
      
      // 根據step調整值，修復浮點數精度問題
      var steppedValue = Math.round(rawValue / step) * step;
      
      // 確保值在範圍內
      if (steppedValue < min) steppedValue = min;
      if (steppedValue > max) steppedValue = max;
      
      // 修復浮點數精度問題
      var decimalPlaces = 0;
      if (step.toString().indexOf('.') !== -1) {
        decimalPlaces = step.toString().split('.')[1].length;
      }
      steppedValue = parseFloat(steppedValue.toFixed(decimalPlaces));
      
      return steppedValue;
    }
    
    // 更新滑塊值和顯示
    function updateSliderValue(newValue) {
      slider.value = newValue;
      
      // 觸發input事件以更新顯示和其他邏輯
      var inputEvent;
      try {
        inputEvent = new Event('input', { bubbles: true });
      } catch (e) {
        // IE/舊瀏覽器兼容
        inputEvent = document.createEvent('HTMLEvents');
        inputEvent.initEvent('input', true, true);
      }
      slider.dispatchEvent(inputEvent);
      
      // 手動更新顯示值（確保格式正確）
      var valueElement = document.getElementById(valueElementId);
      if (valueElement) {
        // 格式化顯示值，避免浮點數精度問題
        var step = parseFloat(slider.step) || 1;
        var decimalPlaces = 0;
        if (step.toString().indexOf('.') !== -1) {
          decimalPlaces = step.toString().split('.')[1].length;
        }
        var formattedValue = parseFloat(newValue.toFixed(decimalPlaces));
        valueElement.textContent = formattedValue + unit;
      }
    }
    
    // 點擊事件處理
    function handleClick(event) {
      // 防止冒泡
      event.preventDefault();
      event.stopPropagation();
      
      var newValue = calculateValueFromClick(event, slider);
      updateSliderValue(newValue);
    }
    
    // 觸摸事件處理
    function handleTouchStart(event) {
      event.preventDefault();
      var newValue = calculateValueFromClick(event, slider);
      updateSliderValue(newValue);
    }
    
    // 添加事件監聽器
    slider.addEventListener('click', handleClick);
    slider.addEventListener('touchstart', handleTouchStart);
    
    console.log('已增強滑塊交互體驗:', slider.id);
  };
  
  // 檢測日文字符
  FlashcardApp.prototype.isJapaneseText = function(text) {
    if (!text) return false;
    
    // 日文字符範圍：
    // 平假名: \u3040-\u309f
    // 片假名: \u30a0-\u30ff
    // 漢字: \u4e00-\u9faf
    // 全角標點: \u3000-\u303f
    var japanesePattern = /[\u3040-\u309f\u30a0-\u30ff\u4e00-\u9faf\u3000-\u303f]/;
    
    return japanesePattern.test(text);
  };

  // 語音播放
  FlashcardApp.prototype.speakEnglishWord = function(text) {
    if (!this.voiceSettings.enabled) return;
    if (!text) return;
    
    // 舊版瀏覽器檢查用戶交互狀態
    if (this.isLegacyBrowser && !this.speechActivated) {
      console.log('舊版瀏覽器：語音未啟用，跳過播放');
      return;
    }
    
    try {
      console.log('播放語音:', text);
      this.speechSynthesis.cancel();
      
      var utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = this.voiceSettings.rate;
      utterance.pitch = this.voiceSettings.pitch;
      utterance.volume = this.voiceSettings.volume;
      utterance.lang = this.voiceSettings.lang;
      
      var voices = this.speechSynthesis.getVoices();
      var selectedVoice = null;
      if (this.voiceSettings.voiceURI) {
        for (var i = 0; i < voices.length; i++) {
          if (voices[i].voiceURI === this.voiceSettings.voiceURI) {
            selectedVoice = voices[i];
            break;
          }
        }
      }
      
      if (!selectedVoice) {
        for (var i = 0; i < voices.length; i++) {
          if (voices[i].lang.indexOf('en-') === 0 || 
              voices[i].name.toLowerCase().indexOf('english') !== -1) {
            selectedVoice = voices[i];
            break;
          }
        }
      }
      
      if (selectedVoice) {
        utterance.voice = selectedVoice;
      }
      
      // 為舊版瀏覽器添加錯誤處理
      utterance.onerror = function(event) {
        console.log('語音播放錯誤:', event.error);
      };
      
      utterance.onstart = function() {
        console.log('語音開始播放:', text);
      };
      
      this.speechSynthesis.speak(utterance);
    } catch (error) {
      console.log('語音播放失敗:', error);
    }
  };
  
  // 日文語音播放
  FlashcardApp.prototype.speakJapaneseWord = function(text) {
    if (!this.voiceSettings.enabled) return;
    if (!text) return;
    
    // 舊版瀏覽器檢查用戶交互狀態
    if (this.isLegacyBrowser && !this.speechActivated) {
      console.log('舊版瀏覽器：語音未啟用，跳過播放');
      return;
    }
    
    try {
      console.log('播放日文語音:', text);
      this.speechSynthesis.cancel();
      
      var utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = this.voiceSettings.rate;
      utterance.pitch = this.voiceSettings.pitch;
      utterance.volume = this.voiceSettings.volume;
      utterance.lang = this.voiceSettings.japaneseLang;
      
      var voices = this.speechSynthesis.getVoices();
      var selectedVoice = null;
      if (this.voiceSettings.japaneseVoiceURI) {
        for (var i = 0; i < voices.length; i++) {
          if (voices[i].voiceURI === this.voiceSettings.japaneseVoiceURI) {
            selectedVoice = voices[i];
            break;
          }
        }
      }
      
      if (!selectedVoice) {
        for (var i = 0; i < voices.length; i++) {
          if (voices[i].lang.indexOf('ja-') === 0 || 
              voices[i].name.toLowerCase().indexOf('japanese') !== -1) {
            selectedVoice = voices[i];
            break;
          }
        }
      }
      
      if (selectedVoice) {
        utterance.voice = selectedVoice;
      }
      
      // 為舊版瀏覽器添加錯誤處理
      utterance.onerror = function(event) {
        console.log('日文語音播放錯誤:', event.error);
      };
      
      utterance.onstart = function() {
        console.log('日文語音開始播放:', text);
      };
      
      this.speechSynthesis.speak(utterance);
    } catch (error) {
      console.log('日文語音播放失敗:', error);
    }
  };
  
  // 智能語音播放（自動檢測語言）
  FlashcardApp.prototype.speakWord = function(text) {
    if (!text) return;
    
    if (this.isJapaneseText(text)) {
      // 文本包含日文字符，使用日文語音
      this.speakJapaneseWord(text);
    } else {
      // 文本不包含日文字符，使用英文語音
      this.speakEnglishWord(text);
    }
  };
  
  // 下一個單字
  FlashcardApp.prototype.nextWord = function() {
    if (this.isTransitioning || this.isPaused) return;
    
    if (this.pendingRemoval) {
      this.confirmRemoval();
        return;
      }
      
    if (!this.showingChinese) {
      this.showSecondPartAndScheduleNext();
        return;
      }
      
    this.saveNavigationState();
    
      if (this.displayTimer) {
        clearTimeout(this.displayTimer);
    }
    
    this.speechSynthesis.cancel();
    
    this.isTransitioning = true;
    
    var englishElement = document.getElementById('english-word');
    var chineseElement = document.getElementById('chinese-word');
    
    englishElement.classList.remove('show');
    chineseElement.classList.remove('show');
    
    chineseElement.textContent = '';
    // 清除背景圖片
    var flashcardDiv = document.getElementById('flashcard');
    if (flashcardDiv) {
      flashcardDiv.style.backgroundImage = '';
      flashcardDiv.classList.remove('has-image');
    }
    
    var self = this;
    setTimeout(function() {
      self.currentIndex = (self.currentIndex + 1) % self.currentWords.length;
      
      if (self.currentIndex === 0) {
        self.shuffleArray(self.currentWords);
        self.navigationHistory = [];
      }
      
      self.displayCurrentWord();
      self.isTransitioning = false;
      
    }, 300);
    this.renderDifficultStar();
  };
  
  // 上一個單字
  FlashcardApp.prototype.previousWord = function() {
    if (this.isTransitioning || this.isPaused) return;
    
    if (this.pendingRemoval) {
      this.cancelRemoval();
      return;
    }
    
    if (this.navigationHistory.length === 0) return;
    
    if (this.displayTimer) {
      clearTimeout(this.displayTimer);
    }
    
    this.speechSynthesis.cancel();
    
    this.isTransitioning = true;
    
    var englishElement = document.getElementById('english-word');
    var chineseElement = document.getElementById('chinese-word');
    
    englishElement.classList.remove('show');
    chineseElement.classList.remove('show');
    
    chineseElement.textContent = '';
    // 清除背景圖片
    var flashcardDiv = document.getElementById('flashcard');
    if (flashcardDiv) {
      flashcardDiv.style.backgroundImage = '';
      flashcardDiv.classList.remove('has-image');
    }
    
    var self = this;
    setTimeout(function() {
      var previousState = self.navigationHistory.pop();
      
      var previousWord = previousState.wordSequence[previousState.currentIndex];
      
      var wordIndex = -1;
      for (var i = 0; i < self.currentWords.length; i++) {
        if (self.currentWords[i].english === previousWord.english && 
            self.currentWords[i].chinese === previousWord.chinese) {
          wordIndex = i;
          break;
        }
      }
      
      if (wordIndex !== -1) {
        self.currentIndex = wordIndex;
      } else {
        self.currentIndex = Math.min(previousState.currentIndex, self.currentWords.length - 1);
        
        if (self.currentWords.length === 0) {
          self.startNewRound();
          self.isTransitioning = false;
        return;
        }
      }
      
      self.displayCurrentWord();
      self.isTransitioning = false;
      
    }, 300);
    this.renderDifficultStar();
  };
  
  // 儲存導航狀態
  FlashcardApp.prototype.saveNavigationState = function() {
    if (this.currentWords.length > 0 && this.currentIndex >= 0) {
      this.navigationHistory.push({
        currentIndex: this.currentIndex,
        wordSequence: this.currentWords.slice()
      });
      
      if (this.navigationHistory.length > 20) {
        this.navigationHistory.shift();
      }
    }
  };
  
  // 確認重新載入單字
  FlashcardApp.prototype.confirmRestart = function() {
    var confirmed = confirm('確定要重新載入單字嗎？\n\n⚠️ 注意：重新載入會恢復所有暫時刪除的單字。');
    if (confirmed) {
      this.restart();
    }
  };

  // 重新載入單字
  FlashcardApp.prototype.restart = function() {
    if (this.displayTimer) {
      clearTimeout(this.displayTimer);
    }
    this.speechSynthesis.cancel();
    this.pendingRemoval = null;
    this.closeMenu();
    
    // 檢查是否有設定的 Google Sheet
    if (this.sheetSettings.sheetId && this.sheetSettings.selectedSheets.length > 0) {
      console.log('重新載入單字，使用已設定的 Google Sheet');
        
        // 顯示載入中訊息
      var loadingDiv = document.getElementById('loading');
      var flashcardDiv = document.getElementById('flashcard');
      if (loadingDiv) loadingDiv.style.display = 'flex';
      if (flashcardDiv) flashcardDiv.style.display = 'none';
      
      var self = this;
      this.loadWords(true, function(hasDuplicates) {
        self.hideLoading();
        self.applySettings();
        
          if (!hasDuplicates) {
          self.startNewRound();
        }
      });
    } else {
      console.log('沒有 Google Sheet 設定，直接重新開始');
            this.startNewRound();
          }
  };
  
  // 切換語音播放
  FlashcardApp.prototype.toggleVoice = function() {
    this.voiceSettings.enabled = !this.voiceSettings.enabled;
    this.saveSettings();
    this.updateVoiceButtonState();
    
    // 停止當前播放的語音
    if (!this.voiceSettings.enabled) {
      this.speechSynthesis.cancel();
    }
  };
  
  // 更新語音按鈕狀態
  FlashcardApp.prototype.updateVoiceButtonState = function() {
    var voiceBtn = document.getElementById('voice-toggle-btn');
    if (voiceBtn) {
      if (this.voiceSettings.enabled) {
        voiceBtn.textContent = '🔊';
        voiceBtn.title = '語音播放：開啟（點擊關閉）';
        voiceBtn.style.opacity = '1';
      } else {
        voiceBtn.textContent = '🔇';
        voiceBtn.title = '語音播放：關閉（點擊開啟）';
        voiceBtn.style.opacity = '0.6';
      }
    }
  };
  
  // 切換暫停/恢復
  FlashcardApp.prototype.togglePause = function() {
    if (this.userPaused) {
      // 用戶手動恢復
      this.userPaused = false;
      this.resumeTimer();
    } else {
      // 用戶手動暫停
      this.userPaused = true;
      this.pauseTimer();
    }
    this.updatePauseButtonState();
  };
  
  // 進入全螢幕模式
  FlashcardApp.prototype.enterFullscreen = function() {
    console.log('嘗試進入全螢幕模式');
    
    var docElement = document.documentElement;
    
    try {
      // 嘗試標準 API
      if (docElement.requestFullscreen) {
        docElement.requestFullscreen();
      }
      // 嘗試 webkit 前綴 (Safari, Chrome)
      else if (docElement.webkitRequestFullscreen) {
        docElement.webkitRequestFullscreen();
      }
      // 嘗試 webkit 前綴 (舊版 Safari)
      else if (docElement.webkitRequestFullScreen) {
        docElement.webkitRequestFullScreen();
      }
      // 嘗試 moz 前綴 (Firefox)
      else if (docElement.mozRequestFullScreen) {
        docElement.mozRequestFullScreen();
      }
      // 嘗試 ms 前綴 (IE/Edge)
      else if (docElement.msRequestFullscreen) {
        docElement.msRequestFullscreen();
      }
      else {
        console.log('此瀏覽器不支援全螢幕 API');
        alert('此瀏覽器不支援全螢幕功能');
        return;
      }
      
      console.log('全螢幕請求已發送');
      
      // 添加全螢幕狀態監聽
      var self = this;
      var fullscreenChangeHandler = function() {
        var isFullscreen = document.fullscreenElement || 
                          document.webkitFullscreenElement || 
                          document.mozFullScreenElement || 
                          document.msFullscreenElement;
        
        if (isFullscreen) {
          console.log('已進入全螢幕模式');
        } else {
          console.log('已退出全螢幕模式');
        }
        
        // 更新按鈕文字
        self.updateFullscreenButtonText();
      };
      
      // 移除舊的監聽器（如果存在）
      document.removeEventListener('fullscreenchange', fullscreenChangeHandler);
      document.removeEventListener('webkitfullscreenchange', fullscreenChangeHandler);
      document.removeEventListener('mozfullscreenchange', fullscreenChangeHandler);
      document.removeEventListener('MSFullscreenChange', fullscreenChangeHandler);
      
      // 添加新的監聽器
      document.addEventListener('fullscreenchange', fullscreenChangeHandler);
      document.addEventListener('webkitfullscreenchange', fullscreenChangeHandler);
      document.addEventListener('mozfullscreenchange', fullscreenChangeHandler);
      document.addEventListener('MSFullscreenChange', fullscreenChangeHandler);
      
    } catch (error) {
      console.error('進入全螢幕時發生錯誤:', error);
      alert('無法進入全螢幕模式，請檢查瀏覽器設定');
    }
  };
  
  // 退出全螢幕模式
  FlashcardApp.prototype.exitFullscreen = function() {
    console.log('嘗試退出全螢幕模式');
    
    try {
      // 嘗試標準 API
      if (document.exitFullscreen) {
        document.exitFullscreen();
      }
      // 嘗試 webkit 前綴 (Safari, Chrome)
      else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      }
      // 嘗試 webkit 前綴 (舊版 Safari)
      else if (document.webkitCancelFullScreen) {
        document.webkitCancelFullScreen();
      }
      // 嘗試 moz 前綴 (Firefox)
      else if (document.mozCancelFullScreen) {
        document.mozCancelFullScreen();
      }
      // 嘗試 ms 前綴 (IE/Edge)
      else if (document.msExitFullscreen) {
        document.msExitFullscreen();
      }
      else {
        console.log('此瀏覽器不支援退出全螢幕 API');
      }
      
      console.log('退出全螢幕請求已發送');
      
    } catch (error) {
      console.error('退出全螢幕時發生錯誤:', error);
    }
  };
  
  // 檢查是否為全螢幕狀態
  FlashcardApp.prototype.isFullscreen = function() {
    return !!(document.fullscreenElement || 
             document.webkitFullscreenElement || 
             document.mozFullScreenElement || 
             document.msFullscreenElement);
  };
  
  // 切換全螢幕狀態
  FlashcardApp.prototype.toggleFullscreen = function() {
    if (this.isFullscreen()) {
      this.exitFullscreen();
    } else {
      this.enterFullscreen();
    }
  };
  
  // 更新全螢幕按鈕文字
  FlashcardApp.prototype.updateFullscreenButtonText = function() {
    var fullscreenBtn = document.getElementById('fullscreen-btn');
    if (fullscreenBtn) {
      if (this.isFullscreen()) {
        fullscreenBtn.textContent = '退出全螢幕';
      } else {
        fullscreenBtn.textContent = '全螢幕';
      }
    }
  };
  
  // 更新暫停按鈕狀態
  FlashcardApp.prototype.updatePauseButtonState = function() {
    var pauseBtn = document.getElementById('pause-btn');
    var controlsWrapper = document.getElementById('controls-wrapper');
    var pausedIndicator = document.getElementById('paused-indicator');
    
    if (pauseBtn) {
      if (this.userPaused) {
        pauseBtn.textContent = '▶️';
        pauseBtn.title = '目前暫停中（點擊恢復）';
        pauseBtn.style.opacity = '0.6';
        
        // 顯示「已暫停」指示器
        if (pausedIndicator) {
          pausedIndicator.style.display = 'flex';
          pausedIndicator.title = '點擊此處恢復播放';
        }
      } else {
        pauseBtn.textContent = '⏸️';
        pauseBtn.title = '目前運行中（點擊暫停）';
        pauseBtn.style.opacity = '1';
        
        // 隱藏「已暫停」指示器
        if (pausedIndicator) {
          pausedIndicator.style.display = 'none';
          pausedIndicator.title = '';
        }
      }
    }
  };

  // 重新顯示當前單字
  FlashcardApp.prototype.redisplayCurrentWord = function() {
    if (this.displayTimer) {
      clearTimeout(this.displayTimer);
      this.displayTimer = null;
    }
    
    this.speechSynthesis.cancel();
    
    this.showingChinese = false;
    this.isTransitioning = false;
    this.isProcessingClick = false;
    this.pendingRemoval = null;
    this.hideRestoreButton();
    
    this.displayCurrentWord();
  };
  
  // 語音設定相關
  FlashcardApp.prototype.openVoiceSettings = function() {
    var modal = document.getElementById('voice-settings-modal');
    if (modal) {
      modal.style.display = 'flex';
      this.pauseTimer();
      
      var speechEnabledSetting = document.getElementById('speech-enabled-setting');
      var voiceRateSetting = document.getElementById('voice-rate-setting');
      var voiceRateValue = document.getElementById('voice-rate-value');
      
      if (speechEnabledSetting) speechEnabledSetting.checked = this.voiceSettings.enabled;
      if (voiceRateSetting) voiceRateSetting.value = this.voiceSettings.rate;
      if (voiceRateValue) {
        // 修復浮點數精度問題
        var step = parseFloat(voiceRateSetting.step) || 0.1;
        var decimalPlaces = step.toString().indexOf('.') !== -1 ? step.toString().split('.')[1].length : 0;
        var formattedRate = parseFloat(this.voiceSettings.rate.toFixed(decimalPlaces));
        voiceRateValue.textContent = formattedRate;
      }
      
      this.populateVoiceSelect();
    }
  };
  
  FlashcardApp.prototype.closeVoiceSettings = function() {
    var modal = document.getElementById('voice-settings-modal');
    if (modal) {
      modal.style.display = 'none';
      this.resumeTimer();
    }
  };
  
  FlashcardApp.prototype.saveVoiceSettingsAndClose = function() {
    var speechEnabledSetting = document.getElementById('speech-enabled-setting');
    var voiceRateSetting = document.getElementById('voice-rate-setting');
    var voiceSelectSetting = document.getElementById('voice-select-setting');
    var japaneseVoiceSelectSetting = document.getElementById('japanese-voice-select-setting');
    
    if (speechEnabledSetting) this.voiceSettings.enabled = speechEnabledSetting.checked;
    if (voiceRateSetting) this.voiceSettings.rate = parseFloat(voiceRateSetting.value);
    
    if (voiceSelectSetting) {
      var selectedVoiceURI = voiceSelectSetting.value;
      this.voiceSettings.voiceURI = selectedVoiceURI;
      var voices = this.speechSynthesis.getVoices();
      for (var i = 0; i < voices.length; i++) {
        if (voices[i].voiceURI === selectedVoiceURI) {
          this.voiceSettings.lang = voices[i].lang;
          break;
        }
      }
    }
    
    if (japaneseVoiceSelectSetting) {
      var selectedJapaneseVoiceURI = japaneseVoiceSelectSetting.value;
      this.voiceSettings.japaneseVoiceURI = selectedJapaneseVoiceURI;
      var voices = this.speechSynthesis.getVoices();
      for (var i = 0; i < voices.length; i++) {
        if (voices[i].voiceURI === selectedJapaneseVoiceURI) {
          this.voiceSettings.japaneseLang = voices[i].lang;
          break;
        }
      }
    }
    
    this.saveSettings();
    this.updateVoiceButtonState();
    this.closeVoiceSettings();
  };
  
  FlashcardApp.prototype.populateVoiceSelect = function() {
    var voiceSelect = document.getElementById('voice-select-setting');
    var japaneseVoiceSelect = document.getElementById('japanese-voice-select-setting');
    var voices = this.speechSynthesis.getVoices();
    
    // 填充英文語音選項
    if (voiceSelect) {
      // 保護select元素
      this.protectSelectElement(voiceSelect);
      
      voiceSelect.innerHTML = '';
      var englishVoices = voices.filter(function(v) { 
        return v.lang && v.lang.indexOf('en') === 0; 
      });
      
      for (var i = 0; i < englishVoices.length; i++) {
        var voice = englishVoices[i];
        var option = document.createElement('option');
        option.value = voice.voiceURI;
        option.textContent = voice.name + ' (' + voice.lang + ')';
        if (voice.voiceURI === this.voiceSettings.voiceURI) {
          option.selected = true;
        }
        voiceSelect.appendChild(option);
      }
      
      if (!voiceSelect.value && englishVoices.length > 0) {
        voiceSelect.value = englishVoices[0].voiceURI;
      }
    }
    
    // 填充日文語音選項
    if (japaneseVoiceSelect) {
      // 保護select元素
      this.protectSelectElement(japaneseVoiceSelect);
      
      japaneseVoiceSelect.innerHTML = '';
      var japaneseVoices = voices.filter(function(v) { 
        return v.lang && v.lang.indexOf('ja') === 0; 
      });
      
      for (var i = 0; i < japaneseVoices.length; i++) {
        var voice = japaneseVoices[i];
        var option = document.createElement('option');
        option.value = voice.voiceURI;
        option.textContent = voice.name + ' (' + voice.lang + ')';
        if (voice.voiceURI === this.voiceSettings.japaneseVoiceURI) {
          option.selected = true;
        }
        japaneseVoiceSelect.appendChild(option);
      }
      
      if (!japaneseVoiceSelect.value && japaneseVoices.length > 0) {
        japaneseVoiceSelect.value = japaneseVoices[0].voiceURI;
      }
    }
  };
  
  // 匯出功能相關（完整版本）
  FlashcardApp.prototype.openExportModal = function() {
      // 預設名稱：目前工作表名稱_yyyyMMdd
    var defaultName = this.getDefaultExportSheetName();
    var exportSheetNameInput = document.getElementById('export-sheet-name');
    var exportTypeRemainingRadio = document.getElementById('export-type-remaining');
    var exportModal = document.getElementById('export-modal');
    
    if (exportSheetNameInput) exportSheetNameInput.value = defaultName;
    if (exportTypeRemainingRadio) exportTypeRemainingRadio.checked = true;
    if (exportModal) exportModal.style.display = 'flex';
    
      this.pauseTimer();
    
    // 重置匯出按鈕狀態和進度顯示
    var confirmBtn = document.getElementById('confirm-export');
      if (confirmBtn) {
        confirmBtn.disabled = false;
        confirmBtn.textContent = '匯出';
      }
    
    // 隱藏進度顯示
    this.hideExportProgress();
  };
  
  FlashcardApp.prototype.closeExportModal = function() {
    var exportModal = document.getElementById('export-modal');
    if (exportModal) exportModal.style.display = 'none';
    
      this.resumeTimer();
    
    // 確保「已暫停」消失
    var pausedIndicator = document.getElementById('paused-indicator');
    if (pausedIndicator) {
      pausedIndicator.style.display = 'none';
      pausedIndicator.title = '';
    }
    
    // 隱藏進度顯示
    this.hideExportProgress();
  };
  
  // 獲取預設匯出工作表名稱
FlashcardApp.prototype.getDefaultExportSheetName = function() {
  // 使用實際載入的工作表名稱作為基礎
  var base = 'Sheet1'; // 預設值
  
  // 如果有選擇的工作表，使用第一個作為基礎名稱
  console.log("this.sheetSettings.selectedSheets", this.sheetSettings.selectedSheets);
  if (this.sheetSettings.selectedSheets && this.sheetSettings.selectedSheets.length > 0) {
    base = this.sheetSettings.selectedSheets[0];
    console.log("base", base);
  }
  
  var date = new Date();
  var y = date.getFullYear();
  var m = (date.getMonth() + 1).toString();
  var d = date.getDate().toString();
  
  // ES5 版本的 padStart
  if (m.length < 2) m = '0' + m;
  if (d.length < 2) d = '0' + d;
  
  return base + '_' + y + m + d;
};
  
  // 顯示匯出進度
  FlashcardApp.prototype.showExportProgress = function() {
    var progressContainer = document.getElementById('export-progress-container');
    if (progressContainer) {
      progressContainer.style.display = 'block';
    }
    
    // 重置進度
    this.updateExportProgress(0, 0, '準備匯出...');
  };
  
  // 隱藏匯出進度
  FlashcardApp.prototype.hideExportProgress = function() {
    var progressContainer = document.getElementById('export-progress-container');
    if (progressContainer) {
      progressContainer.style.display = 'none';
    }
    
    // 清除進度計時器（雖然現在不使用，但保留相容性）
    if (this.progressTimer) {
      clearInterval(this.progressTimer);
      this.progressTimer = null;
    }
    
    // 清除分批匯出狀態
    this.currentBatch = 0;
    this.totalBatches = 0;
    this.processedWords = 0;
    this.totalWords = 0;
    this.exportBatches = null;
    this.isSheetCreated = false;
  };
  
  // 更新匯出進度
  FlashcardApp.prototype.updateExportProgress = function(current, total, message) {
    var progressFill = document.getElementById('export-progress-fill');
    var progressText = document.getElementById('export-progress-text');
    var progressCount = document.getElementById('export-progress-count');
    
    if (progressFill && total > 0) {
      var percentage = Math.min((current / total) * 100, 100);
      progressFill.style.width = percentage + '%';
    }
    
    if (progressText && message) {
      progressText.textContent = message;
    }
    
    if (progressCount && total > 0) {
      progressCount.textContent = current + ' / ' + total;
    }
  };
  
  // 開始分批匯出
  FlashcardApp.prototype.startBatchExport = function(exportData, sheetName, targetSheetId, overwrite) {
    var self = this;
    var batchSize = 15; // 每批處理15個單字
    var batches = [];
    
    // 將資料分成批次
    for (var i = 0; i < exportData.length; i += batchSize) {
      batches.push(exportData.slice(i, i + batchSize));
    }
    
    this.currentBatch = 0;
    this.totalBatches = batches.length;
    this.processedWords = 0;
    this.totalWords = exportData.length;
    this.exportBatches = batches;
    this.exportSheetName = sheetName;
    this.exportTargetSheetId = targetSheetId;
    this.exportOverwrite = overwrite;
    this.isSheetCreated = false; // 追蹤工作表是否已創建
    
    // 開始處理第一批
    this.processBatch();
  };
  
  
// 處理單一批次（修改exportWordsToSheet調用）
FlashcardApp.prototype.processBatch = function() {
  var self = this;
  
  if (this.currentBatch >= this.totalBatches) {
    // 所有批次完成
    this.completeExportProgress();
    setTimeout(function() {
      self.onExportComplete();
    }, 500);
    return;
  }
  
  var currentBatchData = this.exportBatches[this.currentBatch];
  var batchNumber = this.currentBatch + 1;
  var isFirstBatch = this.currentBatch === 0;
  
  // 更新進度顯示
  var message = '正在匯出第 ' + batchNumber + ' 批，共 ' + this.totalBatches + ' 批...';
  this.updateExportProgress(this.processedWords, this.totalWords, message);
  
  // 確定操作模式：第一批次可能需要覆寫，後續批次絕對不覆寫
  var shouldOverwrite = this.exportOverwrite && isFirstBatch;
  
  // 處理當前批次
  google.script.run
    .withSuccessHandler(function(result) {
      console.log('第 ' + batchNumber + ' 批匯出結果:', result);
      
      // 檢查匯出結果
      if (result && result.success === false) {
        // 只有第一批次才處理工作表存在的錯誤
        if (isFirstBatch && result.error === 'SHEET_EXISTS') {
          console.log('第一批次：處理工作表已存在的情況');
          self.handleSheetExistsError(result.message);
          return;
        }
        
        // 處理其他錯誤
        console.error('批次匯出失敗:', result);
        self.hideExportProgress();
        alert('匯出失敗（第 ' + batchNumber + ' 批）：' + (result.message || result.error || '未知錯誤'));
        self.resetExportButton();
        return;
      }
      
      // 批次成功完成
      console.log('第 ' + batchNumber + ' 批成功匯出 ' + currentBatchData.length + ' 個單字');
      self.processedWords += currentBatchData.length;
      self.currentBatch++;
      
      // 標記工作表已創建（第一批次成功後）
      if (isFirstBatch) {
        self.isSheetCreated = true;
      }
      
      // 更新進度
      var progressMessage = '已完成 ' + self.processedWords + ' / ' + self.totalWords + ' 個單字';
      self.updateExportProgress(self.processedWords, self.totalWords, progressMessage);
      
      // 處理下一批（延遲一點讓使用者看到進度更新）
      setTimeout(function() {
        self.processBatch();
      }, 300);
    })
    .withFailureHandler(function(error) {
      console.error('批次匯出失敗:', error);
      self.hideExportProgress();
      alert('匯出失敗（第 ' + batchNumber + ' 批），請重試！\n錯誤：' + error);
      self.resetExportButton();
    })
    .exportWordsToSheet(
      currentBatchData, 
      this.exportSheetName, 
      this.exportTargetSheetId, 
      shouldOverwrite, // 第一批次可能覆寫，後續批次絕對不覆寫
      isFirstBatch // 傳遞是否為第一批次的參數
    );
};
  
  // 匯出完成處理
  FlashcardApp.prototype.onExportComplete = function() {
    var confirmBtn = document.getElementById('confirm-export');
    if (confirmBtn) {
      confirmBtn.disabled = false;
      confirmBtn.textContent = '匯出';
    }
    
    alert('匯出成功！共匯出 ' + this.totalWords + ' 個單字');
    this.closeExportModal();
  };
  
  // 重置匯出按鈕
  FlashcardApp.prototype.resetExportButton = function() {
    var confirmBtn = document.getElementById('confirm-export');
    if (confirmBtn) {
      confirmBtn.disabled = false;
      confirmBtn.textContent = '匯出';
    }
  };
  
  // 完成匯出進度
  FlashcardApp.prototype.completeExportProgress = function() {
    var progressText = document.getElementById('export-progress-text');
    var progressCount = document.getElementById('export-progress-count');
    var progressFill = document.getElementById('export-progress-fill');
    
    // 清除計時器（雖然現在不使用，但保留相容性）
    if (this.progressTimer) {
      clearInterval(this.progressTimer);
      this.progressTimer = null;
    }
    
    // 設定完成狀態
    if (progressFill) {
      progressFill.style.width = '100%';
    }
    
    if (progressText) {
      progressText.textContent = '匯出完成！';
    }
    
    if (progressCount && this.totalWords > 0) {
      progressCount.textContent = this.totalWords + ' / ' + this.totalWords;
    }
  };
  
  FlashcardApp.prototype.confirmExport = function() {
      this.performExport(false);
  };
  
  FlashcardApp.prototype.performExport = function(overwrite) {
    var confirmBtn = document.getElementById('confirm-export');
      if (confirmBtn) {
        confirmBtn.disabled = true;
        confirmBtn.textContent = overwrite ? '覆寫中...' : '匯出中...';
      }
      
    var typeRadio = document.getElementById('export-type-difficult');
    var type = (typeRadio && typeRadio.checked) ? 'difficult' : 'remaining';
    var sheetNameInput = document.getElementById('export-sheet-name');
    var sheetName = (sheetNameInput && sheetNameInput.value.trim()) || this.getDefaultExportSheetName();
    var exportWords = [];
    
      if (type === 'difficult') {
      var self = this;
      exportWords = this.words.filter(function(w) { 
        return self.difficultWords.includes(w.id); 
      });
      } else {
        exportWords = this.currentWords;
      }
      
      // 匯出資料格式
    var exportData = [];
    for (var i = 0; i < exportWords.length; i++) {
      var w = exportWords[i];
      exportData.push({
        english: w.english,
        chinese: w.chinese,
        difficult: this.difficultWords.includes(w.id),
        image: w.image || '',        // 第4列：圖片URL
        imageFormula: w.imageFormula || ''  // 第5列：圖片顯示公式
      });
    }
      
      if (exportData.length === 0) {
        alert('沒有可匯出的單字！');
        if (confirmBtn) {
          confirmBtn.disabled = false;
          confirmBtn.textContent = '匯出';
        }
        return;
      }
    
    // 顯示進度
    this.showExportProgress();
    this.updateExportProgress(0, exportData.length, '準備匯出...');
    
    // 開始分批匯出
    var targetSheetId = this.sheetSettings.sheetId || null;
    this.startBatchExport(exportData, sheetName, targetSheetId, overwrite);
  };
  
  FlashcardApp.prototype.handleSheetExistsError = function(message) {
    var sheetNameInput = document.getElementById('export-sheet-name');
    var currentSheetName = sheetNameInput ? sheetNameInput.value.trim() : '';
    
    // 停止進度顯示
    this.hideExportProgress();
    
    // 重置匯出按鈕
    this.resetExportButton();
      
      // 顯示自定義覆寫確認對話框
      this.showOverwriteConfirmModal(currentSheetName);
  };
  
  FlashcardApp.prototype.showOverwriteConfirmModal = function(sheetName) {
      // 設置工作表名稱
    var existingSheetNameElement = document.getElementById('existing-sheet-name');
    if (existingSheetNameElement) {
      existingSheetNameElement.textContent = sheetName;
    }
      
      // 顯示對話框
    var overwriteModal = document.getElementById('overwrite-confirm-modal');
    if (overwriteModal) {
      overwriteModal.style.display = 'flex';
    }
      
      // 暫停計時器
      this.pauseTimer();
      
      // 綁定事件處理程序
      this.bindOverwriteConfirmEvents();
  };
  
  FlashcardApp.prototype.closeOverwriteConfirmModal = function() {
    var overwriteModal = document.getElementById('overwrite-confirm-modal');
    if (overwriteModal) {
      overwriteModal.style.display = 'none';
    }
    
      this.resumeTimer();
      
      // 移除事件處理程序
      this.unbindOverwriteConfirmEvents();
  };
  
  FlashcardApp.prototype.bindOverwriteConfirmEvents = function() {
    var self = this;
    
      // 移除之前的事件處理程序（如果存在）
      this.unbindOverwriteConfirmEvents();
      
      // 關閉按鈕
    this.closeOverwriteHandler = function() { self.closeOverwriteConfirmModal(); };
    var closeBtn = document.getElementById('close-overwrite-confirm');
    if (closeBtn) {
      closeBtn.addEventListener('click', this.closeOverwriteHandler);
    }
      
      // 使用不同名稱按鈕
    this.useDifferentNameHandler = function() {
      self.closeOverwriteConfirmModal();
      self.suggestAlternativeName();
    };
    var differentNameBtn = document.getElementById('use-different-name');
    if (differentNameBtn) {
      differentNameBtn.addEventListener('click', this.useDifferentNameHandler);
    }
      
      // 覆寫確認按鈕
    this.overwriteConfirmHandler = function() {
      self.closeOverwriteConfirmModal();
      // 重新開始分批匯出，設定覆寫模式
      var exportData = [];
      if (self.exportBatches) {
        // 重新組合所有批次的資料
        for (var i = 0; i < self.exportBatches.length; i++) {
          exportData = exportData.concat(self.exportBatches[i]);
        }
      }
      if (exportData.length > 0) {
        self.showExportProgress();
        // 重置工作表創建狀態
        self.isSheetCreated = false;
        self.startBatchExport(exportData, self.exportSheetName, self.exportTargetSheetId, true);
      } else {
        self.performExport(true);
      }
    };
    var overwriteConfirmBtn = document.getElementById('overwrite-confirm');
    if (overwriteConfirmBtn) {
      overwriteConfirmBtn.addEventListener('click', this.overwriteConfirmHandler);
    }
      
      // 鍵盤事件處理
    this.overwriteKeyHandler = function(event) { self.handleOverwriteKeyboard(event); };
      document.addEventListener('keydown', this.overwriteKeyHandler);
  };
  
  FlashcardApp.prototype.unbindOverwriteConfirmEvents = function() {
      if (this.closeOverwriteHandler) {
      var closeBtn = document.getElementById('close-overwrite-confirm');
      if (closeBtn) {
        closeBtn.removeEventListener('click', this.closeOverwriteHandler);
      }
        this.closeOverwriteHandler = null;
      }
      if (this.useDifferentNameHandler) {
      var differentNameBtn = document.getElementById('use-different-name');
      if (differentNameBtn) {
        differentNameBtn.removeEventListener('click', this.useDifferentNameHandler);
      }
        this.useDifferentNameHandler = null;
      }
      if (this.overwriteConfirmHandler) {
      var overwriteConfirmBtn = document.getElementById('overwrite-confirm');
      if (overwriteConfirmBtn) {
        overwriteConfirmBtn.removeEventListener('click', this.overwriteConfirmHandler);
      }
        this.overwriteConfirmHandler = null;
      }
      if (this.overwriteKeyHandler) {
        document.removeEventListener('keydown', this.overwriteKeyHandler);
        this.overwriteKeyHandler = null;
      }
  };
  
    // 添加鍵盤快捷鍵支持
  FlashcardApp.prototype.handleOverwriteKeyboard = function(event) {
    var overwriteModal = document.getElementById('overwrite-confirm-modal');
    if (overwriteModal && overwriteModal.style.display === 'flex') {
        if (event.key === 'Escape') {
          event.preventDefault();
          this.closeOverwriteConfirmModal();
        } else if (event.key === 'Enter') {
          event.preventDefault();
          // Enter 鍵默認選擇使用不同名稱（較安全的選項）
          this.closeOverwriteConfirmModal();
          this.suggestAlternativeName();
        }
      }
  };
  
  FlashcardApp.prototype.suggestAlternativeName = function() {
    var sheetNameInput = document.getElementById('export-sheet-name');
      if (sheetNameInput) {
        // 生成建議的替代名稱
      var currentName = sheetNameInput.value.trim();
      var suggestedName = this.generateAlternativeSheetName(currentName);
        
        // 更新輸入框值為建議名稱
        sheetNameInput.value = suggestedName;
        sheetNameInput.focus();
        sheetNameInput.select(); // 選取現有文字，方便用戶替換
        
        // 添加錯誤樣式類
      var settingControl = sheetNameInput.closest('.setting-control');
        if (settingControl) {
          settingControl.classList.add('export-error');
        }
        
        // 更新提示文字和樣式
      var hintElement = document.getElementById('sheet-name-hint');
        if (hintElement) {
          hintElement.innerHTML = '💡 已自動建議新名稱，您可以修改後重新匯出';
          hintElement.className = 'sheet-name-hint error';
        }
        
        // 移除錯誤樣式（當用戶開始輸入時）
      var removeErrorStyle = function() {
          if (settingControl) {
            settingControl.classList.remove('export-error');
          }
          if (hintElement) {
            hintElement.innerHTML = '💡 如果工作表已存在，系統會詢問您是否要覆寫';
            hintElement.className = 'sheet-name-hint normal';
          }
          sheetNameInput.removeEventListener('input', removeErrorStyle);
        };
        sheetNameInput.addEventListener('input', removeErrorStyle);
      }
  };
  
  FlashcardApp.prototype.generateAlternativeSheetName = function(originalName) {
    var now = new Date();
    var hours = now.getHours().toString();
    var minutes = now.getMinutes().toString();
    
    // ES5 版本的 padStart
    if (hours.length < 2) hours = '0' + hours;
    if (minutes.length < 2) minutes = '0' + minutes;
    
    var timestamp = hours + minutes;
      
      // 如果原名稱包含時間戳記，則更新時間戳記
    var timePattern = /_\d{4}$/;
      if (timePattern.test(originalName)) {
      return originalName.replace(timePattern, '_' + timestamp);
      } else {
        // 否則添加時間戳記
      return originalName + '_' + timestamp;
    }
  };
  
    // Sheet設定相關（完整實現）
  FlashcardApp.prototype.loadSheetsList = function() {
    // 檢查是否需要使用預設表單
    var sheetIdInput = document.getElementById('sheet-id-input');
    if (sheetIdInput && (!sheetIdInput.value || sheetIdInput.value.trim() === '')) {
      var useDefault = confirm('Google Sheet 欄位是空的。\n\n是否要使用預設的範例表單？\n\n預設表單包含常用的英文單字範例，可以直接開始使用。');
      
      if (useDefault) {
        // 填入預設ID
        var defaultSheetId = '1jrpECEaDgtcXawdO9Rl4raHZ_sqmvnUm7x0bJ4IqfRM';
        sheetIdInput.value = defaultSheetId;
        console.log('用戶選擇使用預設表單，已填入預設ID:', defaultSheetId);
      } else {
        // 用戶拒絕使用預設表單
        console.log('用戶拒絕使用預設表單');
        alert('請輸入您的 Google Sheet ID 或 URL');
        sheetIdInput.focus();
        return;
      }
    }

    var input = this.validateAndGetSheetInput();
    if (!input) return;

    var elements = this.validateSheetUIElements();
    if (!elements) return;

    try {
      var sheetId = this.extractSheetId(input);
      this.updateSheetLoadingUI(elements, true);
      this.performSheetListRequest(sheetId, elements);
    } catch (error) {
      console.error('loadSheetsList 執行過程中發生錯誤:', error);
      alert('錯誤：' + error.message);
    }
  };
  
  FlashcardApp.prototype.validateAndGetSheetInput = function() {
    var sheetIdInput = document.getElementById('sheet-id-input');
    if (!sheetIdInput) {
      console.error('找不到 sheet-id-input 元素');
      alert('系統錯誤：找不到輸入框元素');
      return null;
    }
  
    var input = sheetIdInput.value.trim();
    if (!input) {
      console.warn('用戶未輸入任何內容');
      alert('請輸入 Google Sheet ID 或 URL');
      return null;
    }
  
    return input;
  };
  
  FlashcardApp.prototype.validateSheetUIElements = function() {
    var elements = {
      sheetsList: document.getElementById('sheets-list'),
      sheetsGroup: document.getElementById('sheets-selection-group'),
      loadBtn: document.getElementById('load-sheets-btn')
    };
  
    var elementChecks = [
      { element: elements.sheetsList, name: 'sheets-list', error: '找不到工作表清單元素' },
      { element: elements.sheetsGroup, name: 'sheets-selection-group', error: '找不到工作表選擇組元素' },
      { element: elements.loadBtn, name: 'load-sheets-btn', error: '找不到載入按鈕' }
    ];
  
    for (var i = 0; i < elementChecks.length; i++) {
      var check = elementChecks[i];
      if (!check.element) {
        console.error('找不到 ' + check.name + ' 元素');
        alert('系統錯誤：' + check.error);
        return null;
      }
    }
  
    return elements;
  };
  
  FlashcardApp.prototype.extractSheetId = function(input) {
    console.log('=== extractSheetId 開始執行 ===');
    console.log('輸入內容:', input);
    
    var trimmedInput = input.trim();
    console.log('去除空格後:', trimmedInput);
    
    // 如果看起來像是 URL
    if (trimmedInput.indexOf('docs.google.com/spreadsheets') !== -1) {
      console.log('檢測到 Google Sheets URL');
      // 尋找 /d/ 後面的 ID
      var match = trimmedInput.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
      console.log('正則表達式匹配結果:', match);
      
      if (match && match[1]) {
        console.log('從 URL 提取到 Sheet ID:', match[1]);
        return match[1];
          } else {
        console.error('無法從 URL 中提取 Sheet ID');
        throw new Error('無法從 URL 中提取 Sheet ID，請確認 URL 格式正確');
      }
    }
    
    // 如果看起來像是純 ID (字母數字組合)
    var idPattern = /^[a-zA-Z0-9-_]+$/;
    console.log('檢查是否為純 ID，模式:', idPattern);
    console.log('模式測試結果:', idPattern.test(trimmedInput));
    
    if (idPattern.test(trimmedInput)) {
      console.log('輸入看起來是 Sheet ID:', trimmedInput);
      return trimmedInput;
    }
    
    console.error('輸入格式不正確');
    throw new Error('輸入格式不正確，請輸入有效的 Google Sheet ID 或 URL');
  };
  
  FlashcardApp.prototype.updateSheetLoadingUI = function(elements, isLoading) {
    if (isLoading) {
      elements.sheetsList.innerHTML = '<div class="loading-text">載入中...</div>';
      elements.sheetsGroup.style.display = 'block';
      elements.loadBtn.disabled = true;
      elements.loadBtn.textContent = '載入中...';
          } else {
      elements.loadBtn.disabled = false;
      elements.loadBtn.textContent = '載入工作表清單';
    }
  };
  
  FlashcardApp.prototype.performSheetListRequest = function(sheetId, elements) {
    if (!this.validateGoogleScriptEnvironment()) {
      throw new Error('Google Apps Script 環境不可用');
    }
  
    var self = this;
    var timeout = this.setupSheetRequestTimeout(elements);
    
    google.script.run
      .withSuccessHandler(function(result) {
        self.handleSheetListSuccess(result, elements, timeout);
      })
      .withFailureHandler(function(error) {
        self.handleSheetListFailure(error, elements, timeout);
      })
      .getSheetsList(sheetId);
  };
  
  FlashcardApp.prototype.validateGoogleScriptEnvironment = function() {
    if (typeof google === 'undefined') {
      console.error('google 物件未定義');
      return false;
    }
    if (!google.script || !google.script.run) {
      console.error('Google Apps Script 功能未可用');
      return false;
    }
    return true;
  };
  
  FlashcardApp.prototype.setupSheetRequestTimeout = function(elements) {
    var self = this;
    return setTimeout(function() {
      console.error('載入工作表清單超時 (15秒)');
      elements.sheetsList.innerHTML = '<div class="error-text">載入超時，請檢查網路連接或重試</div>';
      self.updateSheetLoadingUI(elements, false);
    }, 15000);
  };
  
  FlashcardApp.prototype.handleSheetListSuccess = function(result, elements, timeout) {
    clearTimeout(timeout);
    console.log('Google Apps Script 成功回調');
  
    var sheets, spreadsheetName;
    if (result && result.sheets) {
      sheets = result.sheets;
      spreadsheetName = result.spreadsheetName;
    } else if (Array.isArray(result)) {
      sheets = result;
      spreadsheetName = null;
    } else {
      throw new Error('載入工作表清單失敗：返回格式錯誤');
    }
  
    this.availableSheets = sheets;
    this.currentSpreadsheetName = spreadsheetName;
    this.renderSheetsList();
    this.updateSheetLoadingUI(elements, false);
  };
  
  FlashcardApp.prototype.handleSheetListFailure = function(error, elements, timeout) {
    clearTimeout(timeout);
    console.error('載入工作表清單失敗:', error);
  
    var errorMessage = error.message || '未知錯誤';
    var helpMessage = '';
    
    // 根據不同錯誤類型提供具體的幫助訊息
    if (errorMessage.indexOf('權限') !== -1 || errorMessage.indexOf('Permission') !== -1) {
      helpMessage = '<div class="error-help"><strong>解決方案：</strong><br>1. 確認您有存取此 Google Sheet 的權限<br>2. 如果是私人 Sheet，請確保您已登入相同的 Google 帳號<br>3. 嘗試在瀏覽器中直接開啟該 Sheet 確認權限</div>';
    } else if (errorMessage.indexOf('找不到') !== -1 || errorMessage.indexOf('無法開啟') !== -1 || errorMessage.indexOf('not found') !== -1) {
      helpMessage = '<div class="error-help"><strong>解決方案：</strong><br>1. 請檢查 Sheet ID 是否正確<br>2. 確認 Sheet 是否存在且未被刪除<br>3. 如果是 URL，請確保格式正確</div>';
    } else if (errorMessage.indexOf('network') !== -1 || errorMessage.indexOf('網路') !== -1) {
      helpMessage = '<div class="error-help"><strong>解決方案：</strong><br>1. 檢查網路連接<br>2. 稍後重試<br>3. 確認防火牆未阻擋 Google 服務</div>';
          } else {
      helpMessage = '<div class="error-help"><strong>常見解決方案：</strong><br>1. 請刷新頁面重試（按 Ctrl+F5 或 Cmd+Shift+R）<br>2. 確認 Google Sheet ID 格式正確<br>3. 確認您有該 Sheet 的存取權限<br>4. 嘗試直接在瀏覽器開啟該 Sheet</div>';
    }
    
    elements.sheetsList.innerHTML = '<div class="error-text">載入失敗：' + errorMessage + '</div>' + helpMessage;
    this.updateSheetLoadingUI(elements, false);
  };
  
  FlashcardApp.prototype.renderSheetsList = function() {
    console.log('=== renderSheetsList 開始執行 ===');
    console.log('可用工作表數量:', this.availableSheets ? this.availableSheets.length : 0);
    console.log('工作表資料:', this.availableSheets);
    console.log('當前 Google Sheet 名稱:', this.currentSpreadsheetName);
    
    var sheetsList = document.getElementById('sheets-list');
    var sheetsGroup = document.getElementById('sheets-selection-group');
    if (!sheetsList || !sheetsGroup) {
      console.error('找不到 sheets-list 或 sheets-selection-group 元素');
      return;
    }
    
    if (!this.availableSheets || this.availableSheets.length === 0) {
      console.warn('沒有可用的工作表');
      sheetsList.innerHTML = '<div class="error-text">沒有找到工作表</div>';
      var oldTitle = sheetsGroup.querySelector('.sheet-title');
      if (oldTitle) oldTitle.remove();
        return;
      }
      
    console.log('開始清空並重新渲染工作表清單');
    sheetsList.innerHTML = '';
    
    // 先移除舊的標題
    var oldTitle = sheetsGroup.querySelector('.sheet-title');
    if (oldTitle) oldTitle.remove();
    
    // 如果有 Google Sheet 名稱，顯示在 sheetsGroup 最上方
    if (this.currentSpreadsheetName) {
      var sheetTitle = document.createElement('div');
      sheetTitle.className = 'sheet-title';
      sheetTitle.innerHTML = '<div class="sheet-title-text"><strong>Google Sheet:</strong> ' + this.currentSpreadsheetName + '</div>';
      sheetsGroup.insertBefore(sheetTitle, sheetsGroup.firstChild);
      console.log('顯示 Google Sheet 名稱:', this.currentSpreadsheetName);
    }
    
    var self = this;
    for (var index = 0; index < this.availableSheets.length; index++) {
      var sheet = this.availableSheets[index];
      console.log('渲染工作表 ' + (index + 1) + ':', sheet);
      
      var sheetItem = document.createElement('div');
      sheetItem.className = 'sheet-item';
      
      var checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.value = sheet.name;
      
      // 檢查是否應該自動勾選
      if (this.sheetSettings.selectedSheets && this.sheetSettings.selectedSheets.includes(sheet.name)) {
        checkbox.checked = true;
        console.log('自動勾選已載入的工作表:', sheet.name);
      }
      
      (function(sheetName) {
        checkbox.addEventListener('change', function() {
          console.log('工作表選擇狀態改變:', sheetName, checkbox.checked);
          self.toggleSheetSelection();
        });
      })(sheet.name);
      
      var sheetInfo = document.createElement('div');
      sheetInfo.className = 'sheet-info';
      
      var sheetName = document.createElement('div');
      sheetName.className = 'sheet-name';
      sheetName.textContent = sheet.name;
      
      var sheetCount = document.createElement('div');
      sheetCount.className = 'sheet-count';
      sheetCount.textContent = sheet.wordCount + ' 個單字';
      
      sheetInfo.appendChild(sheetName);
      sheetInfo.appendChild(sheetCount);
      
      sheetItem.appendChild(checkbox);
      sheetItem.appendChild(sheetInfo);
      
      (function(currentSheet, currentCheckbox) {
        sheetItem.addEventListener('click', function(e) {
          if (e.target !== currentCheckbox) {
            console.log('點擊工作表項目:', currentSheet.name);
            currentCheckbox.checked = !currentCheckbox.checked;
            self.toggleSheetSelection();
          }
        });
      })(sheet, checkbox);
      
      sheetsList.appendChild(sheetItem);
      console.log('工作表 ' + sheet.name + ' 渲染完成');
    }
    
    console.log('所有工作表渲染完成，更新選擇計數');
    this.updateSelectedCount();
    
    // 檢查是否有已勾選的工作表，如果有則啟用載入按鈕
    var checkboxes = document.querySelectorAll('#sheets-list input[type="checkbox"]');
    var selectedCount = 0;
    for (var i = 0; i < checkboxes.length; i++) {
      if (checkboxes[i].checked) selectedCount++;
    }
    var saveBtn = document.getElementById('save-sheet-settings');
    if (saveBtn && selectedCount > 0) {
      saveBtn.disabled = false;
      console.log('啟用載入單字按鈕，已選擇', selectedCount, '個工作表');
    }
    
    console.log('=== renderSheetsList 執行完成 ===');
  };
  
  FlashcardApp.prototype.toggleSheetSelection = function() {
    var checkboxes = document.querySelectorAll('#sheets-list input[type="checkbox"]');
    var selectedCount = 0;
    for (var i = 0; i < checkboxes.length; i++) {
      if (checkboxes[i].checked) selectedCount++;
    }
    
    var saveBtn = document.getElementById('save-sheet-settings');
    if (saveBtn) {
      saveBtn.disabled = selectedCount === 0;
    }
    this.updateSelectedCount();
  };
  
  FlashcardApp.prototype.updateSelectedCount = function() {
    var checkboxes = document.querySelectorAll('#sheets-list input[type="checkbox"]');
    var selectedCount = 0;
    for (var i = 0; i < checkboxes.length; i++) {
      if (checkboxes[i].checked) selectedCount++;
    }
    var selectedCountElement = document.getElementById('selected-count');
    if (selectedCountElement) {
      selectedCountElement.textContent = '(已選 ' + selectedCount + ' 個)';
    }
  };
  
  FlashcardApp.prototype.saveSheetSettingsAndClose = function() {
    var sheetIdInput = document.getElementById('sheet-id-input');
    var input = sheetIdInput.value.trim();
    
    var checkboxes = document.querySelectorAll('#sheets-list input[type="checkbox"]');
    var selectedSheets = [];
    for (var i = 0; i < checkboxes.length; i++) {
      if (checkboxes[i].checked) {
        selectedSheets.push(checkboxes[i].value);
      }
    }
    
    if (!input || selectedSheets.length === 0) {
      alert('請輸入 Google Sheet ID/URL 並選擇至少一個工作表');
        return;
      }
      
    try {
      var sheetId = this.extractSheetId(input);
      
      this.sheetSettings.sheetId = sheetId;
      this.sheetSettings.selectedSheets = selectedSheets;
      this.saveSheetSettings();
      
      console.log('儲存 Sheet 設定:', this.sheetSettings);
      
      this.closeSheetSettings();
      
      // 顯示載入中訊息
      var loadingDiv = document.getElementById('loading');
      var flashcardDiv = document.getElementById('flashcard');
      if (loadingDiv) loadingDiv.style.display = 'flex';
      if (flashcardDiv) flashcardDiv.style.display = 'none';
      
      // 重新載入單字
      var self = this;
      this.loadWords(false, function(hasDuplicates) {
        self.setupEventListeners();
        self.applySettings();
        
        if (!hasDuplicates) {
          self.startNewRound();
        }
        
        if (loadingDiv) loadingDiv.style.display = 'none';
        if (flashcardDiv) flashcardDiv.style.display = 'flex';
      });
      
    } catch (error) {
      console.error('儲存設定時發生錯誤:', error);
      alert(error.message);
    }
  };
  
  // 重複處理相關（完整版本）
  FlashcardApp.prototype.showAutoProcessingNotification = function(results) {
    console.log('顯示自動處理通知:', results);
    
    // 創建通知元素
    var notification = document.createElement('div');
    notification.className = 'auto-processing-notification';
    notification.innerHTML = 
      '<div class="notification-content">' +
        '<h3>✅ 重複單字已自動處理</h3>' +
        '<p>在記憶體中處理了 ' + results.successCount + '/' + results.totalCount + ' 個重複單字</p>' +
        '<p class="memory-notice">📝 原始Google Sheet未被修改，僅在本次使用中去重</p>' +
        '<button id="close-notification" class="notification-close">×</button>' +
      '</div>';
    
    document.body.appendChild(notification);
    
    var self = this;
    
    // 自動關閉通知
    setTimeout(function() {
      notification.classList.add('fade-out');
      setTimeout(function() {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 300);
    }, 5000);
    
    // 手動關閉通知
    var closeBtn = document.getElementById('close-notification');
    if (closeBtn) {
      closeBtn.addEventListener('click', function() {
        notification.classList.add('fade-out');
        setTimeout(function() {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      });
    }
    
    // 顯示動畫
    setTimeout(function() {
      notification.classList.add('show');
    }, 100);
  };
  
  FlashcardApp.prototype.showDuplicateModal = function() {
    console.log('顯示重複處理模態框');
    
    // 停止任何正在播放的語音
    if (this.speechSynthesis) {
      this.speechSynthesis.cancel();
    }
    
    // 清除任何現有的計時器
    if (this.displayTimer) {
      clearTimeout(this.displayTimer);
      this.displayTimer = null;
    }
    
    var modal = document.getElementById('duplicate-words-modal');
    if (modal) {
      // 重置 modal-body 的 HTML 內容為原始狀態
      var modalBody = modal.querySelector('.modal-body');
      if (modalBody) {
        modalBody.innerHTML = 
          '<div class="duplicate-info">' +
            '<p id="duplicate-summary">找到 <span id="duplicate-count">0</span> 組重複單字，請選擇處理方式：</p>' +
          '</div>' +
          '<div class="duplicate-word-container" id="duplicate-word-container">' +
            '<!-- 重複單字項目將在這裡動態生成 -->' +
          '</div>' +
          '<div class="duplicate-actions" id="duplicate-actions" style="display: none;">' +
            '<div class="current-duplicate-info">' +
              '<h3>處理單字：<strong id="current-duplicate-english"></strong></h3>' +
              '<div id="duplicate-options-container">' +
                '<!-- 處理選項將在這裡動態生成 -->' +
              '</div>' +
            '</div>' +
          '</div>';
      }
      
      // 重置 modal-footer 的 HTML 內容為原始狀態
      var modalFooter = modal.querySelector('.modal-footer');
      if (modalFooter) {
        modalFooter.innerHTML = 
          '<button id="skip-duplicates" class="secondary-btn">跳過，稍後處理</button>' +
          '<button id="process-all-duplicates" class="primary-btn">開始處理</button>' +
          '<button id="confirm-duplicate-action" class="primary-btn" style="display: none;">確認操作</button>' +
          '<button id="next-duplicate" class="primary-btn" style="display: none;">下一個</button>';
        modalFooter.style.display = '';
      }
      
      modal.style.display = 'flex';
      this.pauseTimer();
      
      // 更新重複單字數量
      var duplicateCountElement = document.getElementById('duplicate-count');
      if (duplicateCountElement) {
        duplicateCountElement.textContent = this.duplicateWords.length;
      }
      
      // 渲染重複單字清單
      this.renderDuplicateWordsList();
      
      this.setupDuplicateModalEvents();
    }
  };
  
  FlashcardApp.prototype.setupDuplicateModalEvents = function() {
    var self = this;
    
    // 跳過處理按鈕
    var skipBtn = document.getElementById('skip-duplicates');
    if (skipBtn) {
      skipBtn.addEventListener('click', function() {
        self.skipDuplicates();
      });
    }
    
    // 開始處理按鈕
    var processBtn = document.getElementById('process-all-duplicates');
    if (processBtn) {
      processBtn.addEventListener('click', function() {
        self.processAllDuplicates();
      });
    }
    
    // 確認操作按鈕
    var confirmBtn = document.getElementById('confirm-duplicate-action');
    if (confirmBtn) {
      confirmBtn.addEventListener('click', function() {
        self.confirmDuplicateAction();
      });
    }
    
    // 下一個按鈕
    var nextBtn = document.getElementById('next-duplicate');
    if (nextBtn) {
      nextBtn.addEventListener('click', function() {
        self.nextDuplicate();
      });
    }
    
    // 關閉按鈕
    var closeBtn = document.getElementById('close-duplicate-modal');
    if (closeBtn) {
      closeBtn.addEventListener('click', function() {
        self.closeDuplicateModal();
      });
    }
  };
  
  FlashcardApp.prototype.closeDuplicateModal = function() {
    var modal = document.getElementById('duplicate-words-modal');
    if (modal) {
      modal.style.display = 'none';
      this.resumeTimer();
    }
  };
  
  // 跳過重複處理（自動處理）
  FlashcardApp.prototype.skipDuplicates = function() {
    console.log('跳過重複處理 - 執行本地自動處理邏輯（僅記憶體處理）');
    
    try {
      var result = this.processDuplicatesInMemory(this.words, this.duplicateWords);
        
        if (result.success) {
          // 更新當前單字陣列
          this.words = result.processedWords;
        this.difficultWords = this.words.filter(function(w) { return w.difficult; }).map(function(w) { return w.id; });
          
          // 顯示成功結果
        var modal = document.getElementById('duplicate-words-modal');
        var modalBody = modal.querySelector('.modal-body');
        var modalFooter = modal.querySelector('.modal-footer');
          modalFooter.style.display = 'none';
          
        var successCount = result.successCount || 0;
        var totalCount = result.totalCount || 0;
        var removedCount = result.removedCount || 0;
        
        modalBody.innerHTML = 
          '<div class="auto-processing-result success">' +
            '<h3>✅ 自動處理完成！</h3>' +
            '<p>成功處理 ' + successCount + '/' + totalCount + ' 個重複單字</p>' +
            '<p>原始單字數量：' + result.originalCount + '，處理後數量：' + result.processedCount + '</p>' +
            '<p>已移除重複項目：' + removedCount + ' 個</p>' +
            '<p class="sheet-modify-notice">✅ Google Sheet未被修改，僅在記憶體中處理</p>' +
            '<button id="finish-auto-processing" class="primary-btn">完成</button>' +
          '</div>';
        
        var self = this;
        document.getElementById('finish-auto-processing').addEventListener('click', function() {
          self.closeDuplicateModal();
          self.setupEventListeners();
          self.applySettings();
          self.startNewRound();
          });
        } else {
          throw new Error(result.error || '處理失敗');
        }
      } catch (error) {
      console.error('本地處理失敗:', error);
      alert('自動處理失敗：' + error.message);
      }
  };
    
  // 在記憶體中處理重複單字
  FlashcardApp.prototype.processDuplicatesInMemory = function(allWords, duplicates) {
      try {
        console.log('在前端記憶體中自動處理重複單字，總數:', duplicates.length);
        
      var results = [];
      var wordsToRemove = []; // 記錄要從記憶體中移除的單字ID
      var wordsToModify = {}; // 記錄要修改定義的單字ID和新定義
      
      for (var i = 0; i < duplicates.length; i++) {
        var duplicate = duplicates[i];
          console.log('處理重複單字:', duplicate.english, '是否相同定義:', duplicate.isSameDefinition);
          
          if (duplicate.isSameDefinition) {
            // 中文意義相同：保留第一個工作表的，移除其他
          var keepWord = duplicate.words[0];
          var removeWords = duplicate.words.slice(1);
            
            console.log('相同定義，保留第一個工作表:', keepWord.sheetName);
            
            // 記錄要移除的單字ID
          for (var j = 0; j < removeWords.length; j++) {
            wordsToRemove.push(removeWords[j].id);
          }
            
            results.push({
              english: duplicate.english,
              action: 'keep_first',
              success: true,
              keptSheet: keepWord.sheetName,
              removedCount: removeWords.length
            });
          } else {
            // 中文意義不同：合併定義到第一個工作表的單字
          var targetWord = duplicate.words[0];
          var mergeWords = duplicate.words.slice(1);
            
            console.log('不同定義，合併到第一個工作表:', targetWord.sheetName);
            
            // 準備合併後的定義
          var allDefinitions = [];
          for (var k = 0; k < duplicate.words.length; k++) {
            allDefinitions.push((k + 1) + '. ' + duplicate.words[k].chinese.trim());
          }
          var mergedDefinition = allDefinitions.join('\n');
            
            // 記錄要修改的單字
          wordsToModify[targetWord.id] = mergedDefinition;
            
            // 記錄要移除的單字ID
          for (var l = 0; l < mergeWords.length; l++) {
            wordsToRemove.push(mergeWords[l].id);
          }
            
            results.push({
              english: duplicate.english,
              action: 'merge_to_first',
              success: true,
              targetSheet: targetWord.sheetName,
              mergedDefinition: mergedDefinition,
              removedCount: mergeWords.length
            });
          }
        }
        
        // 處理單字陣列：移除重複項目並修改定義
      var processedWords = [];
      for (var m = 0; m < allWords.length; m++) {
        var word = allWords[m];
        
        if (wordsToRemove.indexOf(word.id) !== -1) {
            // 跳過要移除的單字
            continue;
          }
          
        if (wordsToModify.hasOwnProperty(word.id)) {
            // 修改定義
          var modifiedWord = {};
          for (var key in word) {
            if (word.hasOwnProperty(key)) {
              modifiedWord[key] = word[key];
            }
          }
          modifiedWord.chinese = wordsToModify[word.id];
            processedWords.push(modifiedWord);
          } else {
            // 保持原樣
            processedWords.push(word);
          }
        }
        
      var successCount = results.filter(function(r) { return r.success; }).length;
      var removedCount = wordsToRemove.length;
        
        return {
          success: true,
          results: results,
          successCount: successCount,
        totalCount: duplicates.length,
        removedCount: removedCount,
          originalCount: allWords.length,
          processedCount: processedWords.length,
        processedWords: processedWords
        };
      
      } catch (error) {
      console.error('記憶體處理錯誤:', error);
        return {
          success: false,
        error: error.message || '處理過程中發生錯誤'
      };
    }
  };
  
  // 開始處理所有重複
  FlashcardApp.prototype.processAllDuplicates = function() {
    console.log('開始處理重複');
    if (this.duplicateWords.length > 0) {
      this.currentDuplicateIndex = 0;
      this.duplicateProcessingResults = [];
      this.selectDuplicateWord(0);
    }
  };
  
  // 渲染重複單字清單
  FlashcardApp.prototype.renderDuplicateWordsList = function() {
    var container = document.getElementById('duplicate-word-container');
    if (!container) return;
    
    container.innerHTML = '';
    
    for (var i = 0; i < this.duplicateWords.length; i++) {
      var duplicate = this.duplicateWords[i];
      var wordItem = document.createElement('div');
      wordItem.className = 'duplicate-word-item';
      wordItem.setAttribute('data-index', i);
      
      var wordHeader = document.createElement('div');
      wordHeader.className = 'duplicate-word-header';
      wordHeader.innerHTML = '<strong>' + duplicate.english + '</strong> (' + 
        (duplicate.isSameDefinition ? '相同定義' : '不同定義') + ')';
      
      var wordSources = document.createElement('div');
      wordSources.className = 'duplicate-word-sources';
      
      for (var j = 0; j < duplicate.words.length; j++) {
        var word = duplicate.words[j];
        var sourceItem = document.createElement('div');
        sourceItem.className = 'duplicate-source-item';
        sourceItem.innerHTML = '<span class="source-sheet">' + word.sheetName + '</span>: ' + word.chinese;
        wordSources.appendChild(sourceItem);
      }
      
      wordItem.appendChild(wordHeader);
      wordItem.appendChild(wordSources);
      
      var self = this;
      (function(index) {
        wordItem.addEventListener('click', function() {
          self.selectDuplicateWord(index);
        });
      })(i);
      
      container.appendChild(wordItem);
    }
  };
  
  // 選擇要處理的重複單字
  FlashcardApp.prototype.selectDuplicateWord = function(index) {
    console.log('選擇重複單字，索引:', index);
    
    // 清除之前的選中狀態
    var items = document.querySelectorAll('.duplicate-word-item');
    for (var i = 0; i < items.length; i++) {
      items[i].classList.remove('selected');
    }
    
    // 選中當前項目
    var selectedItem = document.querySelector('[data-index="' + index + '"]');
    if (selectedItem) {
      selectedItem.classList.add('selected');
    }
    
    this.currentDuplicateIndex = index;
    
    // 更新按鈕狀態
    var processBtn = document.getElementById('process-all-duplicates');
    var confirmBtn = document.getElementById('confirm-duplicate-action');
    var nextBtn = document.getElementById('next-duplicate');
    
    if (processBtn) processBtn.style.display = 'none';
    if (confirmBtn) {
      confirmBtn.style.display = 'inline-block';
      confirmBtn.disabled = false;
      confirmBtn.textContent = '確認操作';
    }
    if (nextBtn) nextBtn.style.display = 'none';
    
    // 顯示處理選項
    this.showDuplicateOptions(this.duplicateWords[index]);
  };
  
  // 顯示重複單字處理選項
  FlashcardApp.prototype.showDuplicateOptions = function(duplicate) {
    var actionsDiv = document.getElementById('duplicate-actions');
    var englishSpan = document.getElementById('current-duplicate-english');
    var optionsContainer = document.getElementById('duplicate-options-container');
    
    if (!englishSpan || !optionsContainer) return;
    
    englishSpan.textContent = duplicate.english;
    optionsContainer.innerHTML = '';
    actionsDiv.style.display = 'block';
    
    if (duplicate.isSameDefinition) {
      // 定義相同：選擇保留哪一個
      var keepOption = document.createElement('div');
      keepOption.className = 'duplicate-option';
      keepOption.innerHTML = 
        '<div class="option-header">' +
          '<input type="radio" name="duplicate-action" value="keep" class="option-radio" checked>' +
          '<span class="option-title">保留其中一個，刪除其他</span>' +
        '</div>' +
        '<div class="option-description">選擇要保留的工作表版本，其他版本將被永久刪除</div>' +
        '<div class="merge-target-selection" id="keep-target-selection"></div>';
      
      var targetSelection = keepOption.querySelector('#keep-target-selection');
      for (var i = 0; i < duplicate.words.length; i++) {
        var word = duplicate.words[i];
        var targetOption = document.createElement('div');
        targetOption.className = 'merge-target-option';
        targetOption.innerHTML = 
          '<input type="radio" name="keep-target" value="' + i + '" class="merge-target-radio" ' + 
          (i === 0 ? 'checked' : '') + '>' +
          '<span class="merge-target-label">保留 ' + word.sheetName + ': ' + word.chinese + '</span>';
        
        (function(option) {
          targetOption.addEventListener('click', function(e) {
            if (e.target.type !== 'radio') {
              var radio = option.querySelector('input[type="radio"]');
              if (radio) radio.checked = true;
            }
          });
        })(targetOption);
        
        targetSelection.appendChild(targetOption);
      }
      
      optionsContainer.appendChild(keepOption);
          } else {
      // 定義不同：保留一個或合併
      var keepOption = document.createElement('div');
      keepOption.className = 'duplicate-option';
      keepOption.innerHTML = 
        '<div class="option-header">' +
          '<input type="radio" name="duplicate-action" value="keep" class="option-radio" checked>' +
          '<span class="option-title">保留其中一個，刪除其他</span>' +
        '</div>' +
        '<div class="option-description">選擇要保留的工作表版本，其他版本將被永久刪除</div>' +
        '<div class="merge-target-selection" id="keep-target-selection"></div>';
      
      var targetSelection = keepOption.querySelector('#keep-target-selection');
      for (var j = 0; j < duplicate.words.length; j++) {
        var word = duplicate.words[j];
        var targetOption = document.createElement('div');
        targetOption.className = 'merge-target-option';
        targetOption.innerHTML = 
          '<input type="radio" name="keep-target" value="' + j + '" class="merge-target-radio" ' + 
          (j === 0 ? 'checked' : '') + '>' +
          '<span class="merge-target-label">保留 ' + word.sheetName + ': ' + word.chinese + '</span>';
        
        (function(option) {
          targetOption.addEventListener('click', function(e) {
            if (e.target.type !== 'radio') {
              var radio = option.querySelector('input[type="radio"]');
              if (radio) radio.checked = true;
            }
          });
        })(targetOption);
        
        targetSelection.appendChild(targetOption);
      }
      
      var mergeOption = document.createElement('div');
      mergeOption.className = 'duplicate-option';
      mergeOption.innerHTML = 
        '<div class="option-header">' +
          '<input type="radio" name="duplicate-action" value="merge" class="option-radio">' +
          '<span class="option-title">合併所有定義</span>' +
        '</div>' +
        '<div class="option-description">將所有定義合併到選定的工作表中，其他版本將被刪除</div>' +
        '<div class="merge-target-selection" id="merge-target-selection"></div>';
      
      var mergeTargetSelection = mergeOption.querySelector('#merge-target-selection');
      for (var k = 0; k < duplicate.words.length; k++) {
        var word = duplicate.words[k];
        var targetOption = document.createElement('div');
        targetOption.className = 'merge-target-option';
        targetOption.innerHTML = 
          '<input type="radio" name="merge-target" value="' + k + '" class="merge-target-radio" ' + 
          (k === 0 ? 'checked' : '') + '>' +
          '<span class="merge-target-label">合併到 ' + word.sheetName + '</span>';
        
        (function(option) {
          targetOption.addEventListener('click', function(e) {
            if (e.target.type !== 'radio') {
              var radio = option.querySelector('input[type="radio"]');
              if (radio) radio.checked = true;
            }
          });
        })(targetOption);
        
        mergeTargetSelection.appendChild(targetOption);
      }
      
      optionsContainer.appendChild(keepOption);
      optionsContainer.appendChild(mergeOption);
    }
  };
    
    // 確認處理當前重複項目
  FlashcardApp.prototype.confirmDuplicateAction = function() {
    var confirmBtn = document.getElementById('confirm-duplicate-action');
      if (confirmBtn && confirmBtn.disabled) {
        console.log('處理已在進行中，忽略重複調用');
        return;
      }
  
    console.log('確認處理重複單字');
      
    var duplicate = this.duplicateWords[this.currentDuplicateIndex];
    var actionRadio = document.querySelector('input[name="duplicate-action"]:checked');
      
      if (!actionRadio) {
        alert('請選擇處理方式');
        return;
      }
      
    var action = actionRadio.value;
    var targetIndex = 0;
      
      if (action === 'keep') {
      var targetRadio = document.querySelector('input[name="keep-target"]:checked');
        if (targetRadio) {
          targetIndex = parseInt(targetRadio.value);
        }
      } else if (action === 'merge') {
      var targetRadio = document.querySelector('input[name="merge-target"]:checked');
        if (targetRadio) {
          targetIndex = parseInt(targetRadio.value);
        }
      }
      
      // 顯示處理中狀態
      this.showProcessingIndicator();
      
      // 準備處理參數
    var targetWord = duplicate.words[targetIndex];
    var otherWords = duplicate.words.filter(function(word, index) { return index !== targetIndex; });
      
      console.log('目標單字:', targetWord);
      console.log('要刪除的單字:', otherWords);
      
      // 設置超時機制，防止永久卡住
    var self = this;
    var timeoutId = setTimeout(function() {
        console.error('處理超時');
      self.showProcessingResult(false, '處理超時，請檢查網路連接後重試');
      }, 30000); // 30秒超時
      
      // 定義成功處理函數
    var handleSuccess = function(result) {
        clearTimeout(timeoutId);
        console.log('處理成功回調被觸發，結果:', result);
      
      var isSuccess = false;
      var deletedCount = 0;
      var errorMessage = '';
        
        if (result === true || result === 'true') {
          isSuccess = true;
          deletedCount = otherWords.length;
        } else if (result && typeof result === 'object') {
          isSuccess = result.success === true || result.success === 'true';
          deletedCount = result.deletedCount || otherWords.length;
          errorMessage = result.error || '';
        } else if (result && result.toString().toLowerCase() === 'success') {
          isSuccess = true;
          deletedCount = otherWords.length;
        } else {
          console.warn('未知的結果格式，嘗試解析:', result);
        isSuccess = !!result;
          deletedCount = isSuccess ? otherWords.length : 0;
        }
        
        console.log('解析後的結果 - 成功:', isSuccess, '刪除數量:', deletedCount);
        
        if (isSuccess) {
        var message = action === 'merge' 
          ? '成功合併到 ' + targetWord.sheetName + '，刪除了 ' + deletedCount + ' 個重複項目'
          : '成功保留 ' + targetWord.sheetName + ' 中的單字，刪除了 ' + deletedCount + ' 個重複項目';
        
        self.showProcessingResult(true, message);
        self.duplicateProcessingResults.push({
          duplicate: self.duplicateWords[self.currentDuplicateIndex],
            action: action,
            success: true,
            result: { success: true, deletedCount: deletedCount }
          });
        } else {
        var failureMessage = errorMessage || '處理結果格式錯誤或未成功';
        self.showProcessingResult(false, failureMessage);
        self.duplicateProcessingResults.push({
          duplicate: self.duplicateWords[self.currentDuplicateIndex],
            action: action,
            success: false,
            error: failureMessage
          });
        }
      };
      
      // 定義失敗處理函數
    var handleFailure = function(error) {
        clearTimeout(timeoutId);
        console.error('處理失敗:', error);
        
      var errorMessage = error && error.message ? error.message : '未知錯誤';
      self.showProcessingResult(false, '處理失敗：' + errorMessage);
      self.duplicateProcessingResults.push({
        duplicate: self.duplicateWords[self.currentDuplicateIndex],
          action: action,
          success: false,
          error: errorMessage
        });
      };
      
      // 檢查必要的參數
      if (!this.sheetSettings.sheetId) {
        handleFailure(new Error('Google Sheet ID 未設定'));
        return;
      }
      
      if (!targetWord || !targetWord.sheetName) {
        handleFailure(new Error('目標單字資料不完整'));
        return;
      }
      
      // 檢查 Google Apps Script 是否可用
      if (typeof google === 'undefined' || !google.script || !google.script.run) {
        handleFailure(new Error('Google Apps Script 環境不可用'));
        return;
      }
      
      try {
        if (action === 'keep') {
          // 保留一個，刪除其他
          console.log('調用 handleDuplicateWordKeepOne');
          google.script.run
            .withSuccessHandler(handleSuccess)
            .withFailureHandler(handleFailure)
            .handleDuplicateWordKeepOne(this.sheetSettings.sheetId, targetWord, otherWords);
        } else if (action === 'merge') {
          // 合併定義
          console.log('調用 handleDuplicateWordMerge');
          google.script.run
            .withSuccessHandler(handleSuccess)
            .withFailureHandler(handleFailure)
            .handleDuplicateWordMerge(this.sheetSettings.sheetId, targetWord, otherWords);
        }
      } catch (error) {
        console.error('調用 Google Apps Script 時發生錯誤:', error);
        handleFailure(error);
      }
  };
    
    // 顯示處理中指示器
  FlashcardApp.prototype.showProcessingIndicator = function() {
    var optionsContainer = document.getElementById('duplicate-options-container');
    optionsContainer.innerHTML = 
      '<div class="processing-indicator">' +
        '<div class="processing-spinner"></div>' +
        '<span class="processing-text">處理中...</span>' +
      '</div>';
    
    var confirmBtn = document.getElementById('confirm-duplicate-action');
      if (confirmBtn) {
        confirmBtn.disabled = true;
        confirmBtn.textContent = '處理中...';
      }
      
    var nextBtn = document.getElementById('next-duplicate');
      if (nextBtn) {
        nextBtn.style.display = 'none';
      }
  };
    
    // 顯示處理結果
  FlashcardApp.prototype.showProcessingResult = function(success, message) {
    var optionsContainer = document.getElementById('duplicate-options-container');
    optionsContainer.innerHTML = 
      '<div class="' + (success ? 'duplicate-result-success' : 'duplicate-result-error') + '">' +
        message +
      '</div>';
    
      if (success) {
      // 從重複清單中移除這個項目
        this.duplicateWords.splice(this.currentDuplicateIndex, 1);
        
        // 調整當前索引
        if (this.currentDuplicateIndex >= this.duplicateWords.length) {
          this.currentDuplicateIndex = this.duplicateWords.length - 1;
        }
        
        // 重新渲染重複清單
        this.renderDuplicateWordsList();
        
        // 更新重複數量顯示
      var duplicateCount = document.getElementById('duplicate-count');
        if (duplicateCount) {
          duplicateCount.textContent = this.duplicateWords.length;
        }
      }
      
      // 更新按鈕狀態
    var confirmBtn = document.getElementById('confirm-duplicate-action');
    var nextBtn = document.getElementById('next-duplicate');
      
    if (confirmBtn) confirmBtn.style.display = 'none';
    if (nextBtn) {
      nextBtn.style.display = 'inline-block';
      nextBtn.disabled = false;
      
      if (this.duplicateWords.length === 0) {
        nextBtn.textContent = '完成處理';
      } else if (this.currentDuplicateIndex >= this.duplicateWords.length - 1) {
        nextBtn.textContent = '完成處理';
      } else {
        nextBtn.textContent = '下一個';
      }
    }
  };
    
    // 處理下一個重複項目
  FlashcardApp.prototype.nextDuplicate = function() {
    console.log('處理下一個重複項目');
      
      if (this.duplicateWords.length === 0 || this.currentDuplicateIndex >= this.duplicateWords.length) {
        this.finishDuplicateProcessing();
      } else {
      var confirmBtn = document.getElementById('confirm-duplicate-action');
      var nextBtn = document.getElementById('next-duplicate');
      
      if (confirmBtn) {
        confirmBtn.style.display = 'inline-block';
        confirmBtn.disabled = false;
        confirmBtn.textContent = '確認操作';
      }
      if (nextBtn) nextBtn.style.display = 'none';
      
      this.selectDuplicateWord(this.currentDuplicateIndex);
      }
  };
    
    // 完成重複處理
  FlashcardApp.prototype.finishDuplicateProcessing = function() {
      console.log('完成重複處理');
      
      // 顯示處理摘要
    var successCount = this.duplicateProcessingResults ? 
      this.duplicateProcessingResults.filter(function(r) { return r.success; }).length : 0;
    var totalCount = this.duplicateProcessingResults ? this.duplicateProcessingResults.length : 0;
      
    alert('重複處理完成！\n成功處理: ' + successCount + '/' + totalCount + ' 個重複項目');
      
      // 關閉Modal
      this.closeDuplicateModal();
      
      // 重新載入單字（以反映更改）
      this.reloadWordsAfterDuplicateProcessing();
  };
    
    // 重複處理後重新載入單字
  FlashcardApp.prototype.reloadWordsAfterDuplicateProcessing = function() {
      console.log('重複處理後重新載入單字');
      
      // 顯示載入狀態
    var loadingDiv = document.getElementById('loading');
    var flashcardDiv = document.getElementById('flashcard');
    if (loadingDiv) loadingDiv.style.display = 'flex';
    if (flashcardDiv) flashcardDiv.style.display = 'none';
    
    // 重新載入單字
    var self = this;
    this.loadWords(false, function(hasDuplicates) {
      self.setupEventListeners();
      self.applySettings();
      
      if (!hasDuplicates) {
        self.startNewRound();
      }
      
      if (loadingDiv) loadingDiv.style.display = 'none';
      if (flashcardDiv) flashcardDiv.style.display = 'flex';
    });
  };
  
  // 防止螢幕關閉功能
  FlashcardApp.prototype.enableKeepScreenAwake = function() {
    console.log('啟用防止螢幕關閉功能');
    
    // 嘗試使用Wake Lock API（新版瀏覽器）
    if (this.tryWakeLockAPI()) {
      console.log('使用Wake Lock API防止螢幕關閉');
      return;
    }
    
    // 使用NoSleep.js方法（播放無聲視頻）
    if (this.tryNoSleepVideo()) {
      console.log('使用無聲視頻防止螢幕關閉');
      return;
    }
    
    // 備用方案：定期執行操作
    this.tryKeepAliveMethod();
    console.log('使用定期執行操作防止螢幕關閉');
  };
  
  // 嘗試使用Wake Lock API
  FlashcardApp.prototype.tryWakeLockAPI = function() {
    if ('wakeLock' in navigator) {
      var self = this;
      
      navigator.wakeLock.request('screen').then(function(wakeLock) {
        self.wakeLock = wakeLock;
        console.log('Wake Lock API 已啟用');
        
        // 監聽頁面可見性變化
        document.addEventListener('visibilitychange', function() {
          if (self.wakeLock !== null && document.visibilityState === 'visible') {
            // 頁面重新可見時重新請求Wake Lock
            navigator.wakeLock.request('screen').then(function(wakeLock) {
              self.wakeLock = wakeLock;
            }).catch(function(error) {
              console.log('重新請求Wake Lock失敗:', error);
            });
          }
        });
        
        return true;
      }).catch(function(error) {
        console.log('Wake Lock API 請求失敗:', error);
        return false;
      });
      
      return true;
    }
    return false;
  };
  
  // 嘗試使用NoSleep視頻方法
  FlashcardApp.prototype.tryNoSleepVideo = function() {
    try {
      // 創建無聲視頻元素
      var video = document.createElement('video');
      video.setAttribute('muted', '');
      video.setAttribute('playsinline', '');
      video.setAttribute('loop', '');
      video.style.position = 'fixed';
      video.style.top = '0';
      video.style.left = '0';
      video.style.width = '1px';
      video.style.height = '1px';
      video.style.opacity = '0';
      video.style.pointerEvents = 'none';
      video.style.zIndex = '-1';
      
      // 創建無聲視頻數據URL（1x1像素，極短的無聲視頻）
      var videoDataUrl = 'data:video/mp4;base64,AAAAIGZ0eXBtcDQyAAACAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQAAAr1tZGF0AAACrgYF//+q3EXpvebZSLeWLNgg2SPu73gyNjQgLSBjb3JlIDE0OCByMjYwMSBNIGU5YjVmMzMgLSBILjI2NC9NUEVHLTQgQVZDIGNvZGVjIC0gQ29weWxlZnQgMjAwMy0yMDE2IC0gaHR0cDovL3d3dy52aWRlb2xhbi5vcmcveDI2NC5odG1sIC0gb3B0aW9uczogY2FiYWM9MSByZWY9MyBkZWJsb2NrPTE6MDowIGFuYWx5c2U9MHgzOjB4MTEzIG1lPWhleCBzdWJtZT03IHBzeT0xIHBzeV9yZD0xLjAwOjAuMDAgbWl4ZWRfcmVmPTEgbWVfcmFuZ2U9MTYgY2hyb21hX21lPTEgdHJlbGxpcz0xIDh4OGRjdD0xIGNxbT0wIGRlYWR6b25lPTIxLDExIGZhc3RfcHNraXA9MSBjaHJvbWFfcXBfb2Zmc2V0PS0yIHRocmVhZHM9MSBsb29rYWhlYWRfdGhyZWFkcz0xIHNsaWNlZF90aHJlYWRzPTAgbnI9MCBkZWNpbWF0ZT0xIGludGVybGFjZWQ9MCBibHVyYXlfY29tcGF0PTAgY29uc3RyYWluZWRfaW50cmE9MCBicmFtZXM9MyBiX3B5cmFtaWQ9MiBiX2FkYXB0PTEgYl9iaWFzPTAgZGlyZWN0PTEgd2VpZ2h0Yj0xIG9wZW5fZ29wPTAgd2VpZ2h0cD0yIGtleWludD0yNTAga2V5aW50X21pbj0yNSBzY2VuZWN1dD00MCBpbnRyYV9yZWZyZXNoPTAgcmNfbG9va2FoZWFkPTQwIHJjPWNyZiBtYnRyZWU9MSBjcmY9MjMuMCBxY29tcD0wLjYwIHFwbWluPTAgcXBtYXg9NjkgcXBzdGVwPTQgaXBfcmF0aW89MS40MCBhcT0xOjEuMDAAgAAAAFZliIQL8mKAAKvMnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycH//2Q==';
      
      video.src = videoDataUrl;
      
      // 添加到DOM
      document.body.appendChild(video);
      this.noSleepVideo = video;
      
      // 嘗試播放
      var self = this;
      video.play().then(function() {
        console.log('NoSleep視頻已開始播放');
        self.keepScreenAwake = true;
      }).catch(function(error) {
        console.log('NoSleep視頻播放失敗:', error);
        // 清理失敗的視頻元素
        if (self.noSleepVideo && self.noSleepVideo.parentNode) {
          self.noSleepVideo.parentNode.removeChild(self.noSleepVideo);
        }
        self.noSleepVideo = null;
        return false;
      });
      
      return true;
    } catch (error) {
      console.log('創建NoSleep視頻失敗:', error);
      return false;
    }
  };
  
  // 備用方案：定期執行操作
  FlashcardApp.prototype.tryKeepAliveMethod = function() {
    var self = this;
    
    // 每30秒執行一次操作來保持活動狀態
    setInterval(function() {
      if (self.keepScreenAwake !== false) {
        // 創建一個極小的音頻上下文並立即關閉
        try {
          var audioContext = new (window.AudioContext || window.webkitAudioContext)();
          var oscillator = audioContext.createOscillator();
          var gainNode = audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          // 設置極低的音量
          gainNode.gain.value = 0.001;
          
          // 播放極短的無聲音頻
          oscillator.frequency.value = 20000; // 人耳聽不到的高頻
          oscillator.start();
          oscillator.stop(audioContext.currentTime + 0.001);
          
          // 關閉音頻上下文
          setTimeout(function() {
            audioContext.close();
          }, 10);
        } catch (error) {
          // 靜默忽略錯誤
        }
        
        // 觸發一個極小的DOM操作
        try {
          var dummyDiv = document.createElement('div');
          dummyDiv.style.position = 'fixed';
          dummyDiv.style.top = '-1px';
          dummyDiv.style.left = '-1px';
          dummyDiv.style.width = '1px';
          dummyDiv.style.height = '1px';
          dummyDiv.style.opacity = '0';
          document.body.appendChild(dummyDiv);
          
          setTimeout(function() {
            if (dummyDiv.parentNode) {
              dummyDiv.parentNode.removeChild(dummyDiv);
            }
          }, 1);
        } catch (error) {
          // 靜默忽略錯誤
        }
      }
    }, 30000); // 每30秒執行一次
  };
  
  // ==========================================================================
  // 測驗功能相關方法 (Quiz Functions)
  // ==========================================================================
  
  // 設置測驗模態框事件監聽器
  FlashcardApp.prototype.setupQuizListeners = function() {
    var self = this;
    
    // 測驗模態框元素
    var quizModal = document.getElementById('quiz-modal');
    var closeQuizBtn = document.getElementById('close-quiz');
    var quizStartBtn = document.getElementById('quiz-start');
    var quizNextBtn = document.getElementById('quiz-next');
    var quizRestartBtn = document.getElementById('quiz-restart');
    var quizFinishBtn = document.getElementById('quiz-finish');
    
    // 關閉按鈕事件
    if (closeQuizBtn) {
      closeQuizBtn.addEventListener('click', function() { self.closeQuizModal(); });
    }
    
    // 測驗流程按鈕事件
    if (quizStartBtn) {
      quizStartBtn.addEventListener('click', function() { self.beginQuiz(); });
    }
    if (quizNextBtn) {
      quizNextBtn.addEventListener('click', function() { self.nextQuestion(); });
    }
    if (quizRestartBtn) {
      quizRestartBtn.addEventListener('click', function() { self.restartQuiz(); });
    }
    if (quizFinishBtn) {
      quizFinishBtn.addEventListener('click', function() { self.closeQuizModal(); });
    }
    
    // 模態框點擊外部關閉（但在測驗進行中禁用）
    if (quizModal) {
      quizModal.addEventListener('click', function(e) {
        // 檢查是否在測驗進行中
        if (self.isQuizInProgress()) {
          console.log('測驗進行中，禁用背景點擊關閉');
          return; // 測驗進行中不允許背景點擊關閉
        }
        
        // 檢查點擊目標，排除select元素及其相關元素
        var target = e.target;
        var isSelectRelated = false;
        
        var element = target;
        while (element && element !== quizModal) {
          if (element.tagName === 'SELECT' || 
              element.tagName === 'OPTION' ||
              element.classList.contains('setting-control')) {
            isSelectRelated = true;
            break;
          }
          element = element.parentElement;
        }
        
        if (e.target === quizModal && !isSelectRelated) {
          console.log('非測驗進行中，允許背景點擊關閉');
          self.closeQuizModal();
        }
      });
    }
  };
  
  // 開始測驗
  FlashcardApp.prototype.startQuiz = function(type) {
    console.log('開始測驗，類型:', type);
    
    // 檢查是否有單字可以測驗
    if (!this.words || this.words.length === 0) {
      alert('沒有單字可以測驗！請先載入單字。');
      return;
    }
    
    // 檢查當前可用的單字（考慮篩選條件和暫時刪除）
    var availableWords = this.getCurrentAvailableWords();
    if (availableWords.length === 0) {
      var message = this.getNoWordsMessage();
      alert(message);
      return;
    }
    
    // 檢查快速測驗的單字數量
    if (type === 'quick' && availableWords.length < 3) {
      alert('可用單字太少（少於3個），無法進行測驗。請增加更多單字或調整篩選條件。');
      return;
    }
    
    // 暫停閃卡播放
    this.pauseTimer();
    
    // 設置測驗狀態
    this.quizState = {
      isActive: true,
      type: type,
      questions: [],
      currentQuestionIndex: 0,
      selectedAnswer: null,
      answers: [],
      score: 0,
      startTime: new Date(),
      endTime: null,
      availableWords: availableWords
    };
    
    // 生成測驗題目
    this.generateQuestions(type);
    
    // 顯示測驗模態框
    this.showQuizModal(type);
  };
  
  // 獲取當前可用的單字（考慮篩選和刪除狀態）
  FlashcardApp.prototype.getCurrentAvailableWords = function() {
    // 使用 currentWords，它已經考慮了：
    // 1. "只顯示不熟單字" 的篩選
    // 2. 暫時刪除的單字
    return this.currentWords ? this.currentWords.slice() : [];
  };
  
  // 獲取沒有可用單字時的提示信息
  FlashcardApp.prototype.getNoWordsMessage = function() {
    if (this.showDifficultOnly) {
      return '沒有不熟單字可以測驗！\n\n請先學習一些單字，或取消「只顯示不熟單字」選項。';
    } else if (this.currentWords && this.currentWords.length === 0 && this.words && this.words.length > 0) {
      return '所有單字都已被暫時移除！\n\n請點擊「恢復單字」按鈕或重新載入單字。';
    } else {
      return '沒有單字可以測驗！請先載入單字。';
    }
  };
  
  // 生成測驗題目
  FlashcardApp.prototype.generateQuestions = function(type) {
    console.log('生成測驗題目，類型:', type);
    
    // 使用當前可用的單字（已考慮篩選條件和刪除狀態）
    var availableWords = this.quizState.availableWords.slice();
    
    // 所有測驗類型都隨機化順序
    console.log('洗牌前單字順序:', availableWords.map(function(w, i) { return i + ':' + w.english; }).slice(0, 5));
    this.shuffleArray(availableWords);
    console.log('洗牌後單字順序:', availableWords.map(function(w, i) { return i + ':' + w.english; }).slice(0, 5));
    
    // 根據測驗類型決定題目數量
    var questionCount = type === 'quick' ? Math.min(10, availableWords.length) : availableWords.length;
    
    // 快速測驗只取前N個（已隨機洗牌）
    if (type === 'quick' && availableWords.length > 10) {
      availableWords = availableWords.slice(0, 10);
    }
    
    // 生成題目
    this.quizState.questions = [];
    for (var i = 0; i < availableWords.length; i++) {
      var word = availableWords[i];
      // 使用所有原始單字作為選項池（確保有足夠的錯誤選項）
      var question = this.createQuestion(word, this.words);
      if (question) {
        this.quizState.questions.push(question);
      }
    }
    
    console.log('生成了', this.quizState.questions.length, '道題目');
  };
  
  // 創建單個題目
  FlashcardApp.prototype.createQuestion = function(targetWord, allWords) {
    // 隨機決定題型：英譯中 或 中譯英
    var isEnglishToChinese = Math.random() < 0.5;
    
    var question = {
      word: targetWord,
      type: isEnglishToChinese ? 'en-zh' : 'zh-en',
      question: isEnglishToChinese ? targetWord.english : targetWord.chinese,
      correctAnswer: isEnglishToChinese ? targetWord.chinese : targetWord.english,
      options: []
    };
    
    // 生成錯誤選項
    var wrongOptions = [];
    var attempts = 0;
    var maxAttempts = 100;
    
    while (wrongOptions.length < 3 && attempts < maxAttempts) {
      attempts++;
      var randomWord = allWords[Math.floor(Math.random() * allWords.length)];
      var wrongAnswer = isEnglishToChinese ? randomWord.chinese : randomWord.english;
      
      // 確保錯誤選項不重複且不等於正確答案
      if (wrongAnswer !== question.correctAnswer && 
          wrongOptions.indexOf(wrongAnswer) === -1) {
        wrongOptions.push(wrongAnswer);
      }
    }
    
    // 如果沒有足夠的錯誤選項，補充一些通用選項
    while (wrongOptions.length < 3) {
      var genericOptions = isEnglishToChinese ? 
        ['桌子', '電腦', '書本', '水果', '動物', '顏色', '天氣', '時間'] :
        ['table', 'computer', 'book', 'fruit', 'animal', 'color', 'weather', 'time'];
      
      for (var i = 0; i < genericOptions.length && wrongOptions.length < 3; i++) {
        var option = genericOptions[i];
        if (option !== question.correctAnswer && wrongOptions.indexOf(option) === -1) {
          wrongOptions.push(option);
        }
      }
      break; // 避免無限循環
    }
    
    // 組合所有選項並洗牌
    question.options = [question.correctAnswer].concat(wrongOptions);
    this.shuffleArray(question.options);
    
    return question;
  };
  
  // 顯示測驗模態框
  FlashcardApp.prototype.showQuizModal = function(type) {
    var modal = document.getElementById('quiz-modal');
    var title = document.getElementById('quiz-title');
    var questionCount = document.getElementById('quiz-question-count');
    var introTitle = document.getElementById('quiz-intro-title');
    var introDescription = document.getElementById('quiz-intro-description');
    var scopeInfo = document.getElementById('quiz-scope-info');
    
    if (modal) {
      modal.style.display = 'flex';
    }
    
    // 設置標題和說明
    if (title) {
      title.textContent = type === 'quick' ? '🎯 快速測驗' : '📝 完整測驗';
    }
    if (questionCount) {
      questionCount.textContent = this.quizState.questions.length;
    }
    if (introTitle) {
      var titleText = type === 'quick' ? '準備開始快速測驗！' : '準備開始完整測驗！';
      introTitle.textContent = titleText;
    }
    if (introDescription) {
      var description = type === 'quick' ? 
        '快速檢測你對英文單字的掌握程度！' : 
        '全面測試你學習的英文單字！';
      introDescription.textContent = description;
    }
    if (scopeInfo) {
      scopeInfo.textContent = this.getQuizScopeText();
    }
    
    // 顯示開始畫面
    this.showQuizScreen('start');
  };
  
  // 獲取測驗範圍文字
  FlashcardApp.prototype.getQuizScopeText = function() {
    var questionCount = this.quizState.questions.length;
    
    // 根據當前狀態返回範圍說明
    if (this.showDifficultOnly) {
      return '📚 測驗範圍：不熟單字 (' + questionCount + ' 題)';
    } else if (this.currentWords.length < this.words.length) {
      var removedCount = this.words.length - this.currentWords.length;
      return '📖 測驗範圍：剩餘單字 (' + questionCount + ' 題，已排除 ' + removedCount + ' 個)';
    } else {
      return '📗 測驗範圍：所有單字 (' + questionCount + ' 題)';
    }
  };
  
  // 關閉測驗模態框
  FlashcardApp.prototype.closeQuizModal = function() {
    var modal = document.getElementById('quiz-modal');
    if (modal) {
      modal.style.display = 'none';
    }
    
    // 重置測驗狀態
    this.quizState.isActive = false;
    
    // 恢復閃卡播放
    this.resumeTimer();
  };
  
  // 顯示測驗畫面
  FlashcardApp.prototype.showQuizScreen = function(screenType) {
    // 隱藏所有畫面
    var screens = ['quiz-start-screen', 'quiz-progress-screen', 'quiz-result-screen'];
    for (var i = 0; i < screens.length; i++) {
      var screen = document.getElementById(screens[i]);
      if (screen) {
        screen.style.display = 'none';
      }
    }
    
    // 隱藏所有按鈕
    var buttons = ['quiz-start', 'quiz-next', 'quiz-restart', 'quiz-finish'];
    for (var i = 0; i < buttons.length; i++) {
      var btn = document.getElementById(buttons[i]);
      if (btn) {
        btn.style.display = 'none';
      }
    }
    
    // 顯示指定畫面和相應按鈕
    var targetScreen = document.getElementById('quiz-' + screenType + '-screen');
    if (targetScreen) {
      targetScreen.style.display = 'block';
    }
    
    // 根據畫面類型顯示相應按鈕
    if (screenType === 'start') {
      var startBtn = document.getElementById('quiz-start');
      if (startBtn) {
        startBtn.style.display = 'inline-block';
      }
    } else if (screenType === 'progress') {
      var nextBtn = document.getElementById('quiz-next');
      if (nextBtn) {
        nextBtn.style.display = 'inline-block';
        nextBtn.style.display = 'none'; // 初始隱藏，答題後顯示
      }
    } else if (screenType === 'result') {
      var restartBtn = document.getElementById('quiz-restart');
      var finishBtn = document.getElementById('quiz-finish');
      if (restartBtn) {
        restartBtn.style.display = 'inline-block';
      }
      if (finishBtn) {
        finishBtn.style.display = 'inline-block';
      }
    }
  };
  
  // 開始答題
  FlashcardApp.prototype.beginQuiz = function() {
    console.log('開始答題');
    
    if (this.quizState.questions.length === 0) {
      alert('沒有題目可以測驗！');
      return;
    }
    
    this.quizState.currentQuestionIndex = 0;
    this.quizState.answers = [];
    this.quizState.score = 0;
    
    this.showQuizScreen('progress');
    this.showQuestion();
  };
  
  // 顯示當前題目
  FlashcardApp.prototype.showQuestion = function() {
    var currentQuestion = this.quizState.questions[this.quizState.currentQuestionIndex];
    if (!currentQuestion) return;
    
    console.log('顯示題目:', this.quizState.currentQuestionIndex + 1);
    
    // 更新進度信息
    var currentNum = document.getElementById('quiz-current-number');
    var totalNum = document.getElementById('quiz-total-number');
    var currentScore = document.getElementById('quiz-current-score');
    var progressFill = document.getElementById('quiz-progress-fill');
    
    if (currentNum) {
      currentNum.textContent = this.quizState.currentQuestionIndex + 1;
    }
    if (totalNum) {
      totalNum.textContent = this.quizState.questions.length;
    }
    if (currentScore) {
      currentScore.textContent = this.quizState.score;
    }
    if (progressFill) {
      var progress = (this.quizState.currentQuestionIndex / this.quizState.questions.length) * 100;
      progressFill.style.width = progress + '%';
    }
    
    // 更新題目內容
    var quizWord = document.getElementById('quiz-word');
    
    if (quizWord) {
      quizWord.textContent = currentQuestion.question;
    }
    
    // 生成選項按鈕
    this.renderQuizOptions(currentQuestion);
    
    // 隱藏回饋和下一題按鈕
    var feedback = document.getElementById('quiz-feedback');
    var nextBtn = document.getElementById('quiz-next');
    if (feedback) {
      feedback.style.display = 'none';
    }
    if (nextBtn) {
      nextBtn.style.display = 'none';
    }
    
    // 重置選擇狀態
    this.quizState.selectedAnswer = null;
  };
  
  // 渲染測驗選項
  FlashcardApp.prototype.renderQuizOptions = function(question) {
    var optionsContainer = document.getElementById('quiz-options');
    if (!optionsContainer) return;
    
    optionsContainer.innerHTML = '';
    
    var self = this;
    var letters = ['A', 'B', 'C', 'D'];
    
    for (var i = 0; i < question.options.length; i++) {
      var option = question.options[i];
      var optionBtn = document.createElement('button');
      optionBtn.className = 'quiz-option';
      optionBtn.innerHTML = '<span class="quiz-option-letter">' + letters[i] + '</span>' + option;
      optionBtn.setAttribute('data-answer', option);
      
      (function(answer) {
        optionBtn.addEventListener('click', function() {
          self.selectAnswer(answer);
        });
      })(option);
      
      optionsContainer.appendChild(optionBtn);
    }
  };
  
  // 選擇答案
  FlashcardApp.prototype.selectAnswer = function(selectedAnswer) {
    console.log('選擇答案:', selectedAnswer);
    
    if (this.quizState.selectedAnswer !== null) {
      return; // 已經選擇過答案
    }
    
    this.quizState.selectedAnswer = selectedAnswer;
    
    var currentQuestion = this.quizState.questions[this.quizState.currentQuestionIndex];
    var isCorrect = selectedAnswer === currentQuestion.correctAnswer;
    
    // 記錄答案
    this.quizState.answers.push({
      question: currentQuestion,
      selectedAnswer: selectedAnswer,
      isCorrect: isCorrect
    });
    
    if (isCorrect) {
      this.quizState.score += 10; // 每題10分
    }
    
    // 更新選項樣式
    this.updateOptionStyles(currentQuestion.correctAnswer, selectedAnswer);
    
    // 顯示回饋
    this.showAnswerFeedback(isCorrect, currentQuestion);
    
    // 如果是錯誤答案，標記為困難單字
    if (!isCorrect) {
      this.markWordAsDifficult(currentQuestion.word);
    }
    
    // 顯示下一題按鈕或結束測驗
    this.showNextButton();
  };
  
  // 更新選項樣式
  FlashcardApp.prototype.updateOptionStyles = function(correctAnswer, selectedAnswer) {
    var options = document.querySelectorAll('.quiz-option');
    
    for (var i = 0; i < options.length; i++) {
      var option = options[i];
      var optionAnswer = option.getAttribute('data-answer');
      
      option.classList.add('disabled');
      
      if (optionAnswer === correctAnswer) {
        option.classList.add('correct');
      } else if (optionAnswer === selectedAnswer) {
        option.classList.add('wrong');
      }
    }
  };
  
  // 顯示答案回饋
  FlashcardApp.prototype.showAnswerFeedback = function(isCorrect, question) {
    var feedback = document.getElementById('quiz-feedback');
    var feedbackResult = document.getElementById('quiz-feedback-result');
    var feedbackExplanation = document.getElementById('quiz-feedback-explanation');
    
    if (!feedback) return;
    
    feedback.className = 'quiz-feedback ' + (isCorrect ? 'correct' : 'wrong');
    feedback.style.display = 'block';
    
    if (feedbackResult) {
      feedbackResult.textContent = isCorrect ? '✅ 答對了！' : '❌ 答錯了！';
    }
    
    if (feedbackExplanation) {
      var explanation = question.word.english + ' 的意思是「' + question.word.chinese + '」';
      feedbackExplanation.textContent = explanation;
    }
    
    // 播放語音（如果是英文單字）
    if (this.voiceSettings.enabled) {
      var self = this;
      setTimeout(function() {
        self.speakWord(question.word.english);
      }, 500);
    }
  };
  
  // 顯示下一題按鈕
  FlashcardApp.prototype.showNextButton = function() {
    var nextBtn = document.getElementById('quiz-next');
    if (nextBtn) {
      var isLastQuestion = this.quizState.currentQuestionIndex >= this.quizState.questions.length - 1;
      nextBtn.textContent = isLastQuestion ? '查看結果' : '下一題';
      nextBtn.style.display = 'inline-block';
    }
  };
  
  // 下一題或顯示結果
  FlashcardApp.prototype.nextQuestion = function() {
    this.quizState.currentQuestionIndex++;
    
    if (this.quizState.currentQuestionIndex >= this.quizState.questions.length) {
      // 測驗結束，顯示結果
      this.showQuizResult();
    } else {
      // 顯示下一題
      this.showQuestion();
    }
  };
  
  // 顯示測驗結果
  FlashcardApp.prototype.showQuizResult = function() {
    console.log('顯示測驗結果');
    
    this.quizState.endTime = new Date();
    
    var totalQuestions = this.quizState.questions.length;
    var correctCount = this.quizState.answers.filter(function(a) { return a.isCorrect; }).length;
    var wrongCount = totalQuestions - correctCount;
    var finalScore = Math.round((correctCount / totalQuestions) * 100);
    
    // 更新結果顯示
    var resultIcon = document.getElementById('quiz-result-icon');
    var resultTitle = document.getElementById('quiz-result-title');
    var finalScoreElement = document.getElementById('quiz-final-score');
    var correctCountElement = document.getElementById('quiz-correct-count');
    var wrongCountElement = document.getElementById('quiz-wrong-count');
    var resultMessage = document.getElementById('quiz-result-message');
    
    if (resultIcon) {
      if (finalScore >= 90) {
        resultIcon.textContent = '🏆';
      } else if (finalScore >= 80) {
        resultIcon.textContent = '🎉';
      } else if (finalScore >= 70) {
        resultIcon.textContent = '👏';
      } else {
        resultIcon.textContent = '💪';
      }
    }
    
    if (resultTitle) {
      resultTitle.textContent = '測驗完成！';
    }
    
    if (finalScoreElement) {
      finalScoreElement.textContent = finalScore;
    }
    
    if (correctCountElement) {
      correctCountElement.textContent = correctCount;
    }
    
    if (wrongCountElement) {
      wrongCountElement.textContent = wrongCount;
    }
    
    if (resultMessage) {
      var message = this.getResultMessage(finalScore);
      resultMessage.textContent = message;
    }
    
    // 顯示錯題回顧
    this.showWrongReview();
    
    this.showQuizScreen('result');
  };
  
  // 獲取結果評語
  FlashcardApp.prototype.getResultMessage = function(score) {
    if (score >= 90) {
      return '太棒了！你是英文單字小高手！🏆';
    } else if (score >= 80) {
      return '很好！你的英文單字掌握得不錯！👍';
    } else if (score >= 70) {
      return '不錯哦！繼續努力就會更棒！💪';
    } else if (score >= 60) {
      return '還可以！多多練習會進步的！📚';
    } else {
      return '加油！多讀多練習一定會進步的！🌟';
    }
  };
  
  // 顯示錯題回顧
  FlashcardApp.prototype.showWrongReview = function() {
    var wrongAnswers = this.quizState.answers.filter(function(a) { return !a.isCorrect; });
    var wrongReview = document.getElementById('quiz-wrong-review');
    var wrongList = document.getElementById('quiz-wrong-list');
    
    if (wrongAnswers.length === 0) {
      if (wrongReview) {
        wrongReview.style.display = 'none';
      }
      return;
    }
    
    if (wrongReview) {
      wrongReview.style.display = 'block';
    }
    
    if (wrongList) {
      wrongList.innerHTML = '';
      
      for (var i = 0; i < wrongAnswers.length; i++) {
        var answer = wrongAnswers[i];
        var item = document.createElement('div');
        item.className = 'quiz-wrong-item';
        
        item.innerHTML = 
          '<div class="quiz-wrong-word">' + answer.question.word.english + '</div>' +
          '<div>' +
            '<div class="quiz-wrong-answer">你的答案：' + answer.selectedAnswer + '</div>' +
            '<div class="quiz-wrong-correct">正確答案：' + answer.question.correctAnswer + '</div>' +
          '</div>';
        
        wrongList.appendChild(item);
      }
    }
  };
  
  // 標記單字為困難
  FlashcardApp.prototype.markWordAsDifficult = function(word) {
    if (!this.difficultWords.includes(word.id)) {
      this.difficultWords.push(word.id);
      console.log('標記困難單字:', word.english);
      
      // 同步到後端
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        var rowIndex = word.originalRowIndex;
        if (rowIndex === undefined) {
          rowIndex = this.words.findIndex(function(w) {
            return w.english === word.english && w.chinese === word.chinese;
          });
        }
        
        if (rowIndex !== -1) {
          var sheetId = this.sheetSettings.sheetId;
          var sheetName = word.sheetName || 'Sheet1';
          google.script.run.markWordAsDifficult(sheetId, sheetName, rowIndex, '*');
        }
      }
    }
  };
  
  // 重新開始測驗
  FlashcardApp.prototype.restartQuiz = function() {
    console.log('重新開始測驗');
    
    // 重新獲取當前可用的單字（可能已經變化）
    var availableWords = this.getCurrentAvailableWords();
    if (availableWords.length === 0) {
      var message = this.getNoWordsMessage();
      alert(message);
      this.closeQuizModal();
      return;
    }
    
    // 檢查快速測驗的單字數量
    if (this.quizState.type === 'quick' && availableWords.length < 3) {
      alert('可用單字太少（少於3個），無法進行測驗。請增加更多單字或調整篩選條件。');
      this.closeQuizModal();
      return;
    }
    
    // 更新可用單字
    this.quizState.availableWords = availableWords;
    
    // 重新生成題目
    this.generateQuestions(this.quizState.type);
    
    // 重新設置狀態
    this.quizState.currentQuestionIndex = 0;
    this.quizState.selectedAnswer = null;
    this.quizState.answers = [];
    this.quizState.score = 0;
    this.quizState.startTime = new Date();
    this.quizState.endTime = null;
    
    this.showQuizScreen('start');
  };
  
  // 禁用防止螢幕關閉功能
  FlashcardApp.prototype.disableKeepScreenAwake = function() {
    console.log('禁用防止螢幕關閉功能');
    this.keepScreenAwake = false;
    
    // 釋放Wake Lock
    if (this.wakeLock) {
      this.wakeLock.release();
      this.wakeLock = null;
    }
    
    // 停止NoSleep視頻
    if (this.noSleepVideo) {
      this.noSleepVideo.pause();
      if (this.noSleepVideo.parentNode) {
        this.noSleepVideo.parentNode.removeChild(this.noSleepVideo);
      }
      this.noSleepVideo = null;
    }
  };
  
  // 全域變數
  var app;
  
  // 頁面載入完成後啟動
  window.addEventListener('load', function() {
    try {
      console.log('頁面載入完成，啟動FlashcardApp');
      app = new FlashcardApp();
      
      // 語音列表載入後填充語音腔調選單
    if (window.speechSynthesis) {
        window.speechSynthesis.onvoiceschanged = function() {
          if (app && typeof app.populateVoiceSelect === 'function') {
          app.populateVoiceSelect();
        }
      };
    }
    
    // 頁面卸載時清理資源
    window.addEventListener('beforeunload', function() {
      if (app && typeof app.disableKeepScreenAwake === 'function') {
        app.disableKeepScreenAwake();
      }
    });
    } catch (error) {
      console.error('應用啟動失敗:', error);
      var loadingDiv = document.getElementById('loading');
      var errorDiv = document.getElementById('error');
      if (loadingDiv) loadingDiv.style.display = 'none';
      if (errorDiv) {
        errorDiv.style.display = 'block';
        errorDiv.innerHTML = '<h2>啟動失敗</h2><p>請重新整理頁面，錯誤：' + error.message + '</p>';
      }
    }
  });
  
  console.log('FlashcardApp ES5兼容版本已載入');
  </script>
<!-- script.html -->
<script>
  // ES5å…¼å®¹ç‰ˆæœ¬ FlashcardApp for iPad4
  (function() {
    'use strict';
    
    // ES5 Polyfills
    if (!Array.prototype.forEach) {
      Array.prototype.forEach = function(callback, thisArg) {
        for (var i = 0; i < this.length; i++) {
          callback.call(thisArg, this[i], i, this);
        }
      };
    }
    
    if (!Array.prototype.filter) {
      Array.prototype.filter = function(callback, thisArg) {
        var result = [];
        for (var i = 0; i < this.length; i++) {
          if (callback.call(thisArg, this[i], i, this)) {
            result.push(this[i]);
          }
        }
        return result;
      };
    }
    
    if (!Array.prototype.map) {
      Array.prototype.map = function(callback, thisArg) {
        var result = [];
        for (var i = 0; i < this.length; i++) {
          result.push(callback.call(thisArg, this[i], i, this));
        }
        return result;
      };
    }
    
    if (!Array.prototype.find) {
      Array.prototype.find = function(callback, thisArg) {
        for (var i = 0; i < this.length; i++) {
          if (callback.call(thisArg, this[i], i, this)) {
            return this[i];
          }
        }
        return undefined;
      };
    }
    
    if (!Array.prototype.includes) {
      Array.prototype.includes = function(searchElement) {
        for (var i = 0; i < this.length; i++) {
          if (this[i] === searchElement) {
            return true;
          }
        }
        return false;
      };
    }
  })();
  
  // å…¨åŸŸ FlashcardApp
  function FlashcardApp() {
    // åˆå§‹åŒ–å±¬æ€§
    this.words = [];
    this.currentWords = [];
    this.currentIndex = 0;
      this.showingChinese = false;
      this.isTransitioning = false;
      this.isProcessingClick = false;
    this.displayTimer = null;
    this.speechSynthesis = window.speechSynthesis;
    this.removedWords = [];
    this.navigationHistory = [];
      this.pendingRemoval = null;
    this.isPaused = false;
    this.userPaused = false;
    this.pausedTimestamp = null;
    this.remainingTime = 0;
    
    // èªéŸ³å•Ÿç”¨ç‹€æ…‹ï¼ˆé©ç”¨æ–¼èˆŠç‰ˆç€è¦½å™¨ï¼‰
    this.speechActivated = false;
    this.isLegacyBrowser = false;
    
    // ä¸­æ–‡èªéŸ³ç­‰å¾…å®šæ™‚å™¨
    this.chineseWaitInterval = null;
    
    // è¨­å®š
    this.settings = {
      delayTime: 4.5,
      fontSize: 96,
      reverseMode: false,
      fontFamily: 'system-default',
      delaySpeechInNormalMode: false
    };
    
    // å­—å‹æ˜ å°„è¡¨ï¼ˆiPad 4 å…¼å®¹ï¼‰
    this.fontFamilyMap = {
      'system-default': "'Microsoft JhengHei', 'PingFang TC', 'Helvetica Neue', Arial, sans-serif",
      'microsoft-yahei': "'Microsoft JhengHei', 'Microsoft YaHei', 'SimHei', 'Arial Unicode MS', Arial, sans-serif",
      'songti': "'STSong', 'SimSun', 'Times New Roman', serif",
      'kaiti': "'STKaiti', 'KaiTi', 'BiauKai', 'Times New Roman', serif",
      'arial': "Arial, 'Helvetica Neue', Helvetica, sans-serif",
      'helvetica': "'Helvetica Neue', Helvetica, Arial, sans-serif",
      'times': "'Times New Roman', Times, serif",
      'courier': "'Courier New', Courier, monospace",
      'verdana': "Verdana, Geneva, sans-serif"
    };
    
    this.voiceSettings = {
      enabled: true,
      rate: 0.8,
      pitch: 1,
      volume: 1,
      lang: 'en-US',
      voiceURI: '',
      japaneseLang: 'ja-JP',
      japaneseVoiceURI: '',
      spellOutLetters: false,
      chineseEnabled: false,
      chineseLang: 'zh-TW',
      chineseVoiceURI: ''
    };
    
    this.sheetSettings = {
      sheetId: '',
      selectedSheets: []
    };
    
    // åŠŸèƒ½ç‹€æ…‹
    this.difficultWords = [];
    this.showDifficultOnly = false;
    this.availableSheets = [];
    this.listenersSetup = false;
    this.currentSpreadsheetName = null;
    this.duplicateWords = [];
    this.currentDuplicateIndex = 0;
    this.duplicateProcessingResults = [];
    this.progressTimer = null;
    
    // åœ–ç‰‡é åŠ è¼‰ç®¡ç†
    this.preloadedImages = {};
    this.currentPreloadingImage = null;

    // é˜²æ­¢è¢å¹•é—œé–‰ç›¸é—œ
    this.wakeLock = null;
    this.noSleepVideo = null;
    this.keepScreenAwake = false;
    
    // æ¸¬é©—ç›¸é—œå±¬æ€§
    this.quizState = {
      isActive: false,
      type: 'quick', // 'quick' or 'full'
      questions: [],
      currentQuestionIndex: 0,
      selectedAnswer: null,
      answers: [],
      score: 0,
      startTime: null,
      endTime: null
    };
    
    // å•Ÿå‹•åˆå§‹åŒ–
    this.init();
  }
  
  // åˆå§‹åŒ–æ–¹æ³•
  FlashcardApp.prototype.init = function() {
    console.log('=== FlashcardApp åˆå§‹åŒ–é–‹å§‹ (ES5ç‰ˆæœ¬) ===');
    try {
      console.log('è¼‰å…¥åŸºæœ¬è¨­å®š...');
      this.loadSettings();
      this.loadSheetSettings();
      
      console.log('Sheet è¨­å®š:', this.sheetSettings);
      
      // æª¢æ¸¬ç€è¦½å™¨æ˜¯å¦éœ€è¦èªéŸ³äº¤äº’
      this.detectLegacyBrowser();
      
      console.log('è¨­å®šäº‹ä»¶ç›£è½å™¨...');
      this.setupEventListeners();
      
      // æª¢æŸ¥æ˜¯å¦æœ‰å·²è¨­å®šçš„ Google Sheet
      if (this.sheetSettings.sheetId && this.sheetSettings.selectedSheets.length > 0) {
        console.log('ç™¼ç¾å·²è¨­å®šçš„ Google Sheetï¼Œè¼‰å…¥å–®å­—...');
        var self = this;
        this.loadWords(true, function(hasDuplicates) {
          self.handleLoadingComplete(hasDuplicates);
        });
        } else {
        console.log('æ²’æœ‰æ‰¾åˆ° Google Sheet è¨­å®šï¼Œé¡¯ç¤ºè¨­å®šç•«é¢');
        this.handleLoadingComplete(false, true);
        return;
      }
      
      console.log('=== FlashcardApp åˆå§‹åŒ–å®Œæˆ ===');
    } catch (error) {
      console.error('åˆå§‹åŒ–éŒ¯èª¤:', error);
      this.showError();
    }
    
    // åˆå§‹åŒ–æŒ‰éˆ•ç‹€æ…‹
    this.updateVoiceButtonState();
    this.updatePauseButtonState();
    
    // å•Ÿç”¨é˜²æ­¢è¢å¹•é—œé–‰åŠŸèƒ½
    this.enableKeepScreenAwake();
  };
  
  // æª¢æ¸¬èˆŠç‰ˆç€è¦½å™¨
  FlashcardApp.prototype.detectLegacyBrowser = function() {
    var userAgent = navigator.userAgent;
    var isIOS = /iPad|iPhone|iPod/.test(userAgent);
    var iosVersion = null;
    var isOldChrome = false;
    
    if (isIOS) {
      var match = userAgent.match(/OS (\d+)_/);
      if (match) {
        iosVersion = parseInt(match[1]);
      }
    }
    
    // æª¢æ¸¬èˆŠç‰ˆChromeï¼ˆç‰ˆæœ¬ä½æ–¼80ï¼‰
    var chromeMatch = userAgent.match(/Chrome\/(\d+)/);
    if (chromeMatch) {
      var chromeVersion = parseInt(chromeMatch[1]);
      isOldChrome = chromeVersion < 80;
    }
    
    // æª¢æ¸¬éœ€è¦ç”¨æˆ¶äº¤äº’æ‰èƒ½æ’­æ”¾èªéŸ³çš„ç€è¦½å™¨ï¼š
    // 1. iPad/iOS 10åŠä»¥ä¸‹ç‰ˆæœ¬
    // 2. èˆŠç‰ˆChromeï¼ˆç‰ˆæœ¬ä½æ–¼80ï¼‰
    // 3. Safari 12åŠä»¥ä¸‹ç‰ˆæœ¬
    this.isLegacyBrowser = (isIOS && iosVersion && iosVersion <= 10) || 
                          isOldChrome ||
                          userAgent.indexOf('Safari') !== -1 && userAgent.indexOf('Chrome') === -1 && 
                          userAgent.match(/Version\/(\d+)/) && parseInt(userAgent.match(/Version\/(\d+)/)[1]) <= 12;
    
    // æ–°ç‰ˆç€è¦½å™¨è‡ªå‹•å•Ÿç”¨èªéŸ³
    if (!this.isLegacyBrowser) {
      this.speechActivated = true;
    }
    
    console.log('ç€è¦½å™¨æª¢æ¸¬çµæœ:', {
      userAgent: userAgent,
      isIOS: isIOS,
      iosVersion: iosVersion,
      isOldChrome: isOldChrome,
      isLegacyBrowser: this.isLegacyBrowser,
      speechActivated: this.speechActivated
    });
  };
  
  // è™•ç†è¼‰å…¥å®Œæˆ
  FlashcardApp.prototype.handleLoadingComplete = function(hasDuplicates, shouldOpenSettings) {
    if (this.isLegacyBrowser && !this.speechActivated) {
      // èˆŠç‰ˆç€è¦½å™¨é¡¯ç¤ºèªéŸ³å•Ÿç”¨æŒ‰éˆ•
      this.showSpeechActivation();
    } else {
      // æ–°ç‰ˆç€è¦½å™¨æˆ–å·²å•Ÿç”¨èªéŸ³ï¼Œç›´æ¥é€²å…¥ä¸»ç•«é¢
      this.hideLoading();
      this.applySettings();
      
      if (shouldOpenSettings) {
        this.openSheetSettings();
      } else if (!hasDuplicates) {
        this.startNewRound();
      }
    }
  };
  
  // è¼‰å…¥è¨­å®š
  FlashcardApp.prototype.loadSettings = function() {
    try {
      var savedSettings = JSON.parse(localStorage.getItem('flashcard-settings') || '{}');
      for (var key in savedSettings) {
        if (savedSettings.hasOwnProperty(key) && this.settings.hasOwnProperty(key)) {
          this.settings[key] = savedSettings[key];
        }
      }
      
      var savedVoiceSettings = JSON.parse(localStorage.getItem('flashcard-voice-settings') || '{}');
      for (var key in savedVoiceSettings) {
        if (savedVoiceSettings.hasOwnProperty(key) && this.voiceSettings.hasOwnProperty(key)) {
          this.voiceSettings[key] = savedVoiceSettings[key];
        }
      }
    } catch (e) {
      console.log('è¼‰å…¥è¨­å®šå¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼');
    }
  };
  
  // è¼‰å…¥Sheetè¨­å®š
  FlashcardApp.prototype.loadSheetSettings = function() {
    try {
      var savedSheetSettings = JSON.parse(localStorage.getItem('flashcard-sheet-settings') || '{}');
      for (var key in savedSheetSettings) {
        if (savedSheetSettings.hasOwnProperty(key) && this.sheetSettings.hasOwnProperty(key)) {
          this.sheetSettings[key] = savedSheetSettings[key];
        }
      }
    } catch (e) {
      console.log('è¼‰å…¥Sheetè¨­å®šå¤±æ•—');
    }
  };
  
  // å„²å­˜è¨­å®š
  FlashcardApp.prototype.saveSettings = function() {
    localStorage.setItem('flashcard-settings', JSON.stringify(this.settings));
    localStorage.setItem('flashcard-voice-settings', JSON.stringify(this.voiceSettings));
  };
  
  // å„²å­˜Sheetè¨­å®š
  FlashcardApp.prototype.saveSheetSettings = function() {
    localStorage.setItem('flashcard-sheet-settings', JSON.stringify(this.sheetSettings));
  };
  
  // ç²å–é è¨­Sheetåˆ—è¡¨
  FlashcardApp.prototype.getDefaultSheets = function() {
    return [
      {
        id: '1jrpECEaDgtcXawdO9Rl4raHZ_sqmvnUm7x0bJ4IqfRM',
        name: 'WordGo Data Sheet',
        isDefault: true
      },
      {
        id: '1hX2Ux2__5F-jdhfegmzMBZ7bg3faOt06ARb7ezC8Yzg',
        name: 'å°å­¸ç”Ÿæ•™è‚²éƒ¨è¦å®š1200å–®å­—',
        isDefault: true
      }
    ];
  };
  
  // æª¢æŸ¥æ˜¯å¦ç‚ºé è¨­Sheet
  FlashcardApp.prototype.isDefaultSheet = function(sheetId) {
    var defaultSheets = this.getDefaultSheets();
    for (var i = 0; i < defaultSheets.length; i++) {
      if (defaultSheets[i].id === sheetId) {
        return true;
      }
    }
    return false;
  };
  
  // è¼‰å…¥Sheetæ­·å²è¨˜éŒ„ï¼ˆä¸åŒ…å«é è¨­æª”æ¡ˆï¼‰
  FlashcardApp.prototype.loadSheetHistory = function() {
    try {
      var history = JSON.parse(localStorage.getItem('flashcard-sheet-history') || '[]');
      
      // éæ¿¾æ‰ä»»ä½•å¯èƒ½æ··å…¥çš„é è¨­æª”æ¡ˆ
      var filteredHistory = [];
      for (var i = 0; i < history.length; i++) {
        if (!this.isDefaultSheet(history[i].id)) {
          filteredHistory.push(history[i]);
        }
      }
      
      return filteredHistory;
    } catch (e) {
      console.log('è¼‰å…¥Sheetæ­·å²è¨˜éŒ„å¤±æ•—ï¼Œè¿”å›ç©ºé™£åˆ—');
      return [];
    }
  };
  
  // å„²å­˜Sheetæ­·å²è¨˜éŒ„
  FlashcardApp.prototype.saveSheetHistory = function(history) {
    try {
      localStorage.setItem('flashcard-sheet-history', JSON.stringify(history));
    } catch (e) {
      console.error('å„²å­˜Sheetæ­·å²è¨˜éŒ„å¤±æ•—:', e);
    }
  };
  
  // æ·»åŠ åˆ°Sheetæ­·å²è¨˜éŒ„
  FlashcardApp.prototype.addToSheetHistory = function(sheetId, sheetName) {
    try {
      console.log('æ·»åŠ åˆ°æ­·å²è¨˜éŒ„:', sheetId, sheetName);
      
      // æª¢æŸ¥æ˜¯å¦ç‚ºé è¨­æª”æ¡ˆï¼Œå¦‚æœæ˜¯å‰‡ä¸æ·»åŠ 
      if (this.isDefaultSheet(sheetId)) {
        console.log('é€™æ˜¯é è¨­æª”æ¡ˆï¼Œä¸æ·»åŠ åˆ°æ­·å²è¨˜éŒ„');
        return;
      }
      
      var history = this.loadSheetHistory();
      
      // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
      var existingIndex = -1;
      for (var i = 0; i < history.length; i++) {
        if (history[i].id === sheetId) {
          existingIndex = i;
          break;
        }
      }
      
      if (existingIndex !== -1) {
        // å¦‚æœå·²å­˜åœ¨ï¼Œæ›´æ–°åç¨±ä¸¦ç§»åˆ°æœ€å‰é¢
        history[existingIndex].name = sheetName;
        history[existingIndex].lastUsed = new Date().toISOString();
        var item = history.splice(existingIndex, 1)[0];
        history.unshift(item);
      } else {
        // æ–°é …ç›®ï¼Œæ·»åŠ åˆ°æœ€å‰é¢
        history.unshift({
          id: sheetId,
          name: sheetName,
          isDefault: false,
          lastUsed: new Date().toISOString()
        });
      }
      
      // é™åˆ¶æ­·å²è¨˜éŒ„æ•¸é‡ç‚º10å€‹
      if (history.length > 10) {
        history = history.slice(0, 10);
      }
      
      this.saveSheetHistory(history);
      console.log('æ­·å²è¨˜éŒ„å·²æ›´æ–°ï¼Œç¸½æ•¸:', history.length);
    } catch (e) {
      console.error('æ·»åŠ åˆ°æ­·å²è¨˜éŒ„å¤±æ•—:', e);
    }
  };
  
  // é¡¯ç¤ºSheetæ­·å²è¨˜éŒ„
  FlashcardApp.prototype.displaySheetHistory = function() {
    // é¡¯ç¤ºé è¨­æª”æ¡ˆ
    this.displayDefaultSheets();
    
    // é¡¯ç¤ºæœ€è¿‘ä½¿ç”¨çš„æª”æ¡ˆ
    this.displayRecentSheets();
  };
  
  // é¡¯ç¤ºé è¨­æª”æ¡ˆåˆ—è¡¨
  FlashcardApp.prototype.displayDefaultSheets = function() {
    var defaultList = document.getElementById('default-sheets-list');
    if (!defaultList) {
      console.error('æ‰¾ä¸åˆ°default-sheets-listå…ƒç´ ');
      return;
    }
    
    var defaultSheets = this.getDefaultSheets();
    console.log('é¡¯ç¤ºé è¨­æª”æ¡ˆï¼Œç¸½æ•¸:', defaultSheets.length);
    
    var html = '';
    for (var i = 0; i < defaultSheets.length; i++) {
      var item = defaultSheets[i];
      
      html += '<div class="sheet-history-item default-sheet" data-sheet-id="' + item.id + '">';
      html += '  <div class="sheet-history-info">';
      html += '    <div class="sheet-history-name">' + item.name + '</div>';
      html += '    <div class="sheet-history-id">' + item.id + '</div>';
      html += '  </div>';
      html += '  <span class="sheet-history-badge">é è¨­</span>';
      html += '</div>';
    }
    
    defaultList.innerHTML = html;
    
    // æ·»åŠ é»æ“Šäº‹ä»¶
    var self = this;
    var items = defaultList.querySelectorAll('.sheet-history-item');
    for (var i = 0; i < items.length; i++) {
      (function(item) {
        item.addEventListener('click', function() {
          var sheetId = item.getAttribute('data-sheet-id');
          self.selectSheetFromHistory(sheetId);
        });
      })(items[i]);
    }
  };
  
  // é¡¯ç¤ºæœ€è¿‘ä½¿ç”¨çš„æª”æ¡ˆåˆ—è¡¨
  FlashcardApp.prototype.displayRecentSheets = function() {
    var recentList = document.getElementById('recent-sheets-list');
    if (!recentList) {
      console.error('æ‰¾ä¸åˆ°recent-sheets-listå…ƒç´ ');
      return;
    }
    
    var history = this.loadSheetHistory();
    console.log('é¡¯ç¤ºæœ€è¿‘ä½¿ç”¨çš„æª”æ¡ˆï¼Œç¸½æ•¸:', history.length);
    
    if (history.length === 0) {
      recentList.innerHTML = '<div class="sheet-history-empty">å°šç„¡ä½¿ç”¨è¨˜éŒ„</div>';
      return;
    }
    
    var html = '';
    for (var i = 0; i < history.length; i++) {
      var item = history[i];
      
      html += '<div class="sheet-history-item recent-sheet" data-sheet-id="' + item.id + '">';
      html += '  <div class="sheet-history-info">';
      html += '    <div class="sheet-history-name">' + item.name + '</div>';
      html += '    <div class="sheet-history-id">' + item.id + '</div>';
      html += '  </div>';
      html += '  <button class="sheet-history-delete" data-sheet-id="' + item.id + '" title="åˆªé™¤">ğŸ—‘ï¸</button>';
      html += '</div>';
    }
    
    recentList.innerHTML = html;
    
    // æ·»åŠ é»æ“Šäº‹ä»¶ï¼ˆé¸æ“‡æª”æ¡ˆï¼‰
    var self = this;
    var items = recentList.querySelectorAll('.sheet-history-item');
    for (var i = 0; i < items.length; i++) {
      (function(item) {
        item.addEventListener('click', function(e) {
          // å¦‚æœé»æ“Šçš„æ˜¯åˆªé™¤æŒ‰éˆ•ï¼Œä¸åŸ·è¡Œé¸æ“‡æ“ä½œ
          if (e.target.classList.contains('sheet-history-delete')) {
            return;
          }
          var sheetId = item.getAttribute('data-sheet-id');
          self.selectSheetFromHistory(sheetId);
        });
      })(items[i]);
    }
    
    // æ·»åŠ åˆªé™¤æŒ‰éˆ•äº‹ä»¶
    var deleteButtons = recentList.querySelectorAll('.sheet-history-delete');
    for (var i = 0; i < deleteButtons.length; i++) {
      (function(button) {
        button.addEventListener('click', function(e) {
          e.stopPropagation(); // é˜²æ­¢è§¸ç™¼çˆ¶å…ƒç´ çš„é»æ“Šäº‹ä»¶
          var sheetId = button.getAttribute('data-sheet-id');
          self.removeFromSheetHistory(sheetId);
        });
      })(deleteButtons[i]);
    }
  };
  
  // å¾æ­·å²è¨˜éŒ„ä¸­åˆªé™¤
  FlashcardApp.prototype.removeFromSheetHistory = function(sheetId) {
    try {
      console.log('å¾æ­·å²è¨˜éŒ„åˆªé™¤:', sheetId);
      
      var history = this.loadSheetHistory();
      var newHistory = [];
      
      for (var i = 0; i < history.length; i++) {
        if (history[i].id !== sheetId) {
          newHistory.push(history[i]);
        }
      }
      
      this.saveSheetHistory(newHistory);
      console.log('å·²åˆªé™¤ï¼Œå‰©é¤˜è¨˜éŒ„æ•¸:', newHistory.length);
      
      // é‡æ–°é¡¯ç¤ºåˆ—è¡¨
      this.displayRecentSheets();
    } catch (e) {
      console.error('åˆªé™¤æ­·å²è¨˜éŒ„å¤±æ•—:', e);
    }
  };
  
  // å¾æ­·å²è¨˜éŒ„é¸æ“‡Sheet
  FlashcardApp.prototype.selectSheetFromHistory = function(sheetId) {
    console.log('å¾æ­·å²è¨˜éŒ„é¸æ“‡Sheet:', sheetId);
    
    var sheetIdInput = document.getElementById('sheet-id-input');
    if (sheetIdInput) {
      sheetIdInput.value = sheetId;
      
      // è‡ªå‹•è¼‰å…¥å·¥ä½œè¡¨æ¸…å–®
      this.loadSheetsList();
    }
  };
  
  // æ‡‰ç”¨è¨­å®š
  FlashcardApp.prototype.applySettings = function() {
    var englishWord = document.getElementById('english-word');
    var chineseWord = document.getElementById('chinese-word');
    var loadingText = document.querySelector('#loading p');
    
    // æ‡‰ç”¨å­—é«”å¤§å°
    if (englishWord) englishWord.style.fontSize = this.settings.fontSize + 'px';
    if (chineseWord) chineseWord.style.fontSize = this.settings.fontSize + 'px';
    if (loadingText) loadingText.style.fontSize = this.settings.fontSize + 'px';
    
    // æ‡‰ç”¨å­—å‹
    this.applyFontFamily();
    
    var delaySlider = document.getElementById('delay-setting');
    var fontSizeSlider = document.getElementById('font-size-setting');
    var fontFamilySelect = document.getElementById('font-family-setting');
    var reverseToggle = document.getElementById('reverse-setting');
    var delaySpeechToggle = document.getElementById('delay-speech-setting');
    var delayValue = document.getElementById('delay-value');
    var fontSizeValue = document.getElementById('font-size-value');
    
    if (delaySlider && delayValue) {
      delaySlider.value = this.settings.delayTime;
      // ä¿®å¾©æµ®é»æ•¸ç²¾åº¦å•é¡Œ
      var step = parseFloat(delaySlider.step) || 0.5;
      var decimalPlaces = step.toString().indexOf('.') !== -1 ? step.toString().split('.')[1].length : 0;
      var formattedDelayTime = parseFloat(this.settings.delayTime.toFixed(decimalPlaces));
      delayValue.textContent = formattedDelayTime;
    }
    if (fontSizeSlider && fontSizeValue) {
      fontSizeSlider.value = this.settings.fontSize;
      fontSizeValue.textContent = this.settings.fontSize + 'px';
    }
    if (fontFamilySelect) {
      fontFamilySelect.value = this.settings.fontFamily;
    }
    if (reverseToggle) reverseToggle.checked = this.settings.reverseMode;
    if (delaySpeechToggle) delaySpeechToggle.checked = this.settings.delaySpeechInNormalMode;
    
    // æ›´æ–°å­—å‹é è¦½
    this.updateFontPreview();
    
    // æ‡‰ç”¨åœ–ç‰‡ç¸®æ”¾è¨­å®šï¼ˆæ°¸é ä½¿ç”¨ä¸è£åˆ‡æ¨¡å¼ï¼‰
    this.applyImageFitMode();
  };
  
  // æ‡‰ç”¨åœ–ç‰‡ç¸®æ”¾è¨­å®šï¼ˆæ°¸é ä½¿ç”¨ä¸è£åˆ‡æ¨¡å¼ï¼‰
  FlashcardApp.prototype.applyImageFitMode = function() {
    var flashcardDiv = document.getElementById('flashcard');
    if (flashcardDiv) {
      // æ°¸é ä½¿ç”¨containæ¨¡å¼ï¼ˆä¸è£åˆ‡ï¼‰
      flashcardDiv.classList.add('image-fit-contain');
      flashcardDiv.classList.remove('image-fit-cover');
    }
  };
  
  // æ‡‰ç”¨å­—å‹è¨­å®š
  FlashcardApp.prototype.applyFontFamily = function() {
    var fontFamily = this.fontFamilyMap[this.settings.fontFamily] || this.fontFamilyMap['system-default'];
    
    // æ‡‰ç”¨åˆ°ä¸»è¦å…ƒç´ 
    var elements = [
      document.getElementById('english-word'),
      document.getElementById('chinese-word'),
      document.querySelector('#loading p'),
      document.body // æ‡‰ç”¨åˆ°æ•´å€‹bodyä½œç‚ºfallback
    ];
    
    for (var i = 0; i < elements.length; i++) {
      if (elements[i]) {
        elements[i].style.fontFamily = fontFamily;
      }
    }
    
    console.log('å·²æ‡‰ç”¨å­—å‹:', this.settings.fontFamily, 'â†’', fontFamily);
  };
  
  // æ›´æ–°å­—å‹é è¦½
  FlashcardApp.prototype.updateFontPreview = function() {
    var previewEnglish = document.querySelector('.preview-english');
    var previewChinese = document.querySelector('.preview-chinese');
    var fontFamily = this.fontFamilyMap[this.settings.fontFamily] || this.fontFamilyMap['system-default'];
    
    if (previewEnglish) {
      previewEnglish.style.fontFamily = fontFamily;
    }
    if (previewChinese) {
      previewChinese.style.fontFamily = fontFamily;
    }
  };
  
  // åˆ¤æ–·æ˜¯å¦åœ¨æ¸¬é©—é€²è¡Œä¸­
  FlashcardApp.prototype.isQuizInProgress = function() {
    var progressScreen = document.getElementById('quiz-progress-screen');
    return progressScreen && progressScreen.style.display !== 'none';
  };
  
  // ä¿è­·selectå…ƒç´ ä¸å—å…¨åŸŸäº‹ä»¶å¹²æ“¾
  FlashcardApp.prototype.protectSelectElement = function(selectElement) {
    if (!selectElement) return;
    
    console.log('ç‚ºselectå…ƒç´ æ·»åŠ ä¿è­·:', selectElement.id || selectElement.className);
    
    // é˜»æ­¢æ‰€æœ‰å¯èƒ½å°è‡´å•é¡Œçš„äº‹ä»¶å†’æ³¡
    var eventsToProtect = ['click', 'mousedown', 'mouseup', 'focus', 'blur'];
    
    for (var i = 0; i < eventsToProtect.length; i++) {
      var eventType = eventsToProtect[i];
      
      (function(eventName) {
        selectElement.addEventListener(eventName, function(e) {
          console.log('Select ' + eventName + ' äº‹ä»¶ï¼Œé˜»æ­¢å†’æ³¡');
          e.stopPropagation();
          
          // å°æ–¼focusäº‹ä»¶ï¼Œç¢ºä¿selectç²å¾—ç„¦é»
          if (eventName === 'focus') {
            console.log('Selectç²å¾—ç„¦é»');
          }
          // å°æ–¼bluräº‹ä»¶ï¼Œè¨˜éŒ„å¤±å»ç„¦é»
          else if (eventName === 'blur') {
            console.log('Selectå¤±å»ç„¦é»');
          }
        }, true); // ä½¿ç”¨æ•ç²éšæ®µ
      })(eventType);
    }
    
    // ç‰¹åˆ¥è™•ç†éµç›¤äº‹ä»¶
    selectElement.addEventListener('keydown', function(e) {
      console.log('Select keydown äº‹ä»¶:', e.keyCode);
      e.stopPropagation();
      // ä¸èª¿ç”¨preventDefaultï¼Œè®“selectæ­£å¸¸è™•ç†éµç›¤è¼¸å…¥
    }, true);
    
    selectElement.addEventListener('keyup', function(e) {
      e.stopPropagation();
    }, true);
    
    // ç¢ºä¿selectå…ƒç´ æœ‰æ­£ç¢ºçš„æ¨£å¼
    selectElement.style.position = 'relative';
    selectElement.style.zIndex = '2100';
  };
  
  // è¼‰å…¥å–®å­—
  FlashcardApp.prototype.loadWords = function(isInitialLoad, callback) {
    var self = this;
    callback = callback || function() {};
    
    // æ¸…ç†å…ˆå‰é åŠ è¼‰çš„åœ–ç‰‡ç¼“å­˜
    this.preloadedImages = {};
    this.currentPreloadingImage = null;
    
    if (this.sheetSettings.sheetId && this.sheetSettings.selectedSheets.length > 0) {
      var autoHandle = isInitialLoad;
      
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('è¼‰å…¥çµæœ:', result);
          
          if (result && result.words && result.words.length > 0) {
            self.words = result.words;
            self.difficultWords = self.words.filter(function(w) { return w.difficult; }).map(function(w) { return w.id; });
            
            if (result.autoHandled) {
              console.log('é‡è¤‡å–®å­—å·²è‡ªå‹•è™•ç†:', result.autoResults);
              if (result.autoResults && result.autoResults.successCount > 0) {
                self.showAutoProcessingNotification(result.autoResults);
              }
              callback(false);
            } else if (result.hasDuplicates && result.duplicates.length > 0) {
              console.log('ç™¼ç¾é‡è¤‡å–®å­—éœ€è¦æ‰‹å‹•è™•ç†:', result.duplicates);
              self.duplicateWords = result.duplicates;
              self.currentDuplicateIndex = 0;
              self.duplicateProcessingResults = [];
              
              if (document.readyState === 'complete') {
                self.showDuplicateModal();
      } else {
                window.addEventListener('load', function() {
                  self.showDuplicateModal();
                });
              }
              callback(true);
        return;
            } else {
              callback(false);
            }
          } else {
            throw new Error('æ²’æœ‰æ‰¾åˆ°å–®å­—è³‡æ–™');
          }
        })
        .withFailureHandler(function(error) {
          console.error('è¼‰å…¥å–®å­—å¤±æ•—:', error);
          self.showError();
        })
        .getWordsFromSheetsWithDuplicateDetection(this.sheetSettings.sheetId, this.sheetSettings.selectedSheets, autoHandle);
    } else {
      google.script.run
        .withSuccessHandler(function(words) {
          if (words && words.length > 0) {
            self.words = words;
            self.difficultWords = words.filter(function(w) { return w.difficult; }).map(function(w) { return w.id; });
            callback(false);
          } else {
            throw new Error('æ²’æœ‰æ‰¾åˆ°å–®å­—è³‡æ–™');
          }
        })
        .withFailureHandler(function(error) {
          console.error('è¼‰å…¥å–®å­—å¤±æ•—:', error);
          self.showError();
        })
        .getWordsFromSheet();
    }
  };
  
  // è¨­ç½®äº‹ä»¶ç›£è½å™¨
  FlashcardApp.prototype.setupEventListeners = function() {
    console.log('è¨­ç½®äº‹ä»¶ç›£è½å™¨...');
  
    if (this.listenersSetup) {
      console.log('äº‹ä»¶ç›£è½å™¨å·²è¨­ç½®ï¼Œè·³éé‡è¤‡è¨­ç½®');
        return;
      }
      
    this.setupCoreListeners();
    this.setupMenuListeners();
    this.setupModalListeners();
    this.setupKeyboardListeners();
    this.setupProgressAndExportListeners();
  
    this.listenersSetup = true;
    console.log('æ‰€æœ‰äº‹ä»¶ç›£è½å™¨è¨­ç½®å®Œæˆ');
  };
  
  // æ ¸å¿ƒç›£è½å™¨
  FlashcardApp.prototype.setupCoreListeners = function() {
    var self = this;
    
    var flashcardDiv = document.getElementById('flashcard');
    var nextBtn = document.getElementById('next-btn');
    var prevBtn = document.getElementById('prev-btn');
    
    // åœ¨æ•´å€‹flashcardå€åŸŸæ·»åŠ é»æ“Šäº‹ä»¶ï¼Œä½†æ’é™¤ä¸‹æ–¹å€åŸŸ
    if (flashcardDiv) {
      flashcardDiv.addEventListener('click', function(e) { 
        self.handleFlashcardClick(e); 
      });
    }
    if (nextBtn) {
      nextBtn.addEventListener('click', function() { self.nextWord(); });
    }
    if (prevBtn) {
      prevBtn.addEventListener('click', function() { self.previousWord(); });
    }
    // ç§»é™¤ restartBtn çš„ç›´æ¥äº‹ä»¶ç¶å®šï¼Œå› ç‚ºå®ƒå·²ç¶“åœ¨é¸å–®å§”æ´¾äº‹ä»¶ä¸­è™•ç†äº†
    
    // æ–°å¢æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
    var voiceToggleBtn = document.getElementById('voice-toggle-btn');
    var pauseBtn = document.getElementById('pause-btn');
    var restoreBtn = document.getElementById('restore-btn');
    
    if (voiceToggleBtn) {
      voiceToggleBtn.addEventListener('click', function() { self.toggleVoice(); });
    }
    if (pauseBtn) {
      pauseBtn.addEventListener('click', function() { self.togglePause(); });
    }
    if (restoreBtn) {
      restoreBtn.addEventListener('click', function() { self.cancelRemoval(); });
    }
    
    // ç‚ºæš«åœæŒ‡ç¤ºå™¨æ·»åŠ é»æ“Šäº‹ä»¶ï¼Œè®“ç”¨æˆ¶å¯ä»¥é»æ“Š"å·²æš«åœ"ä¾†çµæŸæš«åœ
    var pausedIndicator = document.getElementById('paused-indicator');
    if (pausedIndicator) {
      pausedIndicator.addEventListener('click', function(e) { 
        // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¸ç™¼ flashcard çš„é»æ“Šäº‹ä»¶
        if (e.stopPropagation) {
          e.stopPropagation();
        } else {
          e.cancelBubble = true; // IE8 åŠæ›´æ—©ç‰ˆæœ¬
        }
        
        if (self.userPaused) {
          self.togglePause(); 
        }
      });
    }
    
    // ç‚ºéœéŸ³æŒ‡ç¤ºå™¨æ·»åŠ é»æ“Šäº‹ä»¶ï¼Œè®“ç”¨æˆ¶å¯ä»¥é»æ“Š"å·²éœéŸ³"ä¾†åˆ‡æ›éœéŸ³ç‹€æ…‹
    var mutedIndicator = document.getElementById('muted-indicator');
    if (mutedIndicator) {
      mutedIndicator.addEventListener('click', function(e) { 
        // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¸ç™¼ flashcard çš„é»æ“Šäº‹ä»¶
        if (e.stopPropagation) {
          e.stopPropagation();
        } else {
          e.cancelBubble = true; // IE8 åŠæ›´æ—©ç‰ˆæœ¬
        }
        
        self.toggleVoice(); 
      });
    }
    

  };
  
  // é¸å–®ç›£è½å™¨
  FlashcardApp.prototype.setupMenuListeners = function() {
    console.log('è¨­å®šé¸å–®äº‹ä»¶ç›£è½å™¨...');
    
    var self = this;
    var menuBtn = document.getElementById('menu-btn');
    var menuDropdown = document.getElementById('menu-dropdown');
    
    if (!menuBtn || !menuDropdown) {
      console.error('æ‰¾ä¸åˆ°é¸å–®å…ƒç´ ');
      return;
    }
    
        // ä½¿ç”¨å§”æ´¾äº‹ä»¶ç›£è½
    document.addEventListener('click', function(e) {
      // æª¢æŸ¥æ˜¯å¦é»æ“Šäº†selectç›¸é—œå…ƒç´ ï¼Œå¦‚æœæ˜¯å‰‡ä¸è™•ç†ä»»ä½•é¸å–®é‚è¼¯
      var target = e.target;
      var isSelectRelated = false;
      
      // å‘ä¸Šéæ­·DOMæ¨¹æª¢æŸ¥æ˜¯å¦é»æ“Šäº†selectæˆ–å…¶ç›¸é—œå…ƒç´ 
      var element = target;
      while (element && element !== document.body) {
        if (element.tagName === 'SELECT' || 
            element.tagName === 'OPTION' ||
            (element.classList && (
              element.classList.contains('modal') ||
              element.classList.contains('modal-content') ||
              element.classList.contains('setting-control') ||
              element.classList.contains('font-preview')))) {
          isSelectRelated = true;
          break;
        }
        element = element.parentElement;
      }
      
      // å¦‚æœé»æ“Šçš„æ˜¯selectç›¸é—œå…ƒç´ ï¼Œç›´æ¥è¿”å›ï¼Œä¸è™•ç†é¸å–®é‚è¼¯
      if (isSelectRelated) {
        console.log('é»æ“Šäº†selectç›¸é—œå…ƒç´ ï¼Œè·³éé¸å–®è™•ç†');
        return;
      }
      
      // è™•ç†é¸å–®æŒ‰éˆ•é»æ“Š
      if (e.target.id === 'menu-btn' || e.target.closest('#menu-btn')) {
        console.log('é¸å–®æŒ‰éˆ•è¢«é»æ“Š');
        e.stopPropagation();
        self.toggleMenu();
        return;
      }
      
      // è™•ç†é¸å–®é …ç›®é»æ“Š
      if (e.target.closest('#menu-dropdown')) {
        console.log('é»æ“Šé¸å–®ä¸‹æ‹‰é¸é …');
        e.stopPropagation();

        if (e.target.id === 'restart-btn') {
          console.log('é‡æ–°é–‹å§‹æŒ‰éˆ•è¢«é»æ“Š');
          self.closeMenu();
          self.confirmRestart();
        } else if (e.target.id === 'fullscreen-btn') {
          console.log('å…¨è¢å¹•æŒ‰éˆ•è¢«é»æ“Š');
          self.closeMenu();
          self.toggleFullscreen();
        } else if (e.target.id === 'sheet-settings-btn') {
          console.log('Google Sheet è¨­å®šæŒ‰éˆ•è¢«é»æ“Š');
          self.closeMenu();
          self.openSheetSettings();
        } else if (e.target.id === 'voice-settings-btn') {
          console.log('èªéŸ³è¨­å®šæŒ‰éˆ•è¢«é»æ“Š');
          self.closeMenu();
          self.openVoiceSettings();
        } else if (e.target.id === 'settings-btn') {
          console.log('è¨­å®šæŒ‰éˆ•è¢«é»æ“Š');
          self.closeMenu();
          self.openSettings();
        } else if (e.target.id === 'export-btn') {
          console.log('åŒ¯å‡ºæŒ‰éˆ•è¢«é»æ“Š');
          self.closeMenu();
          self.openExportModal();
        } else if (e.target.id === 'quick-quiz-btn') {
          console.log('å¿«é€Ÿæ¸¬é©—æŒ‰éˆ•è¢«é»æ“Š');
          self.closeMenu();
          self.startQuiz('quick');
        } else if (e.target.id === 'full-quiz-btn') {
          console.log('å®Œæ•´æ¸¬é©—æŒ‰éˆ•è¢«é»æ“Š');
          self.closeMenu();
          self.startQuiz('full');
        }
        return;
      }

      // é»æ“Šå…¶ä»–åœ°æ–¹é—œé–‰é¸å–®ï¼ˆä½†æ’é™¤selectç›¸é—œå…ƒç´ ï¼‰
      self.closeMenu();
    });
  
    console.log('é¸å–®äº‹ä»¶ç›£è½å™¨è¨­å®šå®Œæˆ');
  };
  

  
  // é¡¯ç¤ºèªéŸ³å•Ÿç”¨ç•Œé¢
  FlashcardApp.prototype.showSpeechActivation = function() {
    console.log('é¡¯ç¤ºèªéŸ³å•Ÿç”¨ç•Œé¢ (èˆŠç‰ˆç€è¦½å™¨)');
    var activationContainer = document.getElementById('speech-activation-container');
    if (activationContainer) {
      activationContainer.style.display = 'block';
    }
    
    // è¨­ç½®èªéŸ³å•Ÿç”¨æŒ‰éˆ•äº‹ä»¶
    var activateBtn = document.getElementById('activate-speech-btn');
    var self = this;
    if (activateBtn) {
      activateBtn.addEventListener('click', function() {
        self.activateSpeech();
      });
    }
  };
  
  // å•Ÿç”¨èªéŸ³åŠŸèƒ½
  FlashcardApp.prototype.activateSpeech = function() {
    console.log('ç”¨æˆ¶é»æ“Šå•Ÿç”¨èªéŸ³æŒ‰éˆ•');
    
    // æ¸¬è©¦èªéŸ³åŠŸèƒ½æ˜¯å¦å¯ç”¨
    try {
      var testUtterance = new SpeechSynthesisUtterance('');
      testUtterance.volume = 0; // éœéŸ³æ¸¬è©¦
      this.speechSynthesis.speak(testUtterance);
      
      this.speechActivated = true;
      console.log('èªéŸ³åŠŸèƒ½å·²å•Ÿç”¨');
      
      // éš±è—èªéŸ³å•Ÿç”¨ç•Œé¢
      var activationContainer = document.getElementById('speech-activation-container');
      if (activationContainer) {
        activationContainer.style.display = 'none';
      }
      
      // é€²å…¥ä¸»ç•«é¢
      this.hideLoading();
      this.applySettings();
      
      if (this.sheetSettings.sheetId && this.sheetSettings.selectedSheets.length > 0) {
        this.startNewRound();
      } else {
        this.openSheetSettings();
      }
      
    } catch (error) {
      console.error('èªéŸ³å•Ÿç”¨å¤±æ•—:', error);
      alert('èªéŸ³åŠŸèƒ½å•Ÿç”¨å¤±æ•—ï¼Œä½†ç¨‹å¼ä»å¯æ­£å¸¸ä½¿ç”¨');
      this.speechActivated = false;
      
      // ä»ç„¶é€²å…¥ä¸»ç•«é¢
      var activationContainer = document.getElementById('speech-activation-container');
      if (activationContainer) {
        activationContainer.style.display = 'none';
      }
      this.hideLoading();
      this.applySettings();
      
      if (this.sheetSettings.sheetId && this.sheetSettings.selectedSheets.length > 0) {
        this.startNewRound();
      } else {
        this.openSheetSettings();
      }
    }
  };
  
  // éš±è—è¼‰å…¥ç•«é¢
  FlashcardApp.prototype.hideLoading = function() {
    var loadingDiv = document.getElementById('loading');
    var flashcardDiv = document.getElementById('flashcard');
    if (loadingDiv) loadingDiv.style.display = 'none';
    if (flashcardDiv) flashcardDiv.style.display = 'flex';
    
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    this.updateVoiceButtonState();
    this.updatePauseButtonState();
    this.updateFullscreenButtonText();
  };
  
  // é¡¯ç¤ºéŒ¯èª¤
  FlashcardApp.prototype.showError = function() {
    var loadingDiv = document.getElementById('loading');
    var errorDiv = document.getElementById('error');
    if (loadingDiv) loadingDiv.style.display = 'none';
    if (errorDiv) errorDiv.style.display = 'block';
  };
  
  // é–‹å§‹æ–°å›åˆ
  FlashcardApp.prototype.startNewRound = function() {
    this.shuffleArray(this.words);
    if (this.showDifficultOnly) {
      this.currentWords = this.words.filter(function(w) { 
        return this.difficultWords.includes(w.id); 
      }, this);
        } else {
      this.currentWords = this.words.slice();
    }
    this.currentIndex = 0;
    this.removedWords = [];
    this.navigationHistory = [];
    this.pendingRemoval = null;
    this.userPaused = false;
    this.isPaused = false;
    this.hideRestoreButton();
          
          if (this.currentWords.length === 0) {
      if (this.showDifficultOnly) {
        alert('æ²’æœ‰ä¸ç†Ÿå–®å­—ï¼');
        this.showDifficultOnly = false;
        var checkbox = document.getElementById('show-difficult-only');
        if (checkbox) checkbox.checked = false;
        this.currentWords = this.words.slice();
          }
        }
        
        this.displayCurrentWord();
        this.updateButtonStates();
    this.updateVoiceButtonState();
    this.updatePauseButtonState();
    this.updateFullscreenButtonText();
    this.renderDifficultStar();
  };
  
  // æ´—ç‰Œ
  FlashcardApp.prototype.shuffleArray = function(array) {
    for (var i = array.length - 1; i > 0; i--) {
      var j = Math.floor(Math.random() * (i + 1));
      var temp = array[i];
      array[i] = array[j];
      array[j] = temp;
    }
  };
  
  // é¡¯ç¤ºç•¶å‰å–®å­—
  FlashcardApp.prototype.displayCurrentWord = function() {
    if (this.currentWords.length === 0) {
      this.startNewRound();
      return;
    }
    
    var currentWord = this.currentWords[this.currentIndex];
    var englishElement = document.getElementById('english-word');
    var chineseElement = document.getElementById('chinese-word');
    this.showingChinese = false;
    this.isTransitioning = false;
    this.isProcessingClick = false;
      this.pendingRemoval = null;
      this.hideRestoreButton();
      
      if (this.displayTimer) {
        clearTimeout(this.displayTimer);
      }
      
    englishElement.classList.remove('show');
    chineseElement.classList.remove('show');
    
    englishElement.style.color = '';
    chineseElement.style.color = '';
    
    // å…ˆæ¸…é™¤èƒŒæ™¯åœ–ç‰‡ï¼ˆåœ–ç‰‡å°‡åœ¨ä¸­æ–‡ç¿»è­¯å‡ºç¾æ™‚æ‰é¡¯ç¤ºï¼‰
    var flashcardDiv = document.getElementById('flashcard');
    if (flashcardDiv) {
      flashcardDiv.style.backgroundImage = '';
      flashcardDiv.classList.remove('has-image');
    }
    
    var self = this;
    setTimeout(function() {
      var firstElement = document.getElementById('english-word');
      
      if (self.settings.reverseMode) {
        firstElement.textContent = currentWord.chinese;
        // åå‘æ¨¡å¼ï¼šå…ˆé¡¯ç¤ºä¸­æ–‡ï¼Œæ’­æ”¾ä¸­æ–‡èªéŸ³
        setTimeout(function() {
          self.speakChineseWord(currentWord.chinese);
        }, 500);
      } else {
        firstElement.textContent = currentWord.english;
        // åªæœ‰åœ¨æœªå•Ÿç”¨å»¶é²ç™¼éŸ³æ™‚æ‰ç«‹å³æ’­æ”¾èªéŸ³
        if (!self.settings.delaySpeechInNormalMode) {
          setTimeout(function() {
            self.speakWord(currentWord.english);
          }, 500);
        }
      }
      firstElement.classList.add('show');
      
      // é åŠ è¼‰ç•¶å‰å–®å­—çš„åœ–ç‰‡ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
      if (currentWord.image && currentWord.image !== '') {
        self.preloadImage(currentWord.image);
      }
      
      // é åŠ è¼‰ä¸‹ä¸€å€‹å–®å­—çš„åœ–ç‰‡ï¼ˆæå‰æº–å‚™ï¼‰
      var nextIndex = (self.currentIndex + 1) % self.currentWords.length;
      var nextWord = self.currentWords[nextIndex];
      if (nextWord && nextWord.image && nextWord.image !== '') {
        self.preloadImage(nextWord.image);
      }
  
      self.displayTimer = setTimeout(function() {
        self.showSecondPartAndScheduleNext();
      }, self.settings.delayTime * 1000);
      
    }, 100);
    
    this.renderDifficultStar();
    this.updateProgress();
    this.updateButtonStates();
  };
  
  // æ›´æ–°é€²åº¦
  FlashcardApp.prototype.updateProgress = function() {
    var progressText = document.getElementById('progress-text');
    if (progressText) {
      var current = this.currentIndex + 1;
      var total = this.currentWords.length;
      progressText.textContent = current + '/' + total;
    }
  };
  
  // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
  FlashcardApp.prototype.updateButtonStates = function() {
    var prevBtn = document.getElementById('prev-btn');
    if (prevBtn) {
      var isFirstWord = this.currentIndex === 0;
      var hasPendingRemoval = this.pendingRemoval !== null;
      prevBtn.disabled = (isFirstWord && !hasPendingRemoval) || this.navigationHistory.length === 0;
    }
  };
  
  // åˆ‡æ›é¸å–®
  FlashcardApp.prototype.toggleMenu = function() {
    console.log('toggleMenu è¢«èª¿ç”¨');
    var menuBtn = document.getElementById('menu-btn');
    var menuDropdown = document.getElementById('menu-dropdown');
    
    if (!menuBtn || !menuDropdown) {
      console.error('é¸å–®å…ƒç´ ä¸å­˜åœ¨ï¼Œç„¡æ³•åˆ‡æ›');
        return;
      }
      
    var isOpen = menuDropdown.classList.contains('show');
    console.log('é¸å–®ç›®å‰ç‹€æ…‹:', isOpen ? 'é–‹å•Ÿ' : 'é—œé–‰');
    
    if (isOpen) {
      this.closeMenu();
    } else {
      console.log('é–‹å•Ÿé¸å–®');
      menuBtn.classList.add('active');
      menuDropdown.classList.add('show');
    }
  };
  
  // é—œé–‰é¸å–®
  FlashcardApp.prototype.closeMenu = function() {
    console.log('closeMenu è¢«èª¿ç”¨');
    var menuBtn = document.getElementById('menu-btn');
    var menuDropdown = document.getElementById('menu-dropdown');
    
    if (menuBtn && menuDropdown) {
      console.log('é—œé–‰é¸å–®');
      menuBtn.classList.remove('active');
      menuDropdown.classList.remove('show');
    }
  };
  

  
  // æ¨¡æ…‹æ¡†ç›£è½å™¨
  FlashcardApp.prototype.setupModalListeners = function() {
    var self = this;
    
    // ä¸»è¨­å®šæ¨¡æ…‹æ¡†
    var settingsModal = document.getElementById('settings-modal');
    var closeSettings = document.getElementById('close-settings');
    var saveSettings = document.getElementById('save-settings');
    var cancelSettings = document.getElementById('cancel-settings');
    var delaySlider = document.getElementById('delay-setting');
    var fontSizeSlider = document.getElementById('font-size-setting');
    
    if (closeSettings) {
      closeSettings.addEventListener('click', function() { self.closeSettings(); });
    }
    if (saveSettings) {
      saveSettings.addEventListener('click', function() { self.saveSettingsAndClose(); });
    }
    if (cancelSettings) {
      cancelSettings.addEventListener('click', function() { self.closeSettings(); });
    }
    if (settingsModal) {
      settingsModal.addEventListener('click', function(e) {
        // æª¢æŸ¥é»æ“Šç›®æ¨™ï¼Œæ’é™¤selectå…ƒç´ åŠå…¶ç›¸é—œå…ƒç´ 
        var target = e.target;
        var isSelectRelated = false;
        
        // å‘ä¸Šéæ­·DOMæ¨¹æª¢æŸ¥æ˜¯å¦é»æ“Šäº†selectæˆ–å…¶ç›¸é—œå…ƒç´ 
        var element = target;
        while (element && element !== settingsModal) {
          if (element.tagName === 'SELECT' || 
              element.tagName === 'OPTION' ||
              element.classList.contains('setting-control') ||
              element.classList.contains('font-preview')) {
            isSelectRelated = true;
            break;
          }
          element = element.parentElement;
        }
        
        // åªæœ‰é»æ“Šæ¨¡æ…‹æ¡†èƒŒæ™¯ä¸”ä¸æ˜¯selectç›¸é—œå…ƒç´ æ™‚æ‰é—œé–‰
        if (e.target === settingsModal && !isSelectRelated) {
          self.closeSettings();
        }
      });
    }
    
    // ä¿®å¾©ï¼šè¨­å®šæ»‘æ¡¿å¯¦æ™‚æ›´æ–°
    if (delaySlider) {
      delaySlider.addEventListener('input', function(e) {
        var delayValue = document.getElementById('delay-value');
        if (delayValue) {
          // ä¿®å¾©æµ®é»æ•¸ç²¾åº¦å•é¡Œ
          var value = parseFloat(e.target.value);
          var step = parseFloat(e.target.step) || 0.5;
          var decimalPlaces = step.toString().indexOf('.') !== -1 ? step.toString().split('.')[1].length : 0;
          var formattedValue = parseFloat(value.toFixed(decimalPlaces));
          delayValue.textContent = formattedValue;
        }
      });
      
      // å¢å¼·è§¸æ§é«”é©—ï¼šé»æ“Šè»Œé“ç›´æ¥è¨­ç½®å€¼
      this.enhanceSliderInteraction(delaySlider, 'delay-value');
    }
    
    if (fontSizeSlider) {
      fontSizeSlider.addEventListener('input', function(e) {
        var fontSizeValue = document.getElementById('font-size-value');
        if (fontSizeValue) {
          fontSizeValue.textContent = e.target.value + 'px';
        }
        // å³æ™‚é è¦½å­—é«”å¤§å°
        var englishWord = document.getElementById('english-word');
        var chineseWord = document.getElementById('chinese-word');
        var previewEnglish = document.querySelector('.preview-english');
        var previewChinese = document.querySelector('.preview-chinese');
        
        if (englishWord) englishWord.style.fontSize = e.target.value + 'px';
        if (chineseWord) chineseWord.style.fontSize = e.target.value + 'px';
        if (previewEnglish) previewEnglish.style.fontSize = Math.max(16, e.target.value * 0.2) + 'px';
        if (previewChinese) previewChinese.style.fontSize = Math.max(14, e.target.value * 0.18) + 'px';
      });
      
      // å¢å¼·è§¸æ§é«”é©—ï¼šé»æ“Šè»Œé“ç›´æ¥è¨­ç½®å€¼
      this.enhanceSliderInteraction(fontSizeSlider, 'font-size-value', 'px');
    }
    
    // å­—å‹é¸æ“‡å™¨äº‹ä»¶ç›£è½
    var fontFamilySelect = document.getElementById('font-family-setting');
    if (fontFamilySelect) {
      var self = this;
      
      // ä¿è­·selectå…ƒç´ ä¸å—å…¨åŸŸäº‹ä»¶å¹²æ“¾
      this.protectSelectElement(fontFamilySelect);
      
      fontFamilySelect.addEventListener('change', function(e) {
        console.log('å­—å‹é¸æ“‡æ”¹è®Š:', e.target.value);
        
        // å³æ™‚é è¦½å­—å‹æ•ˆæœ
        var selectedFont = e.target.value;
        var fontFamily = self.fontFamilyMap[selectedFont] || self.fontFamilyMap['system-default'];
        
        // æ›´æ–°ä¸»è¦å…ƒç´ çš„å­—å‹
        var englishWord = document.getElementById('english-word');
        var chineseWord = document.getElementById('chinese-word');
        if (englishWord) englishWord.style.fontFamily = fontFamily;
        if (chineseWord) chineseWord.style.fontFamily = fontFamily;
        
        // æ›´æ–°é è¦½
        var previewEnglish = document.querySelector('.preview-english');
        var previewChinese = document.querySelector('.preview-chinese');
        if (previewEnglish) previewEnglish.style.fontFamily = fontFamily;
        if (previewChinese) previewChinese.style.fontFamily = fontFamily;
      });
    }
    
    // Google Sheet è¨­å®šæ¨¡æ…‹æ¡†
    var sheetSettingsModal = document.getElementById('sheet-settings-modal');
    var closeSheetSettings = document.getElementById('close-sheet-settings');
    var cancelSheetSettings = document.getElementById('cancel-sheet-settings');
    var saveSheetSettings = document.getElementById('save-sheet-settings');
    var loadSheetsBtn = document.getElementById('load-sheets-btn');
    
    if (closeSheetSettings) {
      closeSheetSettings.addEventListener('click', function() { self.closeSheetSettings(); });
    }
    if (cancelSheetSettings) {
      cancelSheetSettings.addEventListener('click', function() { self.closeSheetSettings(); });
    }
    if (saveSheetSettings) {
      saveSheetSettings.addEventListener('click', function() { self.saveSheetSettingsAndClose(); });
    }
    if (loadSheetsBtn) {
      loadSheetsBtn.addEventListener('click', function() { self.loadSheetsList(); });
    }
    if (sheetSettingsModal) {
      sheetSettingsModal.addEventListener('click', function(e) {
        // æª¢æŸ¥é»æ“Šç›®æ¨™ï¼Œæ’é™¤selectå…ƒç´ åŠå…¶ç›¸é—œå…ƒç´ 
        var target = e.target;
        var isSelectRelated = false;
        
        var element = target;
        while (element && element !== sheetSettingsModal) {
          if (element.tagName === 'SELECT' || 
              element.tagName === 'OPTION' ||
              element.classList.contains('setting-control')) {
            isSelectRelated = true;
            break;
          }
          element = element.parentElement;
        }
        
        if (e.target === sheetSettingsModal && !isSelectRelated) {
          self.closeSheetSettings();
        }
      });
    }
    
    // èªéŸ³è¨­å®šæ¨¡æ…‹æ¡†
    var voiceSettingsModal = document.getElementById('voice-settings-modal');
    var closeVoiceSettings = document.getElementById('close-voice-settings');
    var cancelVoiceSettings = document.getElementById('cancel-voice-settings');
    var saveVoiceSettings = document.getElementById('save-voice-settings');
    var voiceRateSlider = document.getElementById('voice-rate-setting');
    
    if (closeVoiceSettings) {
      closeVoiceSettings.addEventListener('click', function() { self.closeVoiceSettings(); });
    }
    if (cancelVoiceSettings) {
      cancelVoiceSettings.addEventListener('click', function() { self.closeVoiceSettings(); });
    }
    if (saveVoiceSettings) {
      saveVoiceSettings.addEventListener('click', function() { self.saveVoiceSettingsAndClose(); });
    }
    if (voiceSettingsModal) {
      voiceSettingsModal.addEventListener('click', function(e) {
        // æª¢æŸ¥é»æ“Šç›®æ¨™ï¼Œæ’é™¤selectå…ƒç´ åŠå…¶ç›¸é—œå…ƒç´ ï¼ˆèˆ‡ä¸»è¨­å®šæ¨¡æ…‹æ¡†ç›¸åŒçš„é‚è¼¯ï¼‰
        var target = e.target;
        var isSelectRelated = false;
        
        var element = target;
        while (element && element !== voiceSettingsModal) {
          if (element.tagName === 'SELECT' || 
              element.tagName === 'OPTION' ||
              element.classList.contains('setting-control')) {
            isSelectRelated = true;
            break;
          }
          element = element.parentElement;
        }
        
        if (e.target === voiceSettingsModal && !isSelectRelated) {
          self.closeVoiceSettings();
        }
      });
    }
    if (voiceRateSlider) {
      voiceRateSlider.addEventListener('input', function(e) {
        var voiceRateValue = document.getElementById('voice-rate-value');
        if (voiceRateValue) {
          // ä¿®å¾©æµ®é»æ•¸ç²¾åº¦å•é¡Œ
          var value = parseFloat(e.target.value);
          var step = parseFloat(e.target.step) || 0.1;
          var decimalPlaces = step.toString().indexOf('.') !== -1 ? step.toString().split('.')[1].length : 0;
          var formattedValue = parseFloat(value.toFixed(decimalPlaces));
          voiceRateValue.textContent = formattedValue;
        }
      });
      
      // ç•¶ç”¨æˆ¶æ¾é–‹æ»‘æ†æ™‚ï¼Œæ’­æ”¾ç¤ºä¾‹èªéŸ³
      voiceRateSlider.addEventListener('change', function(e) {
        // ç²å–ç•¶å‰é¸æ“‡çš„è‹±æ–‡èªéŸ³
        var voiceSelect = document.getElementById('voice-select-setting');
        if (voiceSelect && voiceSelect.value) {
          self.previewVoice(voiceSelect.value, 'Hello, this is a sample voice.');
        }
      });
      
      // å¢å¼·è§¸æ§é«”é©—ï¼šé»æ“Šè»Œé“ç›´æ¥è¨­ç½®å€¼
      this.enhanceSliderInteraction(voiceRateSlider, 'voice-rate-value');
    }
    
    // åŒ¯å‡ºæ¨¡æ…‹æ¡†
    var exportModal = document.getElementById('export-modal');
    if (exportModal) {
      exportModal.addEventListener('click', function(e) {
        // æª¢æŸ¥é»æ“Šç›®æ¨™ï¼Œæ’é™¤selectå…ƒç´ åŠå…¶ç›¸é—œå…ƒç´ 
        var target = e.target;
        var isSelectRelated = false;
        
        var element = target;
        while (element && element !== exportModal) {
          if (element.tagName === 'SELECT' || 
              element.tagName === 'OPTION' ||
              element.classList.contains('setting-control')) {
            isSelectRelated = true;
            break;
          }
          element = element.parentElement;
        }
        
        if (e.target === exportModal && !isSelectRelated) {
          self.closeExportModal();
        }
      });
    }
    
    // è¦†å¯«ç¢ºèªæ¨¡æ…‹æ¡†
    var overwriteModal = document.getElementById('overwrite-confirm-modal');
    if (overwriteModal) {
      overwriteModal.addEventListener('click', function(e) {
        // æª¢æŸ¥é»æ“Šç›®æ¨™ï¼Œæ’é™¤selectå…ƒç´ åŠå…¶ç›¸é—œå…ƒç´ 
        var target = e.target;
        var isSelectRelated = false;
        
        var element = target;
        while (element && element !== overwriteModal) {
          if (element.tagName === 'SELECT' || 
              element.tagName === 'OPTION' ||
              element.classList.contains('setting-control')) {
            isSelectRelated = true;
            break;
          }
          element = element.parentElement;
        }
        
        if (e.target === overwriteModal && !isSelectRelated) {
          self.closeOverwriteConfirmModal();
        }
      });
    }
    
    // æ¸¬é©—æ¨¡æ…‹æ¡†
    this.setupQuizListeners();
  };
  
    // éµç›¤ç›£è½å™¨ - iPad 4 å…¼å®¹ç‰ˆæœ¬
  FlashcardApp.prototype.setupKeyboardListeners = function() {
    var self = this;
    
    // iPad 4 å…¼å®¹æ€§æ”¹é€²ï¼šç¢ºä¿ body å…ƒç´ å¯ä»¥æ¥æ”¶éµç›¤äº‹ä»¶
    var body = document.body;
    
    // è¨­ç½® tabindex å±¬æ€§ï¼Œè®“ body å¯ä»¥è¢«èšç„¦
    body.setAttribute('tabindex', '0');
    
    // è‡ªå‹•èšç„¦åˆ° body å…ƒç´ 
    body.focus();
    
    // åŠ å…¥é»æ“Šäº‹ä»¶ç›£è½å™¨ï¼Œç¢ºä¿é»æ“Šå¾Œé‡æ–°èšç„¦åˆ° bodyï¼ˆä½†æ’é™¤è¡¨å–®æ§ä»¶ï¼‰
    body.addEventListener('click', function(e) {
      // æª¢æŸ¥é»æ“Šç›®æ¨™æ˜¯å¦ç‚ºè¡¨å–®æ§ä»¶
      var target = e.target;
      if (target && (
          target.tagName === 'SELECT' ||
          target.tagName === 'OPTION' ||
          target.tagName === 'INPUT' ||
          target.tagName === 'TEXTAREA' ||
          target.contentEditable === 'true'
      )) {
        console.log('é»æ“Šäº†è¡¨å–®æ§ä»¶ï¼Œä¸é‡æ–°èšç„¦åˆ°body:', target.tagName);
        return; // ä¸é‡æ–°èšç„¦ï¼Œè®“è¡¨å–®æ§ä»¶ä¿æŒç„¦é»
      }
      
      // æª¢æŸ¥æ˜¯å¦é»æ“Šäº†è¡¨å–®æ§ä»¶çš„å®¹å™¨
      var element = target;
      while (element && element !== body) {
        if (element.classList && (
            element.classList.contains('setting-control') ||
            element.classList.contains('font-preview')
        )) {
          console.log('é»æ“Šäº†è¡¨å–®æ§ä»¶å®¹å™¨ï¼Œä¸é‡æ–°èšç„¦åˆ°body');
          return;
        }
        element = element.parentElement;
      }
      
      body.focus();
    });
    
      // éµç›¤äº‹ä»¶è™•ç†å‡½æ•¸ - ä½¿ç”¨ ES5 å…¼å®¹èªæ³•
  function handleKeyDown(e) {
    // å–å¾—æŒ‰éµä¿¡æ¯ï¼Œå…¼å®¹èˆŠç‰ˆç€è¦½å™¨
    e = e || window.event;
    var keyCode = e.keyCode || e.which;
    var code = e.code || '';
    var key = e.key || '';
    
    // æª¢æŸ¥ç•¶å‰ç„¦é»æ˜¯å¦åœ¨selectå…ƒç´ æˆ–å…¶ä»–è¡¨å–®æ§ä»¶ä¸Š
    var activeElement = document.activeElement;
    if (activeElement && (
        activeElement.tagName === 'SELECT' ||
        activeElement.tagName === 'INPUT' ||
        activeElement.tagName === 'TEXTAREA' ||
        activeElement.contentEditable === 'true'
    )) {
      console.log('ç„¦é»åœ¨è¡¨å–®æ§ä»¶ä¸Šï¼Œè·³ééµç›¤å¿«æ·éµè™•ç†:', activeElement.tagName);
      return; // ä¸è™•ç†ä»»ä½•éµç›¤å¿«æ·éµï¼Œè®“è¡¨å–®æ§ä»¶æ­£å¸¸å·¥ä½œ
    }
    
    // B éµ (keyCode 66) - æš«åœ/ç¹¼çºŒåŠŸèƒ½ï¼Œåœ¨ä»»ä½•ç‹€æ…‹ä¸‹éƒ½èƒ½ä½¿ç”¨
    if (keyCode === 66 || code === 'KeyB') {
      // é˜²æ­¢é è¨­è¡Œç‚º
      if (e.preventDefault) {
        e.preventDefault();
      } else {
        e.returnValue = false; // IE8 åŠæ›´æ—©ç‰ˆæœ¬
      }
      
      self.togglePause();
      return;
    }
    
    // å¦‚æœå·²æš«åœï¼Œé™¤äº† B éµå¤–ä¸è™•ç†å…¶ä»–æŒ‰éµ
    if (self.isPaused) return;
    
    // è™•ç†ç‰¹æ®ŠæŒ‰éµå°æ‡‰
    var keyActions = {};
    
    // Enter éµ (keyCode 13, æˆ– iPad 4 çš„ UIKeyInputUpArrow)
    if (keyCode === 13 || code === 'Enter' || key === 'UIKeyInputUpArrow') {
      keyActions['action'] = function() { self.toggleDifficultCurrentWord(); };
    }
    // ç©ºæ ¼éµ (keyCode 32, æˆ– iPad 4 çš„ UIKeyInputDownArrow)
    else if (keyCode === 32 || code === 'Space' || key === 'UIKeyInputDownArrow') {
      keyActions['action'] = function() { self.onWordClick(); };
    }
    // å·¦æ–¹å‘éµ (keyCode 37, ArrowLeft, æˆ– iPad 4 çš„ UIKeyInputLeftArrow)
    else if (keyCode === 37 || code === 'ArrowLeft' || key === 'UIKeyInputLeftArrow') {
      keyActions['action'] = function() { self.previousWord(); };
    }
    // ä¸Šæ–¹å‘éµ (keyCode 38, ArrowUp)
    else if (keyCode === 38 || code === 'ArrowUp') {
      keyActions['action'] = function() { self.previousWord(); };
    }
    // å³æ–¹å‘éµ (keyCode 39, ArrowRight, æˆ– iPad 4 çš„ UIKeyInputRightArrow)
    else if (keyCode === 39 || code === 'ArrowRight' || key === 'UIKeyInputRightArrow') {
      keyActions['action'] = function() { self.nextWord(); };
    }
    // ä¸‹æ–¹å‘éµ (keyCode 40)
    else if (keyCode === 40 || code === 'ArrowDown') {
      keyActions['action'] = function() { self.nextWord(); };
    }
    // Escape éµ (keyCode 27)
    else if (keyCode === 27 || code === 'Escape') {
      keyActions['action'] = function() {
        self.closeSettings();
        self.closeVoiceSettings();
        self.closeExportModal();
        self.closeOverwriteConfirmModal();
        self.closeDuplicateModal();
        self.closeMenu();
      };
    }
    // F5 éµ (keyCode 116) è·Ÿ S éµ (keyCode 83)  - æ¨™æ³¨ä¸ç†Ÿå–®å­—
    else if (keyCode === 116 || code === 'F5' || keyCode === 83 || code === 'KeyS') {
      keyActions['action'] = function() { self.toggleDifficultCurrentWord(); };
    }

      // åŸ·è¡Œå°æ‡‰çš„å‹•ä½œ
      if (keyActions['action']) {
        // é˜²æ­¢é è¨­è¡Œç‚º
        if (e.preventDefault) {
          e.preventDefault();
        } else {
          e.returnValue = false; // IE8 åŠæ›´æ—©ç‰ˆæœ¬
        }
        
        keyActions['action']();
      }
    }
    
    // ç›£è½æ•´å€‹ document çš„éµç›¤äº‹ä»¶
    document.addEventListener('keydown', handleKeyDown);
    
    console.log('éµç›¤äº‹ä»¶ç›£è½å™¨å·²è¨­ç½® (iPad 4 å…¼å®¹ç‰ˆæœ¬)');
  };
  
  // é€²åº¦å€å’ŒåŒ¯å‡ºç›£è½å™¨
  FlashcardApp.prototype.setupProgressAndExportListeners = function() {
    console.log('è¨­ç½®é€²åº¦å€å’ŒåŒ¯å‡ºäº‹ä»¶ç›£è½å™¨...');
    var self = this;
  
    // ä¿®å¾©ï¼šé€²åº¦å€é»æ“Šæ¨™è¨»/å–æ¶ˆä¸ç†Ÿå–®å­—
    var progressArea = document.getElementById('progress-area');
    if (progressArea) {
      // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨
      var newProgressArea = progressArea.cloneNode(true);
      progressArea.parentNode.replaceChild(newProgressArea, progressArea);
  
      newProgressArea.addEventListener('click', function() {
        console.log('é€²åº¦å€è¢«é»æ“Šï¼Œåˆ‡æ›å›°é›£å–®å­—ç‹€æ…‹');
        self.toggleDifficultCurrentWord();
      });
      console.log('é€²åº¦å€äº‹ä»¶ç›£è½å™¨è¨­ç½®å®Œæˆ');
      } else {
      console.error('æ‰¾ä¸åˆ° progress-area å…ƒç´ ');
    }
  
    // åªé¡¯ç¤ºä¸ç†Ÿå–®å­—checkbox
    var showDifficultCheckbox = document.getElementById('show-difficult-only');
    if (showDifficultCheckbox) {
      showDifficultCheckbox.addEventListener('change', function(e) {
        console.log('åˆ‡æ›åªé¡¯ç¤ºä¸ç†Ÿå–®å­—:', e.target.checked);
        self.showDifficultOnly = e.target.checked;
        self.filterWordsByDifficult();
      });
      console.log('ä¸ç†Ÿå–®å­—éæ¿¾å™¨äº‹ä»¶ç›£è½å™¨è¨­ç½®å®Œæˆ');
    } else {
      console.error('æ‰¾ä¸åˆ° show-difficult-only å…ƒç´ ');
    }
  
    // åŒ¯å‡ºç›¸é—œäº‹ä»¶
    var closeExportModal = document.getElementById('close-export-modal');
    var cancelExport = document.getElementById('cancel-export');
    var confirmExport = document.getElementById('confirm-export');
  
    if (closeExportModal) {
      closeExportModal.addEventListener('click', function() { self.closeExportModal(); });
    }
    if (cancelExport) {
      cancelExport.addEventListener('click', function() { self.closeExportModal(); });
    }
    if (confirmExport) {
      confirmExport.addEventListener('click', function() { self.confirmExport(); });
    }
  
    console.log('åŒ¯å‡ºç›¸é—œäº‹ä»¶ç›£è½å™¨è¨­ç½®å®Œæˆ');
    
    // éš±è—æ§åˆ¶æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
    this.setupHiddenControlListeners();
  };
  
  // è¨­ç½®éš±è—æ§åˆ¶æŒ‰éˆ•ç›£è½å™¨
  FlashcardApp.prototype.setupHiddenControlListeners = function() {
    console.log('è¨­ç½®éš±è—æ§åˆ¶æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨...');
    var self = this;
    

    
    
    

    
    console.log('éš±è—æ§åˆ¶æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨è¨­ç½®å®Œæˆ');
  };
  

  

  

  

  

  

  
  // é–‹å•Ÿè¨­å®š
  FlashcardApp.prototype.openSettings = function() {
    var settingsModal = document.getElementById('settings-modal');
    if (settingsModal) {
      settingsModal.style.display = 'flex';
      this.pauseTimer();
      this.applySettings();
    }
  };
  
  // é—œé–‰è¨­å®š
  FlashcardApp.prototype.closeSettings = function(shouldRedisplay) {
    var settingsModal = document.getElementById('settings-modal');
    if (settingsModal) {
      settingsModal.style.display = 'none';
      this.resumeTimer();
      
      if (shouldRedisplay) {
        this.redisplayCurrentWord();
      }
    }
  };
  
  // å„²å­˜è¨­å®šä¸¦é—œé–‰
  FlashcardApp.prototype.saveSettingsAndClose = function() {
    var delaySlider = document.getElementById('delay-setting');
    var fontSizeSlider = document.getElementById('font-size-setting');
    var fontFamilySelect = document.getElementById('font-family-setting');
    var reverseToggle = document.getElementById('reverse-setting');
    var delaySpeechToggle = document.getElementById('delay-speech-setting');
    
    var oldReverseMode = this.settings.reverseMode;
    var oldFontFamily = this.settings.fontFamily;
    
    if (delaySlider) this.settings.delayTime = parseFloat(delaySlider.value);
    if (fontSizeSlider) this.settings.fontSize = parseInt(fontSizeSlider.value);
    if (fontFamilySelect) this.settings.fontFamily = fontFamilySelect.value;
    if (reverseToggle) this.settings.reverseMode = reverseToggle.checked;
    if (delaySpeechToggle) this.settings.delaySpeechInNormalMode = delaySpeechToggle.checked;
    
    this.saveSettings();
    this.applySettings();
    this.closeSettings();
    
    // å¦‚æœç¿»è­¯æ¨¡å¼æˆ–å­—å‹æ”¹è®Šï¼Œé‡æ–°é¡¯ç¤ºç•¶å‰å–®å­—
    if (oldReverseMode !== this.settings.reverseMode || oldFontFamily !== this.settings.fontFamily) {
      this.redisplayCurrentWord();
    }
  };
  
  // é‡ç½®è¨­å®š
  FlashcardApp.prototype.resetSettings = function() {
    this.settings = {
      delayTime: 3,
      fontSize: 96,
      reverseMode: false,
      fontFamily: 'system-default',
      delaySpeechInNormalMode: false
    };
    this.voiceSettings = {
      enabled: true,
      rate: 0.8,
      pitch: 1,
      volume: 1,
      lang: 'en-US',
      voiceURI: '',
      japaneseLang: 'ja-JP',
      japaneseVoiceURI: '',
      spellOutLetters: false,
      chineseEnabled: false,
      chineseLang: 'zh-TW',
      chineseVoiceURI: ''
    };
    this.applySettings();
      this.saveSettings();
    this.closeSettings();
  };
  
  // æš«åœè¨ˆæ™‚å™¨
  FlashcardApp.prototype.pauseTimer = function() {
    this.isPaused = true;
    
    if (this.displayTimer) {
      clearTimeout(this.displayTimer);
      this.displayTimer = null;
    }

  };
  
  // æ¢å¾©è¨ˆæ™‚å™¨
  FlashcardApp.prototype.resumeTimer = function() {
    // åªæœ‰åœ¨ç”¨æˆ¶æ²’æœ‰æ‰‹å‹•æš«åœçš„æƒ…æ³ä¸‹æ‰æ¢å¾©è¨ˆæ™‚å™¨
    if (!this.userPaused) {
      this.isPaused = false;
    }
    
    var self = this;
    if (!this.isPaused) {
      if (this.showingChinese) {
        this.displayTimer = setTimeout(function() {
          self.nextWord();
        }, this.settings.delayTime * 1000);
      } else if (!this.isTransitioning && !this.isProcessingClick) {
        var currentWord = this.currentWords[this.currentIndex];
        if (currentWord) {
          this.displayTimer = setTimeout(function() {
            self.showSecondPartAndScheduleNext();
          }, this.settings.delayTime * 1000);
        }
      }
    }
    
    // æ›´æ–°UIç‹€æ…‹
    this.updatePauseButtonState();
  };
  
  // é–‹å•ŸGoogle Sheetè¨­å®š
  FlashcardApp.prototype.openSheetSettings = function() {
    console.log('é–‹å•Ÿ Google Sheet è¨­å®šç•«é¢');
    var modal = document.getElementById('sheet-settings-modal');
    if (modal) {
      modal.style.display = 'flex';
      
      var sheetIdInput = document.getElementById('sheet-id-input');
      if (sheetIdInput) {
        sheetIdInput.value = this.sheetSettings.sheetId || '';
      }
      
      var sheetsGroup = document.getElementById('sheets-selection-group');
      if (sheetsGroup) {
      sheetsGroup.style.display = 'none';
      }
      
      var saveBtn = document.getElementById('save-sheet-settings');
      if (saveBtn) {
      saveBtn.disabled = true;
      }
      
      // é¡¯ç¤ºæ­·å²è¨˜éŒ„
      this.displaySheetHistory();
      
      this.pauseTimer();
    }
  };
  
  // é—œé–‰Google Sheetè¨­å®š
  FlashcardApp.prototype.closeSheetSettings = function() {
    var modal = document.getElementById('sheet-settings-modal');
    if (modal) {
      modal.style.display = 'none';
      this.resumeTimer();
    }
  };
  
  // æ¨™è¨»å›°é›£å–®å­—
  FlashcardApp.prototype.toggleDifficultCurrentWord = function() {
    if (this.currentWords.length === 0) return;
    
    var currentWord = this.currentWords[this.currentIndex];
      if (!currentWord) return;
      
    var id = currentWord.id;
    var isDifficult = this.difficultWords.includes(id);
    
      if (isDifficult) {
      this.difficultWords = this.difficultWords.filter(function(did) { return did !== id; });
        } else {
        this.difficultWords.push(id);
      }
      
      // å¾Œç«¯åŒæ­¥
      if (typeof google !== 'undefined' && google.script && google.script.run) {
      var rowIndex = currentWord.originalRowIndex;
        if (rowIndex === undefined) {
        rowIndex = this.words.findIndex(function(w) {
          return w.english === currentWord.english && w.chinese === currentWord.chinese;
        });
        }
        
        if (rowIndex !== -1) {
        var sheetId = this.sheetSettings.sheetId;
        var sheetName = currentWord.sheetName || 'Sheet1';
        var markValue = isDifficult ? '' : '*';
          console.log('æ¨™è¨»å–®å­—:', currentWord.english, 'è¡Œç´¢å¼•:', rowIndex, 'æ¨™è¨˜å€¼:', markValue);
          google.script.run.markWordAsDifficult(sheetId, sheetName, rowIndex, markValue);
        }
      }
  
    // è™•ç†ã€Œåªé¡¯ç¤ºä¸ç†Ÿå–®å­—ã€æ¨¡å¼
      if (this.showDifficultOnly && isDifficult) {
        this.currentWords.splice(this.currentIndex, 1);
        
        if (this.currentIndex >= this.currentWords.length) {
          this.currentIndex = 0;
        }
        
        if (this.currentWords.length === 0) {
          alert('æ­å–œï¼æ²’æœ‰ä¸ç†Ÿå–®å­—äº†ï¼');
          this.showDifficultOnly = false;
        var checkbox = document.getElementById('show-difficult-only');
        if (checkbox) checkbox.checked = false;
          this.startNewRound();
        } else {
          this.displayCurrentWord();
        }
      } else {
        this.renderDifficultStar();
      }
  };
  
  // æ¸²æŸ“å›°é›£æ˜Ÿæ˜Ÿ
  FlashcardApp.prototype.renderDifficultStar = function() {
    var currentWord = this.currentWords[this.currentIndex];
    var star = document.getElementById('difficult-star');
    if (star && currentWord && this.difficultWords.includes(currentWord.id)) {
        star.classList.add('visible');
    } else if (star) {
        star.classList.remove('visible');
      }
  };
    
  // éæ¿¾å›°é›£å–®å­—
  FlashcardApp.prototype.filterWordsByDifficult = function() {
      if (this.showDifficultOnly) {
      var self = this;
      this.currentWords = this.words.filter(function(w) { return self.difficultWords.includes(w.id); });
        this.currentIndex = 0;
      } else {
      this.currentWords = this.words.slice();
        this.currentIndex = 0;
      }
      this.displayCurrentWord();
  };
  
  // è™•ç†flashcardé»æ“Šäº‹ä»¶ï¼ˆæª¢æŸ¥é»æ“Šä½ç½®ï¼‰
  FlashcardApp.prototype.handleFlashcardClick = function(event) {
    // æª¢æŸ¥é»æ“Šæ˜¯å¦ç™¼ç”Ÿåœ¨æ§åˆ¶æŒ‰éˆ•æˆ–é¸å–®ä¸Šï¼ˆES5å…¼å®¹ç‰ˆæœ¬ï¼‰
    var target = event.target;
    
    // å‘ä¸Šéå†DOMæ ‘æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†æ§åˆ¶å…ƒç´ 
    var element = target;
    while (element && element !== event.currentTarget) {
      if (element.classList && (
          element.classList.contains('controls-wrapper') ||
          element.classList.contains('progress') ||
          element.classList.contains('restore-btn-container') ||
          element.classList.contains('paused-indicator') ||
          element.classList.contains('paused-content') ||
          element.classList.contains('paused-icon') ||
          element.classList.contains('paused-text') ||
          element.classList.contains('muted-indicator') ||
          element.classList.contains('muted-content') ||
          element.classList.contains('muted-icon') ||
          element.classList.contains('muted-text') ||
          element.tagName === 'BUTTON')) {
        return; // å¦‚æœé»æ“Šçš„æ˜¯æ§åˆ¶å…ƒç´ ï¼Œä¸è™•ç†
      }
      element = element.parentElement;
    }
    
    // è¨ˆç®—ä¸‹æ–¹å®‰å…¨å€åŸŸçš„é«˜åº¦
    var flashcardRect = event.currentTarget.getBoundingClientRect();
    var clickY = event.clientY;
    var flashcardBottom = flashcardRect.bottom;
    
    // å‹•æ…‹è¨ˆç®—ä¸‹æ–¹å®‰å…¨å€åŸŸé«˜åº¦
    var progressElement = document.getElementById('progress-area');
    var controlsWrapper = document.querySelector('.controls-wrapper');
    var safeAreaHeight = 120; // é»˜èªé«˜åº¦
    
    // å˜—è©¦å‹•æ…‹è¨ˆç®—å¯¦éš›é«˜åº¦
    try {
      var progressHeight = progressElement ? progressElement.offsetHeight + 20 : 40; // åŒ…å«padding
      var controlsHeight = controlsWrapper ? controlsWrapper.offsetHeight + 20 : 60; // åŒ…å«padding
      safeAreaHeight = Math.max(progressHeight, controlsHeight) + 20; // é¡å¤–çš„å®‰å…¨é‚Šè·
    } catch (e) {
      console.log('ç„¡æ³•å‹•æ…‹è¨ˆç®—å®‰å…¨å€åŸŸé«˜åº¦ï¼Œä½¿ç”¨é»˜èªå€¼');
    }
    
    var safeAreaTop = flashcardBottom - safeAreaHeight;
    
    // å¦‚æœé»æ“Šä½ç½®åœ¨ä¸‹æ–¹å®‰å…¨å€åŸŸå…§ï¼Œä¸è§¸ç™¼åˆªé™¤åŠŸèƒ½
    if (clickY >= safeAreaTop) {
      console.log('é»æ“Šä½ç½®åœ¨å®‰å…¨å€åŸŸå…§(Y:' + clickY + ', å®‰å…¨å€åŸŸèµ·å§‹:' + safeAreaTop + ')ï¼Œä¸è§¸ç™¼åˆªé™¤åŠŸèƒ½');
      return;
    }
    
    console.log('é»æ“Šä½ç½®åœ¨æœ‰æ•ˆå€åŸŸå…§(Y:' + clickY + ', å®‰å…¨å€åŸŸèµ·å§‹:' + safeAreaTop + ')ï¼Œè§¸ç™¼åˆªé™¤åŠŸèƒ½');
    // è§¸ç™¼å–®å­—é»æ“Šäº‹ä»¶
    this.onWordClick();
  };
  
  // å–®å­—é»æ“Šäº‹ä»¶ï¼ˆåˆªé™¤å–®å­—åŠŸèƒ½ï¼‰
  FlashcardApp.prototype.onWordClick = function() {
    if (this.isTransitioning || this.isPaused) return;
    
    if (this.currentWords.length <= 1) {
      var sections = document.querySelectorAll('.card-section');
      for (var i = 0; i < sections.length; i++) {
        sections[i].style.backgroundColor = 'rgba(255, 100, 100, 0.3)';
        (function(section) {
          setTimeout(function() {
            section.style.backgroundColor = '';
          }, 300);
        })(sections[i]);
      }
      return;
    }
    
    var currentWord = this.currentWords[this.currentIndex];
    var englishElement = document.getElementById('english-word');
    var chineseElement = document.getElementById('chinese-word');
    
    var isAlreadyMarked = englishElement.style.color === 'rgb(102, 102, 102)' || 
                        englishElement.style.color === '#666666';
    
    if (isAlreadyMarked) {
      this.nextWord();
        return;
      }
      
    this.isProcessingClick = true;
    
    if (this.displayTimer) {
      clearTimeout(this.displayTimer);
    }
    
    if (!this.showingChinese) {
      var secondText = this.settings.reverseMode ? currentWord.english : currentWord.chinese;
      chineseElement.textContent = secondText;
      chineseElement.classList.add('show');
      this.showingChinese = true;
      
      // åŒæ™‚é¡¯ç¤ºåœ–ç‰‡ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰- ä½¿ç”¨é åŠ è¼‰çš„åœ–ç‰‡
      var flashcardDiv = document.getElementById('flashcard');
      var hasImage = currentWord.image && currentWord.image !== '';
      if (hasImage) {
        // ç”±æ–¼åœ–ç‰‡å·²ç¶“é åŠ è¼‰ï¼Œå¯ä»¥ç›´æ¥è¨­å®šï¼Œç„¡éœ€ç­‰å¾…
        flashcardDiv.style.backgroundImage = 'url(' + currentWord.image + ')';
        flashcardDiv.classList.add('has-image');
      } else {
        flashcardDiv.style.backgroundImage = '';
        flashcardDiv.classList.remove('has-image');
      }
      
      var self = this;
      
      if (this.settings.reverseMode) {
        // åå‘æ¨¡å¼ï¼šç”¨æˆ¶é»æ“Šé¡¯ç¤ºè‹±æ–‡ï¼Œæ’­æ”¾è‹±æ–‡èªéŸ³
        setTimeout(function() {
          self.speakWord(currentWord.english);
        }, 500);
      } else {
        // æ­£å¸¸æ¨¡å¼ï¼šç”¨æˆ¶é»æ“Šé¡¯ç¤ºä¸­æ–‡ï¼Œæ’­æ”¾ä¸­æ–‡èªéŸ³
        setTimeout(function() {
          self.speakChineseWord(currentWord.chinese);
        }, 500);
        
        // å¦‚æœå•Ÿç”¨äº†å»¶é²ç™¼éŸ³ï¼Œä¹Ÿåœ¨æ­¤æ™‚æ’­æ”¾è‹±æ–‡èªéŸ³
        if (this.settings.delaySpeechInNormalMode) {
          setTimeout(function() {
            self.speakWord(currentWord.english);
          }, 500);
        }
      }
    }
    
    englishElement.style.color = '#666666';
    chineseElement.style.color = '#666666';
    
    var sections = document.querySelectorAll('.card-section');
    for (var i = 0; i < sections.length; i++) {
      sections[i].classList.add('clicked');
      (function(section) {
        setTimeout(function() { 
          section.classList.remove('clicked'); 
        }, 500);
      })(sections[i]);
    }
    
    this.pendingRemoval = {
      word: currentWord,
      index: this.currentIndex,
      originalEnglishColor: englishElement.style.color,
      originalChineseColor: chineseElement.style.color
    };
    
    this.showRestoreButton();
    this.updateButtonStates();
    
    var self = this;
    this.displayTimer = setTimeout(function() {
      self.confirmRemoval();
    }, this.settings.delayTime * 1000);
  };
  
  // ç¢ºèªç§»é™¤å–®å­—
  FlashcardApp.prototype.confirmRemoval = function() {
    if (!this.pendingRemoval) return;
    
    var word = this.pendingRemoval.word;
    var index = this.pendingRemoval.index;
    
    this.removedWords.push(word);
    this.currentWords.splice(index, 1);
    
    if (this.currentIndex >= this.currentWords.length) {
      this.currentIndex = 0;
    }
    
    this.pendingRemoval = null;
    this.hideRestoreButton();
    
    if (this.currentWords.length === 0) {
      this.startNewRound();
    } else {
      this.displayCurrentWord();
    }
    
    this.isProcessingClick = false;
    this.updateButtonStates();
  };
  
  // å–æ¶ˆç§»é™¤
  FlashcardApp.prototype.cancelRemoval = function() {
    if (!this.pendingRemoval) return;
    
    var englishElement = document.getElementById('english-word');
    var chineseElement = document.getElementById('chinese-word');
    
    englishElement.style.color = '';
    chineseElement.style.color = '';
    
    this.pendingRemoval = null;
    this.hideRestoreButton();
    
    if (this.displayTimer) {
      clearTimeout(this.displayTimer);
    }
    
    this.isProcessingClick = false;
    this.updateButtonStates();
    
    var self = this;
    if (this.showingChinese) {
      this.displayTimer = setTimeout(function() {
        self.nextWord();
      }, this.settings.delayTime * 1000);
      } else {
      this.displayTimer = setTimeout(function() {
        self.showSecondPartAndScheduleNext();
      }, this.settings.delayTime * 1000);
    }
  };
  
  // é¡¯ç¤ºæ¢å¾©æŒ‰éˆ•
  FlashcardApp.prototype.showRestoreButton = function() {
    var restoreBtnContainer = document.getElementById('restore-btn-container');
    if (restoreBtnContainer) {
      restoreBtnContainer.style.display = 'block';
    }
  };
  
  // éš±è—æ¢å¾©æŒ‰éˆ•
  FlashcardApp.prototype.hideRestoreButton = function() {
    var restoreBtnContainer = document.getElementById('restore-btn-container');
    if (restoreBtnContainer) {
      restoreBtnContainer.style.display = 'none';
    }
  };
  
  // é¡¯ç¤ºç¬¬äºŒéƒ¨åˆ†ä¸¦å®‰æ’ä¸‹ä¸€å€‹
  FlashcardApp.prototype.showSecondPartAndScheduleNext = function() {
    if (this.isPaused || this.showingChinese || !this.currentWords[this.currentIndex]) {
      return;
    }
  
        if (this.displayTimer) {
      clearTimeout(this.displayTimer);
    }
    
    // æ¸…é™¤ä¸­æ–‡å»¶é²é¡¯ç¤ºè¨ˆæ™‚å™¨
    if (this.chineseDelayTimer) {
      clearTimeout(this.chineseDelayTimer);
      this.chineseDelayTimer = null;
    }

    var currentWord = this.currentWords[this.currentIndex];
    var chineseElement = document.getElementById('chinese-word');
    var flashcardDiv = document.getElementById('flashcard');
    
    // è¨­å®šèƒŒæ™¯åœ–ç‰‡ï¼ˆåœ–ç‰‡ä½”æ»¿æ•´å€‹ç•«é¢ï¼‰- ä½¿ç”¨é åŠ è¼‰çš„åœ–ç‰‡
    var hasImage = currentWord.image && currentWord.image !== '';
    if (hasImage) {
      // ç”±æ–¼åœ–ç‰‡å·²ç¶“é åŠ è¼‰ï¼Œå¯ä»¥ç›´æ¥è¨­å®šï¼Œç„¡éœ€ç­‰å¾…
      flashcardDiv.style.backgroundImage = 'url(' + currentWord.image + ')';
      flashcardDiv.classList.add('has-image');
    } else {
      flashcardDiv.style.backgroundImage = '';
      flashcardDiv.classList.remove('has-image');
    }
    
    var self = this;
    var secondText = this.settings.reverseMode ? currentWord.english : currentWord.chinese;
    
    // åœ–ç‰‡å’Œä¸­æ–‡åŒæ™‚é¡¯ç¤ºï¼ˆç§»é™¤å»¶é²ï¼‰
    chineseElement.textContent = secondText;
    chineseElement.classList.add('show');
    this.showingChinese = true;
    
    // è¨­å®šä¸‹ä¸€å€‹å–®å­—çš„è¨ˆæ™‚å™¨
    this.displayTimer = setTimeout(function() {
      self.nextWord();
    }, this.settings.delayTime * 1000);
    
    if (this.settings.reverseMode) {
      // åå‘æ¨¡å¼ï¼šç¬¬äºŒéƒ¨åˆ†é¡¯ç¤ºè‹±æ–‡ï¼Œæ’­æ”¾è‹±æ–‡èªéŸ³
      setTimeout(function() {
        self.speakWord(currentWord.english);
      }, 500);
    } else {
      // æ­£å¸¸æ¨¡å¼ï¼šç¬¬äºŒéƒ¨åˆ†é¡¯ç¤ºä¸­æ–‡ï¼Œæ’­æ”¾ä¸­æ–‡èªéŸ³
      setTimeout(function() {
        self.speakChineseWord(currentWord.chinese);
      }, 500);
      
      // å¦‚æœå•Ÿç”¨äº†å»¶é²ç™¼éŸ³ï¼Œä¹Ÿåœ¨æ­¤æ™‚æ’­æ”¾è‹±æ–‡èªéŸ³
      if (this.settings.delaySpeechInNormalMode) {
        setTimeout(function() {
          self.speakWord(currentWord.english);
        }, 500);
      }
    }
  };
  
  // é åŠ è¼‰åœ–ç‰‡æ–¹æ³•
  FlashcardApp.prototype.preloadImage = function(imageUrl, callback) {
    if (!imageUrl || imageUrl === '') {
      if (callback) callback(false);
      return;
    }
    
    // å¦‚æœå·²ç¶“é åŠ è¼‰éï¼Œç›´æ¥å›èª¿
    if (this.preloadedImages[imageUrl]) {
      if (callback) callback(true);
      return;
    }
    
    var self = this;
    var img = new Image();
    
    img.onload = function() {
      self.preloadedImages[imageUrl] = true;
      if (callback) callback(true);
    };
    
    img.onerror = function() {
      console.warn('åœ–ç‰‡é åŠ è¼‰å¤±æ•—:', imageUrl);
      if (callback) callback(false);
    };
    
    img.src = imageUrl;
    this.currentPreloadingImage = img;
  };
  
  // å¢å¼·æ»‘å¡Šäº¤äº’é«”é©—ï¼ˆES5å…¼å®¹ç‰ˆæœ¬ï¼‰
  FlashcardApp.prototype.enhanceSliderInteraction = function(slider, valueElementId, unit) {
    if (!slider) return;
    
    var self = this;
    unit = unit || '';
    
    // è¨ˆç®—é»æ“Šä½ç½®å°æ‡‰çš„å€¼
    function calculateValueFromClick(event, sliderElement) {
      var rect = sliderElement.getBoundingClientRect();
      var clickX = event.clientX || (event.touches && event.touches[0] ? event.touches[0].clientX : 0);
      var sliderX = clickX - rect.left;
      var sliderWidth = rect.width;
      
      // ç¢ºä¿é»æ“Šä½ç½®åœ¨æ»‘å¡Šç¯„åœå…§
      if (sliderX < 0) sliderX = 0;
      if (sliderX > sliderWidth) sliderX = sliderWidth;
      
      // è¨ˆç®—ç™¾åˆ†æ¯”
      var percentage = sliderX / sliderWidth;
      
      // æ ¹æ“šæ»‘å¡Šçš„minã€maxã€stepè¨ˆç®—å€¼
      var min = parseFloat(sliderElement.min);
      var max = parseFloat(sliderElement.max);
      var step = parseFloat(sliderElement.step) || 1;
      
      var rawValue = min + (max - min) * percentage;
      
      // æ ¹æ“šstepèª¿æ•´å€¼ï¼Œä¿®å¾©æµ®é»æ•¸ç²¾åº¦å•é¡Œ
      var steppedValue = Math.round(rawValue / step) * step;
      
      // ç¢ºä¿å€¼åœ¨ç¯„åœå…§
      if (steppedValue < min) steppedValue = min;
      if (steppedValue > max) steppedValue = max;
      
      // ä¿®å¾©æµ®é»æ•¸ç²¾åº¦å•é¡Œ
      var decimalPlaces = 0;
      if (step.toString().indexOf('.') !== -1) {
        decimalPlaces = step.toString().split('.')[1].length;
      }
      steppedValue = parseFloat(steppedValue.toFixed(decimalPlaces));
      
      return steppedValue;
    }
    
    // æ›´æ–°æ»‘å¡Šå€¼å’Œé¡¯ç¤º
    function updateSliderValue(newValue) {
      slider.value = newValue;
      
      // è§¸ç™¼inputäº‹ä»¶ä»¥æ›´æ–°é¡¯ç¤ºå’Œå…¶ä»–é‚è¼¯
      var inputEvent;
      try {
        inputEvent = new Event('input', { bubbles: true });
      } catch (e) {
        // IE/èˆŠç€è¦½å™¨å…¼å®¹
        inputEvent = document.createEvent('HTMLEvents');
        inputEvent.initEvent('input', true, true);
      }
      slider.dispatchEvent(inputEvent);
      
      // æ‰‹å‹•æ›´æ–°é¡¯ç¤ºå€¼ï¼ˆç¢ºä¿æ ¼å¼æ­£ç¢ºï¼‰
      var valueElement = document.getElementById(valueElementId);
      if (valueElement) {
        // æ ¼å¼åŒ–é¡¯ç¤ºå€¼ï¼Œé¿å…æµ®é»æ•¸ç²¾åº¦å•é¡Œ
        var step = parseFloat(slider.step) || 1;
        var decimalPlaces = 0;
        if (step.toString().indexOf('.') !== -1) {
          decimalPlaces = step.toString().split('.')[1].length;
        }
        var formattedValue = parseFloat(newValue.toFixed(decimalPlaces));
        valueElement.textContent = formattedValue + unit;
      }
    }
    
    // é»æ“Šäº‹ä»¶è™•ç†
    function handleClick(event) {
      // é˜²æ­¢å†’æ³¡
      event.preventDefault();
      event.stopPropagation();
      
      var newValue = calculateValueFromClick(event, slider);
      updateSliderValue(newValue);
    }
    
    // è§¸æ‘¸äº‹ä»¶è™•ç†
    function handleTouchStart(event) {
      event.preventDefault();
      var newValue = calculateValueFromClick(event, slider);
      updateSliderValue(newValue);
    }
    
    // æ·»åŠ äº‹ä»¶ç›£è½å™¨
    slider.addEventListener('click', handleClick);
    slider.addEventListener('touchstart', handleTouchStart);
    
    console.log('å·²å¢å¼·æ»‘å¡Šäº¤äº’é«”é©—:', slider.id);
  };
  
  // æª¢æ¸¬æ—¥æ–‡å­—ç¬¦
  FlashcardApp.prototype.isJapaneseText = function(text) {
    if (!text) return false;
    
    // æ—¥æ–‡å­—ç¬¦ç¯„åœï¼š
    // å¹³å‡å: \u3040-\u309f
    // ç‰‡å‡å: \u30a0-\u30ff
    // æ¼¢å­—: \u4e00-\u9faf
    // å…¨è§’æ¨™é»: \u3000-\u303f
    var japanesePattern = /[\u3040-\u309f\u30a0-\u30ff\u4e00-\u9faf\u3000-\u303f]/;
    
    return japanesePattern.test(text);
  };

  // é€å­—æ¯æ‹¼è®€è‹±æ–‡å–®å­—
  FlashcardApp.prototype.speakEnglishLetters = function(text, callback) {
    if (!this.voiceSettings.enabled || !this.voiceSettings.spellOutLetters) {
      if (callback) callback();
      return;
    }
    if (!text) {
      if (callback) callback();
      return;
    }
    
    // èˆŠç‰ˆç€è¦½å™¨æª¢æŸ¥ç”¨æˆ¶äº¤äº’ç‹€æ…‹
    if (this.isLegacyBrowser && !this.speechActivated) {
      console.log('èˆŠç‰ˆç€è¦½å™¨ï¼šèªéŸ³æœªå•Ÿç”¨ï¼Œè·³éå­—æ¯æ‹¼è®€');
      if (callback) callback();
      return;
    }
    
    try {
      // æå–ç´”è‹±æ–‡å­—æ¯
      var letters = [];
      for (var i = 0; i < text.length; i++) {
        var char = text.charAt(i);
        if (/[a-zA-Z]/.test(char)) {
          letters.push(char.toLowerCase());
        }
      }
      
      if (letters.length === 0) {
        if (callback) callback();
        return;
      }
      
      console.log('æ‹¼è®€å­—æ¯:', letters.join('-'));
      
      var self = this;
      var currentLetterIndex = 0;
      
      // éè¿´å‡½æ•¸ï¼šé€å€‹å”¸å­—æ¯
      var speakNextLetter = function() {
        if (currentLetterIndex >= letters.length) {
          // æ‰€æœ‰å­—æ¯éƒ½å”¸å®Œäº†ï¼ŒåŸ·è¡Œå›èª¿
          if (callback) {
            setTimeout(callback, 100); // å­—æ¯æ‹¼è®€å’Œå–®å­—ç™¼éŸ³ä¹‹é–“ç•™ä¸€é»é–“éš”
          }
          return;
        }
        
        var letter = letters[currentLetterIndex];
        var utterance = new SpeechSynthesisUtterance(letter);
        utterance.rate = 1; // è‹±æ–‡å­—æ¯ç°¡å–®æ˜“æ‡‚ï¼Œå›ºå®šä½¿ç”¨æ­£å¸¸é€Ÿåº¦
        utterance.pitch = self.voiceSettings.pitch;
        utterance.volume = self.voiceSettings.volume;
        utterance.lang = self.voiceSettings.lang;
        
        // é¸æ“‡èªéŸ³
        var voices = self.speechSynthesis.getVoices();
        var selectedVoice = null;
        if (self.voiceSettings.voiceURI) {
          for (var i = 0; i < voices.length; i++) {
            if (voices[i].voiceURI === self.voiceSettings.voiceURI) {
              selectedVoice = voices[i];
              break;
            }
          }
        }
        
        if (!selectedVoice) {
          for (var i = 0; i < voices.length; i++) {
            if (voices[i].lang.indexOf('en-') === 0) {
              selectedVoice = voices[i];
              break;
            }
          }
        }
        
        if (selectedVoice) {
          utterance.voice = selectedVoice;
        }
        
        // ç•¶é€™å€‹å­—æ¯å”¸å®Œå¾Œï¼Œç¹¼çºŒä¸‹ä¸€å€‹
        utterance.onend = function() {
          currentLetterIndex++;
          setTimeout(speakNextLetter, 10); // å­—æ¯ä¹‹é–“é–“éš”10ms
        };
        
        utterance.onerror = function(event) {
          console.log('å­—æ¯æ‹¼è®€éŒ¯èª¤:', event.error);
          currentLetterIndex++;
          setTimeout(speakNextLetter, 10);
        };
        
        self.speechSynthesis.speak(utterance);
      };
      
      speakNextLetter();
      
    } catch (error) {
      console.log('å­—æ¯æ‹¼è®€å¤±æ•—:', error);
      if (callback) callback();
    }
  };

  // èªéŸ³æ’­æ”¾ï¼ˆè‹±æ–‡å–®å­—ï¼‰
  FlashcardApp.prototype.speakEnglishWord = function(text) {
    if (!this.voiceSettings.enabled) return;
    if (!text) return;
    
    // èˆŠç‰ˆç€è¦½å™¨æª¢æŸ¥ç”¨æˆ¶äº¤äº’ç‹€æ…‹
    if (this.isLegacyBrowser && !this.speechActivated) {
      console.log('èˆŠç‰ˆç€è¦½å™¨ï¼šèªéŸ³æœªå•Ÿç”¨ï¼Œè·³éæ’­æ”¾');
      return;
    }
    
    var self = this;
    
    // å¦‚æœå•Ÿç”¨äº†å­—æ¯æ‹¼è®€ï¼Œå…ˆæ‹¼è®€å­—æ¯ï¼Œç„¶å¾Œå†å”¸å–®å­—
    if (this.voiceSettings.spellOutLetters) {
      this.speakEnglishLetters(text, function() {
        // å­—æ¯æ‹¼è®€å®Œæˆå¾Œï¼Œå”¸å®Œæ•´å–®å­—
        self.speakEnglishWordOnly(text);
      });
    } else {
      // ç›´æ¥å”¸å–®å­—
      this.speakEnglishWordOnly(text);
    }
  };

  // åªå”¸è‹±æ–‡å–®å­—ï¼ˆä¸æ‹¼è®€å­—æ¯ï¼‰
  FlashcardApp.prototype.speakEnglishWordOnly = function(text) {
    if (!this.voiceSettings.enabled) return;
    if (!text) return;
    
    try {
      console.log('æ’­æ”¾è‹±æ–‡èªéŸ³:', text);
      
      var utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = this.voiceSettings.rate;
      utterance.pitch = this.voiceSettings.pitch;
      utterance.volume = this.voiceSettings.volume;
      utterance.lang = this.voiceSettings.lang;
      
      var voices = this.speechSynthesis.getVoices();
      var selectedVoice = null;
      if (this.voiceSettings.voiceURI) {
        for (var i = 0; i < voices.length; i++) {
          if (voices[i].voiceURI === this.voiceSettings.voiceURI) {
            selectedVoice = voices[i];
            break;
          }
        }
      }
      
      if (!selectedVoice) {
        for (var i = 0; i < voices.length; i++) {
          if (voices[i].lang.indexOf('en-') === 0 || 
              voices[i].name.toLowerCase().indexOf('english') !== -1) {
            selectedVoice = voices[i];
            break;
          }
        }
      }
      
      if (selectedVoice) {
        utterance.voice = selectedVoice;
      }
      
      // ç‚ºèˆŠç‰ˆç€è¦½å™¨æ·»åŠ éŒ¯èª¤è™•ç†
      utterance.onerror = function(event) {
        console.log('è‹±æ–‡èªéŸ³æ’­æ”¾éŒ¯èª¤:', event.error);
      };
      
      utterance.onstart = function() {
        console.log('è‹±æ–‡èªéŸ³é–‹å§‹æ’­æ”¾:', text);
      };
      
      this.speechSynthesis.speak(utterance);
    } catch (error) {
      console.log('è‹±æ–‡èªéŸ³æ’­æ”¾å¤±æ•—:', error);
    }
  };
  
  // æ—¥æ–‡èªéŸ³æ’­æ”¾
  FlashcardApp.prototype.speakJapaneseWord = function(text) {
    if (!this.voiceSettings.enabled) return;
    if (!text) return;
    
    // èˆŠç‰ˆç€è¦½å™¨æª¢æŸ¥ç”¨æˆ¶äº¤äº’ç‹€æ…‹
    if (this.isLegacyBrowser && !this.speechActivated) {
      console.log('èˆŠç‰ˆç€è¦½å™¨ï¼šèªéŸ³æœªå•Ÿç”¨ï¼Œè·³éæ’­æ”¾');
      return;
    }
    
    try {
      console.log('æ’­æ”¾æ—¥æ–‡èªéŸ³:', text);
      this.speechSynthesis.cancel();
      
      var utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = this.voiceSettings.rate;
      utterance.pitch = this.voiceSettings.pitch;
      utterance.volume = this.voiceSettings.volume;
      utterance.lang = this.voiceSettings.japaneseLang;
      
      var voices = this.speechSynthesis.getVoices();
      var selectedVoice = null;
      if (this.voiceSettings.japaneseVoiceURI) {
        for (var i = 0; i < voices.length; i++) {
          if (voices[i].voiceURI === this.voiceSettings.japaneseVoiceURI) {
            selectedVoice = voices[i];
            break;
          }
        }
      }
      
      if (!selectedVoice) {
        for (var i = 0; i < voices.length; i++) {
          if (voices[i].lang.indexOf('ja-') === 0 || 
              voices[i].name.toLowerCase().indexOf('japanese') !== -1) {
            selectedVoice = voices[i];
            break;
          }
        }
      }
      
      if (selectedVoice) {
        utterance.voice = selectedVoice;
      }
      
      // ç‚ºèˆŠç‰ˆç€è¦½å™¨æ·»åŠ éŒ¯èª¤è™•ç†
      utterance.onerror = function(event) {
        console.log('æ—¥æ–‡èªéŸ³æ’­æ”¾éŒ¯èª¤:', event.error);
      };
      
      utterance.onstart = function() {
        console.log('æ—¥æ–‡èªéŸ³é–‹å§‹æ’­æ”¾:', text);
      };
      
      this.speechSynthesis.speak(utterance);
    } catch (error) {
      console.log('æ—¥æ–‡èªéŸ³æ’­æ”¾å¤±æ•—:', error);
    }
  };
  
  // ä¸­æ–‡èªéŸ³æ’­æ”¾
  FlashcardApp.prototype.speakChineseWord = function(text) {
    if (!this.voiceSettings.chineseEnabled) return;
    if (!text) return;
    
    // èˆŠç‰ˆç€è¦½å™¨æª¢æŸ¥ç”¨æˆ¶äº¤äº’ç‹€æ…‹
    if (this.isLegacyBrowser && !this.speechActivated) {
      console.log('èˆŠç‰ˆç€è¦½å™¨ï¼šèªéŸ³æœªå•Ÿç”¨ï¼Œè·³éæ’­æ”¾');
      return;
    }
    
    var self = this;
    
    // æ¸…ç†ä¹‹å‰çš„ç­‰å¾…å®šæ™‚å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if (this.chineseWaitInterval) {
      clearInterval(this.chineseWaitInterval);
      this.chineseWaitInterval = null;
    }
    
    // å¦‚æœæ­£åœ¨æ’­æ”¾è‹±æ–‡æˆ–æ—¥æ–‡èªéŸ³ï¼ˆåŒ…æ‹¬å­—æ¯æ‹¼è®€ï¼‰ï¼Œç­‰å¾…æ’­æ”¾å®Œæˆ
    if (this.speechSynthesis.speaking) {
      console.log('ç­‰å¾…è‹±æ–‡/æ—¥æ–‡èªéŸ³æ’­æ”¾å®Œæˆå¾Œå†æ’­æ”¾ä¸­æ–‡...');
      
      // ä½¿ç”¨è¼ªè©¢æª¢æŸ¥èªéŸ³æ˜¯å¦æ’­æ”¾å®Œæˆ
      this.chineseWaitInterval = setInterval(function() {
        if (!self.speechSynthesis.speaking) {
          clearInterval(self.chineseWaitInterval);
          self.chineseWaitInterval = null;
          console.log('è‹±æ–‡/æ—¥æ–‡èªéŸ³æ’­æ”¾å®Œæˆï¼Œç¾åœ¨æ’­æ”¾ä¸­æ–‡');
          self.speakChineseWordNow(text);
        }
      }, 100); // æ¯100msæª¢æŸ¥ä¸€æ¬¡
      
      return;
    }
    
    // å¦‚æœæ²’æœ‰èªéŸ³æ­£åœ¨æ’­æ”¾ï¼Œç›´æ¥æ’­æ”¾ä¸­æ–‡
    this.speakChineseWordNow(text);
  };
  
  // ç«‹å³æ’­æ”¾ä¸­æ–‡èªéŸ³ï¼ˆå…§éƒ¨å‡½æ•¸ï¼‰
  FlashcardApp.prototype.speakChineseWordNow = function(text) {
    if (!text) return;
    
    try {
      console.log('æ’­æ”¾ä¸­æ–‡èªéŸ³:', text);
      
      var utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = 1; // ä¸­æ–‡ç‚ºæ¯èªï¼Œå›ºå®šä½¿ç”¨æ­£å¸¸é€Ÿåº¦
      utterance.pitch = this.voiceSettings.pitch;
      utterance.volume = this.voiceSettings.volume;
      utterance.lang = this.voiceSettings.chineseLang;
      
      var voices = this.speechSynthesis.getVoices();
      var selectedVoice = null;
      if (this.voiceSettings.chineseVoiceURI) {
        for (var i = 0; i < voices.length; i++) {
          if (voices[i].voiceURI === this.voiceSettings.chineseVoiceURI) {
            selectedVoice = voices[i];
            break;
          }
        }
      }
      
      if (!selectedVoice) {
        for (var i = 0; i < voices.length; i++) {
          if (voices[i].lang.indexOf('zh-') === 0 || 
              voices[i].name.toLowerCase().indexOf('chinese') !== -1) {
            selectedVoice = voices[i];
            break;
          }
        }
      }
      
      if (selectedVoice) {
        utterance.voice = selectedVoice;
      }
      
      // ç‚ºèˆŠç‰ˆç€è¦½å™¨æ·»åŠ éŒ¯èª¤è™•ç†
      utterance.onerror = function(event) {
        console.log('ä¸­æ–‡èªéŸ³æ’­æ”¾éŒ¯èª¤:', event.error);
      };
      
      utterance.onstart = function() {
        console.log('ä¸­æ–‡èªéŸ³é–‹å§‹æ’­æ”¾:', text);
      };
      
      this.speechSynthesis.speak(utterance);
    } catch (error) {
      console.log('ä¸­æ–‡èªéŸ³æ’­æ”¾å¤±æ•—:', error);
    }
  };
  
  // æ™ºèƒ½èªéŸ³æ’­æ”¾ï¼ˆè‡ªå‹•æª¢æ¸¬èªè¨€ - åƒ…ç”¨æ–¼è‹±æ–‡/æ—¥æ–‡å–®å­—ï¼‰
  FlashcardApp.prototype.speakWord = function(text) {
    if (!text) return;
    
    if (this.isJapaneseText(text)) {
      // æ–‡æœ¬åŒ…å«æ—¥æ–‡å­—ç¬¦ï¼Œä½¿ç”¨æ—¥æ–‡èªéŸ³
      this.speakJapaneseWord(text);
    } else {
      // æ–‡æœ¬ç‚ºè‹±æ–‡ï¼Œä½¿ç”¨è‹±æ–‡èªéŸ³ï¼ˆå¯èƒ½åŒ…å«å­—æ¯æ‹¼è®€ï¼‰
      this.speakEnglishWord(text);
    }
  };
  
  // ä¸‹ä¸€å€‹å–®å­—
  FlashcardApp.prototype.nextWord = function() {
    if (this.isTransitioning || this.isPaused) return;
    
    if (this.pendingRemoval) {
      this.confirmRemoval();
        return;
      }
      
    if (!this.showingChinese) {
      this.showSecondPartAndScheduleNext();
        return;
      }
      
    this.saveNavigationState();
    
      if (this.displayTimer) {
        clearTimeout(this.displayTimer);
    }
    
    // æ¸…ç†ä¸­æ–‡èªéŸ³ç­‰å¾…å®šæ™‚å™¨
    if (this.chineseWaitInterval) {
      clearInterval(this.chineseWaitInterval);
      this.chineseWaitInterval = null;
    }
    
    this.speechSynthesis.cancel();
    
    this.isTransitioning = true;
    
    var englishElement = document.getElementById('english-word');
    var chineseElement = document.getElementById('chinese-word');
    
    englishElement.classList.remove('show');
    chineseElement.classList.remove('show');
    
    chineseElement.textContent = '';
    // æ¸…é™¤èƒŒæ™¯åœ–ç‰‡
    var flashcardDiv = document.getElementById('flashcard');
    if (flashcardDiv) {
      flashcardDiv.style.backgroundImage = '';
      flashcardDiv.classList.remove('has-image');
    }
    
    var self = this;
    setTimeout(function() {
      self.currentIndex = (self.currentIndex + 1) % self.currentWords.length;
      
      if (self.currentIndex === 0) {
        self.shuffleArray(self.currentWords);
        self.navigationHistory = [];
      }
      
      self.displayCurrentWord();
      self.isTransitioning = false;
      
    }, 300);
    this.renderDifficultStar();
  };
  
  // ä¸Šä¸€å€‹å–®å­—
  FlashcardApp.prototype.previousWord = function() {
    if (this.isTransitioning || this.isPaused) return;
    
    if (this.pendingRemoval) {
      this.cancelRemoval();
      return;
    }
    
    if (this.navigationHistory.length === 0) return;
    
    if (this.displayTimer) {
      clearTimeout(this.displayTimer);
    }
    
    // æ¸…ç†ä¸­æ–‡èªéŸ³ç­‰å¾…å®šæ™‚å™¨
    if (this.chineseWaitInterval) {
      clearInterval(this.chineseWaitInterval);
      this.chineseWaitInterval = null;
    }
    
    this.speechSynthesis.cancel();
    
    this.isTransitioning = true;
    
    var englishElement = document.getElementById('english-word');
    var chineseElement = document.getElementById('chinese-word');
    
    englishElement.classList.remove('show');
    chineseElement.classList.remove('show');
    
    chineseElement.textContent = '';
    // æ¸…é™¤èƒŒæ™¯åœ–ç‰‡
    var flashcardDiv = document.getElementById('flashcard');
    if (flashcardDiv) {
      flashcardDiv.style.backgroundImage = '';
      flashcardDiv.classList.remove('has-image');
    }
    
    var self = this;
    setTimeout(function() {
      var previousState = self.navigationHistory.pop();
      
      var previousWord = previousState.wordSequence[previousState.currentIndex];
      
      var wordIndex = -1;
      for (var i = 0; i < self.currentWords.length; i++) {
        if (self.currentWords[i].english === previousWord.english && 
            self.currentWords[i].chinese === previousWord.chinese) {
          wordIndex = i;
          break;
        }
      }
      
      if (wordIndex !== -1) {
        self.currentIndex = wordIndex;
      } else {
        self.currentIndex = Math.min(previousState.currentIndex, self.currentWords.length - 1);
        
        if (self.currentWords.length === 0) {
          self.startNewRound();
          self.isTransitioning = false;
        return;
        }
      }
      
      self.displayCurrentWord();
      self.isTransitioning = false;
      
    }, 300);
    this.renderDifficultStar();
  };
  
  // å„²å­˜å°èˆªç‹€æ…‹
  FlashcardApp.prototype.saveNavigationState = function() {
    if (this.currentWords.length > 0 && this.currentIndex >= 0) {
      this.navigationHistory.push({
        currentIndex: this.currentIndex,
        wordSequence: this.currentWords.slice()
      });
      
      if (this.navigationHistory.length > 20) {
        this.navigationHistory.shift();
      }
    }
  };
  
  // ç¢ºèªé‡æ–°è¼‰å…¥å–®å­—
  FlashcardApp.prototype.confirmRestart = function() {
    var confirmed = confirm('ç¢ºå®šè¦é‡æ–°è¼‰å…¥å–®å­—å—ï¼Ÿ\n\nâš ï¸ æ³¨æ„ï¼šé‡æ–°è¼‰å…¥æœƒæ¢å¾©æ‰€æœ‰æš«æ™‚åˆªé™¤çš„å–®å­—ã€‚');
    if (confirmed) {
      this.restart();
    }
  };

  // é‡æ–°è¼‰å…¥å–®å­—
  FlashcardApp.prototype.restart = function() {
    if (this.displayTimer) {
      clearTimeout(this.displayTimer);
    }
    
    // æ¸…ç†ä¸­æ–‡èªéŸ³ç­‰å¾…å®šæ™‚å™¨
    if (this.chineseWaitInterval) {
      clearInterval(this.chineseWaitInterval);
      this.chineseWaitInterval = null;
    }
    
    this.speechSynthesis.cancel();
    this.pendingRemoval = null;
    this.closeMenu();
    
    // æª¢æŸ¥æ˜¯å¦æœ‰è¨­å®šçš„ Google Sheet
    if (this.sheetSettings.sheetId && this.sheetSettings.selectedSheets.length > 0) {
      console.log('é‡æ–°è¼‰å…¥å–®å­—ï¼Œä½¿ç”¨å·²è¨­å®šçš„ Google Sheet');
        
        // é¡¯ç¤ºè¼‰å…¥ä¸­è¨Šæ¯
      var loadingDiv = document.getElementById('loading');
      var flashcardDiv = document.getElementById('flashcard');
      if (loadingDiv) loadingDiv.style.display = 'flex';
      if (flashcardDiv) flashcardDiv.style.display = 'none';
      
      var self = this;
      this.loadWords(true, function(hasDuplicates) {
        self.hideLoading();
        self.applySettings();
        
          if (!hasDuplicates) {
          self.startNewRound();
        }
      });
    } else {
      console.log('æ²’æœ‰ Google Sheet è¨­å®šï¼Œç›´æ¥é‡æ–°é–‹å§‹');
            this.startNewRound();
          }
  };
  
  // åˆ‡æ›èªéŸ³æ’­æ”¾
  FlashcardApp.prototype.toggleVoice = function() {
    this.voiceSettings.enabled = !this.voiceSettings.enabled;
    this.saveSettings();
    this.updateVoiceButtonState();
    
    // åœæ­¢ç•¶å‰æ’­æ”¾çš„èªéŸ³
    if (!this.voiceSettings.enabled) {
      // æ¸…ç†ä¸­æ–‡èªéŸ³ç­‰å¾…å®šæ™‚å™¨
      if (this.chineseWaitInterval) {
        clearInterval(this.chineseWaitInterval);
        this.chineseWaitInterval = null;
      }
      
      this.speechSynthesis.cancel();
    }
  };
  
  // æ›´æ–°èªéŸ³æŒ‰éˆ•ç‹€æ…‹
  FlashcardApp.prototype.updateVoiceButtonState = function() {
    var voiceBtn = document.getElementById('voice-toggle-btn');
    if (voiceBtn) {
      if (this.voiceSettings.enabled) {
        voiceBtn.textContent = 'ğŸ”Š';
        voiceBtn.title = 'èªéŸ³æ’­æ”¾ï¼šé–‹å•Ÿï¼ˆé»æ“Šé—œé–‰ï¼‰';
        voiceBtn.style.opacity = '1';
      } else {
        voiceBtn.textContent = 'ğŸ”‡';
        voiceBtn.title = 'èªéŸ³æ’­æ”¾ï¼šé—œé–‰ï¼ˆé»æ“Šé–‹å•Ÿï¼‰';
        voiceBtn.style.opacity = '0.6';
      }
    }
    
    // æ›´æ–°éœéŸ³æŒ‡ç¤ºå™¨çš„é¡¯ç¤ºç‹€æ…‹
    this.updateMutedIndicator();
  };
  
  // æ›´æ–°éœéŸ³æŒ‡ç¤ºå™¨çš„é¡¯ç¤ºç‹€æ…‹
  FlashcardApp.prototype.updateMutedIndicator = function() {
    var mutedIndicator = document.getElementById('muted-indicator');
    if (mutedIndicator) {
      if (!this.voiceSettings.enabled) {
        // èªéŸ³é—œé–‰æ™‚é¡¯ç¤ºéœéŸ³æŒ‡ç¤ºå™¨
        mutedIndicator.style.display = 'flex';
      } else {
        // èªéŸ³é–‹å•Ÿæ™‚éš±è—éœéŸ³æŒ‡ç¤ºå™¨
        mutedIndicator.style.display = 'none';
      }
    }
  };
  
  // åˆ‡æ›æš«åœ/æ¢å¾©
  FlashcardApp.prototype.togglePause = function() {
    if (this.userPaused) {
      // ç”¨æˆ¶æ‰‹å‹•æ¢å¾©
      this.userPaused = false;
      this.resumeTimer();
    } else {
      // ç”¨æˆ¶æ‰‹å‹•æš«åœ
      this.userPaused = true;
      this.pauseTimer();
    }
    this.updatePauseButtonState();
  };
  
  // é€²å…¥å…¨è¢å¹•æ¨¡å¼
  FlashcardApp.prototype.enterFullscreen = function() {
    console.log('å˜—è©¦é€²å…¥å…¨è¢å¹•æ¨¡å¼');
    
    var docElement = document.documentElement;
    
    try {
      // å˜—è©¦æ¨™æº– API
      if (docElement.requestFullscreen) {
        docElement.requestFullscreen();
      }
      // å˜—è©¦ webkit å‰ç¶´ (Safari, Chrome)
      else if (docElement.webkitRequestFullscreen) {
        docElement.webkitRequestFullscreen();
      }
      // å˜—è©¦ webkit å‰ç¶´ (èˆŠç‰ˆ Safari)
      else if (docElement.webkitRequestFullScreen) {
        docElement.webkitRequestFullScreen();
      }
      // å˜—è©¦ moz å‰ç¶´ (Firefox)
      else if (docElement.mozRequestFullScreen) {
        docElement.mozRequestFullScreen();
      }
      // å˜—è©¦ ms å‰ç¶´ (IE/Edge)
      else if (docElement.msRequestFullscreen) {
        docElement.msRequestFullscreen();
      }
      else {
        console.log('æ­¤ç€è¦½å™¨ä¸æ”¯æ´å…¨è¢å¹• API');
        alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´å…¨è¢å¹•åŠŸèƒ½');
        return;
      }
      
      console.log('å…¨è¢å¹•è«‹æ±‚å·²ç™¼é€');
      
      // æ·»åŠ å…¨è¢å¹•ç‹€æ…‹ç›£è½
      var self = this;
      var fullscreenChangeHandler = function() {
        var isFullscreen = document.fullscreenElement || 
                          document.webkitFullscreenElement || 
                          document.mozFullScreenElement || 
                          document.msFullscreenElement;
        
        if (isFullscreen) {
          console.log('å·²é€²å…¥å…¨è¢å¹•æ¨¡å¼');
        } else {
          console.log('å·²é€€å‡ºå…¨è¢å¹•æ¨¡å¼');
        }
        
        // æ›´æ–°æŒ‰éˆ•æ–‡å­—
        self.updateFullscreenButtonText();
      };
      
      // ç§»é™¤èˆŠçš„ç›£è½å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      document.removeEventListener('fullscreenchange', fullscreenChangeHandler);
      document.removeEventListener('webkitfullscreenchange', fullscreenChangeHandler);
      document.removeEventListener('mozfullscreenchange', fullscreenChangeHandler);
      document.removeEventListener('MSFullscreenChange', fullscreenChangeHandler);
      
      // æ·»åŠ æ–°çš„ç›£è½å™¨
      document.addEventListener('fullscreenchange', fullscreenChangeHandler);
      document.addEventListener('webkitfullscreenchange', fullscreenChangeHandler);
      document.addEventListener('mozfullscreenchange', fullscreenChangeHandler);
      document.addEventListener('MSFullscreenChange', fullscreenChangeHandler);
      
    } catch (error) {
      console.error('é€²å…¥å…¨è¢å¹•æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
      alert('ç„¡æ³•é€²å…¥å…¨è¢å¹•æ¨¡å¼ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®š');
    }
  };
  
  // é€€å‡ºå…¨è¢å¹•æ¨¡å¼
  FlashcardApp.prototype.exitFullscreen = function() {
    console.log('å˜—è©¦é€€å‡ºå…¨è¢å¹•æ¨¡å¼');
    
    try {
      // å˜—è©¦æ¨™æº– API
      if (document.exitFullscreen) {
        document.exitFullscreen();
      }
      // å˜—è©¦ webkit å‰ç¶´ (Safari, Chrome)
      else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      }
      // å˜—è©¦ webkit å‰ç¶´ (èˆŠç‰ˆ Safari)
      else if (document.webkitCancelFullScreen) {
        document.webkitCancelFullScreen();
      }
      // å˜—è©¦ moz å‰ç¶´ (Firefox)
      else if (document.mozCancelFullScreen) {
        document.mozCancelFullScreen();
      }
      // å˜—è©¦ ms å‰ç¶´ (IE/Edge)
      else if (document.msExitFullscreen) {
        document.msExitFullscreen();
      }
      else {
        console.log('æ­¤ç€è¦½å™¨ä¸æ”¯æ´é€€å‡ºå…¨è¢å¹• API');
      }
      
      console.log('é€€å‡ºå…¨è¢å¹•è«‹æ±‚å·²ç™¼é€');
      
    } catch (error) {
      console.error('é€€å‡ºå…¨è¢å¹•æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
    }
  };
  
  // æª¢æŸ¥æ˜¯å¦ç‚ºå…¨è¢å¹•ç‹€æ…‹
  FlashcardApp.prototype.isFullscreen = function() {
    return !!(document.fullscreenElement || 
             document.webkitFullscreenElement || 
             document.mozFullScreenElement || 
             document.msFullscreenElement);
  };
  
  // åˆ‡æ›å…¨è¢å¹•ç‹€æ…‹
  FlashcardApp.prototype.toggleFullscreen = function() {
    if (this.isFullscreen()) {
      this.exitFullscreen();
    } else {
      this.enterFullscreen();
    }
  };
  
  // æ›´æ–°å…¨è¢å¹•æŒ‰éˆ•æ–‡å­—
  FlashcardApp.prototype.updateFullscreenButtonText = function() {
    var fullscreenBtn = document.getElementById('fullscreen-btn');
    if (fullscreenBtn) {
      if (this.isFullscreen()) {
        fullscreenBtn.textContent = 'é€€å‡ºå…¨è¢å¹•';
      } else {
        fullscreenBtn.textContent = 'å…¨è¢å¹•';
      }
    }
  };
  
  // æ›´æ–°æš«åœæŒ‰éˆ•ç‹€æ…‹
  FlashcardApp.prototype.updatePauseButtonState = function() {
    var pauseBtn = document.getElementById('pause-btn');
    var controlsWrapper = document.getElementById('controls-wrapper');
    var pausedIndicator = document.getElementById('paused-indicator');
    
    if (pauseBtn) {
      if (this.userPaused) {
        pauseBtn.textContent = 'â–¶ï¸';
        pauseBtn.title = 'ç›®å‰æš«åœä¸­ï¼ˆé»æ“Šæ¢å¾©ï¼‰';
        pauseBtn.style.opacity = '0.6';
        
        // é¡¯ç¤ºã€Œå·²æš«åœã€æŒ‡ç¤ºå™¨
        if (pausedIndicator) {
          pausedIndicator.style.display = 'flex';
          pausedIndicator.title = 'é»æ“Šæ­¤è™•æ¢å¾©æ’­æ”¾';
        }
      } else {
        pauseBtn.textContent = 'â¸ï¸';
        pauseBtn.title = 'ç›®å‰é‹è¡Œä¸­ï¼ˆé»æ“Šæš«åœï¼‰';
        pauseBtn.style.opacity = '1';
        
        // éš±è—ã€Œå·²æš«åœã€æŒ‡ç¤ºå™¨
        if (pausedIndicator) {
          pausedIndicator.style.display = 'none';
          pausedIndicator.title = '';
        }
      }
    }
  };

  // é‡æ–°é¡¯ç¤ºç•¶å‰å–®å­—
  FlashcardApp.prototype.redisplayCurrentWord = function() {
    if (this.displayTimer) {
      clearTimeout(this.displayTimer);
      this.displayTimer = null;
    }
    
    // æ¸…ç†ä¸­æ–‡èªéŸ³ç­‰å¾…å®šæ™‚å™¨
    if (this.chineseWaitInterval) {
      clearInterval(this.chineseWaitInterval);
      this.chineseWaitInterval = null;
    }
    
    this.speechSynthesis.cancel();
    
    this.showingChinese = false;
    this.isTransitioning = false;
    this.isProcessingClick = false;
    this.pendingRemoval = null;
    this.hideRestoreButton();
    
    this.displayCurrentWord();
  };
  
  // èªéŸ³è¨­å®šç›¸é—œ
  FlashcardApp.prototype.openVoiceSettings = function() {
    var modal = document.getElementById('voice-settings-modal');
    if (modal) {
      modal.style.display = 'flex';
      this.pauseTimer();
      
      var speechEnabledSetting = document.getElementById('speech-enabled-setting');
      var voiceRateSetting = document.getElementById('voice-rate-setting');
      var voiceRateValue = document.getElementById('voice-rate-value');
      var spellOutLettersSetting = document.getElementById('spell-out-letters-setting');
      var chineseSpeechEnabledSetting = document.getElementById('chinese-speech-enabled-setting');
      
      if (speechEnabledSetting) speechEnabledSetting.checked = this.voiceSettings.enabled;
      if (voiceRateSetting) voiceRateSetting.value = this.voiceSettings.rate;
      if (voiceRateValue) {
        // ä¿®å¾©æµ®é»æ•¸ç²¾åº¦å•é¡Œ
        var step = parseFloat(voiceRateSetting.step) || 0.1;
        var decimalPlaces = step.toString().indexOf('.') !== -1 ? step.toString().split('.')[1].length : 0;
        var formattedRate = parseFloat(this.voiceSettings.rate.toFixed(decimalPlaces));
        voiceRateValue.textContent = formattedRate;
      }
      if (spellOutLettersSetting) spellOutLettersSetting.checked = this.voiceSettings.spellOutLetters || false;
      if (chineseSpeechEnabledSetting) chineseSpeechEnabledSetting.checked = this.voiceSettings.chineseEnabled || false;
      
      var delaySpeechToggle = document.getElementById('delay-speech-setting');
      if (delaySpeechToggle) delaySpeechToggle.checked = this.settings.delaySpeechInNormalMode;
      
      this.populateVoiceSelect();
    }
  };
  
  FlashcardApp.prototype.closeVoiceSettings = function() {
    var modal = document.getElementById('voice-settings-modal');
    if (modal) {
      modal.style.display = 'none';
      this.resumeTimer();
    }
  };
  
  // é è¦½èªéŸ³ - æ’­æ”¾ç¤ºä¾‹æ–‡å­—
  FlashcardApp.prototype.previewVoice = function(voiceURI, sampleText) {
    try {
      // æª¢æŸ¥èªéŸ³åˆæˆAPIæ˜¯å¦å¯ç”¨
      if (!this.speechSynthesis) {
        console.warn('èªéŸ³åˆæˆAPIä¸å¯ç”¨');
        return;
      }
      
      // æ¸…ç†ä¸­æ–‡èªéŸ³ç­‰å¾…å®šæ™‚å™¨
      if (this.chineseWaitInterval) {
        clearInterval(this.chineseWaitInterval);
        this.chineseWaitInterval = null;
      }
      
      // åœæ­¢ç•¶å‰æ­£åœ¨æ’­æ”¾çš„èªéŸ³
      this.speechSynthesis.cancel();
      
      // ç²å–ç•¶å‰è¨­å®šçš„èªéŸ³é€Ÿåº¦
      var voiceRateSetting = document.getElementById('voice-rate-setting');
      var rate = voiceRateSetting ? parseFloat(voiceRateSetting.value) : this.voiceSettings.rate;
      
      console.log('é è¦½èªéŸ³:', voiceURI, 'ç¤ºä¾‹æ–‡å­—:', sampleText, 'é€Ÿåº¦:', rate);
      
      // å‰µå»ºèªéŸ³utterance
      var utterance = new SpeechSynthesisUtterance(sampleText);
      utterance.rate = rate;
      utterance.pitch = this.voiceSettings.pitch || 1;
      utterance.volume = this.voiceSettings.volume || 1;
      
      // å°‹æ‰¾æŒ‡å®šçš„èªéŸ³
      var voices = this.speechSynthesis.getVoices();
      var selectedVoice = null;
      
      for (var i = 0; i < voices.length; i++) {
        if (voices[i].voiceURI === voiceURI) {
          selectedVoice = voices[i];
          break;
        }
      }
      
      if (selectedVoice) {
        utterance.voice = selectedVoice;
        utterance.lang = selectedVoice.lang;
        console.log('ä½¿ç”¨èªéŸ³:', selectedVoice.name, 'èªè¨€:', selectedVoice.lang);
      } else {
        console.warn('æ‰¾ä¸åˆ°æŒ‡å®šçš„èªéŸ³:', voiceURI);
      }
      
      // æ’­æ”¾èªéŸ³
      this.speechSynthesis.speak(utterance);
      
      // æ·»åŠ éŒ¯èª¤è™•ç†
      utterance.onerror = function(event) {
        console.error('èªéŸ³æ’­æ”¾éŒ¯èª¤:', event.error);
      };
      
    } catch (error) {
      console.error('é è¦½èªéŸ³æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
    }
  };
  
  FlashcardApp.prototype.saveVoiceSettingsAndClose = function() {
    var speechEnabledSetting = document.getElementById('speech-enabled-setting');
    var voiceRateSetting = document.getElementById('voice-rate-setting');
    var voiceSelectSetting = document.getElementById('voice-select-setting');
    var japaneseVoiceSelectSetting = document.getElementById('japanese-voice-select-setting');
    var spellOutLettersSetting = document.getElementById('spell-out-letters-setting');
    var chineseSpeechEnabledSetting = document.getElementById('chinese-speech-enabled-setting');
    var chineseVoiceSelectSetting = document.getElementById('chinese-voice-select-setting');
    
    if (speechEnabledSetting) this.voiceSettings.enabled = speechEnabledSetting.checked;
    if (voiceRateSetting) this.voiceSettings.rate = parseFloat(voiceRateSetting.value);
    if (spellOutLettersSetting) this.voiceSettings.spellOutLetters = spellOutLettersSetting.checked;
    if (chineseSpeechEnabledSetting) this.voiceSettings.chineseEnabled = chineseSpeechEnabledSetting.checked;
    
    if (voiceSelectSetting) {
      var selectedVoiceURI = voiceSelectSetting.value;
      this.voiceSettings.voiceURI = selectedVoiceURI;
      var voices = this.speechSynthesis.getVoices();
      for (var i = 0; i < voices.length; i++) {
        if (voices[i].voiceURI === selectedVoiceURI) {
          this.voiceSettings.lang = voices[i].lang;
          break;
        }
      }
    }
    
    if (japaneseVoiceSelectSetting) {
      var selectedJapaneseVoiceURI = japaneseVoiceSelectSetting.value;
      this.voiceSettings.japaneseVoiceURI = selectedJapaneseVoiceURI;
      var voices = this.speechSynthesis.getVoices();
      for (var i = 0; i < voices.length; i++) {
        if (voices[i].voiceURI === selectedJapaneseVoiceURI) {
          this.voiceSettings.japaneseLang = voices[i].lang;
          break;
        }
      }
    }
    
    if (chineseVoiceSelectSetting) {
      var selectedChineseVoiceURI = chineseVoiceSelectSetting.value;
      this.voiceSettings.chineseVoiceURI = selectedChineseVoiceURI;
      var voices = this.speechSynthesis.getVoices();
      for (var i = 0; i < voices.length; i++) {
        if (voices[i].voiceURI === selectedChineseVoiceURI) {
          this.voiceSettings.chineseLang = voices[i].lang;
          break;
        }
      }
    }
    
    this.saveSettings();
    this.updateVoiceButtonState();
    this.closeVoiceSettings();
  };
  
  FlashcardApp.prototype.populateVoiceSelect = function() {
    var voiceSelect = document.getElementById('voice-select-setting');
    var japaneseVoiceSelect = document.getElementById('japanese-voice-select-setting');
    var voices = this.speechSynthesis.getVoices();
    var self = this;
    
    // å¡«å……è‹±æ–‡èªéŸ³é¸é …
    if (voiceSelect) {
      // ä¿è­·selectå…ƒç´ 
      this.protectSelectElement(voiceSelect);
      
      voiceSelect.innerHTML = '';
      var englishVoices = voices.filter(function(v) { 
        return v.lang && v.lang.indexOf('en') === 0; 
      });
      
      for (var i = 0; i < englishVoices.length; i++) {
        var voice = englishVoices[i];
        var option = document.createElement('option');
        option.value = voice.voiceURI;
        option.textContent = voice.name + ' (' + voice.lang + ')';
        if (voice.voiceURI === this.voiceSettings.voiceURI) {
          option.selected = true;
        }
        voiceSelect.appendChild(option);
      }
      
      if (!voiceSelect.value && englishVoices.length > 0) {
        voiceSelect.value = englishVoices[0].voiceURI;
      }
      
      // æ·»åŠ changeäº‹ä»¶ç›£è½å™¨ - åˆ‡æ›æ™‚æ’­æ”¾ç¤ºä¾‹èªéŸ³
      voiceSelect.addEventListener('change', function() {
        var selectedVoiceURI = voiceSelect.value;
        self.previewVoice(selectedVoiceURI, 'Hello, this is a sample voice for English pronunciation.');
      });
    }
    
    // å¡«å……æ—¥æ–‡èªéŸ³é¸é …
    if (japaneseVoiceSelect) {
      // ä¿è­·selectå…ƒç´ 
      this.protectSelectElement(japaneseVoiceSelect);
      
      japaneseVoiceSelect.innerHTML = '';
      var japaneseVoices = voices.filter(function(v) { 
        return v.lang && v.lang.indexOf('ja') === 0; 
      });
      
      for (var i = 0; i < japaneseVoices.length; i++) {
        var voice = japaneseVoices[i];
        var option = document.createElement('option');
        option.value = voice.voiceURI;
        option.textContent = voice.name + ' (' + voice.lang + ')';
        if (voice.voiceURI === this.voiceSettings.japaneseVoiceURI) {
          option.selected = true;
        }
        japaneseVoiceSelect.appendChild(option);
      }
      
      if (!japaneseVoiceSelect.value && japaneseVoices.length > 0) {
        japaneseVoiceSelect.value = japaneseVoices[0].voiceURI;
      }
      
      // æ·»åŠ changeäº‹ä»¶ç›£è½å™¨ - åˆ‡æ›æ™‚æ’­æ”¾ç¤ºä¾‹èªéŸ³
      japaneseVoiceSelect.addEventListener('change', function() {
        var selectedVoiceURI = japaneseVoiceSelect.value;
        self.previewVoice(selectedVoiceURI, 'ã“ã‚“ã«ã¡ã¯ã€ã“ã‚Œã¯æ—¥æœ¬èªã®éŸ³å£°ã‚µãƒ³ãƒ—ãƒ«ã§ã™ã€‚');
      });
    }
    
    // å¡«å……ä¸­æ–‡èªéŸ³é¸é …
    var chineseVoiceSelect = document.getElementById('chinese-voice-select-setting');
    if (chineseVoiceSelect) {
      // ä¿è­·selectå…ƒç´ 
      this.protectSelectElement(chineseVoiceSelect);
      
      chineseVoiceSelect.innerHTML = '';
      var chineseVoices = voices.filter(function(v) { 
        return v.lang && (v.lang.indexOf('zh') === 0 || v.lang.indexOf('cmn') === 0 || v.lang.indexOf('yue') === 0); 
      });
      
      for (var i = 0; i < chineseVoices.length; i++) {
        var voice = chineseVoices[i];
        var option = document.createElement('option');
        option.value = voice.voiceURI;
        option.textContent = voice.name + ' (' + voice.lang + ')';
        if (voice.voiceURI === this.voiceSettings.chineseVoiceURI) {
          option.selected = true;
        }
        chineseVoiceSelect.appendChild(option);
      }
      
      if (!chineseVoiceSelect.value && chineseVoices.length > 0) {
        chineseVoiceSelect.value = chineseVoices[0].voiceURI;
      }
      
      // æ·»åŠ changeäº‹ä»¶ç›£è½å™¨ - åˆ‡æ›æ™‚æ’­æ”¾ç¤ºä¾‹èªéŸ³
      chineseVoiceSelect.addEventListener('change', function() {
        var selectedVoiceURI = chineseVoiceSelect.value;
        self.previewVoice(selectedVoiceURI, 'ä½ å¥½ï¼Œé€™æ˜¯ä¸­æ–‡èªéŸ³ç¯„ä¾‹ã€‚');
      });
    }
  };
  
  // åŒ¯å‡ºåŠŸèƒ½ç›¸é—œï¼ˆå®Œæ•´ç‰ˆæœ¬ï¼‰
  FlashcardApp.prototype.openExportModal = function() {
      // é è¨­åç¨±ï¼šç›®å‰å·¥ä½œè¡¨åç¨±_yyyyMMdd
    var defaultName = this.getDefaultExportSheetName();
    var exportSheetNameInput = document.getElementById('export-sheet-name');
    var exportTypeRemainingRadio = document.getElementById('export-type-remaining');
    var exportModal = document.getElementById('export-modal');
    
    if (exportSheetNameInput) exportSheetNameInput.value = defaultName;
    if (exportTypeRemainingRadio) exportTypeRemainingRadio.checked = true;
    if (exportModal) exportModal.style.display = 'flex';
    
      this.pauseTimer();
    
    // é‡ç½®åŒ¯å‡ºæŒ‰éˆ•ç‹€æ…‹å’Œé€²åº¦é¡¯ç¤º
    var confirmBtn = document.getElementById('confirm-export');
      if (confirmBtn) {
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'åŒ¯å‡º';
      }
    
    // éš±è—é€²åº¦é¡¯ç¤º
    this.hideExportProgress();
  };
  
  FlashcardApp.prototype.closeExportModal = function() {
    var exportModal = document.getElementById('export-modal');
    if (exportModal) exportModal.style.display = 'none';
    
      this.resumeTimer();
    
    // ç¢ºä¿ã€Œå·²æš«åœã€æ¶ˆå¤±
    var pausedIndicator = document.getElementById('paused-indicator');
    if (pausedIndicator) {
      pausedIndicator.style.display = 'none';
      pausedIndicator.title = '';
    }
    
    // éš±è—é€²åº¦é¡¯ç¤º
    this.hideExportProgress();
  };
  
  // ç²å–é è¨­åŒ¯å‡ºå·¥ä½œè¡¨åç¨±
FlashcardApp.prototype.getDefaultExportSheetName = function() {
  // ä½¿ç”¨å¯¦éš›è¼‰å…¥çš„å·¥ä½œè¡¨åç¨±ä½œç‚ºåŸºç¤
  var base = 'Sheet1'; // é è¨­å€¼
  
  // å¦‚æœæœ‰é¸æ“‡çš„å·¥ä½œè¡¨ï¼Œä½¿ç”¨ç¬¬ä¸€å€‹ä½œç‚ºåŸºç¤åç¨±
  console.log("this.sheetSettings.selectedSheets", this.sheetSettings.selectedSheets);
  if (this.sheetSettings.selectedSheets && this.sheetSettings.selectedSheets.length > 0) {
    base = this.sheetSettings.selectedSheets[0];
    console.log("base", base);
  }
  
  var date = new Date();
  var y = date.getFullYear();
  var m = (date.getMonth() + 1).toString();
  var d = date.getDate().toString();
  
  // ES5 ç‰ˆæœ¬çš„ padStart
  if (m.length < 2) m = '0' + m;
  if (d.length < 2) d = '0' + d;
  
  return base + '_' + y + m + d;
};
  
  // é¡¯ç¤ºåŒ¯å‡ºé€²åº¦
  FlashcardApp.prototype.showExportProgress = function() {
    var progressContainer = document.getElementById('export-progress-container');
    if (progressContainer) {
      progressContainer.style.display = 'block';
    }
    
    // é‡ç½®é€²åº¦
    this.updateExportProgress(0, 0, 'æº–å‚™åŒ¯å‡º...');
  };
  
  // éš±è—åŒ¯å‡ºé€²åº¦
  FlashcardApp.prototype.hideExportProgress = function() {
    var progressContainer = document.getElementById('export-progress-container');
    if (progressContainer) {
      progressContainer.style.display = 'none';
    }
    
    // æ¸…é™¤é€²åº¦è¨ˆæ™‚å™¨ï¼ˆé›–ç„¶ç¾åœ¨ä¸ä½¿ç”¨ï¼Œä½†ä¿ç•™ç›¸å®¹æ€§ï¼‰
    if (this.progressTimer) {
      clearInterval(this.progressTimer);
      this.progressTimer = null;
    }
    
    // æ¸…é™¤åˆ†æ‰¹åŒ¯å‡ºç‹€æ…‹
    this.currentBatch = 0;
    this.totalBatches = 0;
    this.processedWords = 0;
    this.totalWords = 0;
    this.exportBatches = null;
    this.isSheetCreated = false;
  };
  
  // æ›´æ–°åŒ¯å‡ºé€²åº¦
  FlashcardApp.prototype.updateExportProgress = function(current, total, message) {
    var progressFill = document.getElementById('export-progress-fill');
    var progressText = document.getElementById('export-progress-text');
    var progressCount = document.getElementById('export-progress-count');
    
    if (progressFill && total > 0) {
      var percentage = Math.min((current / total) * 100, 100);
      progressFill.style.width = percentage + '%';
    }
    
    if (progressText && message) {
      progressText.textContent = message;
    }
    
    if (progressCount && total > 0) {
      progressCount.textContent = current + ' / ' + total;
    }
  };
  
  // é–‹å§‹åˆ†æ‰¹åŒ¯å‡º
  FlashcardApp.prototype.startBatchExport = function(exportData, sheetName, targetSheetId, overwrite) {
    var self = this;
    var batchSize = 15; // æ¯æ‰¹è™•ç†15å€‹å–®å­—
    var batches = [];
    
    // å°‡è³‡æ–™åˆ†æˆæ‰¹æ¬¡
    for (var i = 0; i < exportData.length; i += batchSize) {
      batches.push(exportData.slice(i, i + batchSize));
    }
    
    this.currentBatch = 0;
    this.totalBatches = batches.length;
    this.processedWords = 0;
    this.totalWords = exportData.length;
    this.exportBatches = batches;
    this.exportSheetName = sheetName;
    this.exportTargetSheetId = targetSheetId;
    this.exportOverwrite = overwrite;
    this.isSheetCreated = false; // è¿½è¹¤å·¥ä½œè¡¨æ˜¯å¦å·²å‰µå»º
    
    // é–‹å§‹è™•ç†ç¬¬ä¸€æ‰¹
    this.processBatch();
  };
  
  
// è™•ç†å–®ä¸€æ‰¹æ¬¡ï¼ˆä¿®æ”¹exportWordsToSheetèª¿ç”¨ï¼‰
FlashcardApp.prototype.processBatch = function() {
  var self = this;
  
  if (this.currentBatch >= this.totalBatches) {
    // æ‰€æœ‰æ‰¹æ¬¡å®Œæˆ
    this.completeExportProgress();
    setTimeout(function() {
      self.onExportComplete();
    }, 500);
    return;
  }
  
  var currentBatchData = this.exportBatches[this.currentBatch];
  var batchNumber = this.currentBatch + 1;
  var isFirstBatch = this.currentBatch === 0;
  
  // æ›´æ–°é€²åº¦é¡¯ç¤º
  var message = 'æ­£åœ¨åŒ¯å‡ºç¬¬ ' + batchNumber + ' æ‰¹ï¼Œå…± ' + this.totalBatches + ' æ‰¹...';
  this.updateExportProgress(this.processedWords, this.totalWords, message);
  
  // ç¢ºå®šæ“ä½œæ¨¡å¼ï¼šç¬¬ä¸€æ‰¹æ¬¡å¯èƒ½éœ€è¦è¦†å¯«ï¼Œå¾ŒçºŒæ‰¹æ¬¡çµ•å°ä¸è¦†å¯«
  var shouldOverwrite = this.exportOverwrite && isFirstBatch;
  
  // è™•ç†ç•¶å‰æ‰¹æ¬¡
  google.script.run
    .withSuccessHandler(function(result) {
      console.log('ç¬¬ ' + batchNumber + ' æ‰¹åŒ¯å‡ºçµæœ:', result);
      
      // æª¢æŸ¥åŒ¯å‡ºçµæœ
      if (result && result.success === false) {
        // åªæœ‰ç¬¬ä¸€æ‰¹æ¬¡æ‰è™•ç†å·¥ä½œè¡¨å­˜åœ¨çš„éŒ¯èª¤
        if (isFirstBatch && result.error === 'SHEET_EXISTS') {
          console.log('ç¬¬ä¸€æ‰¹æ¬¡ï¼šè™•ç†å·¥ä½œè¡¨å·²å­˜åœ¨çš„æƒ…æ³');
          self.handleSheetExistsError(result.message);
          return;
        }
        
        // è™•ç†å…¶ä»–éŒ¯èª¤
        console.error('æ‰¹æ¬¡åŒ¯å‡ºå¤±æ•—:', result);
        self.hideExportProgress();
        alert('åŒ¯å‡ºå¤±æ•—ï¼ˆç¬¬ ' + batchNumber + ' æ‰¹ï¼‰ï¼š' + (result.message || result.error || 'æœªçŸ¥éŒ¯èª¤'));
        self.resetExportButton();
        return;
      }
      
      // æ‰¹æ¬¡æˆåŠŸå®Œæˆ
      console.log('ç¬¬ ' + batchNumber + ' æ‰¹æˆåŠŸåŒ¯å‡º ' + currentBatchData.length + ' å€‹å–®å­—');
      self.processedWords += currentBatchData.length;
      self.currentBatch++;
      
      // æ¨™è¨˜å·¥ä½œè¡¨å·²å‰µå»ºï¼ˆç¬¬ä¸€æ‰¹æ¬¡æˆåŠŸå¾Œï¼‰
      if (isFirstBatch) {
        self.isSheetCreated = true;
      }
      
      // æ›´æ–°é€²åº¦
      var progressMessage = 'å·²å®Œæˆ ' + self.processedWords + ' / ' + self.totalWords + ' å€‹å–®å­—';
      self.updateExportProgress(self.processedWords, self.totalWords, progressMessage);
      
      // è™•ç†ä¸‹ä¸€æ‰¹ï¼ˆå»¶é²ä¸€é»è®“ä½¿ç”¨è€…çœ‹åˆ°é€²åº¦æ›´æ–°ï¼‰
      setTimeout(function() {
        self.processBatch();
      }, 300);
    })
    .withFailureHandler(function(error) {
      console.error('æ‰¹æ¬¡åŒ¯å‡ºå¤±æ•—:', error);
      self.hideExportProgress();
      alert('åŒ¯å‡ºå¤±æ•—ï¼ˆç¬¬ ' + batchNumber + ' æ‰¹ï¼‰ï¼Œè«‹é‡è©¦ï¼\néŒ¯èª¤ï¼š' + error);
      self.resetExportButton();
    })
    .exportWordsToSheet(
      currentBatchData, 
      this.exportSheetName, 
      this.exportTargetSheetId, 
      shouldOverwrite, // ç¬¬ä¸€æ‰¹æ¬¡å¯èƒ½è¦†å¯«ï¼Œå¾ŒçºŒæ‰¹æ¬¡çµ•å°ä¸è¦†å¯«
      isFirstBatch // å‚³éæ˜¯å¦ç‚ºç¬¬ä¸€æ‰¹æ¬¡çš„åƒæ•¸
    );
};
  
  // åŒ¯å‡ºå®Œæˆè™•ç†
  FlashcardApp.prototype.onExportComplete = function() {
    var confirmBtn = document.getElementById('confirm-export');
    if (confirmBtn) {
      confirmBtn.disabled = false;
      confirmBtn.textContent = 'åŒ¯å‡º';
    }
    
    alert('åŒ¯å‡ºæˆåŠŸï¼å…±åŒ¯å‡º ' + this.totalWords + ' å€‹å–®å­—');
    this.closeExportModal();
  };
  
  // é‡ç½®åŒ¯å‡ºæŒ‰éˆ•
  FlashcardApp.prototype.resetExportButton = function() {
    var confirmBtn = document.getElementById('confirm-export');
    if (confirmBtn) {
      confirmBtn.disabled = false;
      confirmBtn.textContent = 'åŒ¯å‡º';
    }
  };
  
  // å®ŒæˆåŒ¯å‡ºé€²åº¦
  FlashcardApp.prototype.completeExportProgress = function() {
    var progressText = document.getElementById('export-progress-text');
    var progressCount = document.getElementById('export-progress-count');
    var progressFill = document.getElementById('export-progress-fill');
    
    // æ¸…é™¤è¨ˆæ™‚å™¨ï¼ˆé›–ç„¶ç¾åœ¨ä¸ä½¿ç”¨ï¼Œä½†ä¿ç•™ç›¸å®¹æ€§ï¼‰
    if (this.progressTimer) {
      clearInterval(this.progressTimer);
      this.progressTimer = null;
    }
    
    // è¨­å®šå®Œæˆç‹€æ…‹
    if (progressFill) {
      progressFill.style.width = '100%';
    }
    
    if (progressText) {
      progressText.textContent = 'åŒ¯å‡ºå®Œæˆï¼';
    }
    
    if (progressCount && this.totalWords > 0) {
      progressCount.textContent = this.totalWords + ' / ' + this.totalWords;
    }
  };
  
  FlashcardApp.prototype.confirmExport = function() {
      this.performExport(false);
  };
  
  FlashcardApp.prototype.performExport = function(overwrite) {
    var confirmBtn = document.getElementById('confirm-export');
      if (confirmBtn) {
        confirmBtn.disabled = true;
        confirmBtn.textContent = overwrite ? 'è¦†å¯«ä¸­...' : 'åŒ¯å‡ºä¸­...';
      }
      
    var typeRadio = document.getElementById('export-type-difficult');
    var type = (typeRadio && typeRadio.checked) ? 'difficult' : 'remaining';
    var sheetNameInput = document.getElementById('export-sheet-name');
    var sheetName = (sheetNameInput && sheetNameInput.value.trim()) || this.getDefaultExportSheetName();
    var exportWords = [];
    
      if (type === 'difficult') {
      var self = this;
      exportWords = this.words.filter(function(w) { 
        return self.difficultWords.includes(w.id); 
      });
      } else {
        exportWords = this.currentWords;
      }
      
      // åŒ¯å‡ºè³‡æ–™æ ¼å¼
    var exportData = [];
    for (var i = 0; i < exportWords.length; i++) {
      var w = exportWords[i];
      exportData.push({
        english: w.english,
        chinese: w.chinese,
        difficult: this.difficultWords.includes(w.id),
        image: w.image || '',        // ç¬¬4åˆ—ï¼šåœ–ç‰‡URL
        imageFormula: w.imageFormula || ''  // ç¬¬5åˆ—ï¼šåœ–ç‰‡é¡¯ç¤ºå…¬å¼
      });
    }
      
      if (exportData.length === 0) {
        alert('æ²’æœ‰å¯åŒ¯å‡ºçš„å–®å­—ï¼');
        if (confirmBtn) {
          confirmBtn.disabled = false;
          confirmBtn.textContent = 'åŒ¯å‡º';
        }
        return;
      }
    
    // é¡¯ç¤ºé€²åº¦
    this.showExportProgress();
    this.updateExportProgress(0, exportData.length, 'æº–å‚™åŒ¯å‡º...');
    
    // é–‹å§‹åˆ†æ‰¹åŒ¯å‡º
    var targetSheetId = this.sheetSettings.sheetId || null;
    this.startBatchExport(exportData, sheetName, targetSheetId, overwrite);
  };
  
  FlashcardApp.prototype.handleSheetExistsError = function(message) {
    var sheetNameInput = document.getElementById('export-sheet-name');
    var currentSheetName = sheetNameInput ? sheetNameInput.value.trim() : '';
    
    // åœæ­¢é€²åº¦é¡¯ç¤º
    this.hideExportProgress();
    
    // é‡ç½®åŒ¯å‡ºæŒ‰éˆ•
    this.resetExportButton();
      
      // é¡¯ç¤ºè‡ªå®šç¾©è¦†å¯«ç¢ºèªå°è©±æ¡†
      this.showOverwriteConfirmModal(currentSheetName);
  };
  
  FlashcardApp.prototype.showOverwriteConfirmModal = function(sheetName) {
      // è¨­ç½®å·¥ä½œè¡¨åç¨±
    var existingSheetNameElement = document.getElementById('existing-sheet-name');
    if (existingSheetNameElement) {
      existingSheetNameElement.textContent = sheetName;
    }
      
      // é¡¯ç¤ºå°è©±æ¡†
    var overwriteModal = document.getElementById('overwrite-confirm-modal');
    if (overwriteModal) {
      overwriteModal.style.display = 'flex';
    }
      
      // æš«åœè¨ˆæ™‚å™¨
      this.pauseTimer();
      
      // ç¶å®šäº‹ä»¶è™•ç†ç¨‹åº
      this.bindOverwriteConfirmEvents();
  };
  
  FlashcardApp.prototype.closeOverwriteConfirmModal = function() {
    var overwriteModal = document.getElementById('overwrite-confirm-modal');
    if (overwriteModal) {
      overwriteModal.style.display = 'none';
    }
    
      this.resumeTimer();
      
      // ç§»é™¤äº‹ä»¶è™•ç†ç¨‹åº
      this.unbindOverwriteConfirmEvents();
  };
  
  FlashcardApp.prototype.bindOverwriteConfirmEvents = function() {
    var self = this;
    
      // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶è™•ç†ç¨‹åºï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      this.unbindOverwriteConfirmEvents();
      
      // é—œé–‰æŒ‰éˆ•
    this.closeOverwriteHandler = function() { self.closeOverwriteConfirmModal(); };
    var closeBtn = document.getElementById('close-overwrite-confirm');
    if (closeBtn) {
      closeBtn.addEventListener('click', this.closeOverwriteHandler);
    }
      
      // ä½¿ç”¨ä¸åŒåç¨±æŒ‰éˆ•
    this.useDifferentNameHandler = function() {
      self.closeOverwriteConfirmModal();
      self.suggestAlternativeName();
    };
    var differentNameBtn = document.getElementById('use-different-name');
    if (differentNameBtn) {
      differentNameBtn.addEventListener('click', this.useDifferentNameHandler);
    }
      
      // è¦†å¯«ç¢ºèªæŒ‰éˆ•
    this.overwriteConfirmHandler = function() {
      self.closeOverwriteConfirmModal();
      // é‡æ–°é–‹å§‹åˆ†æ‰¹åŒ¯å‡ºï¼Œè¨­å®šè¦†å¯«æ¨¡å¼
      var exportData = [];
      if (self.exportBatches) {
        // é‡æ–°çµ„åˆæ‰€æœ‰æ‰¹æ¬¡çš„è³‡æ–™
        for (var i = 0; i < self.exportBatches.length; i++) {
          exportData = exportData.concat(self.exportBatches[i]);
        }
      }
      if (exportData.length > 0) {
        self.showExportProgress();
        // é‡ç½®å·¥ä½œè¡¨å‰µå»ºç‹€æ…‹
        self.isSheetCreated = false;
        self.startBatchExport(exportData, self.exportSheetName, self.exportTargetSheetId, true);
      } else {
        self.performExport(true);
      }
    };
    var overwriteConfirmBtn = document.getElementById('overwrite-confirm');
    if (overwriteConfirmBtn) {
      overwriteConfirmBtn.addEventListener('click', this.overwriteConfirmHandler);
    }
      
      // éµç›¤äº‹ä»¶è™•ç†
    this.overwriteKeyHandler = function(event) { self.handleOverwriteKeyboard(event); };
      document.addEventListener('keydown', this.overwriteKeyHandler);
  };
  
  FlashcardApp.prototype.unbindOverwriteConfirmEvents = function() {
      if (this.closeOverwriteHandler) {
      var closeBtn = document.getElementById('close-overwrite-confirm');
      if (closeBtn) {
        closeBtn.removeEventListener('click', this.closeOverwriteHandler);
      }
        this.closeOverwriteHandler = null;
      }
      if (this.useDifferentNameHandler) {
      var differentNameBtn = document.getElementById('use-different-name');
      if (differentNameBtn) {
        differentNameBtn.removeEventListener('click', this.useDifferentNameHandler);
      }
        this.useDifferentNameHandler = null;
      }
      if (this.overwriteConfirmHandler) {
      var overwriteConfirmBtn = document.getElementById('overwrite-confirm');
      if (overwriteConfirmBtn) {
        overwriteConfirmBtn.removeEventListener('click', this.overwriteConfirmHandler);
      }
        this.overwriteConfirmHandler = null;
      }
      if (this.overwriteKeyHandler) {
        document.removeEventListener('keydown', this.overwriteKeyHandler);
        this.overwriteKeyHandler = null;
      }
  };
  
    // æ·»åŠ éµç›¤å¿«æ·éµæ”¯æŒ
  FlashcardApp.prototype.handleOverwriteKeyboard = function(event) {
    var overwriteModal = document.getElementById('overwrite-confirm-modal');
    if (overwriteModal && overwriteModal.style.display === 'flex') {
        if (event.key === 'Escape') {
          event.preventDefault();
          this.closeOverwriteConfirmModal();
        } else if (event.key === 'Enter') {
          event.preventDefault();
          // Enter éµé»˜èªé¸æ“‡ä½¿ç”¨ä¸åŒåç¨±ï¼ˆè¼ƒå®‰å…¨çš„é¸é …ï¼‰
          this.closeOverwriteConfirmModal();
          this.suggestAlternativeName();
        }
      }
  };
  
  FlashcardApp.prototype.suggestAlternativeName = function() {
    var sheetNameInput = document.getElementById('export-sheet-name');
      if (sheetNameInput) {
        // ç”Ÿæˆå»ºè­°çš„æ›¿ä»£åç¨±
      var currentName = sheetNameInput.value.trim();
      var suggestedName = this.generateAlternativeSheetName(currentName);
        
        // æ›´æ–°è¼¸å…¥æ¡†å€¼ç‚ºå»ºè­°åç¨±
        sheetNameInput.value = suggestedName;
        sheetNameInput.focus();
        sheetNameInput.select(); // é¸å–ç¾æœ‰æ–‡å­—ï¼Œæ–¹ä¾¿ç”¨æˆ¶æ›¿æ›
        
        // æ·»åŠ éŒ¯èª¤æ¨£å¼é¡
      var settingControl = sheetNameInput.closest('.setting-control');
        if (settingControl) {
          settingControl.classList.add('export-error');
        }
        
        // æ›´æ–°æç¤ºæ–‡å­—å’Œæ¨£å¼
      var hintElement = document.getElementById('sheet-name-hint');
        if (hintElement) {
          hintElement.innerHTML = 'ğŸ’¡ å·²è‡ªå‹•å»ºè­°æ–°åç¨±ï¼Œæ‚¨å¯ä»¥ä¿®æ”¹å¾Œé‡æ–°åŒ¯å‡º';
          hintElement.className = 'sheet-name-hint error';
        }
        
        // ç§»é™¤éŒ¯èª¤æ¨£å¼ï¼ˆç•¶ç”¨æˆ¶é–‹å§‹è¼¸å…¥æ™‚ï¼‰
      var removeErrorStyle = function() {
          if (settingControl) {
            settingControl.classList.remove('export-error');
          }
          if (hintElement) {
            hintElement.innerHTML = 'ğŸ’¡ å¦‚æœå·¥ä½œè¡¨å·²å­˜åœ¨ï¼Œç³»çµ±æœƒè©¢å•æ‚¨æ˜¯å¦è¦è¦†å¯«';
            hintElement.className = 'sheet-name-hint normal';
          }
          sheetNameInput.removeEventListener('input', removeErrorStyle);
        };
        sheetNameInput.addEventListener('input', removeErrorStyle);
      }
  };
  
  FlashcardApp.prototype.generateAlternativeSheetName = function(originalName) {
    var now = new Date();
    var hours = now.getHours().toString();
    var minutes = now.getMinutes().toString();
    
    // ES5 ç‰ˆæœ¬çš„ padStart
    if (hours.length < 2) hours = '0' + hours;
    if (minutes.length < 2) minutes = '0' + minutes;
    
    var timestamp = hours + minutes;
      
      // å¦‚æœåŸåç¨±åŒ…å«æ™‚é–“æˆ³è¨˜ï¼Œå‰‡æ›´æ–°æ™‚é–“æˆ³è¨˜
    var timePattern = /_\d{4}$/;
      if (timePattern.test(originalName)) {
      return originalName.replace(timePattern, '_' + timestamp);
      } else {
        // å¦å‰‡æ·»åŠ æ™‚é–“æˆ³è¨˜
      return originalName + '_' + timestamp;
    }
  };
  
    // Sheetè¨­å®šç›¸é—œï¼ˆå®Œæ•´å¯¦ç¾ï¼‰
  FlashcardApp.prototype.loadSheetsList = function() {
    // æª¢æŸ¥æ˜¯å¦éœ€è¦ä½¿ç”¨é è¨­è¡¨å–®
    var sheetIdInput = document.getElementById('sheet-id-input');
    if (sheetIdInput && (!sheetIdInput.value || sheetIdInput.value.trim() === '')) {
      var useDefault = confirm('Google Sheet æ¬„ä½æ˜¯ç©ºçš„ã€‚\n\næ˜¯å¦è¦ä½¿ç”¨é è¨­çš„ç¯„ä¾‹è¡¨å–®ï¼Ÿ\n\né è¨­è¡¨å–®åŒ…å«å¸¸ç”¨çš„è‹±æ–‡å–®å­—ç¯„ä¾‹ï¼Œå¯ä»¥ç›´æ¥é–‹å§‹ä½¿ç”¨ã€‚');
      
      if (useDefault) {
        // å¡«å…¥é è¨­ID
        var defaultSheetId = '1jrpECEaDgtcXawdO9Rl4raHZ_sqmvnUm7x0bJ4IqfRM';
        sheetIdInput.value = defaultSheetId;
        console.log('ç”¨æˆ¶é¸æ“‡ä½¿ç”¨é è¨­è¡¨å–®ï¼Œå·²å¡«å…¥é è¨­ID:', defaultSheetId);
      } else {
        // ç”¨æˆ¶æ‹’çµ•ä½¿ç”¨é è¨­è¡¨å–®
        console.log('ç”¨æˆ¶æ‹’çµ•ä½¿ç”¨é è¨­è¡¨å–®');
        alert('è«‹è¼¸å…¥æ‚¨çš„ Google Sheet ID æˆ– URL');
        sheetIdInput.focus();
        return;
      }
    }

    var input = this.validateAndGetSheetInput();
    if (!input) return;

    var elements = this.validateSheetUIElements();
    if (!elements) return;

    try {
      var sheetId = this.extractSheetId(input);
      this.updateSheetLoadingUI(elements, true);
      this.performSheetListRequest(sheetId, elements);
    } catch (error) {
      console.error('loadSheetsList åŸ·è¡Œéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:', error);
      alert('éŒ¯èª¤ï¼š' + error.message);
    }
  };
  
  FlashcardApp.prototype.validateAndGetSheetInput = function() {
    var sheetIdInput = document.getElementById('sheet-id-input');
    if (!sheetIdInput) {
      console.error('æ‰¾ä¸åˆ° sheet-id-input å…ƒç´ ');
      alert('ç³»çµ±éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è¼¸å…¥æ¡†å…ƒç´ ');
      return null;
    }
  
    var input = sheetIdInput.value.trim();
    if (!input) {
      console.warn('ç”¨æˆ¶æœªè¼¸å…¥ä»»ä½•å…§å®¹');
      alert('è«‹è¼¸å…¥ Google Sheet ID æˆ– URL');
      return null;
    }
  
    return input;
  };
  
  FlashcardApp.prototype.validateSheetUIElements = function() {
    var elements = {
      sheetsList: document.getElementById('sheets-list'),
      sheetsGroup: document.getElementById('sheets-selection-group'),
      loadBtn: document.getElementById('load-sheets-btn')
    };
  
    var elementChecks = [
      { element: elements.sheetsList, name: 'sheets-list', error: 'æ‰¾ä¸åˆ°å·¥ä½œè¡¨æ¸…å–®å…ƒç´ ' },
      { element: elements.sheetsGroup, name: 'sheets-selection-group', error: 'æ‰¾ä¸åˆ°å·¥ä½œè¡¨é¸æ“‡çµ„å…ƒç´ ' },
      { element: elements.loadBtn, name: 'load-sheets-btn', error: 'æ‰¾ä¸åˆ°è¼‰å…¥æŒ‰éˆ•' }
    ];
  
    for (var i = 0; i < elementChecks.length; i++) {
      var check = elementChecks[i];
      if (!check.element) {
        console.error('æ‰¾ä¸åˆ° ' + check.name + ' å…ƒç´ ');
        alert('ç³»çµ±éŒ¯èª¤ï¼š' + check.error);
        return null;
      }
    }
  
    return elements;
  };
  
  FlashcardApp.prototype.extractSheetId = function(input) {
    console.log('=== extractSheetId é–‹å§‹åŸ·è¡Œ ===');
    console.log('è¼¸å…¥å…§å®¹:', input);
    
    var trimmedInput = input.trim();
    console.log('å»é™¤ç©ºæ ¼å¾Œ:', trimmedInput);
    
    // å¦‚æœçœ‹èµ·ä¾†åƒæ˜¯ URL
    if (trimmedInput.indexOf('docs.google.com/spreadsheets') !== -1) {
      console.log('æª¢æ¸¬åˆ° Google Sheets URL');
      // å°‹æ‰¾ /d/ å¾Œé¢çš„ ID
      var match = trimmedInput.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
      console.log('æ­£å‰‡è¡¨é”å¼åŒ¹é…çµæœ:', match);
      
      if (match && match[1]) {
        console.log('å¾ URL æå–åˆ° Sheet ID:', match[1]);
        return match[1];
          } else {
        console.error('ç„¡æ³•å¾ URL ä¸­æå– Sheet ID');
        throw new Error('ç„¡æ³•å¾ URL ä¸­æå– Sheet IDï¼Œè«‹ç¢ºèª URL æ ¼å¼æ­£ç¢º');
      }
    }
    
    // å¦‚æœçœ‹èµ·ä¾†åƒæ˜¯ç´” ID (å­—æ¯æ•¸å­—çµ„åˆ)
    var idPattern = /^[a-zA-Z0-9-_]+$/;
    console.log('æª¢æŸ¥æ˜¯å¦ç‚ºç´” IDï¼Œæ¨¡å¼:', idPattern);
    console.log('æ¨¡å¼æ¸¬è©¦çµæœ:', idPattern.test(trimmedInput));
    
    if (idPattern.test(trimmedInput)) {
      console.log('è¼¸å…¥çœ‹èµ·ä¾†æ˜¯ Sheet ID:', trimmedInput);
      return trimmedInput;
    }
    
    console.error('è¼¸å…¥æ ¼å¼ä¸æ­£ç¢º');
    throw new Error('è¼¸å…¥æ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹è¼¸å…¥æœ‰æ•ˆçš„ Google Sheet ID æˆ– URL');
  };
  
  FlashcardApp.prototype.updateSheetLoadingUI = function(elements, isLoading) {
    if (isLoading) {
      elements.sheetsList.innerHTML = '<div class="loading-text">è¼‰å…¥ä¸­...</div>';
      elements.sheetsGroup.style.display = 'block';
      elements.loadBtn.disabled = true;
      elements.loadBtn.textContent = 'è¼‰å…¥ä¸­...';
          } else {
      elements.loadBtn.disabled = false;
      elements.loadBtn.textContent = 'è¼‰å…¥å·¥ä½œè¡¨æ¸…å–®';
    }
  };
  
  FlashcardApp.prototype.performSheetListRequest = function(sheetId, elements) {
    if (!this.validateGoogleScriptEnvironment()) {
      throw new Error('Google Apps Script ç’°å¢ƒä¸å¯ç”¨');
    }
  
    var self = this;
    var timeout = this.setupSheetRequestTimeout(elements);
    
    google.script.run
      .withSuccessHandler(function(result) {
        self.handleSheetListSuccess(result, elements, timeout, sheetId);
      })
      .withFailureHandler(function(error) {
        self.handleSheetListFailure(error, elements, timeout);
      })
      .getSheetsList(sheetId);
  };
  
  FlashcardApp.prototype.validateGoogleScriptEnvironment = function() {
    if (typeof google === 'undefined') {
      console.error('google ç‰©ä»¶æœªå®šç¾©');
      return false;
    }
    if (!google.script || !google.script.run) {
      console.error('Google Apps Script åŠŸèƒ½æœªå¯ç”¨');
      return false;
    }
    return true;
  };
  
  FlashcardApp.prototype.setupSheetRequestTimeout = function(elements) {
    var self = this;
    return setTimeout(function() {
      console.error('è¼‰å…¥å·¥ä½œè¡¨æ¸…å–®è¶…æ™‚ (15ç§’)');
      elements.sheetsList.innerHTML = '<div class="error-text">è¼‰å…¥è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥æˆ–é‡è©¦</div>';
      self.updateSheetLoadingUI(elements, false);
    }, 15000);
  };
  
  FlashcardApp.prototype.handleSheetListSuccess = function(result, elements, timeout, sheetId) {
    clearTimeout(timeout);
    console.log('Google Apps Script æˆåŠŸå›èª¿');
  
    var sheets, spreadsheetName;
    if (result && result.sheets) {
      sheets = result.sheets;
      spreadsheetName = result.spreadsheetName;
    } else if (Array.isArray(result)) {
      sheets = result;
      spreadsheetName = null;
    } else {
      throw new Error('è¼‰å…¥å·¥ä½œè¡¨æ¸…å–®å¤±æ•—ï¼šè¿”å›æ ¼å¼éŒ¯èª¤');
    }
  
    this.availableSheets = sheets;
    this.currentSpreadsheetName = spreadsheetName;
    
    // ä¿å­˜åˆ°æ­·å²è¨˜éŒ„
    if (sheetId && spreadsheetName) {
      this.addToSheetHistory(sheetId, spreadsheetName);
      console.log('å·²æ·»åŠ åˆ°æ­·å²è¨˜éŒ„:', sheetId, spreadsheetName);
    }
    
    this.renderSheetsList();
    this.updateSheetLoadingUI(elements, false);
  };
  
  FlashcardApp.prototype.handleSheetListFailure = function(error, elements, timeout) {
    clearTimeout(timeout);
    console.error('è¼‰å…¥å·¥ä½œè¡¨æ¸…å–®å¤±æ•—:', error);
  
    var errorMessage = error.message || 'æœªçŸ¥éŒ¯èª¤';
    var helpMessage = '';
    
    // æ ¹æ“šä¸åŒéŒ¯èª¤é¡å‹æä¾›å…·é«”çš„å¹«åŠ©è¨Šæ¯
    if (errorMessage.indexOf('æ¬Šé™') !== -1 || errorMessage.indexOf('Permission') !== -1) {
      helpMessage = '<div class="error-help"><strong>è§£æ±ºæ–¹æ¡ˆï¼š</strong><br>1. ç¢ºèªæ‚¨æœ‰å­˜å–æ­¤ Google Sheet çš„æ¬Šé™<br>2. å¦‚æœæ˜¯ç§äºº Sheetï¼Œè«‹ç¢ºä¿æ‚¨å·²ç™»å…¥ç›¸åŒçš„ Google å¸³è™Ÿ<br>3. å˜—è©¦åœ¨ç€è¦½å™¨ä¸­ç›´æ¥é–‹å•Ÿè©² Sheet ç¢ºèªæ¬Šé™</div>';
    } else if (errorMessage.indexOf('æ‰¾ä¸åˆ°') !== -1 || errorMessage.indexOf('ç„¡æ³•é–‹å•Ÿ') !== -1 || errorMessage.indexOf('not found') !== -1) {
      helpMessage = '<div class="error-help"><strong>è§£æ±ºæ–¹æ¡ˆï¼š</strong><br>1. è«‹æª¢æŸ¥ Sheet ID æ˜¯å¦æ­£ç¢º<br>2. ç¢ºèª Sheet æ˜¯å¦å­˜åœ¨ä¸”æœªè¢«åˆªé™¤<br>3. å¦‚æœæ˜¯ URLï¼Œè«‹ç¢ºä¿æ ¼å¼æ­£ç¢º</div>';
    } else if (errorMessage.indexOf('network') !== -1 || errorMessage.indexOf('ç¶²è·¯') !== -1) {
      helpMessage = '<div class="error-help"><strong>è§£æ±ºæ–¹æ¡ˆï¼š</strong><br>1. æª¢æŸ¥ç¶²è·¯é€£æ¥<br>2. ç¨å¾Œé‡è©¦<br>3. ç¢ºèªé˜²ç«ç‰†æœªé˜»æ“‹ Google æœå‹™</div>';
          } else {
      helpMessage = '<div class="error-help"><strong>å¸¸è¦‹è§£æ±ºæ–¹æ¡ˆï¼š</strong><br>1. è«‹åˆ·æ–°é é¢é‡è©¦ï¼ˆæŒ‰ Ctrl+F5 æˆ– Cmd+Shift+Rï¼‰<br>2. ç¢ºèª Google Sheet ID æ ¼å¼æ­£ç¢º<br>3. ç¢ºèªæ‚¨æœ‰è©² Sheet çš„å­˜å–æ¬Šé™<br>4. å˜—è©¦ç›´æ¥åœ¨ç€è¦½å™¨é–‹å•Ÿè©² Sheet</div>';
    }
    
    elements.sheetsList.innerHTML = '<div class="error-text">è¼‰å…¥å¤±æ•—ï¼š' + errorMessage + '</div>' + helpMessage;
    this.updateSheetLoadingUI(elements, false);
  };
  
  FlashcardApp.prototype.renderSheetsList = function() {
    console.log('=== renderSheetsList é–‹å§‹åŸ·è¡Œ ===');
    console.log('å¯ç”¨å·¥ä½œè¡¨æ•¸é‡:', this.availableSheets ? this.availableSheets.length : 0);
    console.log('å·¥ä½œè¡¨è³‡æ–™:', this.availableSheets);
    console.log('ç•¶å‰ Google Sheet åç¨±:', this.currentSpreadsheetName);
    
    var sheetsList = document.getElementById('sheets-list');
    var sheetsGroup = document.getElementById('sheets-selection-group');
    if (!sheetsList || !sheetsGroup) {
      console.error('æ‰¾ä¸åˆ° sheets-list æˆ– sheets-selection-group å…ƒç´ ');
      return;
    }
    
    if (!this.availableSheets || this.availableSheets.length === 0) {
      console.warn('æ²’æœ‰å¯ç”¨çš„å·¥ä½œè¡¨');
      sheetsList.innerHTML = '<div class="error-text">æ²’æœ‰æ‰¾åˆ°å·¥ä½œè¡¨</div>';
      var oldTitle = sheetsGroup.querySelector('.sheet-title');
      if (oldTitle) oldTitle.remove();
        return;
      }
      
    console.log('é–‹å§‹æ¸…ç©ºä¸¦é‡æ–°æ¸²æŸ“å·¥ä½œè¡¨æ¸…å–®');
    sheetsList.innerHTML = '';
    
    // å…ˆç§»é™¤èˆŠçš„æ¨™é¡Œ
    var oldTitle = sheetsGroup.querySelector('.sheet-title');
    if (oldTitle) oldTitle.remove();
    
    // å¦‚æœæœ‰ Google Sheet åç¨±ï¼Œé¡¯ç¤ºåœ¨ sheetsGroup æœ€ä¸Šæ–¹
    if (this.currentSpreadsheetName) {
      var sheetTitle = document.createElement('div');
      sheetTitle.className = 'sheet-title';
      sheetTitle.innerHTML = '<div class="sheet-title-text"><strong>Google Sheet:</strong> ' + this.currentSpreadsheetName + '</div>';
      sheetsGroup.insertBefore(sheetTitle, sheetsGroup.firstChild);
      console.log('é¡¯ç¤º Google Sheet åç¨±:', this.currentSpreadsheetName);
    }
    
    var self = this;
    for (var index = 0; index < this.availableSheets.length; index++) {
      var sheet = this.availableSheets[index];
      console.log('æ¸²æŸ“å·¥ä½œè¡¨ ' + (index + 1) + ':', sheet);
      
      var sheetItem = document.createElement('div');
      sheetItem.className = 'sheet-item';
      
      var checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.value = sheet.name;
      
      // æª¢æŸ¥æ˜¯å¦æ‡‰è©²è‡ªå‹•å‹¾é¸
      if (this.sheetSettings.selectedSheets && this.sheetSettings.selectedSheets.includes(sheet.name)) {
        checkbox.checked = true;
        console.log('è‡ªå‹•å‹¾é¸å·²è¼‰å…¥çš„å·¥ä½œè¡¨:', sheet.name);
      }
      
      (function(sheetName) {
        checkbox.addEventListener('change', function() {
          console.log('å·¥ä½œè¡¨é¸æ“‡ç‹€æ…‹æ”¹è®Š:', sheetName, checkbox.checked);
          self.toggleSheetSelection();
        });
      })(sheet.name);
      
      var sheetInfo = document.createElement('div');
      sheetInfo.className = 'sheet-info';
      
      var sheetName = document.createElement('div');
      sheetName.className = 'sheet-name';
      sheetName.textContent = sheet.name;
      
      var sheetCount = document.createElement('div');
      sheetCount.className = 'sheet-count';
      // å¦‚æœ wordCount ç‚º null æˆ– undefinedï¼Œé¡¯ç¤º '-'ï¼Œè¡¨ç¤ºè©²å·¥ä½œè¡¨çš„ F1 æ¬„ä½éœ€è¦è¨­ç½®
      if (sheet.wordCount === null || sheet.wordCount === undefined) {
        sheetCount.textContent = '-';
        sheetCount.style.color = '#888'; // ä½¿ç”¨ç°è‰²è¡¨ç¤ºç„¡è³‡æ–™
      } else {
        sheetCount.textContent = sheet.wordCount + ' å€‹å–®å­—';
      }
      
      sheetInfo.appendChild(sheetName);
      sheetInfo.appendChild(sheetCount);
      
      sheetItem.appendChild(checkbox);
      sheetItem.appendChild(sheetInfo);
      
      (function(currentSheet, currentCheckbox) {
        sheetItem.addEventListener('click', function(e) {
          if (e.target !== currentCheckbox) {
            console.log('é»æ“Šå·¥ä½œè¡¨é …ç›®:', currentSheet.name);
            currentCheckbox.checked = !currentCheckbox.checked;
            self.toggleSheetSelection();
          }
        });
      })(sheet, checkbox);
      
      sheetsList.appendChild(sheetItem);
      console.log('å·¥ä½œè¡¨ ' + sheet.name + ' æ¸²æŸ“å®Œæˆ');
    }
    
    console.log('æ‰€æœ‰å·¥ä½œè¡¨æ¸²æŸ“å®Œæˆï¼Œæ›´æ–°é¸æ“‡è¨ˆæ•¸');
    this.updateSelectedCount();
    
    // æª¢æŸ¥æ˜¯å¦æœ‰å·²å‹¾é¸çš„å·¥ä½œè¡¨ï¼Œå¦‚æœæœ‰å‰‡å•Ÿç”¨è¼‰å…¥æŒ‰éˆ•
    var checkboxes = document.querySelectorAll('#sheets-list input[type="checkbox"]');
    var selectedCount = 0;
    for (var i = 0; i < checkboxes.length; i++) {
      if (checkboxes[i].checked) selectedCount++;
    }
    var saveBtn = document.getElementById('save-sheet-settings');
    if (saveBtn && selectedCount > 0) {
      saveBtn.disabled = false;
      console.log('å•Ÿç”¨è¼‰å…¥å–®å­—æŒ‰éˆ•ï¼Œå·²é¸æ“‡', selectedCount, 'å€‹å·¥ä½œè¡¨');
    }
    
    console.log('=== renderSheetsList åŸ·è¡Œå®Œæˆ ===');
  };
  
  FlashcardApp.prototype.toggleSheetSelection = function() {
    var checkboxes = document.querySelectorAll('#sheets-list input[type="checkbox"]');
    var selectedCount = 0;
    for (var i = 0; i < checkboxes.length; i++) {
      if (checkboxes[i].checked) selectedCount++;
    }
    
    var saveBtn = document.getElementById('save-sheet-settings');
    if (saveBtn) {
      saveBtn.disabled = selectedCount === 0;
    }
    this.updateSelectedCount();
  };
  
  FlashcardApp.prototype.updateSelectedCount = function() {
    var checkboxes = document.querySelectorAll('#sheets-list input[type="checkbox"]');
    var selectedCount = 0;
    for (var i = 0; i < checkboxes.length; i++) {
      if (checkboxes[i].checked) selectedCount++;
    }
    var selectedCountElement = document.getElementById('selected-count');
    if (selectedCountElement) {
      selectedCountElement.textContent = '(å·²é¸ ' + selectedCount + ' å€‹)';
    }
  };
  
  FlashcardApp.prototype.saveSheetSettingsAndClose = function() {
    var sheetIdInput = document.getElementById('sheet-id-input');
    var input = sheetIdInput.value.trim();
    
    var checkboxes = document.querySelectorAll('#sheets-list input[type="checkbox"]');
    var selectedSheets = [];
    for (var i = 0; i < checkboxes.length; i++) {
      if (checkboxes[i].checked) {
        selectedSheets.push(checkboxes[i].value);
      }
    }
    
    if (!input || selectedSheets.length === 0) {
      alert('è«‹è¼¸å…¥ Google Sheet ID/URL ä¸¦é¸æ“‡è‡³å°‘ä¸€å€‹å·¥ä½œè¡¨');
        return;
      }
      
    try {
      var sheetId = this.extractSheetId(input);
      
      this.sheetSettings.sheetId = sheetId;
      this.sheetSettings.selectedSheets = selectedSheets;
      this.saveSheetSettings();
      
      console.log('å„²å­˜ Sheet è¨­å®š:', this.sheetSettings);
      
      this.closeSheetSettings();
      
      // é¡¯ç¤ºè¼‰å…¥ä¸­è¨Šæ¯
      var loadingDiv = document.getElementById('loading');
      var flashcardDiv = document.getElementById('flashcard');
      if (loadingDiv) loadingDiv.style.display = 'flex';
      if (flashcardDiv) flashcardDiv.style.display = 'none';
      
      // é‡æ–°è¼‰å…¥å–®å­—
      var self = this;
      this.loadWords(false, function(hasDuplicates) {
        self.setupEventListeners();
        self.applySettings();
        
        if (!hasDuplicates) {
          self.startNewRound();
        }
        
        if (loadingDiv) loadingDiv.style.display = 'none';
        if (flashcardDiv) flashcardDiv.style.display = 'flex';
      });
      
    } catch (error) {
      console.error('å„²å­˜è¨­å®šæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
      alert(error.message);
    }
  };
  
  // é‡è¤‡è™•ç†ç›¸é—œï¼ˆå®Œæ•´ç‰ˆæœ¬ï¼‰
  FlashcardApp.prototype.showAutoProcessingNotification = function(results) {
    console.log('é¡¯ç¤ºè‡ªå‹•è™•ç†é€šçŸ¥:', results);
    
    // å‰µå»ºé€šçŸ¥å…ƒç´ 
    var notification = document.createElement('div');
    notification.className = 'auto-processing-notification';
    notification.innerHTML = 
      '<div class="notification-content">' +
        '<h3>âœ… é‡è¤‡å–®å­—å·²è‡ªå‹•è™•ç†</h3>' +
        '<p>åœ¨è¨˜æ†¶é«”ä¸­è™•ç†äº† ' + results.successCount + '/' + results.totalCount + ' å€‹é‡è¤‡å–®å­—</p>' +
        '<p class="memory-notice">ğŸ“ åŸå§‹Google Sheetæœªè¢«ä¿®æ”¹ï¼Œåƒ…åœ¨æœ¬æ¬¡ä½¿ç”¨ä¸­å»é‡</p>' +
        '<button id="close-notification" class="notification-close">Ã—</button>' +
      '</div>';
    
    document.body.appendChild(notification);
    
    var self = this;
    
    // è‡ªå‹•é—œé–‰é€šçŸ¥
    setTimeout(function() {
      notification.classList.add('fade-out');
      setTimeout(function() {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 300);
    }, 5000);
    
    // æ‰‹å‹•é—œé–‰é€šçŸ¥
    var closeBtn = document.getElementById('close-notification');
    if (closeBtn) {
      closeBtn.addEventListener('click', function() {
        notification.classList.add('fade-out');
        setTimeout(function() {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      });
    }
    
    // é¡¯ç¤ºå‹•ç•«
    setTimeout(function() {
      notification.classList.add('show');
    }, 100);
  };
  
  FlashcardApp.prototype.showDuplicateModal = function() {
    console.log('é¡¯ç¤ºé‡è¤‡è™•ç†æ¨¡æ…‹æ¡†');
    
    // æ¸…ç†ä¸­æ–‡èªéŸ³ç­‰å¾…å®šæ™‚å™¨
    if (this.chineseWaitInterval) {
      clearInterval(this.chineseWaitInterval);
      this.chineseWaitInterval = null;
    }
    
    // åœæ­¢ä»»ä½•æ­£åœ¨æ’­æ”¾çš„èªéŸ³
    if (this.speechSynthesis) {
      this.speechSynthesis.cancel();
    }
    
    // æ¸…é™¤ä»»ä½•ç¾æœ‰çš„è¨ˆæ™‚å™¨
    if (this.displayTimer) {
      clearTimeout(this.displayTimer);
      this.displayTimer = null;
    }
    
    var modal = document.getElementById('duplicate-words-modal');
    if (modal) {
      // é‡ç½® modal-body çš„ HTML å…§å®¹ç‚ºåŸå§‹ç‹€æ…‹
      var modalBody = modal.querySelector('.modal-body');
      if (modalBody) {
        modalBody.innerHTML = 
          '<div class="duplicate-info">' +
            '<p id="duplicate-summary">æ‰¾åˆ° <span id="duplicate-count">0</span> çµ„é‡è¤‡å–®å­—ï¼Œè«‹é¸æ“‡è™•ç†æ–¹å¼ï¼š</p>' +
          '</div>' +
          '<div class="duplicate-word-container" id="duplicate-word-container">' +
            '<!-- é‡è¤‡å–®å­—é …ç›®å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->' +
          '</div>' +
          '<div class="duplicate-actions" id="duplicate-actions" style="display: none;">' +
            '<div class="current-duplicate-info">' +
              '<h3>è™•ç†å–®å­—ï¼š<strong id="current-duplicate-english"></strong></h3>' +
              '<div id="duplicate-options-container">' +
                '<!-- è™•ç†é¸é …å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->' +
              '</div>' +
            '</div>' +
          '</div>';
      }
      
      // é‡ç½® modal-footer çš„ HTML å…§å®¹ç‚ºåŸå§‹ç‹€æ…‹
      var modalFooter = modal.querySelector('.modal-footer');
      if (modalFooter) {
        modalFooter.innerHTML = 
          '<button id="skip-duplicates" class="secondary-btn">è·³éï¼Œç¨å¾Œè™•ç†</button>' +
          '<button id="process-all-duplicates" class="primary-btn">é–‹å§‹è™•ç†</button>' +
          '<button id="confirm-duplicate-action" class="primary-btn" style="display: none;">ç¢ºèªæ“ä½œ</button>' +
          '<button id="next-duplicate" class="primary-btn" style="display: none;">ä¸‹ä¸€å€‹</button>';
        modalFooter.style.display = '';
      }
      
      modal.style.display = 'flex';
      this.pauseTimer();
      
      // æ›´æ–°é‡è¤‡å–®å­—æ•¸é‡
      var duplicateCountElement = document.getElementById('duplicate-count');
      if (duplicateCountElement) {
        duplicateCountElement.textContent = this.duplicateWords.length;
      }
      
      // æ¸²æŸ“é‡è¤‡å–®å­—æ¸…å–®
      this.renderDuplicateWordsList();
      
      this.setupDuplicateModalEvents();
    }
  };
  
  FlashcardApp.prototype.setupDuplicateModalEvents = function() {
    var self = this;
    
    // è·³éè™•ç†æŒ‰éˆ•
    var skipBtn = document.getElementById('skip-duplicates');
    if (skipBtn) {
      skipBtn.addEventListener('click', function() {
        self.skipDuplicates();
      });
    }
    
    // é–‹å§‹è™•ç†æŒ‰éˆ•
    var processBtn = document.getElementById('process-all-duplicates');
    if (processBtn) {
      processBtn.addEventListener('click', function() {
        self.processAllDuplicates();
      });
    }
    
    // ç¢ºèªæ“ä½œæŒ‰éˆ•
    var confirmBtn = document.getElementById('confirm-duplicate-action');
    if (confirmBtn) {
      confirmBtn.addEventListener('click', function() {
        self.confirmDuplicateAction();
      });
    }
    
    // ä¸‹ä¸€å€‹æŒ‰éˆ•
    var nextBtn = document.getElementById('next-duplicate');
    if (nextBtn) {
      nextBtn.addEventListener('click', function() {
        self.nextDuplicate();
      });
    }
    
    // é—œé–‰æŒ‰éˆ•
    var closeBtn = document.getElementById('close-duplicate-modal');
    if (closeBtn) {
      closeBtn.addEventListener('click', function() {
        self.closeDuplicateModal();
      });
    }
  };
  
  FlashcardApp.prototype.closeDuplicateModal = function() {
    var modal = document.getElementById('duplicate-words-modal');
    if (modal) {
      modal.style.display = 'none';
      this.resumeTimer();
    }
  };
  
  // è·³éé‡è¤‡è™•ç†ï¼ˆè‡ªå‹•è™•ç†ï¼‰
  FlashcardApp.prototype.skipDuplicates = function() {
    console.log('è·³éé‡è¤‡è™•ç† - åŸ·è¡Œæœ¬åœ°è‡ªå‹•è™•ç†é‚è¼¯ï¼ˆåƒ…è¨˜æ†¶é«”è™•ç†ï¼‰');
    
    try {
      var result = this.processDuplicatesInMemory(this.words, this.duplicateWords);
        
        if (result.success) {
          // æ›´æ–°ç•¶å‰å–®å­—é™£åˆ—
          this.words = result.processedWords;
        this.difficultWords = this.words.filter(function(w) { return w.difficult; }).map(function(w) { return w.id; });
          
          // é¡¯ç¤ºæˆåŠŸçµæœ
        var modal = document.getElementById('duplicate-words-modal');
        var modalBody = modal.querySelector('.modal-body');
        var modalFooter = modal.querySelector('.modal-footer');
          modalFooter.style.display = 'none';
          
        var successCount = result.successCount || 0;
        var totalCount = result.totalCount || 0;
        var removedCount = result.removedCount || 0;
        
        modalBody.innerHTML = 
          '<div class="auto-processing-result success">' +
            '<h3>âœ… è‡ªå‹•è™•ç†å®Œæˆï¼</h3>' +
            '<p>æˆåŠŸè™•ç† ' + successCount + '/' + totalCount + ' å€‹é‡è¤‡å–®å­—</p>' +
            '<p>åŸå§‹å–®å­—æ•¸é‡ï¼š' + result.originalCount + 'ï¼Œè™•ç†å¾Œæ•¸é‡ï¼š' + result.processedCount + '</p>' +
            '<p>å·²ç§»é™¤é‡è¤‡é …ç›®ï¼š' + removedCount + ' å€‹</p>' +
            '<p class="sheet-modify-notice">âœ… Google Sheetæœªè¢«ä¿®æ”¹ï¼Œåƒ…åœ¨è¨˜æ†¶é«”ä¸­è™•ç†</p>' +
            '<button id="finish-auto-processing" class="primary-btn">å®Œæˆ</button>' +
          '</div>';
        
        var self = this;
        document.getElementById('finish-auto-processing').addEventListener('click', function() {
          self.closeDuplicateModal();
          self.setupEventListeners();
          self.applySettings();
          self.startNewRound();
          });
        } else {
          throw new Error(result.error || 'è™•ç†å¤±æ•—');
        }
      } catch (error) {
      console.error('æœ¬åœ°è™•ç†å¤±æ•—:', error);
      alert('è‡ªå‹•è™•ç†å¤±æ•—ï¼š' + error.message);
      }
  };
    
  // åœ¨è¨˜æ†¶é«”ä¸­è™•ç†é‡è¤‡å–®å­—
  FlashcardApp.prototype.processDuplicatesInMemory = function(allWords, duplicates) {
      try {
        console.log('åœ¨å‰ç«¯è¨˜æ†¶é«”ä¸­è‡ªå‹•è™•ç†é‡è¤‡å–®å­—ï¼Œç¸½æ•¸:', duplicates.length);
        
      var results = [];
      var wordsToRemove = []; // è¨˜éŒ„è¦å¾è¨˜æ†¶é«”ä¸­ç§»é™¤çš„å–®å­—ID
      var wordsToModify = {}; // è¨˜éŒ„è¦ä¿®æ”¹å®šç¾©çš„å–®å­—IDå’Œæ–°å®šç¾©
      
      for (var i = 0; i < duplicates.length; i++) {
        var duplicate = duplicates[i];
          console.log('è™•ç†é‡è¤‡å–®å­—:', duplicate.english, 'æ˜¯å¦ç›¸åŒå®šç¾©:', duplicate.isSameDefinition);
          
          if (duplicate.isSameDefinition) {
            // ä¸­æ–‡æ„ç¾©ç›¸åŒï¼šä¿ç•™ç¬¬ä¸€å€‹å·¥ä½œè¡¨çš„ï¼Œç§»é™¤å…¶ä»–
          var keepWord = duplicate.words[0];
          var removeWords = duplicate.words.slice(1);
            
            console.log('ç›¸åŒå®šç¾©ï¼Œä¿ç•™ç¬¬ä¸€å€‹å·¥ä½œè¡¨:', keepWord.sheetName);
            
            // è¨˜éŒ„è¦ç§»é™¤çš„å–®å­—ID
          for (var j = 0; j < removeWords.length; j++) {
            wordsToRemove.push(removeWords[j].id);
          }
            
            results.push({
              english: duplicate.english,
              action: 'keep_first',
              success: true,
              keptSheet: keepWord.sheetName,
              removedCount: removeWords.length
            });
          } else {
            // ä¸­æ–‡æ„ç¾©ä¸åŒï¼šåˆä½µå®šç¾©åˆ°ç¬¬ä¸€å€‹å·¥ä½œè¡¨çš„å–®å­—
          var targetWord = duplicate.words[0];
          var mergeWords = duplicate.words.slice(1);
            
            console.log('ä¸åŒå®šç¾©ï¼Œåˆä½µåˆ°ç¬¬ä¸€å€‹å·¥ä½œè¡¨:', targetWord.sheetName);
            
            // æº–å‚™åˆä½µå¾Œçš„å®šç¾©
          var allDefinitions = [];
          for (var k = 0; k < duplicate.words.length; k++) {
            allDefinitions.push((k + 1) + '. ' + duplicate.words[k].chinese.trim());
          }
          var mergedDefinition = allDefinitions.join('\n');
            
            // è¨˜éŒ„è¦ä¿®æ”¹çš„å–®å­—
          wordsToModify[targetWord.id] = mergedDefinition;
            
            // è¨˜éŒ„è¦ç§»é™¤çš„å–®å­—ID
          for (var l = 0; l < mergeWords.length; l++) {
            wordsToRemove.push(mergeWords[l].id);
          }
            
            results.push({
              english: duplicate.english,
              action: 'merge_to_first',
              success: true,
              targetSheet: targetWord.sheetName,
              mergedDefinition: mergedDefinition,
              removedCount: mergeWords.length
            });
          }
        }
        
        // è™•ç†å–®å­—é™£åˆ—ï¼šç§»é™¤é‡è¤‡é …ç›®ä¸¦ä¿®æ”¹å®šç¾©
      var processedWords = [];
      for (var m = 0; m < allWords.length; m++) {
        var word = allWords[m];
        
        if (wordsToRemove.indexOf(word.id) !== -1) {
            // è·³éè¦ç§»é™¤çš„å–®å­—
            continue;
          }
          
        if (wordsToModify.hasOwnProperty(word.id)) {
            // ä¿®æ”¹å®šç¾©
          var modifiedWord = {};
          for (var key in word) {
            if (word.hasOwnProperty(key)) {
              modifiedWord[key] = word[key];
            }
          }
          modifiedWord.chinese = wordsToModify[word.id];
            processedWords.push(modifiedWord);
          } else {
            // ä¿æŒåŸæ¨£
            processedWords.push(word);
          }
        }
        
      var successCount = results.filter(function(r) { return r.success; }).length;
      var removedCount = wordsToRemove.length;
        
        return {
          success: true,
          results: results,
          successCount: successCount,
        totalCount: duplicates.length,
        removedCount: removedCount,
          originalCount: allWords.length,
          processedCount: processedWords.length,
        processedWords: processedWords
        };
      
      } catch (error) {
      console.error('è¨˜æ†¶é«”è™•ç†éŒ¯èª¤:', error);
        return {
          success: false,
        error: error.message || 'è™•ç†éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤'
      };
    }
  };
  
  // é–‹å§‹è™•ç†æ‰€æœ‰é‡è¤‡
  FlashcardApp.prototype.processAllDuplicates = function() {
    console.log('é–‹å§‹è™•ç†é‡è¤‡');
    if (this.duplicateWords.length > 0) {
      this.currentDuplicateIndex = 0;
      this.duplicateProcessingResults = [];
      this.selectDuplicateWord(0);
    }
  };
  
  // æ¸²æŸ“é‡è¤‡å–®å­—æ¸…å–®
  FlashcardApp.prototype.renderDuplicateWordsList = function() {
    var container = document.getElementById('duplicate-word-container');
    if (!container) return;
    
    container.innerHTML = '';
    
    for (var i = 0; i < this.duplicateWords.length; i++) {
      var duplicate = this.duplicateWords[i];
      var wordItem = document.createElement('div');
      wordItem.className = 'duplicate-word-item';
      wordItem.setAttribute('data-index', i);
      
      var wordHeader = document.createElement('div');
      wordHeader.className = 'duplicate-word-header';
      wordHeader.innerHTML = '<strong>' + duplicate.english + '</strong> (' + 
        (duplicate.isSameDefinition ? 'ç›¸åŒå®šç¾©' : 'ä¸åŒå®šç¾©') + ')';
      
      var wordSources = document.createElement('div');
      wordSources.className = 'duplicate-word-sources';
      
      for (var j = 0; j < duplicate.words.length; j++) {
        var word = duplicate.words[j];
        var sourceItem = document.createElement('div');
        sourceItem.className = 'duplicate-source-item';
        sourceItem.innerHTML = '<span class="source-sheet">' + word.sheetName + '</span>: ' + word.chinese;
        wordSources.appendChild(sourceItem);
      }
      
      wordItem.appendChild(wordHeader);
      wordItem.appendChild(wordSources);
      
      var self = this;
      (function(index) {
        wordItem.addEventListener('click', function() {
          self.selectDuplicateWord(index);
        });
      })(i);
      
      container.appendChild(wordItem);
    }
  };
  
  // é¸æ“‡è¦è™•ç†çš„é‡è¤‡å–®å­—
  FlashcardApp.prototype.selectDuplicateWord = function(index) {
    console.log('é¸æ“‡é‡è¤‡å–®å­—ï¼Œç´¢å¼•:', index);
    
    // æ¸…é™¤ä¹‹å‰çš„é¸ä¸­ç‹€æ…‹
    var items = document.querySelectorAll('.duplicate-word-item');
    for (var i = 0; i < items.length; i++) {
      items[i].classList.remove('selected');
    }
    
    // é¸ä¸­ç•¶å‰é …ç›®
    var selectedItem = document.querySelector('[data-index="' + index + '"]');
    if (selectedItem) {
      selectedItem.classList.add('selected');
    }
    
    this.currentDuplicateIndex = index;
    
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    var processBtn = document.getElementById('process-all-duplicates');
    var confirmBtn = document.getElementById('confirm-duplicate-action');
    var nextBtn = document.getElementById('next-duplicate');
    
    if (processBtn) processBtn.style.display = 'none';
    if (confirmBtn) {
      confirmBtn.style.display = 'inline-block';
      confirmBtn.disabled = false;
      confirmBtn.textContent = 'ç¢ºèªæ“ä½œ';
    }
    if (nextBtn) nextBtn.style.display = 'none';
    
    // é¡¯ç¤ºè™•ç†é¸é …
    this.showDuplicateOptions(this.duplicateWords[index]);
  };
  
  // é¡¯ç¤ºé‡è¤‡å–®å­—è™•ç†é¸é …
  FlashcardApp.prototype.showDuplicateOptions = function(duplicate) {
    var actionsDiv = document.getElementById('duplicate-actions');
    var englishSpan = document.getElementById('current-duplicate-english');
    var optionsContainer = document.getElementById('duplicate-options-container');
    
    if (!englishSpan || !optionsContainer) return;
    
    englishSpan.textContent = duplicate.english;
    optionsContainer.innerHTML = '';
    actionsDiv.style.display = 'block';
    
    if (duplicate.isSameDefinition) {
      // å®šç¾©ç›¸åŒï¼šé¸æ“‡ä¿ç•™å“ªä¸€å€‹
      var keepOption = document.createElement('div');
      keepOption.className = 'duplicate-option';
      keepOption.innerHTML = 
        '<div class="option-header">' +
          '<input type="radio" name="duplicate-action" value="keep" class="option-radio" checked>' +
          '<span class="option-title">ä¿ç•™å…¶ä¸­ä¸€å€‹ï¼Œåˆªé™¤å…¶ä»–</span>' +
        '</div>' +
        '<div class="option-description">é¸æ“‡è¦ä¿ç•™çš„å·¥ä½œè¡¨ç‰ˆæœ¬ï¼Œå…¶ä»–ç‰ˆæœ¬å°‡è¢«æ°¸ä¹…åˆªé™¤</div>' +
        '<div class="merge-target-selection" id="keep-target-selection"></div>';
      
      var targetSelection = keepOption.querySelector('#keep-target-selection');
      for (var i = 0; i < duplicate.words.length; i++) {
        var word = duplicate.words[i];
        var targetOption = document.createElement('div');
        targetOption.className = 'merge-target-option';
        targetOption.innerHTML = 
          '<input type="radio" name="keep-target" value="' + i + '" class="merge-target-radio" ' + 
          (i === 0 ? 'checked' : '') + '>' +
          '<span class="merge-target-label">ä¿ç•™ ' + word.sheetName + ': ' + word.chinese + '</span>';
        
        (function(option) {
          targetOption.addEventListener('click', function(e) {
            if (e.target.type !== 'radio') {
              var radio = option.querySelector('input[type="radio"]');
              if (radio) radio.checked = true;
            }
          });
        })(targetOption);
        
        targetSelection.appendChild(targetOption);
      }
      
      optionsContainer.appendChild(keepOption);
          } else {
      // å®šç¾©ä¸åŒï¼šä¿ç•™ä¸€å€‹æˆ–åˆä½µ
      var keepOption = document.createElement('div');
      keepOption.className = 'duplicate-option';
      keepOption.innerHTML = 
        '<div class="option-header">' +
          '<input type="radio" name="duplicate-action" value="keep" class="option-radio" checked>' +
          '<span class="option-title">ä¿ç•™å…¶ä¸­ä¸€å€‹ï¼Œåˆªé™¤å…¶ä»–</span>' +
        '</div>' +
        '<div class="option-description">é¸æ“‡è¦ä¿ç•™çš„å·¥ä½œè¡¨ç‰ˆæœ¬ï¼Œå…¶ä»–ç‰ˆæœ¬å°‡è¢«æ°¸ä¹…åˆªé™¤</div>' +
        '<div class="merge-target-selection" id="keep-target-selection"></div>';
      
      var targetSelection = keepOption.querySelector('#keep-target-selection');
      for (var j = 0; j < duplicate.words.length; j++) {
        var word = duplicate.words[j];
        var targetOption = document.createElement('div');
        targetOption.className = 'merge-target-option';
        targetOption.innerHTML = 
          '<input type="radio" name="keep-target" value="' + j + '" class="merge-target-radio" ' + 
          (j === 0 ? 'checked' : '') + '>' +
          '<span class="merge-target-label">ä¿ç•™ ' + word.sheetName + ': ' + word.chinese + '</span>';
        
        (function(option) {
          targetOption.addEventListener('click', function(e) {
            if (e.target.type !== 'radio') {
              var radio = option.querySelector('input[type="radio"]');
              if (radio) radio.checked = true;
            }
          });
        })(targetOption);
        
        targetSelection.appendChild(targetOption);
      }
      
      var mergeOption = document.createElement('div');
      mergeOption.className = 'duplicate-option';
      mergeOption.innerHTML = 
        '<div class="option-header">' +
          '<input type="radio" name="duplicate-action" value="merge" class="option-radio">' +
          '<span class="option-title">åˆä½µæ‰€æœ‰å®šç¾©</span>' +
        '</div>' +
        '<div class="option-description">å°‡æ‰€æœ‰å®šç¾©åˆä½µåˆ°é¸å®šçš„å·¥ä½œè¡¨ä¸­ï¼Œå…¶ä»–ç‰ˆæœ¬å°‡è¢«åˆªé™¤</div>' +
        '<div class="merge-target-selection" id="merge-target-selection"></div>';
      
      var mergeTargetSelection = mergeOption.querySelector('#merge-target-selection');
      for (var k = 0; k < duplicate.words.length; k++) {
        var word = duplicate.words[k];
        var targetOption = document.createElement('div');
        targetOption.className = 'merge-target-option';
        targetOption.innerHTML = 
          '<input type="radio" name="merge-target" value="' + k + '" class="merge-target-radio" ' + 
          (k === 0 ? 'checked' : '') + '>' +
          '<span class="merge-target-label">åˆä½µåˆ° ' + word.sheetName + '</span>';
        
        (function(option) {
          targetOption.addEventListener('click', function(e) {
            if (e.target.type !== 'radio') {
              var radio = option.querySelector('input[type="radio"]');
              if (radio) radio.checked = true;
            }
          });
        })(targetOption);
        
        mergeTargetSelection.appendChild(targetOption);
      }
      
      optionsContainer.appendChild(keepOption);
      optionsContainer.appendChild(mergeOption);
    }
  };
    
    // ç¢ºèªè™•ç†ç•¶å‰é‡è¤‡é …ç›®
  FlashcardApp.prototype.confirmDuplicateAction = function() {
    var confirmBtn = document.getElementById('confirm-duplicate-action');
      if (confirmBtn && confirmBtn.disabled) {
        console.log('è™•ç†å·²åœ¨é€²è¡Œä¸­ï¼Œå¿½ç•¥é‡è¤‡èª¿ç”¨');
        return;
      }
  
    console.log('ç¢ºèªè™•ç†é‡è¤‡å–®å­—');
      
    var duplicate = this.duplicateWords[this.currentDuplicateIndex];
    var actionRadio = document.querySelector('input[name="duplicate-action"]:checked');
      
      if (!actionRadio) {
        alert('è«‹é¸æ“‡è™•ç†æ–¹å¼');
        return;
      }
      
    var action = actionRadio.value;
    var targetIndex = 0;
      
      if (action === 'keep') {
      var targetRadio = document.querySelector('input[name="keep-target"]:checked');
        if (targetRadio) {
          targetIndex = parseInt(targetRadio.value);
        }
      } else if (action === 'merge') {
      var targetRadio = document.querySelector('input[name="merge-target"]:checked');
        if (targetRadio) {
          targetIndex = parseInt(targetRadio.value);
        }
      }
      
      // é¡¯ç¤ºè™•ç†ä¸­ç‹€æ…‹
      this.showProcessingIndicator();
      
      // æº–å‚™è™•ç†åƒæ•¸
    var targetWord = duplicate.words[targetIndex];
    var otherWords = duplicate.words.filter(function(word, index) { return index !== targetIndex; });
      
      console.log('ç›®æ¨™å–®å­—:', targetWord);
      console.log('è¦åˆªé™¤çš„å–®å­—:', otherWords);
      
      // è¨­ç½®è¶…æ™‚æ©Ÿåˆ¶ï¼Œé˜²æ­¢æ°¸ä¹…å¡ä½
    var self = this;
    var timeoutId = setTimeout(function() {
        console.error('è™•ç†è¶…æ™‚');
      self.showProcessingResult(false, 'è™•ç†è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥å¾Œé‡è©¦');
      }, 30000); // 30ç§’è¶…æ™‚
      
      // å®šç¾©æˆåŠŸè™•ç†å‡½æ•¸
    var handleSuccess = function(result) {
        clearTimeout(timeoutId);
        console.log('è™•ç†æˆåŠŸå›èª¿è¢«è§¸ç™¼ï¼Œçµæœ:', result);
      
      var isSuccess = false;
      var deletedCount = 0;
      var errorMessage = '';
        
        if (result === true || result === 'true') {
          isSuccess = true;
          deletedCount = otherWords.length;
        } else if (result && typeof result === 'object') {
          isSuccess = result.success === true || result.success === 'true';
          deletedCount = result.deletedCount || otherWords.length;
          errorMessage = result.error || '';
        } else if (result && result.toString().toLowerCase() === 'success') {
          isSuccess = true;
          deletedCount = otherWords.length;
        } else {
          console.warn('æœªçŸ¥çš„çµæœæ ¼å¼ï¼Œå˜—è©¦è§£æ:', result);
        isSuccess = !!result;
          deletedCount = isSuccess ? otherWords.length : 0;
        }
        
        console.log('è§£æå¾Œçš„çµæœ - æˆåŠŸ:', isSuccess, 'åˆªé™¤æ•¸é‡:', deletedCount);
        
        if (isSuccess) {
        var message = action === 'merge' 
          ? 'æˆåŠŸåˆä½µåˆ° ' + targetWord.sheetName + 'ï¼Œåˆªé™¤äº† ' + deletedCount + ' å€‹é‡è¤‡é …ç›®'
          : 'æˆåŠŸä¿ç•™ ' + targetWord.sheetName + ' ä¸­çš„å–®å­—ï¼Œåˆªé™¤äº† ' + deletedCount + ' å€‹é‡è¤‡é …ç›®';
        
        self.showProcessingResult(true, message);
        self.duplicateProcessingResults.push({
          duplicate: self.duplicateWords[self.currentDuplicateIndex],
            action: action,
            success: true,
            result: { success: true, deletedCount: deletedCount }
          });
        } else {
        var failureMessage = errorMessage || 'è™•ç†çµæœæ ¼å¼éŒ¯èª¤æˆ–æœªæˆåŠŸ';
        self.showProcessingResult(false, failureMessage);
        self.duplicateProcessingResults.push({
          duplicate: self.duplicateWords[self.currentDuplicateIndex],
            action: action,
            success: false,
            error: failureMessage
          });
        }
      };
      
      // å®šç¾©å¤±æ•—è™•ç†å‡½æ•¸
    var handleFailure = function(error) {
        clearTimeout(timeoutId);
        console.error('è™•ç†å¤±æ•—:', error);
        
      var errorMessage = error && error.message ? error.message : 'æœªçŸ¥éŒ¯èª¤';
      self.showProcessingResult(false, 'è™•ç†å¤±æ•—ï¼š' + errorMessage);
      self.duplicateProcessingResults.push({
        duplicate: self.duplicateWords[self.currentDuplicateIndex],
          action: action,
          success: false,
          error: errorMessage
        });
      };
      
      // æª¢æŸ¥å¿…è¦çš„åƒæ•¸
      if (!this.sheetSettings.sheetId) {
        handleFailure(new Error('Google Sheet ID æœªè¨­å®š'));
        return;
      }
      
      if (!targetWord || !targetWord.sheetName) {
        handleFailure(new Error('ç›®æ¨™å–®å­—è³‡æ–™ä¸å®Œæ•´'));
        return;
      }
      
      // æª¢æŸ¥ Google Apps Script æ˜¯å¦å¯ç”¨
      if (typeof google === 'undefined' || !google.script || !google.script.run) {
        handleFailure(new Error('Google Apps Script ç’°å¢ƒä¸å¯ç”¨'));
        return;
      }
      
      try {
        if (action === 'keep') {
          // ä¿ç•™ä¸€å€‹ï¼Œåˆªé™¤å…¶ä»–
          console.log('èª¿ç”¨ handleDuplicateWordKeepOne');
          google.script.run
            .withSuccessHandler(handleSuccess)
            .withFailureHandler(handleFailure)
            .handleDuplicateWordKeepOne(this.sheetSettings.sheetId, targetWord, otherWords);
        } else if (action === 'merge') {
          // åˆä½µå®šç¾©
          console.log('èª¿ç”¨ handleDuplicateWordMerge');
          google.script.run
            .withSuccessHandler(handleSuccess)
            .withFailureHandler(handleFailure)
            .handleDuplicateWordMerge(this.sheetSettings.sheetId, targetWord, otherWords);
        }
      } catch (error) {
        console.error('èª¿ç”¨ Google Apps Script æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        handleFailure(error);
      }
  };
    
    // é¡¯ç¤ºè™•ç†ä¸­æŒ‡ç¤ºå™¨
  FlashcardApp.prototype.showProcessingIndicator = function() {
    var optionsContainer = document.getElementById('duplicate-options-container');
    optionsContainer.innerHTML = 
      '<div class="processing-indicator">' +
        '<div class="processing-spinner"></div>' +
        '<span class="processing-text">è™•ç†ä¸­...</span>' +
      '</div>';
    
    var confirmBtn = document.getElementById('confirm-duplicate-action');
      if (confirmBtn) {
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'è™•ç†ä¸­...';
      }
      
    var nextBtn = document.getElementById('next-duplicate');
      if (nextBtn) {
        nextBtn.style.display = 'none';
      }
  };
    
    // é¡¯ç¤ºè™•ç†çµæœ
  FlashcardApp.prototype.showProcessingResult = function(success, message) {
    var optionsContainer = document.getElementById('duplicate-options-container');
    optionsContainer.innerHTML = 
      '<div class="' + (success ? 'duplicate-result-success' : 'duplicate-result-error') + '">' +
        message +
      '</div>';
    
      if (success) {
      // å¾é‡è¤‡æ¸…å–®ä¸­ç§»é™¤é€™å€‹é …ç›®
        this.duplicateWords.splice(this.currentDuplicateIndex, 1);
        
        // èª¿æ•´ç•¶å‰ç´¢å¼•
        if (this.currentDuplicateIndex >= this.duplicateWords.length) {
          this.currentDuplicateIndex = this.duplicateWords.length - 1;
        }
        
        // é‡æ–°æ¸²æŸ“é‡è¤‡æ¸…å–®
        this.renderDuplicateWordsList();
        
        // æ›´æ–°é‡è¤‡æ•¸é‡é¡¯ç¤º
      var duplicateCount = document.getElementById('duplicate-count');
        if (duplicateCount) {
          duplicateCount.textContent = this.duplicateWords.length;
        }
      }
      
      // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    var confirmBtn = document.getElementById('confirm-duplicate-action');
    var nextBtn = document.getElementById('next-duplicate');
      
    if (confirmBtn) confirmBtn.style.display = 'none';
    if (nextBtn) {
      nextBtn.style.display = 'inline-block';
      nextBtn.disabled = false;
      
      if (this.duplicateWords.length === 0) {
        nextBtn.textContent = 'å®Œæˆè™•ç†';
      } else if (this.currentDuplicateIndex >= this.duplicateWords.length - 1) {
        nextBtn.textContent = 'å®Œæˆè™•ç†';
      } else {
        nextBtn.textContent = 'ä¸‹ä¸€å€‹';
      }
    }
  };
    
    // è™•ç†ä¸‹ä¸€å€‹é‡è¤‡é …ç›®
  FlashcardApp.prototype.nextDuplicate = function() {
    console.log('è™•ç†ä¸‹ä¸€å€‹é‡è¤‡é …ç›®');
      
      if (this.duplicateWords.length === 0 || this.currentDuplicateIndex >= this.duplicateWords.length) {
        this.finishDuplicateProcessing();
      } else {
      var confirmBtn = document.getElementById('confirm-duplicate-action');
      var nextBtn = document.getElementById('next-duplicate');
      
      if (confirmBtn) {
        confirmBtn.style.display = 'inline-block';
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'ç¢ºèªæ“ä½œ';
      }
      if (nextBtn) nextBtn.style.display = 'none';
      
      this.selectDuplicateWord(this.currentDuplicateIndex);
      }
  };
    
    // å®Œæˆé‡è¤‡è™•ç†
  FlashcardApp.prototype.finishDuplicateProcessing = function() {
      console.log('å®Œæˆé‡è¤‡è™•ç†');
      
      // é¡¯ç¤ºè™•ç†æ‘˜è¦
    var successCount = this.duplicateProcessingResults ? 
      this.duplicateProcessingResults.filter(function(r) { return r.success; }).length : 0;
    var totalCount = this.duplicateProcessingResults ? this.duplicateProcessingResults.length : 0;
      
    alert('é‡è¤‡è™•ç†å®Œæˆï¼\næˆåŠŸè™•ç†: ' + successCount + '/' + totalCount + ' å€‹é‡è¤‡é …ç›®');
      
      // é—œé–‰Modal
      this.closeDuplicateModal();
      
      // é‡æ–°è¼‰å…¥å–®å­—ï¼ˆä»¥åæ˜ æ›´æ”¹ï¼‰
      this.reloadWordsAfterDuplicateProcessing();
  };
    
    // é‡è¤‡è™•ç†å¾Œé‡æ–°è¼‰å…¥å–®å­—
  FlashcardApp.prototype.reloadWordsAfterDuplicateProcessing = function() {
      console.log('é‡è¤‡è™•ç†å¾Œé‡æ–°è¼‰å…¥å–®å­—');
      
      // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    var loadingDiv = document.getElementById('loading');
    var flashcardDiv = document.getElementById('flashcard');
    if (loadingDiv) loadingDiv.style.display = 'flex';
    if (flashcardDiv) flashcardDiv.style.display = 'none';
    
    // é‡æ–°è¼‰å…¥å–®å­—
    var self = this;
    this.loadWords(false, function(hasDuplicates) {
      self.setupEventListeners();
      self.applySettings();
      
      if (!hasDuplicates) {
        self.startNewRound();
      }
      
      if (loadingDiv) loadingDiv.style.display = 'none';
      if (flashcardDiv) flashcardDiv.style.display = 'flex';
    });
  };
  
  // é˜²æ­¢è¢å¹•é—œé–‰åŠŸèƒ½
  FlashcardApp.prototype.enableKeepScreenAwake = function() {
    console.log('å•Ÿç”¨é˜²æ­¢è¢å¹•é—œé–‰åŠŸèƒ½');
    
    // å˜—è©¦ä½¿ç”¨Wake Lock APIï¼ˆæ–°ç‰ˆç€è¦½å™¨ï¼‰
    if (this.tryWakeLockAPI()) {
      console.log('ä½¿ç”¨Wake Lock APIé˜²æ­¢è¢å¹•é—œé–‰');
      return;
    }
    
    // ä½¿ç”¨NoSleep.jsæ–¹æ³•ï¼ˆæ’­æ”¾ç„¡è²è¦–é »ï¼‰
    if (this.tryNoSleepVideo()) {
      console.log('ä½¿ç”¨ç„¡è²è¦–é »é˜²æ­¢è¢å¹•é—œé–‰');
      return;
    }
    
    // å‚™ç”¨æ–¹æ¡ˆï¼šå®šæœŸåŸ·è¡Œæ“ä½œ
    this.tryKeepAliveMethod();
    console.log('ä½¿ç”¨å®šæœŸåŸ·è¡Œæ“ä½œé˜²æ­¢è¢å¹•é—œé–‰');
  };
  
  // å˜—è©¦ä½¿ç”¨Wake Lock API
  FlashcardApp.prototype.tryWakeLockAPI = function() {
    if ('wakeLock' in navigator) {
      var self = this;
      
      navigator.wakeLock.request('screen').then(function(wakeLock) {
        self.wakeLock = wakeLock;
        console.log('Wake Lock API å·²å•Ÿç”¨');
        
        // ç›£è½é é¢å¯è¦‹æ€§è®ŠåŒ–
        document.addEventListener('visibilitychange', function() {
          if (self.wakeLock !== null && document.visibilityState === 'visible') {
            // é é¢é‡æ–°å¯è¦‹æ™‚é‡æ–°è«‹æ±‚Wake Lock
            navigator.wakeLock.request('screen').then(function(wakeLock) {
              self.wakeLock = wakeLock;
            }).catch(function(error) {
              console.log('é‡æ–°è«‹æ±‚Wake Lockå¤±æ•—:', error);
            });
          }
        });
        
        return true;
      }).catch(function(error) {
        console.log('Wake Lock API è«‹æ±‚å¤±æ•—:', error);
        return false;
      });
      
      return true;
    }
    return false;
  };
  
  // å˜—è©¦ä½¿ç”¨NoSleepè¦–é »æ–¹æ³•
  FlashcardApp.prototype.tryNoSleepVideo = function() {
    try {
      // å‰µå»ºç„¡è²è¦–é »å…ƒç´ 
      var video = document.createElement('video');
      video.setAttribute('muted', '');
      video.setAttribute('playsinline', '');
      video.setAttribute('loop', '');
      video.style.position = 'fixed';
      video.style.top = '0';
      video.style.left = '0';
      video.style.width = '1px';
      video.style.height = '1px';
      video.style.opacity = '0';
      video.style.pointerEvents = 'none';
      video.style.zIndex = '-1';
      
      // å‰µå»ºç„¡è²è¦–é »æ•¸æ“šURLï¼ˆ1x1åƒç´ ï¼Œæ¥µçŸ­çš„ç„¡è²è¦–é »ï¼‰
      var videoDataUrl = 'data:video/mp4;base64,AAAAIGZ0eXBtcDQyAAACAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQAAAr1tZGF0AAACrgYF//+q3EXpvebZSLeWLNgg2SPu73gyNjQgLSBjb3JlIDE0OCByMjYwMSBNIGU5YjVmMzMgLSBILjI2NC9NUEVHLTQgQVZDIGNvZGVjIC0gQ29weWxlZnQgMjAwMy0yMDE2IC0gaHR0cDovL3d3dy52aWRlb2xhbi5vcmcveDI2NC5odG1sIC0gb3B0aW9uczogY2FiYWM9MSByZWY9MyBkZWJsb2NrPTE6MDowIGFuYWx5c2U9MHgzOjB4MTEzIG1lPWhleCBzdWJtZT03IHBzeT0xIHBzeV9yZD0xLjAwOjAuMDAgbWl4ZWRfcmVmPTEgbWVfcmFuZ2U9MTYgY2hyb21hX21lPTEgdHJlbGxpcz0xIDh4OGRjdD0xIGNxbT0wIGRlYWR6b25lPTIxLDExIGZhc3RfcHNraXA9MSBjaHJvbWFfcXBfb2Zmc2V0PS0yIHRocmVhZHM9MSBsb29rYWhlYWRfdGhyZWFkcz0xIHNsaWNlZF90aHJlYWRzPTAgbnI9MCBkZWNpbWF0ZT0xIGludGVybGFjZWQ9MCBibHVyYXlfY29tcGF0PTAgY29uc3RyYWluZWRfaW50cmE9MCBicmFtZXM9MyBiX3B5cmFtaWQ9MiBiX2FkYXB0PTEgYl9iaWFzPTAgZGlyZWN0PTEgd2VpZ2h0Yj0xIG9wZW5fZ29wPTAgd2VpZ2h0cD0yIGtleWludD0yNTAga2V5aW50X21pbj0yNSBzY2VuZWN1dD00MCBpbnRyYV9yZWZyZXNoPTAgcmNfbG9va2FoZWFkPTQwIHJjPWNyZiBtYnRyZWU9MSBjcmY9MjMuMCBxY29tcD0wLjYwIHFwbWluPTAgcXBtYXg9NjkgcXBzdGVwPTQgaXBfcmF0aW89MS40MCBhcT0xOjEuMDAAgAAAAFZliIQL8mKAAKvMnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycH//2Q==';
      
      video.src = videoDataUrl;
      
      // æ·»åŠ åˆ°DOM
      document.body.appendChild(video);
      this.noSleepVideo = video;
      
      // å˜—è©¦æ’­æ”¾
      var self = this;
      video.play().then(function() {
        console.log('NoSleepè¦–é »å·²é–‹å§‹æ’­æ”¾');
        self.keepScreenAwake = true;
      }).catch(function(error) {
        console.log('NoSleepè¦–é »æ’­æ”¾å¤±æ•—:', error);
        // æ¸…ç†å¤±æ•—çš„è¦–é »å…ƒç´ 
        if (self.noSleepVideo && self.noSleepVideo.parentNode) {
          self.noSleepVideo.parentNode.removeChild(self.noSleepVideo);
        }
        self.noSleepVideo = null;
        return false;
      });
      
      return true;
    } catch (error) {
      console.log('å‰µå»ºNoSleepè¦–é »å¤±æ•—:', error);
      return false;
    }
  };
  
  // å‚™ç”¨æ–¹æ¡ˆï¼šå®šæœŸåŸ·è¡Œæ“ä½œ
  FlashcardApp.prototype.tryKeepAliveMethod = function() {
    var self = this;
    
    // æ¯30ç§’åŸ·è¡Œä¸€æ¬¡æ“ä½œä¾†ä¿æŒæ´»å‹•ç‹€æ…‹
    setInterval(function() {
      if (self.keepScreenAwake !== false) {
        // å‰µå»ºä¸€å€‹æ¥µå°çš„éŸ³é »ä¸Šä¸‹æ–‡ä¸¦ç«‹å³é—œé–‰
        try {
          var audioContext = new (window.AudioContext || window.webkitAudioContext)();
          var oscillator = audioContext.createOscillator();
          var gainNode = audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          // è¨­ç½®æ¥µä½çš„éŸ³é‡
          gainNode.gain.value = 0.001;
          
          // æ’­æ”¾æ¥µçŸ­çš„ç„¡è²éŸ³é »
          oscillator.frequency.value = 20000; // äººè€³è½ä¸åˆ°çš„é«˜é »
          oscillator.start();
          oscillator.stop(audioContext.currentTime + 0.001);
          
          // é—œé–‰éŸ³é »ä¸Šä¸‹æ–‡
          setTimeout(function() {
            audioContext.close();
          }, 10);
        } catch (error) {
          // éœé»˜å¿½ç•¥éŒ¯èª¤
        }
        
        // è§¸ç™¼ä¸€å€‹æ¥µå°çš„DOMæ“ä½œ
        try {
          var dummyDiv = document.createElement('div');
          dummyDiv.style.position = 'fixed';
          dummyDiv.style.top = '-1px';
          dummyDiv.style.left = '-1px';
          dummyDiv.style.width = '1px';
          dummyDiv.style.height = '1px';
          dummyDiv.style.opacity = '0';
          document.body.appendChild(dummyDiv);
          
          setTimeout(function() {
            if (dummyDiv.parentNode) {
              dummyDiv.parentNode.removeChild(dummyDiv);
            }
          }, 1);
        } catch (error) {
          // éœé»˜å¿½ç•¥éŒ¯èª¤
        }
      }
    }, 30000); // æ¯30ç§’åŸ·è¡Œä¸€æ¬¡
  };
  
  // ==========================================================================
  // æ¸¬é©—åŠŸèƒ½ç›¸é—œæ–¹æ³• (Quiz Functions)
  // ==========================================================================
  
  // è¨­ç½®æ¸¬é©—æ¨¡æ…‹æ¡†äº‹ä»¶ç›£è½å™¨
  FlashcardApp.prototype.setupQuizListeners = function() {
    var self = this;
    
    // æ¸¬é©—æ¨¡æ…‹æ¡†å…ƒç´ 
    var quizModal = document.getElementById('quiz-modal');
    var closeQuizBtn = document.getElementById('close-quiz');
    var quizStartBtn = document.getElementById('quiz-start');
    var quizNextBtn = document.getElementById('quiz-next');
    var quizRestartBtn = document.getElementById('quiz-restart');
    var quizFinishBtn = document.getElementById('quiz-finish');
    
    // é—œé–‰æŒ‰éˆ•äº‹ä»¶
    if (closeQuizBtn) {
      closeQuizBtn.addEventListener('click', function() { self.closeQuizModal(); });
    }
    
    // æ¸¬é©—æµç¨‹æŒ‰éˆ•äº‹ä»¶
    if (quizStartBtn) {
      quizStartBtn.addEventListener('click', function() { self.beginQuiz(); });
    }
    if (quizNextBtn) {
      quizNextBtn.addEventListener('click', function() { self.nextQuestion(); });
    }
    if (quizRestartBtn) {
      quizRestartBtn.addEventListener('click', function() { self.restartQuiz(); });
    }
    if (quizFinishBtn) {
      quizFinishBtn.addEventListener('click', function() { self.closeQuizModal(); });
    }
    
    // æ¨¡æ…‹æ¡†é»æ“Šå¤–éƒ¨é—œé–‰ï¼ˆä½†åœ¨æ¸¬é©—é€²è¡Œä¸­ç¦ç”¨ï¼‰
    if (quizModal) {
      quizModal.addEventListener('click', function(e) {
        // æª¢æŸ¥æ˜¯å¦åœ¨æ¸¬é©—é€²è¡Œä¸­
        if (self.isQuizInProgress()) {
          console.log('æ¸¬é©—é€²è¡Œä¸­ï¼Œç¦ç”¨èƒŒæ™¯é»æ“Šé—œé–‰');
          return; // æ¸¬é©—é€²è¡Œä¸­ä¸å…è¨±èƒŒæ™¯é»æ“Šé—œé–‰
        }
        
        // æª¢æŸ¥é»æ“Šç›®æ¨™ï¼Œæ’é™¤selectå…ƒç´ åŠå…¶ç›¸é—œå…ƒç´ 
        var target = e.target;
        var isSelectRelated = false;
        
        var element = target;
        while (element && element !== quizModal) {
          if (element.tagName === 'SELECT' || 
              element.tagName === 'OPTION' ||
              element.classList.contains('setting-control')) {
            isSelectRelated = true;
            break;
          }
          element = element.parentElement;
        }
        
        if (e.target === quizModal && !isSelectRelated) {
          console.log('éæ¸¬é©—é€²è¡Œä¸­ï¼Œå…è¨±èƒŒæ™¯é»æ“Šé—œé–‰');
          self.closeQuizModal();
        }
      });
    }
  };
  
  // é–‹å§‹æ¸¬é©—
  FlashcardApp.prototype.startQuiz = function(type) {
    console.log('é–‹å§‹æ¸¬é©—ï¼Œé¡å‹:', type);
    
    // æª¢æŸ¥æ˜¯å¦æœ‰å–®å­—å¯ä»¥æ¸¬é©—
    if (!this.words || this.words.length === 0) {
      alert('æ²’æœ‰å–®å­—å¯ä»¥æ¸¬é©—ï¼è«‹å…ˆè¼‰å…¥å–®å­—ã€‚');
      return;
    }
    
    // æª¢æŸ¥ç•¶å‰å¯ç”¨çš„å–®å­—ï¼ˆè€ƒæ…®ç¯©é¸æ¢ä»¶å’Œæš«æ™‚åˆªé™¤ï¼‰
    var availableWords = this.getCurrentAvailableWords();
    if (availableWords.length === 0) {
      var message = this.getNoWordsMessage();
      alert(message);
      return;
    }
    
    // æª¢æŸ¥å¿«é€Ÿæ¸¬é©—çš„å–®å­—æ•¸é‡
    if (type === 'quick' && availableWords.length < 3) {
      alert('å¯ç”¨å–®å­—å¤ªå°‘ï¼ˆå°‘æ–¼3å€‹ï¼‰ï¼Œç„¡æ³•é€²è¡Œæ¸¬é©—ã€‚è«‹å¢åŠ æ›´å¤šå–®å­—æˆ–èª¿æ•´ç¯©é¸æ¢ä»¶ã€‚');
      return;
    }
    
    // æš«åœé–ƒå¡æ’­æ”¾
    this.pauseTimer();
    
    // è¨­ç½®æ¸¬é©—ç‹€æ…‹
    this.quizState = {
      isActive: true,
      type: type,
      questions: [],
      currentQuestionIndex: 0,
      selectedAnswer: null,
      answers: [],
      score: 0,
      startTime: new Date(),
      endTime: null,
      availableWords: availableWords
    };
    
    // ç”Ÿæˆæ¸¬é©—é¡Œç›®
    this.generateQuestions(type);
    
    // é¡¯ç¤ºæ¸¬é©—æ¨¡æ…‹æ¡†
    this.showQuizModal(type);
  };
  
  // ç²å–ç•¶å‰å¯ç”¨çš„å–®å­—ï¼ˆè€ƒæ…®ç¯©é¸å’Œåˆªé™¤ç‹€æ…‹ï¼‰
  FlashcardApp.prototype.getCurrentAvailableWords = function() {
    // ä½¿ç”¨ currentWordsï¼Œå®ƒå·²ç¶“è€ƒæ…®äº†ï¼š
    // 1. "åªé¡¯ç¤ºä¸ç†Ÿå–®å­—" çš„ç¯©é¸
    // 2. æš«æ™‚åˆªé™¤çš„å–®å­—
    return this.currentWords ? this.currentWords.slice() : [];
  };
  
  // ç²å–æ²’æœ‰å¯ç”¨å–®å­—æ™‚çš„æç¤ºä¿¡æ¯
  FlashcardApp.prototype.getNoWordsMessage = function() {
    if (this.showDifficultOnly) {
      return 'æ²’æœ‰ä¸ç†Ÿå–®å­—å¯ä»¥æ¸¬é©—ï¼\n\nè«‹å…ˆå­¸ç¿’ä¸€äº›å–®å­—ï¼Œæˆ–å–æ¶ˆã€Œåªé¡¯ç¤ºä¸ç†Ÿå–®å­—ã€é¸é …ã€‚';
    } else if (this.currentWords && this.currentWords.length === 0 && this.words && this.words.length > 0) {
      return 'æ‰€æœ‰å–®å­—éƒ½å·²è¢«æš«æ™‚ç§»é™¤ï¼\n\nè«‹é»æ“Šã€Œæ¢å¾©å–®å­—ã€æŒ‰éˆ•æˆ–é‡æ–°è¼‰å…¥å–®å­—ã€‚';
    } else {
      return 'æ²’æœ‰å–®å­—å¯ä»¥æ¸¬é©—ï¼è«‹å…ˆè¼‰å…¥å–®å­—ã€‚';
    }
  };
  
  // ç”Ÿæˆæ¸¬é©—é¡Œç›®
  FlashcardApp.prototype.generateQuestions = function(type) {
    console.log('ç”Ÿæˆæ¸¬é©—é¡Œç›®ï¼Œé¡å‹:', type);
    
    // ä½¿ç”¨ç•¶å‰å¯ç”¨çš„å–®å­—ï¼ˆå·²è€ƒæ…®ç¯©é¸æ¢ä»¶å’Œåˆªé™¤ç‹€æ…‹ï¼‰
    var availableWords = this.quizState.availableWords.slice();
    
    // æ‰€æœ‰æ¸¬é©—é¡å‹éƒ½éš¨æ©ŸåŒ–é †åº
    console.log('æ´—ç‰Œå‰å–®å­—é †åº:', availableWords.map(function(w, i) { return i + ':' + w.english; }).slice(0, 5));
    this.shuffleArray(availableWords);
    console.log('æ´—ç‰Œå¾Œå–®å­—é †åº:', availableWords.map(function(w, i) { return i + ':' + w.english; }).slice(0, 5));
    
    // æ ¹æ“šæ¸¬é©—é¡å‹æ±ºå®šé¡Œç›®æ•¸é‡
    var questionCount = type === 'quick' ? Math.min(10, availableWords.length) : availableWords.length;
    
    // å¿«é€Ÿæ¸¬é©—åªå–å‰Nå€‹ï¼ˆå·²éš¨æ©Ÿæ´—ç‰Œï¼‰
    if (type === 'quick' && availableWords.length > 10) {
      availableWords = availableWords.slice(0, 10);
    }
    
    // ç”Ÿæˆé¡Œç›®
    this.quizState.questions = [];
    for (var i = 0; i < availableWords.length; i++) {
      var word = availableWords[i];
      // ä½¿ç”¨æ‰€æœ‰åŸå§‹å–®å­—ä½œç‚ºé¸é …æ± ï¼ˆç¢ºä¿æœ‰è¶³å¤ çš„éŒ¯èª¤é¸é …ï¼‰
      var question = this.createQuestion(word, this.words);
      if (question) {
        this.quizState.questions.push(question);
      }
    }
    
    console.log('ç”Ÿæˆäº†', this.quizState.questions.length, 'é“é¡Œç›®');
  };
  
  // å‰µå»ºå–®å€‹é¡Œç›®
  FlashcardApp.prototype.createQuestion = function(targetWord, allWords) {
    // éš¨æ©Ÿæ±ºå®šé¡Œå‹ï¼šè‹±è­¯ä¸­ æˆ– ä¸­è­¯è‹±
    var isEnglishToChinese = Math.random() < 0.5;
    
    var question = {
      word: targetWord,
      type: isEnglishToChinese ? 'en-zh' : 'zh-en',
      question: isEnglishToChinese ? targetWord.english : targetWord.chinese,
      correctAnswer: isEnglishToChinese ? targetWord.chinese : targetWord.english,
      options: []
    };
    
    // ç”ŸæˆéŒ¯èª¤é¸é …
    var wrongOptions = [];
    var attempts = 0;
    var maxAttempts = 100;
    
    while (wrongOptions.length < 3 && attempts < maxAttempts) {
      attempts++;
      var randomWord = allWords[Math.floor(Math.random() * allWords.length)];
      var wrongAnswer = isEnglishToChinese ? randomWord.chinese : randomWord.english;
      
      // ç¢ºä¿éŒ¯èª¤é¸é …ä¸é‡è¤‡ä¸”ä¸ç­‰æ–¼æ­£ç¢ºç­”æ¡ˆ
      if (wrongAnswer !== question.correctAnswer && 
          wrongOptions.indexOf(wrongAnswer) === -1) {
        wrongOptions.push(wrongAnswer);
      }
    }
    
    // å¦‚æœæ²’æœ‰è¶³å¤ çš„éŒ¯èª¤é¸é …ï¼Œè£œå……ä¸€äº›é€šç”¨é¸é …
    while (wrongOptions.length < 3) {
      var genericOptions = isEnglishToChinese ? 
        ['æ¡Œå­', 'é›»è…¦', 'æ›¸æœ¬', 'æ°´æœ', 'å‹•ç‰©', 'é¡è‰²', 'å¤©æ°£', 'æ™‚é–“'] :
        ['table', 'computer', 'book', 'fruit', 'animal', 'color', 'weather', 'time'];
      
      for (var i = 0; i < genericOptions.length && wrongOptions.length < 3; i++) {
        var option = genericOptions[i];
        if (option !== question.correctAnswer && wrongOptions.indexOf(option) === -1) {
          wrongOptions.push(option);
        }
      }
      break; // é¿å…ç„¡é™å¾ªç’°
    }
    
    // çµ„åˆæ‰€æœ‰é¸é …ä¸¦æ´—ç‰Œ
    question.options = [question.correctAnswer].concat(wrongOptions);
    this.shuffleArray(question.options);
    
    return question;
  };
  
  // é¡¯ç¤ºæ¸¬é©—æ¨¡æ…‹æ¡†
  FlashcardApp.prototype.showQuizModal = function(type) {
    var modal = document.getElementById('quiz-modal');
    var title = document.getElementById('quiz-title');
    var questionCount = document.getElementById('quiz-question-count');
    var introTitle = document.getElementById('quiz-intro-title');
    var introDescription = document.getElementById('quiz-intro-description');
    var scopeInfo = document.getElementById('quiz-scope-info');
    
    if (modal) {
      modal.style.display = 'flex';
    }
    
    // è¨­ç½®æ¨™é¡Œå’Œèªªæ˜
    if (title) {
      title.textContent = type === 'quick' ? 'ğŸ¯ å¿«é€Ÿæ¸¬é©—' : 'ğŸ“ å®Œæ•´æ¸¬é©—';
    }
    if (questionCount) {
      questionCount.textContent = this.quizState.questions.length;
    }
    if (introTitle) {
      var titleText = type === 'quick' ? 'æº–å‚™é–‹å§‹å¿«é€Ÿæ¸¬é©—ï¼' : 'æº–å‚™é–‹å§‹å®Œæ•´æ¸¬é©—ï¼';
      introTitle.textContent = titleText;
    }
    if (introDescription) {
      var description = type === 'quick' ? 
        'å¿«é€Ÿæª¢æ¸¬ä½ å°è‹±æ–‡å–®å­—çš„æŒæ¡ç¨‹åº¦ï¼' : 
        'å…¨é¢æ¸¬è©¦ä½ å­¸ç¿’çš„è‹±æ–‡å–®å­—ï¼';
      introDescription.textContent = description;
    }
    if (scopeInfo) {
      scopeInfo.textContent = this.getQuizScopeText();
    }
    
    // é¡¯ç¤ºé–‹å§‹ç•«é¢
    this.showQuizScreen('start');
  };
  
  // ç²å–æ¸¬é©—ç¯„åœæ–‡å­—
  FlashcardApp.prototype.getQuizScopeText = function() {
    var questionCount = this.quizState.questions.length;
    
    // æ ¹æ“šç•¶å‰ç‹€æ…‹è¿”å›ç¯„åœèªªæ˜
    if (this.showDifficultOnly) {
      return 'ğŸ“š æ¸¬é©—ç¯„åœï¼šä¸ç†Ÿå–®å­— (' + questionCount + ' é¡Œ)';
    } else if (this.currentWords.length < this.words.length) {
      var removedCount = this.words.length - this.currentWords.length;
      return 'ğŸ“– æ¸¬é©—ç¯„åœï¼šå‰©é¤˜å–®å­— (' + questionCount + ' é¡Œï¼Œå·²æ’é™¤ ' + removedCount + ' å€‹)';
    } else {
      return 'ğŸ“— æ¸¬é©—ç¯„åœï¼šæ‰€æœ‰å–®å­— (' + questionCount + ' é¡Œ)';
    }
  };
  
  // é—œé–‰æ¸¬é©—æ¨¡æ…‹æ¡†
  FlashcardApp.prototype.closeQuizModal = function() {
    var modal = document.getElementById('quiz-modal');
    if (modal) {
      modal.style.display = 'none';
    }
    
    // é‡ç½®æ¸¬é©—ç‹€æ…‹
    this.quizState.isActive = false;
    
    // æ¢å¾©é–ƒå¡æ’­æ”¾
    this.resumeTimer();
  };
  
  // é¡¯ç¤ºæ¸¬é©—ç•«é¢
  FlashcardApp.prototype.showQuizScreen = function(screenType) {
    // éš±è—æ‰€æœ‰ç•«é¢
    var screens = ['quiz-start-screen', 'quiz-progress-screen', 'quiz-result-screen'];
    for (var i = 0; i < screens.length; i++) {
      var screen = document.getElementById(screens[i]);
      if (screen) {
        screen.style.display = 'none';
      }
    }
    
    // éš±è—æ‰€æœ‰æŒ‰éˆ•
    var buttons = ['quiz-start', 'quiz-next', 'quiz-restart', 'quiz-finish'];
    for (var i = 0; i < buttons.length; i++) {
      var btn = document.getElementById(buttons[i]);
      if (btn) {
        btn.style.display = 'none';
      }
    }
    
    // é¡¯ç¤ºæŒ‡å®šç•«é¢å’Œç›¸æ‡‰æŒ‰éˆ•
    var targetScreen = document.getElementById('quiz-' + screenType + '-screen');
    if (targetScreen) {
      targetScreen.style.display = 'block';
    }
    
    // æ ¹æ“šç•«é¢é¡å‹é¡¯ç¤ºç›¸æ‡‰æŒ‰éˆ•
    if (screenType === 'start') {
      var startBtn = document.getElementById('quiz-start');
      if (startBtn) {
        startBtn.style.display = 'inline-block';
      }
    } else if (screenType === 'progress') {
      var nextBtn = document.getElementById('quiz-next');
      if (nextBtn) {
        nextBtn.style.display = 'inline-block';
        nextBtn.style.display = 'none'; // åˆå§‹éš±è—ï¼Œç­”é¡Œå¾Œé¡¯ç¤º
      }
    } else if (screenType === 'result') {
      var restartBtn = document.getElementById('quiz-restart');
      var finishBtn = document.getElementById('quiz-finish');
      if (restartBtn) {
        restartBtn.style.display = 'inline-block';
      }
      if (finishBtn) {
        finishBtn.style.display = 'inline-block';
      }
    }
  };
  
  // é–‹å§‹ç­”é¡Œ
  FlashcardApp.prototype.beginQuiz = function() {
    console.log('é–‹å§‹ç­”é¡Œ');
    
    if (this.quizState.questions.length === 0) {
      alert('æ²’æœ‰é¡Œç›®å¯ä»¥æ¸¬é©—ï¼');
      return;
    }
    
    this.quizState.currentQuestionIndex = 0;
    this.quizState.answers = [];
    this.quizState.score = 0;
    
    this.showQuizScreen('progress');
    this.showQuestion();
  };
  
  // é¡¯ç¤ºç•¶å‰é¡Œç›®
  FlashcardApp.prototype.showQuestion = function() {
    var currentQuestion = this.quizState.questions[this.quizState.currentQuestionIndex];
    if (!currentQuestion) return;
    
    console.log('é¡¯ç¤ºé¡Œç›®:', this.quizState.currentQuestionIndex + 1);
    
    // æ›´æ–°é€²åº¦ä¿¡æ¯
    var currentNum = document.getElementById('quiz-current-number');
    var totalNum = document.getElementById('quiz-total-number');
    var currentScore = document.getElementById('quiz-current-score');
    var progressFill = document.getElementById('quiz-progress-fill');
    
    if (currentNum) {
      currentNum.textContent = this.quizState.currentQuestionIndex + 1;
    }
    if (totalNum) {
      totalNum.textContent = this.quizState.questions.length;
    }
    if (currentScore) {
      currentScore.textContent = this.quizState.score;
    }
    if (progressFill) {
      var progress = (this.quizState.currentQuestionIndex / this.quizState.questions.length) * 100;
      progressFill.style.width = progress + '%';
    }
    
    // æ›´æ–°é¡Œç›®å…§å®¹
    var quizWord = document.getElementById('quiz-word');
    
    if (quizWord) {
      quizWord.textContent = currentQuestion.question;
    }
    
    // ç”Ÿæˆé¸é …æŒ‰éˆ•
    this.renderQuizOptions(currentQuestion);
    
    // éš±è—å›é¥‹å’Œä¸‹ä¸€é¡ŒæŒ‰éˆ•
    var feedback = document.getElementById('quiz-feedback');
    var nextBtn = document.getElementById('quiz-next');
    if (feedback) {
      feedback.style.display = 'none';
    }
    if (nextBtn) {
      nextBtn.style.display = 'none';
    }
    
    // é‡ç½®é¸æ“‡ç‹€æ…‹
    this.quizState.selectedAnswer = null;
  };
  
  // æ¸²æŸ“æ¸¬é©—é¸é …
  FlashcardApp.prototype.renderQuizOptions = function(question) {
    var optionsContainer = document.getElementById('quiz-options');
    if (!optionsContainer) return;
    
    optionsContainer.innerHTML = '';
    
    var self = this;
    var letters = ['A', 'B', 'C', 'D'];
    
    for (var i = 0; i < question.options.length; i++) {
      var option = question.options[i];
      var optionBtn = document.createElement('button');
      optionBtn.className = 'quiz-option';
      optionBtn.innerHTML = '<span class="quiz-option-letter">' + letters[i] + '</span>' + option;
      optionBtn.setAttribute('data-answer', option);
      
      (function(answer) {
        optionBtn.addEventListener('click', function() {
          self.selectAnswer(answer);
        });
      })(option);
      
      optionsContainer.appendChild(optionBtn);
    }
  };
  
  // é¸æ“‡ç­”æ¡ˆ
  FlashcardApp.prototype.selectAnswer = function(selectedAnswer) {
    console.log('é¸æ“‡ç­”æ¡ˆ:', selectedAnswer);
    
    if (this.quizState.selectedAnswer !== null) {
      return; // å·²ç¶“é¸æ“‡éç­”æ¡ˆ
    }
    
    this.quizState.selectedAnswer = selectedAnswer;
    
    var currentQuestion = this.quizState.questions[this.quizState.currentQuestionIndex];
    var isCorrect = selectedAnswer === currentQuestion.correctAnswer;
    
    // è¨˜éŒ„ç­”æ¡ˆ
    this.quizState.answers.push({
      question: currentQuestion,
      selectedAnswer: selectedAnswer,
      isCorrect: isCorrect
    });
    
    if (isCorrect) {
      this.quizState.score += 10; // æ¯é¡Œ10åˆ†
    }
    
    // æ›´æ–°é¸é …æ¨£å¼
    this.updateOptionStyles(currentQuestion.correctAnswer, selectedAnswer);
    
    // é¡¯ç¤ºå›é¥‹
    this.showAnswerFeedback(isCorrect, currentQuestion);
    
    // å¦‚æœæ˜¯éŒ¯èª¤ç­”æ¡ˆï¼Œæ¨™è¨˜ç‚ºå›°é›£å–®å­—
    if (!isCorrect) {
      this.markWordAsDifficult(currentQuestion.word);
    }
    
    // é¡¯ç¤ºä¸‹ä¸€é¡ŒæŒ‰éˆ•æˆ–çµæŸæ¸¬é©—
    this.showNextButton();
  };
  
  // æ›´æ–°é¸é …æ¨£å¼
  FlashcardApp.prototype.updateOptionStyles = function(correctAnswer, selectedAnswer) {
    var options = document.querySelectorAll('.quiz-option');
    
    for (var i = 0; i < options.length; i++) {
      var option = options[i];
      var optionAnswer = option.getAttribute('data-answer');
      
      option.classList.add('disabled');
      
      if (optionAnswer === correctAnswer) {
        option.classList.add('correct');
      } else if (optionAnswer === selectedAnswer) {
        option.classList.add('wrong');
      }
    }
  };
  
  // é¡¯ç¤ºç­”æ¡ˆå›é¥‹
  FlashcardApp.prototype.showAnswerFeedback = function(isCorrect, question) {
    var feedback = document.getElementById('quiz-feedback');
    var feedbackResult = document.getElementById('quiz-feedback-result');
    var feedbackExplanation = document.getElementById('quiz-feedback-explanation');
    
    if (!feedback) return;
    
    feedback.className = 'quiz-feedback ' + (isCorrect ? 'correct' : 'wrong');
    feedback.style.display = 'block';
    
    if (feedbackResult) {
      feedbackResult.textContent = isCorrect ? 'âœ… ç­”å°äº†ï¼' : 'âŒ ç­”éŒ¯äº†ï¼';
    }
    
    if (feedbackExplanation) {
      var explanation = question.word.english + ' çš„æ„æ€æ˜¯ã€Œ' + question.word.chinese + 'ã€';
      feedbackExplanation.textContent = explanation;
    }
    
    // æ’­æ”¾èªéŸ³ï¼ˆå¦‚æœæ˜¯è‹±æ–‡å–®å­—ï¼‰
    if (this.voiceSettings.enabled) {
      var self = this;
      setTimeout(function() {
        self.speakWord(question.word.english);
      }, 500);
    }
  };
  
  // é¡¯ç¤ºä¸‹ä¸€é¡ŒæŒ‰éˆ•
  FlashcardApp.prototype.showNextButton = function() {
    var nextBtn = document.getElementById('quiz-next');
    if (nextBtn) {
      var isLastQuestion = this.quizState.currentQuestionIndex >= this.quizState.questions.length - 1;
      nextBtn.textContent = isLastQuestion ? 'æŸ¥çœ‹çµæœ' : 'ä¸‹ä¸€é¡Œ';
      nextBtn.style.display = 'inline-block';
    }
  };
  
  // ä¸‹ä¸€é¡Œæˆ–é¡¯ç¤ºçµæœ
  FlashcardApp.prototype.nextQuestion = function() {
    this.quizState.currentQuestionIndex++;
    
    if (this.quizState.currentQuestionIndex >= this.quizState.questions.length) {
      // æ¸¬é©—çµæŸï¼Œé¡¯ç¤ºçµæœ
      this.showQuizResult();
    } else {
      // é¡¯ç¤ºä¸‹ä¸€é¡Œ
      this.showQuestion();
    }
  };
  
  // é¡¯ç¤ºæ¸¬é©—çµæœ
  FlashcardApp.prototype.showQuizResult = function() {
    console.log('é¡¯ç¤ºæ¸¬é©—çµæœ');
    
    this.quizState.endTime = new Date();
    
    var totalQuestions = this.quizState.questions.length;
    var correctCount = this.quizState.answers.filter(function(a) { return a.isCorrect; }).length;
    var wrongCount = totalQuestions - correctCount;
    var finalScore = Math.round((correctCount / totalQuestions) * 100);
    
    // æ›´æ–°çµæœé¡¯ç¤º
    var resultIcon = document.getElementById('quiz-result-icon');
    var resultTitle = document.getElementById('quiz-result-title');
    var finalScoreElement = document.getElementById('quiz-final-score');
    var correctCountElement = document.getElementById('quiz-correct-count');
    var wrongCountElement = document.getElementById('quiz-wrong-count');
    var resultMessage = document.getElementById('quiz-result-message');
    
    if (resultIcon) {
      if (finalScore >= 90) {
        resultIcon.textContent = 'ğŸ†';
      } else if (finalScore >= 80) {
        resultIcon.textContent = 'ğŸ‰';
      } else if (finalScore >= 70) {
        resultIcon.textContent = 'ğŸ‘';
      } else {
        resultIcon.textContent = 'ğŸ’ª';
      }
    }
    
    if (resultTitle) {
      resultTitle.textContent = 'æ¸¬é©—å®Œæˆï¼';
    }
    
    if (finalScoreElement) {
      finalScoreElement.textContent = finalScore;
    }
    
    if (correctCountElement) {
      correctCountElement.textContent = correctCount;
    }
    
    if (wrongCountElement) {
      wrongCountElement.textContent = wrongCount;
    }
    
    if (resultMessage) {
      var message = this.getResultMessage(finalScore);
      resultMessage.textContent = message;
    }
    
    // é¡¯ç¤ºéŒ¯é¡Œå›é¡§
    this.showWrongReview();
    
    this.showQuizScreen('result');
  };
  
  // ç²å–çµæœè©•èª
  FlashcardApp.prototype.getResultMessage = function(score) {
    if (score >= 90) {
      return 'å¤ªæ£’äº†ï¼ä½ æ˜¯è‹±æ–‡å–®å­—å°é«˜æ‰‹ï¼ğŸ†';
    } else if (score >= 80) {
      return 'å¾ˆå¥½ï¼ä½ çš„è‹±æ–‡å–®å­—æŒæ¡å¾—ä¸éŒ¯ï¼ğŸ‘';
    } else if (score >= 70) {
      return 'ä¸éŒ¯å“¦ï¼ç¹¼çºŒåŠªåŠ›å°±æœƒæ›´æ£’ï¼ğŸ’ª';
    } else if (score >= 60) {
      return 'é‚„å¯ä»¥ï¼å¤šå¤šç·´ç¿’æœƒé€²æ­¥çš„ï¼ğŸ“š';
    } else {
      return 'åŠ æ²¹ï¼å¤šè®€å¤šç·´ç¿’ä¸€å®šæœƒé€²æ­¥çš„ï¼ğŸŒŸ';
    }
  };
  
  // é¡¯ç¤ºéŒ¯é¡Œå›é¡§
  FlashcardApp.prototype.showWrongReview = function() {
    var wrongAnswers = this.quizState.answers.filter(function(a) { return !a.isCorrect; });
    var wrongReview = document.getElementById('quiz-wrong-review');
    var wrongList = document.getElementById('quiz-wrong-list');
    
    if (wrongAnswers.length === 0) {
      if (wrongReview) {
        wrongReview.style.display = 'none';
      }
      return;
    }
    
    if (wrongReview) {
      wrongReview.style.display = 'block';
    }
    
    if (wrongList) {
      wrongList.innerHTML = '';
      
      for (var i = 0; i < wrongAnswers.length; i++) {
        var answer = wrongAnswers[i];
        var item = document.createElement('div');
        item.className = 'quiz-wrong-item';
        
        item.innerHTML = 
          '<div class="quiz-wrong-word">' + answer.question.word.english + '</div>' +
          '<div>' +
            '<div class="quiz-wrong-answer">ä½ çš„ç­”æ¡ˆï¼š' + answer.selectedAnswer + '</div>' +
            '<div class="quiz-wrong-correct">æ­£ç¢ºç­”æ¡ˆï¼š' + answer.question.correctAnswer + '</div>' +
          '</div>';
        
        wrongList.appendChild(item);
      }
    }
  };
  
  // æ¨™è¨˜å–®å­—ç‚ºå›°é›£
  FlashcardApp.prototype.markWordAsDifficult = function(word) {
    if (!this.difficultWords.includes(word.id)) {
      this.difficultWords.push(word.id);
      console.log('æ¨™è¨˜å›°é›£å–®å­—:', word.english);
      
      // åŒæ­¥åˆ°å¾Œç«¯
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        var rowIndex = word.originalRowIndex;
        if (rowIndex === undefined) {
          rowIndex = this.words.findIndex(function(w) {
            return w.english === word.english && w.chinese === word.chinese;
          });
        }
        
        if (rowIndex !== -1) {
          var sheetId = this.sheetSettings.sheetId;
          var sheetName = word.sheetName || 'Sheet1';
          google.script.run.markWordAsDifficult(sheetId, sheetName, rowIndex, '*');
        }
      }
    }
  };
  
  // é‡æ–°é–‹å§‹æ¸¬é©—
  FlashcardApp.prototype.restartQuiz = function() {
    console.log('é‡æ–°é–‹å§‹æ¸¬é©—');
    
    // é‡æ–°ç²å–ç•¶å‰å¯ç”¨çš„å–®å­—ï¼ˆå¯èƒ½å·²ç¶“è®ŠåŒ–ï¼‰
    var availableWords = this.getCurrentAvailableWords();
    if (availableWords.length === 0) {
      var message = this.getNoWordsMessage();
      alert(message);
      this.closeQuizModal();
      return;
    }
    
    // æª¢æŸ¥å¿«é€Ÿæ¸¬é©—çš„å–®å­—æ•¸é‡
    if (this.quizState.type === 'quick' && availableWords.length < 3) {
      alert('å¯ç”¨å–®å­—å¤ªå°‘ï¼ˆå°‘æ–¼3å€‹ï¼‰ï¼Œç„¡æ³•é€²è¡Œæ¸¬é©—ã€‚è«‹å¢åŠ æ›´å¤šå–®å­—æˆ–èª¿æ•´ç¯©é¸æ¢ä»¶ã€‚');
      this.closeQuizModal();
      return;
    }
    
    // æ›´æ–°å¯ç”¨å–®å­—
    this.quizState.availableWords = availableWords;
    
    // é‡æ–°ç”Ÿæˆé¡Œç›®
    this.generateQuestions(this.quizState.type);
    
    // é‡æ–°è¨­ç½®ç‹€æ…‹
    this.quizState.currentQuestionIndex = 0;
    this.quizState.selectedAnswer = null;
    this.quizState.answers = [];
    this.quizState.score = 0;
    this.quizState.startTime = new Date();
    this.quizState.endTime = null;
    
    this.showQuizScreen('start');
  };
  
  // ç¦ç”¨é˜²æ­¢è¢å¹•é—œé–‰åŠŸèƒ½
  FlashcardApp.prototype.disableKeepScreenAwake = function() {
    console.log('ç¦ç”¨é˜²æ­¢è¢å¹•é—œé–‰åŠŸèƒ½');
    this.keepScreenAwake = false;
    
    // é‡‹æ”¾Wake Lock
    if (this.wakeLock) {
      this.wakeLock.release();
      this.wakeLock = null;
    }
    
    // åœæ­¢NoSleepè¦–é »
    if (this.noSleepVideo) {
      this.noSleepVideo.pause();
      if (this.noSleepVideo.parentNode) {
        this.noSleepVideo.parentNode.removeChild(this.noSleepVideo);
      }
      this.noSleepVideo = null;
    }
  };
  
  // å…¨åŸŸè®Šæ•¸
  var app;
  
  // é é¢è¼‰å…¥å®Œæˆå¾Œå•Ÿå‹•
  window.addEventListener('load', function() {
    try {
      console.log('é é¢è¼‰å…¥å®Œæˆï¼Œå•Ÿå‹•FlashcardApp');
      app = new FlashcardApp();
      
      // èªéŸ³åˆ—è¡¨è¼‰å…¥å¾Œå¡«å……èªéŸ³è…”èª¿é¸å–®
    if (window.speechSynthesis) {
        window.speechSynthesis.onvoiceschanged = function() {
          if (app && typeof app.populateVoiceSelect === 'function') {
          app.populateVoiceSelect();
        }
      };
    }
    
    // é é¢å¸è¼‰æ™‚æ¸…ç†è³‡æº
    window.addEventListener('beforeunload', function() {
      if (app && typeof app.disableKeepScreenAwake === 'function') {
        app.disableKeepScreenAwake();
      }
    });
    } catch (error) {
      console.error('æ‡‰ç”¨å•Ÿå‹•å¤±æ•—:', error);
      var loadingDiv = document.getElementById('loading');
      var errorDiv = document.getElementById('error');
      if (loadingDiv) loadingDiv.style.display = 'none';
      if (errorDiv) {
        errorDiv.style.display = 'block';
        errorDiv.innerHTML = '<h2>å•Ÿå‹•å¤±æ•—</h2><p>è«‹é‡æ–°æ•´ç†é é¢ï¼ŒéŒ¯èª¤ï¼š' + error.message + '</p>';
      }
    }
  });
  
  console.log('FlashcardApp ES5å…¼å®¹ç‰ˆæœ¬å·²è¼‰å…¥');
  </script>
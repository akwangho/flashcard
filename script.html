<!-- script.html -->
<script>
class FlashcardApp {
  constructor() {
    this.words = [];
    this.currentWords = [];
    this.currentIndex = 0;
    this.showingChinese = false;
    this.isTransitioning = false;
    this.isProcessingClick = false;
    this.displayTimer = null;
    this.speechSynthesis = window.speechSynthesis;
    this.removedWords = [];
    this.navigationHistory = [];
    this.pendingRemoval = null;
    this.isPaused = false; // 新增：暫停狀態
    this.pausedTimestamp = null; // 新增：暫停時間戳
    this.remainingTime = 0; // 新增：剩餘時間
    this.settings = {
      delayTime: 1, // 延遲時間（秒）
      fontSize: 96, // 字體大小（px）
      reverseMode: false // 是否先顯示中文
    };
    this.voiceSettings = {
      enabled: true, // 新增：是否啟用發音
      rate: 0.8,
      pitch: 1,
      volume: 1,
      lang: 'en-US',
      voiceURI: '' // 新增：語音腔調
    };
    this.difficultWords = [];
    this.showDifficultOnly = false;
    // 新增：Google Sheet 設定
    this.sheetSettings = {
      sheetId: '',
      selectedSheets: []
    };
    this.availableSheets = [];
    this.listenersSetup = false; // 新增：追蹤事件監聽器是否已設置
    this.currentSpreadsheetName = null; // 新增：當前 Google Sheet 名稱
    this.init();
  }
  
  async init() {
    console.log('=== FlashcardApp 初始化開始 ===');
    try {
      console.log('載入基本設定...');
      this.loadSettings(); // 載入設定
      this.loadSheetSettings(); // 載入 Sheet 設定
      
      console.log('Sheet 設定:', this.sheetSettings);
      
      // 首先設置事件監聽器（只設置一次）
      console.log('設定事件監聽器...');
      this.setupEventListeners();
      
      // 檢查是否有已設定的 Google Sheet
      if (this.sheetSettings.sheetId && this.sheetSettings.selectedSheets.length > 0) {
        console.log('發現已設定的 Google Sheet，載入單字...');
        await this.loadWords();
        this.hideLoading();
        this.applySettings(); // 應用設定
        this.startNewRound();
      } else {
        console.log('沒有找到 Google Sheet 設定，顯示設定畫面');
        // 沒有設定則顯示設定畫面
        this.hideLoading();
        this.openSheetSettings();
        return;
      }
      
      console.log('=== FlashcardApp 初始化完成 ===');
    } catch (error) {
      console.error('初始化錯誤:', error);
      console.error('錯誤詳細資訊:', {
        name: error.name,
        message: error.message,
        stack: error.stack
      });
      this.showError();
    }
  }
  
  // 新增：載入設定
  loadSettings() {
    const savedSettings = JSON.parse(localStorage.getItem('flashcard-settings') || '{}');
    this.settings = { ...this.settings, ...savedSettings };
    // 新增：載入語音設定
    const savedVoiceSettings = JSON.parse(localStorage.getItem('flashcard-voice-settings') || '{}');
    this.voiceSettings = { ...this.voiceSettings, ...savedVoiceSettings };
  }
  
  // 新增：載入 Sheet 設定
  loadSheetSettings() {
    const savedSheetSettings = JSON.parse(localStorage.getItem('flashcard-sheet-settings') || '{}');
    this.sheetSettings = { ...this.sheetSettings, ...savedSheetSettings };
  }
  
  // 新增：儲存設定
  saveSettings() {
    localStorage.setItem('flashcard-settings', JSON.stringify(this.settings));
    // 新增：儲存語音設定
    localStorage.setItem('flashcard-voice-settings', JSON.stringify(this.voiceSettings));
  }
  
  // 新增：儲存 Sheet 設定
  saveSheetSettings() {
    localStorage.setItem('flashcard-sheet-settings', JSON.stringify(this.sheetSettings));
  }
  
  // 新增：應用設定到UI
  applySettings() {
    const englishWord = document.getElementById('english-word');
    const chineseWord = document.getElementById('chinese-word');
    const loadingText = document.querySelector('#loading p');
    
    // 應用字體大小
    if (englishWord) englishWord.style.fontSize = this.settings.fontSize + 'px';
    if (chineseWord) chineseWord.style.fontSize = this.settings.fontSize + 'px';
    if (loadingText) loadingText.style.fontSize = this.settings.fontSize + 'px';
    
    // 更新設定畫面的滑桿值
    const delaySlider = document.getElementById('delay-setting');
    const fontSizeSlider = document.getElementById('font-size-setting');
    const reverseToggle = document.getElementById('reverse-setting');
    
    if (delaySlider) {
      delaySlider.value = this.settings.delayTime;
      document.getElementById('delay-value').textContent = this.settings.delayTime;
    }
    if (fontSizeSlider) {
      fontSizeSlider.value = this.settings.fontSize;
      document.getElementById('font-size-value').textContent = this.settings.fontSize + 'px';
    }
    if (reverseToggle) reverseToggle.checked = this.settings.reverseMode;
  }
  
  async loadWords() {
    return new Promise((resolve, reject) => {
      if (this.sheetSettings.sheetId && this.sheetSettings.selectedSheets.length > 0) {
        // 使用新的多工作表載入功能
        google.script.run
          .withSuccessHandler(words => {
            if (words && words.length > 0) {
              this.words = words;
              // 初始化 difficultWords 狀態
              this.difficultWords = words.filter(w => w.difficult).map(w => w.id);
              resolve();
            } else {
              reject(new Error('沒有找到單字資料'));
            }
          })
          .withFailureHandler(error => {
            reject(error);
          })
          .getWordsFromSheets(this.sheetSettings.sheetId, this.sheetSettings.selectedSheets);
      } else {
        // 向後相容：使用預設設定
        google.script.run
          .withSuccessHandler(words => {
            if (words && words.length > 0) {
              this.words = words;
              // 初始化 difficultWords 狀態
              this.difficultWords = words.filter(w => w.difficult).map(w => w.id);
              resolve();
            } else {
              reject(new Error('沒有找到單字資料'));
            }
          })
          .withFailureHandler(error => {
            reject(error);
          })
          .getWordsFromSheet();
      }
    });
  }
  
  // Refactored: Split into smaller, more manageable functions
  setupEventListeners() {
    console.log('設置事件監聽器...');

    // 防止重複綁定事件監聽器
    if (this.listenersSetup) {
      console.log('事件監聽器已設置，跳過重複設置');
      return;
    }

    this.setupCoreListeners();
    this.setupMenuListeners();
    this.setupModalListeners();
    this.setupKeyboardListeners();
    this.setupProgressAndExportListeners();

    // 標記事件監聽器已設置
    this.listenersSetup = true;
    console.log('所有事件監聽器設置完成');
  }
  
  // New: Listeners for core card and control functionality
  setupCoreListeners() {
    document.getElementById('english-section').addEventListener('click', () => this.onWordClick());
    document.getElementById('chinese-section').addEventListener('click', () => this.onWordClick());
    document.getElementById('next-btn').addEventListener('click', () => this.nextWord());
    document.getElementById('prev-btn').addEventListener('click', () => this.previousWord());
    document.getElementById('restart-btn').addEventListener('click', () => this.restart());
  }
  
  // New: Listeners for the menu system
  setupMenuListeners() {
    console.log('設定選單事件監聽器...');
    
    const menuBtn = document.getElementById('menu-btn');
    const menuDropdown = document.getElementById('menu-dropdown');
    
    if (!menuBtn) {
      console.error('找不到 menu-btn 元素');
      return;
    }
    
    if (!menuDropdown) {
      console.error('找不到 menu-dropdown 元素');
      return;
    }
    
    console.log('選單元素檢查通過');
    
    // 使用委派事件監聽，避免重複綁定的問題
    document.addEventListener('click', (e) => {
      // 處理選單按鈕點擊
      if (e.target.id === 'menu-btn' || e.target.closest('#menu-btn')) {
        console.log('選單按鈕被點擊');
        e.stopPropagation();
        this.toggleMenu();
        return;
      }

      // 處理選單項目點擊
      if (e.target.closest('#menu-dropdown')) {
        console.log('點擊選單下拉選項');
        e.stopPropagation();

        // 處理各種選單項目
        if (e.target.id === 'restart-btn') {
          console.log('重新開始按鈕被點擊');
          this.closeMenu();
          this.restart();
        } else if (e.target.id === 'sheet-settings-btn') {
          console.log('Google Sheet 設定按鈕被點擊');
          this.closeMenu();
          this.openSheetSettings();
        } else if (e.target.id === 'voice-settings-btn') {
          console.log('語音設定按鈕被點擊');
          this.closeMenu();
          this.openVoiceSettings();
        } else if (e.target.id === 'settings-btn') {
          console.log('設定按鈕被點擊');
          this.closeMenu();
          this.openSettings();
        } else if (e.target.id === 'export-btn') {
          console.log('匯出按鈕被點擊');
          this.closeMenu();
          this.openExportModal();
        }
        return;
      }

      // 點擊其他地方關閉選單
      if (this.closeMenu) {
        this.closeMenu();
      }
    });

    console.log('選單事件監聽器設定完成（使用事件委派）');
  }

  // New: Listeners for all modals (main and voice settings)
  setupModalListeners() {
    // Main settings modal
    const settingsModal = document.getElementById('settings-modal');
    document.getElementById('close-settings').addEventListener('click', () => this.closeSettings());
    document.getElementById('save-settings').addEventListener('click', () => this.saveSettingsAndClose());
    document.getElementById('reset-settings').addEventListener('click', () => this.resetSettings());
    settingsModal.addEventListener('click', (e) => {
      if (e.target === settingsModal) this.closeSettings();
    });
    document.getElementById('delay-setting').addEventListener('input', (e) => {
      document.getElementById('delay-value').textContent = e.target.value;
    });
    document.getElementById('font-size-setting').addEventListener('input', (e) => {
      document.getElementById('font-size-value').textContent = e.target.value + 'px';
      // Live preview font size
      const englishWord = document.getElementById('english-word');
      const chineseWord = document.getElementById('chinese-word');
      if (englishWord) englishWord.style.fontSize = e.target.value + 'px';
      if (chineseWord) chineseWord.style.fontSize = e.target.value + 'px';
    });

    // Voice settings modal
    const voiceSettingsModal = document.getElementById('voice-settings-modal');
    document.getElementById('close-voice-settings').addEventListener('click', () => this.closeVoiceSettings());
    document.getElementById('cancel-voice-settings').addEventListener('click', () => this.closeVoiceSettings());
    document.getElementById('save-voice-settings').addEventListener('click', () => this.saveVoiceSettingsAndClose());
    voiceSettingsModal.addEventListener('click', (e) => {
      if (e.target === voiceSettingsModal) this.closeVoiceSettings();
    });
    document.getElementById('voice-rate-setting').addEventListener('input', (e) => {
      document.getElementById('voice-rate-value').textContent = e.target.value;
    });

    // Google Sheet settings modal
    const sheetSettingsModal = document.getElementById('sheet-settings-modal');
    document.getElementById('close-sheet-settings').addEventListener('click', () => {
      console.log('關閉 Sheet 設定按鈕被點擊');
      this.closeSheetSettings();
    });
    document.getElementById('cancel-sheet-settings').addEventListener('click', () => {
      console.log('取消 Sheet 設定按鈕被點擊');
      this.closeSheetSettings();
    });
    document.getElementById('save-sheet-settings').addEventListener('click', () => {
      console.log('儲存 Sheet 設定按鈕被點擊');
      this.saveSheetSettingsAndClose();
    });
    document.getElementById('load-sheets-btn').addEventListener('click', () => {
      console.log('載入工作表清單按鈕被點擊');
      this.loadSheetsList();
    });
    sheetSettingsModal.addEventListener('click', (e) => {
      if (e.target === sheetSettingsModal) {
        console.log('點擊模態視窗背景，關閉設定');
        this.closeSheetSettings();
      }
    });
  }

  // New: Listeners for all keyboard shortcuts
  setupKeyboardListeners() {
    document.addEventListener('keydown', (e) => {
      if (this.isPaused) return;

      const keyActions = {
        'Enter': () => this.onWordClick(),
        'Space': () => this.onWordClick(),
        'KeyD': () => this.onWordClick(),
        'KeyR': () => this.restart(),
        'ArrowLeft': () => this.previousWord(),
        'ArrowUp': () => this.previousWord(),
        'ArrowRight': () => this.nextWord(),
        'ArrowDown': () => this.nextWord(),
        'Escape': () => {
          this.closeSettings();
          this.closeVoiceSettings();
          this.closeMenu();
        }
      };

      if (keyActions[e.code]) {
        e.preventDefault();
        keyActions[e.code]();
      }
    });
  }
  
  // 新增：設置進度區和匯出相關的事件監聽器
  setupProgressAndExportListeners() {
    console.log('設置進度區和匯出事件監聽器...');

    // 進度區點擊標註/取消不熟單字
    const progressArea = document.getElementById('progress-area');
    if (progressArea) {
      // 移除舊的事件監聽器（如果存在）
      const newProgressArea = progressArea.cloneNode(true);
      progressArea.parentNode.replaceChild(newProgressArea, progressArea);

      newProgressArea.addEventListener('click', () => {
        console.log('進度區被點擊，切換困難單字狀態');
        this.toggleDifficultCurrentWord();
      });
      console.log('進度區事件監聽器設置完成');
    } else {
      console.error('找不到 progress-area 元素');
    }

    // 只顯示不熟單字checkbox
    const showDifficultCheckbox = document.getElementById('show-difficult-only');
    if (showDifficultCheckbox) {
      showDifficultCheckbox.addEventListener('change', (e) => {
        console.log('切換只顯示不熟單字:', e.target.checked);
        this.showDifficultOnly = e.target.checked;
        this.filterWordsByDifficult();
      });
      console.log('不熟單字過濾器事件監聽器設置完成');
    } else {
      console.error('找不到 show-difficult-only 元素');
    }

    // 匯出單字相關事件
    const exportBtn = document.getElementById('export-btn');
    const closeExportModal = document.getElementById('close-export-modal');
    const cancelExport = document.getElementById('cancel-export');
    const confirmExport = document.getElementById('confirm-export');

    if (exportBtn) {
      exportBtn.addEventListener('click', () => {
        console.log('匯出按鈕被點擊');
        this.openExportModal();
      });
    }

    if (closeExportModal) {
      closeExportModal.addEventListener('click', () => this.closeExportModal());
    }

    if (cancelExport) {
      cancelExport.addEventListener('click', () => this.closeExportModal());
    }

    if (confirmExport) {
      confirmExport.addEventListener('click', () => this.confirmExport());
    }

    console.log('匯出相關事件監聽器設置完成');
  }
  
  // 新增：選單控制
  toggleMenu() {
    console.log('toggleMenu 被調用');
    const menuBtn = document.getElementById('menu-btn');
    const menuDropdown = document.getElementById('menu-dropdown');
    
    if (!menuBtn || !menuDropdown) {
      console.error('選單元素不存在，無法切換');
      return;
    }
    
    const isOpen = menuDropdown.classList.contains('show');
    console.log('選單目前狀態:', isOpen ? '開啟' : '關閉');
    
    if (isOpen) {
      this.closeMenu();
    } else {
      console.log('開啟選單');
      menuBtn.classList.add('active');
      menuDropdown.classList.add('show');
    }
  }
  
  closeMenu() {
    console.log('closeMenu 被調用');
    const menuBtn = document.getElementById('menu-btn');
    const menuDropdown = document.getElementById('menu-dropdown');
    
    if (menuBtn && menuDropdown) {
      console.log('關閉選單');
      menuBtn.classList.remove('active');
      menuDropdown.classList.remove('show');
    }
  }
  
  // 新增：開啟設定畫面
  openSettings() {
    const settingsModal = document.getElementById('settings-modal');
    settingsModal.style.display = 'flex';
    
    // 暫停計時器
    this.pauseTimer();
    
    // 更新設定畫面的值
    this.applySettings();
  }
  
  // 修正：關閉設定畫面
  closeSettings(shouldRedisplay = false) {
    const settingsModal = document.getElementById('settings-modal');
    settingsModal.style.display = 'none';
    
    // 恢復計時器
    this.resumeTimer();
    
    // 只有在需要時才重新顯示當前單字
    if (shouldRedisplay) {
      this.redisplayCurrentWord();
    }
  }
  
  // 新增方法：重新顯示當前單字
  redisplayCurrentWord() {
    // 清除現有的計時器
    if (this.displayTimer) {
      clearTimeout(this.displayTimer);
      this.displayTimer = null;
    }
    
    // 停止語音播放
    this.speechSynthesis.cancel();
    
    // 重置狀態
    this.showingChinese = false;
    this.isTransitioning = false;
    this.isProcessingClick = false;
    this.pendingRemoval = null;
    
    // 重新顯示當前單字
    this.displayCurrentWord();
  }
  
  // 新增：儲存設定並關閉
  saveSettingsAndClose() {
    const delaySlider = document.getElementById('delay-setting');
    const fontSizeSlider = document.getElementById('font-size-setting');
    const reverseToggle = document.getElementById('reverse-setting');
    
    // 檢查是否有重要設定變更
    const oldReverseMode = this.settings.reverseMode;
    
    // 更新設定
    this.settings.delayTime = parseFloat(delaySlider.value);
    this.settings.fontSize = parseInt(fontSizeSlider.value);
    this.settings.reverseMode = reverseToggle.checked;
    
    // 儲存到本地儲存
    this.saveSettings();
    
    // 應用新設定
    this.applySettings();
    
    // 關閉設定畫面
    this.closeSettings();
    
    // 如果反向模式有變更，重新顯示當前單字
    if (oldReverseMode !== this.settings.reverseMode) {
      this.redisplayCurrentWord();
    }
  }
  
  // 新增：重置設定
  resetSettings() {
    this.settings = {
      delayTime: 3,
      fontSize: 96,
      reverseMode: false
    };
    this.voiceSettings = {
      enabled: true,
      rate: 0.8,
      pitch: 1,
      volume: 1,
      lang: 'en-US',
      voiceURI: ''
    };
    this.applySettings();
    this.saveSettings();
    this.closeSettings();
  }
  
  // 新增：暫停計時器
  pauseTimer() {
    this.isPaused = true;
    
    if (this.displayTimer) {
      clearTimeout(this.displayTimer);
      this.displayTimer = null;
    }
    
    // 顯示暫停指示器
    const pausedIndicator = document.createElement('div');
    pausedIndicator.id = 'paused-indicator';
    pausedIndicator.className = 'paused-indicator';
    pausedIndicator.textContent = '已暫停';
    document.getElementById('flashcard').appendChild(pausedIndicator);
  }
  
  // 新增：恢復計時器
  resumeTimer() {
    this.isPaused = false;
    
    // 移除暫停指示器
    const pausedIndicator = document.getElementById('paused-indicator');
    if (pausedIndicator) {
      pausedIndicator.remove();
    }
    
    // 恢復計時器（如果需要）
    if (this.showingChinese) {
      // 如果中文已經顯示，繼續等待切換到下一個單字
      this.displayTimer = setTimeout(() => {
        this.nextWord();
      }, this.settings.delayTime * 1000);
    } else if (!this.isTransitioning && !this.isProcessingClick) {
      // 如果英文顯示中，繼續等待顯示中文
      const currentWord = this.currentWords[this.currentIndex];
      const chineseElement = document.getElementById('chinese-word');
      
      this.displayTimer = setTimeout(() => {
        chineseElement.textContent = this.settings.reverseMode ? currentWord.english : currentWord.chinese;
        chineseElement.classList.add('show');
        this.showingChinese = true;
        
        // 中文顯示後等待切換到下一個單字
        this.displayTimer = setTimeout(() => {
          this.nextWord();
        }, this.settings.delayTime * 1000);
        
      }, this.settings.delayTime * 1000);
    }
  }
  
  startNewRound() {
    this.shuffleArray(this.words);
    if (this.showDifficultOnly) {
      this.currentWords = this.words.filter(w => this.difficultWords.includes(w.id));
    } else {
      this.currentWords = [...this.words];
    }
    this.currentIndex = 0;
    this.removedWords = [];
    this.navigationHistory = [];
    this.pendingRemoval = null;
    this.displayCurrentWord();
    this.updateButtonStates();
    this.renderDifficultStar();
  }
  
  shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
  }
  
  saveNavigationState() {
    if (this.currentWords.length > 0 && this.currentIndex >= 0) {
      this.navigationHistory.push({
        currentIndex: this.currentIndex,
        wordSequence: [...this.currentWords]
      });
      
      if (this.navigationHistory.length > 20) {
        this.navigationHistory.shift();
      }
    }
  }
  
  // Refactored: New function to handle revealing the second part and scheduling the next word
  showSecondPartAndScheduleNext() {
    if (this.isPaused || this.showingChinese || !this.currentWords[this.currentIndex]) {
      return;
    }

    if (this.displayTimer) {
      clearTimeout(this.displayTimer);
    }

    const currentWord = this.currentWords[this.currentIndex];
    const chineseElement = document.getElementById('chinese-word');
    
    const secondText = this.settings.reverseMode ? currentWord.english : currentWord.chinese;
    chineseElement.textContent = secondText;
    chineseElement.classList.add('show');
    this.showingChinese = true;
    
    // If in reverse mode, the second part is English, so we speak it.
    if (this.settings.reverseMode) {
      setTimeout(() => {
        this.speakEnglishWord(currentWord.english);
      }, 500); // Delay to sync with reveal animation
    }
    
    // Schedule the next word to appear
    this.displayTimer = setTimeout(() => {
      this.nextWord();
    }, this.settings.delayTime * 1000);
  }

  speakEnglishWord(text) {
    // 檢查是否啟用發音
    if (!this.voiceSettings.enabled) return;
    
    try {
      this.speechSynthesis.cancel();
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = this.voiceSettings.rate;
      utterance.pitch = this.voiceSettings.pitch;
      utterance.volume = this.voiceSettings.volume;
      utterance.lang = this.voiceSettings.lang;
      
      const voices = this.speechSynthesis.getVoices();
      let selectedVoice = null;
      if (this.voiceSettings.voiceURI) {
        selectedVoice = voices.find(v => v.voiceURI === this.voiceSettings.voiceURI);
      }
      
      if (!selectedVoice) {
        // fallback: 找第一個英文語音
        selectedVoice = voices.find(voice => 
          voice.lang.startsWith('en-') || 
          voice.name.toLowerCase().includes('english')
        );
      }
      
      if (selectedVoice) {
        utterance.voice = selectedVoice;
      }
      
      this.speechSynthesis.speak(utterance);
    } catch (error) {
      console.log('語音播放失敗:', error);
    }
  }
  
  displayCurrentWord() {
    if (this.currentWords.length === 0) {
      this.startNewRound();
      return;
    }
    
    const currentWord = this.currentWords[this.currentIndex];
    const englishElement = document.getElementById('english-word');
    const chineseElement = document.getElementById('chinese-word');
    
    this.showingChinese = false;
    this.isTransitioning = false;
    this.isProcessingClick = false;
    this.pendingRemoval = null;
    
    if (this.displayTimer) {
      clearTimeout(this.displayTimer);
    }
    
    englishElement.classList.remove('show');
    chineseElement.classList.remove('show');
    
    englishElement.style.color = '';
    chineseElement.style.color = '';
    
    setTimeout(() => {
      const firstElement = document.getElementById('english-word');
      
      // 根據設定決定顯示順序
      if (this.settings.reverseMode) {
        // 先顯示中文
        firstElement.textContent = currentWord.chinese;
      } else {
        // 先顯示英文（原本的邏輯）
        firstElement.textContent = currentWord.english;
        // 發音英文單字
        setTimeout(() => {
          this.speakEnglishWord(currentWord.english);
        }, 500);
      }
      firstElement.classList.add('show');

      // 延遲顯示第二部分
      this.displayTimer = setTimeout(() => {
        this.showSecondPartAndScheduleNext();
      }, this.settings.delayTime * 1000);
      
    }, 100);
    
    this.renderDifficultStar();
    this.updateProgress();
    this.updateButtonStates();
  }
  
  updateProgress() {
    const progressText = document.getElementById('progress-text');
    const current = this.currentIndex + 1;
    const total = this.currentWords.length;
    progressText.textContent = `${current}/${total}`;
  }
  
  updateButtonStates() {
    const prevBtn = document.getElementById('prev-btn');
    // const hasNavigationHistory = this.navigationHistory.length > 0;
    // const hasPendingRemoval = this.pendingRemoval !== null;
    // prevBtn.disabled = !hasNavigationHistory && !hasPendingRemoval;

    // 修正：第一個單字時「上一個」不能按
    const isFirstWord = this.currentIndex === 0;
    const hasPendingRemoval = this.pendingRemoval !== null;
    prevBtn.disabled = (isFirstWord && !hasPendingRemoval) || this.navigationHistory.length === 0;
  }
  
  onWordClick() {
    if (this.isTransitioning || this.isPaused) return;
    
    if (this.currentWords.length <= 1) {
      const sections = document.querySelectorAll('.card-section');
      sections.forEach(section => {
        section.style.backgroundColor = 'rgba(255, 100, 100, 0.3)';
        setTimeout(() => {
          section.style.backgroundColor = '';
        }, 300);
      });
      return;
    }
    
    const currentWord = this.currentWords[this.currentIndex];
    const englishElement = document.getElementById('english-word');
    const chineseElement = document.getElementById('chinese-word');
    
    const isAlreadyMarked = englishElement.style.color === 'rgb(102, 102, 102)' || 
                          englishElement.style.color === '#666666';
    
    if (isAlreadyMarked) {
      this.nextWord();
      return;
    }
    
    this.isProcessingClick = true;
    
    if (this.displayTimer) {
      clearTimeout(this.displayTimer);
    }
    
    if (!this.showingChinese) {
      const secondText = this.settings.reverseMode ? currentWord.english : currentWord.chinese;
      chineseElement.textContent = secondText;
      chineseElement.classList.add('show');
      this.showingChinese = true;
      
      // 如果是反向模式且還沒發音，現在發音
      if (this.settings.reverseMode) {
        setTimeout(() => {
          this.speakEnglishWord(currentWord.english);
        }, 500);
      }
    }
    
    englishElement.style.color = '#666666';
    chineseElement.style.color = '#666666';
    
    const sections = document.querySelectorAll('.card-section');
    sections.forEach(section => {
      section.classList.add('clicked');
      setTimeout(() => section.classList.remove('clicked'), 500);
    });
    
    this.pendingRemoval = {
      word: currentWord,
      index: this.currentIndex,
      originalEnglishColor: englishElement.style.color,
      originalChineseColor: chineseElement.style.color
    };
    
    this.updateButtonStates();
    
    this.displayTimer = setTimeout(() => {
      this.confirmRemoval();
    }, this.settings.delayTime * 1000);
  }
  
  confirmRemoval() {
    if (!this.pendingRemoval) return;
    
    const { word, index } = this.pendingRemoval;
    
    this.removedWords.push(word);
    this.currentWords.splice(index, 1);
    
    if (this.currentIndex >= this.currentWords.length) {
      this.currentIndex = 0;
    }
    
    this.pendingRemoval = null;
    
    if (this.currentWords.length === 0) {
      this.startNewRound();
    } else {
      this.displayCurrentWord();
    }
    
    this.isProcessingClick = false;
    this.updateButtonStates();
  }
  
  cancelRemoval() {
    if (!this.pendingRemoval) return;
    
    const englishElement = document.getElementById('english-word');
    const chineseElement = document.getElementById('chinese-word');
    
    englishElement.style.color = '';
    chineseElement.style.color = '';
    
    this.pendingRemoval = null;
    
    if (this.displayTimer) {
      clearTimeout(this.displayTimer);
    }
    
    this.isProcessingClick = false;
    this.updateButtonStates();
    
    if (this.showingChinese) {
      this.displayTimer = setTimeout(() => {
        this.nextWord();
      }, this.settings.delayTime * 1000);
    } else {
      // 如果英文顯示中，恢復計時以顯示中文
      this.displayTimer = setTimeout(() => {
        this.showSecondPartAndScheduleNext();
      }, this.settings.delayTime * 1000);
    }
  }
  
  nextWord() {
    if (this.isTransitioning || this.isPaused) return;
    
    if (this.pendingRemoval) {
      this.confirmRemoval();
      return;
    }
    
    if (!this.showingChinese) {
      this.showSecondPartAndScheduleNext();
      return;
    }
    
    this.saveNavigationState();
    
    if (this.displayTimer) {
      clearTimeout(this.displayTimer);
    }
    
    this.speechSynthesis.cancel();
    
    this.isTransitioning = true;
    
    const englishElement = document.getElementById('english-word');
    const chineseElement = document.getElementById('chinese-word');
    
    englishElement.classList.remove('show');
    chineseElement.classList.remove('show');
    
    chineseElement.textContent = '';
    
    setTimeout(() => {
      this.currentIndex = (this.currentIndex + 1) % this.currentWords.length;
      
      if (this.currentIndex === 0) {
        this.shuffleArray(this.currentWords);
        this.navigationHistory = []; // 新增：新一輪開始時，清空導覽歷史
      }
      
      this.displayCurrentWord();
      this.isTransitioning = false;
      
    }, 300);
    this.renderDifficultStar();
  }
  
  previousWord() {
    if (this.isTransitioning || this.isPaused) return;
    
    if (this.pendingRemoval) {
      this.cancelRemoval();
      return;
    }
    
    // 如果沒有導覽歷史，就不能返回
    if (this.navigationHistory.length === 0) return;
    
    if (this.displayTimer) {
      clearTimeout(this.displayTimer);
    }
    
    this.speechSynthesis.cancel();
    
    this.isTransitioning = true;
    
    const englishElement = document.getElementById('english-word');
    const chineseElement = document.getElementById('chinese-word');
    
    englishElement.classList.remove('show');
    chineseElement.classList.remove('show');
    
    chineseElement.textContent = '';
    
    setTimeout(() => {
      const previousState = this.navigationHistory.pop();
      
      const previousWord = previousState.wordSequence[previousState.currentIndex];
      
      const wordIndex = this.currentWords.findIndex(word => 
        word.english === previousWord.english && word.chinese === previousWord.chinese
      );
      
      if (wordIndex !== -1) {
        this.currentIndex = wordIndex;
      } else {
        this.currentIndex = Math.min(previousState.currentIndex, this.currentWords.length - 1);
        
        if (this.currentWords.length === 0) {
          this.startNewRound();
          this.isTransitioning = false;
          return;
        }
      }
      
      this.displayCurrentWord();
      this.isTransitioning = false;
      
    }, 300);
    this.renderDifficultStar();
  }
  
  restart() {
    if (this.displayTimer) {
      clearTimeout(this.displayTimer);
    }
    this.speechSynthesis.cancel();
    this.pendingRemoval = null;
    this.closeMenu(); // 關閉選單
    this.startNewRound();
  }
  
  hideLoading() {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('flashcard').style.display = 'flex';
  }
    
  showError() {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('error').style.display = 'block';
  }
  
  // 新增：開啟語音設定畫面
  openVoiceSettings() {
    const modal = document.getElementById('voice-settings-modal');
    modal.style.display = 'flex';
    // 暫停計時器
    this.pauseTimer();
    // 載入目前語音設定
    document.getElementById('speech-enabled-setting').checked = this.voiceSettings.enabled;
    document.getElementById('voice-rate-setting').value = this.voiceSettings.rate;
    document.getElementById('voice-rate-value').textContent = this.voiceSettings.rate;
    // 載入語音腔調
    this.populateVoiceSelect();
  }
  
  // 新增：關閉語音設定畫面
  closeVoiceSettings() {
    const modal = document.getElementById('voice-settings-modal');
    modal.style.display = 'none';
    // 恢復計時器
    this.resumeTimer();
  }
  
  // 新增：儲存語音設定
  saveVoiceSettingsAndClose() {
    this.voiceSettings.enabled = document.getElementById('speech-enabled-setting').checked;
    this.voiceSettings.rate = parseFloat(document.getElementById('voice-rate-setting').value);
    const voiceSelect = document.getElementById('voice-select-setting');
    const selectedVoiceURI = voiceSelect.value;
    this.voiceSettings.voiceURI = selectedVoiceURI;
    // 取得語音的 lang
    const voices = this.speechSynthesis.getVoices();
    const selectedVoice = voices.find(v => v.voiceURI === selectedVoiceURI);
    if (selectedVoice) {
      this.voiceSettings.lang = selectedVoice.lang;
    }
    this.saveSettings();
    this.closeVoiceSettings();
  }
  
  // 新增：語音腔調選單
  populateVoiceSelect() {
    const voiceSelect = document.getElementById('voice-select-setting');
    // 清空
    voiceSelect.innerHTML = '';
    const voices = this.speechSynthesis.getVoices();
    // 只顯示英文語音
    const englishVoices = voices.filter(v => v.lang && v.lang.startsWith('en'));
    englishVoices.forEach(voice => {
      const option = document.createElement('option');
      option.value = voice.voiceURI;
      option.textContent = `${voice.name} (${voice.lang})`;
      if (voice.voiceURI === this.voiceSettings.voiceURI) {
        option.selected = true;
      }
      voiceSelect.appendChild(option);
    });
    // 若沒選到，預設選第一個
    if (!voiceSelect.value && englishVoices.length > 0) {
      voiceSelect.value = englishVoices[0].voiceURI;
    }
  }

  // 新增：開啟 Google Sheet 設定畫面
  openSheetSettings() {
    console.log('開啟 Google Sheet 設定畫面');
    const modal = document.getElementById('sheet-settings-modal');
    if (!modal) {
      console.error('找不到 sheet-settings-modal 元素');
      return;
    }
    
    modal.style.display = 'flex';
    console.log('設定畫面已顯示');
    
    // 載入目前設定
    const sheetIdInput = document.getElementById('sheet-id-input');
    if (!sheetIdInput) {
      console.error('找不到 sheet-id-input 元素');
      return;
    }
    
    sheetIdInput.value = this.sheetSettings.sheetId || '';
    console.log('載入現有設定，Sheet ID:', this.sheetSettings.sheetId);
    
    // 重置工作表清單
    const sheetsGroup = document.getElementById('sheets-selection-group');
    if (!sheetsGroup) {
      console.error('找不到 sheets-selection-group 元素');
      return;
    }
    
    sheetsGroup.style.display = 'none';
    
    const saveBtn = document.getElementById('save-sheet-settings');
    if (!saveBtn) {
      console.error('找不到 save-sheet-settings 按鈕');
      return;
    }
    
    saveBtn.disabled = true;
    console.log('重置 UI 狀態完成');
    
    this.pauseTimer();
  }

  // 新增：關閉 Google Sheet 設定畫面
  closeSheetSettings() {
    const modal = document.getElementById('sheet-settings-modal');
    modal.style.display = 'none';
    this.resumeTimer();
  }

  // 新增：從 URL 中提取 Google Sheet ID
  extractSheetId(input) {
    console.log('=== extractSheetId 開始執行 ===');
    console.log('輸入內容:', input);
    
    const trimmedInput = input.trim();
    console.log('去除空格後:', trimmedInput);
    
    // 如果看起來像是 URL
    if (trimmedInput.includes('docs.google.com/spreadsheets')) {
      console.log('檢測到 Google Sheets URL');
      // 尋找 /d/ 後面的 ID
      const match = trimmedInput.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
      console.log('正則表達式匹配結果:', match);
      
      if (match && match[1]) {
        console.log('從 URL 提取到 Sheet ID:', match[1]);
        return match[1];
      } else {
        console.error('無法從 URL 中提取 Sheet ID');
        throw new Error('無法從 URL 中提取 Sheet ID，請確認 URL 格式正確');
      }
    }
    
    // 如果看起來像是純 ID (字母數字組合)
    const idPattern = /^[a-zA-Z0-9-_]+$/;
    console.log('檢查是否為純 ID，模式:', idPattern);
    console.log('模式測試結果:', idPattern.test(trimmedInput));
    
    if (idPattern.test(trimmedInput)) {
      console.log('輸入看起來是 Sheet ID:', trimmedInput);
      return trimmedInput;
    }
    
    console.error('輸入格式不正確');
    throw new Error('輸入格式不正確，請輸入有效的 Google Sheet ID 或 URL');
  }

  // 新增：載入工作表清單
  loadSheetsList() {
    console.log('=== loadSheetsList 函數開始執行 ===');
    
    const sheetIdInput = document.getElementById('sheet-id-input');
    if (!sheetIdInput) {
      console.error('找不到 sheet-id-input 元素');
      alert('系統錯誤：找不到輸入框元素');
      return;
    }
    
    const input = sheetIdInput.value.trim();
    console.log('用戶輸入的內容:', input);
    
    if (!input) {
      console.warn('用戶未輸入任何內容');
      alert('請輸入 Google Sheet ID 或 URL');
      return;
    }
    
    const sheetsList = document.getElementById('sheets-list');
    const sheetsGroup = document.getElementById('sheets-selection-group');
    const loadBtn = document.getElementById('load-sheets-btn');
    
    // 檢查 DOM 元素是否存在
    if (!sheetsList) {
      console.error('找不到 sheets-list 元素');
      alert('系統錯誤：找不到工作表清單元素');
      return;
    }
    if (!sheetsGroup) {
      console.error('找不到 sheets-selection-group 元素');
      alert('系統錯誤：找不到工作表選擇組元素');
      return;
    }
    if (!loadBtn) {
      console.error('找不到 load-sheets-btn 按鈕');
      alert('系統錯誤：找不到載入按鈕');
      return;
    }
    
    console.log('所有 DOM 元素檢查通過');
    
    try {
      // 提取 Sheet ID
      console.log('開始提取 Sheet ID...');
      const sheetId = this.extractSheetId(input);
      console.log('成功提取 Sheet ID:', sheetId);
      
      // 更新 UI 狀態
      console.log('更新 UI 狀態...');
      sheetsList.innerHTML = '<div class="loading-text">載入中...</div>';
      sheetsGroup.style.display = 'block';
      loadBtn.disabled = true;
      loadBtn.textContent = '載入中...';
      console.log('UI 狀態更新完成');
      
      // 檢查 google.script.run 是否可用
      if (typeof google === 'undefined') {
        console.error('google 物件未定義');
        throw new Error('Google Apps Script 環境未正確載入');
      }
      if (!google.script) {
        console.error('google.script 未定義');
        throw new Error('Google Apps Script 功能未可用');
      }
      if (!google.script.run) {
        console.error('google.script.run 未定義');
        throw new Error('Google Apps Script 執行功能未可用');
      }
      
      console.log('Google Apps Script 環境檢查通過');
      console.log('準備調用 getSheetsList，參數:', sheetId);
      
      // 設定超時處理
      const timeout = setTimeout(() => {
        console.error('載入工作表清單超時 (15秒)');
        sheetsList.innerHTML = '<div class="error-text">載入超時，請檢查網路連接或重試</div>';
        loadBtn.disabled = false;
        loadBtn.textContent = '載入工作表清單';
      }, 15000); // 15秒超時
      
      console.log('開始調用 Google Apps Script...');
      
      google.script.run
        .withSuccessHandler(result => {
          console.log('=== Google Apps Script 成功回調 ===');
          clearTimeout(timeout);
          
          // 處理新的返回格式
          let sheets, spreadsheetName;
          if (result && result.sheets) {
            // 新格式：包含 spreadsheet 名稱
            sheets = result.sheets;
            spreadsheetName = result.spreadsheetName;
            console.log('成功載入 Google Sheet:', spreadsheetName, '包含', sheets.length, '個工作表');
          } else if (Array.isArray(result)) {
            // 向後兼容：舊格式
            sheets = result;
            spreadsheetName = null;
            console.log('使用舊格式載入工作表清單，數量:', sheets.length);
          } else {
            console.error('未知的返回格式:', result);
            throw new Error('載入工作表清單失敗：返回格式錯誤');
          }
          
          console.log('工作表資料:', sheets);
          
          this.availableSheets = sheets;
          this.currentSpreadsheetName = spreadsheetName; // 儲存 spreadsheet 名稱
          this.renderSheetsList();
          loadBtn.disabled = false;
          loadBtn.textContent = '載入工作表清單';
          console.log('工作表清單渲染完成');
        })
        .withFailureHandler(error => {
          console.log('=== Google Apps Script 失敗回調 ===');
          clearTimeout(timeout);
          console.error('載入工作表清單失敗:', error);
          console.error('錯誤詳細資訊:', {
            name: error.name,
            message: error.message,
            stack: error.stack
          });
          
          const errorMessage = error.message || '未知錯誤';
          sheetsList.innerHTML = '<div class="error-text">載入失敗：' + errorMessage + '</div>';
          loadBtn.disabled = false;
          loadBtn.textContent = '載入工作表清單';
          
          // 顯示更詳細的錯誤提示
          if (errorMessage.includes('權限')) {
            sheetsList.innerHTML += '<div class="error-text">提示：請確認您有存取此 Google Sheet 的權限</div>';
          } else if (errorMessage.includes('找不到') || errorMessage.includes('無法開啟')) {
            sheetsList.innerHTML += '<div class="error-text">提示：請檢查 Sheet ID 是否正確，或 Sheet 是否存在</div>';
          }
        })
        .getSheetsList(sheetId);
      
      console.log('Google Apps Script 調用已發送');
      
    } catch (error) {
      console.error('loadSheetsList 執行過程中發生錯誤:', error);
      console.error('錯誤詳細資訊:', {
        name: error.name,
        message: error.message,
        stack: error.stack
      });
      alert('錯誤：' + error.message);
      return;
    }
    
    console.log('=== loadSheetsList 函數執行完成 ===');
  }

  // 新增：渲染工作表清單
  renderSheetsList() {
    console.log('=== renderSheetsList 開始執行 ===');
    console.log('可用工作表數量:', this.availableSheets ? this.availableSheets.length : 0);
    console.log('工作表資料:', this.availableSheets);
    console.log('當前 Google Sheet 名稱:', this.currentSpreadsheetName);
    
    const sheetsList = document.getElementById('sheets-list');
    const sheetsGroup = document.getElementById('sheets-selection-group');
    if (!sheetsList || !sheetsGroup) {
      console.error('找不到 sheets-list 或 sheets-selection-group 元素');
      return;
    }
    
    if (!this.availableSheets || this.availableSheets.length === 0) {
      console.warn('沒有可用的工作表');
      sheetsList.innerHTML = '<div class="error-text">沒有找到工作表</div>';
      // 移除舊的標題
      const oldTitle = sheetsGroup.querySelector('.sheet-title');
      if (oldTitle) oldTitle.remove();
      return;
    }
    
    console.log('開始清空並重新渲染工作表清單');
    sheetsList.innerHTML = '';
    
    // 先移除舊的標題
    const oldTitle = sheetsGroup.querySelector('.sheet-title');
    if (oldTitle) oldTitle.remove();
    // 如果有 Google Sheet 名稱，顯示在 sheetsGroup 最上方
    if (this.currentSpreadsheetName) {
      const sheetTitle = document.createElement('div');
      sheetTitle.className = 'sheet-title';
      sheetTitle.innerHTML = `
        <div class="sheet-title-text">
          <strong>Google Sheet:</strong> ${this.currentSpreadsheetName}
        </div>
      `;
      // 插入到 sheetsGroup 最前面
      sheetsGroup.insertBefore(sheetTitle, sheetsGroup.firstChild);
      console.log('顯示 Google Sheet 名稱:', this.currentSpreadsheetName);
    }
    
    this.availableSheets.forEach((sheet, index) => {
      console.log(`渲染工作表 ${index + 1}:`, sheet);
      
      const sheetItem = document.createElement('div');
      sheetItem.className = 'sheet-item';
      
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.value = sheet.name;
      
      // 檢查是否應該自動勾選（如果是當前已載入的工作表）
      if (this.sheetSettings.selectedSheets && this.sheetSettings.selectedSheets.includes(sheet.name)) {
        checkbox.checked = true;
        console.log('自動勾選已載入的工作表:', sheet.name);
      }
      
      checkbox.addEventListener('change', () => {
        console.log('工作表選擇狀態改變:', sheet.name, checkbox.checked);
        this.toggleSheetSelection();
      });
      
      const sheetInfo = document.createElement('div');
      sheetInfo.className = 'sheet-info';
      
      const sheetName = document.createElement('div');
      sheetName.className = 'sheet-name';
      sheetName.textContent = sheet.name;
      
      const sheetCount = document.createElement('div');
      sheetCount.className = 'sheet-count';
      sheetCount.textContent = `${sheet.wordCount} 個單字`;
      
      sheetInfo.appendChild(sheetName);
      sheetInfo.appendChild(sheetCount);
      
      sheetItem.appendChild(checkbox);
      sheetItem.appendChild(sheetInfo);
      
      sheetItem.addEventListener('click', (e) => {
        if (e.target !== checkbox) {
          console.log('點擊工作表項目:', sheet.name);
          checkbox.checked = !checkbox.checked;
          this.toggleSheetSelection();
        }
      });
      
      sheetsList.appendChild(sheetItem);
      console.log(`工作表 ${sheet.name} 渲染完成`);
    });
    
    console.log('所有工作表渲染完成，更新選擇計數');
    this.updateSelectedCount();
    console.log('=== renderSheetsList 執行完成 ===');
  }

  // 新增：切換工作表選擇
  toggleSheetSelection() {
    const checkboxes = document.querySelectorAll('#sheets-list input[type="checkbox"]');
    const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
    
    document.getElementById('save-sheet-settings').disabled = selectedCount === 0;
    this.updateSelectedCount();
  }

  // 新增：更新已選數量
  updateSelectedCount() {
    const checkboxes = document.querySelectorAll('#sheets-list input[type="checkbox"]');
    const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
    document.getElementById('selected-count').textContent = `(已選 ${selectedCount} 個)`;
  }

  // 新增：儲存 Google Sheet 設定並關閉
  saveSheetSettingsAndClose() {
    const sheetIdInput = document.getElementById('sheet-id-input');
    const input = sheetIdInput.value.trim();
    
    const checkboxes = document.querySelectorAll('#sheets-list input[type="checkbox"]');
    const selectedSheets = Array.from(checkboxes)
      .filter(cb => cb.checked)
      .map(cb => cb.value);
    
    if (!input || selectedSheets.length === 0) {
      alert('請輸入 Google Sheet ID/URL 並選擇至少一個工作表');
      return;
    }
    
    try {
      // 提取並儲存 Sheet ID
      const sheetId = this.extractSheetId(input);
      
      // 儲存設定
      this.sheetSettings.sheetId = sheetId;
      this.sheetSettings.selectedSheets = selectedSheets;
      this.saveSheetSettings();
      
      console.log('儲存 Sheet 設定:', this.sheetSettings);
      
      // 關閉設定畫面
      this.closeSheetSettings();
      
      // 顯示載入中訊息
      const loadingDiv = document.getElementById('loading');
      const flashcardDiv = document.getElementById('flashcard');
      loadingDiv.style.display = 'flex';
      flashcardDiv.style.display = 'none';
      
      // 重新載入單字
      this.loadWords().then(() => {
        this.setupEventListeners();
        this.applySettings();
        this.startNewRound();
        loadingDiv.style.display = 'none';
        flashcardDiv.style.display = 'flex';
      }).catch(error => {
        console.error('載入單字失敗:', error);
        alert('載入單字失敗：' + error.message);
        loadingDiv.style.display = 'none';
        this.openSheetSettings(); // 重新開啟設定畫面
      });
      
    } catch (error) {
      console.error('儲存設定時發生錯誤:', error);
      alert(error.message);
    }
  }
  
  // 切換標註/取消標註當前單字
  toggleDifficultCurrentWord() {
    const currentWord = this.currentWords[this.currentIndex];
    if (!currentWord) return;
    const id = currentWord.id;
    const isDifficult = this.difficultWords.includes(id);
    if (isDifficult) {
      this.difficultWords = this.difficultWords.filter(did => did !== id);
    } else {
      this.difficultWords.push(id);
    }
    // 後端同步
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      // 使用 originalRowIndex 如果有的話，否則回退到尋找
      let rowIndex = currentWord.originalRowIndex;
      if (rowIndex === undefined) {
        rowIndex = this.words.findIndex(w => 
          w.english === currentWord.english && w.chinese === currentWord.chinese
        );
      }
      
      if (rowIndex !== -1) {
        const sheetId = this.sheetSettings.sheetId;
        const sheetName = currentWord.sheetName || 'Sheet1';
        console.log('標註單字:', currentWord.english, '行索引:', rowIndex, '是否困難:', !isDifficult);
        google.script.run.markWordAsDifficult(sheetId, sheetName, rowIndex, !isDifficult);
      }
    }
    this.renderDifficultStar();
  }
  
  // 根據狀態渲染星星
  renderDifficultStar() {
    const currentWord = this.currentWords[this.currentIndex];
    const star = document.getElementById('difficult-star');
    if (currentWord && this.difficultWords.includes(currentWord.id)) {
      star.classList.add('visible');
    } else {
      star.classList.remove('visible');
    }
  }
  
  // 過濾只顯示不熟單字
  filterWordsByDifficult() {
    if (this.showDifficultOnly) {
      this.currentWords = this.words.filter(w => this.difficultWords.includes(w.id));
      this.currentIndex = 0;
    } else {
      this.currentWords = [...this.words];
      this.currentIndex = 0;
    }
    this.displayCurrentWord();
  }
  
  // 匯出 modal 控制
  openExportModal() {
    // 預設名稱：目前工作表名稱_yyyyMMdd
    const defaultName = this.getDefaultExportSheetName();
    document.getElementById('export-sheet-name').value = defaultName;
    document.getElementById('export-type-remaining').checked = true;
    document.getElementById('export-modal').style.display = 'flex';
    this.pauseTimer();
    // 新增：重置匯出按鈕狀態
    const confirmBtn = document.getElementById('confirm-export');
    if (confirmBtn) {
      confirmBtn.disabled = false;
      confirmBtn.textContent = '匯出';
    }
  }
  closeExportModal() {
    document.getElementById('export-modal').style.display = 'none';
    this.resumeTimer();
    // 新增：確保「已暫停」消失
    const pausedIndicator = document.getElementById('paused-indicator');
    if (pausedIndicator) pausedIndicator.remove();
  }
  getDefaultExportSheetName() {
    // 取目前工作表名稱（假設與 SHEET_NAME 一致）
    const base = 'Sheet1';
    const date = new Date();
    const y = date.getFullYear();
    const m = (date.getMonth() + 1).toString().padStart(2, '0');
    const d = date.getDate().toString().padStart(2, '0');
    return `${base}_${y}${m}${d}`;
  }
  confirmExport() {
    const confirmBtn = document.getElementById('confirm-export');
    if (confirmBtn) {
      confirmBtn.disabled = true;
      confirmBtn.textContent = '匯出中...';
    }
    const type = document.getElementById('export-type-difficult').checked ? 'difficult' : 'remaining';
    const sheetName = document.getElementById('export-sheet-name').value.trim() || this.getDefaultExportSheetName();
    let exportWords = [];
    if (type === 'difficult') {
      exportWords = this.words.filter(w => this.difficultWords.includes(w.id));
    } else {
      exportWords = this.currentWords;
    }
    // 匯出資料格式
    const exportData = exportWords.map(w => ({
      english: w.english,
      chinese: w.chinese,
      difficult: this.difficultWords.includes(w.id)
    }));
    if (exportData.length === 0) {
      alert('沒有可匯出的單字！');
      if (confirmBtn) {
        confirmBtn.disabled = false;
        confirmBtn.textContent = '匯出';
      }
      return;
    }
    // 呼叫 Apps Script
    const targetSheetId = this.sheetSettings.sheetId || null;
    google.script.run
      .withSuccessHandler(() => {
        alert('匯出成功！');
        this.closeExportModal();
      })
      .withFailureHandler(() => {
        alert('匯出失敗，請重試！');
        if (confirmBtn) {
          confirmBtn.disabled = false;
          confirmBtn.textContent = '匯出';
        }
      })
      .exportWordsToSheet(exportData, sheetName, targetSheetId);
  }
}

// 當頁面載入完成後啟動應用
window.addEventListener('load', () => {
  const app = new FlashcardApp();
  // 語音列表載入後再填充語音腔調選單
  if (window.speechSynthesis) {
    window.speechSynthesis.onvoiceschanged = () => {
      if (typeof app.populateVoiceSelect === 'function') {
        app.populateVoiceSelect();
      }
    };
  }
});
</script>

<!-- script.html -->
<script>
  // ES5å…¼å®¹ç‰ˆæœ¬ FlashcardApp for iPad4
  (function() {
    'use strict';
    
    // ES5 Polyfills
    if (!Array.prototype.forEach) {
      Array.prototype.forEach = function(callback, thisArg) {
        for (var i = 0; i < this.length; i++) {
          callback.call(thisArg, this[i], i, this);
        }
      };
    }
    
    if (!Array.prototype.filter) {
      Array.prototype.filter = function(callback, thisArg) {
        var result = [];
        for (var i = 0; i < this.length; i++) {
          if (callback.call(thisArg, this[i], i, this)) {
            result.push(this[i]);
          }
        }
        return result;
      };
    }
    
    if (!Array.prototype.map) {
      Array.prototype.map = function(callback, thisArg) {
        var result = [];
        for (var i = 0; i < this.length; i++) {
          result.push(callback.call(thisArg, this[i], i, this));
        }
        return result;
      };
    }
    
    if (!Array.prototype.find) {
      Array.prototype.find = function(callback, thisArg) {
        for (var i = 0; i < this.length; i++) {
          if (callback.call(thisArg, this[i], i, this)) {
            return this[i];
          }
        }
        return undefined;
      };
    }
    
    if (!Array.prototype.includes) {
      Array.prototype.includes = function(searchElement) {
        for (var i = 0; i < this.length; i++) {
          if (this[i] === searchElement) {
            return true;
          }
        }
        return false;
      };
    }
  })();
  
  // å…¨åŸŸ FlashcardApp
  function FlashcardApp() {
    // åˆå§‹åŒ–å±¬æ€§
    this.words = [];
    this.currentWords = [];
    this.currentIndex = 0;
      this.showingChinese = false;
      this.isTransitioning = false;
      this.isProcessingClick = false;
    this.displayTimer = null;
    this.speechSynthesis = window.speechSynthesis;
    this.removedWords = [];
    this.navigationHistory = [];
      this.pendingRemoval = null;
    this.isPaused = false;
    this.pausedTimestamp = null;
    this.remainingTime = 0;
    
    // èªéŸ³å•Ÿç”¨ç‹€æ…‹ï¼ˆé©ç”¨æ–¼èˆŠç‰ˆç€è¦½å™¨ï¼‰
    this.speechActivated = false;
    this.isLegacyBrowser = false;
    
    // è¨­å®š
    this.settings = {
      delayTime: 1,
      fontSize: 96,
      reverseMode: false
    };
    
    this.voiceSettings = {
      enabled: true,
      rate: 0.8,
      pitch: 1,
      volume: 1,
      lang: 'en-US',
      voiceURI: ''
    };
    
    this.sheetSettings = {
      sheetId: '',
      selectedSheets: []
    };
    
    // åŠŸèƒ½ç‹€æ…‹
    this.difficultWords = [];
    this.showDifficultOnly = false;
    this.availableSheets = [];
    this.listenersSetup = false;
    this.currentSpreadsheetName = null;
    this.duplicateWords = [];
    this.currentDuplicateIndex = 0;
    this.duplicateProcessingResults = [];
    
    // å•Ÿå‹•åˆå§‹åŒ–
    this.init();
  }
  
  // åˆå§‹åŒ–æ–¹æ³•
  FlashcardApp.prototype.init = function() {
    console.log('=== FlashcardApp åˆå§‹åŒ–é–‹å§‹ (ES5ç‰ˆæœ¬) ===');
    try {
      console.log('è¼‰å…¥åŸºæœ¬è¨­å®š...');
      this.loadSettings();
      this.loadSheetSettings();
      
      console.log('Sheet è¨­å®š:', this.sheetSettings);
      
      // æª¢æ¸¬ç€è¦½å™¨æ˜¯å¦éœ€è¦èªéŸ³äº¤äº’
      this.detectLegacyBrowser();
      
      console.log('è¨­å®šäº‹ä»¶ç›£è½å™¨...');
      this.setupEventListeners();
      
      // æª¢æŸ¥æ˜¯å¦æœ‰å·²è¨­å®šçš„ Google Sheet
      if (this.sheetSettings.sheetId && this.sheetSettings.selectedSheets.length > 0) {
        console.log('ç™¼ç¾å·²è¨­å®šçš„ Google Sheetï¼Œè¼‰å…¥å–®å­—...');
        var self = this;
        this.loadWords(true, function(hasDuplicates) {
          self.handleLoadingComplete(hasDuplicates);
        });
        } else {
        console.log('æ²’æœ‰æ‰¾åˆ° Google Sheet è¨­å®šï¼Œé¡¯ç¤ºè¨­å®šç•«é¢');
        this.handleLoadingComplete(false, true);
        return;
      }
      
      console.log('=== FlashcardApp åˆå§‹åŒ–å®Œæˆ ===');
    } catch (error) {
      console.error('åˆå§‹åŒ–éŒ¯èª¤:', error);
      this.showError();
    }
    
    // åˆå§‹åŒ–æŒ‰éˆ•ç‹€æ…‹
    this.updateVoiceButtonState();
    this.updatePauseButtonState();
  };
  
  // æª¢æ¸¬èˆŠç‰ˆç€è¦½å™¨
  FlashcardApp.prototype.detectLegacyBrowser = function() {
    var userAgent = navigator.userAgent;
    var isIOS = /iPad|iPhone|iPod/.test(userAgent);
    var iosVersion = null;
    var isOldChrome = false;
    
    if (isIOS) {
      var match = userAgent.match(/OS (\d+)_/);
      if (match) {
        iosVersion = parseInt(match[1]);
      }
    }
    
    // æª¢æ¸¬èˆŠç‰ˆChromeï¼ˆç‰ˆæœ¬ä½æ–¼80ï¼‰
    var chromeMatch = userAgent.match(/Chrome\/(\d+)/);
    if (chromeMatch) {
      var chromeVersion = parseInt(chromeMatch[1]);
      isOldChrome = chromeVersion < 80;
    }
    
    // æª¢æ¸¬éœ€è¦ç”¨æˆ¶äº¤äº’æ‰èƒ½æ’­æ”¾èªéŸ³çš„ç€è¦½å™¨ï¼š
    // 1. iPad/iOS 10åŠä»¥ä¸‹ç‰ˆæœ¬
    // 2. èˆŠç‰ˆChromeï¼ˆç‰ˆæœ¬ä½æ–¼80ï¼‰
    // 3. Safari 12åŠä»¥ä¸‹ç‰ˆæœ¬
    this.isLegacyBrowser = (isIOS && iosVersion && iosVersion <= 10) || 
                          isOldChrome ||
                          userAgent.indexOf('Safari') !== -1 && userAgent.indexOf('Chrome') === -1 && 
                          userAgent.match(/Version\/(\d+)/) && parseInt(userAgent.match(/Version\/(\d+)/)[1]) <= 12;
    
    // æ–°ç‰ˆç€è¦½å™¨è‡ªå‹•å•Ÿç”¨èªéŸ³
    if (!this.isLegacyBrowser) {
      this.speechActivated = true;
    }
    
    console.log('ç€è¦½å™¨æª¢æ¸¬çµæœ:', {
      userAgent: userAgent,
      isIOS: isIOS,
      iosVersion: iosVersion,
      isOldChrome: isOldChrome,
      isLegacyBrowser: this.isLegacyBrowser,
      speechActivated: this.speechActivated
    });
  };
  
  // è™•ç†è¼‰å…¥å®Œæˆ
  FlashcardApp.prototype.handleLoadingComplete = function(hasDuplicates, shouldOpenSettings) {
    if (this.isLegacyBrowser && !this.speechActivated) {
      // èˆŠç‰ˆç€è¦½å™¨é¡¯ç¤ºèªéŸ³å•Ÿç”¨æŒ‰éˆ•
      this.showSpeechActivation();
    } else {
      // æ–°ç‰ˆç€è¦½å™¨æˆ–å·²å•Ÿç”¨èªéŸ³ï¼Œç›´æ¥é€²å…¥ä¸»ç•«é¢
      this.hideLoading();
      this.applySettings();
      
      if (shouldOpenSettings) {
        this.openSheetSettings();
      } else if (!hasDuplicates) {
        this.startNewRound();
      }
    }
  };
  
  // è¼‰å…¥è¨­å®š
  FlashcardApp.prototype.loadSettings = function() {
    try {
      var savedSettings = JSON.parse(localStorage.getItem('flashcard-settings') || '{}');
      for (var key in savedSettings) {
        if (savedSettings.hasOwnProperty(key) && this.settings.hasOwnProperty(key)) {
          this.settings[key] = savedSettings[key];
        }
      }
      
      var savedVoiceSettings = JSON.parse(localStorage.getItem('flashcard-voice-settings') || '{}');
      for (var key in savedVoiceSettings) {
        if (savedVoiceSettings.hasOwnProperty(key) && this.voiceSettings.hasOwnProperty(key)) {
          this.voiceSettings[key] = savedVoiceSettings[key];
        }
      }
    } catch (e) {
      console.log('è¼‰å…¥è¨­å®šå¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼');
    }
  };
  
  // è¼‰å…¥Sheetè¨­å®š
  FlashcardApp.prototype.loadSheetSettings = function() {
    try {
      var savedSheetSettings = JSON.parse(localStorage.getItem('flashcard-sheet-settings') || '{}');
      for (var key in savedSheetSettings) {
        if (savedSheetSettings.hasOwnProperty(key) && this.sheetSettings.hasOwnProperty(key)) {
          this.sheetSettings[key] = savedSheetSettings[key];
        }
      }
    } catch (e) {
      console.log('è¼‰å…¥Sheetè¨­å®šå¤±æ•—');
    }
  };
  
  // å„²å­˜è¨­å®š
  FlashcardApp.prototype.saveSettings = function() {
    localStorage.setItem('flashcard-settings', JSON.stringify(this.settings));
    localStorage.setItem('flashcard-voice-settings', JSON.stringify(this.voiceSettings));
  };
  
  // å„²å­˜Sheetè¨­å®š
  FlashcardApp.prototype.saveSheetSettings = function() {
    localStorage.setItem('flashcard-sheet-settings', JSON.stringify(this.sheetSettings));
  };
  
  // æ‡‰ç”¨è¨­å®š
  FlashcardApp.prototype.applySettings = function() {
    var englishWord = document.getElementById('english-word');
    var chineseWord = document.getElementById('chinese-word');
    var loadingText = document.querySelector('#loading p');
    
    if (englishWord) englishWord.style.fontSize = this.settings.fontSize + 'px';
    if (chineseWord) chineseWord.style.fontSize = this.settings.fontSize + 'px';
    if (loadingText) loadingText.style.fontSize = this.settings.fontSize + 'px';
    
    var delaySlider = document.getElementById('delay-setting');
    var fontSizeSlider = document.getElementById('font-size-setting');
    var reverseToggle = document.getElementById('reverse-setting');
    var delayValue = document.getElementById('delay-value');
    var fontSizeValue = document.getElementById('font-size-value');
    
    if (delaySlider && delayValue) {
      delaySlider.value = this.settings.delayTime;
      delayValue.textContent = this.settings.delayTime;
    }
    if (fontSizeSlider && fontSizeValue) {
      fontSizeSlider.value = this.settings.fontSize;
      fontSizeValue.textContent = this.settings.fontSize + 'px';
    }
    if (reverseToggle) reverseToggle.checked = this.settings.reverseMode;
  };
  
  // è¼‰å…¥å–®å­—
  FlashcardApp.prototype.loadWords = function(isInitialLoad, callback) {
    var self = this;
    callback = callback || function() {};
    
    if (this.sheetSettings.sheetId && this.sheetSettings.selectedSheets.length > 0) {
      var autoHandle = isInitialLoad;
      
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('è¼‰å…¥çµæœ:', result);
          
          if (result && result.words && result.words.length > 0) {
            self.words = result.words;
            self.difficultWords = self.words.filter(function(w) { return w.difficult; }).map(function(w) { return w.id; });
            
            if (result.autoHandled) {
              console.log('é‡è¤‡å–®å­—å·²è‡ªå‹•è™•ç†:', result.autoResults);
              if (result.autoResults && result.autoResults.successCount > 0) {
                self.showAutoProcessingNotification(result.autoResults);
              }
              callback(false);
            } else if (result.hasDuplicates && result.duplicates.length > 0) {
              console.log('ç™¼ç¾é‡è¤‡å–®å­—éœ€è¦æ‰‹å‹•è™•ç†:', result.duplicates);
              self.duplicateWords = result.duplicates;
              self.currentDuplicateIndex = 0;
              self.duplicateProcessingResults = [];
              
              if (document.readyState === 'complete') {
                self.showDuplicateModal();
      } else {
                window.addEventListener('load', function() {
                  self.showDuplicateModal();
                });
              }
              callback(true);
        return;
            } else {
              callback(false);
            }
          } else {
            throw new Error('æ²’æœ‰æ‰¾åˆ°å–®å­—è³‡æ–™');
          }
        })
        .withFailureHandler(function(error) {
          console.error('è¼‰å…¥å–®å­—å¤±æ•—:', error);
          self.showError();
        })
        .getWordsFromSheetsWithDuplicateDetection(this.sheetSettings.sheetId, this.sheetSettings.selectedSheets, autoHandle);
    } else {
      google.script.run
        .withSuccessHandler(function(words) {
          if (words && words.length > 0) {
            self.words = words;
            self.difficultWords = words.filter(function(w) { return w.difficult; }).map(function(w) { return w.id; });
            callback(false);
          } else {
            throw new Error('æ²’æœ‰æ‰¾åˆ°å–®å­—è³‡æ–™');
          }
        })
        .withFailureHandler(function(error) {
          console.error('è¼‰å…¥å–®å­—å¤±æ•—:', error);
          self.showError();
        })
        .getWordsFromSheet();
    }
  };
  
  // è¨­ç½®äº‹ä»¶ç›£è½å™¨
  FlashcardApp.prototype.setupEventListeners = function() {
    console.log('è¨­ç½®äº‹ä»¶ç›£è½å™¨...');
  
    if (this.listenersSetup) {
      console.log('äº‹ä»¶ç›£è½å™¨å·²è¨­ç½®ï¼Œè·³éé‡è¤‡è¨­ç½®');
        return;
      }
      
    this.setupCoreListeners();
    this.setupMenuListeners();
    this.setupModalListeners();
    this.setupKeyboardListeners();
    this.setupProgressAndExportListeners();
  
    this.listenersSetup = true;
    console.log('æ‰€æœ‰äº‹ä»¶ç›£è½å™¨è¨­ç½®å®Œæˆ');
  };
  
  // æ ¸å¿ƒç›£è½å™¨
  FlashcardApp.prototype.setupCoreListeners = function() {
    var self = this;
    
    var englishSection = document.getElementById('english-section');
    var chineseSection = document.getElementById('chinese-section');
    var nextBtn = document.getElementById('next-btn');
    var prevBtn = document.getElementById('prev-btn');
    var restartBtn = document.getElementById('restart-btn');
    
    if (englishSection) {
      englishSection.addEventListener('click', function() { self.onWordClick(); });
    }
    if (chineseSection) {
      chineseSection.addEventListener('click', function() { self.onWordClick(); });
    }
    if (nextBtn) {
      nextBtn.addEventListener('click', function() { self.nextWord(); });
    }
    if (prevBtn) {
      prevBtn.addEventListener('click', function() { self.previousWord(); });
    }
    if (restartBtn) {
      restartBtn.addEventListener('click', function() { self.confirmRestart(); });
    }
    
    // æ–°å¢æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
    var voiceToggleBtn = document.getElementById('voice-toggle-btn');
    var pauseBtn = document.getElementById('pause-btn');
    
    if (voiceToggleBtn) {
      voiceToggleBtn.addEventListener('click', function() { self.toggleVoice(); });
    }
    if (pauseBtn) {
      pauseBtn.addEventListener('click', function() { self.togglePause(); });
    }
  };
  
  // é¸å–®ç›£è½å™¨
  FlashcardApp.prototype.setupMenuListeners = function() {
    console.log('è¨­å®šé¸å–®äº‹ä»¶ç›£è½å™¨...');
    
    var self = this;
    var menuBtn = document.getElementById('menu-btn');
    var menuDropdown = document.getElementById('menu-dropdown');
    
    if (!menuBtn || !menuDropdown) {
      console.error('æ‰¾ä¸åˆ°é¸å–®å…ƒç´ ');
      return;
    }
    
    // ä½¿ç”¨å§”æ´¾äº‹ä»¶ç›£è½
    document.addEventListener('click', function(e) {
      // è™•ç†é¸å–®æŒ‰éˆ•é»æ“Š
      if (e.target.id === 'menu-btn' || e.target.closest('#menu-btn')) {
        console.log('é¸å–®æŒ‰éˆ•è¢«é»æ“Š');
        e.stopPropagation();
        self.toggleMenu();
        return;
      }
      
      // è™•ç†é¸å–®é …ç›®é»æ“Š
      if (e.target.closest('#menu-dropdown')) {
        console.log('é»æ“Šé¸å–®ä¸‹æ‹‰é¸é …');
        e.stopPropagation();
  
        if (e.target.id === 'restart-btn') {
          console.log('é‡æ–°é–‹å§‹æŒ‰éˆ•è¢«é»æ“Š');
          self.closeMenu();
          self.confirmRestart();
        } else if (e.target.id === 'sheet-settings-btn') {
          console.log('Google Sheet è¨­å®šæŒ‰éˆ•è¢«é»æ“Š');
          self.closeMenu();
          self.openSheetSettings();
        } else if (e.target.id === 'voice-settings-btn') {
          console.log('èªéŸ³è¨­å®šæŒ‰éˆ•è¢«é»æ“Š');
          self.closeMenu();
          self.openVoiceSettings();
        } else if (e.target.id === 'settings-btn') {
          console.log('è¨­å®šæŒ‰éˆ•è¢«é»æ“Š');
          self.closeMenu();
          self.openSettings();
        } else if (e.target.id === 'export-btn') {
          console.log('åŒ¯å‡ºæŒ‰éˆ•è¢«é»æ“Š');
          self.closeMenu();
          self.openExportModal();
        }
        return;
      }
  
      // é»æ“Šå…¶ä»–åœ°æ–¹é—œé–‰é¸å–®
      self.closeMenu();
    });
  
    console.log('é¸å–®äº‹ä»¶ç›£è½å™¨è¨­å®šå®Œæˆ');
  };
  
  // é¡¯ç¤ºèªéŸ³å•Ÿç”¨ç•Œé¢
  FlashcardApp.prototype.showSpeechActivation = function() {
    console.log('é¡¯ç¤ºèªéŸ³å•Ÿç”¨ç•Œé¢ (èˆŠç‰ˆç€è¦½å™¨)');
    var activationContainer = document.getElementById('speech-activation-container');
    if (activationContainer) {
      activationContainer.style.display = 'block';
    }
    
    // è¨­ç½®èªéŸ³å•Ÿç”¨æŒ‰éˆ•äº‹ä»¶
    var activateBtn = document.getElementById('activate-speech-btn');
    var self = this;
    if (activateBtn) {
      activateBtn.addEventListener('click', function() {
        self.activateSpeech();
      });
    }
  };
  
  // å•Ÿç”¨èªéŸ³åŠŸèƒ½
  FlashcardApp.prototype.activateSpeech = function() {
    console.log('ç”¨æˆ¶é»æ“Šå•Ÿç”¨èªéŸ³æŒ‰éˆ•');
    
    // æ¸¬è©¦èªéŸ³åŠŸèƒ½æ˜¯å¦å¯ç”¨
    try {
      var testUtterance = new SpeechSynthesisUtterance('');
      testUtterance.volume = 0; // éœéŸ³æ¸¬è©¦
      this.speechSynthesis.speak(testUtterance);
      
      this.speechActivated = true;
      console.log('èªéŸ³åŠŸèƒ½å·²å•Ÿç”¨');
      
      // éš±è—èªéŸ³å•Ÿç”¨ç•Œé¢
      var activationContainer = document.getElementById('speech-activation-container');
      if (activationContainer) {
        activationContainer.style.display = 'none';
      }
      
      // é€²å…¥ä¸»ç•«é¢
      this.hideLoading();
      this.applySettings();
      
      if (this.sheetSettings.sheetId && this.sheetSettings.selectedSheets.length > 0) {
        this.startNewRound();
      } else {
        this.openSheetSettings();
      }
      
    } catch (error) {
      console.error('èªéŸ³å•Ÿç”¨å¤±æ•—:', error);
      alert('èªéŸ³åŠŸèƒ½å•Ÿç”¨å¤±æ•—ï¼Œä½†ç¨‹å¼ä»å¯æ­£å¸¸ä½¿ç”¨');
      this.speechActivated = false;
      
      // ä»ç„¶é€²å…¥ä¸»ç•«é¢
      var activationContainer = document.getElementById('speech-activation-container');
      if (activationContainer) {
        activationContainer.style.display = 'none';
      }
      this.hideLoading();
      this.applySettings();
      
      if (this.sheetSettings.sheetId && this.sheetSettings.selectedSheets.length > 0) {
        this.startNewRound();
      } else {
        this.openSheetSettings();
      }
    }
  };
  
  // éš±è—è¼‰å…¥ç•«é¢
  FlashcardApp.prototype.hideLoading = function() {
    var loadingDiv = document.getElementById('loading');
    var flashcardDiv = document.getElementById('flashcard');
    if (loadingDiv) loadingDiv.style.display = 'none';
    if (flashcardDiv) flashcardDiv.style.display = 'flex';
    
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    this.updateVoiceButtonState();
    this.updatePauseButtonState();
  };
  
  // é¡¯ç¤ºéŒ¯èª¤
  FlashcardApp.prototype.showError = function() {
    var loadingDiv = document.getElementById('loading');
    var errorDiv = document.getElementById('error');
    if (loadingDiv) loadingDiv.style.display = 'none';
    if (errorDiv) errorDiv.style.display = 'block';
  };
  
  // é–‹å§‹æ–°å›åˆ
  FlashcardApp.prototype.startNewRound = function() {
    this.shuffleArray(this.words);
    if (this.showDifficultOnly) {
      this.currentWords = this.words.filter(function(w) { 
        return this.difficultWords.includes(w.id); 
      }, this);
        } else {
      this.currentWords = this.words.slice();
    }
    this.currentIndex = 0;
    this.removedWords = [];
    this.navigationHistory = [];
    this.pendingRemoval = null;
          
          if (this.currentWords.length === 0) {
      if (this.showDifficultOnly) {
        alert('æ²’æœ‰ä¸ç†Ÿå–®å­—ï¼');
        this.showDifficultOnly = false;
        var checkbox = document.getElementById('show-difficult-only');
        if (checkbox) checkbox.checked = false;
        this.currentWords = this.words.slice();
          }
        }
        
        this.displayCurrentWord();
    this.updateButtonStates();
    this.updateVoiceButtonState();
    this.updatePauseButtonState();
      this.renderDifficultStar();
  };
  
  // æ´—ç‰Œ
  FlashcardApp.prototype.shuffleArray = function(array) {
    for (var i = array.length - 1; i > 0; i--) {
      var j = Math.floor(Math.random() * (i + 1));
      var temp = array[i];
      array[i] = array[j];
      array[j] = temp;
    }
  };
  
  // é¡¯ç¤ºç•¶å‰å–®å­—
  FlashcardApp.prototype.displayCurrentWord = function() {
    if (this.currentWords.length === 0) {
      this.startNewRound();
      return;
    }
    
    var currentWord = this.currentWords[this.currentIndex];
    var englishElement = document.getElementById('english-word');
    var chineseElement = document.getElementById('chinese-word');
    
    this.showingChinese = false;
    this.isTransitioning = false;
    this.isProcessingClick = false;
      this.pendingRemoval = null;
      
      if (this.displayTimer) {
        clearTimeout(this.displayTimer);
      }
      
    englishElement.classList.remove('show');
    chineseElement.classList.remove('show');
    
    englishElement.style.color = '';
    chineseElement.style.color = '';
    
    var self = this;
    setTimeout(function() {
      var firstElement = document.getElementById('english-word');
      
      if (self.settings.reverseMode) {
        firstElement.textContent = currentWord.chinese;
      } else {
        firstElement.textContent = currentWord.english;
        setTimeout(function() {
          self.speakEnglishWord(currentWord.english);
        }, 500);
      }
      firstElement.classList.add('show');
  
      self.displayTimer = setTimeout(function() {
        self.showSecondPartAndScheduleNext();
      }, self.settings.delayTime * 1000);
      
    }, 100);
    
    this.renderDifficultStar();
    this.updateProgress();
    this.updateButtonStates();
  };
  
  // æ›´æ–°é€²åº¦
  FlashcardApp.prototype.updateProgress = function() {
    var progressText = document.getElementById('progress-text');
    if (progressText) {
      var current = this.currentIndex + 1;
      var total = this.currentWords.length;
      progressText.textContent = current + '/' + total;
    }
  };
  
  // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
  FlashcardApp.prototype.updateButtonStates = function() {
    var prevBtn = document.getElementById('prev-btn');
    if (prevBtn) {
      var isFirstWord = this.currentIndex === 0;
      var hasPendingRemoval = this.pendingRemoval !== null;
      prevBtn.disabled = (isFirstWord && !hasPendingRemoval) || this.navigationHistory.length === 0;
    }
  };
  
  // åˆ‡æ›é¸å–®
  FlashcardApp.prototype.toggleMenu = function() {
    console.log('toggleMenu è¢«èª¿ç”¨');
    var menuBtn = document.getElementById('menu-btn');
    var menuDropdown = document.getElementById('menu-dropdown');
    
    if (!menuBtn || !menuDropdown) {
      console.error('é¸å–®å…ƒç´ ä¸å­˜åœ¨ï¼Œç„¡æ³•åˆ‡æ›');
        return;
      }
      
    var isOpen = menuDropdown.classList.contains('show');
    console.log('é¸å–®ç›®å‰ç‹€æ…‹:', isOpen ? 'é–‹å•Ÿ' : 'é—œé–‰');
    
    if (isOpen) {
      this.closeMenu();
    } else {
      console.log('é–‹å•Ÿé¸å–®');
      menuBtn.classList.add('active');
      menuDropdown.classList.add('show');
    }
  };
  
  // é—œé–‰é¸å–®
  FlashcardApp.prototype.closeMenu = function() {
    console.log('closeMenu è¢«èª¿ç”¨');
    var menuBtn = document.getElementById('menu-btn');
    var menuDropdown = document.getElementById('menu-dropdown');
    
    if (menuBtn && menuDropdown) {
      console.log('é—œé–‰é¸å–®');
      menuBtn.classList.remove('active');
      menuDropdown.classList.remove('show');
    }
  };
  
  // æ¨¡æ…‹æ¡†ç›£è½å™¨
  FlashcardApp.prototype.setupModalListeners = function() {
    var self = this;
    
    // ä¸»è¨­å®šæ¨¡æ…‹æ¡†
    var settingsModal = document.getElementById('settings-modal');
    var closeSettings = document.getElementById('close-settings');
    var saveSettings = document.getElementById('save-settings');
    var resetSettings = document.getElementById('reset-settings');
    var delaySlider = document.getElementById('delay-setting');
    var fontSizeSlider = document.getElementById('font-size-setting');
    
    if (closeSettings) {
      closeSettings.addEventListener('click', function() { self.closeSettings(); });
    }
    if (saveSettings) {
      saveSettings.addEventListener('click', function() { self.saveSettingsAndClose(); });
    }
    if (resetSettings) {
      resetSettings.addEventListener('click', function() { self.resetSettings(); });
    }
    if (settingsModal) {
      settingsModal.addEventListener('click', function(e) {
        if (e.target === settingsModal) self.closeSettings();
      });
    }
    
    // ä¿®å¾©ï¼šè¨­å®šæ»‘æ¡¿å¯¦æ™‚æ›´æ–°
    if (delaySlider) {
      delaySlider.addEventListener('input', function(e) {
        var delayValue = document.getElementById('delay-value');
        if (delayValue) {
          delayValue.textContent = e.target.value;
        }
      });
    }
    
    if (fontSizeSlider) {
      fontSizeSlider.addEventListener('input', function(e) {
        var fontSizeValue = document.getElementById('font-size-value');
        if (fontSizeValue) {
          fontSizeValue.textContent = e.target.value + 'px';
        }
        // å³æ™‚é è¦½å­—é«”å¤§å°
        var englishWord = document.getElementById('english-word');
        var chineseWord = document.getElementById('chinese-word');
        if (englishWord) englishWord.style.fontSize = e.target.value + 'px';
        if (chineseWord) chineseWord.style.fontSize = e.target.value + 'px';
      });
    }
    
    // Google Sheet è¨­å®šæ¨¡æ…‹æ¡†
    var sheetSettingsModal = document.getElementById('sheet-settings-modal');
    var closeSheetSettings = document.getElementById('close-sheet-settings');
    var cancelSheetSettings = document.getElementById('cancel-sheet-settings');
    var saveSheetSettings = document.getElementById('save-sheet-settings');
    var loadSheetsBtn = document.getElementById('load-sheets-btn');
    
    if (closeSheetSettings) {
      closeSheetSettings.addEventListener('click', function() { self.closeSheetSettings(); });
    }
    if (cancelSheetSettings) {
      cancelSheetSettings.addEventListener('click', function() { self.closeSheetSettings(); });
    }
    if (saveSheetSettings) {
      saveSheetSettings.addEventListener('click', function() { self.saveSheetSettingsAndClose(); });
    }
    if (loadSheetsBtn) {
      loadSheetsBtn.addEventListener('click', function() { self.loadSheetsList(); });
    }
    if (sheetSettingsModal) {
      sheetSettingsModal.addEventListener('click', function(e) {
        if (e.target === sheetSettingsModal) self.closeSheetSettings();
      });
    }
    
    // èªéŸ³è¨­å®šæ¨¡æ…‹æ¡†
    var voiceSettingsModal = document.getElementById('voice-settings-modal');
    var closeVoiceSettings = document.getElementById('close-voice-settings');
    var cancelVoiceSettings = document.getElementById('cancel-voice-settings');
    var saveVoiceSettings = document.getElementById('save-voice-settings');
    var voiceRateSlider = document.getElementById('voice-rate-setting');
    
    if (closeVoiceSettings) {
      closeVoiceSettings.addEventListener('click', function() { self.closeVoiceSettings(); });
    }
    if (cancelVoiceSettings) {
      cancelVoiceSettings.addEventListener('click', function() { self.closeVoiceSettings(); });
    }
    if (saveVoiceSettings) {
      saveVoiceSettings.addEventListener('click', function() { self.saveVoiceSettingsAndClose(); });
    }
    if (voiceSettingsModal) {
      voiceSettingsModal.addEventListener('click', function(e) {
        if (e.target === voiceSettingsModal) self.closeVoiceSettings();
      });
    }
    if (voiceRateSlider) {
      voiceRateSlider.addEventListener('input', function(e) {
        var voiceRateValue = document.getElementById('voice-rate-value');
        if (voiceRateValue) {
          voiceRateValue.textContent = e.target.value;
        }
      });
    }
    
    // åŒ¯å‡ºæ¨¡æ…‹æ¡†
    var exportModal = document.getElementById('export-modal');
    if (exportModal) {
      exportModal.addEventListener('click', function(e) {
        if (e.target === exportModal) self.closeExportModal();
      });
    }
    
    // è¦†å¯«ç¢ºèªæ¨¡æ…‹æ¡†
    var overwriteModal = document.getElementById('overwrite-confirm-modal');
    if (overwriteModal) {
      overwriteModal.addEventListener('click', function(e) {
        if (e.target === overwriteModal) self.closeOverwriteConfirmModal();
      });
    }
  };
  
  // éµç›¤ç›£è½å™¨
  FlashcardApp.prototype.setupKeyboardListeners = function() {
    var self = this;
    
    document.addEventListener('keydown', function(e) {
      if (self.isPaused) return;
  
      var keyActions = {
        'Enter': function() { self.toggleDifficultCurrentWord(); },
        'KeyS': function() { self.toggleDifficultCurrentWord(); },
        'Space': function() { self.onWordClick(); },
        'KeyD': function() { self.onWordClick(); },
        'KeyR': function() { self.restart(); }, // é‡æ–°è¼‰å…¥å–®å­—
        'ArrowLeft': function() { self.previousWord(); },
        'ArrowUp': function() { self.previousWord(); },
        'ArrowRight': function() { self.nextWord(); },
        'ArrowDown': function() { self.nextWord(); },
        'Escape': function() {
          self.closeSettings();
          self.closeVoiceSettings();
          self.closeExportModal();
          self.closeOverwriteConfirmModal();
          self.closeDuplicateModal();
          self.closeMenu();
        }
      };
  
      if (keyActions[e.code]) {
        e.preventDefault();
        keyActions[e.code]();
      }
    });
  };
  
  // é€²åº¦å€å’ŒåŒ¯å‡ºç›£è½å™¨
  FlashcardApp.prototype.setupProgressAndExportListeners = function() {
    console.log('è¨­ç½®é€²åº¦å€å’ŒåŒ¯å‡ºäº‹ä»¶ç›£è½å™¨...');
    var self = this;
  
    // ä¿®å¾©ï¼šé€²åº¦å€é»æ“Šæ¨™è¨»/å–æ¶ˆä¸ç†Ÿå–®å­—
    var progressArea = document.getElementById('progress-area');
    if (progressArea) {
      // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨
      var newProgressArea = progressArea.cloneNode(true);
      progressArea.parentNode.replaceChild(newProgressArea, progressArea);
  
      newProgressArea.addEventListener('click', function() {
        console.log('é€²åº¦å€è¢«é»æ“Šï¼Œåˆ‡æ›å›°é›£å–®å­—ç‹€æ…‹');
        self.toggleDifficultCurrentWord();
      });
      console.log('é€²åº¦å€äº‹ä»¶ç›£è½å™¨è¨­ç½®å®Œæˆ');
      } else {
      console.error('æ‰¾ä¸åˆ° progress-area å…ƒç´ ');
    }
  
    // åªé¡¯ç¤ºä¸ç†Ÿå–®å­—checkbox
    var showDifficultCheckbox = document.getElementById('show-difficult-only');
    if (showDifficultCheckbox) {
      showDifficultCheckbox.addEventListener('change', function(e) {
        console.log('åˆ‡æ›åªé¡¯ç¤ºä¸ç†Ÿå–®å­—:', e.target.checked);
        self.showDifficultOnly = e.target.checked;
        self.filterWordsByDifficult();
      });
      console.log('ä¸ç†Ÿå–®å­—éæ¿¾å™¨äº‹ä»¶ç›£è½å™¨è¨­ç½®å®Œæˆ');
    } else {
      console.error('æ‰¾ä¸åˆ° show-difficult-only å…ƒç´ ');
    }
  
    // åŒ¯å‡ºç›¸é—œäº‹ä»¶
    var closeExportModal = document.getElementById('close-export-modal');
    var cancelExport = document.getElementById('cancel-export');
    var confirmExport = document.getElementById('confirm-export');
  
    if (closeExportModal) {
      closeExportModal.addEventListener('click', function() { self.closeExportModal(); });
    }
    if (cancelExport) {
      cancelExport.addEventListener('click', function() { self.closeExportModal(); });
    }
    if (confirmExport) {
      confirmExport.addEventListener('click', function() { self.confirmExport(); });
    }
  
    console.log('åŒ¯å‡ºç›¸é—œäº‹ä»¶ç›£è½å™¨è¨­ç½®å®Œæˆ');
    
    // éš±è—æ§åˆ¶æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
    this.setupHiddenControlListeners();
  };
  
  // è¨­ç½®éš±è—æ§åˆ¶æŒ‰éˆ•ç›£è½å™¨
  FlashcardApp.prototype.setupHiddenControlListeners = function() {
    console.log('è¨­ç½®éš±è—æ§åˆ¶æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨...');
    var self = this;
    

    
    
    

    
    console.log('éš±è—æ§åˆ¶æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨è¨­ç½®å®Œæˆ');
  };
  

  

  

  

  

  

  
  // é–‹å•Ÿè¨­å®š
  FlashcardApp.prototype.openSettings = function() {
    var settingsModal = document.getElementById('settings-modal');
    if (settingsModal) {
      settingsModal.style.display = 'flex';
      this.pauseTimer();
      this.applySettings();
    }
  };
  
  // é—œé–‰è¨­å®š
  FlashcardApp.prototype.closeSettings = function(shouldRedisplay) {
    var settingsModal = document.getElementById('settings-modal');
    if (settingsModal) {
      settingsModal.style.display = 'none';
      this.resumeTimer();
      
      if (shouldRedisplay) {
        this.redisplayCurrentWord();
      }
    }
  };
  
  // å„²å­˜è¨­å®šä¸¦é—œé–‰
  FlashcardApp.prototype.saveSettingsAndClose = function() {
    var delaySlider = document.getElementById('delay-setting');
    var fontSizeSlider = document.getElementById('font-size-setting');
    var reverseToggle = document.getElementById('reverse-setting');
    
    var oldReverseMode = this.settings.reverseMode;
    
    if (delaySlider) this.settings.delayTime = parseFloat(delaySlider.value);
    if (fontSizeSlider) this.settings.fontSize = parseInt(fontSizeSlider.value);
    if (reverseToggle) this.settings.reverseMode = reverseToggle.checked;
    
    this.saveSettings();
    this.applySettings();
    this.closeSettings();
    
    if (oldReverseMode !== this.settings.reverseMode) {
      this.redisplayCurrentWord();
    }
  };
  
  // é‡ç½®è¨­å®š
  FlashcardApp.prototype.resetSettings = function() {
    this.settings = {
      delayTime: 3,
      fontSize: 96,
      reverseMode: false
    };
    this.voiceSettings = {
      enabled: true,
      rate: 0.8,
      pitch: 1,
      volume: 1,
      lang: 'en-US',
      voiceURI: ''
    };
    this.applySettings();
      this.saveSettings();
    this.closeSettings();
  };
  
  // æš«åœè¨ˆæ™‚å™¨
  FlashcardApp.prototype.pauseTimer = function() {
    this.isPaused = true;
    
    if (this.displayTimer) {
      clearTimeout(this.displayTimer);
      this.displayTimer = null;
    }
    

  };
  
  // æ¢å¾©è¨ˆæ™‚å™¨
  FlashcardApp.prototype.resumeTimer = function() {
    this.isPaused = false;
    

    
    var self = this;
    if (this.showingChinese) {
      this.displayTimer = setTimeout(function() {
        self.nextWord();
      }, this.settings.delayTime * 1000);
    } else if (!this.isTransitioning && !this.isProcessingClick) {
      var currentWord = this.currentWords[this.currentIndex];
      if (currentWord) {
        this.displayTimer = setTimeout(function() {
          self.showSecondPartAndScheduleNext();
        }, this.settings.delayTime * 1000);
      }
    }
  };
  
  // é–‹å•ŸGoogle Sheetè¨­å®š
  FlashcardApp.prototype.openSheetSettings = function() {
    console.log('é–‹å•Ÿ Google Sheet è¨­å®šç•«é¢');
    var modal = document.getElementById('sheet-settings-modal');
    if (modal) {
      modal.style.display = 'flex';
      
      var sheetIdInput = document.getElementById('sheet-id-input');
      if (sheetIdInput) {
        sheetIdInput.value = this.sheetSettings.sheetId || '';
      }
      
      var sheetsGroup = document.getElementById('sheets-selection-group');
      if (sheetsGroup) {
      sheetsGroup.style.display = 'none';
      }
      
      var saveBtn = document.getElementById('save-sheet-settings');
      if (saveBtn) {
      saveBtn.disabled = true;
      }
      
      this.pauseTimer();
    }
  };
  
  // é—œé–‰Google Sheetè¨­å®š
  FlashcardApp.prototype.closeSheetSettings = function() {
    var modal = document.getElementById('sheet-settings-modal');
    if (modal) {
      modal.style.display = 'none';
      this.resumeTimer();
    }
  };
  
  // æ¨™è¨»å›°é›£å–®å­—
  FlashcardApp.prototype.toggleDifficultCurrentWord = function() {
    if (this.currentWords.length === 0) return;
    
    var currentWord = this.currentWords[this.currentIndex];
      if (!currentWord) return;
      
    var id = currentWord.id;
    var isDifficult = this.difficultWords.includes(id);
    
      if (isDifficult) {
      this.difficultWords = this.difficultWords.filter(function(did) { return did !== id; });
        } else {
        this.difficultWords.push(id);
      }
      
      // å¾Œç«¯åŒæ­¥
      if (typeof google !== 'undefined' && google.script && google.script.run) {
      var rowIndex = currentWord.originalRowIndex;
        if (rowIndex === undefined) {
        rowIndex = this.words.findIndex(function(w) {
          return w.english === currentWord.english && w.chinese === currentWord.chinese;
        });
        }
        
        if (rowIndex !== -1) {
        var sheetId = this.sheetSettings.sheetId;
        var sheetName = currentWord.sheetName || 'Sheet1';
        var markValue = isDifficult ? '' : '*';
          console.log('æ¨™è¨»å–®å­—:', currentWord.english, 'è¡Œç´¢å¼•:', rowIndex, 'æ¨™è¨˜å€¼:', markValue);
          google.script.run.markWordAsDifficult(sheetId, sheetName, rowIndex, markValue);
        }
      }
  
    // è™•ç†ã€Œåªé¡¯ç¤ºä¸ç†Ÿå–®å­—ã€æ¨¡å¼
      if (this.showDifficultOnly && isDifficult) {
        this.currentWords.splice(this.currentIndex, 1);
        
        if (this.currentIndex >= this.currentWords.length) {
          this.currentIndex = 0;
        }
        
        if (this.currentWords.length === 0) {
          alert('æ­å–œï¼æ²’æœ‰ä¸ç†Ÿå–®å­—äº†ï¼');
          this.showDifficultOnly = false;
        var checkbox = document.getElementById('show-difficult-only');
        if (checkbox) checkbox.checked = false;
          this.startNewRound();
        } else {
          this.displayCurrentWord();
        }
      } else {
        this.renderDifficultStar();
      }
  };
  
  // æ¸²æŸ“å›°é›£æ˜Ÿæ˜Ÿ
  FlashcardApp.prototype.renderDifficultStar = function() {
    var currentWord = this.currentWords[this.currentIndex];
    var star = document.getElementById('difficult-star');
    if (star && currentWord && this.difficultWords.includes(currentWord.id)) {
        star.classList.add('visible');
    } else if (star) {
        star.classList.remove('visible');
      }
  };
    
  // éæ¿¾å›°é›£å–®å­—
  FlashcardApp.prototype.filterWordsByDifficult = function() {
      if (this.showDifficultOnly) {
      var self = this;
      this.currentWords = this.words.filter(function(w) { return self.difficultWords.includes(w.id); });
        this.currentIndex = 0;
      } else {
      this.currentWords = this.words.slice();
        this.currentIndex = 0;
      }
      this.displayCurrentWord();
  };
  
  // å–®å­—é»æ“Šäº‹ä»¶ï¼ˆåˆªé™¤å–®å­—åŠŸèƒ½ï¼‰
  FlashcardApp.prototype.onWordClick = function() {
    if (this.isTransitioning || this.isPaused) return;
    
    if (this.currentWords.length <= 1) {
      var sections = document.querySelectorAll('.card-section');
      for (var i = 0; i < sections.length; i++) {
        sections[i].style.backgroundColor = 'rgba(255, 100, 100, 0.3)';
        (function(section) {
          setTimeout(function() {
            section.style.backgroundColor = '';
          }, 300);
        })(sections[i]);
      }
      return;
    }
    
    var currentWord = this.currentWords[this.currentIndex];
    var englishElement = document.getElementById('english-word');
    var chineseElement = document.getElementById('chinese-word');
    
    var isAlreadyMarked = englishElement.style.color === 'rgb(102, 102, 102)' || 
                        englishElement.style.color === '#666666';
    
    if (isAlreadyMarked) {
      this.nextWord();
        return;
      }
      
    this.isProcessingClick = true;
    
    if (this.displayTimer) {
      clearTimeout(this.displayTimer);
    }
    
    if (!this.showingChinese) {
      var secondText = this.settings.reverseMode ? currentWord.english : currentWord.chinese;
      chineseElement.textContent = secondText;
      chineseElement.classList.add('show');
      this.showingChinese = true;
      
      if (this.settings.reverseMode) {
        var self = this;
        setTimeout(function() {
          self.speakEnglishWord(currentWord.english);
        }, 500);
      }
    }
    
    englishElement.style.color = '#666666';
    chineseElement.style.color = '#666666';
    
    var sections = document.querySelectorAll('.card-section');
    for (var i = 0; i < sections.length; i++) {
      sections[i].classList.add('clicked');
      (function(section) {
        setTimeout(function() { 
          section.classList.remove('clicked'); 
        }, 500);
      })(sections[i]);
    }
    
    this.pendingRemoval = {
      word: currentWord,
      index: this.currentIndex,
      originalEnglishColor: englishElement.style.color,
      originalChineseColor: chineseElement.style.color
    };
    
    this.updateButtonStates();
    
    var self = this;
    this.displayTimer = setTimeout(function() {
      self.confirmRemoval();
    }, this.settings.delayTime * 1000);
  };
  
  // ç¢ºèªç§»é™¤å–®å­—
  FlashcardApp.prototype.confirmRemoval = function() {
    if (!this.pendingRemoval) return;
    
    var word = this.pendingRemoval.word;
    var index = this.pendingRemoval.index;
    
    this.removedWords.push(word);
    this.currentWords.splice(index, 1);
    
    if (this.currentIndex >= this.currentWords.length) {
      this.currentIndex = 0;
    }
    
    this.pendingRemoval = null;
    
    if (this.currentWords.length === 0) {
      this.startNewRound();
    } else {
      this.displayCurrentWord();
    }
    
    this.isProcessingClick = false;
    this.updateButtonStates();
  };
  
  // å–æ¶ˆç§»é™¤
  FlashcardApp.prototype.cancelRemoval = function() {
    if (!this.pendingRemoval) return;
    
    var englishElement = document.getElementById('english-word');
    var chineseElement = document.getElementById('chinese-word');
    
    englishElement.style.color = '';
    chineseElement.style.color = '';
    
    this.pendingRemoval = null;
    
    if (this.displayTimer) {
      clearTimeout(this.displayTimer);
    }
    
    this.isProcessingClick = false;
    this.updateButtonStates();
    
    var self = this;
    if (this.showingChinese) {
      this.displayTimer = setTimeout(function() {
        self.nextWord();
      }, this.settings.delayTime * 1000);
      } else {
      this.displayTimer = setTimeout(function() {
        self.showSecondPartAndScheduleNext();
      }, this.settings.delayTime * 1000);
    }
  };
  
  // é¡¯ç¤ºç¬¬äºŒéƒ¨åˆ†ä¸¦å®‰æ’ä¸‹ä¸€å€‹
  FlashcardApp.prototype.showSecondPartAndScheduleNext = function() {
    if (this.isPaused || this.showingChinese || !this.currentWords[this.currentIndex]) {
      return;
    }
  
    if (this.displayTimer) {
      clearTimeout(this.displayTimer);
    }
  
    var currentWord = this.currentWords[this.currentIndex];
    var chineseElement = document.getElementById('chinese-word');
    
    var secondText = this.settings.reverseMode ? currentWord.english : currentWord.chinese;
    chineseElement.textContent = secondText;
    chineseElement.classList.add('show');
    this.showingChinese = true;
    
    if (this.settings.reverseMode) {
      var self = this;
      setTimeout(function() {
        self.speakEnglishWord(currentWord.english);
      }, 500);
    }
    
    var self = this;
    this.displayTimer = setTimeout(function() {
      self.nextWord();
    }, this.settings.delayTime * 1000);
  };
  
  // èªéŸ³æ’­æ”¾
  FlashcardApp.prototype.speakEnglishWord = function(text) {
    if (!this.voiceSettings.enabled) return;
    if (!text) return;
    
    // èˆŠç‰ˆç€è¦½å™¨æª¢æŸ¥ç”¨æˆ¶äº¤äº’ç‹€æ…‹
    if (this.isLegacyBrowser && !this.speechActivated) {
      console.log('èˆŠç‰ˆç€è¦½å™¨ï¼šèªéŸ³æœªå•Ÿç”¨ï¼Œè·³éæ’­æ”¾');
      return;
    }
    
    try {
      console.log('æ’­æ”¾èªéŸ³:', text);
      this.speechSynthesis.cancel();
      
      var utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = this.voiceSettings.rate;
      utterance.pitch = this.voiceSettings.pitch;
      utterance.volume = this.voiceSettings.volume;
      utterance.lang = this.voiceSettings.lang;
      
      var voices = this.speechSynthesis.getVoices();
      var selectedVoice = null;
      if (this.voiceSettings.voiceURI) {
        for (var i = 0; i < voices.length; i++) {
          if (voices[i].voiceURI === this.voiceSettings.voiceURI) {
            selectedVoice = voices[i];
            break;
          }
        }
      }
      
      if (!selectedVoice) {
        for (var i = 0; i < voices.length; i++) {
          if (voices[i].lang.indexOf('en-') === 0 || 
              voices[i].name.toLowerCase().indexOf('english') !== -1) {
            selectedVoice = voices[i];
            break;
          }
        }
      }
      
      if (selectedVoice) {
        utterance.voice = selectedVoice;
      }
      
      // ç‚ºèˆŠç‰ˆç€è¦½å™¨æ·»åŠ éŒ¯èª¤è™•ç†
      utterance.onerror = function(event) {
        console.log('èªéŸ³æ’­æ”¾éŒ¯èª¤:', event.error);
      };
      
      utterance.onstart = function() {
        console.log('èªéŸ³é–‹å§‹æ’­æ”¾:', text);
      };
      
      this.speechSynthesis.speak(utterance);
    } catch (error) {
      console.log('èªéŸ³æ’­æ”¾å¤±æ•—:', error);
    }
  };
  
  // ä¸‹ä¸€å€‹å–®å­—
  FlashcardApp.prototype.nextWord = function() {
    if (this.isTransitioning || this.isPaused) return;
    
    if (this.pendingRemoval) {
      this.confirmRemoval();
        return;
      }
      
    if (!this.showingChinese) {
      this.showSecondPartAndScheduleNext();
        return;
      }
      
    this.saveNavigationState();
    
      if (this.displayTimer) {
        clearTimeout(this.displayTimer);
    }
    
    this.speechSynthesis.cancel();
    
    this.isTransitioning = true;
    
    var englishElement = document.getElementById('english-word');
    var chineseElement = document.getElementById('chinese-word');
    
    englishElement.classList.remove('show');
    chineseElement.classList.remove('show');
    
    chineseElement.textContent = '';
    
    var self = this;
    setTimeout(function() {
      self.currentIndex = (self.currentIndex + 1) % self.currentWords.length;
      
      if (self.currentIndex === 0) {
        self.shuffleArray(self.currentWords);
        self.navigationHistory = [];
      }
      
      self.displayCurrentWord();
      self.isTransitioning = false;
      
    }, 300);
    this.renderDifficultStar();
  };
  
  // ä¸Šä¸€å€‹å–®å­—
  FlashcardApp.prototype.previousWord = function() {
    if (this.isTransitioning || this.isPaused) return;
    
    if (this.pendingRemoval) {
      this.cancelRemoval();
      return;
    }
    
    if (this.navigationHistory.length === 0) return;
    
    if (this.displayTimer) {
      clearTimeout(this.displayTimer);
    }
    
    this.speechSynthesis.cancel();
    
    this.isTransitioning = true;
    
    var englishElement = document.getElementById('english-word');
    var chineseElement = document.getElementById('chinese-word');
    
    englishElement.classList.remove('show');
    chineseElement.classList.remove('show');
    
    chineseElement.textContent = '';
    
    var self = this;
    setTimeout(function() {
      var previousState = self.navigationHistory.pop();
      
      var previousWord = previousState.wordSequence[previousState.currentIndex];
      
      var wordIndex = -1;
      for (var i = 0; i < self.currentWords.length; i++) {
        if (self.currentWords[i].english === previousWord.english && 
            self.currentWords[i].chinese === previousWord.chinese) {
          wordIndex = i;
          break;
        }
      }
      
      if (wordIndex !== -1) {
        self.currentIndex = wordIndex;
      } else {
        self.currentIndex = Math.min(previousState.currentIndex, self.currentWords.length - 1);
        
        if (self.currentWords.length === 0) {
          self.startNewRound();
          self.isTransitioning = false;
        return;
        }
      }
      
      self.displayCurrentWord();
      self.isTransitioning = false;
      
    }, 300);
    this.renderDifficultStar();
  };
  
  // å„²å­˜å°èˆªç‹€æ…‹
  FlashcardApp.prototype.saveNavigationState = function() {
    if (this.currentWords.length > 0 && this.currentIndex >= 0) {
      this.navigationHistory.push({
        currentIndex: this.currentIndex,
        wordSequence: this.currentWords.slice()
      });
      
      if (this.navigationHistory.length > 20) {
        this.navigationHistory.shift();
      }
    }
  };
  
  // ç¢ºèªé‡æ–°è¼‰å…¥å–®å­—
  FlashcardApp.prototype.confirmRestart = function() {
    var confirmed = confirm('ç¢ºå®šè¦é‡æ–°è¼‰å…¥å–®å­—å—ï¼Ÿ\n\nâš ï¸ æ³¨æ„ï¼šé‡æ–°è¼‰å…¥æœƒæ¢å¾©æ‰€æœ‰æš«æ™‚åˆªé™¤çš„å–®å­—ã€‚');
    if (confirmed) {
      this.restart();
    }
  };

  // é‡æ–°è¼‰å…¥å–®å­—
  FlashcardApp.prototype.restart = function() {
    if (this.displayTimer) {
      clearTimeout(this.displayTimer);
    }
    this.speechSynthesis.cancel();
    this.pendingRemoval = null;
    this.closeMenu();
    
    // æª¢æŸ¥æ˜¯å¦æœ‰è¨­å®šçš„ Google Sheet
    if (this.sheetSettings.sheetId && this.sheetSettings.selectedSheets.length > 0) {
      console.log('é‡æ–°è¼‰å…¥å–®å­—ï¼Œä½¿ç”¨å·²è¨­å®šçš„ Google Sheet');
        
        // é¡¯ç¤ºè¼‰å…¥ä¸­è¨Šæ¯
      var loadingDiv = document.getElementById('loading');
      var flashcardDiv = document.getElementById('flashcard');
      if (loadingDiv) loadingDiv.style.display = 'flex';
      if (flashcardDiv) flashcardDiv.style.display = 'none';
      
      var self = this;
      this.loadWords(true, function(hasDuplicates) {
        self.hideLoading();
        self.applySettings();
        
          if (!hasDuplicates) {
          self.startNewRound();
        }
      });
    } else {
      console.log('æ²’æœ‰ Google Sheet è¨­å®šï¼Œç›´æ¥é‡æ–°é–‹å§‹');
            this.startNewRound();
          }
  };
  
  // åˆ‡æ›èªéŸ³æ’­æ”¾
  FlashcardApp.prototype.toggleVoice = function() {
    this.voiceSettings.enabled = !this.voiceSettings.enabled;
    this.saveSettings();
    this.updateVoiceButtonState();
    
    // åœæ­¢ç•¶å‰æ’­æ”¾çš„èªéŸ³
    if (!this.voiceSettings.enabled) {
      this.speechSynthesis.cancel();
    }
  };
  
  // æ›´æ–°èªéŸ³æŒ‰éˆ•ç‹€æ…‹
  FlashcardApp.prototype.updateVoiceButtonState = function() {
    var voiceBtn = document.getElementById('voice-toggle-btn');
    if (voiceBtn) {
      if (this.voiceSettings.enabled) {
        voiceBtn.textContent = 'ğŸ”Š';
        voiceBtn.title = 'èªéŸ³æ’­æ”¾ï¼šé–‹å•Ÿï¼ˆé»æ“Šé—œé–‰ï¼‰';
        voiceBtn.style.opacity = '1';
      } else {
        voiceBtn.textContent = 'ğŸ”‡';
        voiceBtn.title = 'èªéŸ³æ’­æ”¾ï¼šé—œé–‰ï¼ˆé»æ“Šé–‹å•Ÿï¼‰';
        voiceBtn.style.opacity = '0.6';
      }
    }
  };
  
  // åˆ‡æ›æš«åœ/æ¢å¾©
  FlashcardApp.prototype.togglePause = function() {
    if (this.isPaused) {
      this.resumeTimer();
      this.updatePauseButtonState();
    } else {
      this.pauseTimer();
      this.updatePauseButtonState();
    }
  };
  
  // æ›´æ–°æš«åœæŒ‰éˆ•ç‹€æ…‹
  FlashcardApp.prototype.updatePauseButtonState = function() {
    var pauseBtn = document.getElementById('pause-btn');
    if (pauseBtn) {
      if (this.isPaused) {
        pauseBtn.textContent = 'â–¶ï¸';
        pauseBtn.title = 'ç›®å‰æš«åœä¸­ï¼ˆé»æ“Šæ¢å¾©ï¼‰';
        pauseBtn.style.opacity = '0.6';
      } else {
        pauseBtn.textContent = 'â¸ï¸';
        pauseBtn.title = 'ç›®å‰é‹è¡Œä¸­ï¼ˆé»æ“Šæš«åœï¼‰';
        pauseBtn.style.opacity = '1';
      }
    }
  };

  // é‡æ–°é¡¯ç¤ºç•¶å‰å–®å­—
  FlashcardApp.prototype.redisplayCurrentWord = function() {
    if (this.displayTimer) {
      clearTimeout(this.displayTimer);
      this.displayTimer = null;
    }
    
    this.speechSynthesis.cancel();
    
    this.showingChinese = false;
    this.isTransitioning = false;
    this.isProcessingClick = false;
    this.pendingRemoval = null;
    
    this.displayCurrentWord();
  };
  
  // èªéŸ³è¨­å®šç›¸é—œ
  FlashcardApp.prototype.openVoiceSettings = function() {
    var modal = document.getElementById('voice-settings-modal');
    if (modal) {
      modal.style.display = 'flex';
      this.pauseTimer();
      
      var speechEnabledSetting = document.getElementById('speech-enabled-setting');
      var voiceRateSetting = document.getElementById('voice-rate-setting');
      var voiceRateValue = document.getElementById('voice-rate-value');
      
      if (speechEnabledSetting) speechEnabledSetting.checked = this.voiceSettings.enabled;
      if (voiceRateSetting) voiceRateSetting.value = this.voiceSettings.rate;
      if (voiceRateValue) voiceRateValue.textContent = this.voiceSettings.rate;
      
      this.populateVoiceSelect();
    }
  };
  
  FlashcardApp.prototype.closeVoiceSettings = function() {
    var modal = document.getElementById('voice-settings-modal');
    if (modal) {
      modal.style.display = 'none';
      this.resumeTimer();
    }
  };
  
  FlashcardApp.prototype.saveVoiceSettingsAndClose = function() {
    var speechEnabledSetting = document.getElementById('speech-enabled-setting');
    var voiceRateSetting = document.getElementById('voice-rate-setting');
    var voiceSelectSetting = document.getElementById('voice-select-setting');
    
    if (speechEnabledSetting) this.voiceSettings.enabled = speechEnabledSetting.checked;
    if (voiceRateSetting) this.voiceSettings.rate = parseFloat(voiceRateSetting.value);
    
    if (voiceSelectSetting) {
      var selectedVoiceURI = voiceSelectSetting.value;
      this.voiceSettings.voiceURI = selectedVoiceURI;
      var voices = this.speechSynthesis.getVoices();
      for (var i = 0; i < voices.length; i++) {
        if (voices[i].voiceURI === selectedVoiceURI) {
          this.voiceSettings.lang = voices[i].lang;
          break;
        }
      }
    }
    
    this.saveSettings();
    this.updateVoiceButtonState();
    this.closeVoiceSettings();
  };
  
  FlashcardApp.prototype.populateVoiceSelect = function() {
    var voiceSelect = document.getElementById('voice-select-setting');
    if (!voiceSelect) return;
    
    voiceSelect.innerHTML = '';
    var voices = this.speechSynthesis.getVoices();
    var englishVoices = voices.filter(function(v) { 
      return v.lang && v.lang.indexOf('en') === 0; 
    });
    
    for (var i = 0; i < englishVoices.length; i++) {
      var voice = englishVoices[i];
      var option = document.createElement('option');
      option.value = voice.voiceURI;
      option.textContent = voice.name + ' (' + voice.lang + ')';
      if (voice.voiceURI === this.voiceSettings.voiceURI) {
        option.selected = true;
      }
      voiceSelect.appendChild(option);
    }
    
    if (!voiceSelect.value && englishVoices.length > 0) {
      voiceSelect.value = englishVoices[0].voiceURI;
    }
  };
  
  // åŒ¯å‡ºåŠŸèƒ½ç›¸é—œï¼ˆå®Œæ•´ç‰ˆæœ¬ï¼‰
  FlashcardApp.prototype.openExportModal = function() {
      // é è¨­åç¨±ï¼šç›®å‰å·¥ä½œè¡¨åç¨±_yyyyMMdd
    var defaultName = this.getDefaultExportSheetName();
    var exportSheetNameInput = document.getElementById('export-sheet-name');
    var exportTypeRemainingRadio = document.getElementById('export-type-remaining');
    var exportModal = document.getElementById('export-modal');
    
    if (exportSheetNameInput) exportSheetNameInput.value = defaultName;
    if (exportTypeRemainingRadio) exportTypeRemainingRadio.checked = true;
    if (exportModal) exportModal.style.display = 'flex';
    
      this.pauseTimer();
    
    // é‡ç½®åŒ¯å‡ºæŒ‰éˆ•ç‹€æ…‹
    var confirmBtn = document.getElementById('confirm-export');
      if (confirmBtn) {
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'åŒ¯å‡º';
      }
  };
  
  FlashcardApp.prototype.closeExportModal = function() {
    var exportModal = document.getElementById('export-modal');
    if (exportModal) exportModal.style.display = 'none';
    
      this.resumeTimer();
    
    // ç¢ºä¿ã€Œå·²æš«åœã€æ¶ˆå¤±
    var pausedIndicator = document.getElementById('paused-indicator');
      if (pausedIndicator) pausedIndicator.remove();
  };
  
  FlashcardApp.prototype.getDefaultExportSheetName = function() {
    // å–ç›®å‰å·¥ä½œè¡¨åç¨±ï¼ˆé è¨­ç‚º Sheet1ï¼‰
    var base = 'Sheet1';
    var date = new Date();
    var y = date.getFullYear();
    var m = (date.getMonth() + 1).toString();
    var d = date.getDate().toString();
    
    // ES5 ç‰ˆæœ¬çš„ padStart
    if (m.length < 2) m = '0' + m;
    if (d.length < 2) d = '0' + d;
    
    return base + '_' + y + m + d;
  };
  
  FlashcardApp.prototype.confirmExport = function() {
      this.performExport(false);
  };
  
  FlashcardApp.prototype.performExport = function(overwrite) {
    var confirmBtn = document.getElementById('confirm-export');
      if (confirmBtn) {
        confirmBtn.disabled = true;
        confirmBtn.textContent = overwrite ? 'è¦†å¯«ä¸­...' : 'åŒ¯å‡ºä¸­...';
      }
      
    var typeRadio = document.getElementById('export-type-difficult');
    var type = (typeRadio && typeRadio.checked) ? 'difficult' : 'remaining';
    var sheetNameInput = document.getElementById('export-sheet-name');
    var sheetName = (sheetNameInput && sheetNameInput.value.trim()) || this.getDefaultExportSheetName();
    var exportWords = [];
    
      if (type === 'difficult') {
      var self = this;
      exportWords = this.words.filter(function(w) { 
        return self.difficultWords.includes(w.id); 
      });
      } else {
        exportWords = this.currentWords;
      }
      
      // åŒ¯å‡ºè³‡æ–™æ ¼å¼
    var exportData = [];
    for (var i = 0; i < exportWords.length; i++) {
      var w = exportWords[i];
      exportData.push({
        english: w.english,
        chinese: w.chinese,
        difficult: this.difficultWords.includes(w.id)
      });
    }
      
      if (exportData.length === 0) {
        alert('æ²’æœ‰å¯åŒ¯å‡ºçš„å–®å­—ï¼');
        if (confirmBtn) {
          confirmBtn.disabled = false;
          confirmBtn.textContent = 'åŒ¯å‡º';
        }
        return;
      }
      
      // å‘¼å« Apps Script
    var targetSheetId = this.sheetSettings.sheetId || null;
    var self = this;
    
      google.script.run
      .withSuccessHandler(function(result) {
          if (confirmBtn) {
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'åŒ¯å‡º';
          }
          
          if (result && result.success === false && result.error === 'SHEET_EXISTS') {
            // å·¥ä½œè¡¨å·²å­˜åœ¨ï¼Œè©¢å•ç”¨æˆ¶æ˜¯å¦è¦†å¯«
          self.handleSheetExistsError(result.message);
          } else if (result && result.success) {
            // åŒ¯å‡ºæˆåŠŸ
            alert(result.message || 'åŒ¯å‡ºæˆåŠŸï¼');
          self.closeExportModal();
          } else {
            // å…¶ä»–æˆåŠŸæƒ…æ³ï¼ˆå‘å¾Œå…¼å®¹ï¼‰
            alert('åŒ¯å‡ºæˆåŠŸï¼');
          self.closeExportModal();
          }
        })
      .withFailureHandler(function(error) {
          console.error('åŒ¯å‡ºå¤±æ•—:', error);
          alert('åŒ¯å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦ï¼');
          if (confirmBtn) {
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'åŒ¯å‡º';
          }
        })
        .exportWordsToSheet(exportData, sheetName, targetSheetId, overwrite);
  };
  
  FlashcardApp.prototype.handleSheetExistsError = function(message) {
    var sheetNameInput = document.getElementById('export-sheet-name');
    var currentSheetName = sheetNameInput ? sheetNameInput.value.trim() : '';
      
      // é¡¯ç¤ºè‡ªå®šç¾©è¦†å¯«ç¢ºèªå°è©±æ¡†
      this.showOverwriteConfirmModal(currentSheetName);
  };
  
  FlashcardApp.prototype.showOverwriteConfirmModal = function(sheetName) {
      // è¨­ç½®å·¥ä½œè¡¨åç¨±
    var existingSheetNameElement = document.getElementById('existing-sheet-name');
    if (existingSheetNameElement) {
      existingSheetNameElement.textContent = sheetName;
    }
      
      // é¡¯ç¤ºå°è©±æ¡†
    var overwriteModal = document.getElementById('overwrite-confirm-modal');
    if (overwriteModal) {
      overwriteModal.style.display = 'flex';
    }
      
      // æš«åœè¨ˆæ™‚å™¨
      this.pauseTimer();
      
      // ç¶å®šäº‹ä»¶è™•ç†ç¨‹åº
      this.bindOverwriteConfirmEvents();
  };
  
  FlashcardApp.prototype.closeOverwriteConfirmModal = function() {
    var overwriteModal = document.getElementById('overwrite-confirm-modal');
    if (overwriteModal) {
      overwriteModal.style.display = 'none';
    }
    
      this.resumeTimer();
      
      // ç§»é™¤äº‹ä»¶è™•ç†ç¨‹åº
      this.unbindOverwriteConfirmEvents();
  };
  
  FlashcardApp.prototype.bindOverwriteConfirmEvents = function() {
    var self = this;
    
      // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶è™•ç†ç¨‹åºï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      this.unbindOverwriteConfirmEvents();
      
      // é—œé–‰æŒ‰éˆ•
    this.closeOverwriteHandler = function() { self.closeOverwriteConfirmModal(); };
    var closeBtn = document.getElementById('close-overwrite-confirm');
    if (closeBtn) {
      closeBtn.addEventListener('click', this.closeOverwriteHandler);
    }
      
      // ä½¿ç”¨ä¸åŒåç¨±æŒ‰éˆ•
    this.useDifferentNameHandler = function() {
      self.closeOverwriteConfirmModal();
      self.suggestAlternativeName();
    };
    var differentNameBtn = document.getElementById('use-different-name');
    if (differentNameBtn) {
      differentNameBtn.addEventListener('click', this.useDifferentNameHandler);
    }
      
      // è¦†å¯«ç¢ºèªæŒ‰éˆ•
    this.overwriteConfirmHandler = function() {
      self.closeOverwriteConfirmModal();
      self.performExport(true);
    };
    var overwriteConfirmBtn = document.getElementById('overwrite-confirm');
    if (overwriteConfirmBtn) {
      overwriteConfirmBtn.addEventListener('click', this.overwriteConfirmHandler);
    }
      
      // éµç›¤äº‹ä»¶è™•ç†
    this.overwriteKeyHandler = function(event) { self.handleOverwriteKeyboard(event); };
      document.addEventListener('keydown', this.overwriteKeyHandler);
  };
  
  FlashcardApp.prototype.unbindOverwriteConfirmEvents = function() {
      if (this.closeOverwriteHandler) {
      var closeBtn = document.getElementById('close-overwrite-confirm');
      if (closeBtn) {
        closeBtn.removeEventListener('click', this.closeOverwriteHandler);
      }
        this.closeOverwriteHandler = null;
      }
      if (this.useDifferentNameHandler) {
      var differentNameBtn = document.getElementById('use-different-name');
      if (differentNameBtn) {
        differentNameBtn.removeEventListener('click', this.useDifferentNameHandler);
      }
        this.useDifferentNameHandler = null;
      }
      if (this.overwriteConfirmHandler) {
      var overwriteConfirmBtn = document.getElementById('overwrite-confirm');
      if (overwriteConfirmBtn) {
        overwriteConfirmBtn.removeEventListener('click', this.overwriteConfirmHandler);
      }
        this.overwriteConfirmHandler = null;
      }
      if (this.overwriteKeyHandler) {
        document.removeEventListener('keydown', this.overwriteKeyHandler);
        this.overwriteKeyHandler = null;
      }
  };
  
    // æ·»åŠ éµç›¤å¿«æ·éµæ”¯æŒ
  FlashcardApp.prototype.handleOverwriteKeyboard = function(event) {
    var overwriteModal = document.getElementById('overwrite-confirm-modal');
    if (overwriteModal && overwriteModal.style.display === 'flex') {
        if (event.key === 'Escape') {
          event.preventDefault();
          this.closeOverwriteConfirmModal();
        } else if (event.key === 'Enter') {
          event.preventDefault();
          // Enter éµé»˜èªé¸æ“‡ä½¿ç”¨ä¸åŒåç¨±ï¼ˆè¼ƒå®‰å…¨çš„é¸é …ï¼‰
          this.closeOverwriteConfirmModal();
          this.suggestAlternativeName();
        }
      }
  };
  
  FlashcardApp.prototype.suggestAlternativeName = function() {
    var sheetNameInput = document.getElementById('export-sheet-name');
      if (sheetNameInput) {
        // ç”Ÿæˆå»ºè­°çš„æ›¿ä»£åç¨±
      var currentName = sheetNameInput.value.trim();
      var suggestedName = this.generateAlternativeSheetName(currentName);
        
        // æ›´æ–°è¼¸å…¥æ¡†å€¼ç‚ºå»ºè­°åç¨±
        sheetNameInput.value = suggestedName;
        sheetNameInput.focus();
        sheetNameInput.select(); // é¸å–ç¾æœ‰æ–‡å­—ï¼Œæ–¹ä¾¿ç”¨æˆ¶æ›¿æ›
        
        // æ·»åŠ éŒ¯èª¤æ¨£å¼é¡
      var settingControl = sheetNameInput.closest('.setting-control');
        if (settingControl) {
          settingControl.classList.add('export-error');
        }
        
        // æ›´æ–°æç¤ºæ–‡å­—å’Œæ¨£å¼
      var hintElement = document.getElementById('sheet-name-hint');
        if (hintElement) {
          hintElement.innerHTML = 'ğŸ’¡ å·²è‡ªå‹•å»ºè­°æ–°åç¨±ï¼Œæ‚¨å¯ä»¥ä¿®æ”¹å¾Œé‡æ–°åŒ¯å‡º';
          hintElement.className = 'sheet-name-hint error';
        }
        
        // ç§»é™¤éŒ¯èª¤æ¨£å¼ï¼ˆç•¶ç”¨æˆ¶é–‹å§‹è¼¸å…¥æ™‚ï¼‰
      var removeErrorStyle = function() {
          if (settingControl) {
            settingControl.classList.remove('export-error');
          }
          if (hintElement) {
            hintElement.innerHTML = 'ğŸ’¡ å¦‚æœå·¥ä½œè¡¨å·²å­˜åœ¨ï¼Œç³»çµ±æœƒè©¢å•æ‚¨æ˜¯å¦è¦è¦†å¯«';
            hintElement.className = 'sheet-name-hint normal';
          }
          sheetNameInput.removeEventListener('input', removeErrorStyle);
        };
        sheetNameInput.addEventListener('input', removeErrorStyle);
      }
  };
  
  FlashcardApp.prototype.generateAlternativeSheetName = function(originalName) {
    var now = new Date();
    var hours = now.getHours().toString();
    var minutes = now.getMinutes().toString();
    
    // ES5 ç‰ˆæœ¬çš„ padStart
    if (hours.length < 2) hours = '0' + hours;
    if (minutes.length < 2) minutes = '0' + minutes;
    
    var timestamp = hours + minutes;
      
      // å¦‚æœåŸåç¨±åŒ…å«æ™‚é–“æˆ³è¨˜ï¼Œå‰‡æ›´æ–°æ™‚é–“æˆ³è¨˜
    var timePattern = /_\d{4}$/;
      if (timePattern.test(originalName)) {
      return originalName.replace(timePattern, '_' + timestamp);
      } else {
        // å¦å‰‡æ·»åŠ æ™‚é–“æˆ³è¨˜
      return originalName + '_' + timestamp;
    }
  };
  
  // Sheetè¨­å®šç›¸é—œï¼ˆå®Œæ•´å¯¦ç¾ï¼‰
  FlashcardApp.prototype.loadSheetsList = function() {
    var input = this.validateAndGetSheetInput();
    if (!input) return;
  
    var elements = this.validateSheetUIElements();
    if (!elements) return;
  
    try {
      var sheetId = this.extractSheetId(input);
      this.updateSheetLoadingUI(elements, true);
      this.performSheetListRequest(sheetId, elements);
    } catch (error) {
      console.error('loadSheetsList åŸ·è¡Œéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:', error);
      alert('éŒ¯èª¤ï¼š' + error.message);
    }
  };
  
  FlashcardApp.prototype.validateAndGetSheetInput = function() {
    var sheetIdInput = document.getElementById('sheet-id-input');
    if (!sheetIdInput) {
      console.error('æ‰¾ä¸åˆ° sheet-id-input å…ƒç´ ');
      alert('ç³»çµ±éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è¼¸å…¥æ¡†å…ƒç´ ');
      return null;
    }
  
    var input = sheetIdInput.value.trim();
    if (!input) {
      console.warn('ç”¨æˆ¶æœªè¼¸å…¥ä»»ä½•å…§å®¹');
      alert('è«‹è¼¸å…¥ Google Sheet ID æˆ– URL');
      return null;
    }
  
    return input;
  };
  
  FlashcardApp.prototype.validateSheetUIElements = function() {
    var elements = {
      sheetsList: document.getElementById('sheets-list'),
      sheetsGroup: document.getElementById('sheets-selection-group'),
      loadBtn: document.getElementById('load-sheets-btn')
    };
  
    var elementChecks = [
      { element: elements.sheetsList, name: 'sheets-list', error: 'æ‰¾ä¸åˆ°å·¥ä½œè¡¨æ¸…å–®å…ƒç´ ' },
      { element: elements.sheetsGroup, name: 'sheets-selection-group', error: 'æ‰¾ä¸åˆ°å·¥ä½œè¡¨é¸æ“‡çµ„å…ƒç´ ' },
      { element: elements.loadBtn, name: 'load-sheets-btn', error: 'æ‰¾ä¸åˆ°è¼‰å…¥æŒ‰éˆ•' }
    ];
  
    for (var i = 0; i < elementChecks.length; i++) {
      var check = elementChecks[i];
      if (!check.element) {
        console.error('æ‰¾ä¸åˆ° ' + check.name + ' å…ƒç´ ');
        alert('ç³»çµ±éŒ¯èª¤ï¼š' + check.error);
        return null;
      }
    }
  
    return elements;
  };
  
  FlashcardApp.prototype.extractSheetId = function(input) {
    console.log('=== extractSheetId é–‹å§‹åŸ·è¡Œ ===');
    console.log('è¼¸å…¥å…§å®¹:', input);
    
    var trimmedInput = input.trim();
    console.log('å»é™¤ç©ºæ ¼å¾Œ:', trimmedInput);
    
    // å¦‚æœçœ‹èµ·ä¾†åƒæ˜¯ URL
    if (trimmedInput.indexOf('docs.google.com/spreadsheets') !== -1) {
      console.log('æª¢æ¸¬åˆ° Google Sheets URL');
      // å°‹æ‰¾ /d/ å¾Œé¢çš„ ID
      var match = trimmedInput.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
      console.log('æ­£å‰‡è¡¨é”å¼åŒ¹é…çµæœ:', match);
      
      if (match && match[1]) {
        console.log('å¾ URL æå–åˆ° Sheet ID:', match[1]);
        return match[1];
          } else {
        console.error('ç„¡æ³•å¾ URL ä¸­æå– Sheet ID');
        throw new Error('ç„¡æ³•å¾ URL ä¸­æå– Sheet IDï¼Œè«‹ç¢ºèª URL æ ¼å¼æ­£ç¢º');
      }
    }
    
    // å¦‚æœçœ‹èµ·ä¾†åƒæ˜¯ç´” ID (å­—æ¯æ•¸å­—çµ„åˆ)
    var idPattern = /^[a-zA-Z0-9-_]+$/;
    console.log('æª¢æŸ¥æ˜¯å¦ç‚ºç´” IDï¼Œæ¨¡å¼:', idPattern);
    console.log('æ¨¡å¼æ¸¬è©¦çµæœ:', idPattern.test(trimmedInput));
    
    if (idPattern.test(trimmedInput)) {
      console.log('è¼¸å…¥çœ‹èµ·ä¾†æ˜¯ Sheet ID:', trimmedInput);
      return trimmedInput;
    }
    
    console.error('è¼¸å…¥æ ¼å¼ä¸æ­£ç¢º');
    throw new Error('è¼¸å…¥æ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹è¼¸å…¥æœ‰æ•ˆçš„ Google Sheet ID æˆ– URL');
  };
  
  FlashcardApp.prototype.updateSheetLoadingUI = function(elements, isLoading) {
    if (isLoading) {
      elements.sheetsList.innerHTML = '<div class="loading-text">è¼‰å…¥ä¸­...</div>';
      elements.sheetsGroup.style.display = 'block';
      elements.loadBtn.disabled = true;
      elements.loadBtn.textContent = 'è¼‰å…¥ä¸­...';
          } else {
      elements.loadBtn.disabled = false;
      elements.loadBtn.textContent = 'è¼‰å…¥å·¥ä½œè¡¨æ¸…å–®';
    }
  };
  
  FlashcardApp.prototype.performSheetListRequest = function(sheetId, elements) {
    if (!this.validateGoogleScriptEnvironment()) {
      throw new Error('Google Apps Script ç’°å¢ƒä¸å¯ç”¨');
    }
  
    var self = this;
    var timeout = this.setupSheetRequestTimeout(elements);
    
    google.script.run
      .withSuccessHandler(function(result) {
        self.handleSheetListSuccess(result, elements, timeout);
      })
      .withFailureHandler(function(error) {
        self.handleSheetListFailure(error, elements, timeout);
      })
      .getSheetsList(sheetId);
  };
  
  FlashcardApp.prototype.validateGoogleScriptEnvironment = function() {
    if (typeof google === 'undefined') {
      console.error('google ç‰©ä»¶æœªå®šç¾©');
      return false;
    }
    if (!google.script || !google.script.run) {
      console.error('Google Apps Script åŠŸèƒ½æœªå¯ç”¨');
      return false;
    }
    return true;
  };
  
  FlashcardApp.prototype.setupSheetRequestTimeout = function(elements) {
    var self = this;
    return setTimeout(function() {
      console.error('è¼‰å…¥å·¥ä½œè¡¨æ¸…å–®è¶…æ™‚ (15ç§’)');
      elements.sheetsList.innerHTML = '<div class="error-text">è¼‰å…¥è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥æˆ–é‡è©¦</div>';
      self.updateSheetLoadingUI(elements, false);
    }, 15000);
  };
  
  FlashcardApp.prototype.handleSheetListSuccess = function(result, elements, timeout) {
    clearTimeout(timeout);
    console.log('Google Apps Script æˆåŠŸå›èª¿');
  
    var sheets, spreadsheetName;
    if (result && result.sheets) {
      sheets = result.sheets;
      spreadsheetName = result.spreadsheetName;
    } else if (Array.isArray(result)) {
      sheets = result;
      spreadsheetName = null;
    } else {
      throw new Error('è¼‰å…¥å·¥ä½œè¡¨æ¸…å–®å¤±æ•—ï¼šè¿”å›æ ¼å¼éŒ¯èª¤');
    }
  
    this.availableSheets = sheets;
    this.currentSpreadsheetName = spreadsheetName;
    this.renderSheetsList();
    this.updateSheetLoadingUI(elements, false);
  };
  
  FlashcardApp.prototype.handleSheetListFailure = function(error, elements, timeout) {
    clearTimeout(timeout);
    console.error('è¼‰å…¥å·¥ä½œè¡¨æ¸…å–®å¤±æ•—:', error);
  
    var errorMessage = error.message || 'æœªçŸ¥éŒ¯èª¤';
    var helpMessage = '';
    
    // æ ¹æ“šä¸åŒéŒ¯èª¤é¡å‹æä¾›å…·é«”çš„å¹«åŠ©è¨Šæ¯
    if (errorMessage.indexOf('æ¬Šé™') !== -1 || errorMessage.indexOf('Permission') !== -1) {
      helpMessage = '<div class="error-help"><strong>è§£æ±ºæ–¹æ¡ˆï¼š</strong><br>1. ç¢ºèªæ‚¨æœ‰å­˜å–æ­¤ Google Sheet çš„æ¬Šé™<br>2. å¦‚æœæ˜¯ç§äºº Sheetï¼Œè«‹ç¢ºä¿æ‚¨å·²ç™»å…¥ç›¸åŒçš„ Google å¸³è™Ÿ<br>3. å˜—è©¦åœ¨ç€è¦½å™¨ä¸­ç›´æ¥é–‹å•Ÿè©² Sheet ç¢ºèªæ¬Šé™</div>';
    } else if (errorMessage.indexOf('æ‰¾ä¸åˆ°') !== -1 || errorMessage.indexOf('ç„¡æ³•é–‹å•Ÿ') !== -1 || errorMessage.indexOf('not found') !== -1) {
      helpMessage = '<div class="error-help"><strong>è§£æ±ºæ–¹æ¡ˆï¼š</strong><br>1. è«‹æª¢æŸ¥ Sheet ID æ˜¯å¦æ­£ç¢º<br>2. ç¢ºèª Sheet æ˜¯å¦å­˜åœ¨ä¸”æœªè¢«åˆªé™¤<br>3. å¦‚æœæ˜¯ URLï¼Œè«‹ç¢ºä¿æ ¼å¼æ­£ç¢º</div>';
    } else if (errorMessage.indexOf('network') !== -1 || errorMessage.indexOf('ç¶²è·¯') !== -1) {
      helpMessage = '<div class="error-help"><strong>è§£æ±ºæ–¹æ¡ˆï¼š</strong><br>1. æª¢æŸ¥ç¶²è·¯é€£æ¥<br>2. ç¨å¾Œé‡è©¦<br>3. ç¢ºèªé˜²ç«ç‰†æœªé˜»æ“‹ Google æœå‹™</div>';
          } else {
      helpMessage = '<div class="error-help"><strong>å¸¸è¦‹è§£æ±ºæ–¹æ¡ˆï¼š</strong><br>1. è«‹åˆ·æ–°é é¢é‡è©¦ï¼ˆæŒ‰ Ctrl+F5 æˆ– Cmd+Shift+Rï¼‰<br>2. ç¢ºèª Google Sheet ID æ ¼å¼æ­£ç¢º<br>3. ç¢ºèªæ‚¨æœ‰è©² Sheet çš„å­˜å–æ¬Šé™<br>4. å˜—è©¦ç›´æ¥åœ¨ç€è¦½å™¨é–‹å•Ÿè©² Sheet</div>';
    }
    
    elements.sheetsList.innerHTML = '<div class="error-text">è¼‰å…¥å¤±æ•—ï¼š' + errorMessage + '</div>' + helpMessage;
    this.updateSheetLoadingUI(elements, false);
  };
  
  FlashcardApp.prototype.renderSheetsList = function() {
    console.log('=== renderSheetsList é–‹å§‹åŸ·è¡Œ ===');
    console.log('å¯ç”¨å·¥ä½œè¡¨æ•¸é‡:', this.availableSheets ? this.availableSheets.length : 0);
    console.log('å·¥ä½œè¡¨è³‡æ–™:', this.availableSheets);
    console.log('ç•¶å‰ Google Sheet åç¨±:', this.currentSpreadsheetName);
    
    var sheetsList = document.getElementById('sheets-list');
    var sheetsGroup = document.getElementById('sheets-selection-group');
    if (!sheetsList || !sheetsGroup) {
      console.error('æ‰¾ä¸åˆ° sheets-list æˆ– sheets-selection-group å…ƒç´ ');
      return;
    }
    
    if (!this.availableSheets || this.availableSheets.length === 0) {
      console.warn('æ²’æœ‰å¯ç”¨çš„å·¥ä½œè¡¨');
      sheetsList.innerHTML = '<div class="error-text">æ²’æœ‰æ‰¾åˆ°å·¥ä½œè¡¨</div>';
      var oldTitle = sheetsGroup.querySelector('.sheet-title');
      if (oldTitle) oldTitle.remove();
        return;
      }
      
    console.log('é–‹å§‹æ¸…ç©ºä¸¦é‡æ–°æ¸²æŸ“å·¥ä½œè¡¨æ¸…å–®');
    sheetsList.innerHTML = '';
    
    // å…ˆç§»é™¤èˆŠçš„æ¨™é¡Œ
    var oldTitle = sheetsGroup.querySelector('.sheet-title');
    if (oldTitle) oldTitle.remove();
    
    // å¦‚æœæœ‰ Google Sheet åç¨±ï¼Œé¡¯ç¤ºåœ¨ sheetsGroup æœ€ä¸Šæ–¹
    if (this.currentSpreadsheetName) {
      var sheetTitle = document.createElement('div');
      sheetTitle.className = 'sheet-title';
      sheetTitle.innerHTML = '<div class="sheet-title-text"><strong>Google Sheet:</strong> ' + this.currentSpreadsheetName + '</div>';
      sheetsGroup.insertBefore(sheetTitle, sheetsGroup.firstChild);
      console.log('é¡¯ç¤º Google Sheet åç¨±:', this.currentSpreadsheetName);
    }
    
    var self = this;
    for (var index = 0; index < this.availableSheets.length; index++) {
      var sheet = this.availableSheets[index];
      console.log('æ¸²æŸ“å·¥ä½œè¡¨ ' + (index + 1) + ':', sheet);
      
      var sheetItem = document.createElement('div');
      sheetItem.className = 'sheet-item';
      
      var checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.value = sheet.name;
      
      // æª¢æŸ¥æ˜¯å¦æ‡‰è©²è‡ªå‹•å‹¾é¸
      if (this.sheetSettings.selectedSheets && this.sheetSettings.selectedSheets.includes(sheet.name)) {
        checkbox.checked = true;
        console.log('è‡ªå‹•å‹¾é¸å·²è¼‰å…¥çš„å·¥ä½œè¡¨:', sheet.name);
      }
      
      (function(sheetName) {
        checkbox.addEventListener('change', function() {
          console.log('å·¥ä½œè¡¨é¸æ“‡ç‹€æ…‹æ”¹è®Š:', sheetName, checkbox.checked);
          self.toggleSheetSelection();
        });
      })(sheet.name);
      
      var sheetInfo = document.createElement('div');
      sheetInfo.className = 'sheet-info';
      
      var sheetName = document.createElement('div');
      sheetName.className = 'sheet-name';
      sheetName.textContent = sheet.name;
      
      var sheetCount = document.createElement('div');
      sheetCount.className = 'sheet-count';
      sheetCount.textContent = sheet.wordCount + ' å€‹å–®å­—';
      
      sheetInfo.appendChild(sheetName);
      sheetInfo.appendChild(sheetCount);
      
      sheetItem.appendChild(checkbox);
      sheetItem.appendChild(sheetInfo);
      
      (function(currentSheet, currentCheckbox) {
        sheetItem.addEventListener('click', function(e) {
          if (e.target !== currentCheckbox) {
            console.log('é»æ“Šå·¥ä½œè¡¨é …ç›®:', currentSheet.name);
            currentCheckbox.checked = !currentCheckbox.checked;
            self.toggleSheetSelection();
          }
        });
      })(sheet, checkbox);
      
      sheetsList.appendChild(sheetItem);
      console.log('å·¥ä½œè¡¨ ' + sheet.name + ' æ¸²æŸ“å®Œæˆ');
    }
    
    console.log('æ‰€æœ‰å·¥ä½œè¡¨æ¸²æŸ“å®Œæˆï¼Œæ›´æ–°é¸æ“‡è¨ˆæ•¸');
    this.updateSelectedCount();
    
    // æª¢æŸ¥æ˜¯å¦æœ‰å·²å‹¾é¸çš„å·¥ä½œè¡¨ï¼Œå¦‚æœæœ‰å‰‡å•Ÿç”¨è¼‰å…¥æŒ‰éˆ•
    var checkboxes = document.querySelectorAll('#sheets-list input[type="checkbox"]');
    var selectedCount = 0;
    for (var i = 0; i < checkboxes.length; i++) {
      if (checkboxes[i].checked) selectedCount++;
    }
    var saveBtn = document.getElementById('save-sheet-settings');
    if (saveBtn && selectedCount > 0) {
      saveBtn.disabled = false;
      console.log('å•Ÿç”¨è¼‰å…¥å–®å­—æŒ‰éˆ•ï¼Œå·²é¸æ“‡', selectedCount, 'å€‹å·¥ä½œè¡¨');
    }
    
    console.log('=== renderSheetsList åŸ·è¡Œå®Œæˆ ===');
  };
  
  FlashcardApp.prototype.toggleSheetSelection = function() {
    var checkboxes = document.querySelectorAll('#sheets-list input[type="checkbox"]');
    var selectedCount = 0;
    for (var i = 0; i < checkboxes.length; i++) {
      if (checkboxes[i].checked) selectedCount++;
    }
    
    var saveBtn = document.getElementById('save-sheet-settings');
    if (saveBtn) {
      saveBtn.disabled = selectedCount === 0;
    }
    this.updateSelectedCount();
  };
  
  FlashcardApp.prototype.updateSelectedCount = function() {
    var checkboxes = document.querySelectorAll('#sheets-list input[type="checkbox"]');
    var selectedCount = 0;
    for (var i = 0; i < checkboxes.length; i++) {
      if (checkboxes[i].checked) selectedCount++;
    }
    var selectedCountElement = document.getElementById('selected-count');
    if (selectedCountElement) {
      selectedCountElement.textContent = '(å·²é¸ ' + selectedCount + ' å€‹)';
    }
  };
  
  FlashcardApp.prototype.saveSheetSettingsAndClose = function() {
    var sheetIdInput = document.getElementById('sheet-id-input');
    var input = sheetIdInput.value.trim();
    
    var checkboxes = document.querySelectorAll('#sheets-list input[type="checkbox"]');
    var selectedSheets = [];
    for (var i = 0; i < checkboxes.length; i++) {
      if (checkboxes[i].checked) {
        selectedSheets.push(checkboxes[i].value);
      }
    }
    
    if (!input || selectedSheets.length === 0) {
      alert('è«‹è¼¸å…¥ Google Sheet ID/URL ä¸¦é¸æ“‡è‡³å°‘ä¸€å€‹å·¥ä½œè¡¨');
        return;
      }
      
    try {
      var sheetId = this.extractSheetId(input);
      
      this.sheetSettings.sheetId = sheetId;
      this.sheetSettings.selectedSheets = selectedSheets;
      this.saveSheetSettings();
      
      console.log('å„²å­˜ Sheet è¨­å®š:', this.sheetSettings);
      
      this.closeSheetSettings();
      
      // é¡¯ç¤ºè¼‰å…¥ä¸­è¨Šæ¯
      var loadingDiv = document.getElementById('loading');
      var flashcardDiv = document.getElementById('flashcard');
      if (loadingDiv) loadingDiv.style.display = 'flex';
      if (flashcardDiv) flashcardDiv.style.display = 'none';
      
      // é‡æ–°è¼‰å…¥å–®å­—
      var self = this;
      this.loadWords(false, function(hasDuplicates) {
        self.setupEventListeners();
        self.applySettings();
        
        if (!hasDuplicates) {
          self.startNewRound();
        }
        
        if (loadingDiv) loadingDiv.style.display = 'none';
        if (flashcardDiv) flashcardDiv.style.display = 'flex';
      });
      
    } catch (error) {
      console.error('å„²å­˜è¨­å®šæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
      alert(error.message);
    }
  };
  
  // é‡è¤‡è™•ç†ç›¸é—œï¼ˆå®Œæ•´ç‰ˆæœ¬ï¼‰
  FlashcardApp.prototype.showAutoProcessingNotification = function(results) {
    console.log('é¡¯ç¤ºè‡ªå‹•è™•ç†é€šçŸ¥:', results);
    
    // å‰µå»ºé€šçŸ¥å…ƒç´ 
    var notification = document.createElement('div');
    notification.className = 'auto-processing-notification';
    notification.innerHTML = 
      '<div class="notification-content">' +
        '<h3>âœ… é‡è¤‡å–®å­—å·²è‡ªå‹•è™•ç†</h3>' +
        '<p>åœ¨è¨˜æ†¶é«”ä¸­è™•ç†äº† ' + results.successCount + '/' + results.totalCount + ' å€‹é‡è¤‡å–®å­—</p>' +
        '<p class="memory-notice">ğŸ“ åŸå§‹Google Sheetæœªè¢«ä¿®æ”¹ï¼Œåƒ…åœ¨æœ¬æ¬¡ä½¿ç”¨ä¸­å»é‡</p>' +
        '<button id="close-notification" class="notification-close">Ã—</button>' +
      '</div>';
    
    document.body.appendChild(notification);
    
    var self = this;
    
    // è‡ªå‹•é—œé–‰é€šçŸ¥
    setTimeout(function() {
      notification.classList.add('fade-out');
      setTimeout(function() {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 300);
    }, 5000);
    
    // æ‰‹å‹•é—œé–‰é€šçŸ¥
    var closeBtn = document.getElementById('close-notification');
    if (closeBtn) {
      closeBtn.addEventListener('click', function() {
        notification.classList.add('fade-out');
        setTimeout(function() {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      });
    }
    
    // é¡¯ç¤ºå‹•ç•«
    setTimeout(function() {
      notification.classList.add('show');
    }, 100);
  };
  
  FlashcardApp.prototype.showDuplicateModal = function() {
    console.log('é¡¯ç¤ºé‡è¤‡è™•ç†æ¨¡æ…‹æ¡†');
    
    // åœæ­¢ä»»ä½•æ­£åœ¨æ’­æ”¾çš„èªéŸ³
    if (this.speechSynthesis) {
      this.speechSynthesis.cancel();
    }
    
    // æ¸…é™¤ä»»ä½•ç¾æœ‰çš„è¨ˆæ™‚å™¨
    if (this.displayTimer) {
      clearTimeout(this.displayTimer);
      this.displayTimer = null;
    }
    
    var modal = document.getElementById('duplicate-words-modal');
    if (modal) {
      // é‡ç½® modal-body çš„ HTML å…§å®¹ç‚ºåŸå§‹ç‹€æ…‹
      var modalBody = modal.querySelector('.modal-body');
      if (modalBody) {
        modalBody.innerHTML = 
          '<div class="duplicate-info">' +
            '<p id="duplicate-summary">æ‰¾åˆ° <span id="duplicate-count">0</span> çµ„é‡è¤‡å–®å­—ï¼Œè«‹é¸æ“‡è™•ç†æ–¹å¼ï¼š</p>' +
          '</div>' +
          '<div class="duplicate-word-container" id="duplicate-word-container">' +
            '<!-- é‡è¤‡å–®å­—é …ç›®å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->' +
          '</div>' +
          '<div class="duplicate-actions" id="duplicate-actions" style="display: none;">' +
            '<div class="current-duplicate-info">' +
              '<h3>è™•ç†å–®å­—ï¼š<strong id="current-duplicate-english"></strong></h3>' +
              '<div id="duplicate-options-container">' +
                '<!-- è™•ç†é¸é …å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->' +
              '</div>' +
            '</div>' +
          '</div>';
      }
      
      // é‡ç½® modal-footer çš„ HTML å…§å®¹ç‚ºåŸå§‹ç‹€æ…‹
      var modalFooter = modal.querySelector('.modal-footer');
      if (modalFooter) {
        modalFooter.innerHTML = 
          '<button id="skip-duplicates" class="secondary-btn">è·³éï¼Œç¨å¾Œè™•ç†</button>' +
          '<button id="process-all-duplicates" class="primary-btn">é–‹å§‹è™•ç†</button>' +
          '<button id="confirm-duplicate-action" class="primary-btn" style="display: none;">ç¢ºèªæ“ä½œ</button>' +
          '<button id="next-duplicate" class="primary-btn" style="display: none;">ä¸‹ä¸€å€‹</button>';
        modalFooter.style.display = '';
      }
      
      modal.style.display = 'flex';
      this.pauseTimer();
      
      // æ›´æ–°é‡è¤‡å–®å­—æ•¸é‡
      var duplicateCountElement = document.getElementById('duplicate-count');
      if (duplicateCountElement) {
        duplicateCountElement.textContent = this.duplicateWords.length;
      }
      
      // æ¸²æŸ“é‡è¤‡å–®å­—æ¸…å–®
      this.renderDuplicateWordsList();
      
      this.setupDuplicateModalEvents();
    }
  };
  
  FlashcardApp.prototype.setupDuplicateModalEvents = function() {
    var self = this;
    
    // è·³éè™•ç†æŒ‰éˆ•
    var skipBtn = document.getElementById('skip-duplicates');
    if (skipBtn) {
      skipBtn.addEventListener('click', function() {
        self.skipDuplicates();
      });
    }
    
    // é–‹å§‹è™•ç†æŒ‰éˆ•
    var processBtn = document.getElementById('process-all-duplicates');
    if (processBtn) {
      processBtn.addEventListener('click', function() {
        self.processAllDuplicates();
      });
    }
    
    // ç¢ºèªæ“ä½œæŒ‰éˆ•
    var confirmBtn = document.getElementById('confirm-duplicate-action');
    if (confirmBtn) {
      confirmBtn.addEventListener('click', function() {
        self.confirmDuplicateAction();
      });
    }
    
    // ä¸‹ä¸€å€‹æŒ‰éˆ•
    var nextBtn = document.getElementById('next-duplicate');
    if (nextBtn) {
      nextBtn.addEventListener('click', function() {
        self.nextDuplicate();
      });
    }
    
    // é—œé–‰æŒ‰éˆ•
    var closeBtn = document.getElementById('close-duplicate-modal');
    if (closeBtn) {
      closeBtn.addEventListener('click', function() {
        self.closeDuplicateModal();
      });
    }
  };
  
  FlashcardApp.prototype.closeDuplicateModal = function() {
    var modal = document.getElementById('duplicate-words-modal');
    if (modal) {
      modal.style.display = 'none';
      this.resumeTimer();
    }
  };
  
  // è·³éé‡è¤‡è™•ç†ï¼ˆè‡ªå‹•è™•ç†ï¼‰
  FlashcardApp.prototype.skipDuplicates = function() {
    console.log('è·³éé‡è¤‡è™•ç† - åŸ·è¡Œæœ¬åœ°è‡ªå‹•è™•ç†é‚è¼¯ï¼ˆåƒ…è¨˜æ†¶é«”è™•ç†ï¼‰');
    
    try {
      var result = this.processDuplicatesInMemory(this.words, this.duplicateWords);
        
        if (result.success) {
          // æ›´æ–°ç•¶å‰å–®å­—é™£åˆ—
          this.words = result.processedWords;
        this.difficultWords = this.words.filter(function(w) { return w.difficult; }).map(function(w) { return w.id; });
          
          // é¡¯ç¤ºæˆåŠŸçµæœ
        var modal = document.getElementById('duplicate-words-modal');
        var modalBody = modal.querySelector('.modal-body');
        var modalFooter = modal.querySelector('.modal-footer');
          modalFooter.style.display = 'none';
          
        var successCount = result.successCount || 0;
        var totalCount = result.totalCount || 0;
        var removedCount = result.removedCount || 0;
        
        modalBody.innerHTML = 
          '<div class="auto-processing-result success">' +
            '<h3>âœ… è‡ªå‹•è™•ç†å®Œæˆï¼</h3>' +
            '<p>æˆåŠŸè™•ç† ' + successCount + '/' + totalCount + ' å€‹é‡è¤‡å–®å­—</p>' +
            '<p>åŸå§‹å–®å­—æ•¸é‡ï¼š' + result.originalCount + 'ï¼Œè™•ç†å¾Œæ•¸é‡ï¼š' + result.processedCount + '</p>' +
            '<p>å·²ç§»é™¤é‡è¤‡é …ç›®ï¼š' + removedCount + ' å€‹</p>' +
            '<p class="sheet-modify-notice">âœ… Google Sheetæœªè¢«ä¿®æ”¹ï¼Œåƒ…åœ¨è¨˜æ†¶é«”ä¸­è™•ç†</p>' +
            '<button id="finish-auto-processing" class="primary-btn">å®Œæˆ</button>' +
          '</div>';
        
        var self = this;
        document.getElementById('finish-auto-processing').addEventListener('click', function() {
          self.closeDuplicateModal();
          self.setupEventListeners();
          self.applySettings();
          self.startNewRound();
          });
        } else {
          throw new Error(result.error || 'è™•ç†å¤±æ•—');
        }
      } catch (error) {
      console.error('æœ¬åœ°è™•ç†å¤±æ•—:', error);
      alert('è‡ªå‹•è™•ç†å¤±æ•—ï¼š' + error.message);
      }
  };
    
  // åœ¨è¨˜æ†¶é«”ä¸­è™•ç†é‡è¤‡å–®å­—
  FlashcardApp.prototype.processDuplicatesInMemory = function(allWords, duplicates) {
      try {
        console.log('åœ¨å‰ç«¯è¨˜æ†¶é«”ä¸­è‡ªå‹•è™•ç†é‡è¤‡å–®å­—ï¼Œç¸½æ•¸:', duplicates.length);
        
      var results = [];
      var wordsToRemove = []; // è¨˜éŒ„è¦å¾è¨˜æ†¶é«”ä¸­ç§»é™¤çš„å–®å­—ID
      var wordsToModify = {}; // è¨˜éŒ„è¦ä¿®æ”¹å®šç¾©çš„å–®å­—IDå’Œæ–°å®šç¾©
      
      for (var i = 0; i < duplicates.length; i++) {
        var duplicate = duplicates[i];
          console.log('è™•ç†é‡è¤‡å–®å­—:', duplicate.english, 'æ˜¯å¦ç›¸åŒå®šç¾©:', duplicate.isSameDefinition);
          
          if (duplicate.isSameDefinition) {
            // ä¸­æ–‡æ„ç¾©ç›¸åŒï¼šä¿ç•™ç¬¬ä¸€å€‹å·¥ä½œè¡¨çš„ï¼Œç§»é™¤å…¶ä»–
          var keepWord = duplicate.words[0];
          var removeWords = duplicate.words.slice(1);
            
            console.log('ç›¸åŒå®šç¾©ï¼Œä¿ç•™ç¬¬ä¸€å€‹å·¥ä½œè¡¨:', keepWord.sheetName);
            
            // è¨˜éŒ„è¦ç§»é™¤çš„å–®å­—ID
          for (var j = 0; j < removeWords.length; j++) {
            wordsToRemove.push(removeWords[j].id);
          }
            
            results.push({
              english: duplicate.english,
              action: 'keep_first',
              success: true,
              keptSheet: keepWord.sheetName,
              removedCount: removeWords.length
            });
          } else {
            // ä¸­æ–‡æ„ç¾©ä¸åŒï¼šåˆä½µå®šç¾©åˆ°ç¬¬ä¸€å€‹å·¥ä½œè¡¨çš„å–®å­—
          var targetWord = duplicate.words[0];
          var mergeWords = duplicate.words.slice(1);
            
            console.log('ä¸åŒå®šç¾©ï¼Œåˆä½µåˆ°ç¬¬ä¸€å€‹å·¥ä½œè¡¨:', targetWord.sheetName);
            
            // æº–å‚™åˆä½µå¾Œçš„å®šç¾©
          var allDefinitions = [];
          for (var k = 0; k < duplicate.words.length; k++) {
            allDefinitions.push((k + 1) + '. ' + duplicate.words[k].chinese.trim());
          }
          var mergedDefinition = allDefinitions.join('\n');
            
            // è¨˜éŒ„è¦ä¿®æ”¹çš„å–®å­—
          wordsToModify[targetWord.id] = mergedDefinition;
            
            // è¨˜éŒ„è¦ç§»é™¤çš„å–®å­—ID
          for (var l = 0; l < mergeWords.length; l++) {
            wordsToRemove.push(mergeWords[l].id);
          }
            
            results.push({
              english: duplicate.english,
              action: 'merge_to_first',
              success: true,
              targetSheet: targetWord.sheetName,
              mergedDefinition: mergedDefinition,
              removedCount: mergeWords.length
            });
          }
        }
        
        // è™•ç†å–®å­—é™£åˆ—ï¼šç§»é™¤é‡è¤‡é …ç›®ä¸¦ä¿®æ”¹å®šç¾©
      var processedWords = [];
      for (var m = 0; m < allWords.length; m++) {
        var word = allWords[m];
        
        if (wordsToRemove.indexOf(word.id) !== -1) {
            // è·³éè¦ç§»é™¤çš„å–®å­—
            continue;
          }
          
        if (wordsToModify.hasOwnProperty(word.id)) {
            // ä¿®æ”¹å®šç¾©
          var modifiedWord = {};
          for (var key in word) {
            if (word.hasOwnProperty(key)) {
              modifiedWord[key] = word[key];
            }
          }
          modifiedWord.chinese = wordsToModify[word.id];
            processedWords.push(modifiedWord);
          } else {
            // ä¿æŒåŸæ¨£
            processedWords.push(word);
          }
        }
        
      var successCount = results.filter(function(r) { return r.success; }).length;
      var removedCount = wordsToRemove.length;
        
        return {
          success: true,
          results: results,
          successCount: successCount,
        totalCount: duplicates.length,
        removedCount: removedCount,
          originalCount: allWords.length,
          processedCount: processedWords.length,
        processedWords: processedWords
        };
      
      } catch (error) {
      console.error('è¨˜æ†¶é«”è™•ç†éŒ¯èª¤:', error);
        return {
          success: false,
        error: error.message || 'è™•ç†éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤'
      };
    }
  };
  
  // é–‹å§‹è™•ç†æ‰€æœ‰é‡è¤‡
  FlashcardApp.prototype.processAllDuplicates = function() {
    console.log('é–‹å§‹è™•ç†é‡è¤‡');
    if (this.duplicateWords.length > 0) {
      this.currentDuplicateIndex = 0;
      this.duplicateProcessingResults = [];
      this.selectDuplicateWord(0);
    }
  };
  
  // æ¸²æŸ“é‡è¤‡å–®å­—æ¸…å–®
  FlashcardApp.prototype.renderDuplicateWordsList = function() {
    var container = document.getElementById('duplicate-word-container');
    if (!container) return;
    
    container.innerHTML = '';
    
    for (var i = 0; i < this.duplicateWords.length; i++) {
      var duplicate = this.duplicateWords[i];
      var wordItem = document.createElement('div');
      wordItem.className = 'duplicate-word-item';
      wordItem.setAttribute('data-index', i);
      
      var wordHeader = document.createElement('div');
      wordHeader.className = 'duplicate-word-header';
      wordHeader.innerHTML = '<strong>' + duplicate.english + '</strong> (' + 
        (duplicate.isSameDefinition ? 'ç›¸åŒå®šç¾©' : 'ä¸åŒå®šç¾©') + ')';
      
      var wordSources = document.createElement('div');
      wordSources.className = 'duplicate-word-sources';
      
      for (var j = 0; j < duplicate.words.length; j++) {
        var word = duplicate.words[j];
        var sourceItem = document.createElement('div');
        sourceItem.className = 'duplicate-source-item';
        sourceItem.innerHTML = '<span class="source-sheet">' + word.sheetName + '</span>: ' + word.chinese;
        wordSources.appendChild(sourceItem);
      }
      
      wordItem.appendChild(wordHeader);
      wordItem.appendChild(wordSources);
      
      var self = this;
      (function(index) {
        wordItem.addEventListener('click', function() {
          self.selectDuplicateWord(index);
        });
      })(i);
      
      container.appendChild(wordItem);
    }
  };
  
  // é¸æ“‡è¦è™•ç†çš„é‡è¤‡å–®å­—
  FlashcardApp.prototype.selectDuplicateWord = function(index) {
    console.log('é¸æ“‡é‡è¤‡å–®å­—ï¼Œç´¢å¼•:', index);
    
    // æ¸…é™¤ä¹‹å‰çš„é¸ä¸­ç‹€æ…‹
    var items = document.querySelectorAll('.duplicate-word-item');
    for (var i = 0; i < items.length; i++) {
      items[i].classList.remove('selected');
    }
    
    // é¸ä¸­ç•¶å‰é …ç›®
    var selectedItem = document.querySelector('[data-index="' + index + '"]');
    if (selectedItem) {
      selectedItem.classList.add('selected');
    }
    
    this.currentDuplicateIndex = index;
    
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    var processBtn = document.getElementById('process-all-duplicates');
    var confirmBtn = document.getElementById('confirm-duplicate-action');
    var nextBtn = document.getElementById('next-duplicate');
    
    if (processBtn) processBtn.style.display = 'none';
    if (confirmBtn) {
      confirmBtn.style.display = 'inline-block';
      confirmBtn.disabled = false;
      confirmBtn.textContent = 'ç¢ºèªæ“ä½œ';
    }
    if (nextBtn) nextBtn.style.display = 'none';
    
    // é¡¯ç¤ºè™•ç†é¸é …
    this.showDuplicateOptions(this.duplicateWords[index]);
  };
  
  // é¡¯ç¤ºé‡è¤‡å–®å­—è™•ç†é¸é …
  FlashcardApp.prototype.showDuplicateOptions = function(duplicate) {
    var actionsDiv = document.getElementById('duplicate-actions');
    var englishSpan = document.getElementById('current-duplicate-english');
    var optionsContainer = document.getElementById('duplicate-options-container');
    
    if (!englishSpan || !optionsContainer) return;
    
    englishSpan.textContent = duplicate.english;
    optionsContainer.innerHTML = '';
    actionsDiv.style.display = 'block';
    
    if (duplicate.isSameDefinition) {
      // å®šç¾©ç›¸åŒï¼šé¸æ“‡ä¿ç•™å“ªä¸€å€‹
      var keepOption = document.createElement('div');
      keepOption.className = 'duplicate-option';
      keepOption.innerHTML = 
        '<div class="option-header">' +
          '<input type="radio" name="duplicate-action" value="keep" class="option-radio" checked>' +
          '<span class="option-title">ä¿ç•™å…¶ä¸­ä¸€å€‹ï¼Œåˆªé™¤å…¶ä»–</span>' +
        '</div>' +
        '<div class="option-description">é¸æ“‡è¦ä¿ç•™çš„å·¥ä½œè¡¨ç‰ˆæœ¬ï¼Œå…¶ä»–ç‰ˆæœ¬å°‡è¢«æ°¸ä¹…åˆªé™¤</div>' +
        '<div class="merge-target-selection" id="keep-target-selection"></div>';
      
      var targetSelection = keepOption.querySelector('#keep-target-selection');
      for (var i = 0; i < duplicate.words.length; i++) {
        var word = duplicate.words[i];
        var targetOption = document.createElement('div');
        targetOption.className = 'merge-target-option';
        targetOption.innerHTML = 
          '<input type="radio" name="keep-target" value="' + i + '" class="merge-target-radio" ' + 
          (i === 0 ? 'checked' : '') + '>' +
          '<span class="merge-target-label">ä¿ç•™ ' + word.sheetName + ': ' + word.chinese + '</span>';
        
        (function(option) {
          targetOption.addEventListener('click', function(e) {
            if (e.target.type !== 'radio') {
              var radio = option.querySelector('input[type="radio"]');
              if (radio) radio.checked = true;
            }
          });
        })(targetOption);
        
        targetSelection.appendChild(targetOption);
      }
      
      optionsContainer.appendChild(keepOption);
          } else {
      // å®šç¾©ä¸åŒï¼šä¿ç•™ä¸€å€‹æˆ–åˆä½µ
      var keepOption = document.createElement('div');
      keepOption.className = 'duplicate-option';
      keepOption.innerHTML = 
        '<div class="option-header">' +
          '<input type="radio" name="duplicate-action" value="keep" class="option-radio" checked>' +
          '<span class="option-title">ä¿ç•™å…¶ä¸­ä¸€å€‹ï¼Œåˆªé™¤å…¶ä»–</span>' +
        '</div>' +
        '<div class="option-description">é¸æ“‡è¦ä¿ç•™çš„å·¥ä½œè¡¨ç‰ˆæœ¬ï¼Œå…¶ä»–ç‰ˆæœ¬å°‡è¢«æ°¸ä¹…åˆªé™¤</div>' +
        '<div class="merge-target-selection" id="keep-target-selection"></div>';
      
      var targetSelection = keepOption.querySelector('#keep-target-selection');
      for (var j = 0; j < duplicate.words.length; j++) {
        var word = duplicate.words[j];
        var targetOption = document.createElement('div');
        targetOption.className = 'merge-target-option';
        targetOption.innerHTML = 
          '<input type="radio" name="keep-target" value="' + j + '" class="merge-target-radio" ' + 
          (j === 0 ? 'checked' : '') + '>' +
          '<span class="merge-target-label">ä¿ç•™ ' + word.sheetName + ': ' + word.chinese + '</span>';
        
        (function(option) {
          targetOption.addEventListener('click', function(e) {
            if (e.target.type !== 'radio') {
              var radio = option.querySelector('input[type="radio"]');
              if (radio) radio.checked = true;
            }
          });
        })(targetOption);
        
        targetSelection.appendChild(targetOption);
      }
      
      var mergeOption = document.createElement('div');
      mergeOption.className = 'duplicate-option';
      mergeOption.innerHTML = 
        '<div class="option-header">' +
          '<input type="radio" name="duplicate-action" value="merge" class="option-radio">' +
          '<span class="option-title">åˆä½µæ‰€æœ‰å®šç¾©</span>' +
        '</div>' +
        '<div class="option-description">å°‡æ‰€æœ‰å®šç¾©åˆä½µåˆ°é¸å®šçš„å·¥ä½œè¡¨ä¸­ï¼Œå…¶ä»–ç‰ˆæœ¬å°‡è¢«åˆªé™¤</div>' +
        '<div class="merge-target-selection" id="merge-target-selection"></div>';
      
      var mergeTargetSelection = mergeOption.querySelector('#merge-target-selection');
      for (var k = 0; k < duplicate.words.length; k++) {
        var word = duplicate.words[k];
        var targetOption = document.createElement('div');
        targetOption.className = 'merge-target-option';
        targetOption.innerHTML = 
          '<input type="radio" name="merge-target" value="' + k + '" class="merge-target-radio" ' + 
          (k === 0 ? 'checked' : '') + '>' +
          '<span class="merge-target-label">åˆä½µåˆ° ' + word.sheetName + '</span>';
        
        (function(option) {
          targetOption.addEventListener('click', function(e) {
            if (e.target.type !== 'radio') {
              var radio = option.querySelector('input[type="radio"]');
              if (radio) radio.checked = true;
            }
          });
        })(targetOption);
        
        mergeTargetSelection.appendChild(targetOption);
      }
      
      optionsContainer.appendChild(keepOption);
      optionsContainer.appendChild(mergeOption);
    }
  };
    
    // ç¢ºèªè™•ç†ç•¶å‰é‡è¤‡é …ç›®
  FlashcardApp.prototype.confirmDuplicateAction = function() {
    var confirmBtn = document.getElementById('confirm-duplicate-action');
      if (confirmBtn && confirmBtn.disabled) {
        console.log('è™•ç†å·²åœ¨é€²è¡Œä¸­ï¼Œå¿½ç•¥é‡è¤‡èª¿ç”¨');
        return;
      }
  
    console.log('ç¢ºèªè™•ç†é‡è¤‡å–®å­—');
      
    var duplicate = this.duplicateWords[this.currentDuplicateIndex];
    var actionRadio = document.querySelector('input[name="duplicate-action"]:checked');
      
      if (!actionRadio) {
        alert('è«‹é¸æ“‡è™•ç†æ–¹å¼');
        return;
      }
      
    var action = actionRadio.value;
    var targetIndex = 0;
      
      if (action === 'keep') {
      var targetRadio = document.querySelector('input[name="keep-target"]:checked');
        if (targetRadio) {
          targetIndex = parseInt(targetRadio.value);
        }
      } else if (action === 'merge') {
      var targetRadio = document.querySelector('input[name="merge-target"]:checked');
        if (targetRadio) {
          targetIndex = parseInt(targetRadio.value);
        }
      }
      
      // é¡¯ç¤ºè™•ç†ä¸­ç‹€æ…‹
      this.showProcessingIndicator();
      
      // æº–å‚™è™•ç†åƒæ•¸
    var targetWord = duplicate.words[targetIndex];
    var otherWords = duplicate.words.filter(function(word, index) { return index !== targetIndex; });
      
      console.log('ç›®æ¨™å–®å­—:', targetWord);
      console.log('è¦åˆªé™¤çš„å–®å­—:', otherWords);
      
      // è¨­ç½®è¶…æ™‚æ©Ÿåˆ¶ï¼Œé˜²æ­¢æ°¸ä¹…å¡ä½
    var self = this;
    var timeoutId = setTimeout(function() {
        console.error('è™•ç†è¶…æ™‚');
      self.showProcessingResult(false, 'è™•ç†è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥å¾Œé‡è©¦');
      }, 30000); // 30ç§’è¶…æ™‚
      
      // å®šç¾©æˆåŠŸè™•ç†å‡½æ•¸
    var handleSuccess = function(result) {
        clearTimeout(timeoutId);
        console.log('è™•ç†æˆåŠŸå›èª¿è¢«è§¸ç™¼ï¼Œçµæœ:', result);
      
      var isSuccess = false;
      var deletedCount = 0;
      var errorMessage = '';
        
        if (result === true || result === 'true') {
          isSuccess = true;
          deletedCount = otherWords.length;
        } else if (result && typeof result === 'object') {
          isSuccess = result.success === true || result.success === 'true';
          deletedCount = result.deletedCount || otherWords.length;
          errorMessage = result.error || '';
        } else if (result && result.toString().toLowerCase() === 'success') {
          isSuccess = true;
          deletedCount = otherWords.length;
        } else {
          console.warn('æœªçŸ¥çš„çµæœæ ¼å¼ï¼Œå˜—è©¦è§£æ:', result);
        isSuccess = !!result;
          deletedCount = isSuccess ? otherWords.length : 0;
        }
        
        console.log('è§£æå¾Œçš„çµæœ - æˆåŠŸ:', isSuccess, 'åˆªé™¤æ•¸é‡:', deletedCount);
        
        if (isSuccess) {
        var message = action === 'merge' 
          ? 'æˆåŠŸåˆä½µåˆ° ' + targetWord.sheetName + 'ï¼Œåˆªé™¤äº† ' + deletedCount + ' å€‹é‡è¤‡é …ç›®'
          : 'æˆåŠŸä¿ç•™ ' + targetWord.sheetName + ' ä¸­çš„å–®å­—ï¼Œåˆªé™¤äº† ' + deletedCount + ' å€‹é‡è¤‡é …ç›®';
        
        self.showProcessingResult(true, message);
        self.duplicateProcessingResults.push({
          duplicate: self.duplicateWords[self.currentDuplicateIndex],
            action: action,
            success: true,
            result: { success: true, deletedCount: deletedCount }
          });
        } else {
        var failureMessage = errorMessage || 'è™•ç†çµæœæ ¼å¼éŒ¯èª¤æˆ–æœªæˆåŠŸ';
        self.showProcessingResult(false, failureMessage);
        self.duplicateProcessingResults.push({
          duplicate: self.duplicateWords[self.currentDuplicateIndex],
            action: action,
            success: false,
            error: failureMessage
          });
        }
      };
      
      // å®šç¾©å¤±æ•—è™•ç†å‡½æ•¸
    var handleFailure = function(error) {
        clearTimeout(timeoutId);
        console.error('è™•ç†å¤±æ•—:', error);
        
      var errorMessage = error && error.message ? error.message : 'æœªçŸ¥éŒ¯èª¤';
      self.showProcessingResult(false, 'è™•ç†å¤±æ•—ï¼š' + errorMessage);
      self.duplicateProcessingResults.push({
        duplicate: self.duplicateWords[self.currentDuplicateIndex],
          action: action,
          success: false,
          error: errorMessage
        });
      };
      
      // æª¢æŸ¥å¿…è¦çš„åƒæ•¸
      if (!this.sheetSettings.sheetId) {
        handleFailure(new Error('Google Sheet ID æœªè¨­å®š'));
        return;
      }
      
      if (!targetWord || !targetWord.sheetName) {
        handleFailure(new Error('ç›®æ¨™å–®å­—è³‡æ–™ä¸å®Œæ•´'));
        return;
      }
      
      // æª¢æŸ¥ Google Apps Script æ˜¯å¦å¯ç”¨
      if (typeof google === 'undefined' || !google.script || !google.script.run) {
        handleFailure(new Error('Google Apps Script ç’°å¢ƒä¸å¯ç”¨'));
        return;
      }
      
      try {
        if (action === 'keep') {
          // ä¿ç•™ä¸€å€‹ï¼Œåˆªé™¤å…¶ä»–
          console.log('èª¿ç”¨ handleDuplicateWordKeepOne');
          google.script.run
            .withSuccessHandler(handleSuccess)
            .withFailureHandler(handleFailure)
            .handleDuplicateWordKeepOne(this.sheetSettings.sheetId, targetWord, otherWords);
        } else if (action === 'merge') {
          // åˆä½µå®šç¾©
          console.log('èª¿ç”¨ handleDuplicateWordMerge');
          google.script.run
            .withSuccessHandler(handleSuccess)
            .withFailureHandler(handleFailure)
            .handleDuplicateWordMerge(this.sheetSettings.sheetId, targetWord, otherWords);
        }
      } catch (error) {
        console.error('èª¿ç”¨ Google Apps Script æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        handleFailure(error);
      }
  };
    
    // é¡¯ç¤ºè™•ç†ä¸­æŒ‡ç¤ºå™¨
  FlashcardApp.prototype.showProcessingIndicator = function() {
    var optionsContainer = document.getElementById('duplicate-options-container');
    optionsContainer.innerHTML = 
      '<div class="processing-indicator">' +
        '<div class="processing-spinner"></div>' +
        '<span class="processing-text">è™•ç†ä¸­...</span>' +
      '</div>';
    
    var confirmBtn = document.getElementById('confirm-duplicate-action');
      if (confirmBtn) {
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'è™•ç†ä¸­...';
      }
      
    var nextBtn = document.getElementById('next-duplicate');
      if (nextBtn) {
        nextBtn.style.display = 'none';
      }
  };
    
    // é¡¯ç¤ºè™•ç†çµæœ
  FlashcardApp.prototype.showProcessingResult = function(success, message) {
    var optionsContainer = document.getElementById('duplicate-options-container');
    optionsContainer.innerHTML = 
      '<div class="' + (success ? 'duplicate-result-success' : 'duplicate-result-error') + '">' +
        message +
      '</div>';
    
      if (success) {
      // å¾é‡è¤‡æ¸…å–®ä¸­ç§»é™¤é€™å€‹é …ç›®
        this.duplicateWords.splice(this.currentDuplicateIndex, 1);
        
        // èª¿æ•´ç•¶å‰ç´¢å¼•
        if (this.currentDuplicateIndex >= this.duplicateWords.length) {
          this.currentDuplicateIndex = this.duplicateWords.length - 1;
        }
        
        // é‡æ–°æ¸²æŸ“é‡è¤‡æ¸…å–®
        this.renderDuplicateWordsList();
        
        // æ›´æ–°é‡è¤‡æ•¸é‡é¡¯ç¤º
      var duplicateCount = document.getElementById('duplicate-count');
        if (duplicateCount) {
          duplicateCount.textContent = this.duplicateWords.length;
        }
      }
      
      // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    var confirmBtn = document.getElementById('confirm-duplicate-action');
    var nextBtn = document.getElementById('next-duplicate');
      
    if (confirmBtn) confirmBtn.style.display = 'none';
    if (nextBtn) {
      nextBtn.style.display = 'inline-block';
      nextBtn.disabled = false;
      
      if (this.duplicateWords.length === 0) {
        nextBtn.textContent = 'å®Œæˆè™•ç†';
      } else if (this.currentDuplicateIndex >= this.duplicateWords.length - 1) {
        nextBtn.textContent = 'å®Œæˆè™•ç†';
      } else {
        nextBtn.textContent = 'ä¸‹ä¸€å€‹';
      }
    }
  };
    
    // è™•ç†ä¸‹ä¸€å€‹é‡è¤‡é …ç›®
  FlashcardApp.prototype.nextDuplicate = function() {
    console.log('è™•ç†ä¸‹ä¸€å€‹é‡è¤‡é …ç›®');
      
      if (this.duplicateWords.length === 0 || this.currentDuplicateIndex >= this.duplicateWords.length) {
        this.finishDuplicateProcessing();
      } else {
      var confirmBtn = document.getElementById('confirm-duplicate-action');
      var nextBtn = document.getElementById('next-duplicate');
      
      if (confirmBtn) {
        confirmBtn.style.display = 'inline-block';
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'ç¢ºèªæ“ä½œ';
      }
      if (nextBtn) nextBtn.style.display = 'none';
      
      this.selectDuplicateWord(this.currentDuplicateIndex);
      }
  };
    
    // å®Œæˆé‡è¤‡è™•ç†
  FlashcardApp.prototype.finishDuplicateProcessing = function() {
      console.log('å®Œæˆé‡è¤‡è™•ç†');
      
      // é¡¯ç¤ºè™•ç†æ‘˜è¦
    var successCount = this.duplicateProcessingResults ? 
      this.duplicateProcessingResults.filter(function(r) { return r.success; }).length : 0;
    var totalCount = this.duplicateProcessingResults ? this.duplicateProcessingResults.length : 0;
      
    alert('é‡è¤‡è™•ç†å®Œæˆï¼\næˆåŠŸè™•ç†: ' + successCount + '/' + totalCount + ' å€‹é‡è¤‡é …ç›®');
      
      // é—œé–‰Modal
      this.closeDuplicateModal();
      
      // é‡æ–°è¼‰å…¥å–®å­—ï¼ˆä»¥åæ˜ æ›´æ”¹ï¼‰
      this.reloadWordsAfterDuplicateProcessing();
  };
    
    // é‡è¤‡è™•ç†å¾Œé‡æ–°è¼‰å…¥å–®å­—
  FlashcardApp.prototype.reloadWordsAfterDuplicateProcessing = function() {
      console.log('é‡è¤‡è™•ç†å¾Œé‡æ–°è¼‰å…¥å–®å­—');
      
      // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    var loadingDiv = document.getElementById('loading');
    var flashcardDiv = document.getElementById('flashcard');
    if (loadingDiv) loadingDiv.style.display = 'flex';
    if (flashcardDiv) flashcardDiv.style.display = 'none';
    
    // é‡æ–°è¼‰å…¥å–®å­—
    var self = this;
    this.loadWords(false, function(hasDuplicates) {
      self.setupEventListeners();
      self.applySettings();
      
      if (!hasDuplicates) {
        self.startNewRound();
      }
      
      if (loadingDiv) loadingDiv.style.display = 'none';
      if (flashcardDiv) flashcardDiv.style.display = 'flex';
    });
  };
  
  // å…¨åŸŸè®Šæ•¸
  var app;
  
  // é é¢è¼‰å…¥å®Œæˆå¾Œå•Ÿå‹•
  window.addEventListener('load', function() {
    try {
      console.log('é é¢è¼‰å…¥å®Œæˆï¼Œå•Ÿå‹•FlashcardApp');
      app = new FlashcardApp();
      
      // èªéŸ³åˆ—è¡¨è¼‰å…¥å¾Œå¡«å……èªéŸ³è…”èª¿é¸å–®
    if (window.speechSynthesis) {
        window.speechSynthesis.onvoiceschanged = function() {
          if (app && typeof app.populateVoiceSelect === 'function') {
          app.populateVoiceSelect();
        }
      };
    }
    } catch (error) {
      console.error('æ‡‰ç”¨å•Ÿå‹•å¤±æ•—:', error);
      var loadingDiv = document.getElementById('loading');
      var errorDiv = document.getElementById('error');
      if (loadingDiv) loadingDiv.style.display = 'none';
      if (errorDiv) {
        errorDiv.style.display = 'block';
        errorDiv.innerHTML = '<h2>å•Ÿå‹•å¤±æ•—</h2><p>è«‹é‡æ–°æ•´ç†é é¢ï¼ŒéŒ¯èª¤ï¼š' + error.message + '</p>';
      }
    }
  });
  
  console.log('FlashcardApp ES5å…¼å®¹ç‰ˆæœ¬å·²è¼‰å…¥');
  </script>
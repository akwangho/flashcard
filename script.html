<script>
// ES5兼容性檢查和修復 for iPad4舊版瀏覽器
(function() {
  'use strict';
  
  // 添加基本的polyfills
  if (!Array.prototype.forEach) {
    Array.prototype.forEach = function(callback, thisArg) {
      for (var i = 0; i < this.length; i++) {
        callback.call(thisArg, this[i], i, this);
      }
    };
  }
  
  if (!Array.prototype.filter) {
    Array.prototype.filter = function(callback, thisArg) {
      var result = [];
      for (var i = 0; i < this.length; i++) {
        if (callback.call(thisArg, this[i], i, this)) {
          result.push(this[i]);
        }
      }
      return result;
    };
  }
})();

// 全域變數定義 (ES5兼容版本)
var flashcardApp = {};

// 初始化函數
function initFlashcardApp() {
  console.log('開始初始化FlashcardApp (ES5兼容版本)');
  
  // 初始化屬性
  flashcardApp.words = [];
  flashcardApp.currentWords = [];
  flashcardApp.currentIndex = 0;
  flashcardApp.removedWords = [];
  flashcardApp.displayTimer = null;
  flashcardApp.showingChinese = false;
  flashcardApp.isTransitioning = false;
  flashcardApp.speechSynthesis = window.speechSynthesis;
  flashcardApp.isPaused = false;
  flashcardApp.isProcessingClick = false;
  flashcardApp.pendingRemoval = null;
  flashcardApp.navigationHistory = [];
  
  // 設定
  flashcardApp.settings = {
    delayTime: 3,
    fontSize: 96,
    reverseMode: false
  };
  
  try {
    loadSettings();
    loadWords();
    setupEventListeners();
    applySettings();
    startNewRound();
    hideLoading();
    console.log('FlashcardApp 初始化完成');
  } catch (error) {
    console.error('FlashcardApp 初始化失敗:', error);
    showError();
  }
}

// 載入設定
function loadSettings() {
  try {
    var savedSettings = JSON.parse(localStorage.getItem('flashcard-settings') || '{}');
    for (var key in savedSettings) {
      if (savedSettings.hasOwnProperty(key) && flashcardApp.settings.hasOwnProperty(key)) {
        flashcardApp.settings[key] = savedSettings[key];
      }
    }
  } catch (e) {
    console.log('載入設定失敗，使用預設值');
  }
}

// 隱藏載入畫面
function hideLoading() {
  var loadingDiv = document.getElementById('loading');
  var flashcardDiv = document.getElementById('flashcard');
  if (loadingDiv) loadingDiv.style.display = 'none';
  if (flashcardDiv) flashcardDiv.style.display = 'flex';
}

// 顯示錯誤
function showError() {
  var loadingDiv = document.getElementById('loading');
  var errorDiv = document.getElementById('error');
  if (loadingDiv) loadingDiv.style.display = 'none';
  if (errorDiv) errorDiv.style.display = 'block';
}

// 載入單字
function loadWords() {
  flashcardApp.words = getDemoWords();
}

// 取得示例單字
function getDemoWords() {
  return [
    {id: 0, english: 'Hello', chinese: '你好', difficult: false},
    {id: 1, english: 'World', chinese: '世界', difficult: false},
    {id: 2, english: 'Apple', chinese: '蘋果', difficult: false},
    {id: 3, english: 'Book', chinese: '書', difficult: false},
    {id: 4, english: 'Computer', chinese: '電腦', difficult: false},
    {id: 5, english: 'Friend', chinese: '朋友', difficult: false},
    {id: 6, english: 'Happy', chinese: '快樂', difficult: false},
    {id: 7, english: 'Study', chinese: '學習', difficult: false},
    {id: 8, english: 'Love', chinese: '愛', difficult: false},
    {id: 9, english: 'Peace', chinese: '和平', difficult: false}
  ];
}

// 開始新回合
function startNewRound() {
  flashcardApp.currentWords = flashcardApp.words.slice();
  
  if (flashcardApp.currentWords.length === 0) {
    flashcardApp.currentWords = getDemoWords();
  }
  
  shuffleArray(flashcardApp.currentWords);
  flashcardApp.currentIndex = 0;
  flashcardApp.navigationHistory = [];
  displayCurrentWord();
}

// 洗牌算法
function shuffleArray(array) {
  for (var i = array.length - 1; i > 0; i--) {
    var j = Math.floor(Math.random() * (i + 1));
    var temp = array[i];
    array[i] = array[j];
    array[j] = temp;
  }
}

// 顯示當前單字
function displayCurrentWord() {
  if (flashcardApp.currentWords.length === 0) {
    startNewRound();
    return;
  }
  
  var currentWord = flashcardApp.currentWords[flashcardApp.currentIndex];
  var englishElement = document.getElementById('english-word');
  var chineseElement = document.getElementById('chinese-word');
  
  if (!englishElement || !chineseElement) {
    console.error('找不到必要的HTML元素');
    return;
  }
  
  flashcardApp.showingChinese = false;
  flashcardApp.isTransitioning = false;
  flashcardApp.isProcessingClick = false;
  flashcardApp.pendingRemoval = null;
  
  if (flashcardApp.displayTimer) {
    clearTimeout(flashcardApp.displayTimer);
  }
  
  englishElement.classList.remove('show');
  chineseElement.classList.remove('show');
  
  englishElement.style.color = '';
  chineseElement.style.color = '';
  
  setTimeout(function() {
    var firstElement = document.getElementById('english-word');
    
    // 根據設定決定顯示順序
    if (flashcardApp.settings.reverseMode) {
      // 先顯示中文
      firstElement.textContent = currentWord.chinese;
    } else {
      // 先顯示英文（原本的邏輯）
      firstElement.textContent = currentWord.english;
      // 發音英文單字
      setTimeout(function() {
        speakEnglishWord(currentWord.english);
      }, 500);
    }
    firstElement.classList.add('show');

    // 延遲顯示第二部分
    flashcardApp.displayTimer = setTimeout(function() {
      showSecondPartAndScheduleNext();
    }, flashcardApp.settings.delayTime * 1000);
    
  }, 100);
  
  updateProgress();
  updateButtonStates();
}

// 顯示第二部分並安排下一個
function showSecondPartAndScheduleNext() {
  var currentWord = flashcardApp.currentWords[flashcardApp.currentIndex];
  var chineseElement = document.getElementById('chinese-word');
  
  var secondText = flashcardApp.settings.reverseMode ? currentWord.english : currentWord.chinese;
  chineseElement.textContent = secondText;
  chineseElement.classList.add('show');
  flashcardApp.showingChinese = true;
  
  // 如果是反向模式且還沒發音，現在發音
  if (flashcardApp.settings.reverseMode) {
    setTimeout(function() {
      speakEnglishWord(currentWord.english);
    }, 500);
  }
  
  flashcardApp.displayTimer = setTimeout(function() {
    nextWord();
  }, flashcardApp.settings.delayTime * 1000);
}

// 更新進度
function updateProgress() {
  var progressText = document.getElementById('progress-text');
  if (progressText) {
    var current = flashcardApp.currentIndex + 1;
    var total = flashcardApp.currentWords.length;
    progressText.textContent = current + '/' + total;
  }
}

// 更新按鈕狀態
function updateButtonStates() {
  var prevBtn = document.getElementById('prev-btn');
  if (prevBtn) {
    var isFirstWord = flashcardApp.currentIndex === 0;
    var hasPendingRemoval = flashcardApp.pendingRemoval !== null;
    prevBtn.disabled = (isFirstWord && !hasPendingRemoval) || flashcardApp.navigationHistory.length === 0;
  }
}

// 單字點擊事件
function onWordClick() {
  if (flashcardApp.isTransitioning || flashcardApp.isPaused) return;
  
  if (flashcardApp.currentWords.length <= 1) {
    var sections = document.querySelectorAll('.card-section');
    for (var i = 0; i < sections.length; i++) {
      sections[i].style.backgroundColor = 'rgba(255, 100, 100, 0.3)';
      setTimeout((function(section) {
        return function() {
          section.style.backgroundColor = '';
        };
      })(sections[i]), 300);
    }
    return;
  }
  
  var currentWord = flashcardApp.currentWords[flashcardApp.currentIndex];
  var englishElement = document.getElementById('english-word');
  var chineseElement = document.getElementById('chinese-word');
  
  var isAlreadyMarked = englishElement.style.color === 'rgb(102, 102, 102)' || 
                      englishElement.style.color === '#666666';
  
  if (isAlreadyMarked) {
    nextWord();
    return;
  }
  
  flashcardApp.isProcessingClick = true;
  
  if (flashcardApp.displayTimer) {
    clearTimeout(flashcardApp.displayTimer);
  }
  
  if (!flashcardApp.showingChinese) {
    var secondText = flashcardApp.settings.reverseMode ? currentWord.english : currentWord.chinese;
    chineseElement.textContent = secondText;
    chineseElement.classList.add('show');
    flashcardApp.showingChinese = true;
    
    // 如果是反向模式且還沒發音，現在發音
    if (flashcardApp.settings.reverseMode) {
      setTimeout(function() {
        speakEnglishWord(currentWord.english);
      }, 500);
    }
  }
  
  englishElement.style.color = '#666666';
  chineseElement.style.color = '#666666';
  
  var sections = document.querySelectorAll('.card-section');
  for (var i = 0; i < sections.length; i++) {
    sections[i].classList.add('clicked');
    setTimeout((function(section) {
      return function() {
        section.classList.remove('clicked');
      };
    })(sections[i]), 500);
  }
  
  flashcardApp.pendingRemoval = {
    word: currentWord,
    index: flashcardApp.currentIndex,
    originalEnglishColor: englishElement.style.color,
    originalChineseColor: chineseElement.style.color
  };
  
  updateButtonStates();
  
  flashcardApp.displayTimer = setTimeout(function() {
    confirmRemoval();
  }, flashcardApp.settings.delayTime * 1000);
}

// 確認移除
function confirmRemoval() {
  if (!flashcardApp.pendingRemoval) return;
  
  var word = flashcardApp.pendingRemoval.word;
  var index = flashcardApp.pendingRemoval.index;
  
  flashcardApp.removedWords.push(word);
  flashcardApp.currentWords.splice(index, 1);
  
  if (flashcardApp.currentIndex >= flashcardApp.currentWords.length) {
    flashcardApp.currentIndex = 0;
  }
  
  flashcardApp.pendingRemoval = null;
  
  if (flashcardApp.currentWords.length === 0) {
    startNewRound();
  } else {
    displayCurrentWord();
  }
  
  flashcardApp.isProcessingClick = false;
  updateButtonStates();
}

// 下一個單字
function nextWord() {
  if (flashcardApp.isTransitioning || flashcardApp.isPaused) return;
  
  if (flashcardApp.pendingRemoval) {
    confirmRemoval();
    return;
  }
  
  if (!flashcardApp.showingChinese) {
    showSecondPartAndScheduleNext();
    return;
  }
  
  saveNavigationState();
  
  if (flashcardApp.displayTimer) {
    clearTimeout(flashcardApp.displayTimer);
  }
  
  if (flashcardApp.speechSynthesis) {
    flashcardApp.speechSynthesis.cancel();
  }
  
  flashcardApp.isTransitioning = true;
  
  var englishElement = document.getElementById('english-word');
  var chineseElement = document.getElementById('chinese-word');
  
  englishElement.classList.remove('show');
  chineseElement.classList.remove('show');
  
  chineseElement.textContent = '';
  
  setTimeout(function() {
    flashcardApp.currentIndex = (flashcardApp.currentIndex + 1) % flashcardApp.currentWords.length;
    
    if (flashcardApp.currentIndex === 0) {
      shuffleArray(flashcardApp.currentWords);
      flashcardApp.navigationHistory = [];
    }
    
    displayCurrentWord();
    flashcardApp.isTransitioning = false;
    
  }, 300);
}

// 儲存導覽狀態
function saveNavigationState() {
  flashcardApp.navigationHistory.push({
    currentIndex: flashcardApp.currentIndex,
    wordSequence: flashcardApp.currentWords.slice()
  });
}

// 上一個單字
function previousWord() {
  if (flashcardApp.isTransitioning || flashcardApp.isPaused) return;
  
  if (flashcardApp.pendingRemoval) {
    // 取消移除
    var englishElement = document.getElementById('english-word');
    var chineseElement = document.getElementById('chinese-word');
    
    englishElement.style.color = '';
    chineseElement.style.color = '';
    
    flashcardApp.pendingRemoval = null;
    
    if (flashcardApp.displayTimer) {
      clearTimeout(flashcardApp.displayTimer);
    }
    
    flashcardApp.isProcessingClick = false;
    updateButtonStates();
    return;
  }
  
  if (flashcardApp.navigationHistory.length === 0) return;
  
  if (flashcardApp.displayTimer) {
    clearTimeout(flashcardApp.displayTimer);
  }
  
  if (flashcardApp.speechSynthesis) {
    flashcardApp.speechSynthesis.cancel();
  }
  
  flashcardApp.isTransitioning = true;
  
  var englishElement = document.getElementById('english-word');
  var chineseElement = document.getElementById('chinese-word');
  
  englishElement.classList.remove('show');
  chineseElement.classList.remove('show');
  
  chineseElement.textContent = '';
  
  setTimeout(function() {
    var previousState = flashcardApp.navigationHistory.pop();
    flashcardApp.currentIndex = previousState.currentIndex;
    flashcardApp.currentWords = previousState.wordSequence.slice();
    
    displayCurrentWord();
    flashcardApp.isTransitioning = false;
    
  }, 300);
}

// 重新開始
function restart() {
  if (flashcardApp.displayTimer) {
    clearTimeout(flashcardApp.displayTimer);
  }
  if (flashcardApp.speechSynthesis) {
    flashcardApp.speechSynthesis.cancel();
  }
  flashcardApp.pendingRemoval = null;
  closeMenu();
  startNewRound();
}

// 語音播放
function speakEnglishWord(text) {
  if (!flashcardApp.speechSynthesis || !text) return;
  
  try {
    var utterance = new SpeechSynthesisUtterance(text);
    utterance.rate = 0.8;
    utterance.lang = 'en-US';
    flashcardApp.speechSynthesis.speak(utterance);
  } catch (e) {
    console.log('語音播放失敗:', e);
  }
}

// 設定事件監聽器
function setupEventListeners() {
  var englishWord = document.getElementById('english-word');
  var chineseWord = document.getElementById('chinese-word');
  
  if (englishWord) englishWord.addEventListener('click', onWordClick);
  if (chineseWord) chineseWord.addEventListener('click', onWordClick);
  
  // 按鈕事件
  var prevBtn = document.getElementById('prev-btn');
  var nextBtn = document.getElementById('next-btn');
  
  if (prevBtn) prevBtn.addEventListener('click', previousWord);
  if (nextBtn) nextBtn.addEventListener('click', nextWord);
  
  // 鍵盤事件
  document.addEventListener('keydown', function(event) {
    if (event.key === 'ArrowLeft' || event.keyCode === 37) {
      event.preventDefault();
      previousWord();
    } else if (event.key === 'ArrowRight' || event.keyCode === 39) {
      event.preventDefault();
      nextWord();
    } else if (event.key === ' ' || event.keyCode === 32) {
      event.preventDefault();
      onWordClick();
    }
  });
  
  // 選單相關事件
  var menuBtn = document.getElementById('menu-btn');
  var restartBtn = document.getElementById('restart-btn');
  
  if (menuBtn) menuBtn.addEventListener('click', toggleMenu);
  if (restartBtn) restartBtn.addEventListener('click', restart);
  
  // 設定相關事件
  var settingsBtn = document.getElementById('settings-btn');
  var closeSettings = document.getElementById('close-settings');
  var saveSettings = document.getElementById('save-settings');
  
  if (settingsBtn) settingsBtn.addEventListener('click', openSettings);
  if (closeSettings) closeSettings.addEventListener('click', closeSettingsModal);
  if (saveSettings) saveSettings.addEventListener('click', saveSettingsAndClose);
}

// 應用設定
function applySettings() {
  if (document.documentElement.style.setProperty) {
    document.documentElement.style.setProperty('--font-4xl', flashcardApp.settings.fontSize + 'px');
  }
}

// 選單相關函數
function toggleMenu() {
  var menuDropdown = document.getElementById('menu-dropdown');
  if (menuDropdown) {
    if (menuDropdown.classList.contains('show')) {
      menuDropdown.classList.remove('show');
    } else {
      menuDropdown.classList.add('show');
    }
  }
}

function closeMenu() {
  var menuDropdown = document.getElementById('menu-dropdown');
  if (menuDropdown) {
    menuDropdown.classList.remove('show');
  }
}

// 設定相關函數
function openSettings() {
  var settingsModal = document.getElementById('settings-modal');
  if (settingsModal) {
    settingsModal.style.display = 'flex';
  }
  closeMenu();
}

function closeSettingsModal() {
  var settingsModal = document.getElementById('settings-modal');
  if (settingsModal) {
    settingsModal.style.display = 'none';
  }
}

function saveSettingsAndClose() {
  try {
    var delaySlider = document.getElementById('delay-setting');
    var fontSizeSlider = document.getElementById('font-size-setting');
    var reverseToggle = document.getElementById('reverse-setting');
    
    if (delaySlider) flashcardApp.settings.delayTime = parseFloat(delaySlider.value);
    if (fontSizeSlider) flashcardApp.settings.fontSize = parseInt(fontSizeSlider.value);
    if (reverseToggle) flashcardApp.settings.reverseMode = reverseToggle.checked;
    
    localStorage.setItem('flashcard-settings', JSON.stringify(flashcardApp.settings));
    
    applySettings();
    closeSettingsModal();
  } catch (e) {
    console.log('儲存設定失敗:', e);
    closeSettingsModal();
  }
}

// 當頁面載入完成後啟動應用 (ES5 兼容版本)
window.addEventListener('load', function() {
  // 兼容性檢查
  try {
    // 檢查基本功能
    if (!document.getElementById || !document.createElement || !document.querySelector) {
      throw new Error('基本DOM功能不支援');
    }
    
    console.log('嘗試初始化FlashcardApp (ES5兼容版本)...');
    initFlashcardApp();
    
    console.log('FlashcardApp 成功初始化');
  } catch (error) {
    console.error('FlashcardApp 初始化失敗:', error);
    
    // 顯示兼容性錯誤訊息
    var loadingDiv = document.getElementById('loading');
    var errorDiv = document.getElementById('error');
    
    if (loadingDiv) {
      loadingDiv.style.display = 'none';
    }
    
    if (errorDiv) {
      errorDiv.style.display = 'block';
      errorDiv.innerHTML = '<h2>瀏覽器兼容性問題</h2>' +
        '<p>您的瀏覽器版本可能過舊，不支援此應用程式的某些功能。</p>' +
        '<p><strong>檢測到的問題：</strong></p>' +
        '<ul>' +
        '<li>iPad4 Chrome 134版本可能不支援某些JavaScript功能</li>' +
        '<li>請嘗試重新整理頁面</li>' +
        '<li>如果問題持續，建議使用Safari瀏覽器</li>' +
        '</ul>' +
        '<p><strong>錯誤詳情：</strong> ' + error.message + '</p>' +
        '<p><strong>建議解決方案：</strong></p>' +
        '<ul>' +
        '<li>嘗試重新整理頁面</li>' +
        '<li>清除瀏覽器快取</li>' +
        '<li>使用Safari瀏覽器（通常在iPad上相容性更好）</li>' +
        '</ul>';
    } else {
      // 如果沒有error div，創建一個
      var newErrorDiv = document.createElement('div');
      newErrorDiv.innerHTML = '<div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; color: black; padding: 20px; border: 2px solid red; z-index: 9999; max-width: 80%;"><h2>瀏覽器兼容性問題</h2><p>您的瀏覽器版本可能過舊，不支援此應用程式的某些功能。</p><p>請嘗試重新整理頁面或使用Safari瀏覽器。</p><p>錯誤詳情：' + error.message + '</p></div>';
      document.body.appendChild(newErrorDiv);
    }
  }
});
</script> 
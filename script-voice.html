<!-- script-voice.html -->
<script>
  // æª¢æ¸¬æ—¥æ–‡å­—ç¬¦
  FlashcardApp.prototype.isJapaneseText = function(text) {
    if (!text) return false;
    
    // æ—¥æ–‡å­—ç¬¦ç¯„åœï¼š
    // å¹³å‡å: \u3040-\u309f
    // ç‰‡å‡å: \u30a0-\u30ff
    // æ¼¢å­—: \u4e00-\u9faf
    // å…¨è§’æ¨™é»: \u3000-\u303f
    var japanesePattern = /[\u3040-\u309f\u30a0-\u30ff\u4e00-\u9faf\u3000-\u303f]/;
    
    return japanesePattern.test(text);
  };

  // é€å­—æ¯æ‹¼è®€è‹±æ–‡å–®å­—
  FlashcardApp.prototype.speakEnglishLetters = function(text, callback) {
    if (!this.voiceSettings.enabled || !this.voiceSettings.spellOutLetters) {
      if (callback) callback();
      return;
    }
    if (!text) {
      if (callback) callback();
      return;
    }
    
    // èˆŠç‰ˆç€è¦½å™¨æª¢æŸ¥ç”¨æˆ¶äº¤äº’ç‹€æ…‹
    if (this.isLegacyBrowser && !this.speechActivated) {
      console.log('èˆŠç‰ˆç€è¦½å™¨ï¼šèªéŸ³æœªå•Ÿç”¨ï¼Œè·³éå­—æ¯æ‹¼è®€');
      if (callback) callback();
      return;
    }
    
    try {
      // æå–ç´”è‹±æ–‡å­—æ¯
      var letters = [];
      for (var i = 0; i < text.length; i++) {
        var char = text.charAt(i);
        if (/[a-zA-Z]/.test(char)) {
          letters.push(char.toLowerCase());
        }
      }
      
      if (letters.length === 0) {
        if (callback) callback();
        return;
      }
      
      console.log('æ‹¼è®€å­—æ¯:', letters.join('-'));
      
      var self = this;
      var currentLetterIndex = 0;
      
      // éè¿´å‡½æ•¸ï¼šé€å€‹å”¸å­—æ¯
      var speakNextLetter = function() {
        if (currentLetterIndex >= letters.length) {
          // æ‰€æœ‰å­—æ¯éƒ½å”¸å®Œäº†ï¼ŒåŸ·è¡Œå›èª¿
          if (callback) {
            setTimeout(callback, 100); // å­—æ¯æ‹¼è®€å’Œå–®å­—ç™¼éŸ³ä¹‹é–“ç•™ä¸€é»é–“éš”
          }
          return;
        }
        
        var letter = letters[currentLetterIndex];
        var utterance = new SpeechSynthesisUtterance(letter);
        utterance.rate = 1; // è‹±æ–‡å­—æ¯ç°¡å–®æ˜“æ‡‚ï¼Œå›ºå®šä½¿ç”¨æ­£å¸¸é€Ÿåº¦
        utterance.pitch = self.voiceSettings.pitch;
        utterance.volume = self.voiceSettings.volume;
        utterance.lang = self.voiceSettings.lang;
        
        // é¸æ“‡èªéŸ³
        var voices = self.speechSynthesis.getVoices();
        var selectedVoice = null;
        if (self.voiceSettings.voiceURI) {
          for (var i = 0; i < voices.length; i++) {
            if (voices[i].voiceURI === self.voiceSettings.voiceURI) {
              selectedVoice = voices[i];
              break;
            }
          }
        }
        
        if (!selectedVoice) {
          for (var i = 0; i < voices.length; i++) {
            if (voices[i].lang.indexOf('en-') === 0) {
              selectedVoice = voices[i];
              break;
            }
          }
        }
        
        if (selectedVoice) {
          utterance.voice = selectedVoice;
        }
        
        // ç•¶é€™å€‹å­—æ¯å”¸å®Œå¾Œï¼Œç¹¼çºŒä¸‹ä¸€å€‹
        utterance.onend = function() {
          currentLetterIndex++;
          setTimeout(speakNextLetter, 10); // å­—æ¯ä¹‹é–“é–“éš”10ms
        };
        
        utterance.onerror = function(event) {
          console.log('å­—æ¯æ‹¼è®€éŒ¯èª¤:', event.error);
          currentLetterIndex++;
          setTimeout(speakNextLetter, 10);
        };
        
        self.speechSynthesis.speak(utterance);
      };
      
      speakNextLetter();
      
    } catch (error) {
      console.log('å­—æ¯æ‹¼è®€å¤±æ•—:', error);
      if (callback) callback();
    }
  };

  // èªéŸ³æ’­æ”¾ï¼ˆè‹±æ–‡å–®å­—ï¼‰
  FlashcardApp.prototype.speakEnglishWord = function(text) {
    if (!this.voiceSettings.enabled) return;
    if (!text) return;
    
    // èˆŠç‰ˆç€è¦½å™¨æª¢æŸ¥ç”¨æˆ¶äº¤äº’ç‹€æ…‹
    if (this.isLegacyBrowser && !this.speechActivated) {
      console.log('èˆŠç‰ˆç€è¦½å™¨ï¼šèªéŸ³æœªå•Ÿç”¨ï¼Œè·³éæ’­æ”¾');
      return;
    }
    
    var self = this;
    
    // å¦‚æœå•Ÿç”¨äº†å­—æ¯æ‹¼è®€ï¼Œå…ˆæ‹¼è®€å­—æ¯ï¼Œç„¶å¾Œå†å”¸å–®å­—
    if (this.voiceSettings.spellOutLetters) {
      // æ¨™è¨˜èªéŸ³åºåˆ—é–‹å§‹ï¼ˆæ‹¼è®€ + å–®å­—ç™¼éŸ³ï¼‰ï¼Œé˜²æ­¢ä¸­é€”è¢«åˆ‡æ›
      this._speechSequenceActive = true;
      this.speakEnglishLetters(text, function() {
        // å­—æ¯æ‹¼è®€å®Œæˆå¾Œï¼Œå”¸å®Œæ•´å–®å­—
        self.speakEnglishWordOnly(text);
      });
    } else {
      // ç›´æ¥å”¸å–®å­—
      this.speakEnglishWordOnly(text);
    }
  };

  // åªå”¸è‹±æ–‡å–®å­—ï¼ˆä¸æ‹¼è®€å­—æ¯ï¼‰
  FlashcardApp.prototype.speakEnglishWordOnly = function(text) {
    if (!this.voiceSettings.enabled) return;
    if (!text) return;
    
    try {
      console.log('æ’­æ”¾è‹±æ–‡èªéŸ³:', text);
      
      var utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = this.voiceSettings.rate;
      utterance.pitch = this.voiceSettings.pitch;
      utterance.volume = this.voiceSettings.volume;
      utterance.lang = this.voiceSettings.lang;
      
      var voices = this.speechSynthesis.getVoices();
      var selectedVoice = null;
      if (this.voiceSettings.voiceURI) {
        for (var i = 0; i < voices.length; i++) {
          if (voices[i].voiceURI === this.voiceSettings.voiceURI) {
            selectedVoice = voices[i];
            break;
          }
        }
      }
      
      if (!selectedVoice) {
        for (var i = 0; i < voices.length; i++) {
          if (voices[i].lang.indexOf('en-') === 0 || 
              voices[i].name.toLowerCase().indexOf('english') !== -1) {
            selectedVoice = voices[i];
            break;
          }
        }
      }
      
      if (selectedVoice) {
        utterance.voice = selectedVoice;
      }
      
      var self = this;
      
      // ç‚ºèˆŠç‰ˆç€è¦½å™¨æ·»åŠ éŒ¯èª¤è™•ç†
      utterance.onerror = function(event) {
        console.log('è‹±æ–‡èªéŸ³æ’­æ”¾éŒ¯èª¤:', event.error);
        self._speechSequenceActive = false;
      };
      
      utterance.onstart = function() {
        console.log('è‹±æ–‡èªéŸ³é–‹å§‹æ’­æ”¾:', text);
      };
      
      utterance.onend = function() {
        self._speechSequenceActive = false;
      };
      
      this.speechSynthesis.speak(utterance);
    } catch (error) {
      console.log('è‹±æ–‡èªéŸ³æ’­æ”¾å¤±æ•—:', error);
      this._speechSequenceActive = false;
    }
  };
  
  // æ—¥æ–‡èªéŸ³æ’­æ”¾
  FlashcardApp.prototype.speakJapaneseWord = function(text) {
    if (!this.voiceSettings.enabled) return;
    if (!text) return;
    
    // èˆŠç‰ˆç€è¦½å™¨æª¢æŸ¥ç”¨æˆ¶äº¤äº’ç‹€æ…‹
    if (this.isLegacyBrowser && !this.speechActivated) {
      console.log('èˆŠç‰ˆç€è¦½å™¨ï¼šèªéŸ³æœªå•Ÿç”¨ï¼Œè·³éæ’­æ”¾');
      return;
    }
    
    try {
      console.log('æ’­æ”¾æ—¥æ–‡èªéŸ³:', text);
      this.speechSynthesis.cancel();
      
      var utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = this.voiceSettings.rate;
      utterance.pitch = this.voiceSettings.pitch;
      utterance.volume = this.voiceSettings.volume;
      utterance.lang = this.voiceSettings.japaneseLang;
      
      var voices = this.speechSynthesis.getVoices();
      var selectedVoice = null;
      if (this.voiceSettings.japaneseVoiceURI) {
        for (var i = 0; i < voices.length; i++) {
          if (voices[i].voiceURI === this.voiceSettings.japaneseVoiceURI) {
            selectedVoice = voices[i];
            break;
          }
        }
      }
      
      if (!selectedVoice) {
        for (var i = 0; i < voices.length; i++) {
          if (voices[i].lang.indexOf('ja-') === 0 || 
              voices[i].name.toLowerCase().indexOf('japanese') !== -1) {
            selectedVoice = voices[i];
            break;
          }
        }
      }
      
      if (selectedVoice) {
        utterance.voice = selectedVoice;
      }
      
      // ç‚ºèˆŠç‰ˆç€è¦½å™¨æ·»åŠ éŒ¯èª¤è™•ç†
      utterance.onerror = function(event) {
        console.log('æ—¥æ–‡èªéŸ³æ’­æ”¾éŒ¯èª¤:', event.error);
      };
      
      utterance.onstart = function() {
        console.log('æ—¥æ–‡èªéŸ³é–‹å§‹æ’­æ”¾:', text);
      };
      
      this.speechSynthesis.speak(utterance);
    } catch (error) {
      console.log('æ—¥æ–‡èªéŸ³æ’­æ”¾å¤±æ•—:', error);
    }
  };
  
  // ä¸­æ–‡èªéŸ³æ’­æ”¾
  FlashcardApp.prototype.speakChineseWord = function(text) {
    if (!this.voiceSettings.chineseEnabled) return;
    if (!text) return;
    
    // èˆŠç‰ˆç€è¦½å™¨æª¢æŸ¥ç”¨æˆ¶äº¤äº’ç‹€æ…‹
    if (this.isLegacyBrowser && !this.speechActivated) {
      console.log('èˆŠç‰ˆç€è¦½å™¨ï¼šèªéŸ³æœªå•Ÿç”¨ï¼Œè·³éæ’­æ”¾');
      return;
    }
    
    var self = this;
    
    // æ¸…ç†ä¹‹å‰çš„ç­‰å¾…å®šæ™‚å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if (this.chineseWaitInterval) {
      clearInterval(this.chineseWaitInterval);
      this.chineseWaitInterval = null;
    }
    
    // å¦‚æœæ­£åœ¨æ’­æ”¾è‹±æ–‡æˆ–æ—¥æ–‡èªéŸ³ï¼ˆåŒ…æ‹¬å­—æ¯æ‹¼è®€ï¼‰ï¼Œç­‰å¾…æ’­æ”¾å®Œæˆ
    if (this.speechSynthesis.speaking) {
      console.log('ç­‰å¾…è‹±æ–‡/æ—¥æ–‡èªéŸ³æ’­æ”¾å®Œæˆå¾Œå†æ’­æ”¾ä¸­æ–‡...');
      
      // ä½¿ç”¨è¼ªè©¢æª¢æŸ¥èªéŸ³æ˜¯å¦æ’­æ”¾å®Œæˆ
      this.chineseWaitInterval = setInterval(function() {
        if (!self.speechSynthesis.speaking) {
          clearInterval(self.chineseWaitInterval);
          self.chineseWaitInterval = null;
          console.log('è‹±æ–‡/æ—¥æ–‡èªéŸ³æ’­æ”¾å®Œæˆï¼Œç¾åœ¨æ’­æ”¾ä¸­æ–‡');
          self.speakChineseWordNow(text);
        }
      }, 100); // æ¯100msæª¢æŸ¥ä¸€æ¬¡
      
      return;
    }
    
    // å¦‚æœæ²’æœ‰èªéŸ³æ­£åœ¨æ’­æ”¾ï¼Œç›´æ¥æ’­æ”¾ä¸­æ–‡
    this.speakChineseWordNow(text);
  };
  
  // ç«‹å³æ’­æ”¾ä¸­æ–‡èªéŸ³ï¼ˆå…§éƒ¨å‡½æ•¸ï¼‰
  FlashcardApp.prototype.speakChineseWordNow = function(text) {
    if (!text) return;
    
    try {
      console.log('æ’­æ”¾ä¸­æ–‡èªéŸ³:', text);
      
      var utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = 1; // ä¸­æ–‡ç‚ºæ¯èªï¼Œå›ºå®šä½¿ç”¨æ­£å¸¸é€Ÿåº¦
      utterance.pitch = this.voiceSettings.pitch;
      utterance.volume = this.voiceSettings.volume;
      utterance.lang = this.voiceSettings.chineseLang;
      
      var voices = this.speechSynthesis.getVoices();
      var selectedVoice = null;
      if (this.voiceSettings.chineseVoiceURI) {
        for (var i = 0; i < voices.length; i++) {
          if (voices[i].voiceURI === this.voiceSettings.chineseVoiceURI) {
            selectedVoice = voices[i];
            break;
          }
        }
      }
      
      if (!selectedVoice) {
        for (var i = 0; i < voices.length; i++) {
          if (voices[i].lang.indexOf('zh-') === 0 || 
              voices[i].name.toLowerCase().indexOf('chinese') !== -1) {
            selectedVoice = voices[i];
            break;
          }
        }
      }
      
      if (selectedVoice) {
        utterance.voice = selectedVoice;
      }
      
      // ç‚ºèˆŠç‰ˆç€è¦½å™¨æ·»åŠ éŒ¯èª¤è™•ç†
      utterance.onerror = function(event) {
        console.log('ä¸­æ–‡èªéŸ³æ’­æ”¾éŒ¯èª¤:', event.error);
      };
      
      utterance.onstart = function() {
        console.log('ä¸­æ–‡èªéŸ³é–‹å§‹æ’­æ”¾:', text);
      };
      
      this.speechSynthesis.speak(utterance);
    } catch (error) {
      console.log('ä¸­æ–‡èªéŸ³æ’­æ”¾å¤±æ•—:', error);
    }
  };
  
  // æ™ºèƒ½èªéŸ³æ’­æ”¾ï¼ˆè‡ªå‹•æª¢æ¸¬èªè¨€ - åƒ…ç”¨æ–¼è‹±æ–‡/æ—¥æ–‡å–®å­—ï¼‰
  FlashcardApp.prototype.speakWord = function(text) {
    if (!text) return;
    
    if (this.isJapaneseText(text)) {
      // æ–‡æœ¬åŒ…å«æ—¥æ–‡å­—ç¬¦ï¼Œä½¿ç”¨æ—¥æ–‡èªéŸ³
      this.speakJapaneseWord(text);
    } else {
      // æ–‡æœ¬ç‚ºè‹±æ–‡ï¼Œä½¿ç”¨è‹±æ–‡èªéŸ³ï¼ˆå¯èƒ½åŒ…å«å­—æ¯æ‹¼è®€ï¼‰
      this.speakEnglishWord(text);
    }
  };
  
  // æ¸…é™¤èªéŸ³ç­‰å¾…è¨ˆæ™‚å™¨
  FlashcardApp.prototype.clearSpeechWait = function() {
    if (this._speechWaitInterval) {
      clearInterval(this._speechWaitInterval);
      this._speechWaitInterval = null;
    }
    if (this._speechWaitTimeout) {
      clearTimeout(this._speechWaitTimeout);
      this._speechWaitTimeout = null;
    }
  };

  // ç­‰å¾…èªéŸ³æ’­æ”¾å®Œæˆå¾Œæ‰åŸ·è¡Œå›èª¿ï¼ˆç¢ºä¿å­—æ¯æ‹¼è®€å’Œä¸­æ–‡èªéŸ³ä¸æœƒè¢«ä¸­é€”æ‰“æ–·ï¼‰
  FlashcardApp.prototype.waitForSpeechThenExecute = function(callback) {
    var self = this;
    
    // æ¸…é™¤ä¹‹å‰çš„ç­‰å¾…
    this.clearSpeechWait();
    
    // æª¢æŸ¥æ˜¯å¦æœ‰éœ€è¦ç­‰å¾…çš„èªéŸ³åŠŸèƒ½å•Ÿç”¨
    var hasSpellOut = this.voiceSettings.enabled && this.voiceSettings.spellOutLetters;
    var hasChinese = this.voiceSettings.chineseEnabled;
    
    if (!hasSpellOut && !hasChinese) {
      callback();
      return;
    }
    
    // æª¢æŸ¥æ˜¯å¦æœ‰èªéŸ³æ­£åœ¨æ’­æ”¾æˆ–ç­‰å¾…ä¸­
    var isSpeaking = false;
    try {
      isSpeaking = this.speechSynthesis.speaking || !!this.chineseWaitInterval || this._speechSequenceActive;
    } catch (e) {
      // èªéŸ³ API ä¸å¯ç”¨æ™‚ç›´æ¥åŸ·è¡Œå›èª¿
      callback();
      return;
    }
    
    if (!isSpeaking) {
      callback();
      return;
    }
    
    console.log('èªéŸ³ä»åœ¨æ’­æ”¾ä¸­ï¼Œç­‰å¾…å®Œæˆå¾Œå†åˆ‡æ›...');
    
    // è¼ªè©¢ç­‰å¾…èªéŸ³æ’­æ”¾å®Œæˆ
    this._speechWaitInterval = setInterval(function() {
      var stillSpeaking = false;
      try {
        stillSpeaking = self.speechSynthesis.speaking || !!self.chineseWaitInterval || self._speechSequenceActive;
      } catch (e) {
        stillSpeaking = false;
      }
      
      if (!stillSpeaking) {
        self.clearSpeechWait();
        // èªéŸ³æ’­æ”¾å®Œæˆå¾Œï¼ŒçŸ­æš«å»¶é²å†åŸ·è¡Œå›èª¿
        setTimeout(function() {
          if (!self.isPaused) {
            callback();
          }
        }, 300);
      }
    }, 100);
    
    // å®‰å…¨è¶…æ™‚ï¼šæœ€å¤šç­‰å¾… 60 ç§’ï¼Œé¿å…æ°¸é å¡ä½
    this._speechWaitTimeout = setTimeout(function() {
      console.log('èªéŸ³ç­‰å¾…è¶…æ™‚ï¼ˆ60ç§’ï¼‰ï¼Œå¼·åˆ¶åŸ·è¡Œåˆ‡æ›');
      self.clearSpeechWait();
      if (!self.isPaused) {
        callback();
      }
    }, 60000);
  };

  // ä¸‹ä¸€å€‹å–®å­—
  FlashcardApp.prototype.nextWord = function() {
    if (this.isTransitioning || this.isPaused) return;
    
    if (this.pendingRemoval) {
      this.confirmRemoval();
        return;
      }
      
    if (!this.showingChinese) {
      this.showSecondPartAndScheduleNext();
        return;
      }
      
    this.saveNavigationState();
    
      if (this.displayTimer) {
        clearTimeout(this.displayTimer);
    }
    
    // æ¸…ç†èªéŸ³ç­‰å¾…è¨ˆæ™‚å™¨
    this.clearSpeechWait();
    
    // æ¸…ç†ä¸­æ–‡èªéŸ³ç­‰å¾…å®šæ™‚å™¨
    if (this.chineseWaitInterval) {
      clearInterval(this.chineseWaitInterval);
      this.chineseWaitInterval = null;
    }
    
    this._speechSequenceActive = false;
    this.speechSynthesis.cancel();
    
    this.isTransitioning = true;
    
    var englishElement = document.getElementById('english-word');
    var chineseElement = document.getElementById('chinese-word');
    
    englishElement.classList.remove('show');
    chineseElement.classList.remove('show');
    
    chineseElement.textContent = '';
    // æ¸…é™¤èƒŒæ™¯åœ–ç‰‡
    var flashcardDiv = document.getElementById('flashcard');
    if (flashcardDiv) {
      flashcardDiv.style.backgroundImage = '';
      flashcardDiv.classList.remove('has-image');
    }
    
    var self = this;
    setTimeout(function() {
      self.currentIndex = (self.currentIndex + 1) % self.currentWords.length;
      
      if (self.currentIndex === 0) {
        self.shuffleArray(self.currentWords);
        self.navigationHistory = [];
      }
      
      self.displayCurrentWord();
      self.isTransitioning = false;
      
    }, 300);
    this.renderDifficultyLevel();
  };
  
  // ä¸Šä¸€å€‹å–®å­—
  FlashcardApp.prototype.previousWord = function() {
    if (this.isTransitioning || this.isPaused) return;
    
    if (this.pendingRemoval) {
      this.cancelRemoval();
      return;
    }
    
    if (this.navigationHistory.length === 0) return;
    
    if (this.displayTimer) {
      clearTimeout(this.displayTimer);
    }
    
    // æ¸…ç†èªéŸ³ç­‰å¾…è¨ˆæ™‚å™¨
    this.clearSpeechWait();
    
    // æ¸…ç†ä¸­æ–‡èªéŸ³ç­‰å¾…å®šæ™‚å™¨
    if (this.chineseWaitInterval) {
      clearInterval(this.chineseWaitInterval);
      this.chineseWaitInterval = null;
    }
    
    this._speechSequenceActive = false;
    this.speechSynthesis.cancel();
    
    this.isTransitioning = true;
    
    var englishElement = document.getElementById('english-word');
    var chineseElement = document.getElementById('chinese-word');
    
    englishElement.classList.remove('show');
    chineseElement.classList.remove('show');
    
    chineseElement.textContent = '';
    // æ¸…é™¤èƒŒæ™¯åœ–ç‰‡
    var flashcardDiv = document.getElementById('flashcard');
    if (flashcardDiv) {
      flashcardDiv.style.backgroundImage = '';
      flashcardDiv.classList.remove('has-image');
    }
    
    var self = this;
    setTimeout(function() {
      var previousState = self.navigationHistory.pop();
      
      var previousWord = previousState.wordSequence[previousState.currentIndex];
      
      var wordIndex = -1;
      for (var i = 0; i < self.currentWords.length; i++) {
        if (self.currentWords[i].english === previousWord.english && 
            self.currentWords[i].chinese === previousWord.chinese) {
          wordIndex = i;
          break;
        }
      }
      
      if (wordIndex !== -1) {
        self.currentIndex = wordIndex;
      } else {
        self.currentIndex = Math.min(previousState.currentIndex, self.currentWords.length - 1);
        
        if (self.currentWords.length === 0) {
          self.startNewRound();
          self.isTransitioning = false;
        return;
        }
      }
      
      self.displayCurrentWord();
      self.isTransitioning = false;
      
    }, 300);
    this.renderDifficultyLevel();
  };
  
  // å„²å­˜å°èˆªç‹€æ…‹
  FlashcardApp.prototype.saveNavigationState = function() {
    if (this.currentWords.length > 0 && this.currentIndex >= 0) {
      this.navigationHistory.push({
        currentIndex: this.currentIndex,
        wordSequence: this.currentWords.slice()
      });
      
      if (this.navigationHistory.length > 20) {
        this.navigationHistory.shift();
      }
    }
  };
  
  // ç¢ºèªé‡æ–°è¼‰å…¥å–®å­—ï¼ˆä½¿ç”¨è‡ªè¨‚å°è©±æ¡†ï¼Œé¿å…é›¢é–‹å…¨è¢å¹•ï¼‰
  FlashcardApp.prototype.confirmRestart = function() {
    var self = this;
    this.customConfirm({
      title: 'ğŸ”„ é‡æ–°è¼‰å…¥å–®å­—',
      message: 'ç¢ºå®šè¦é‡æ–°è¼‰å…¥å–®å­—å—ï¼Ÿ',
      warning: 'âš ï¸ æ³¨æ„ï¼šé‡æ–°è¼‰å…¥æœƒæ¢å¾©æ‰€æœ‰æš«æ™‚åˆªé™¤çš„å–®å­—ã€‚',
      confirmText: 'ç¢ºå®š',
      cancelText: 'å–æ¶ˆ'
    }, function() {
      self.restart();
    });
  };

  // é‡æ–°è¼‰å…¥å–®å­—
  FlashcardApp.prototype.restart = function() {
    if (this.displayTimer) {
      clearTimeout(this.displayTimer);
    }
    
    // æ¸…ç†èªéŸ³ç­‰å¾…è¨ˆæ™‚å™¨
    this.clearSpeechWait();
    
    // æ¸…ç†ä¸­æ–‡èªéŸ³ç­‰å¾…å®šæ™‚å™¨
    if (this.chineseWaitInterval) {
      clearInterval(this.chineseWaitInterval);
      this.chineseWaitInterval = null;
    }
    
    this._speechSequenceActive = false;
    this.speechSynthesis.cancel();
    this.pendingRemoval = null;
    this.closeMenu();
    
    // æª¢æŸ¥æ˜¯å¦æœ‰è¨­å®šçš„ Google Sheet
    if (this.sheetSettings.sheetId && this.sheetSettings.selectedSheets.length > 0) {
      console.log('é‡æ–°è¼‰å…¥å–®å­—ï¼Œä½¿ç”¨å·²è¨­å®šçš„ Google Sheet');
        
        // é¡¯ç¤ºè¼‰å…¥ä¸­è¨Šæ¯
      var loadingDiv = document.getElementById('loading');
      var flashcardDiv = document.getElementById('flashcard');
      if (loadingDiv) loadingDiv.style.display = 'flex';
      if (flashcardDiv) flashcardDiv.style.display = 'none';
      
      var self = this;
      this.loadWords(true, function(hasDuplicates) {
        self.hideLoading();
        self.applySettings();
        
          if (!hasDuplicates) {
          self.startNewRound();
        }
      });
    } else {
      console.log('æ²’æœ‰ Google Sheet è¨­å®šï¼Œç›´æ¥é‡æ–°é–‹å§‹');
            this.startNewRound();
          }
  };
  
  // åˆ‡æ›èªéŸ³æ’­æ”¾
  FlashcardApp.prototype.toggleVoice = function() {
    this.voiceSettings.enabled = !this.voiceSettings.enabled;
    this.saveSettings();
    this.updateVoiceButtonState();
    
    // åœæ­¢ç•¶å‰æ’­æ”¾çš„èªéŸ³
    if (!this.voiceSettings.enabled) {
      // æ¸…ç†èªéŸ³ç­‰å¾…è¨ˆæ™‚å™¨
      this.clearSpeechWait();
      
      // æ¸…ç†ä¸­æ–‡èªéŸ³ç­‰å¾…å®šæ™‚å™¨
      if (this.chineseWaitInterval) {
        clearInterval(this.chineseWaitInterval);
        this.chineseWaitInterval = null;
      }
      
      this._speechSequenceActive = false;
      this.speechSynthesis.cancel();
    }
  };
  
  // æ›´æ–°èªéŸ³æŒ‰éˆ•ç‹€æ…‹
  FlashcardApp.prototype.updateVoiceButtonState = function() {
    var voiceBtn = document.getElementById('voice-toggle-btn');
    if (voiceBtn) {
      if (this.voiceSettings.enabled) {
        voiceBtn.textContent = 'ğŸ”Š';
        voiceBtn.title = 'èªéŸ³æ’­æ”¾ï¼šé–‹å•Ÿï¼ˆé»æ“Šé—œé–‰ï¼‰';
        voiceBtn.style.opacity = '1';
      } else {
        voiceBtn.textContent = 'ğŸ”‡';
        voiceBtn.title = 'èªéŸ³æ’­æ”¾ï¼šé—œé–‰ï¼ˆé»æ“Šé–‹å•Ÿï¼‰';
        voiceBtn.style.opacity = '0.6';
      }
    }
    
    // æ›´æ–°éœéŸ³æŒ‡ç¤ºå™¨çš„é¡¯ç¤ºç‹€æ…‹
    this.updateMutedIndicator();
  };
  
  // æ›´æ–°éœéŸ³æŒ‡ç¤ºå™¨çš„é¡¯ç¤ºç‹€æ…‹
  FlashcardApp.prototype.updateMutedIndicator = function() {
    var mutedIndicator = document.getElementById('muted-indicator');
    if (mutedIndicator) {
      if (!this.voiceSettings.enabled) {
        // èªéŸ³é—œé–‰æ™‚é¡¯ç¤ºéœéŸ³æŒ‡ç¤ºå™¨
        mutedIndicator.style.display = 'flex';
      } else {
        // èªéŸ³é–‹å•Ÿæ™‚éš±è—éœéŸ³æŒ‡ç¤ºå™¨
        mutedIndicator.style.display = 'none';
      }
    }
  };
  
  // åˆ‡æ›æš«åœ/æ¢å¾©
  FlashcardApp.prototype.togglePause = function() {
    if (this.userPaused) {
      // ç”¨æˆ¶æ‰‹å‹•æ¢å¾©
      this.userPaused = false;
      this.resumeTimer();
    } else {
      // ç”¨æˆ¶æ‰‹å‹•æš«åœ
      this.userPaused = true;
      this.pauseTimer();
    }
    this.updatePauseButtonState();
  };
  
  // æª¢æ¸¬æ˜¯å¦ç‚º iOS è£ç½®ï¼ˆiPhone / iPad / iPodï¼‰
  FlashcardApp.prototype._isIOSDevice = function() {
    return /iPad|iPhone|iPod/.test(navigator.userAgent);
  };

  // é€²å…¥å…¨è¢å¹•æ¨¡å¼
  FlashcardApp.prototype.enterFullscreen = function() {
    console.log('å˜—è©¦é€²å…¥å…¨è¢å¹•æ¨¡å¼');
    
    // iOS Safari/Chrome ä¸æ”¯æ´ç¶²é å…¨è¢å¹• APIï¼ˆåƒ…æ”¯æ´ video å…ƒç´ ï¼‰
    if (this._isIOSDevice()) {
      if (window.navigator.standalone) {
        // å·²å¾ä¸»ç•«é¢é–‹å•Ÿï¼Œç­‰åŒå…¨è¢å¹•
        alert('ç›®å‰å·²æ˜¯å…¨è¢å¹•æ¨¡å¼ï¼ˆå¾ä¸»ç•«é¢é–‹å•Ÿï¼‰');
      } else {
        alert(
          'iPhone / iPad çš„ç€è¦½å™¨ä¸æ”¯æ´ç¶²é å…¨è¢å¹•ã€‚\n\n' +
          'å¦‚éœ€å…¨è¢å¹•é«”é©—ï¼Œè«‹åœ¨ Safari ä¸­ï¼š\n' +
          '1. é»é¸åº•éƒ¨ã€Œåˆ†äº«ã€æŒ‰éˆ•\n' +
          '2. é¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ã€\n' +
          '3. å¾ä¸»ç•«é¢é–‹å•Ÿæ­¤ App'
        );
      }
      return;
    }
    
    var docElement = document.documentElement;
    
    try {
      // å˜—è©¦æ¨™æº– API
      if (docElement.requestFullscreen) {
        docElement.requestFullscreen();
      }
      // å˜—è©¦ webkit å‰ç¶´ (Safari, Chrome)
      else if (docElement.webkitRequestFullscreen) {
        docElement.webkitRequestFullscreen();
      }
      // å˜—è©¦ webkit å‰ç¶´ (èˆŠç‰ˆ Safari)
      else if (docElement.webkitRequestFullScreen) {
        docElement.webkitRequestFullScreen();
      }
      // å˜—è©¦ moz å‰ç¶´ (Firefox)
      else if (docElement.mozRequestFullScreen) {
        docElement.mozRequestFullScreen();
      }
      // å˜—è©¦ ms å‰ç¶´ (IE/Edge)
      else if (docElement.msRequestFullscreen) {
        docElement.msRequestFullscreen();
      }
      else {
        console.log('æ­¤ç€è¦½å™¨ä¸æ”¯æ´å…¨è¢å¹• API');
        alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´å…¨è¢å¹•åŠŸèƒ½');
        return;
      }
      
      console.log('å…¨è¢å¹•è«‹æ±‚å·²ç™¼é€');
      
      // æ·»åŠ å…¨è¢å¹•ç‹€æ…‹ç›£è½
      var self = this;
      var fullscreenChangeHandler = function() {
        var isFullscreen = document.fullscreenElement || 
                          document.webkitFullscreenElement || 
                          document.mozFullScreenElement || 
                          document.msFullscreenElement;
        
        if (isFullscreen) {
          console.log('å·²é€²å…¥å…¨è¢å¹•æ¨¡å¼');
        } else {
          console.log('å·²é€€å‡ºå…¨è¢å¹•æ¨¡å¼');
        }
        
        // æ›´æ–°æŒ‰éˆ•æ–‡å­—
        self.updateFullscreenButtonText();
      };
      
      // ç§»é™¤èˆŠçš„ç›£è½å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      document.removeEventListener('fullscreenchange', fullscreenChangeHandler);
      document.removeEventListener('webkitfullscreenchange', fullscreenChangeHandler);
      document.removeEventListener('mozfullscreenchange', fullscreenChangeHandler);
      document.removeEventListener('MSFullscreenChange', fullscreenChangeHandler);
      
      // æ·»åŠ æ–°çš„ç›£è½å™¨
      document.addEventListener('fullscreenchange', fullscreenChangeHandler);
      document.addEventListener('webkitfullscreenchange', fullscreenChangeHandler);
      document.addEventListener('mozfullscreenchange', fullscreenChangeHandler);
      document.addEventListener('MSFullscreenChange', fullscreenChangeHandler);
      
    } catch (error) {
      console.error('é€²å…¥å…¨è¢å¹•æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
      alert('ç„¡æ³•é€²å…¥å…¨è¢å¹•æ¨¡å¼ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®š');
    }
  };
  
  // é€€å‡ºå…¨è¢å¹•æ¨¡å¼
  FlashcardApp.prototype.exitFullscreen = function() {
    console.log('å˜—è©¦é€€å‡ºå…¨è¢å¹•æ¨¡å¼');
    
    try {
      // å˜—è©¦æ¨™æº– API
      if (document.exitFullscreen) {
        document.exitFullscreen();
      }
      // å˜—è©¦ webkit å‰ç¶´ (Safari, Chrome)
      else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      }
      // å˜—è©¦ webkit å‰ç¶´ (èˆŠç‰ˆ Safari)
      else if (document.webkitCancelFullScreen) {
        document.webkitCancelFullScreen();
      }
      // å˜—è©¦ moz å‰ç¶´ (Firefox)
      else if (document.mozCancelFullScreen) {
        document.mozCancelFullScreen();
      }
      // å˜—è©¦ ms å‰ç¶´ (IE/Edge)
      else if (document.msExitFullscreen) {
        document.msExitFullscreen();
      }
      else {
        console.log('æ­¤ç€è¦½å™¨ä¸æ”¯æ´é€€å‡ºå…¨è¢å¹• API');
      }
      
      console.log('é€€å‡ºå…¨è¢å¹•è«‹æ±‚å·²ç™¼é€');
      
    } catch (error) {
      console.error('é€€å‡ºå…¨è¢å¹•æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
    }
  };
  
  // æª¢æŸ¥æ˜¯å¦ç‚ºå…¨è¢å¹•ç‹€æ…‹
  FlashcardApp.prototype.isFullscreen = function() {
    return !!(document.fullscreenElement || 
             document.webkitFullscreenElement || 
             document.mozFullScreenElement || 
             document.msFullscreenElement);
  };
  
  // åˆ‡æ›å…¨è¢å¹•ç‹€æ…‹
  FlashcardApp.prototype.toggleFullscreen = function() {
    if (this.isFullscreen()) {
      this.exitFullscreen();
    } else {
      this.enterFullscreen();
    }
  };
  
  // æ›´æ–°å…¨è¢å¹•æŒ‰éˆ•æ–‡å­—
  FlashcardApp.prototype.updateFullscreenButtonText = function() {
    var fullscreenBtn = document.getElementById('fullscreen-btn');
    if (fullscreenBtn) {
      if (this.isFullscreen()) {
        fullscreenBtn.textContent = 'é€€å‡ºå…¨è¢å¹•';
      } else {
        fullscreenBtn.textContent = 'å…¨è¢å¹•';
      }
    }
  };
  
  // æ›´æ–°æš«åœæŒ‰éˆ•ç‹€æ…‹
  FlashcardApp.prototype.updatePauseButtonState = function() {
    var pauseBtn = document.getElementById('pause-btn');
    var controlsWrapper = document.getElementById('controls-wrapper');
    var pausedIndicator = document.getElementById('paused-indicator');
    
    if (pauseBtn) {
      if (this.userPaused) {
        pauseBtn.textContent = 'â–¶ï¸';
        pauseBtn.title = 'ç›®å‰æš«åœä¸­ï¼ˆé»æ“Šæ¢å¾©ï¼‰';
        pauseBtn.style.opacity = '0.6';
        
        // é¡¯ç¤ºã€Œå·²æš«åœã€æŒ‡ç¤ºå™¨
        if (pausedIndicator) {
          pausedIndicator.style.display = 'flex';
          pausedIndicator.title = 'é»æ“Šæ­¤è™•æ¢å¾©æ’­æ”¾';
        }
      } else {
        pauseBtn.textContent = 'â¸ï¸';
        pauseBtn.title = 'ç›®å‰é‹è¡Œä¸­ï¼ˆé»æ“Šæš«åœï¼‰';
        pauseBtn.style.opacity = '1';
        
        // éš±è—ã€Œå·²æš«åœã€æŒ‡ç¤ºå™¨
        if (pausedIndicator) {
          pausedIndicator.style.display = 'none';
          pausedIndicator.title = '';
        }
      }
    }
  };

  // é‡æ–°é¡¯ç¤ºç•¶å‰å–®å­—
  FlashcardApp.prototype.redisplayCurrentWord = function() {
    if (this.displayTimer) {
      clearTimeout(this.displayTimer);
      this.displayTimer = null;
    }
    
    // æ¸…ç†èªéŸ³ç­‰å¾…è¨ˆæ™‚å™¨
    this.clearSpeechWait();
    
    // æ¸…ç†ä¸­æ–‡èªéŸ³ç­‰å¾…å®šæ™‚å™¨
    if (this.chineseWaitInterval) {
      clearInterval(this.chineseWaitInterval);
      this.chineseWaitInterval = null;
    }
    
    this._speechSequenceActive = false;
    this.speechSynthesis.cancel();
    
    this.showingChinese = false;
    this.isTransitioning = false;
    this.isProcessingClick = false;
    this.pendingRemoval = null;
    this.hideRestoreButton();
    
    this.displayCurrentWord();
  };
  
  // èªéŸ³è¨­å®šç›¸é—œ
  FlashcardApp.prototype.openVoiceSettings = function() {
    var modal = document.getElementById('voice-settings-modal');
    if (modal) {
      modal.style.display = 'flex';
      this.pauseTimer();
      
      var speechEnabledSetting = document.getElementById('speech-enabled-setting');
      var voiceRateSetting = document.getElementById('voice-rate-setting');
      var voiceRateValue = document.getElementById('voice-rate-value');
      var spellOutLettersSetting = document.getElementById('spell-out-letters-setting');
      var chineseSpeechEnabledSetting = document.getElementById('chinese-speech-enabled-setting');
      
      if (speechEnabledSetting) speechEnabledSetting.checked = this.voiceSettings.enabled;
      if (voiceRateSetting) voiceRateSetting.value = this.voiceSettings.rate;
      if (voiceRateValue) {
        // ä¿®å¾©æµ®é»æ•¸ç²¾åº¦å•é¡Œ
        var step = parseFloat(voiceRateSetting.step) || 0.1;
        var decimalPlaces = step.toString().indexOf('.') !== -1 ? step.toString().split('.')[1].length : 0;
        var formattedRate = parseFloat(this.voiceSettings.rate.toFixed(decimalPlaces));
        voiceRateValue.textContent = formattedRate;
      }
      if (spellOutLettersSetting) spellOutLettersSetting.checked = this.voiceSettings.spellOutLetters || false;
      if (chineseSpeechEnabledSetting) chineseSpeechEnabledSetting.checked = this.voiceSettings.chineseEnabled || false;
      
      var delaySpeechToggle = document.getElementById('delay-speech-setting');
      if (delaySpeechToggle) delaySpeechToggle.checked = this.settings.delaySpeechInNormalMode;
      
      this.populateVoiceSelect();
    }
  };
  
  FlashcardApp.prototype.closeVoiceSettings = function() {
    var modal = document.getElementById('voice-settings-modal');
    if (modal) {
      modal.style.display = 'none';
      this.resumeTimer();
    }
  };
  
  // é è¦½èªéŸ³ - æ’­æ”¾ç¤ºä¾‹æ–‡å­—
  FlashcardApp.prototype.previewVoice = function(voiceURI, sampleText) {
    try {
      // æª¢æŸ¥èªéŸ³åˆæˆAPIæ˜¯å¦å¯ç”¨
      if (!this.speechSynthesis) {
        console.warn('èªéŸ³åˆæˆAPIä¸å¯ç”¨');
        return;
      }
      
      // æ¸…ç†ä¸­æ–‡èªéŸ³ç­‰å¾…å®šæ™‚å™¨
      if (this.chineseWaitInterval) {
        clearInterval(this.chineseWaitInterval);
        this.chineseWaitInterval = null;
      }
      
      // åœæ­¢ç•¶å‰æ­£åœ¨æ’­æ”¾çš„èªéŸ³
      this.speechSynthesis.cancel();
      
      // ç²å–ç•¶å‰è¨­å®šçš„èªéŸ³é€Ÿåº¦
      var voiceRateSetting = document.getElementById('voice-rate-setting');
      var rate = voiceRateSetting ? parseFloat(voiceRateSetting.value) : this.voiceSettings.rate;
      
      console.log('é è¦½èªéŸ³:', voiceURI, 'ç¤ºä¾‹æ–‡å­—:', sampleText, 'é€Ÿåº¦:', rate);
      
      // å‰µå»ºèªéŸ³utterance
      var utterance = new SpeechSynthesisUtterance(sampleText);
      utterance.rate = rate;
      utterance.pitch = this.voiceSettings.pitch || 1;
      utterance.volume = this.voiceSettings.volume || 1;
      
      // å°‹æ‰¾æŒ‡å®šçš„èªéŸ³
      var voices = this.speechSynthesis.getVoices();
      var selectedVoice = null;
      
      for (var i = 0; i < voices.length; i++) {
        if (voices[i].voiceURI === voiceURI) {
          selectedVoice = voices[i];
          break;
        }
      }
      
      if (selectedVoice) {
        utterance.voice = selectedVoice;
        utterance.lang = selectedVoice.lang;
        console.log('ä½¿ç”¨èªéŸ³:', selectedVoice.name, 'èªè¨€:', selectedVoice.lang);
      } else {
        console.warn('æ‰¾ä¸åˆ°æŒ‡å®šçš„èªéŸ³:', voiceURI);
      }
      
      // æ’­æ”¾èªéŸ³
      this.speechSynthesis.speak(utterance);
      
      // æ·»åŠ éŒ¯èª¤è™•ç†
      utterance.onerror = function(event) {
        console.error('èªéŸ³æ’­æ”¾éŒ¯èª¤:', event.error);
      };
      
    } catch (error) {
      console.error('é è¦½èªéŸ³æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
    }
  };
  
  FlashcardApp.prototype.saveVoiceSettingsAndClose = function() {
    var speechEnabledSetting = document.getElementById('speech-enabled-setting');
    var voiceRateSetting = document.getElementById('voice-rate-setting');
    var voiceSelectSetting = document.getElementById('voice-select-setting');
    var japaneseVoiceSelectSetting = document.getElementById('japanese-voice-select-setting');
    var spellOutLettersSetting = document.getElementById('spell-out-letters-setting');
    var chineseSpeechEnabledSetting = document.getElementById('chinese-speech-enabled-setting');
    var chineseVoiceSelectSetting = document.getElementById('chinese-voice-select-setting');
    var delaySpeechToggle = document.getElementById('delay-speech-setting');
    
    if (speechEnabledSetting) this.voiceSettings.enabled = speechEnabledSetting.checked;
    if (voiceRateSetting) this.voiceSettings.rate = parseFloat(voiceRateSetting.value);
    if (spellOutLettersSetting) this.voiceSettings.spellOutLetters = spellOutLettersSetting.checked;
    if (chineseSpeechEnabledSetting) this.voiceSettings.chineseEnabled = chineseSpeechEnabledSetting.checked;
    if (delaySpeechToggle) this.settings.delaySpeechInNormalMode = delaySpeechToggle.checked;
    
    if (voiceSelectSetting) {
      var selectedVoiceURI = voiceSelectSetting.value;
      this.voiceSettings.voiceURI = selectedVoiceURI;
      var voices = this.speechSynthesis.getVoices();
      for (var i = 0; i < voices.length; i++) {
        if (voices[i].voiceURI === selectedVoiceURI) {
          this.voiceSettings.lang = voices[i].lang;
          break;
        }
      }
    }
    
    if (japaneseVoiceSelectSetting) {
      var selectedJapaneseVoiceURI = japaneseVoiceSelectSetting.value;
      this.voiceSettings.japaneseVoiceURI = selectedJapaneseVoiceURI;
      var voices = this.speechSynthesis.getVoices();
      for (var i = 0; i < voices.length; i++) {
        if (voices[i].voiceURI === selectedJapaneseVoiceURI) {
          this.voiceSettings.japaneseLang = voices[i].lang;
          break;
        }
      }
    }
    
    if (chineseVoiceSelectSetting) {
      var selectedChineseVoiceURI = chineseVoiceSelectSetting.value;
      this.voiceSettings.chineseVoiceURI = selectedChineseVoiceURI;
      var voices = this.speechSynthesis.getVoices();
      for (var i = 0; i < voices.length; i++) {
        if (voices[i].voiceURI === selectedChineseVoiceURI) {
          this.voiceSettings.chineseLang = voices[i].lang;
          break;
        }
      }
    }
    
    this.saveSettings();
    this.updateVoiceButtonState();
    this.closeVoiceSettings();
  };
  
  FlashcardApp.prototype.populateVoiceSelect = function() {
    var voiceSelect = document.getElementById('voice-select-setting');
    var japaneseVoiceSelect = document.getElementById('japanese-voice-select-setting');
    var voices = this.speechSynthesis.getVoices();
    var self = this;
    
    // å¡«å……è‹±æ–‡èªéŸ³é¸é …
    if (voiceSelect) {
      // ä¿è­·selectå…ƒç´ 
      this.protectSelectElement(voiceSelect);
      
      voiceSelect.innerHTML = '';
      var englishVoices = voices.filter(function(v) { 
        return v.lang && v.lang.indexOf('en') === 0; 
      });
      
      for (var i = 0; i < englishVoices.length; i++) {
        var voice = englishVoices[i];
        var option = document.createElement('option');
        option.value = voice.voiceURI;
        option.textContent = voice.name + ' (' + voice.lang + ')';
        if (voice.voiceURI === this.voiceSettings.voiceURI) {
          option.selected = true;
        }
        voiceSelect.appendChild(option);
      }
      
      if (!voiceSelect.value && englishVoices.length > 0) {
        voiceSelect.value = englishVoices[0].voiceURI;
      }
      
      // æ·»åŠ changeäº‹ä»¶ç›£è½å™¨ - åˆ‡æ›æ™‚æ’­æ”¾ç¤ºä¾‹èªéŸ³
      voiceSelect.addEventListener('change', function() {
        var selectedVoiceURI = voiceSelect.value;
        self.previewVoice(selectedVoiceURI, 'Hello, this is a sample voice for English pronunciation.');
      });
    }
    
    // å¡«å……æ—¥æ–‡èªéŸ³é¸é …
    if (japaneseVoiceSelect) {
      // ä¿è­·selectå…ƒç´ 
      this.protectSelectElement(japaneseVoiceSelect);
      
      japaneseVoiceSelect.innerHTML = '';
      var japaneseVoices = voices.filter(function(v) { 
        return v.lang && v.lang.indexOf('ja') === 0; 
      });
      
      for (var i = 0; i < japaneseVoices.length; i++) {
        var voice = japaneseVoices[i];
        var option = document.createElement('option');
        option.value = voice.voiceURI;
        option.textContent = voice.name + ' (' + voice.lang + ')';
        if (voice.voiceURI === this.voiceSettings.japaneseVoiceURI) {
          option.selected = true;
        }
        japaneseVoiceSelect.appendChild(option);
      }
      
      if (!japaneseVoiceSelect.value && japaneseVoices.length > 0) {
        japaneseVoiceSelect.value = japaneseVoices[0].voiceURI;
      }
      
      // æ·»åŠ changeäº‹ä»¶ç›£è½å™¨ - åˆ‡æ›æ™‚æ’­æ”¾ç¤ºä¾‹èªéŸ³
      japaneseVoiceSelect.addEventListener('change', function() {
        var selectedVoiceURI = japaneseVoiceSelect.value;
        self.previewVoice(selectedVoiceURI, 'ã“ã‚“ã«ã¡ã¯ã€ã“ã‚Œã¯æ—¥æœ¬èªã®éŸ³å£°ã‚µãƒ³ãƒ—ãƒ«ã§ã™ã€‚');
      });
    }
    
    // å¡«å……ä¸­æ–‡èªéŸ³é¸é …
    var chineseVoiceSelect = document.getElementById('chinese-voice-select-setting');
    if (chineseVoiceSelect) {
      // ä¿è­·selectå…ƒç´ 
      this.protectSelectElement(chineseVoiceSelect);
      
      chineseVoiceSelect.innerHTML = '';
      var chineseVoices = voices.filter(function(v) { 
        return v.lang && (v.lang.indexOf('zh') === 0 || v.lang.indexOf('cmn') === 0 || v.lang.indexOf('yue') === 0); 
      });
      
      for (var i = 0; i < chineseVoices.length; i++) {
        var voice = chineseVoices[i];
        var option = document.createElement('option');
        option.value = voice.voiceURI;
        option.textContent = voice.name + ' (' + voice.lang + ')';
        if (voice.voiceURI === this.voiceSettings.chineseVoiceURI) {
          option.selected = true;
        }
        chineseVoiceSelect.appendChild(option);
      }
      
      if (!chineseVoiceSelect.value && chineseVoices.length > 0) {
        chineseVoiceSelect.value = chineseVoices[0].voiceURI;
      }
      
      // æ·»åŠ changeäº‹ä»¶ç›£è½å™¨ - åˆ‡æ›æ™‚æ’­æ”¾ç¤ºä¾‹èªéŸ³
      chineseVoiceSelect.addEventListener('change', function() {
        var selectedVoiceURI = chineseVoiceSelect.value;
        self.previewVoice(selectedVoiceURI, 'ä½ å¥½ï¼Œé€™æ˜¯ä¸­æ–‡èªéŸ³ç¯„ä¾‹ã€‚');
      });
    }
  };
</script>

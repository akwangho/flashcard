<!-- script-srs.html -->
<script>
  /**
   * @module script-srs
   * @description 間隔重複系統 (Spaced Repetition System - Leitner Box)：
   *   Box 等級管理、複習間隔計算、到期單字判定、優先度排序、
   *   快速複習模態框。
   *
   * @dependencies script-core.html (FlashcardApp, APP_CONSTANTS, formatDateYYYYMMDD, closeModalById)
   * @provides FlashcardApp.prototype: getBoxInterval, getInitialBox,
   *   loadSrsData, saveSrsData, getSrsForWord, updateSrsData,
   *   getDueWords, getDueWordCount, getRecommendedWords, startSrsReview,
   *   openSrsReviewModal, renderSrsCountOptions, closeSrsReviewModal,
   *   updateSrsBadge
   */

  // ==========================================================================
  // 間隔重複系統 (Spaced Repetition System - Leitner Box)
  // ==========================================================================

  // Box 等級對應的複習間隔天數
  FlashcardApp.prototype.getBoxInterval = function(box) {
    return APP_CONSTANTS.SRS_BOX_INTERVALS[box] || 1;
  };

  // 根據難度決定初始 Box 等級
  FlashcardApp.prototype.getInitialBox = function(difficulty) {
    if (difficulty === -1) return 5;  // 非常熟
    if (difficulty === 0) return 3;   // 無標記
    if (difficulty >= 1 && difficulty <= 3) return 2; // 略不熟
    return 1; // difficulty >= 4，很不熟
  };

  // 從 localStorage 載入 SRS 資料
  FlashcardApp.prototype.loadSrsData = function() {
    try {
      var data = localStorage.getItem(APP_CONSTANTS.STORAGE_KEYS.SRS);
      this.srsData = data ? JSON.parse(data) : {};
    } catch (e) {
      this.srsData = {};
    }
  };

  // 將 SRS 資料儲存到 localStorage
  FlashcardApp.prototype.saveSrsData = function() {
    try {
      localStorage.setItem(APP_CONSTANTS.STORAGE_KEYS.SRS, JSON.stringify(this.srsData));
    } catch (e) {
      console.error('SRS 資料儲存失敗:', e);
    }
  };

  // 取得單字的 SRS 資料
  FlashcardApp.prototype.getSrsForWord = function(word) {
    if (!word || !word.sheetName) return null;
    var key = word.sheetName + ':' + word.originalRowIndex;
    return this.srsData[key] || null;
  };

  // 更新單字的 SRS 資料（複習後呼叫）
  FlashcardApp.prototype.updateSrsData = function(word) {
    if (!word || !word.sheetName || word.sheetName === 'Demo') return;

    var key = word.sheetName + ':' + word.originalRowIndex;
    var entry = this.srsData[key];
    var difficulty = (word.difficultyLevel !== undefined && word.difficultyLevel !== null) ? word.difficultyLevel : 0;

    if (!entry) {
      // 首次進入 SRS：根據難度決定初始 Box
      entry = { box: this.getInitialBox(difficulty) };
    } else {
      // 根據難度調整 Box
      if (difficulty === -1 || difficulty <= 2) {
        // 熟悉：Box 上升（最高 SRS_MAX_BOX）
        entry.box = Math.min(APP_CONSTANTS.SRS_MAX_BOX, (entry.box || 1) + 1);
      } else if (difficulty >= 6) {
        // 很不熟：回到 Box 1
        entry.box = 1;
      }
      // difficulty 3-5：Box 不變
    }

    // 計算下次複習日期
    var today = new Date();
    var interval = this.getBoxInterval(entry.box);
    var nextDate = new Date(today.getTime() + interval * 24 * 60 * 60 * 1000);
    entry.nextReview = formatDateYYYYMMDD(nextDate);

    this.srsData[key] = entry;
    this.saveSrsData();
  };

  // 取得所有今天到期/逾期需要複習的單字
  FlashcardApp.prototype.getDueWords = function() {
    var today = this.getTodayDateString();
    var dueWords = [];

    for (var i = 0; i < this.words.length; i++) {
      var word = this.words[i];
      var srs = this.getSrsForWord(word);

      if (!srs) {
        // 從未進入 SRS 系統的單字，視為需要複習
        dueWords.push(word);
      } else if (srs.nextReview <= today) {
        // 已到複習日期
        dueWords.push(word);
      }
    }

    return dueWords;
  };

  // 取得需要複習的單字數量
  FlashcardApp.prototype.getDueWordCount = function() {
    return this.getDueWords().length;
  };

  // ★ 快速複習：取得依優先度排序的建議複習單字
  // 總是從已載入的單字中列出最建議複習的單字，不會出現「沒有單字」的情況
  // 優先度：(1) 已到期/逾期 (2) 從未複習 (3) 尚未到期但最接近的
  FlashcardApp.prototype.getRecommendedWords = function() {
    var today = this.getTodayDateString();
    var self = this;
    var wordsWithPriority = [];

    for (var i = 0; i < this.words.length; i++) {
      var word = this.words[i];
      var srs = this.getSrsForWord(word);
      var priority;
      var sortKey;

      if (!srs) {
        // 從未進入 SRS 系統：高優先（類別 1），依難度排序（越不熟越前面）
        var diff = (word.difficultyLevel !== undefined && word.difficultyLevel !== null) ? word.difficultyLevel : 0;
        // difficulty -1 = 非常熟，排最後；0~10 越高越不熟
        priority = 1;
        sortKey = (diff === -1) ? -1 : diff; // 越高越優先
        wordsWithPriority.push({ word: word, priority: priority, sortKey: sortKey, nextReview: '' });
      } else if (srs.nextReview <= today) {
        // 已到期/逾期：最高優先（類別 0），依逾期天數 + box 等級排序
        priority = 0;
        // sortKey: 逾期越久越優先，box 越低越優先
        sortKey = -(srs.box || 1); // box 越低 sortKey 越小（負值越大 = 越優先）
        wordsWithPriority.push({ word: word, priority: priority, sortKey: sortKey, nextReview: srs.nextReview });
      } else {
        // 尚未到期：低優先（類別 2），依最近到期日排序
        priority = 2;
        sortKey = 0;
        wordsWithPriority.push({ word: word, priority: priority, sortKey: sortKey, nextReview: srs.nextReview });
      }
    }

    // 排序：priority 小的在前 → sortKey 大的在前 → nextReview 早的在前
    wordsWithPriority.sort(function(a, b) {
      // 1. 優先類別：0（已到期）> 1（未複習）> 2（未到期）
      if (a.priority !== b.priority) return a.priority - b.priority;
      // 2. 同類別內排序
      if (a.priority === 0) {
        // 已到期：nextReview 越早（越逾期）越優先，box 越低越優先
        if (a.nextReview !== b.nextReview) return a.nextReview < b.nextReview ? -1 : 1;
        return a.sortKey - b.sortKey; // box 越低（sortKey 越負）越前
      }
      if (a.priority === 1) {
        // 未複習：difficulty 越高越優先
        return b.sortKey - a.sortKey;
      }
      // 未到期：nextReview 越早越優先
      if (a.nextReview !== b.nextReview) return a.nextReview < b.nextReview ? -1 : 1;
      return 0;
    });

    var result = [];
    for (var j = 0; j < wordsWithPriority.length; j++) {
      result.push(wordsWithPriority[j].word);
    }
    return result;
  };

  // 開始快速複習模式（依優先度排序，取前 N 個）
  FlashcardApp.prototype.startSrsReview = function(count) {
    var recommendedWords = this.getRecommendedWords();

    if (recommendedWords.length === 0) {
      this.showNotification('沒有可複習的單字', 'info');
      return;
    }

    // 取指定數量（已依優先度排序，直接取前 N 個）
    var reviewCount = Math.min(count, recommendedWords.length);
    this.currentWords = recommendedWords.slice(0, reviewCount);
    this.currentIndex = 0;
    this.srsReviewActive = true;

    this.updateActiveFilterDisplay();
    this.displayCurrentWord();
    this.updateProgress();
    this.updateSrsBadge();

    this.closeSrsReviewModal();
    this.showNotification('開始複習 ' + reviewCount + ' 個單字', 'success');
    console.log('快速複習模式啟動，共', reviewCount, '個單字');
  };

  // 開啟快速複習模態框
  FlashcardApp.prototype.openSrsReviewModal = function() {
    var totalWords = this.words ? this.words.length : 0;
    var dueCount = this.getDueWordCount();
    var modal = document.getElementById('srs-review-modal');
    var countEl = document.getElementById('srs-due-count');
    var optionsEl = document.getElementById('srs-count-options');
    var noDueEl = document.getElementById('srs-no-due');
    var startBtn = document.getElementById('srs-start-btn');

    if (!modal) return;

    // 暫停計時器
    this._clearDisplayTimer();

    if (totalWords === 0) {
      // 沒有載入任何單字
      if (countEl) countEl.style.display = 'none';
      if (optionsEl) optionsEl.style.display = 'none';
      if (startBtn) startBtn.style.display = 'none';
      if (noDueEl) noDueEl.style.display = 'block';
    } else {
      // 總是顯示可複習的單字（依優先度排序）
      if (noDueEl) noDueEl.style.display = 'none';
      if (countEl) {
        countEl.style.display = 'block';
        if (dueCount > 0) {
          countEl.textContent = '共 ' + totalWords + ' 個單字，其中 ' + dueCount + ' 個建議優先複習';
        } else {
          countEl.textContent = '共 ' + totalWords + ' 個單字，依複習優先度排列';
        }
      }
      if (optionsEl) optionsEl.style.display = 'block';
      if (startBtn) startBtn.style.display = 'block';

      // 更新數量選項（使用全部單字數量）
      this.renderSrsCountOptions(totalWords);
    }

    modal.style.display = 'flex';
  };

  // 渲染 SRS 數量選項
  FlashcardApp.prototype.renderSrsCountOptions = function(dueCount) {
    var container = document.getElementById('srs-count-buttons');
    if (!container) return;

    container.innerHTML = '';
    var counts = APP_CONSTANTS.SRS_COUNT_OPTIONS;
    var self = this;
    var selectedCount = null;

    for (var i = 0; i < counts.length; i++) {
      if (counts[i] > dueCount) continue;
      (function(c) {
        var btn = document.createElement('button');
        btn.className = 'srs-count-btn';
        btn.textContent = c;
        btn.setAttribute('data-count', c);
        btn.onclick = function() {
          // 清除其他選中狀態
          var allBtns = container.querySelectorAll('.srs-count-btn');
          for (var j = 0; j < allBtns.length; j++) {
            allBtns[j].classList.remove('selected');
          }
          btn.classList.add('selected');
          self._srsSelectedCount = c;
        };
        container.appendChild(btn);
      })(counts[i]);
    }

    // 如果總數不在預設選項中且 <= 100，加入「全部」按鈕
    if (dueCount <= 100) {
      var allBtn = document.createElement('button');
      allBtn.className = 'srs-count-btn';
      allBtn.textContent = '全部 (' + dueCount + ')';
      allBtn.setAttribute('data-count', dueCount);
      allBtn.onclick = function() {
        var allBtns = container.querySelectorAll('.srs-count-btn');
        for (var j = 0; j < allBtns.length; j++) {
          allBtns[j].classList.remove('selected');
        }
        allBtn.classList.add('selected');
        self._srsSelectedCount = dueCount;
      };
      container.appendChild(allBtn);
    }

    // 預設選取第一個選項
    var firstBtn = container.querySelector('.srs-count-btn');
    if (firstBtn) {
      firstBtn.classList.add('selected');
      this._srsSelectedCount = parseInt(firstBtn.getAttribute('data-count'), 10);
    }
  };

  // 關閉 SRS 複習模態框
  FlashcardApp.prototype.closeSrsReviewModal = function() {
    closeModalById(this, 'srs-review-modal');
  };

  // 更新 SRS 徽章（顯示待複習數量）
  FlashcardApp.prototype.updateSrsBadge = function() {
    var badge = document.getElementById('srs-due-badge');
    if (!badge) return;

    var count = this.getDueWordCount();
    if (count > 0) {
      badge.textContent = count > 99 ? '99+' : count;
      badge.style.display = 'inline-block';
    } else {
      badge.style.display = 'none';
    }
  };

</script>

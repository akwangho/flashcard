<!-- script-display.html -->
<script>
  /**
   * @module script-display
   * @description 顯示與互動模組：設定開啟/關閉/儲存/重置、暫停/恢復計時器、
   *   Sheet 設定 UI、不熟程度增減與同步、單字點擊（暫時刪除）、
   *   D 鍵雙按確認標記非常熟、進度條動畫、圖片預加載、滑桿增強。
   *
   * @dependencies script-core.html (FlashcardApp, APP_CONSTANTS)
   * @provides FlashcardApp.prototype: openSettings, closeSettings,
   *   saveSettingsAndClose, pauseTimer, resumeTimer, increaseDifficulty,
   *   onWordClick, confirmRemoval, cancelRemoval, showSecondPartAndScheduleNext,
   *   handleMarkVeryFamiliar, startProgressBar, enhanceSliderInteraction ...
   */

  // 開啟設定
  FlashcardApp.prototype.openSettings = function() {
    var modal = openModalById(this, 'settings-modal');
    if (modal) {
      this.applySettings();
    }
  };
  
  // 關閉設定
  FlashcardApp.prototype.closeSettings = function(shouldRedisplay) {
    closeModalById(this, 'settings-modal');
    if (shouldRedisplay) {
      this.redisplayCurrentWord();
    }
  };
  
  // 儲存設定並關閉
  FlashcardApp.prototype.saveSettingsAndClose = function() {
    var delaySlider = document.getElementById('delay-setting');
    var fontSizeSlider = document.getElementById('font-size-setting');
    var fontFamilySelect = document.getElementById('font-family-setting');
    
    var oldDisplayMode = this.settings.displayMode;
    var oldFontFamily = this.settings.fontFamily;
    
    if (delaySlider) this.settings.delayTime = parseFloat(delaySlider.value);
    if (fontSizeSlider) this.settings.fontSize = parseInt(fontSizeSlider.value);
    if (fontFamilySelect) this.settings.fontFamily = fontFamilySelect.value;
    
    // 讀取顯示模式 radio buttons
    var selectedMode = document.querySelector('input[name="display-mode"]:checked');
    if (selectedMode) this.settings.displayMode = selectedMode.value;
    
    // 讀取要會拼強制先中文開關
    var mustSpellChineseFirstToggle = document.getElementById('must-spell-chinese-first-setting');
    if (mustSpellChineseFirstToggle) this.settings.mustSpellChineseFirst = mustSpellChineseFirstToggle.checked;
    
    // 讀取智慧計時開關
    var smartTimerToggle = document.getElementById('smart-timer-setting');
    if (smartTimerToggle) this.settings.smartTimerEnabled = smartTimerToggle.checked;
    
    // 讀取計時進度條開關
    var showTimerToggle = document.getElementById('show-timer-progress-setting');
    if (showTimerToggle) this.settings.showTimerProgressBar = showTimerToggle.checked;
    
    // 讀取計時進度條偏移量
    var timerOffsetInput = document.getElementById('timer-offset-setting');
    if (timerOffsetInput) this.settings.timerProgressBarOffset = parseInt(timerOffsetInput.value, 10) || 0;
    
    this.saveSettings();
    this.applySettings();
    this.closeSettings();
    
    // 如果顯示模式或字型改變，重新顯示當前單字
    if (oldDisplayMode !== this.settings.displayMode || oldFontFamily !== this.settings.fontFamily) {
      this.redisplayCurrentWord();
    }
  };
  
  // 重置設定
  FlashcardApp.prototype.resetSettings = function() {
    this.settings = {
      delayTime: 3,
      fontSize: 96,
      displayMode: 'english-first',
      fontFamily: 'system-default',
      delaySpeechInNormalMode: false,
      mustSpellChineseFirst: true,
      showTimerProgressBar: true,
      timerProgressBarOffset: 0,
      smartTimerEnabled: false
    };
    this.voiceSettings = {
      enabled: true,
      rate: 0.8,
      pitch: 1,
      volume: 1,
      lang: 'en-US',
      voiceURI: '',
      japaneseLang: 'ja-JP',
      japaneseVoiceURI: '',
      spellOutLetters: false,
      chineseEnabled: false,
      chineseLang: 'zh-TW',
      chineseVoiceURI: ''
    };
    this.applySettings();
      this.saveSettings();
    this.closeSettings();
  };
  
  // 暫停計時器
  FlashcardApp.prototype.pauseTimer = function() {
    this.isPaused = true;
    
    // 在清除計時器前，計算剩餘時間（用於恢復時精確還原進度）
    if (this._activeTimerInfo) {
      var elapsed = Date.now() - this._activeTimerInfo.setAt;
      this._pauseRemainingMs = Math.max(0, this._activeTimerInfo.delay - elapsed);
    } else {
      this._pauseRemainingMs = 0;
    }
    
    this._clearDisplayTimer();
    
    // 清理語音等待計時器
    this.clearSpeechWait();
    
    // 暫停進度條
    this.pauseProgressBar();

  };
  
  // 恢復計時器
  FlashcardApp.prototype.resumeTimer = function() {
    // 只有在用戶沒有手動暫停的情況下才恢復計時器
    if (!this.userPaused) {
      this.isPaused = false;
    }
    
    var self = this;
    if (!this.isPaused) {
      // 使用暫停時記錄的剩餘時間，確保計時器與進度條精確同步
      var remainingMs = this._pauseRemainingMs;
      
      if (this.showingChinese) {
        if (!remainingMs || remainingMs <= 0) {
          remainingMs = this.getPhase2Delay() * 1000;
        }
        this._setDisplayTimer(function() {
          self.waitForSpeechThenExecute(function() {
            self.nextWord();
          });
        }, remainingMs);
        // 恢復進度條（第二階段：使用剩餘時間）
        this._progressPhase = 2;
        this.resumeProgressBar(remainingMs / 1000);
      } else if (!this.isTransitioning && !this.isProcessingClick) {
        var currentWord = this.currentWords[this.currentIndex];
        if (currentWord) {
          if (!remainingMs || remainingMs <= 0) {
            remainingMs = this.settings.delayTime * 1000;
          }
          this._setDisplayTimer(function() {
            self.waitForSpeechThenExecute(function() {
              self.showSecondPartAndScheduleNext();
            });
          }, remainingMs);
          // 恢復進度條（第一階段：使用剩餘時間）
          this._progressPhase = 1;
          this.resumeProgressBar(remainingMs / 1000);
        }
      }
      
      this._pauseRemainingMs = 0;
    }
    
    // 更新UI狀態
    this.updatePauseButtonState();
  };
  
  // 開啟Google Sheet設定
  FlashcardApp.prototype.openSheetSettings = function() {
    console.log('開啟 Google Sheet 設定畫面');
    var modal = openModalById(this, 'sheet-settings-modal');
    if (modal) {
      
      // 還原所有區塊的可見性（上次選擇預設檔後可能被隱藏）
      var showIds = ['default-sheets-group', 'recent-sheets-group', 'sheet-id-group', 'load-sheets-group'];
      for (var i = 0; i < showIds.length; i++) {
        var el = document.getElementById(showIds[i]);
        if (el) el.style.display = '';
      }
      
      var sheetIdInput = document.getElementById('sheet-id-input');
      if (sheetIdInput) {
        sheetIdInput.value = this.sheetSettings.sheetId || '';
      }
      
      var sheetsGroup = document.getElementById('sheets-selection-group');
      if (sheetsGroup) {
        sheetsGroup.style.display = 'none';
      }
      
      var saveBtn = document.getElementById('save-sheet-settings');
      if (saveBtn) {
        saveBtn.disabled = true;
      }
      
      // 顯示歷史記錄
      this.displaySheetHistory();
    }
  };
  
  // 關閉Google Sheet設定
  FlashcardApp.prototype.closeSheetSettings = function() {
    closeModalById(this, 'sheet-settings-modal');
  };
  
  // 增加不熟程度（+1，最高10；-1 → 0）
  FlashcardApp.prototype.increaseDifficulty = function() {
    if (this.currentWords.length === 0) return;
    
    var currentWord = this.currentWords[this.currentIndex];
    if (!currentWord) return;
    
    // 增加不熟程度（-1 → 0, 0 → 1, ..., 9 → 10）
    var currentLevel = (currentWord.difficultyLevel !== undefined && currentWord.difficultyLevel !== null) ? currentWord.difficultyLevel : 0;
    var newLevel = Math.min(10, currentLevel + 1);
    currentWord.difficultyLevel = newLevel;
    
    // 同步到 words 主陣列
    var mainWord = this.words.find(function(w) { return w.id === currentWord.id; });
    if (mainWord) mainWord.difficultyLevel = newLevel;
    
    // 後端同步
    this.syncDifficultyToBackend(currentWord);
    
    // 更新 SRS 資料
    this.updateSrsData(currentWord);
    
    this.renderDifficultyLevel();
    console.log('增加不熟程度:', currentWord.english, '→ ★' + newLevel);
  };

  // 減少不熟程度（-1，最低0）
  FlashcardApp.prototype.decreaseDifficulty = function(word) {
    if (!word) return;
    
    var newLevel = Math.max(0, (word.difficultyLevel || 0) - 1);
    word.difficultyLevel = newLevel;
    
    // 同步到 words 主陣列
    var mainWord = this.words.find(function(w) { return w.id === word.id; });
    if (mainWord) mainWord.difficultyLevel = newLevel;
    
    // 後端同步
    this.syncDifficultyToBackend(word);
    
    // 更新 SRS 資料
    this.updateSrsData(word);
    
    console.log('減少不熟程度:', word.english, '→ ★' + newLevel);
  };

  // 同步不熟程度到後端
  FlashcardApp.prototype.syncDifficultyToBackend = function(word) {
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      var rowIndex = word.originalRowIndex;
      if (rowIndex !== undefined && rowIndex !== -1) {
        var sheetId = this.sheetSettings.sheetId;
        var sheetName = word.sheetName || 'Sheet1';
        google.script.run.updateWordDifficulty(sheetId, sheetName, rowIndex, word.difficultyLevel);
      }
    }
  };

  // 向後兼容：toggleDifficultCurrentWord
  FlashcardApp.prototype.toggleDifficultCurrentWord = function() {
    this.increaseDifficulty();
  };
  
  // 渲染不熟程度顯示
  FlashcardApp.prototype.renderDifficultyLevel = function() {
    var currentWord = this.currentWords[this.currentIndex];
    var display = document.getElementById('difficulty-display');
    var levelEl = document.getElementById('difficulty-level');
    
    if (!display || !levelEl) return;
    
    var level = (currentWord && currentWord.difficultyLevel !== undefined && currentWord.difficultyLevel !== null) ? currentWord.difficultyLevel : 0;
    
    // -1 顯示為 ✓ 符號，其他顯示數字
    if (level === -1) {
      levelEl.textContent = '✓';
    } else {
      levelEl.textContent = level;
    }
    
    // 移除所有等級 class（包含 n1 代表 -1）
    display.className = display.className.replace('difficulty-level-n1', '').trim();
    for (var i = 0; i <= 10; i++) {
      display.className = display.className.replace('difficulty-level-' + i, '').trim();
    }
    display.className = display.className.replace(/\s+/g, ' ').trim();
    display.classList.add('difficulty-display');
    var cls = level === -1 ? 'difficulty-level-n1' : 'difficulty-level-' + level;
    display.classList.add(cls);
  };

  // 渲染「要會拼」指示器
  FlashcardApp.prototype.renderMustSpellIndicator = function() {
    var indicator = document.getElementById('must-spell-indicator');
    if (!indicator) return;
    
    var currentWord = this.currentWords[this.currentIndex];
    if (currentWord && currentWord.mustSpell) {
      indicator.style.display = 'inline-block';
    } else {
      indicator.style.display = 'none';
    }
  };

  // 判斷當前單字是否以反向模式顯示（先中文後英文）
  FlashcardApp.prototype.isReversedForCurrentWord = function() {
    if (this.settings.displayMode === 'chinese-first') return true;
    if (this.settings.displayMode === 'mixed') return this.currentWordReversed;
    return false; // 'english-first'
  };

  // 計算 Phase 2（翻譯顯示後）的智慧延遲秒數
  // 僅在智慧計時啟用且第二語言為中文時生效，否則回傳原始 delayTime
  FlashcardApp.prototype.getPhase2Delay = function() {
    if (!this.settings.smartTimerEnabled) {
      return this.settings.delayTime;
    }

    // 反向模式（第二語言為英文）不適用智慧計時
    if (this.isReversedForCurrentWord()) {
      return this.settings.delayTime;
    }

    var currentWord = this.currentWords[this.currentIndex];
    if (!currentWord || !currentWord.chinese) {
      return this.settings.delayTime;
    }

    var charCount = currentWord.chinese.length;
    var baseTime = APP_CONSTANTS.SMART_TIMER_BASE_TIME;
    var perCharTime = APP_CONSTANTS.SMART_TIMER_PER_CHAR_TIME;
    var minTime = APP_CONSTANTS.SMART_TIMER_MIN_TIME;

    var smartDelay = Math.max(minTime, baseTime + charCount * perCharTime);
    return Math.min(smartDelay, this.settings.delayTime);
  };
    
  // 渲染不熟程度預覽（暫時刪除時立即顯示減少後的數字）
  FlashcardApp.prototype.renderDifficultyLevelPreview = function(level) {
    var display = document.getElementById('difficulty-display');
    var levelEl = document.getElementById('difficulty-level');
    
    if (!display || !levelEl) return;
    
    // -1 顯示為 ✓ 符號，其他顯示數字
    if (level === -1) {
      levelEl.textContent = '✓';
    } else {
      levelEl.textContent = level;
    }
    
    // 移除所有等級 class（包含 n1 代表 -1）
    display.className = display.className.replace('difficulty-level-n1', '').trim();
    for (var i = 0; i <= 10; i++) {
      display.className = display.className.replace('difficulty-level-' + i, '').trim();
    }
    display.className = display.className.replace(/\s+/g, ' ').trim();
    display.classList.add('difficulty-display');
    var cls = level === -1 ? 'difficulty-level-n1' : 'difficulty-level-' + level;
    display.classList.add(cls);
  };

  // 重新套用篩選（用於切換篩選條件後）
  FlashcardApp.prototype.reapplyFilters = function() {
    this.shuffleArray(this.words);
    this.currentWords = this.applyAllFilters(this.words);
    this.currentIndex = 0;
    this.removedWords = [];
    this.displayCurrentWord();
    this.updateActiveFilterDisplay();
  };
  
  // 處理flashcard點擊事件（檢查點擊位置）
  FlashcardApp.prototype.handleFlashcardClick = function(event) {
    // 檢查點擊是否發生在控制按鈕或選單上（ES5兼容版本）
    var target = event.target;
    
    // 向上遍历DOM树检查是否点击了控制元素
    var element = target;
    while (element && element !== event.currentTarget) {
      if (element.classList && (
          element.classList.contains('controls-wrapper') ||
          element.classList.contains('progress') ||
          element.classList.contains('restore-btn-container') ||
          element.classList.contains('paused-indicator') ||
          element.classList.contains('paused-content') ||
          element.classList.contains('paused-icon') ||
          element.classList.contains('paused-text') ||
          element.classList.contains('muted-indicator') ||
          element.classList.contains('muted-content') ||
          element.classList.contains('muted-icon') ||
          element.classList.contains('muted-text') ||
          element.classList.contains('active-filters') ||
          element.tagName === 'BUTTON')) {
        return; // 如果點擊的是控制元素，不處理
      }
      element = element.parentElement;
    }
    
    // 計算下方安全區域的高度
    var flashcardRect = event.currentTarget.getBoundingClientRect();
    var clickY = event.clientY;
    var flashcardBottom = flashcardRect.bottom;
    
    // 動態計算下方安全區域高度
    var progressElement = document.getElementById('progress-area');
    var controlsWrapper = document.querySelector('.controls-wrapper');
    var safeAreaHeight = 120; // 默認高度
    
    // 嘗試動態計算實際高度
    try {
      var progressHeight = progressElement ? progressElement.offsetHeight + 20 : 40; // 包含padding
      var controlsHeight = controlsWrapper ? controlsWrapper.offsetHeight + 20 : 60; // 包含padding
      safeAreaHeight = Math.max(progressHeight, controlsHeight) + 20; // 額外的安全邊距
    } catch (e) {
      console.log('無法動態計算安全區域高度，使用默認值');
    }
    
    var safeAreaTop = flashcardBottom - safeAreaHeight;
    
    // 如果點擊位置在下方安全區域內，不觸發刪除功能
    if (clickY >= safeAreaTop) {
      console.log('點擊位置在安全區域內(Y:' + clickY + ', 安全區域起始:' + safeAreaTop + ')，不觸發刪除功能');
      return;
    }
    
    console.log('點擊位置在有效區域內(Y:' + clickY + ', 安全區域起始:' + safeAreaTop + ')，觸發刪除功能');
    // 觸發單字點擊事件
    this.onWordClick();
  };
  
  // 單字點擊事件（刪除單字功能）
  FlashcardApp.prototype.onWordClick = function() {
    if (this.isTransitioning || this.isPaused) return;
    
    if (this.currentWords.length <= 1) {
      var sections = document.querySelectorAll('.card-section');
      for (var i = 0; i < sections.length; i++) {
        sections[i].style.backgroundColor = 'rgba(255, 100, 100, 0.3)';
        (function(section) {
          setTimeout(function() {
            section.style.backgroundColor = '';
          }, APP_CONSTANTS.TRANSITION_DELAY_MS);
        })(sections[i]);
      }
      return;
    }
    
    var currentWord = this.currentWords[this.currentIndex];
    var englishElement = document.getElementById('english-word');
    var chineseElement = document.getElementById('chinese-word');
    
    var isAlreadyMarked = englishElement.classList.contains('word-pending-removal');
    
    if (isAlreadyMarked) {
      this.nextWord();
        return;
      }
      
    this.isProcessingClick = true;
    
    this._clearDisplayTimer();
    
    if (!this.showingChinese) {
      var isReversed = this.isReversedForCurrentWord();
      var secondText = isReversed ? currentWord.english : currentWord.chinese;
      chineseElement.textContent = secondText;
      chineseElement.classList.add('show');
      this.showingChinese = true;
      
      // 同時顯示圖片（如果有的話）- 使用預加載的圖片
      var flashcardDiv = document.getElementById('flashcard');
      var hasImage = currentWord.image && currentWord.image !== '';
      if (hasImage) {
        // 由於圖片已經預加載，可以直接設定，無需等待
        flashcardDiv.style.backgroundImage = 'url(' + currentWord.image + ')';
        flashcardDiv.classList.add('has-image');
      } else {
        flashcardDiv.style.backgroundImage = '';
        flashcardDiv.classList.remove('has-image');
      }
      
      var self = this;
      
      if (isReversed) {
        // 反向模式：用戶點擊顯示英文，播放英文語音
        setTimeout(function() {
          self.speakWord(currentWord.english);
        }, APP_CONSTANTS.SPEECH_DELAY_MS);
      } else {
        // 正常模式：用戶點擊顯示中文，播放中文語音
        setTimeout(function() {
          self.speakChineseWord(currentWord.chinese);
        }, APP_CONSTANTS.SPEECH_DELAY_MS);
        
        // 如果啟用了延遲發音，也在此時播放英文語音
        if (this.settings.delaySpeechInNormalMode) {
          setTimeout(function() {
            self.speakWord(currentWord.english);
          }, APP_CONSTANTS.SPEECH_DELAY_MS);
        }
      }
    }
    
    englishElement.classList.add('word-pending-removal');
    chineseElement.classList.add('word-pending-removal');
    
    var sections = document.querySelectorAll('.card-section');
    for (var i = 0; i < sections.length; i++) {
      sections[i].classList.add('clicked');
      (function(section) {
        setTimeout(function() { 
          section.classList.remove('clicked'); 
        }, 500);
      })(sections[i]);
    }
    
    // 記錄原始不熟程度，以便取消時恢復
    var originalDifficultyLevel = (currentWord.difficultyLevel !== undefined && currentWord.difficultyLevel !== null) ? currentWord.difficultyLevel : 0;
    // 預覽減少後的不熟程度（最低 0）
    var previewLevel = Math.max(0, originalDifficultyLevel - 1);

    this.pendingRemoval = {
      word: currentWord,
      index: this.currentIndex,
      originalEnglishColor: englishElement.style.color,
      originalChineseColor: chineseElement.style.color,
      originalDifficultyLevel: originalDifficultyLevel
    };
    
    // 立即在 UI 上顯示減少後的不熟程度（提升 UX）
    this.renderDifficultyLevelPreview(previewLevel);
    
    this.showRestoreButton();
    this.updateButtonStates();
    
    var self = this;
    var phase2Delay = this.getPhase2Delay();
    this._setDisplayTimer(function() {
      self.waitForSpeechThenExecute(function() {
        self.confirmRemoval();
      });
    }, phase2Delay * 1000);
    
    // 進度條第二階段：50% → 100%（翻譯已顯示，等待移除確認，使用智慧延遲）
    this.startProgressBar(2, phase2Delay);
  };
  
  // 確認移除單字
  FlashcardApp.prototype.confirmRemoval = function() {
    if (!this.pendingRemoval) return;
    
    var word = this.pendingRemoval.word;
    var index = this.pendingRemoval.index;
    var isVeryFamiliar = this.pendingRemoval.isVeryFamiliar;
    
    if (isVeryFamiliar) {
      // 標記為非常熟（-1）
      word.difficultyLevel = -1;
      
      // 同步到 words 主陣列
      var mainWord = this.words.find(function(w) { return w.id === word.id; });
      if (mainWord) mainWord.difficultyLevel = -1;
      
      // 後端同步
      this.syncDifficultyToBackend(word);
      
      // 更新 SRS 資料
      this.updateSrsData(word);
      
      console.log('已設為非常熟:', word.english);
    } else {
      // 暫時移除單字時，減少不熟程度 -1
      this.decreaseDifficulty(word);
    }
    
    // 標記該單字為已複習（暫時刪除才算已複習）
    this.markWordAsReviewed(word);
    
    this.removedWords.push(word);
    this.currentWords.splice(index, 1);
    
    if (this.currentIndex >= this.currentWords.length) {
      this.currentIndex = 0;
      // 移除最後一個單字導致回到開頭時，重新打亂順序
      if (this.currentWords.length > 1) {
        this.shuffleArray(this.currentWords);
      }
    }
    
    this.pendingRemoval = null;
    this.hideRestoreButton();
    
    if (this.currentWords.length === 0) {
      this.startNewRound();
    } else {
      this.displayCurrentWord();
    }
    
    this.isProcessingClick = false;
    this.updateButtonStates();
  };
  
  // 取消移除
  FlashcardApp.prototype.cancelRemoval = function() {
    if (!this.pendingRemoval) return;
    
    var isVeryFamiliar = this.pendingRemoval.isVeryFamiliar;
    
    var englishElement = document.getElementById('english-word');
    var chineseElement = document.getElementById('chinese-word');
    
    englishElement.classList.remove('word-pending-removal');
    chineseElement.classList.remove('word-pending-removal');
    
    // 恢復原本的不熟程度顯示
    if (this.pendingRemoval.originalDifficultyLevel !== undefined) {
      this.renderDifficultyLevelPreview(this.pendingRemoval.originalDifficultyLevel);
    }
    
    // 如果是取消非常熟標記，隱藏 toast
    if (isVeryFamiliar) {
      this.hideVeryFamiliarToast();
    }
    
    this.pendingRemoval = null;
    this.hideRestoreButton();
    
    this._clearDisplayTimer();
    
    this.isProcessingClick = false;
    this.updateButtonStates();
    
    var self = this;
    if (this.showingChinese) {
      var phase2Delay = this.getPhase2Delay();
      this._setDisplayTimer(function() {
        self.waitForSpeechThenExecute(function() {
          self.nextWord();
        });
      }, phase2Delay * 1000);
      // 進度條第二階段：50% → 100%（使用智慧延遲）
      this.startProgressBar(2, phase2Delay);
      } else {
      this._setDisplayTimer(function() {
        self.waitForSpeechThenExecute(function() {
          self.showSecondPartAndScheduleNext();
        });
      }, this.settings.delayTime * 1000);
      // 進度條第一階段：0% → 50%
      this.startProgressBar(1);
    }
  };
  
  // 顯示恢復按鈕
  FlashcardApp.prototype.showRestoreButton = function() {
    var restoreBtnContainer = document.getElementById('restore-btn-container');
    if (restoreBtnContainer) {
      restoreBtnContainer.style.display = 'block';
    }
    var progressArea = document.getElementById('progress-area');
    if (progressArea) {
      progressArea.classList.add('progress-shifted');
    }
    var filtersEl = document.getElementById('active-filters');
    if (filtersEl) {
      filtersEl.classList.add('active-filters-shifted');
    }
  };
  
  // 隱藏恢復按鈕
  FlashcardApp.prototype.hideRestoreButton = function() {
    var restoreBtnContainer = document.getElementById('restore-btn-container');
    if (restoreBtnContainer) {
      restoreBtnContainer.style.display = 'none';
    }
    var progressArea = document.getElementById('progress-area');
    if (progressArea) {
      progressArea.classList.remove('progress-shifted');
    }
    var filtersEl = document.getElementById('active-filters');
    if (filtersEl) {
      filtersEl.classList.remove('active-filters-shifted');
    }
  };
  
  // 顯示第二部分並安排下一個
  FlashcardApp.prototype.showSecondPartAndScheduleNext = function() {
    if (this.isPaused || this.showingChinese || !this.currentWords[this.currentIndex]) {
      return;
    }
  
    this._clearDisplayTimer();
    
    // 清除中文延遲顯示計時器
    if (this.chineseDelayTimer) {
      clearTimeout(this.chineseDelayTimer);
      this.chineseDelayTimer = null;
    }

    var currentWord = this.currentWords[this.currentIndex];
    var chineseElement = document.getElementById('chinese-word');
    var flashcardDiv = document.getElementById('flashcard');
    
    // 設定背景圖片（圖片佔滿整個畫面）- 使用預加載的圖片
    var hasImage = currentWord.image && currentWord.image !== '';
    if (hasImage) {
      // 由於圖片已經預加載，可以直接設定，無需等待
      flashcardDiv.style.backgroundImage = 'url(' + currentWord.image + ')';
      flashcardDiv.classList.add('has-image');
    } else {
      flashcardDiv.style.backgroundImage = '';
      flashcardDiv.classList.remove('has-image');
    }
    
    var self = this;
    var isReversed = this.isReversedForCurrentWord();
    var secondText = isReversed ? currentWord.english : currentWord.chinese;
    
    // 圖片和中文同時顯示（移除延遲）
    chineseElement.textContent = secondText;
    chineseElement.classList.add('show');
    this.showingChinese = true;
    
    // 設定下一個單字的計時器（智慧計時：Phase 2 可能縮短）
    var phase2Delay = this.getPhase2Delay();
    this._setDisplayTimer(function() {
      self.waitForSpeechThenExecute(function() {
        self.nextWord();
      });
    }, phase2Delay * 1000);
    
    // 進度條第二階段：50% → 100%（使用智慧延遲）
    this.startProgressBar(2, phase2Delay);
    
    if (isReversed) {
      // 反向模式：第二部分顯示英文，播放英文語音
      setTimeout(function() {
        self.speakWord(currentWord.english);
      }, APP_CONSTANTS.SPEECH_DELAY_MS);
    } else {
      // 正常模式：第二部分顯示中文，播放中文語音
      setTimeout(function() {
        self.speakChineseWord(currentWord.chinese);
      }, APP_CONSTANTS.SPEECH_DELAY_MS);
      
      // 如果啟用了延遲發音，也在此時播放英文語音
      if (this.settings.delaySpeechInNormalMode) {
        setTimeout(function() {
          self.speakWord(currentWord.english);
        }, APP_CONSTANTS.SPEECH_DELAY_MS);
      }
    }
  };
  
  // 預加載圖片方法
  FlashcardApp.prototype.preloadImage = function(imageUrl, callback) {
    if (!imageUrl || imageUrl === '') {
      if (callback) callback(false);
      return;
    }
    
    // 如果已經預加載過，直接回調
    if (this.preloadedImages[imageUrl]) {
      if (callback) callback(true);
      return;
    }
    
    var self = this;
    var img = new Image();
    
    img.onload = function() {
      self.preloadedImages[imageUrl] = true;
      if (callback) callback(true);
    };
    
    img.onerror = function() {
      console.warn('圖片預加載失敗:', imageUrl);
      if (callback) callback(false);
    };
    
    img.src = imageUrl;
    this.currentPreloadingImage = img;
  };
  
  // ===========================================
  // D 鍵：標記為非常熟（-1）功能
  // ===========================================

  // 處理 D 鍵按下（雙按確認標記為非常熟）
  FlashcardApp.prototype.handleMarkVeryFamiliar = function() {
    if (this.currentWords.length === 0) return;
    
    var currentWord = this.currentWords[this.currentIndex];
    if (!currentWord) return;
    
    // 如果已經是 -1，顯示提示
    if (currentWord.difficultyLevel === -1) {
      this.showVeryFamiliarToast('此字已經是非常熟');
      return;
    }
    
    // 如果已經在非常熟暫時刪除狀態中，忽略
    if (this.pendingRemoval && this.pendingRemoval.isVeryFamiliar) {
      return;
    }
    
    // 如果已有待確認狀態（第二次按 D）
    if (this._pendingVeryFamiliar && this._pendingVeryFamiliar.wordId === currentWord.id) {
      // 確認標記為非常熟（進入暫時刪除狀態）
      this.confirmMarkVeryFamiliar();
      return;
    }
    
    // 第一次按 D：暫停計時器並顯示確認提示
    var savedRemainingMs = 0;
    var savedProgressPhase = this._progressPhase;
    if (this._activeTimerInfo) {
      var elapsed = Date.now() - this._activeTimerInfo.setAt;
      savedRemainingMs = Math.max(0, this._activeTimerInfo.delay - elapsed);
    }
    this._clearDisplayTimer();
    this.pauseProgressBar();
    
    // 儲存計時器狀態，供取消或特殊路徑恢復使用
    this._vfSavedTimer = {
      remainingMs: savedRemainingMs,
      progressPhase: savedProgressPhase
    };
    
    var self = this;
    this._pendingVeryFamiliar = {
      wordId: currentWord.id,
      timer: setTimeout(function() {
        self.cancelMarkVeryFamiliar();
      }, APP_CONSTANTS.VERY_FAMILIAR_TIMEOUT_MS)
    };
    
    this.showVeryFamiliarToast('再按一下 D 設為非常熟（ESC 取消）');
  };

  // 確認標記為非常熟（-1）— 進入暫時刪除狀態（灰色字顯示答案）
  FlashcardApp.prototype.confirmMarkVeryFamiliar = function() {
    if (!this._pendingVeryFamiliar) return;
    
    var wordId = this._pendingVeryFamiliar.wordId;
    
    // 清除待確認狀態
    if (this._pendingVeryFamiliar.timer) {
      clearTimeout(this._pendingVeryFamiliar.timer);
    }
    this._pendingVeryFamiliar = null;
    
    // 找到目標單字
    var currentWord = this.currentWords[this.currentIndex];
    if (!currentWord || currentWord.id !== wordId) return;
    
    // 如果在 -1 篩選模式下，直接設定並更新顯示（不需要移除）
    if (this.difficultyFilter === -1) {
      currentWord.difficultyLevel = -1;
      var mainWord = this.words.find(function(w) { return w.id === wordId; });
      if (mainWord) mainWord.difficultyLevel = -1;
      this.syncDifficultyToBackend(currentWord);
      this.updateSrsData(currentWord);
      this.showVeryFamiliarToast('✓ 已設為非常熟');
      this.renderDifficultyLevel();
      // 恢復被第一次 D 暫停的計時器
      this._resumeTimerAfterVeryFamiliarCancel();
      return;
    }
    
    // 如果已經有 pendingRemoval（例如已經點擊過單字卡），升級為非常熟
    if (this.pendingRemoval && this.pendingRemoval.word && this.pendingRemoval.word.id === wordId) {
      this.pendingRemoval.isVeryFamiliar = true;
      // 更新不熟程度預覽為 ✓（-1）
      this.renderDifficultyLevelPreview(-1);
      this.showVeryFamiliarToast('✓ 已設為非常熟');
      // 恢復被第一次 D 暫停的計時器（pendingRemoval 自身的計時器）
      this._resumeTimerAfterVeryFamiliarCancel();
      return;
    }
    
    // === 進入類似暫時刪除的狀態 ===
    
    // 清除 D 鍵暫停時儲存的計時器狀態（不再需要，將使用新的計時器）
    this._vfSavedTimer = null;
    
    var englishElement = document.getElementById('english-word');
    var chineseElement = document.getElementById('chinese-word');
    
    this.isProcessingClick = true;
    this._clearDisplayTimer();
    
    // 如果中文（第二語言）尚未顯示，立即顯示
    if (!this.showingChinese) {
      var isReversed = this.isReversedForCurrentWord();
      var secondText = isReversed ? currentWord.english : currentWord.chinese;
      chineseElement.textContent = secondText;
      chineseElement.classList.add('show');
      this.showingChinese = true;
      
      // 顯示圖片（如果有的話）
      var flashcardDiv = document.getElementById('flashcard');
      var hasImage = currentWord.image && currentWord.image !== '';
      if (hasImage) {
        flashcardDiv.style.backgroundImage = 'url(' + currentWord.image + ')';
        flashcardDiv.classList.add('has-image');
      } else {
        flashcardDiv.style.backgroundImage = '';
        flashcardDiv.classList.remove('has-image');
      }
      
      var self = this;
      if (isReversed) {
        setTimeout(function() {
          self.speakWord(currentWord.english);
        }, APP_CONSTANTS.SPEECH_DELAY_MS);
      } else {
        setTimeout(function() {
          self.speakChineseWord(currentWord.chinese);
        }, APP_CONSTANTS.SPEECH_DELAY_MS);
        if (this.settings.delaySpeechInNormalMode) {
          setTimeout(function() {
            self.speakWord(currentWord.english);
          }, APP_CONSTANTS.SPEECH_DELAY_MS);
        }
      }
    }
    
    // 灰色字顯示（pending removal 視覺效果）
    englishElement.classList.add('word-pending-removal');
    chineseElement.classList.add('word-pending-removal');
    
    // 記錄原始不熟程度，以便取消時恢復
    var originalDifficultyLevel = (currentWord.difficultyLevel !== undefined && currentWord.difficultyLevel !== null) ? currentWord.difficultyLevel : 0;
    
    // 建立 pendingRemoval 狀態（標記為 isVeryFamiliar）
    this.pendingRemoval = {
      word: currentWord,
      index: this.currentIndex,
      originalEnglishColor: englishElement.style.color,
      originalChineseColor: chineseElement.style.color,
      originalDifficultyLevel: originalDifficultyLevel,
      isVeryFamiliar: true
    };
    
    // 預覽不熟程度為 ✓（-1）
    this.renderDifficultyLevelPreview(-1);
    
    this.showRestoreButton();
    this.updateButtonStates();
    
    // 顯示確認訊息
    this.showVeryFamiliarToast('✓ 已設為非常熟');
    
    // 設定計時器，到期後透過 confirmRemoval 確認
    var self = this;
    var phase2Delay = this.getPhase2Delay();
    this._setDisplayTimer(function() {
      self.waitForSpeechThenExecute(function() {
        self.confirmRemoval();
      });
    }, phase2Delay * 1000);
    
    // 進度條第二階段
    this.startProgressBar(2, phase2Delay);
  };

  // 恢復被第一次 D 鍵暫停的計時器（共用邏輯）
  FlashcardApp.prototype._resumeTimerAfterVeryFamiliarCancel = function() {
    if (!this._vfSavedTimer) return;
    
    var savedRemainingMs = this._vfSavedTimer.remainingMs;
    var savedProgressPhase = this._vfSavedTimer.progressPhase;
    this._vfSavedTimer = null;
    
    // 恢復計時器和進度條（如果不在暫停狀態）
    if (!this.isPaused && savedRemainingMs > 0) {
      var self = this;
      if (savedProgressPhase === 2 || this.showingChinese) {
        this._setDisplayTimer(function() {
          self.waitForSpeechThenExecute(function() {
            self.nextWord();
          });
        }, savedRemainingMs);
        this._progressPhase = 2;
        this.resumeProgressBar(savedRemainingMs / 1000);
      } else {
        this._setDisplayTimer(function() {
          self.waitForSpeechThenExecute(function() {
            self.showSecondPartAndScheduleNext();
          });
        }, savedRemainingMs);
        this._progressPhase = 1;
        this.resumeProgressBar(savedRemainingMs / 1000);
      }
    }
  };

  // 取消標記為非常熟（恢復計時器）
  FlashcardApp.prototype.cancelMarkVeryFamiliar = function() {
    if (!this._pendingVeryFamiliar) return;
    
    if (this._pendingVeryFamiliar.timer) {
      clearTimeout(this._pendingVeryFamiliar.timer);
    }
    this._pendingVeryFamiliar = null;
    this.hideVeryFamiliarToast();
    
    // 恢復被第一次 D 暫停的計時器
    this._resumeTimerAfterVeryFamiliarCancel();
  };

  // 顯示非常熟提示訊息（toast）
  FlashcardApp.prototype.showVeryFamiliarToast = function(message) {
    var toast = document.getElementById('very-familiar-toast');
    if (!toast) return;
    
    toast.textContent = message;
    toast.style.display = 'block';
    toast.style.opacity = '1';
    
    // 如果是確認訊息，1.5 秒後自動隱藏
    if (message.indexOf('✓') === 0 || message.indexOf('此字已經') === 0) {
      var self = this;
      setTimeout(function() {
        self.hideVeryFamiliarToast();
      }, 1500);
    }
  };

  // 隱藏非常熟提示訊息
  FlashcardApp.prototype.hideVeryFamiliarToast = function() {
    var toast = document.getElementById('very-familiar-toast');
    if (!toast) return;
    toast.style.opacity = '0';
    setTimeout(function() {
      toast.style.display = 'none';
    }, APP_CONSTANTS.NOTIFICATION_FADE_MS);
  };

  // 增強滑塊交互體驗（ES5兼容版本）
  FlashcardApp.prototype.enhanceSliderInteraction = function(slider, valueElementId, unit) {
    if (!slider) return;
    
    var self = this;
    unit = unit || '';
    
    // 計算點擊位置對應的值
    function calculateValueFromClick(event, sliderElement) {
      var rect = sliderElement.getBoundingClientRect();
      var clickX = event.clientX || (event.touches && event.touches[0] ? event.touches[0].clientX : 0);
      var sliderX = clickX - rect.left;
      var sliderWidth = rect.width;
      
      // 確保點擊位置在滑塊範圍內
      if (sliderX < 0) sliderX = 0;
      if (sliderX > sliderWidth) sliderX = sliderWidth;
      
      // 計算百分比
      var percentage = sliderX / sliderWidth;
      
      // 根據滑塊的min、max、step計算值
      var min = parseFloat(sliderElement.min);
      var max = parseFloat(sliderElement.max);
      var step = parseFloat(sliderElement.step) || 1;
      
      var rawValue = min + (max - min) * percentage;
      
      // 根據step調整值，修復浮點數精度問題
      var steppedValue = Math.round(rawValue / step) * step;
      
      // 確保值在範圍內
      if (steppedValue < min) steppedValue = min;
      if (steppedValue > max) steppedValue = max;
      
      // 修復浮點數精度問題
      var decimalPlaces = 0;
      if (step.toString().indexOf('.') !== -1) {
        decimalPlaces = step.toString().split('.')[1].length;
      }
      steppedValue = parseFloat(steppedValue.toFixed(decimalPlaces));
      
      return steppedValue;
    }
    
    // 更新滑塊值和顯示
    function updateSliderValue(newValue) {
      slider.value = newValue;
      
      // 觸發input事件以更新顯示和其他邏輯
      var inputEvent;
      try {
        inputEvent = new Event('input', { bubbles: true });
      } catch (e) {
        // IE/舊瀏覽器兼容
        inputEvent = document.createEvent('HTMLEvents');
        inputEvent.initEvent('input', true, true);
      }
      slider.dispatchEvent(inputEvent);
      
      // 手動更新顯示值（確保格式正確）
      var valueElement = document.getElementById(valueElementId);
      if (valueElement) {
        // 格式化顯示值，避免浮點數精度問題
        var step = parseFloat(slider.step) || 1;
        var decimalPlaces = 0;
        if (step.toString().indexOf('.') !== -1) {
          decimalPlaces = step.toString().split('.')[1].length;
        }
        var formattedValue = parseFloat(newValue.toFixed(decimalPlaces));
        valueElement.textContent = formattedValue + unit;
      }
    }
    
    // 點擊事件處理
    function handleClick(event) {
      // 防止冒泡
      event.preventDefault();
      event.stopPropagation();
      
      var newValue = calculateValueFromClick(event, slider);
      updateSliderValue(newValue);
    }
    
    // 觸摸事件處理
    function handleTouchStart(event) {
      event.preventDefault();
      var newValue = calculateValueFromClick(event, slider);
      updateSliderValue(newValue);
    }
    
    // 添加事件監聽器
    slider.addEventListener('click', handleClick);
    slider.addEventListener('touchstart', handleTouchStart);
    
    console.log('已增強滑塊交互體驗:', slider.id);
  };
  
  // ===========================================
  // 計時器進度條（畫面中央水平線）
  // ===========================================

  // 開始進度條動畫
  // phase=1: 第一語言顯示中，0% → 50%（到 50% 時顯示翻譯）
  // phase=2: 翻譯已顯示，50% → 100%（到 100% 時切換下一個單字）
  // customDuration: 可選，Phase 2 智慧計時時使用的自訂時長（秒）
  FlashcardApp.prototype.startProgressBar = function(phase, customDuration) {
    var bar = document.getElementById('timer-progress-bar');
    if (!bar) return;

    var duration = (phase === 2 && customDuration !== undefined) ? customDuration : this.settings.delayTime;
    var startPercent = phase === 1 ? 0 : 50;
    var endPercent = phase === 1 ? 50 : 100;

    this._progressPhase = phase;
    this._progressDuration = duration;

    // 重置到起始位置（無動畫）
    bar.style.WebkitTransition = 'none';
    bar.style.transition = 'none';
    bar.style.width = startPercent + '%';

    // 強制 reflow
    bar.offsetWidth;

    // 啟動動畫（以 duration 為時長，線性成長）
    bar.style.WebkitTransition = 'width ' + duration + 's linear';
    bar.style.transition = 'width ' + duration + 's linear';
    bar.style.width = endPercent + '%';
  };

  // 暫停進度條（凍結在當前位置）
  FlashcardApp.prototype.pauseProgressBar = function() {
    var bar = document.getElementById('timer-progress-bar');
    if (!bar) return;

    // 取得當前動畫中的寬度
    var computedWidth = 0;
    try {
      computedWidth = parseFloat(window.getComputedStyle(bar).width) || 0;
    } catch (e) {
      computedWidth = bar.offsetWidth || 0;
    }
    var parentWidth = bar.parentElement ? bar.parentElement.offsetWidth : window.innerWidth;
    var currentPercent = parentWidth > 0 ? (computedWidth / parentWidth) * 100 : 0;

    // 凍結在當前位置
    bar.style.WebkitTransition = 'none';
    bar.style.transition = 'none';
    bar.style.width = currentPercent + '%';
  };

  // 恢復進度條（從凍結位置動畫到目標，使用剩餘時間確保與計時器同步）
  // remainingDuration: 可選，剩餘時長（秒），確保進度條與計時器精確同步
  FlashcardApp.prototype.resumeProgressBar = function(remainingDuration) {
    var bar = document.getElementById('timer-progress-bar');
    if (!bar || !this._progressPhase) return;

    var duration = remainingDuration || this._progressDuration || this.settings.delayTime;
    var endPercent = this._progressPhase === 1 ? 50 : 100;

    // 強制 reflow（bar 目前凍結在暫停位置）
    bar.offsetWidth;

    // 從當前位置動畫到目標，使用剩餘時間
    bar.style.WebkitTransition = 'width ' + duration + 's linear';
    bar.style.transition = 'width ' + duration + 's linear';
    bar.style.width = endPercent + '%';
  };

  // 重置進度條（歸零）
  FlashcardApp.prototype.resetProgressBar = function() {
    var bar = document.getElementById('timer-progress-bar');
    if (!bar) return;

    bar.style.WebkitTransition = 'none';
    bar.style.transition = 'none';
    bar.style.width = '0%';
    this._progressPhase = null;
  };

</script>

<!-- script-export.html -->
<script>
  /**
   * @module script-export
   * @description åŒ¯å‡ºæ¨¡çµ„ï¼šé–‹å•Ÿ/é—œé–‰åŒ¯å‡ºæ¨¡æ…‹æ¡†ã€åˆ†æ‰¹åŒ¯å‡ºå–®å­—åˆ° Google Sheetã€
   *   é€²åº¦æ¢æ›´æ–°ã€å·¥ä½œè¡¨å·²å­˜åœ¨è™•ç†ï¼ˆè¦†å¯«/æ”¹åï¼‰ã€æ›¿ä»£åç¨±ç”Ÿæˆã€‚
   *
   * @dependencies script-core.html (FlashcardApp, APP_CONSTANTS)
   * @provides FlashcardApp.prototype: openExportModal, closeExportModal,
   *   startBatchExport, processBatch, confirmExport, performExport,
   *   handleSheetExistsError, showOverwriteConfirmModal ...
   */

  // åŒ¯å‡ºåŠŸèƒ½ç›¸é—œï¼ˆå®Œæ•´ç‰ˆæœ¬ï¼‰
  FlashcardApp.prototype.openExportModal = function() {
      // é è¨­åç¨±ï¼šç›®å‰å·¥ä½œè¡¨åç¨±_yyyyMMdd
    var defaultName = this.getDefaultExportSheetName();
    var exportSheetNameInput = document.getElementById('export-sheet-name');
    var exportTypeRemainingRadio = document.getElementById('export-type-remaining');
    
    if (exportSheetNameInput) exportSheetNameInput.value = defaultName;
    if (exportTypeRemainingRadio) exportTypeRemainingRadio.checked = true;
    openModalById(this, 'export-modal');
    
    // é‡ç½®åŒ¯å‡ºæŒ‰éˆ•ç‹€æ…‹å’Œé€²åº¦é¡¯ç¤º
    var confirmBtn = document.getElementById('confirm-export');
      if (confirmBtn) {
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'åŒ¯å‡º';
      }
    
    // éš±è—é€²åº¦é¡¯ç¤º
    this.hideExportProgress();
  };
  
  FlashcardApp.prototype.closeExportModal = function() {
    closeModalById(this, 'export-modal');
    
    // ç¢ºä¿ã€Œå·²æš«åœã€æ¶ˆå¤±
    var pausedIndicator = document.getElementById('paused-indicator');
    if (pausedIndicator) {
      pausedIndicator.style.display = 'none';
      pausedIndicator.title = '';
    }
    
    // éš±è—é€²åº¦é¡¯ç¤º
    this.hideExportProgress();
  };
  
  // ç²å–é è¨­åŒ¯å‡ºå·¥ä½œè¡¨åç¨±
FlashcardApp.prototype.getDefaultExportSheetName = function() {
  // ä½¿ç”¨å¯¦éš›è¼‰å…¥çš„å·¥ä½œè¡¨åç¨±ä½œç‚ºåŸºç¤
  var base = 'Sheet1'; // é è¨­å€¼
  
  // å¦‚æœæœ‰é¸æ“‡çš„å·¥ä½œè¡¨ï¼Œä½¿ç”¨ç¬¬ä¸€å€‹ä½œç‚ºåŸºç¤åç¨±
  console.log("this.sheetSettings.selectedSheets", this.sheetSettings.selectedSheets);
  if (this.sheetSettings.selectedSheets && this.sheetSettings.selectedSheets.length > 0) {
    base = this.sheetSettings.selectedSheets[0];
    console.log("base", base);
  }
  
  var date = new Date();
  var y = date.getFullYear();
  var m = (date.getMonth() + 1).toString();
  var d = date.getDate().toString();
  
  // ES5 ç‰ˆæœ¬çš„ padStart
  if (m.length < 2) m = '0' + m;
  if (d.length < 2) d = '0' + d;
  
  return base + '_' + y + m + d;
};
  
  // é¡¯ç¤ºåŒ¯å‡ºé€²åº¦
  FlashcardApp.prototype.showExportProgress = function() {
    var progressContainer = document.getElementById('export-progress-container');
    if (progressContainer) {
      progressContainer.style.display = 'block';
    }
    
    // é‡ç½®é€²åº¦
    this.updateExportProgress(0, 0, 'æº–å‚™åŒ¯å‡º...');
  };
  
  // éš±è—åŒ¯å‡ºé€²åº¦
  FlashcardApp.prototype.hideExportProgress = function() {
    var progressContainer = document.getElementById('export-progress-container');
    if (progressContainer) {
      progressContainer.style.display = 'none';
    }
    
    // æ¸…é™¤é€²åº¦è¨ˆæ™‚å™¨ï¼ˆé›–ç„¶ç¾åœ¨ä¸ä½¿ç”¨ï¼Œä½†ä¿ç•™ç›¸å®¹æ€§ï¼‰
    if (this.progressTimer) {
      clearInterval(this.progressTimer);
      this.progressTimer = null;
    }
    
    // æ¸…é™¤åˆ†æ‰¹åŒ¯å‡ºç‹€æ…‹
    this.currentBatch = 0;
    this.totalBatches = 0;
    this.processedWords = 0;
    this.totalWords = 0;
    this.exportBatches = null;
    this.isSheetCreated = false;
  };
  
  // æ›´æ–°åŒ¯å‡ºé€²åº¦
  FlashcardApp.prototype.updateExportProgress = function(current, total, message) {
    var progressFill = document.getElementById('export-progress-fill');
    var progressText = document.getElementById('export-progress-text');
    var progressCount = document.getElementById('export-progress-count');
    
    if (progressFill && total > 0) {
      var percentage = Math.min((current / total) * 100, 100);
      progressFill.style.width = percentage + '%';
    }
    
    if (progressText && message) {
      progressText.textContent = message;
    }
    
    if (progressCount && total > 0) {
      progressCount.textContent = current + ' / ' + total;
    }
  };
  
  // é–‹å§‹åˆ†æ‰¹åŒ¯å‡º
  FlashcardApp.prototype.startBatchExport = function(exportData, sheetName, targetSheetId, overwrite) {
    var self = this;
    var batchSize = APP_CONSTANTS.EXPORT_BATCH_SIZE;
    var batches = [];
    
    // å°‡è³‡æ–™åˆ†æˆæ‰¹æ¬¡
    for (var i = 0; i < exportData.length; i += batchSize) {
      batches.push(exportData.slice(i, i + batchSize));
    }
    
    this.currentBatch = 0;
    this.totalBatches = batches.length;
    this.processedWords = 0;
    this.totalWords = exportData.length;
    this.exportBatches = batches;
    this.exportSheetName = sheetName;
    this.exportTargetSheetId = targetSheetId;
    this.exportOverwrite = overwrite;
    this.isSheetCreated = false; // è¿½è¹¤å·¥ä½œè¡¨æ˜¯å¦å·²å‰µå»º
    
    // é–‹å§‹è™•ç†ç¬¬ä¸€æ‰¹
    this.processBatch();
  };
  
  
// è™•ç†å–®ä¸€æ‰¹æ¬¡ï¼ˆä¿®æ”¹exportWordsToSheetèª¿ç”¨ï¼‰
FlashcardApp.prototype.processBatch = function() {
  var self = this;
  
  if (this.currentBatch >= this.totalBatches) {
    // æ‰€æœ‰æ‰¹æ¬¡å®Œæˆ
    this.completeExportProgress();
    setTimeout(function() {
      self.onExportComplete();
    }, 500);
    return;
  }
  
  var currentBatchData = this.exportBatches[this.currentBatch];
  var batchNumber = this.currentBatch + 1;
  var isFirstBatch = this.currentBatch === 0;
  
  // æ›´æ–°é€²åº¦é¡¯ç¤º
  var message = 'æ­£åœ¨åŒ¯å‡ºç¬¬ ' + batchNumber + ' æ‰¹ï¼Œå…± ' + this.totalBatches + ' æ‰¹...';
  this.updateExportProgress(this.processedWords, this.totalWords, message);
  
  // ç¢ºå®šæ“ä½œæ¨¡å¼ï¼šç¬¬ä¸€æ‰¹æ¬¡å¯èƒ½éœ€è¦è¦†å¯«ï¼Œå¾ŒçºŒæ‰¹æ¬¡çµ•å°ä¸è¦†å¯«
  var shouldOverwrite = this.exportOverwrite && isFirstBatch;
  
  // è™•ç†ç•¶å‰æ‰¹æ¬¡
  google.script.run
    .withSuccessHandler(function(result) {
      console.log('ç¬¬ ' + batchNumber + ' æ‰¹åŒ¯å‡ºçµæœ:', result);
      
      // æª¢æŸ¥åŒ¯å‡ºçµæœ
      if (result && result.success === false) {
        // åªæœ‰ç¬¬ä¸€æ‰¹æ¬¡æ‰è™•ç†å·¥ä½œè¡¨å­˜åœ¨çš„éŒ¯èª¤
        if (isFirstBatch && result.error === 'SHEET_EXISTS') {
          console.log('ç¬¬ä¸€æ‰¹æ¬¡ï¼šè™•ç†å·¥ä½œè¡¨å·²å­˜åœ¨çš„æƒ…æ³');
          self.handleSheetExistsError(result.message);
          return;
        }
        
        // è™•ç†å…¶ä»–éŒ¯èª¤
        console.error('æ‰¹æ¬¡åŒ¯å‡ºå¤±æ•—:', result);
        self.hideExportProgress();
        alert('åŒ¯å‡ºå¤±æ•—ï¼ˆç¬¬ ' + batchNumber + ' æ‰¹ï¼‰ï¼š' + (result.message || result.error || 'æœªçŸ¥éŒ¯èª¤'));
        self.resetExportButton();
        return;
      }
      
      // æ‰¹æ¬¡æˆåŠŸå®Œæˆ
      console.log('ç¬¬ ' + batchNumber + ' æ‰¹æˆåŠŸåŒ¯å‡º ' + currentBatchData.length + ' å€‹å–®å­—');
      self.processedWords += currentBatchData.length;
      self.currentBatch++;
      
      // æ¨™è¨˜å·¥ä½œè¡¨å·²å‰µå»ºï¼ˆç¬¬ä¸€æ‰¹æ¬¡æˆåŠŸå¾Œï¼‰
      if (isFirstBatch) {
        self.isSheetCreated = true;
      }
      
      // æ›´æ–°é€²åº¦
      var progressMessage = 'å·²å®Œæˆ ' + self.processedWords + ' / ' + self.totalWords + ' å€‹å–®å­—';
      self.updateExportProgress(self.processedWords, self.totalWords, progressMessage);
      
      // è™•ç†ä¸‹ä¸€æ‰¹ï¼ˆå»¶é²ä¸€é»è®“ä½¿ç”¨è€…çœ‹åˆ°é€²åº¦æ›´æ–°ï¼‰
      setTimeout(function() {
        self.processBatch();
      }, APP_CONSTANTS.EXPORT_BATCH_DELAY_MS);
    })
    .withFailureHandler(function(error) {
      console.error('æ‰¹æ¬¡åŒ¯å‡ºå¤±æ•—:', error);
      self.hideExportProgress();
      alert('åŒ¯å‡ºå¤±æ•—ï¼ˆç¬¬ ' + batchNumber + ' æ‰¹ï¼‰ï¼Œè«‹é‡è©¦ï¼\néŒ¯èª¤ï¼š' + error);
      self.resetExportButton();
    })
    .exportWordsToSheet(
      currentBatchData, 
      this.exportSheetName, 
      this.exportTargetSheetId, 
      shouldOverwrite, // ç¬¬ä¸€æ‰¹æ¬¡å¯èƒ½è¦†å¯«ï¼Œå¾ŒçºŒæ‰¹æ¬¡çµ•å°ä¸è¦†å¯«
      isFirstBatch // å‚³éæ˜¯å¦ç‚ºç¬¬ä¸€æ‰¹æ¬¡çš„åƒæ•¸
    );
};
  
  // åŒ¯å‡ºå®Œæˆè™•ç†
  FlashcardApp.prototype.onExportComplete = function() {
    var confirmBtn = document.getElementById('confirm-export');
    if (confirmBtn) {
      confirmBtn.disabled = false;
      confirmBtn.textContent = 'åŒ¯å‡º';
    }
    
    alert('åŒ¯å‡ºæˆåŠŸï¼å…±åŒ¯å‡º ' + this.totalWords + ' å€‹å–®å­—');
    this.closeExportModal();
  };
  
  // é‡ç½®åŒ¯å‡ºæŒ‰éˆ•
  FlashcardApp.prototype.resetExportButton = function() {
    var confirmBtn = document.getElementById('confirm-export');
    if (confirmBtn) {
      confirmBtn.disabled = false;
      confirmBtn.textContent = 'åŒ¯å‡º';
    }
  };
  
  // å®ŒæˆåŒ¯å‡ºé€²åº¦
  FlashcardApp.prototype.completeExportProgress = function() {
    var progressText = document.getElementById('export-progress-text');
    var progressCount = document.getElementById('export-progress-count');
    var progressFill = document.getElementById('export-progress-fill');
    
    // æ¸…é™¤è¨ˆæ™‚å™¨ï¼ˆé›–ç„¶ç¾åœ¨ä¸ä½¿ç”¨ï¼Œä½†ä¿ç•™ç›¸å®¹æ€§ï¼‰
    if (this.progressTimer) {
      clearInterval(this.progressTimer);
      this.progressTimer = null;
    }
    
    // è¨­å®šå®Œæˆç‹€æ…‹
    if (progressFill) {
      progressFill.style.width = '100%';
    }
    
    if (progressText) {
      progressText.textContent = 'åŒ¯å‡ºå®Œæˆï¼';
    }
    
    if (progressCount && this.totalWords > 0) {
      progressCount.textContent = this.totalWords + ' / ' + this.totalWords;
    }
  };
  
  FlashcardApp.prototype.confirmExport = function() {
      this.performExport(false);
  };
  
  FlashcardApp.prototype.performExport = function(overwrite) {
    var confirmBtn = document.getElementById('confirm-export');
      if (confirmBtn) {
        confirmBtn.disabled = true;
        confirmBtn.textContent = overwrite ? 'è¦†å¯«ä¸­...' : 'åŒ¯å‡ºä¸­...';
      }
      
    var typeRadio = document.getElementById('export-type-difficult');
    var type = (typeRadio && typeRadio.checked) ? 'difficult' : 'remaining';
    var sheetNameInput = document.getElementById('export-sheet-name');
    var sheetName = (sheetNameInput && sheetNameInput.value.trim()) || this.getDefaultExportSheetName();
    var exportWords = [];
    
      if (type === 'difficult') {
      exportWords = this.words.filter(function(w) { 
        return (w.difficultyLevel || 0) >= 1; 
      });
      } else {
        exportWords = this.currentWords;
      }
      
      // åŒ¯å‡ºè³‡æ–™æ ¼å¼
    var exportData = [];
    for (var i = 0; i < exportWords.length; i++) {
      var w = exportWords[i];
      exportData.push({
        english: w.english,
        chinese: w.chinese,
        difficultyLevel: w.difficultyLevel || 0,
        image: w.image || '',        // E æ¬„ï¼šåœ–ç‰‡URL
        imageFormula: w.imageFormula || ''  // F æ¬„ï¼šåœ–ç‰‡é¡¯ç¤ºå…¬å¼
      });
    }
      
      if (exportData.length === 0) {
        alert('æ²’æœ‰å¯åŒ¯å‡ºçš„å–®å­—ï¼');
        if (confirmBtn) {
          confirmBtn.disabled = false;
          confirmBtn.textContent = 'åŒ¯å‡º';
        }
        return;
      }
    
    // é¡¯ç¤ºé€²åº¦
    this.showExportProgress();
    this.updateExportProgress(0, exportData.length, 'æº–å‚™åŒ¯å‡º...');
    
    // é–‹å§‹åˆ†æ‰¹åŒ¯å‡º
    var targetSheetId = this.sheetSettings.sheetId || null;
    this.startBatchExport(exportData, sheetName, targetSheetId, overwrite);
  };
  
  FlashcardApp.prototype.handleSheetExistsError = function(message) {
    var sheetNameInput = document.getElementById('export-sheet-name');
    var currentSheetName = sheetNameInput ? sheetNameInput.value.trim() : '';
    
    // åœæ­¢é€²åº¦é¡¯ç¤º
    this.hideExportProgress();
    
    // é‡ç½®åŒ¯å‡ºæŒ‰éˆ•
    this.resetExportButton();
      
      // é¡¯ç¤ºè‡ªå®šç¾©è¦†å¯«ç¢ºèªå°è©±æ¡†
      this.showOverwriteConfirmModal(currentSheetName);
  };
  
  FlashcardApp.prototype.showOverwriteConfirmModal = function(sheetName) {
      // è¨­ç½®å·¥ä½œè¡¨åç¨±
    var existingSheetNameElement = document.getElementById('existing-sheet-name');
    if (existingSheetNameElement) {
      existingSheetNameElement.textContent = sheetName;
    }
      
      // é¡¯ç¤ºå°è©±æ¡†
    var overwriteModal = document.getElementById('overwrite-confirm-modal');
    if (overwriteModal) {
      overwriteModal.style.display = 'flex';
    }
      
      // æš«åœè¨ˆæ™‚å™¨
      this.pauseTimer();
      
      // ç¶å®šäº‹ä»¶è™•ç†ç¨‹åº
      this.bindOverwriteConfirmEvents();
  };
  
  FlashcardApp.prototype.closeOverwriteConfirmModal = function() {
    var overwriteModal = document.getElementById('overwrite-confirm-modal');
    if (overwriteModal) {
      overwriteModal.style.display = 'none';
    }
    
      this.resumeTimer();
      
      // ç§»é™¤äº‹ä»¶è™•ç†ç¨‹åº
      this.unbindOverwriteConfirmEvents();
  };
  
  FlashcardApp.prototype.bindOverwriteConfirmEvents = function() {
    var self = this;
    
      // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶è™•ç†ç¨‹åºï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      this.unbindOverwriteConfirmEvents();
      
      // é—œé–‰æŒ‰éˆ•
    this.closeOverwriteHandler = function() { self.closeOverwriteConfirmModal(); };
    var closeBtn = document.getElementById('close-overwrite-confirm');
    if (closeBtn) {
      closeBtn.addEventListener('click', this.closeOverwriteHandler);
    }
      
      // ä½¿ç”¨ä¸åŒåç¨±æŒ‰éˆ•
    this.useDifferentNameHandler = function() {
      self.closeOverwriteConfirmModal();
      self.suggestAlternativeName();
    };
    var differentNameBtn = document.getElementById('use-different-name');
    if (differentNameBtn) {
      differentNameBtn.addEventListener('click', this.useDifferentNameHandler);
    }
      
      // è¦†å¯«ç¢ºèªæŒ‰éˆ•
    this.overwriteConfirmHandler = function() {
      self.closeOverwriteConfirmModal();
      // é‡æ–°é–‹å§‹åˆ†æ‰¹åŒ¯å‡ºï¼Œè¨­å®šè¦†å¯«æ¨¡å¼
      var exportData = [];
      if (self.exportBatches) {
        // é‡æ–°çµ„åˆæ‰€æœ‰æ‰¹æ¬¡çš„è³‡æ–™
        for (var i = 0; i < self.exportBatches.length; i++) {
          exportData = exportData.concat(self.exportBatches[i]);
        }
      }
      if (exportData.length > 0) {
        self.showExportProgress();
        // é‡ç½®å·¥ä½œè¡¨å‰µå»ºç‹€æ…‹
        self.isSheetCreated = false;
        self.startBatchExport(exportData, self.exportSheetName, self.exportTargetSheetId, true);
      } else {
        self.performExport(true);
      }
    };
    var overwriteConfirmBtn = document.getElementById('overwrite-confirm');
    if (overwriteConfirmBtn) {
      overwriteConfirmBtn.addEventListener('click', this.overwriteConfirmHandler);
    }
      
      // éµç›¤äº‹ä»¶è™•ç†
    this.overwriteKeyHandler = function(event) { self.handleOverwriteKeyboard(event); };
      document.addEventListener('keydown', this.overwriteKeyHandler);
  };
  
  FlashcardApp.prototype.unbindOverwriteConfirmEvents = function() {
      if (this.closeOverwriteHandler) {
      var closeBtn = document.getElementById('close-overwrite-confirm');
      if (closeBtn) {
        closeBtn.removeEventListener('click', this.closeOverwriteHandler);
      }
        this.closeOverwriteHandler = null;
      }
      if (this.useDifferentNameHandler) {
      var differentNameBtn = document.getElementById('use-different-name');
      if (differentNameBtn) {
        differentNameBtn.removeEventListener('click', this.useDifferentNameHandler);
      }
        this.useDifferentNameHandler = null;
      }
      if (this.overwriteConfirmHandler) {
      var overwriteConfirmBtn = document.getElementById('overwrite-confirm');
      if (overwriteConfirmBtn) {
        overwriteConfirmBtn.removeEventListener('click', this.overwriteConfirmHandler);
      }
        this.overwriteConfirmHandler = null;
      }
      if (this.overwriteKeyHandler) {
        document.removeEventListener('keydown', this.overwriteKeyHandler);
        this.overwriteKeyHandler = null;
      }
  };
  
    // æ·»åŠ éµç›¤å¿«æ·éµæ”¯æŒ
  FlashcardApp.prototype.handleOverwriteKeyboard = function(event) {
    var overwriteModal = document.getElementById('overwrite-confirm-modal');
    if (overwriteModal && overwriteModal.style.display === 'flex') {
        if (event.key === 'Escape') {
          event.preventDefault();
          this.closeOverwriteConfirmModal();
        } else if (event.key === 'Enter') {
          event.preventDefault();
          // Enter éµé»˜èªé¸æ“‡ä½¿ç”¨ä¸åŒåç¨±ï¼ˆè¼ƒå®‰å…¨çš„é¸é …ï¼‰
          this.closeOverwriteConfirmModal();
          this.suggestAlternativeName();
        }
      }
  };
  
  FlashcardApp.prototype.suggestAlternativeName = function() {
    var sheetNameInput = document.getElementById('export-sheet-name');
      if (sheetNameInput) {
        // ç”Ÿæˆå»ºè­°çš„æ›¿ä»£åç¨±
      var currentName = sheetNameInput.value.trim();
      var suggestedName = this.generateAlternativeSheetName(currentName);
        
        // æ›´æ–°è¼¸å…¥æ¡†å€¼ç‚ºå»ºè­°åç¨±
        sheetNameInput.value = suggestedName;
        sheetNameInput.focus();
        sheetNameInput.select(); // é¸å–ç¾æœ‰æ–‡å­—ï¼Œæ–¹ä¾¿ç”¨æˆ¶æ›¿æ›
        
        // æ·»åŠ éŒ¯èª¤æ¨£å¼é¡
      var settingControl = sheetNameInput.closest('.setting-control');
        if (settingControl) {
          settingControl.classList.add('export-error');
        }
        
        // æ›´æ–°æç¤ºæ–‡å­—å’Œæ¨£å¼
      var hintElement = document.getElementById('sheet-name-hint');
        if (hintElement) {
          hintElement.innerHTML = 'ğŸ’¡ å·²è‡ªå‹•å»ºè­°æ–°åç¨±ï¼Œæ‚¨å¯ä»¥ä¿®æ”¹å¾Œé‡æ–°åŒ¯å‡º';
          hintElement.className = 'sheet-name-hint error';
        }
        
        // ç§»é™¤éŒ¯èª¤æ¨£å¼ï¼ˆç•¶ç”¨æˆ¶é–‹å§‹è¼¸å…¥æ™‚ï¼‰
      var removeErrorStyle = function() {
          if (settingControl) {
            settingControl.classList.remove('export-error');
          }
          if (hintElement) {
            hintElement.innerHTML = 'ğŸ’¡ å¦‚æœå·¥ä½œè¡¨å·²å­˜åœ¨ï¼Œç³»çµ±æœƒè©¢å•æ‚¨æ˜¯å¦è¦è¦†å¯«';
            hintElement.className = 'sheet-name-hint normal';
          }
          sheetNameInput.removeEventListener('input', removeErrorStyle);
        };
        sheetNameInput.addEventListener('input', removeErrorStyle);
      }
  };
  
  FlashcardApp.prototype.generateAlternativeSheetName = function(originalName) {
    var now = new Date();
    var hours = now.getHours().toString();
    var minutes = now.getMinutes().toString();
    
    // ES5 ç‰ˆæœ¬çš„ padStart
    if (hours.length < 2) hours = '0' + hours;
    if (minutes.length < 2) minutes = '0' + minutes;
    
    var timestamp = hours + minutes;
      
      // å¦‚æœåŸåç¨±åŒ…å«æ™‚é–“æˆ³è¨˜ï¼Œå‰‡æ›´æ–°æ™‚é–“æˆ³è¨˜
    var timePattern = /_\d{4}$/;
      if (timePattern.test(originalName)) {
      return originalName.replace(timePattern, '_' + timestamp);
      } else {
        // å¦å‰‡æ·»åŠ æ™‚é–“æˆ³è¨˜
      return originalName + '_' + timestamp;
    }
  };
  
</script>

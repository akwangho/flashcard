<!-- script-filter.html -->
<script>
  /**
   * @module script-filter
   * @description ç¯©é¸èˆ‡ SRS æ¨¡çµ„ï¼šè¤‡ç¿’æ™‚é–“ç¯©é¸ã€ä¸ç†Ÿç¨‹åº¦ç¯©é¸ã€è¦æœƒæ‹¼ç¯©é¸ã€
   *   ç¯©é¸æŒ‡ç¤ºå™¨ã€ç·¨è¼¯å–®å­—åŠŸèƒ½ã€é–“éš”é‡è¤‡ç³»çµ± (Leitner Box)ã€å¿«é€Ÿè¤‡ç¿’ã€‚
   *
   * @dependencies script-core.html (FlashcardApp, APP_CONSTANTS, formatDateYYYYMMDD)
   * @provides FlashcardApp.prototype: getTodayDateString, markWordAsReviewed,
   *   syncReviewDates, applyAllFilters, getFilterCutoffDate, countWordsForFilter,
   *   openReviewFilterModal, openDifficultyFilterModal, openEditWordModal,
   *   getBoxInterval, updateSrsData, getDueWords, startSrsReview ...
   */

  // ===========================================
  // è¤‡ç¿’æ™‚é–“ç¯©é¸åŠŸèƒ½
  // ===========================================

  // å–å¾—ä»Šå¤©çš„æ—¥æœŸå­—ä¸² YYYY-MM-DDï¼ˆä½¿ç”¨å…±ç”¨å·¥å…·å‡½å¼ï¼‰
  FlashcardApp.prototype.getTodayDateString = function() {
    return formatDateYYYYMMDD(new Date());
  };

  // æ¨™è¨˜å–®å­—ç‚ºå·²è¤‡ç¿’ï¼ˆè¨˜éŒ„åˆ°è¨˜æ†¶é«”ï¼Œç¨å¾Œæ‰¹æ¬¡åŒæ­¥ï¼‰
  FlashcardApp.prototype.markWordAsReviewed = function(word) {
    if (!word || !word.sheetName || word.sheetName === 'Demo') return;
    
    var key = word.sheetName + ':' + word.originalRowIndex;
    var today = this.getTodayDateString();
    
    // é¿å…åŒä¸€è¼ªé‡è¤‡è¨˜éŒ„
    if (this.reviewedInSession[key] === today) return;
    
    this.reviewedInSession[key] = today;
    
    // åŒæ™‚æ›´æ–°è¨˜æ†¶é«”ä¸­çš„ word ç‰©ä»¶
    word.lastReviewDate = today;
    
    // æ›´æ–° SRS è³‡æ–™
    this.updateSrsData(word);
    
    // æª¢æŸ¥æ˜¯å¦é”åˆ°åŒæ­¥é–¾å€¼
    var count = 0;
    for (var k in this.reviewedInSession) {
      if (this.reviewedInSession.hasOwnProperty(k)) {
        count++;
      }
    }
    
    if (count >= this.reviewSyncThreshold && !this.reviewSyncPending) {
      console.log('å·²è¤‡ç¿’å–®å­—é”åˆ°', this.reviewSyncThreshold, 'å€‹ï¼Œè‡ªå‹•åŒæ­¥');
      this.syncReviewDates();
    }
  };

  // æ‰¹æ¬¡åŒæ­¥è¤‡ç¿’æ—¥æœŸåˆ° Google Sheet
  FlashcardApp.prototype.syncReviewDates = function() {
    var keys = [];
    for (var k in this.reviewedInSession) {
      if (this.reviewedInSession.hasOwnProperty(k)) {
        keys.push(k);
      }
    }
    
    if (keys.length === 0 || this.reviewSyncPending) return;
    if (!this.sheetSettings.sheetId) return;
    
    console.log('åŒæ­¥è¤‡ç¿’æ—¥æœŸï¼Œæ•¸é‡:', keys.length);
    this.reviewSyncPending = true;
    
    var updates = [];
    for (var i = 0; i < keys.length; i++) {
      var parts = keys[i].split(':');
      updates.push({
        sheetName: parts[0],
        rowIndex: parseInt(parts[1], 10),
        date: this.reviewedInSession[keys[i]]
      });
    }
    
    var self = this;
    var currentBatch = {}; // ä¿å­˜ç›®å‰é€™æ‰¹çš„ keys
    for (var j = 0; j < keys.length; j++) {
      currentBatch[keys[j]] = true;
    }
    
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('è¤‡ç¿’æ—¥æœŸåŒæ­¥çµæœ:', result);
        self.reviewSyncPending = false;
        
        // åªæ¸…é™¤å·²æˆåŠŸåŒæ­¥çš„é …ç›®
        if (result && result.success) {
          for (var k in currentBatch) {
            if (currentBatch.hasOwnProperty(k)) {
              delete self.reviewedInSession[k];
            }
          }
        }
      })
      .withFailureHandler(function(error) {
        console.error('è¤‡ç¿’æ—¥æœŸåŒæ­¥å¤±æ•—:', error);
        self.reviewSyncPending = false;
      })
      .batchUpdateReviewDates(this.sheetSettings.sheetId, updates);
  };

  // å¥—ç”¨æ‰€æœ‰ç¯©é¸æ¢ä»¶ï¼ˆä¸ç†Ÿå–®å­— + è¤‡ç¿’æ™‚é–“ï¼‰
  FlashcardApp.prototype.applyAllFilters = function(words) {
    var filtered = words.slice();
    var self = this;
    
    // ç¯©é¸ 1ï¼šä¸ç†Ÿç¨‹åº¦ç¯©é¸
    if (this.difficultyFilter === -1) {
      // ç‰¹æ®Šç¯©é¸ï¼šåªé¡¯ç¤ºéå¸¸ç†Ÿï¼ˆ-1ï¼‰çš„å–®å­—
      filtered = filtered.filter(function(w) {
        return w.difficultyLevel === -1;
      });
    } else {
      // é è¨­æ’é™¤ -1ï¼ˆéå¸¸ç†Ÿï¼‰çš„å–®å­—ï¼Œåªæœ‰æ˜ç¢ºç¯©é¸ -1 æ™‚æ‰é¡¯ç¤º
      filtered = filtered.filter(function(w) {
        return w.difficultyLevel !== -1;
      });
      // å†å¥—ç”¨ >= ç¯©é¸
      if (this.difficultyFilter > 0) {
        filtered = filtered.filter(function(w) {
          return (w.difficultyLevel || 0) >= self.difficultyFilter;
        });
      }
    }
    
    // ç¯©é¸ 2ï¼šè¤‡ç¿’æ™‚é–“ç¯©é¸
    if (this.reviewFilter !== 'all') {
      var cutoffDate = this.getFilterCutoffDate(this.reviewFilter);
      filtered = filtered.filter(function(w) {
        if (self.reviewFilter === 'never') {
          return !w.lastReviewDate || w.lastReviewDate === '';
        }
        // å¾æœªè¤‡ç¿’çš„å–®å­—ä¹ŸåŒ…å«åœ¨æ™‚é–“ç¯©é¸ä¸­ï¼ˆè¦–ç‚ºæ›´ä¹…æ²’è¤‡ç¿’ï¼‰
        if (!w.lastReviewDate || w.lastReviewDate === '') {
          return true;
        }
        // æ¯”è¼ƒæ—¥æœŸå­—ä¸² YYYY-MM-DDï¼ˆå­—ä¸²æ¯”è¼ƒå³å¯ï¼‰
        return w.lastReviewDate < cutoffDate;
      });
    }
    
    // ç¯©é¸ 3ï¼šè¦æœƒæ‹¼ç¯©é¸
    if (this.mustSpellFilter) {
      filtered = filtered.filter(function(w) {
        return w.mustSpell;
      });
    }
    
    return filtered;
  };

  // å–å¾—ç¯©é¸æˆªæ­¢æ—¥æœŸ
  FlashcardApp.prototype.getFilterCutoffDate = function(filterType) {
    var now = new Date();
    var cutoff;
    
    var days = APP_CONSTANTS.FILTER_DAYS[filterType];
    if (!days) return '9999-12-31'; // ä¸ç¯©é¸
    
    cutoff = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
    return formatDateYYYYMMDD(cutoff);
  };

  // è¨ˆç®—å„è¤‡ç¿’æ™‚é–“ç¯©é¸æ¢ä»¶ç¬¦åˆçš„å–®å­—æ•¸é‡
  FlashcardApp.prototype.countWordsForFilter = function(filterType) {
    var words = this.words;
    
    // å¦‚æœåŒæ™‚å•Ÿç”¨äº†ä¸ç†Ÿç¨‹åº¦ç¯©é¸ï¼Œå…ˆå¥—ç”¨
    if (this.difficultyFilter === -1) {
      words = words.filter(function(w) {
        return w.difficultyLevel === -1;
      });
    } else {
      // é è¨­æ’é™¤ -1 çš„å–®å­—
      words = words.filter(function(w) {
        return w.difficultyLevel !== -1;
      });
      if (this.difficultyFilter > 0) {
        var minLevel = this.difficultyFilter;
        words = words.filter(function(w) {
          return (w.difficultyLevel || 0) >= minLevel;
        });
      }
    }
    
    // å¦‚æœåŒæ™‚å•Ÿç”¨äº†è¦æœƒæ‹¼ç¯©é¸ï¼Œå…ˆå¥—ç”¨
    if (this.mustSpellFilter) {
      words = words.filter(function(w) {
        return w.mustSpell;
      });
    }
    
    if (filterType === 'all') {
      return words.length;
    }
    
    if (filterType === 'never') {
      return words.filter(function(w) {
        return !w.lastReviewDate || w.lastReviewDate === '';
      }).length;
    }
    
    var cutoffDate = this.getFilterCutoffDate(filterType);
    return words.filter(function(w) {
      if (!w.lastReviewDate || w.lastReviewDate === '') return true;
      return w.lastReviewDate < cutoffDate;
    }).length;
  };

  // é–‹å•Ÿè¤‡ç¿’æ™‚é–“ç¯©é¸æ¨¡æ…‹æ¡†
  FlashcardApp.prototype.openReviewFilterModal = function() {
    console.log('é–‹å•Ÿè¤‡ç¿’æ™‚é–“ç¯©é¸æ¨¡æ…‹æ¡†');
    this.pauseTimer();
    
    var modal = document.getElementById('review-filter-modal');
    if (!modal) return;
    
    // æ›´æ–°å„é¸é …çš„å–®å­—æ•¸é‡
    var filters = ['all', 'never', '2weeks', '1month', '3months', '6months'];
    for (var i = 0; i < filters.length; i++) {
      var countEl = document.getElementById('review-count-' + filters[i]);
      if (countEl) {
        var count = this.countWordsForFilter(filters[i]);
        countEl.textContent = '(' + count + ' å€‹)';
      }
    }
    
    // è¨­å®šç›®å‰é¸ä¸­çš„ç¯©é¸æ¢ä»¶
    var radios = modal.querySelectorAll('input[name="review-filter"]');
    for (var j = 0; j < radios.length; j++) {
      radios[j].checked = (radios[j].value === this.reviewFilter);
    }
    
    modal.style.display = 'flex';
    
    // è¨­ç½®æ¨¡æ…‹æ¡†äº‹ä»¶ï¼ˆå¦‚æœå°šæœªè¨­ç½®ï¼‰
    this.setupReviewFilterListeners();
  };

  // é—œé–‰è¤‡ç¿’æ™‚é–“ç¯©é¸æ¨¡æ…‹æ¡†
  FlashcardApp.prototype.closeReviewFilterModal = function() {
    closeModalById(this, 'review-filter-modal');
  };

  // è¨­ç½®è¤‡ç¿’ç¯©é¸æ¨¡æ…‹æ¡†äº‹ä»¶ç›£è½å™¨
  FlashcardApp.prototype.setupReviewFilterListeners = function() {
    if (this._reviewFilterListenersSetup) return;
    this._reviewFilterListenersSetup = true;
    
    var self = this;
    var modal = document.getElementById('review-filter-modal');
    var closeBtn = document.getElementById('close-review-filter');
    var cancelBtn = document.getElementById('cancel-review-filter');
    var applyBtn = document.getElementById('apply-review-filter');
    
    if (closeBtn) {
      closeBtn.addEventListener('click', function() { self.closeReviewFilterModal(); });
    }
    if (cancelBtn) {
      cancelBtn.addEventListener('click', function() { self.closeReviewFilterModal(); });
    }
    if (applyBtn) {
      applyBtn.addEventListener('click', function() { self.applyReviewFilterFromModal(); });
    }
    if (modal) {
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          self.closeReviewFilterModal();
        }
      });
    }
  };

  // å¾æ¨¡æ…‹æ¡†å¥—ç”¨ç¯©é¸æ¢ä»¶
  FlashcardApp.prototype.applyReviewFilterFromModal = function() {
    var modal = document.getElementById('review-filter-modal');
    if (!modal) return;
    
    var radios = modal.querySelectorAll('input[name="review-filter"]');
    var selectedFilter = 'all';
    for (var i = 0; i < radios.length; i++) {
      if (radios[i].checked) {
        selectedFilter = radios[i].value;
        break;
      }
    }
    
    console.log('å¥—ç”¨è¤‡ç¿’æ™‚é–“ç¯©é¸:', selectedFilter);
    this.reviewFilter = selectedFilter;
    
    // æ›´æ–°é¸å–®ä¸­çš„ç¯©é¸æŒ‰éˆ•æ–‡å­—ï¼ˆé¡¯ç¤ºç›®å‰çš„ç¯©é¸ç‹€æ…‹ï¼‰
    this.updateReviewFilterButtonText();
    
    this.closeReviewFilterModal();
    
    // é‡æ–°æ‰“äº‚ä¸¦å¥—ç”¨ç¯©é¸ï¼Œé–‹å§‹æ–°å›åˆ
    this.shuffleArray(this.words);
    this.currentWords = this.applyAllFilters(this.words);
    this.currentIndex = 0;
    this.removedWords = [];
    
    if (this.currentWords.length === 0) {
      var filterMsg = 'æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„å–®å­—ï¼ç¯©é¸å·²é‡è¨­ç‚ºã€Œå…¨éƒ¨ã€ã€‚';
      alert(filterMsg);
      this.reviewFilter = 'all';
      this.updateReviewFilterButtonText();
      this.currentWords = this.applyAllFilters(this.words);
    }
    
    this.displayCurrentWord();
    this.updateButtonStates();
    this.renderDifficultyLevel();
    this.updateActiveFilterDisplay();
  };

  // æ›´æ–°é¸å–®ä¸­ç¯©é¸æŒ‰éˆ•çš„æ–‡å­—
  FlashcardApp.prototype.updateReviewFilterButtonText = function() {
    var btn = document.getElementById('review-filter-btn');
    if (!btn) return;
    
    var labels = {
      'all': 'ğŸ“… è¤‡ç¿’æ™‚é–“ç¯©é¸',
      'never': 'ğŸ“… ç¯©é¸ï¼šå¾æœªè¤‡ç¿’',
      '2weeks': 'ğŸ“… ç¯©é¸ï¼šè¶…é2é€±',
      '1month': 'ğŸ“… ç¯©é¸ï¼šè¶…é1å€‹æœˆ',
      '3months': 'ğŸ“… ç¯©é¸ï¼šè¶…é3å€‹æœˆ',
      '6months': 'ğŸ“… ç¯©é¸ï¼šè¶…é6å€‹æœˆ'
    };
    
    btn.textContent = labels[this.reviewFilter] || labels['all'];
    
    // å¦‚æœæœ‰ç¯©é¸æ¢ä»¶å•Ÿç”¨ï¼Œåœ¨æŒ‰éˆ•ä¸ŠåŠ ä¸Šæ¨™è¨˜
    if (this.reviewFilter !== 'all') {
      btn.style.color = '#FFA500';
    } else {
      btn.style.color = '';
    }
  };

  // ===================================================================
  // ä¸ç†Ÿç¨‹åº¦ç¯©é¸æ¨¡æ…‹æ¡†
  // ===================================================================

  // é–‹å•Ÿä¸ç†Ÿç¨‹åº¦ç¯©é¸æ¨¡æ…‹æ¡†
  FlashcardApp.prototype.openDifficultyFilterModal = function() {
    console.log('é–‹å•Ÿä¸ç†Ÿç¨‹åº¦ç¯©é¸æ¨¡æ…‹æ¡†');
    this.pauseTimer();
    
    var modal = document.getElementById('difficulty-filter-modal');
    if (!modal) return;
    
    // æ›´æ–°å„é¸é …çš„å–®å­—æ•¸é‡
    var levels = [-1, 0, 1, 3, 5, 7, 10];
    for (var i = 0; i < levels.length; i++) {
      var countId = 'diff-count-' + (levels[i] === -1 ? 'n1' : levels[i]);
      var countEl = document.getElementById(countId);
      if (countEl) {
        var count = this.countWordsForDifficultyFilter(levels[i]);
        countEl.textContent = '(' + count + ' å€‹)';
      }
    }
    
    // è¨­å®šç›®å‰é¸ä¸­çš„ç¯©é¸æ¢ä»¶
    var radios = modal.querySelectorAll('input[name="difficulty-filter"]');
    for (var j = 0; j < radios.length; j++) {
      radios[j].checked = (parseInt(radios[j].value) === this.difficultyFilter);
    }
    
    modal.style.display = 'flex';
    this.setupDifficultyFilterListeners();
  };

  // é—œé–‰ä¸ç†Ÿç¨‹åº¦ç¯©é¸æ¨¡æ…‹æ¡†
  FlashcardApp.prototype.closeDifficultyFilterModal = function() {
    closeModalById(this, 'difficulty-filter-modal');
  };

  // è¨­ç½®ä¸ç†Ÿç¨‹åº¦ç¯©é¸æ¨¡æ…‹æ¡†äº‹ä»¶ç›£è½å™¨
  FlashcardApp.prototype.setupDifficultyFilterListeners = function() {
    if (this._difficultyFilterListenersSetup) return;
    this._difficultyFilterListenersSetup = true;
    
    var self = this;
    var modal = document.getElementById('difficulty-filter-modal');
    var closeBtn = document.getElementById('close-difficulty-filter');
    var cancelBtn = document.getElementById('cancel-difficulty-filter');
    var applyBtn = document.getElementById('apply-difficulty-filter');
    
    if (closeBtn) {
      closeBtn.addEventListener('click', function() { self.closeDifficultyFilterModal(); });
    }
    if (cancelBtn) {
      cancelBtn.addEventListener('click', function() { self.closeDifficultyFilterModal(); });
    }
    if (applyBtn) {
      applyBtn.addEventListener('click', function() { self.applyDifficultyFilterFromModal(); });
    }
    if (modal) {
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          self.closeDifficultyFilterModal();
        }
      });
    }
  };

  // å¾æ¨¡æ…‹æ¡†å¥—ç”¨ä¸ç†Ÿç¨‹åº¦ç¯©é¸
  FlashcardApp.prototype.applyDifficultyFilterFromModal = function() {
    var modal = document.getElementById('difficulty-filter-modal');
    if (!modal) return;
    
    var radios = modal.querySelectorAll('input[name="difficulty-filter"]');
    var selectedFilter = 0;
    for (var i = 0; i < radios.length; i++) {
      if (radios[i].checked) {
        selectedFilter = parseInt(radios[i].value);
        break;
      }
    }
    
    console.log('å¥—ç”¨ä¸ç†Ÿç¨‹åº¦ç¯©é¸:', selectedFilter);
    this.difficultyFilter = selectedFilter;
    
    this.updateDifficultyFilterButtonText();
    this.closeDifficultyFilterModal();
    
    // é‡æ–°æ‰“äº‚ä¸¦å¥—ç”¨ç¯©é¸
    this.shuffleArray(this.words);
    this.currentWords = this.applyAllFilters(this.words);
    this.currentIndex = 0;
    this.removedWords = [];
    
    if (this.currentWords.length === 0) {
      alert('æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„å–®å­—ï¼ç¯©é¸å·²é‡è¨­ç‚ºã€Œå…¨éƒ¨ã€ã€‚');
      this.difficultyFilter = 0;
      this.updateDifficultyFilterButtonText();
      this.currentWords = this.applyAllFilters(this.words);
    }
    
    this.displayCurrentWord();
    this.updateButtonStates();
    this.renderDifficultyLevel();
    this.updateActiveFilterDisplay();
  };

  // è¨ˆç®—ä¸ç†Ÿç¨‹åº¦ç¯©é¸çš„å–®å­—æ•¸é‡
  FlashcardApp.prototype.countWordsForDifficultyFilter = function(minLevel) {
    var words = this.words;
    
    // å¦‚æœåŒæ™‚å•Ÿç”¨äº†è¤‡ç¿’æ™‚é–“ç¯©é¸ï¼Œå…ˆå¥—ç”¨
    if (this.reviewFilter !== 'all') {
      var self = this;
      var cutoffDate = this.getFilterCutoffDate(this.reviewFilter);
      words = words.filter(function(w) {
        if (self.reviewFilter === 'never') {
          return !w.lastReviewDate || w.lastReviewDate === '';
        }
        if (!w.lastReviewDate || w.lastReviewDate === '') return true;
        return w.lastReviewDate < cutoffDate;
      });
    }
    
    // å¦‚æœåŒæ™‚å•Ÿç”¨äº†è¦æœƒæ‹¼ç¯©é¸ï¼Œå…ˆå¥—ç”¨
    if (this.mustSpellFilter) {
      words = words.filter(function(w) {
        return w.mustSpell;
      });
    }
    
    // ç‰¹æ®Šï¼š-1 ç¯©é¸åªè¨ˆç®— difficultyLevel === -1 çš„å–®å­—
    if (minLevel === -1) {
      return words.filter(function(w) {
        return w.difficultyLevel === -1;
      }).length;
    }
    
    // 0 = å…¨éƒ¨ï¼ˆä½†æ’é™¤ -1ï¼‰
    if (minLevel === 0) {
      return words.filter(function(w) {
        return w.difficultyLevel !== -1;
      }).length;
    }
    
    // >= minLevelï¼ˆæ’é™¤ -1ï¼‰
    return words.filter(function(w) {
      return w.difficultyLevel !== -1 && (w.difficultyLevel || 0) >= minLevel;
    }).length;
  };

  // æ›´æ–°ä¸ç†Ÿç¨‹åº¦ç¯©é¸æŒ‰éˆ•æ–‡å­—
  FlashcardApp.prototype.updateDifficultyFilterButtonText = function() {
    var btn = document.getElementById('difficulty-filter-btn');
    if (!btn) return;
    
    if (this.difficultyFilter === -1) {
      btn.textContent = 'â­ ç¯©é¸ï¼šéå¸¸ç†Ÿ';
      btn.style.color = '#00CC00';
    } else if (this.difficultyFilter > 0) {
      btn.textContent = 'â­ ç¯©é¸ï¼šâ˜…' + this.difficultyFilter + ' ä»¥ä¸Š';
      btn.style.color = '#FFA500';
    } else {
      btn.textContent = 'â­ ä¸ç†Ÿç¨‹åº¦ç¯©é¸';
      btn.style.color = '';
    }
  };

  // ===================================================================
  // è¦æœƒæ‹¼ç¯©é¸
  // ===================================================================

  // åˆ‡æ›è¦æœƒæ‹¼ç¯©é¸
  FlashcardApp.prototype.toggleMustSpellFilter = function() {
    this.mustSpellFilter = !this.mustSpellFilter;
    console.log('åˆ‡æ›è¦æœƒæ‹¼ç¯©é¸:', this.mustSpellFilter);
    this.updateMustSpellFilterButtonText();
    this.reapplyFilters();
  };

  // æ›´æ–°è¦æœƒæ‹¼ç¯©é¸æŒ‰éˆ•æ–‡å­—
  FlashcardApp.prototype.updateMustSpellFilterButtonText = function() {
    var btn = document.getElementById('must-spell-filter-btn');
    if (!btn) return;
    
    if (this.mustSpellFilter) {
      btn.textContent = 'âœï¸ ç¯©é¸ï¼šè¦æœƒæ‹¼';
      btn.style.color = '#87CEEB';
    } else {
      btn.textContent = 'âœï¸ è¦æœƒæ‹¼ç¯©é¸';
      btn.style.color = '';
    }
  };

  // ===================================================================
  // ç¯©é¸æŒ‡ç¤ºå™¨
  // ===================================================================

  // æ›´æ–°ç¯©é¸æŒ‡ç¤ºå™¨
  FlashcardApp.prototype.updateActiveFilterDisplay = function() {
    var container = document.getElementById('active-filters');
    var textEl = document.getElementById('active-filters-text');
    if (!container || !textEl) return;
    
    var parts = [];
    
    if (this.difficultyFilter === -1) {
      parts.push('â­ éå¸¸ç†Ÿ');
    } else if (this.difficultyFilter > 0) {
      parts.push('â­ â˜…' + this.difficultyFilter + '+');
    }
    
    if (this.reviewFilter !== 'all') {
      var reviewLabels = {
        'never': 'ğŸ“… å¾æœªè¤‡ç¿’',
        '2weeks': 'ğŸ“… >2é€±',
        '1month': 'ğŸ“… >1æœˆ',
        '3months': 'ğŸ“… >3æœˆ',
        '6months': 'ğŸ“… >6æœˆ'
      };
      parts.push(reviewLabels[this.reviewFilter] || '');
    }
    
    if (this.mustSpellFilter) {
      parts.push('âœï¸ è¦æœƒæ‹¼');
    }
    
    if (this.srsReviewActive) {
      parts.push('ğŸ“– å¿«é€Ÿè¤‡ç¿’');
    }
    
    if (parts.length > 0) {
      textEl.textContent = 'ç¯©é¸: ' + parts.join(' | ') + ' (' + this.currentWords.length + 'å€‹)';
      container.style.display = 'flex';
    } else {
      container.style.display = 'none';
    }
  };

  // æ¸…é™¤æ‰€æœ‰ç¯©é¸
  FlashcardApp.prototype.clearAllFilters = function() {
    console.log('æ¸…é™¤æ‰€æœ‰ç¯©é¸æ¢ä»¶');
    this.difficultyFilter = 0;
    this.reviewFilter = 'all';
    this.mustSpellFilter = false;
    this.srsReviewActive = false;
    this.updateDifficultyFilterButtonText();
    this.updateReviewFilterButtonText();
    this.updateMustSpellFilterButtonText();
    this.reapplyFilters();
  };

  // ==========================================================================
  // ç·¨è¼¯å–®å­—åŠŸèƒ½
  // ==========================================================================

  // é–‹å•Ÿç·¨è¼¯å–®å­—æ¨¡æ…‹æ¡†
  FlashcardApp.prototype.openEditWordModal = function() {
    var currentWord = this.currentWords[this.currentIndex];
    if (!currentWord) {
      alert('ç›®å‰æ²’æœ‰å¯ç·¨è¼¯çš„å–®å­—');
      return;
    }

    // è¨˜ä½ç·¨è¼¯å‰çš„æš«åœç‹€æ…‹ï¼Œç·¨è¼¯å®Œæˆå¾Œæ¢å¾©
    this._wasPausedBeforeEdit = this.userPaused;
    if (!this.userPaused) {
      this.userPaused = true;
      this.pauseTimer();
      this.updatePauseButtonState();
    }

    // è¨­ç½®åˆå§‹äº‹ä»¶ç›£è½å™¨ï¼ˆåªéœ€ä¸€æ¬¡ï¼‰
    this.setupEditWordListeners();

    // å¡«å…¥ç•¶å‰å–®å­—è³‡æ–™
    var englishInput = document.getElementById('edit-word-english');
    var chineseInput = document.getElementById('edit-word-chinese');
    var difficultyInput = document.getElementById('edit-word-difficulty');
    var difficultyValue = document.getElementById('edit-word-difficulty-value');
    var imageInput = document.getElementById('edit-word-image');
    var sheetNameEl = document.getElementById('edit-word-sheet-name');

    if (englishInput) englishInput.value = currentWord.english || '';
    if (chineseInput) chineseInput.value = currentWord.chinese || '';
    if (difficultyInput) {
      var diffLevel = (currentWord.difficultyLevel !== undefined && currentWord.difficultyLevel !== null) ? currentWord.difficultyLevel : 0;
      difficultyInput.value = diffLevel;
    }
    if (difficultyValue) {
      var level = (currentWord.difficultyLevel !== undefined && currentWord.difficultyLevel !== null) ? currentWord.difficultyLevel : 0;
      difficultyValue.textContent = level === -1 ? 'éå¸¸ç†Ÿ âœ“' : 'â˜…' + level;
      this.updateEditWordDifficultyColor(level);
    }
    if (imageInput) imageInput.value = currentWord.image || '';
    if (sheetNameEl) sheetNameEl.textContent = currentWord.sheetName || 'æœªçŸ¥';

    var mustSpellToggle = document.getElementById('edit-word-must-spell');
    if (mustSpellToggle) mustSpellToggle.checked = !!currentWord.mustSpell;

    // æ›´æ–°åœ–ç‰‡é è¦½
    this.updateEditWordImagePreview(currentWord.image || '');

    // è¨˜ä½æ­£åœ¨ç·¨è¼¯çš„å–®å­— ID
    this._editingWordId = currentWord.id;

    var modal = document.getElementById('edit-word-modal');
    if (modal) {
      modal.style.display = 'flex';
    }
  };

  // é—œé–‰ç·¨è¼¯å–®å­—æ¨¡æ…‹æ¡†
  FlashcardApp.prototype.closeEditWordModal = function() {
    closeModalById(this, 'edit-word-modal');
    this._editingWordId = undefined;

    // æ¢å¾©ç·¨è¼¯å‰çš„æš«åœç‹€æ…‹
    if (!this._wasPausedBeforeEdit) {
      this.userPaused = false;
      this.updatePauseButtonState();
      this.resumeTimer();
    }
    this._wasPausedBeforeEdit = undefined;
  };

  // æ›´æ–°ä¸ç†Ÿç¨‹åº¦æ»‘æ¡¿çš„é¡¯ç¤ºé¡è‰²
  FlashcardApp.prototype.updateEditWordDifficultyColor = function(level) {
    var valueEl = document.getElementById('edit-word-difficulty-value');
    if (!valueEl) return;

    // ç§»é™¤èˆŠçš„é¡è‰² classï¼ˆåŒ…å« -1ï¼‰
    valueEl.className = valueEl.className.replace('difficulty-level-n1', '').trim();
    for (var i = 0; i <= 10; i++) {
      valueEl.className = valueEl.className.replace('difficulty-level-' + i, '').trim();
    }
    var cls = level === -1 ? 'difficulty-level-n1' : 'difficulty-level-' + level;
    valueEl.className = (valueEl.className + ' ' + cls).trim();
  };

  // è¨­ç½®ç·¨è¼¯å–®å­—æ¨¡æ…‹æ¡†äº‹ä»¶ç›£è½å™¨
  FlashcardApp.prototype.setupEditWordListeners = function() {
    if (this._editWordListenersSetup) return;
    this._editWordListenersSetup = true;

    var self = this;
    var modal = document.getElementById('edit-word-modal');
    var closeBtn = document.getElementById('close-edit-word');
    var cancelBtn = document.getElementById('cancel-edit-word');
    var saveBtn = document.getElementById('save-edit-word');
    var difficultyInput = document.getElementById('edit-word-difficulty');

    if (closeBtn) {
      closeBtn.addEventListener('click', function() { self.closeEditWordModal(); });
    }
    if (cancelBtn) {
      cancelBtn.addEventListener('click', function() { self.closeEditWordModal(); });
    }
    if (saveBtn) {
      saveBtn.addEventListener('click', function() { self.saveEditWord(); });
    }
    if (difficultyInput) {
      var updateDiffDisplay = function() {
        var val = parseInt(difficultyInput.value);
        if (isNaN(val)) val = 0;
        var valueEl = document.getElementById('edit-word-difficulty-value');
        if (valueEl) {
          valueEl.textContent = val === -1 ? 'éå¸¸ç†Ÿ âœ“' : 'â˜…' + val;
          self.updateEditWordDifficultyColor(val);
        }
      };
      difficultyInput.addEventListener('input', updateDiffDisplay);
      // ç›¸å®¹èˆŠç‰ˆç€è¦½å™¨
      difficultyInput.addEventListener('change', updateDiffDisplay);
    }
    // åœ–ç‰‡ URL è¼¸å…¥æ¡†è®Šæ›´æ™‚æ›´æ–°é è¦½
    var imageInput = document.getElementById('edit-word-image');
    if (imageInput) {
      var previewTimer = null;
      var handleImageChange = function() {
        if (previewTimer) clearTimeout(previewTimer);
        previewTimer = setTimeout(function() {
          self.updateEditWordImagePreview(imageInput.value.trim());
        }, APP_CONSTANTS.IMAGE_PREVIEW_DEBOUNCE_MS);
      };
      imageInput.addEventListener('input', handleImageChange);
      imageInput.addEventListener('change', handleImageChange);
    }

    if (modal) {
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          self.closeEditWordModal();
        }
      });
    }
  };

  // æ›´æ–°ç·¨è¼¯æ¨¡æ…‹æ¡†çš„åœ–ç‰‡é è¦½
  FlashcardApp.prototype.updateEditWordImagePreview = function(url) {
    var previewContainer = document.getElementById('edit-word-image-preview');
    var previewImg = document.getElementById('edit-word-image-preview-img');
    var previewError = document.getElementById('edit-word-image-preview-error');
    if (!previewContainer || !previewImg || !previewError) return;

    if (!url) {
      previewContainer.style.display = 'none';
      previewImg.src = '';
      return;
    }

    // é¡¯ç¤ºé è¦½å€ã€éš±è—éŒ¯èª¤
    previewContainer.style.display = 'block';
    previewError.style.display = 'none';
    previewImg.style.display = 'block';

    previewImg.onload = function() {
      previewImg.style.display = 'block';
      previewError.style.display = 'none';
    };
    previewImg.onerror = function() {
      previewImg.style.display = 'none';
      previewError.style.display = 'block';
    };

    previewImg.src = url;
  };

  // å„²å­˜ç·¨è¼¯çš„å–®å­—
  FlashcardApp.prototype.saveEditWord = function() {
    var self = this;
    var wordId = this._editingWordId;
    if (wordId === undefined) return;

    var englishInput = document.getElementById('edit-word-english');
    var chineseInput = document.getElementById('edit-word-chinese');
    var difficultyInput = document.getElementById('edit-word-difficulty');
    var imageInput = document.getElementById('edit-word-image');
    var mustSpellToggle = document.getElementById('edit-word-must-spell');

    var newEnglish = englishInput ? englishInput.value.trim() : '';
    var newChinese = chineseInput ? chineseInput.value.trim() : '';
    var newDifficulty = difficultyInput ? parseInt(difficultyInput.value) : 0;
    if (isNaN(newDifficulty)) newDifficulty = 0;
    var newImage = imageInput ? imageInput.value.trim() : '';
    var newMustSpell = mustSpellToggle ? mustSpellToggle.checked : false;

    if (!newEnglish || !newChinese) {
      alert('å–®å­—å’Œç¿»è­¯ä¸èƒ½ç‚ºç©º');
      return;
    }

    // æ‰¾åˆ°åŸå§‹å–®å­—
    var word = null;
    var wordIdx = -1;
    for (var i = 0; i < this.words.length; i++) {
      if (this.words[i].id === wordId) {
        word = this.words[i];
        wordIdx = i;
        break;
      }
    }

    if (!word) {
      alert('æ‰¾ä¸åˆ°è¦ç·¨è¼¯çš„å–®å­—');
      this.closeEditWordModal();
      return;
    }

    // æº–å‚™æ›´æ–°çš„å±¬æ€§
    var properties = {
      english: newEnglish,
      chinese: newChinese,
      difficultyLevel: newDifficulty,
      imageUrl: newImage,
      mustSpell: newMustSpell
    };

    // æ›´æ–°æœ¬åœ°è³‡æ–™ï¼ˆä¸»é™£åˆ—ï¼‰
    word.english = newEnglish;
    word.chinese = newChinese;
    word.difficultyLevel = newDifficulty;
    word.image = newImage;
    word.mustSpell = newMustSpell;

    // åŒæ­¥æ›´æ–° currentWords ä¸­çš„å°æ‡‰é …ç›®
    for (var j = 0; j < this.currentWords.length; j++) {
      if (this.currentWords[j].id === wordId) {
        this.currentWords[j].english = newEnglish;
        this.currentWords[j].chinese = newChinese;
        this.currentWords[j].difficultyLevel = newDifficulty;
        this.currentWords[j].image = newImage;
        this.currentWords[j].mustSpell = newMustSpell;
        break;
      }
    }

    // å‘¼å«å¾Œç«¯æ›´æ–° Google Sheet
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      var rowIndex = word.originalRowIndex;
      if (rowIndex !== undefined && rowIndex !== -1) {
        var sheetId = this.sheetSettings.sheetId;
        var sheetName = word.sheetName || 'Sheet1';
        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.success) {
              console.log('å–®å­—å±¬æ€§å·²åŒæ­¥åˆ°å¾Œç«¯');
            } else {
              console.error('å¾Œç«¯æ›´æ–°å¤±æ•—:', result ? result.error : 'æœªçŸ¥éŒ¯èª¤');
            }
          })
          .withFailureHandler(function(error) {
            console.error('å¾Œç«¯æ›´æ–°å–®å­—å±¬æ€§å¤±æ•—:', error);
          })
          .updateWordProperties(sheetId, sheetName, rowIndex, properties);
      }
    }

    // æ›´æ–°ç•«é¢é¡¯ç¤º
    this.displayCurrentWord();
    this.renderDifficultyLevel();

    this.closeEditWordModal();
    console.log('å–®å­—å·²æ›´æ–°:', newEnglish, '-', newChinese, 'â˜…' + newDifficulty);
  };

  // ==========================================================================
  // é–“éš”é‡è¤‡ç³»çµ± (Spaced Repetition System - Leitner Box)
  // ==========================================================================

  // Box ç­‰ç´šå°æ‡‰çš„è¤‡ç¿’é–“éš”å¤©æ•¸
  FlashcardApp.prototype.getBoxInterval = function(box) {
    return APP_CONSTANTS.SRS_BOX_INTERVALS[box] || 1;
  };

  // æ ¹æ“šé›£åº¦æ±ºå®šåˆå§‹ Box ç­‰ç´š
  FlashcardApp.prototype.getInitialBox = function(difficulty) {
    if (difficulty === -1) return 5;  // éå¸¸ç†Ÿ
    if (difficulty === 0) return 3;   // ç„¡æ¨™è¨˜
    if (difficulty >= 1 && difficulty <= 3) return 2; // ç•¥ä¸ç†Ÿ
    return 1; // difficulty >= 4ï¼Œå¾ˆä¸ç†Ÿ
  };

  // å¾ localStorage è¼‰å…¥ SRS è³‡æ–™
  FlashcardApp.prototype.loadSrsData = function() {
    try {
      var data = localStorage.getItem(APP_CONSTANTS.STORAGE_KEYS.SRS);
      this.srsData = data ? JSON.parse(data) : {};
    } catch (e) {
      this.srsData = {};
    }
  };

  // å°‡ SRS è³‡æ–™å„²å­˜åˆ° localStorage
  FlashcardApp.prototype.saveSrsData = function() {
    try {
      localStorage.setItem(APP_CONSTANTS.STORAGE_KEYS.SRS, JSON.stringify(this.srsData));
    } catch (e) {
      console.error('SRS è³‡æ–™å„²å­˜å¤±æ•—:', e);
    }
  };

  // å–å¾—å–®å­—çš„ SRS è³‡æ–™
  FlashcardApp.prototype.getSrsForWord = function(word) {
    if (!word || !word.sheetName) return null;
    var key = word.sheetName + ':' + word.originalRowIndex;
    return this.srsData[key] || null;
  };

  // æ›´æ–°å–®å­—çš„ SRS è³‡æ–™ï¼ˆè¤‡ç¿’å¾Œå‘¼å«ï¼‰
  FlashcardApp.prototype.updateSrsData = function(word) {
    if (!word || !word.sheetName || word.sheetName === 'Demo') return;

    var key = word.sheetName + ':' + word.originalRowIndex;
    var entry = this.srsData[key];
    var difficulty = (word.difficultyLevel !== undefined && word.difficultyLevel !== null) ? word.difficultyLevel : 0;

    if (!entry) {
      // é¦–æ¬¡é€²å…¥ SRSï¼šæ ¹æ“šé›£åº¦æ±ºå®šåˆå§‹ Box
      entry = { box: this.getInitialBox(difficulty) };
    } else {
      // æ ¹æ“šé›£åº¦èª¿æ•´ Box
      if (difficulty === -1 || difficulty <= 2) {
        // ç†Ÿæ‚‰ï¼šBox ä¸Šå‡ï¼ˆæœ€é«˜ SRS_MAX_BOXï¼‰
        entry.box = Math.min(APP_CONSTANTS.SRS_MAX_BOX, (entry.box || 1) + 1);
      } else if (difficulty >= 6) {
        // å¾ˆä¸ç†Ÿï¼šå›åˆ° Box 1
        entry.box = 1;
      }
      // difficulty 3-5ï¼šBox ä¸è®Š
    }

    // è¨ˆç®—ä¸‹æ¬¡è¤‡ç¿’æ—¥æœŸ
    var today = new Date();
    var interval = this.getBoxInterval(entry.box);
    var nextDate = new Date(today.getTime() + interval * 24 * 60 * 60 * 1000);
    entry.nextReview = formatDateYYYYMMDD(nextDate);

    this.srsData[key] = entry;
    this.saveSrsData();
  };

  // å–å¾—æ‰€æœ‰ä»Šå¤©åˆ°æœŸ/é€¾æœŸéœ€è¦è¤‡ç¿’çš„å–®å­—
  FlashcardApp.prototype.getDueWords = function() {
    var today = this.getTodayDateString();
    var dueWords = [];

    for (var i = 0; i < this.words.length; i++) {
      var word = this.words[i];
      var srs = this.getSrsForWord(word);

      if (!srs) {
        // å¾æœªé€²å…¥ SRS ç³»çµ±çš„å–®å­—ï¼Œè¦–ç‚ºéœ€è¦è¤‡ç¿’
        dueWords.push(word);
      } else if (srs.nextReview <= today) {
        // å·²åˆ°è¤‡ç¿’æ—¥æœŸ
        dueWords.push(word);
      }
    }

    return dueWords;
  };

  // å–å¾—éœ€è¦è¤‡ç¿’çš„å–®å­—æ•¸é‡
  FlashcardApp.prototype.getDueWordCount = function() {
    return this.getDueWords().length;
  };

  // â˜… å¿«é€Ÿè¤‡ç¿’ï¼šå–å¾—ä¾å„ªå…ˆåº¦æ’åºçš„å»ºè­°è¤‡ç¿’å–®å­—
  // ç¸½æ˜¯å¾å·²è¼‰å…¥çš„å–®å­—ä¸­åˆ—å‡ºæœ€å»ºè­°è¤‡ç¿’çš„å–®å­—ï¼Œä¸æœƒå‡ºç¾ã€Œæ²’æœ‰å–®å­—ã€çš„æƒ…æ³
  // å„ªå…ˆåº¦ï¼š(1) å·²åˆ°æœŸ/é€¾æœŸ (2) å¾æœªè¤‡ç¿’ (3) å°šæœªåˆ°æœŸä½†æœ€æ¥è¿‘çš„
  FlashcardApp.prototype.getRecommendedWords = function() {
    var today = this.getTodayDateString();
    var self = this;
    var wordsWithPriority = [];

    for (var i = 0; i < this.words.length; i++) {
      var word = this.words[i];
      var srs = this.getSrsForWord(word);
      var priority;
      var sortKey;

      if (!srs) {
        // å¾æœªé€²å…¥ SRS ç³»çµ±ï¼šé«˜å„ªå…ˆï¼ˆé¡åˆ¥ 1ï¼‰ï¼Œä¾é›£åº¦æ’åºï¼ˆè¶Šä¸ç†Ÿè¶Šå‰é¢ï¼‰
        var diff = (word.difficultyLevel !== undefined && word.difficultyLevel !== null) ? word.difficultyLevel : 0;
        // difficulty -1 = éå¸¸ç†Ÿï¼Œæ’æœ€å¾Œï¼›0~10 è¶Šé«˜è¶Šä¸ç†Ÿ
        priority = 1;
        sortKey = (diff === -1) ? -1 : diff; // è¶Šé«˜è¶Šå„ªå…ˆ
        wordsWithPriority.push({ word: word, priority: priority, sortKey: sortKey, nextReview: '' });
      } else if (srs.nextReview <= today) {
        // å·²åˆ°æœŸ/é€¾æœŸï¼šæœ€é«˜å„ªå…ˆï¼ˆé¡åˆ¥ 0ï¼‰ï¼Œä¾é€¾æœŸå¤©æ•¸ + box ç­‰ç´šæ’åº
        priority = 0;
        // sortKey: é€¾æœŸè¶Šä¹…è¶Šå„ªå…ˆï¼Œbox è¶Šä½è¶Šå„ªå…ˆ
        sortKey = -(srs.box || 1); // box è¶Šä½ sortKey è¶Šå°ï¼ˆè² å€¼è¶Šå¤§ = è¶Šå„ªå…ˆï¼‰
        wordsWithPriority.push({ word: word, priority: priority, sortKey: sortKey, nextReview: srs.nextReview });
      } else {
        // å°šæœªåˆ°æœŸï¼šä½å„ªå…ˆï¼ˆé¡åˆ¥ 2ï¼‰ï¼Œä¾æœ€è¿‘åˆ°æœŸæ—¥æ’åº
        priority = 2;
        sortKey = 0;
        wordsWithPriority.push({ word: word, priority: priority, sortKey: sortKey, nextReview: srs.nextReview });
      }
    }

    // æ’åºï¼špriority å°çš„åœ¨å‰ â†’ sortKey å¤§çš„åœ¨å‰ â†’ nextReview æ—©çš„åœ¨å‰
    wordsWithPriority.sort(function(a, b) {
      // 1. å„ªå…ˆé¡åˆ¥ï¼š0ï¼ˆå·²åˆ°æœŸï¼‰> 1ï¼ˆæœªè¤‡ç¿’ï¼‰> 2ï¼ˆæœªåˆ°æœŸï¼‰
      if (a.priority !== b.priority) return a.priority - b.priority;
      // 2. åŒé¡åˆ¥å…§æ’åº
      if (a.priority === 0) {
        // å·²åˆ°æœŸï¼šnextReview è¶Šæ—©ï¼ˆè¶Šé€¾æœŸï¼‰è¶Šå„ªå…ˆï¼Œbox è¶Šä½è¶Šå„ªå…ˆ
        if (a.nextReview !== b.nextReview) return a.nextReview < b.nextReview ? -1 : 1;
        return a.sortKey - b.sortKey; // box è¶Šä½ï¼ˆsortKey è¶Šè² ï¼‰è¶Šå‰
      }
      if (a.priority === 1) {
        // æœªè¤‡ç¿’ï¼šdifficulty è¶Šé«˜è¶Šå„ªå…ˆ
        return b.sortKey - a.sortKey;
      }
      // æœªåˆ°æœŸï¼šnextReview è¶Šæ—©è¶Šå„ªå…ˆ
      if (a.nextReview !== b.nextReview) return a.nextReview < b.nextReview ? -1 : 1;
      return 0;
    });

    var result = [];
    for (var j = 0; j < wordsWithPriority.length; j++) {
      result.push(wordsWithPriority[j].word);
    }
    return result;
  };

  // é–‹å§‹å¿«é€Ÿè¤‡ç¿’æ¨¡å¼ï¼ˆä¾å„ªå…ˆåº¦æ’åºï¼Œå–å‰ N å€‹ï¼‰
  FlashcardApp.prototype.startSrsReview = function(count) {
    var recommendedWords = this.getRecommendedWords();

    if (recommendedWords.length === 0) {
      this.showNotification('æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­—', 'info');
      return;
    }

    // å–æŒ‡å®šæ•¸é‡ï¼ˆå·²ä¾å„ªå…ˆåº¦æ’åºï¼Œç›´æ¥å–å‰ N å€‹ï¼‰
    var reviewCount = Math.min(count, recommendedWords.length);
    this.currentWords = recommendedWords.slice(0, reviewCount);
    this.currentIndex = 0;
    this.srsReviewActive = true;

    this.updateActiveFilterDisplay();
    this.displayCurrentWord();
    this.updateProgress();
    this.updateSrsBadge();

    this.closeSrsReviewModal();
    this.showNotification('é–‹å§‹è¤‡ç¿’ ' + reviewCount + ' å€‹å–®å­—', 'success');
    console.log('å¿«é€Ÿè¤‡ç¿’æ¨¡å¼å•Ÿå‹•ï¼Œå…±', reviewCount, 'å€‹å–®å­—');
  };

  // é–‹å•Ÿå¿«é€Ÿè¤‡ç¿’æ¨¡æ…‹æ¡†
  FlashcardApp.prototype.openSrsReviewModal = function() {
    var totalWords = this.words ? this.words.length : 0;
    var dueCount = this.getDueWordCount();
    var modal = document.getElementById('srs-review-modal');
    var countEl = document.getElementById('srs-due-count');
    var optionsEl = document.getElementById('srs-count-options');
    var noDueEl = document.getElementById('srs-no-due');
    var startBtn = document.getElementById('srs-start-btn');

    if (!modal) return;

    // æš«åœè¨ˆæ™‚å™¨
    this._clearDisplayTimer();

    if (totalWords === 0) {
      // æ²’æœ‰è¼‰å…¥ä»»ä½•å–®å­—
      if (countEl) countEl.style.display = 'none';
      if (optionsEl) optionsEl.style.display = 'none';
      if (startBtn) startBtn.style.display = 'none';
      if (noDueEl) noDueEl.style.display = 'block';
    } else {
      // ç¸½æ˜¯é¡¯ç¤ºå¯è¤‡ç¿’çš„å–®å­—ï¼ˆä¾å„ªå…ˆåº¦æ’åºï¼‰
      if (noDueEl) noDueEl.style.display = 'none';
      if (countEl) {
        countEl.style.display = 'block';
        if (dueCount > 0) {
          countEl.textContent = 'å…± ' + totalWords + ' å€‹å–®å­—ï¼Œå…¶ä¸­ ' + dueCount + ' å€‹å»ºè­°å„ªå…ˆè¤‡ç¿’';
        } else {
          countEl.textContent = 'å…± ' + totalWords + ' å€‹å–®å­—ï¼Œä¾è¤‡ç¿’å„ªå…ˆåº¦æ’åˆ—';
        }
      }
      if (optionsEl) optionsEl.style.display = 'block';
      if (startBtn) startBtn.style.display = 'block';

      // æ›´æ–°æ•¸é‡é¸é …ï¼ˆä½¿ç”¨å…¨éƒ¨å–®å­—æ•¸é‡ï¼‰
      this.renderSrsCountOptions(totalWords);
    }

    modal.style.display = 'flex';
  };

  // æ¸²æŸ“ SRS æ•¸é‡é¸é …
  FlashcardApp.prototype.renderSrsCountOptions = function(dueCount) {
    var container = document.getElementById('srs-count-buttons');
    if (!container) return;

    container.innerHTML = '';
    var counts = APP_CONSTANTS.SRS_COUNT_OPTIONS;
    var self = this;
    var selectedCount = null;

    for (var i = 0; i < counts.length; i++) {
      if (counts[i] > dueCount) continue;
      (function(c) {
        var btn = document.createElement('button');
        btn.className = 'srs-count-btn';
        btn.textContent = c;
        btn.setAttribute('data-count', c);
        btn.onclick = function() {
          // æ¸…é™¤å…¶ä»–é¸ä¸­ç‹€æ…‹
          var allBtns = container.querySelectorAll('.srs-count-btn');
          for (var j = 0; j < allBtns.length; j++) {
            allBtns[j].classList.remove('selected');
          }
          btn.classList.add('selected');
          self._srsSelectedCount = c;
        };
        container.appendChild(btn);
      })(counts[i]);
    }

    // å¦‚æœç¸½æ•¸ä¸åœ¨é è¨­é¸é …ä¸­ä¸” <= 100ï¼ŒåŠ å…¥ã€Œå…¨éƒ¨ã€æŒ‰éˆ•
    if (dueCount <= 100) {
      var allBtn = document.createElement('button');
      allBtn.className = 'srs-count-btn';
      allBtn.textContent = 'å…¨éƒ¨ (' + dueCount + ')';
      allBtn.setAttribute('data-count', dueCount);
      allBtn.onclick = function() {
        var allBtns = container.querySelectorAll('.srs-count-btn');
        for (var j = 0; j < allBtns.length; j++) {
          allBtns[j].classList.remove('selected');
        }
        allBtn.classList.add('selected');
        self._srsSelectedCount = dueCount;
      };
      container.appendChild(allBtn);
    }

    // é è¨­é¸å–ç¬¬ä¸€å€‹é¸é …
    var firstBtn = container.querySelector('.srs-count-btn');
    if (firstBtn) {
      firstBtn.classList.add('selected');
      this._srsSelectedCount = parseInt(firstBtn.getAttribute('data-count'), 10);
    }
  };

  // é—œé–‰ SRS è¤‡ç¿’æ¨¡æ…‹æ¡†
  FlashcardApp.prototype.closeSrsReviewModal = function() {
    closeModalById(this, 'srs-review-modal');
  };

  // æ›´æ–° SRS å¾½ç« ï¼ˆé¡¯ç¤ºå¾…è¤‡ç¿’æ•¸é‡ï¼‰
  FlashcardApp.prototype.updateSrsBadge = function() {
    var badge = document.getElementById('srs-due-badge');
    if (!badge) return;

    var count = this.getDueWordCount();
    if (count > 0) {
      badge.textContent = count > 99 ? '99+' : count;
      badge.style.display = 'inline-block';
    } else {
      badge.style.display = 'none';
    }
  };

</script>

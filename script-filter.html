<!-- script-filter.html -->
<script>
  /**
   * @module script-filter
   * @description ç¯©é¸æ¨¡çµ„ï¼šè¤‡ç¿’æ™‚é–“ç¯©é¸ã€ä¸ç†Ÿç¨‹åº¦ç¯©é¸ã€è¦æœƒæ‹¼ç¯©é¸ã€
   *   ç¯©é¸æŒ‡ç¤ºå™¨ã€ç¯©é¸æ¸…é™¤ã€‚
   *
   * @dependencies script-core.html (FlashcardApp, APP_CONSTANTS, formatDateYYYYMMDD, closeModalById)
   * @provides FlashcardApp.prototype: getTodayDateString, markWordAsReviewed,
   *   syncReviewDates, applyAllFilters, getFilterCutoffDate, countWordsForFilter,
   *   openReviewFilterModal, openDifficultyFilterModal, toggleMustSpellFilter,
   *   updateActiveFilterDisplay, clearAllFilters ...
   */

  // ===========================================
  // è¤‡ç¿’æ™‚é–“ç¯©é¸åŠŸèƒ½
  // ===========================================

  // å–å¾—ä»Šå¤©çš„æ—¥æœŸå­—ä¸² YYYY-MM-DDï¼ˆä½¿ç”¨å…±ç”¨å·¥å…·å‡½å¼ï¼‰
  FlashcardApp.prototype.getTodayDateString = function() {
    return formatDateYYYYMMDD(new Date());
  };

  // æ¨™è¨˜å–®å­—ç‚ºå·²è¤‡ç¿’ï¼ˆè¨˜éŒ„åˆ°è¨˜æ†¶é«”ï¼Œç¨å¾Œæ‰¹æ¬¡åŒæ­¥ï¼‰
  FlashcardApp.prototype.markWordAsReviewed = function(word) {
    if (!word || !word.sheetName || word.sheetName === 'Demo') return;
    
    var key = word.sheetName + ':' + word.originalRowIndex;
    var today = this.getTodayDateString();
    
    // é¿å…åŒä¸€è¼ªé‡è¤‡è¨˜éŒ„
    if (this.reviewedInSession[key] === today) return;
    
    this.reviewedInSession[key] = today;
    
    // åŒæ™‚æ›´æ–°è¨˜æ†¶é«”ä¸­çš„ word ç‰©ä»¶
    word.lastReviewDate = today;
    
    // æ›´æ–° SRS è³‡æ–™
    this.updateSrsData(word);
    
    // æª¢æŸ¥æ˜¯å¦é”åˆ°åŒæ­¥é–¾å€¼
    var count = 0;
    for (var k in this.reviewedInSession) {
      if (this.reviewedInSession.hasOwnProperty(k)) {
        count++;
      }
    }
    
    if (count >= this.reviewSyncThreshold && !this.reviewSyncPending) {
      console.log('å·²è¤‡ç¿’å–®å­—é”åˆ°', this.reviewSyncThreshold, 'å€‹ï¼Œè‡ªå‹•åŒæ­¥');
      this.syncReviewDates();
    }
  };

  // æ‰¹æ¬¡åŒæ­¥è¤‡ç¿’æ—¥æœŸåˆ° Google Sheet
  FlashcardApp.prototype.syncReviewDates = function() {
    var keys = [];
    for (var k in this.reviewedInSession) {
      if (this.reviewedInSession.hasOwnProperty(k)) {
        keys.push(k);
      }
    }
    
    if (keys.length === 0 || this.reviewSyncPending) return;
    if (!this.sheetSettings.sheetId) return;
    
    console.log('åŒæ­¥è¤‡ç¿’æ—¥æœŸï¼Œæ•¸é‡:', keys.length);
    this.reviewSyncPending = true;
    
    var updates = [];
    for (var i = 0; i < keys.length; i++) {
      var parts = keys[i].split(':');
      updates.push({
        sheetName: parts[0],
        rowIndex: parseInt(parts[1], 10),
        date: this.reviewedInSession[keys[i]]
      });
    }
    
    var self = this;
    var currentBatch = {}; // ä¿å­˜ç›®å‰é€™æ‰¹çš„ keys
    for (var j = 0; j < keys.length; j++) {
      currentBatch[keys[j]] = true;
    }
    
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('è¤‡ç¿’æ—¥æœŸåŒæ­¥çµæœ:', result);
        self.reviewSyncPending = false;
        
        // åªæ¸…é™¤å·²æˆåŠŸåŒæ­¥çš„é …ç›®
        if (result && result.success) {
          for (var k in currentBatch) {
            if (currentBatch.hasOwnProperty(k)) {
              delete self.reviewedInSession[k];
            }
          }
        }
      })
      .withFailureHandler(function(error) {
        console.error('è¤‡ç¿’æ—¥æœŸåŒæ­¥å¤±æ•—:', error);
        self.reviewSyncPending = false;
      })
      .batchUpdateReviewDates(this.sheetSettings.sheetId, updates);
  };

  // å¥—ç”¨æ‰€æœ‰ç¯©é¸æ¢ä»¶ï¼ˆä¸ç†Ÿå–®å­— + è¤‡ç¿’æ™‚é–“ï¼‰
  FlashcardApp.prototype.applyAllFilters = function(words) {
    var filtered = words.slice();
    var self = this;
    
    // ç¯©é¸ 1ï¼šä¸ç†Ÿç¨‹åº¦ç¯©é¸
    if (this.difficultyFilter === -1) {
      // ç‰¹æ®Šç¯©é¸ï¼šåªé¡¯ç¤ºéå¸¸ç†Ÿï¼ˆ-1ï¼‰çš„å–®å­—
      filtered = filtered.filter(function(w) {
        return w.difficultyLevel === -1;
      });
    } else {
      // é è¨­æ’é™¤ -1ï¼ˆéå¸¸ç†Ÿï¼‰çš„å–®å­—ï¼Œåªæœ‰æ˜ç¢ºç¯©é¸ -1 æ™‚æ‰é¡¯ç¤º
      filtered = filtered.filter(function(w) {
        return w.difficultyLevel !== -1;
      });
      // å†å¥—ç”¨ >= ç¯©é¸
      if (this.difficultyFilter > 0) {
        filtered = filtered.filter(function(w) {
          return (w.difficultyLevel || 0) >= self.difficultyFilter;
        });
      }
    }
    
    // ç¯©é¸ 2ï¼šè¤‡ç¿’æ™‚é–“ç¯©é¸
    if (this.reviewFilter !== 'all') {
      var cutoffDate = this.getFilterCutoffDate(this.reviewFilter);
      filtered = filtered.filter(function(w) {
        if (self.reviewFilter === 'never') {
          return !w.lastReviewDate || w.lastReviewDate === '';
        }
        // å¾æœªè¤‡ç¿’çš„å–®å­—ä¹ŸåŒ…å«åœ¨æ™‚é–“ç¯©é¸ä¸­ï¼ˆè¦–ç‚ºæ›´ä¹…æ²’è¤‡ç¿’ï¼‰
        if (!w.lastReviewDate || w.lastReviewDate === '') {
          return true;
        }
        // æ¯”è¼ƒæ—¥æœŸå­—ä¸² YYYY-MM-DDï¼ˆå­—ä¸²æ¯”è¼ƒå³å¯ï¼‰
        return w.lastReviewDate < cutoffDate;
      });
    }
    
    // ç¯©é¸ 3ï¼šè¦æœƒæ‹¼ç¯©é¸
    if (this.mustSpellFilter) {
      filtered = filtered.filter(function(w) {
        return w.mustSpell;
      });
    }
    
    // ç¯©é¸å¾Œé‡æ–°æ‰“äº‚é †åºï¼Œç¢ºä¿å¤šå·¥ä½œè¡¨çš„å–®å­—å……åˆ†æ··åˆ
    this.shuffleArray(filtered);
    
    return filtered;
  };

  // å–å¾—ç¯©é¸æˆªæ­¢æ—¥æœŸ
  FlashcardApp.prototype.getFilterCutoffDate = function(filterType) {
    var now = new Date();
    var cutoff;
    
    var days = APP_CONSTANTS.FILTER_DAYS[filterType];
    if (!days) return '9999-12-31'; // ä¸ç¯©é¸
    
    cutoff = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
    return formatDateYYYYMMDD(cutoff);
  };

  // è¨ˆç®—å„è¤‡ç¿’æ™‚é–“ç¯©é¸æ¢ä»¶ç¬¦åˆçš„å–®å­—æ•¸é‡
  FlashcardApp.prototype.countWordsForFilter = function(filterType) {
    var words = this.words;
    
    // å¦‚æœåŒæ™‚å•Ÿç”¨äº†ä¸ç†Ÿç¨‹åº¦ç¯©é¸ï¼Œå…ˆå¥—ç”¨
    if (this.difficultyFilter === -1) {
      words = words.filter(function(w) {
        return w.difficultyLevel === -1;
      });
    } else {
      // é è¨­æ’é™¤ -1 çš„å–®å­—
      words = words.filter(function(w) {
        return w.difficultyLevel !== -1;
      });
      if (this.difficultyFilter > 0) {
        var minLevel = this.difficultyFilter;
        words = words.filter(function(w) {
          return (w.difficultyLevel || 0) >= minLevel;
        });
      }
    }
    
    // å¦‚æœåŒæ™‚å•Ÿç”¨äº†è¦æœƒæ‹¼ç¯©é¸ï¼Œå…ˆå¥—ç”¨
    if (this.mustSpellFilter) {
      words = words.filter(function(w) {
        return w.mustSpell;
      });
    }
    
    if (filterType === 'all') {
      return words.length;
    }
    
    if (filterType === 'never') {
      return words.filter(function(w) {
        return !w.lastReviewDate || w.lastReviewDate === '';
      }).length;
    }
    
    var cutoffDate = this.getFilterCutoffDate(filterType);
    return words.filter(function(w) {
      if (!w.lastReviewDate || w.lastReviewDate === '') return true;
      return w.lastReviewDate < cutoffDate;
    }).length;
  };

  // é–‹å•Ÿè¤‡ç¿’æ™‚é–“ç¯©é¸æ¨¡æ…‹æ¡†
  FlashcardApp.prototype.openReviewFilterModal = function() {
    console.log('é–‹å•Ÿè¤‡ç¿’æ™‚é–“ç¯©é¸æ¨¡æ…‹æ¡†');
    this.pauseTimer();
    
    var modal = document.getElementById('review-filter-modal');
    if (!modal) return;
    
    // æ›´æ–°å„é¸é …çš„å–®å­—æ•¸é‡
    var filters = ['all', 'never', '2weeks', '1month', '3months', '6months'];
    for (var i = 0; i < filters.length; i++) {
      var countEl = document.getElementById('review-count-' + filters[i]);
      if (countEl) {
        var count = this.countWordsForFilter(filters[i]);
        countEl.textContent = '(' + count + ' å€‹)';
      }
    }
    
    // è¨­å®šç›®å‰é¸ä¸­çš„ç¯©é¸æ¢ä»¶
    var radios = modal.querySelectorAll('input[name="review-filter"]');
    for (var j = 0; j < radios.length; j++) {
      radios[j].checked = (radios[j].value === this.reviewFilter);
    }
    
    modal.style.display = 'flex';
    
    // è¨­ç½®æ¨¡æ…‹æ¡†äº‹ä»¶ï¼ˆå¦‚æœå°šæœªè¨­ç½®ï¼‰
    this.setupReviewFilterListeners();
  };

  // é—œé–‰è¤‡ç¿’æ™‚é–“ç¯©é¸æ¨¡æ…‹æ¡†
  FlashcardApp.prototype.closeReviewFilterModal = function() {
    closeModalById(this, 'review-filter-modal');
  };

  // è¨­ç½®è¤‡ç¿’ç¯©é¸æ¨¡æ…‹æ¡†äº‹ä»¶ç›£è½å™¨
  FlashcardApp.prototype.setupReviewFilterListeners = function() {
    if (this._reviewFilterListenersSetup) return;
    this._reviewFilterListenersSetup = true;
    
    var self = this;
    var modal = document.getElementById('review-filter-modal');
    var closeBtn = document.getElementById('close-review-filter');
    var cancelBtn = document.getElementById('cancel-review-filter');
    var applyBtn = document.getElementById('apply-review-filter');
    
    if (closeBtn) {
      closeBtn.addEventListener('click', function() { self.closeReviewFilterModal(); });
    }
    if (cancelBtn) {
      cancelBtn.addEventListener('click', function() { self.closeReviewFilterModal(); });
    }
    if (applyBtn) {
      applyBtn.addEventListener('click', function() { self.applyReviewFilterFromModal(); });
    }
    if (modal) {
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          self.closeReviewFilterModal();
        }
      });
    }
  };

  // å¾æ¨¡æ…‹æ¡†å¥—ç”¨ç¯©é¸æ¢ä»¶
  FlashcardApp.prototype.applyReviewFilterFromModal = function() {
    var modal = document.getElementById('review-filter-modal');
    if (!modal) return;
    
    var radios = modal.querySelectorAll('input[name="review-filter"]');
    var selectedFilter = 'all';
    for (var i = 0; i < radios.length; i++) {
      if (radios[i].checked) {
        selectedFilter = radios[i].value;
        break;
      }
    }
    
    console.log('å¥—ç”¨è¤‡ç¿’æ™‚é–“ç¯©é¸:', selectedFilter);
    this.reviewFilter = selectedFilter;
    
    // æ›´æ–°é¸å–®ä¸­çš„ç¯©é¸æŒ‰éˆ•æ–‡å­—ï¼ˆé¡¯ç¤ºç›®å‰çš„ç¯©é¸ç‹€æ…‹ï¼‰
    this.updateReviewFilterButtonText();
    
    this.closeReviewFilterModal();
    
    // é‡æ–°æ‰“äº‚ä¸¦å¥—ç”¨ç¯©é¸ï¼Œé–‹å§‹æ–°å›åˆ
    this.shuffleArray(this.words);
    this.currentWords = this.applyAllFilters(this.words);
    this.currentIndex = 0;
    this.removedWords = [];
    
    if (this.currentWords.length === 0) {
      var filterMsg = 'æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„å–®å­—ï¼ç¯©é¸å·²é‡è¨­ç‚ºã€Œå…¨éƒ¨ã€ã€‚';
      alert(filterMsg);
      this.reviewFilter = 'all';
      this.updateReviewFilterButtonText();
      this.currentWords = this.applyAllFilters(this.words);
    }
    
    this.displayCurrentWord();
    this.updateButtonStates();
    this.renderDifficultyLevel();
    this.updateActiveFilterDisplay();
  };

  // æ›´æ–°é¸å–®ä¸­ç¯©é¸æŒ‰éˆ•çš„æ–‡å­—
  FlashcardApp.prototype.updateReviewFilterButtonText = function() {
    var btn = document.getElementById('review-filter-btn');
    if (!btn) return;
    
    var labels = {
      'all': 'ğŸ“… è¤‡ç¿’æ™‚é–“ç¯©é¸',
      'never': 'ğŸ“… ç¯©é¸ï¼šå¾æœªè¤‡ç¿’',
      '2weeks': 'ğŸ“… ç¯©é¸ï¼šè¶…é2é€±',
      '1month': 'ğŸ“… ç¯©é¸ï¼šè¶…é1å€‹æœˆ',
      '3months': 'ğŸ“… ç¯©é¸ï¼šè¶…é3å€‹æœˆ',
      '6months': 'ğŸ“… ç¯©é¸ï¼šè¶…é6å€‹æœˆ'
    };
    
    btn.textContent = labels[this.reviewFilter] || labels['all'];
    
    // å¦‚æœæœ‰ç¯©é¸æ¢ä»¶å•Ÿç”¨ï¼Œåœ¨æŒ‰éˆ•ä¸ŠåŠ ä¸Šæ¨™è¨˜
    if (this.reviewFilter !== 'all') {
      btn.style.color = '#FFA500';
    } else {
      btn.style.color = '';
    }
  };

  // ===================================================================
  // ä¸ç†Ÿç¨‹åº¦ç¯©é¸æ¨¡æ…‹æ¡†
  // ===================================================================

  // é–‹å•Ÿä¸ç†Ÿç¨‹åº¦ç¯©é¸æ¨¡æ…‹æ¡†
  FlashcardApp.prototype.openDifficultyFilterModal = function() {
    console.log('é–‹å•Ÿä¸ç†Ÿç¨‹åº¦ç¯©é¸æ¨¡æ…‹æ¡†');
    this.pauseTimer();
    
    var modal = document.getElementById('difficulty-filter-modal');
    if (!modal) return;
    
    // æ›´æ–°å„é¸é …çš„å–®å­—æ•¸é‡
    var levels = [-1, 0, 1, 3, 5, 7, 10];
    for (var i = 0; i < levels.length; i++) {
      var countId = 'diff-count-' + (levels[i] === -1 ? 'n1' : levels[i]);
      var countEl = document.getElementById(countId);
      if (countEl) {
        var count = this.countWordsForDifficultyFilter(levels[i]);
        countEl.textContent = '(' + count + ' å€‹)';
      }
    }
    
    // è¨­å®šç›®å‰é¸ä¸­çš„ç¯©é¸æ¢ä»¶
    var radios = modal.querySelectorAll('input[name="difficulty-filter"]');
    for (var j = 0; j < radios.length; j++) {
      radios[j].checked = (parseInt(radios[j].value) === this.difficultyFilter);
    }
    
    modal.style.display = 'flex';
    this.setupDifficultyFilterListeners();
  };

  // é—œé–‰ä¸ç†Ÿç¨‹åº¦ç¯©é¸æ¨¡æ…‹æ¡†
  FlashcardApp.prototype.closeDifficultyFilterModal = function() {
    closeModalById(this, 'difficulty-filter-modal');
  };

  // è¨­ç½®ä¸ç†Ÿç¨‹åº¦ç¯©é¸æ¨¡æ…‹æ¡†äº‹ä»¶ç›£è½å™¨
  FlashcardApp.prototype.setupDifficultyFilterListeners = function() {
    if (this._difficultyFilterListenersSetup) return;
    this._difficultyFilterListenersSetup = true;
    
    var self = this;
    var modal = document.getElementById('difficulty-filter-modal');
    var closeBtn = document.getElementById('close-difficulty-filter');
    var cancelBtn = document.getElementById('cancel-difficulty-filter');
    var applyBtn = document.getElementById('apply-difficulty-filter');
    
    if (closeBtn) {
      closeBtn.addEventListener('click', function() { self.closeDifficultyFilterModal(); });
    }
    if (cancelBtn) {
      cancelBtn.addEventListener('click', function() { self.closeDifficultyFilterModal(); });
    }
    if (applyBtn) {
      applyBtn.addEventListener('click', function() { self.applyDifficultyFilterFromModal(); });
    }
    if (modal) {
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          self.closeDifficultyFilterModal();
        }
      });
    }
  };

  // å¾æ¨¡æ…‹æ¡†å¥—ç”¨ä¸ç†Ÿç¨‹åº¦ç¯©é¸
  FlashcardApp.prototype.applyDifficultyFilterFromModal = function() {
    var modal = document.getElementById('difficulty-filter-modal');
    if (!modal) return;
    
    var radios = modal.querySelectorAll('input[name="difficulty-filter"]');
    var selectedFilter = 0;
    for (var i = 0; i < radios.length; i++) {
      if (radios[i].checked) {
        selectedFilter = parseInt(radios[i].value);
        break;
      }
    }
    
    console.log('å¥—ç”¨ä¸ç†Ÿç¨‹åº¦ç¯©é¸:', selectedFilter);
    this.difficultyFilter = selectedFilter;
    
    this.updateDifficultyFilterButtonText();
    this.closeDifficultyFilterModal();
    
    // é‡æ–°æ‰“äº‚ä¸¦å¥—ç”¨ç¯©é¸
    this.shuffleArray(this.words);
    this.currentWords = this.applyAllFilters(this.words);
    this.currentIndex = 0;
    this.removedWords = [];
    
    if (this.currentWords.length === 0) {
      alert('æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„å–®å­—ï¼ç¯©é¸å·²é‡è¨­ç‚ºã€Œå…¨éƒ¨ã€ã€‚');
      this.difficultyFilter = 0;
      this.updateDifficultyFilterButtonText();
      this.currentWords = this.applyAllFilters(this.words);
    }
    
    this.displayCurrentWord();
    this.updateButtonStates();
    this.renderDifficultyLevel();
    this.updateActiveFilterDisplay();
  };

  // è¨ˆç®—ä¸ç†Ÿç¨‹åº¦ç¯©é¸çš„å–®å­—æ•¸é‡
  FlashcardApp.prototype.countWordsForDifficultyFilter = function(minLevel) {
    var words = this.words;
    
    // å¦‚æœåŒæ™‚å•Ÿç”¨äº†è¤‡ç¿’æ™‚é–“ç¯©é¸ï¼Œå…ˆå¥—ç”¨
    if (this.reviewFilter !== 'all') {
      var self = this;
      var cutoffDate = this.getFilterCutoffDate(this.reviewFilter);
      words = words.filter(function(w) {
        if (self.reviewFilter === 'never') {
          return !w.lastReviewDate || w.lastReviewDate === '';
        }
        if (!w.lastReviewDate || w.lastReviewDate === '') return true;
        return w.lastReviewDate < cutoffDate;
      });
    }
    
    // å¦‚æœåŒæ™‚å•Ÿç”¨äº†è¦æœƒæ‹¼ç¯©é¸ï¼Œå…ˆå¥—ç”¨
    if (this.mustSpellFilter) {
      words = words.filter(function(w) {
        return w.mustSpell;
      });
    }
    
    // ç‰¹æ®Šï¼š-1 ç¯©é¸åªè¨ˆç®— difficultyLevel === -1 çš„å–®å­—
    if (minLevel === -1) {
      return words.filter(function(w) {
        return w.difficultyLevel === -1;
      }).length;
    }
    
    // 0 = å…¨éƒ¨ï¼ˆä½†æ’é™¤ -1ï¼‰
    if (minLevel === 0) {
      return words.filter(function(w) {
        return w.difficultyLevel !== -1;
      }).length;
    }
    
    // >= minLevelï¼ˆæ’é™¤ -1ï¼‰
    return words.filter(function(w) {
      return w.difficultyLevel !== -1 && (w.difficultyLevel || 0) >= minLevel;
    }).length;
  };

  // æ›´æ–°ä¸ç†Ÿç¨‹åº¦ç¯©é¸æŒ‰éˆ•æ–‡å­—
  FlashcardApp.prototype.updateDifficultyFilterButtonText = function() {
    var btn = document.getElementById('difficulty-filter-btn');
    if (!btn) return;
    
    if (this.difficultyFilter === -1) {
      btn.textContent = 'â­ ç¯©é¸ï¼šéå¸¸ç†Ÿ';
      btn.style.color = '#00CC00';
    } else if (this.difficultyFilter > 0) {
      btn.textContent = 'â­ ç¯©é¸ï¼šâ˜…' + this.difficultyFilter + ' ä»¥ä¸Š';
      btn.style.color = '#FFA500';
    } else {
      btn.textContent = 'â­ ä¸ç†Ÿç¨‹åº¦ç¯©é¸';
      btn.style.color = '';
    }
  };

  // ===================================================================
  // è¦æœƒæ‹¼ç¯©é¸
  // ===================================================================

  // åˆ‡æ›è¦æœƒæ‹¼ç¯©é¸
  FlashcardApp.prototype.toggleMustSpellFilter = function() {
    this.mustSpellFilter = !this.mustSpellFilter;
    console.log('åˆ‡æ›è¦æœƒæ‹¼ç¯©é¸:', this.mustSpellFilter);
    this.updateMustSpellFilterButtonText();
    this.reapplyFilters();
  };

  // æ›´æ–°è¦æœƒæ‹¼ç¯©é¸æŒ‰éˆ•æ–‡å­—
  FlashcardApp.prototype.updateMustSpellFilterButtonText = function() {
    var btn = document.getElementById('must-spell-filter-btn');
    if (!btn) return;
    
    if (this.mustSpellFilter) {
      btn.textContent = 'âœï¸ ç¯©é¸ï¼šè¦æœƒæ‹¼';
      btn.style.color = '#87CEEB';
    } else {
      btn.textContent = 'âœï¸ è¦æœƒæ‹¼ç¯©é¸';
      btn.style.color = '';
    }
  };

  // ===================================================================
  // ç¯©é¸æŒ‡ç¤ºå™¨
  // ===================================================================

  // æ›´æ–°ç¯©é¸æŒ‡ç¤ºå™¨
  FlashcardApp.prototype.updateActiveFilterDisplay = function() {
    var container = document.getElementById('active-filters');
    var textEl = document.getElementById('active-filters-text');
    if (!container || !textEl) return;
    
    var parts = [];
    
    if (this.difficultyFilter === -1) {
      parts.push('â­ éå¸¸ç†Ÿ');
    } else if (this.difficultyFilter > 0) {
      parts.push('â­ â˜…' + this.difficultyFilter + '+');
    }
    
    if (this.reviewFilter !== 'all') {
      var reviewLabels = {
        'never': 'ğŸ“… å¾æœªè¤‡ç¿’',
        '2weeks': 'ğŸ“… >2é€±',
        '1month': 'ğŸ“… >1æœˆ',
        '3months': 'ğŸ“… >3æœˆ',
        '6months': 'ğŸ“… >6æœˆ'
      };
      parts.push(reviewLabels[this.reviewFilter] || '');
    }
    
    if (this.mustSpellFilter) {
      parts.push('âœï¸ è¦æœƒæ‹¼');
    }
    
    if (this.srsReviewActive) {
      parts.push('ğŸ“– å¿«é€Ÿè¤‡ç¿’');
    }
    
    if (parts.length > 0) {
      textEl.textContent = 'ç¯©é¸: ' + parts.join(' | ') + ' (' + this.currentWords.length + 'å€‹)';
      container.style.display = 'flex';
    } else {
      container.style.display = 'none';
    }
  };

  // æ¸…é™¤æ‰€æœ‰ç¯©é¸
  FlashcardApp.prototype.clearAllFilters = function() {
    console.log('æ¸…é™¤æ‰€æœ‰ç¯©é¸æ¢ä»¶');
    this.difficultyFilter = 0;
    this.reviewFilter = 'all';
    this.mustSpellFilter = false;
    this.srsReviewActive = false;
    this.updateDifficultyFilterButtonText();
    this.updateReviewFilterButtonText();
    this.updateMustSpellFilterButtonText();
    this.reapplyFilters();
  };


</script>

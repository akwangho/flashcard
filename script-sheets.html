<!-- script-sheets.html -->
<script>
  /**
   * @module script-sheets
   * @description Google Sheet è¨­å®šæ¨¡çµ„ï¼šè¼‰å…¥å·¥ä½œè¡¨æ¸…å–®ï¼ˆå…©éšæ®µï¼šåç¨±â†’å–®å­—æ•¸ï¼‰ã€
   *   Sheet ID æå–èˆ‡é©—è­‰ã€å·¥ä½œè¡¨é¸æ“‡ UIï¼ˆå« Shift å¤šé¸ï¼‰ã€å…¨é¸/æ¸…é™¤ã€
   *   å„²å­˜è¨­å®šä¸¦é‡æ–°è¼‰å…¥å–®å­—ã€‚
   *
   * @dependencies script-core.html (FlashcardApp, APP_CONSTANTS)
   * @provides FlashcardApp.prototype: loadSheetsList, extractSheetId,
   *   renderSheetsList, toggleSheetSelection, toggleSelectAll,
   *   saveSheetSettingsAndClose ...
   */

    // Sheetè¨­å®šç›¸é—œï¼ˆå®Œæ•´å¯¦ç¾ï¼‰
  FlashcardApp.prototype.loadSheetsList = function() {
    // æª¢æŸ¥æ˜¯å¦éœ€è¦ä½¿ç”¨é è¨­è¡¨å–®ï¼ˆä½¿ç”¨è‡ªè¨‚å°è©±æ¡†ï¼Œé¿å…é›¢é–‹å…¨è¢å¹•ï¼‰
    var sheetIdInput = document.getElementById('sheet-id-input');
    if (sheetIdInput && (!sheetIdInput.value || sheetIdInput.value.trim() === '')) {
      var self = this;
      this.customConfirm({
        title: 'ğŸ“‹ ä½¿ç”¨é è¨­è¡¨å–®',
        message: 'Google Sheet æ¬„ä½æ˜¯ç©ºçš„ã€‚\n\næ˜¯å¦è¦ä½¿ç”¨é è¨­çš„ç¯„ä¾‹è¡¨å–®ï¼Ÿ\n\né è¨­è¡¨å–®åŒ…å«å¸¸ç”¨çš„è‹±æ–‡å–®å­—ç¯„ä¾‹ï¼Œå¯ä»¥ç›´æ¥é–‹å§‹ä½¿ç”¨ã€‚',
        confirmText: 'ä½¿ç”¨é è¨­è¡¨å–®',
        cancelText: 'å–æ¶ˆ'
      }, function() {
        // ç”¨æˆ¶é¸æ“‡ä½¿ç”¨é è¨­è¡¨å–®
        var defaultSheetId = APP_CONSTANTS.DEFAULT_SHEETS[0].id;
        sheetIdInput.value = defaultSheetId;
        console.log('ç”¨æˆ¶é¸æ“‡ä½¿ç”¨é è¨­è¡¨å–®ï¼Œå·²å¡«å…¥é è¨­ID:', defaultSheetId);
        // ç¹¼çºŒåŸ·è¡Œè¼‰å…¥æµç¨‹
        self._continueLoadSheetsList();
      }, function() {
        // ç”¨æˆ¶æ‹’çµ•ä½¿ç”¨é è¨­è¡¨å–®
        console.log('ç”¨æˆ¶æ‹’çµ•ä½¿ç”¨é è¨­è¡¨å–®');
        sheetIdInput.focus();
      });
      return;
    }

    this._continueLoadSheetsList();
  };

  // ç¹¼çºŒåŸ·è¡Œè¼‰å…¥å·¥ä½œè¡¨æ¸…å–®ï¼ˆå¾ loadSheetsList æ‹†åˆ†ï¼‰
  FlashcardApp.prototype._continueLoadSheetsList = function() {
    var input = this.validateAndGetSheetInput();
    if (!input) return;

    var elements = this.validateSheetUIElements();
    if (!elements) return;

    try {
      var sheetId = this.extractSheetId(input);
      this.updateSheetLoadingUI(elements, true);
      this.performSheetListRequest(sheetId, elements);
    } catch (error) {
      console.error('loadSheetsList åŸ·è¡Œéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:', error);
      alert('éŒ¯èª¤ï¼š' + error.message);
    }
  };
  
  FlashcardApp.prototype.validateAndGetSheetInput = function() {
    var sheetIdInput = document.getElementById('sheet-id-input');
    if (!sheetIdInput) {
      console.error('æ‰¾ä¸åˆ° sheet-id-input å…ƒç´ ');
      alert('ç³»çµ±éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è¼¸å…¥æ¡†å…ƒç´ ');
      return null;
    }
  
    var input = sheetIdInput.value.trim();
    if (!input) {
      console.warn('ç”¨æˆ¶æœªè¼¸å…¥ä»»ä½•å…§å®¹');
      alert('è«‹è¼¸å…¥ Google Sheet ID æˆ– URL');
      return null;
    }
  
    return input;
  };
  
  FlashcardApp.prototype.validateSheetUIElements = function() {
    var elements = {
      sheetsList: document.getElementById('sheets-list'),
      sheetsGroup: document.getElementById('sheets-selection-group'),
      loadBtn: document.getElementById('load-sheets-btn')
    };
  
    var elementChecks = [
      { element: elements.sheetsList, name: 'sheets-list', error: 'æ‰¾ä¸åˆ°å·¥ä½œè¡¨æ¸…å–®å…ƒç´ ' },
      { element: elements.sheetsGroup, name: 'sheets-selection-group', error: 'æ‰¾ä¸åˆ°å·¥ä½œè¡¨é¸æ“‡çµ„å…ƒç´ ' },
      { element: elements.loadBtn, name: 'load-sheets-btn', error: 'æ‰¾ä¸åˆ°è¼‰å…¥æŒ‰éˆ•' }
    ];
  
    for (var i = 0; i < elementChecks.length; i++) {
      var check = elementChecks[i];
      if (!check.element) {
        console.error('æ‰¾ä¸åˆ° ' + check.name + ' å…ƒç´ ');
        alert('ç³»çµ±éŒ¯èª¤ï¼š' + check.error);
        return null;
      }
    }
  
    return elements;
  };
  
  FlashcardApp.prototype.extractSheetId = function(input) {
    console.log('=== extractSheetId é–‹å§‹åŸ·è¡Œ ===');
    console.log('è¼¸å…¥å…§å®¹:', input);
    
    var trimmedInput = input.trim();
    console.log('å»é™¤ç©ºæ ¼å¾Œ:', trimmedInput);
    
    // å¦‚æœçœ‹èµ·ä¾†åƒæ˜¯ URL
    if (trimmedInput.indexOf('docs.google.com/spreadsheets') !== -1) {
      console.log('æª¢æ¸¬åˆ° Google Sheets URL');
      // å°‹æ‰¾ /d/ å¾Œé¢çš„ ID
      var match = trimmedInput.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
      console.log('æ­£å‰‡è¡¨é”å¼åŒ¹é…çµæœ:', match);
      
      if (match && match[1]) {
        console.log('å¾ URL æå–åˆ° Sheet ID:', match[1]);
        return match[1];
          } else {
        console.error('ç„¡æ³•å¾ URL ä¸­æå– Sheet ID');
        throw new Error('ç„¡æ³•å¾ URL ä¸­æå– Sheet IDï¼Œè«‹ç¢ºèª URL æ ¼å¼æ­£ç¢º');
      }
    }
    
    // å¦‚æœçœ‹èµ·ä¾†åƒæ˜¯ç´” ID (å­—æ¯æ•¸å­—çµ„åˆ)
    var idPattern = /^[a-zA-Z0-9-_]+$/;
    console.log('æª¢æŸ¥æ˜¯å¦ç‚ºç´” IDï¼Œæ¨¡å¼:', idPattern);
    console.log('æ¨¡å¼æ¸¬è©¦çµæœ:', idPattern.test(trimmedInput));
    
    if (idPattern.test(trimmedInput)) {
      console.log('è¼¸å…¥çœ‹èµ·ä¾†æ˜¯ Sheet ID:', trimmedInput);
      return trimmedInput;
    }
    
    console.error('è¼¸å…¥æ ¼å¼ä¸æ­£ç¢º');
    throw new Error('è¼¸å…¥æ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹è¼¸å…¥æœ‰æ•ˆçš„ Google Sheet ID æˆ– URL');
  };
  
  FlashcardApp.prototype.updateSheetLoadingUI = function(elements, isLoading) {
    if (isLoading) {
      // éš±è—éå¿…è¦å€å¡Šï¼Œåªä¿ç•™å·¥ä½œè¡¨æ¸…å–®èˆ‡åº•éƒ¨æŒ‰éˆ•
      var hideIds = ['default-sheets-group', 'recent-sheets-group', 'sheet-id-group', 'load-sheets-group'];
      for (var i = 0; i < hideIds.length; i++) {
        var el = document.getElementById(hideIds[i]);
        if (el) el.style.display = 'none';
      }
      
      // å»ºç«‹æˆ–æ›´æ–°é€²åº¦æ¢å®¹å™¨
      var progressContainer = document.getElementById('sheet-loading-progress-container');
      if (!progressContainer) {
        progressContainer = document.createElement('div');
        progressContainer.id = 'sheet-loading-progress-container';
        progressContainer.className = 'sheet-loading-progress';
        elements.sheetsGroup.insertBefore(progressContainer, elements.sheetsList);
      }
      progressContainer.style.display = 'block';
      progressContainer.innerHTML =
        '<div class="progress-bar indeterminate"><div class="progress-fill" id="sheet-loading-fill"></div></div>' +
        '<div class="loading-text" id="sheet-loading-text">æ­£åœ¨é€£æ¥ Google Sheet...</div>';
      
      elements.sheetsList.innerHTML = '';
      elements.sheetsGroup.style.display = 'block';
      elements.loadBtn.disabled = true;
      elements.loadBtn.textContent = 'è¼‰å…¥ä¸­...';
    } else {
      // éš±è—é€²åº¦æ¢
      var progressContainer = document.getElementById('sheet-loading-progress-container');
      if (progressContainer) progressContainer.style.display = 'none';
      
      this.isLoadingWordCounts = false;
      elements.loadBtn.disabled = false;
      elements.loadBtn.textContent = 'è¼‰å…¥å·¥ä½œè¡¨æ¸…å–®';
    }
  };
  
  FlashcardApp.prototype.performSheetListRequest = function(sheetId, elements) {
    if (!this.validateGoogleScriptEnvironment()) {
      throw new Error('Google Apps Script ç’°å¢ƒä¸å¯ç”¨');
    }

    var self = this;
    
    // Phase 1 è¶…æ™‚
    var phase1Timeout = setTimeout(function() {
      console.error('é€£æ¥ Google Sheet è¶…æ™‚ (' + APP_CONSTANTS.PHASE1_TIMEOUT_MS + 'ms)');
      elements.sheetsList.innerHTML = '<div class="error-text">é€£æ¥è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥æˆ–é‡è©¦</div>';
      self.updateSheetLoadingUI(elements, false);
    }, APP_CONSTANTS.PHASE1_TIMEOUT_MS);
    
    // Phase 1: å–å¾—å·¥ä½œè¡¨åç¨±ï¼ˆå¿«é€Ÿï¼‰
    google.script.run
      .withSuccessHandler(function(result) {
        clearTimeout(phase1Timeout);
        self.handlePhase1Success(result, elements, sheetId);
      })
      .withFailureHandler(function(error) {
        clearTimeout(phase1Timeout);
        self.handleSheetListFailure(error, elements, null);
      })
      .getSheetNamesOnly(sheetId);
  };
  
  // Phase 1 æˆåŠŸï¼šå–å¾—å·¥ä½œè¡¨åç¨±ï¼Œé–‹å§‹ Phase 2 é€ä¸€å–å¾—å–®å­—æ•¸
  FlashcardApp.prototype.handlePhase1Success = function(result, elements, sheetId) {
    console.log('Phase 1 æˆåŠŸï¼šå–å¾—å·¥ä½œè¡¨åç¨±', result);
    
    var spreadsheetName = result.spreadsheetName;
    var sheetNames = result.sheetNames;
    
    // éæ¿¾æ‰éå–®å­—å·¥ä½œè¡¨
    var excludedSheets = APP_CONSTANTS.EXCLUDED_SHEETS;
    var filteredNames = [];
    for (var i = 0; i < sheetNames.length; i++) {
      var shouldExclude = false;
      for (var j = 0; j < excludedSheets.length; j++) {
        if (sheetNames[i] === excludedSheets[j]) {
          shouldExclude = true;
          break;
        }
      }
      if (!shouldExclude) {
        filteredNames.push(sheetNames[i]);
      }
    }
    sheetNames = filteredNames;
    console.log('éæ¿¾å¾Œçš„å·¥ä½œè¡¨åç¨±ï¼ˆæ’é™¤éå–®å­—å·¥ä½œè¡¨ï¼‰:', sheetNames);
    
    var total = sheetNames.length;
    
    this.currentSpreadsheetName = spreadsheetName;
    
    // ä¿å­˜åˆ°æ­·å²è¨˜éŒ„
    if (sheetId && spreadsheetName) {
      this.addToSheetHistory(sheetId, spreadsheetName);
      console.log('å·²æ·»åŠ åˆ°æ­·å²è¨˜éŒ„:', sheetId, spreadsheetName);
    }
    
    if (total === 0) {
      elements.sheetsList.innerHTML = '<div class="error-text">æ²’æœ‰æ‰¾åˆ°å·¥ä½œè¡¨</div>';
      this.updateSheetLoadingUI(elements, false);
      return;
    }
    
    // åˆå§‹åŒ– availableSheetsï¼ˆå–®å­—æ•¸ç‚º nullï¼Œç¨å¾Œé€ä¸€å¡«å…¥ï¼‰
    this.availableSheets = [];
    for (var i = 0; i < sheetNames.length; i++) {
      this.availableSheets.push({ name: sheetNames[i], wordCount: null });
    }
    
    // æ¨™è¨˜æ­£åœ¨è¼‰å…¥å–®å­—æ•¸
    this.isLoadingWordCounts = true;
    
    // å…ˆæ¸²æŸ“å·¥ä½œè¡¨æ¸…å–®ï¼ˆå„é …é¡¯ç¤ºã€Œè¼‰å…¥ä¸­...ã€ï¼‰
    this.renderSheetsList();
    
    // åˆ‡æ›é€²åº¦æ¢ç‚ºç¢ºå®šæ¨¡å¼ï¼ˆPhase 2ï¼‰
    var progressBar = document.querySelector('#sheet-loading-progress-container .progress-bar');
    if (progressBar) {
      progressBar.className = 'progress-bar'; // ç§»é™¤ indeterminate
    }
    this.updateSheetLoadingProgress(0, total, 'æ­£åœ¨è¼‰å…¥å·¥ä½œè¡¨è³‡è¨Š 0/' + total + '...');
    
    // Phase 2: ä¸¦è¡Œå–å¾—å„å·¥ä½œè¡¨çš„å–®å­—æ•¸
    var self = this;
    var completed = 0;
    
    // Phase 2 è¶…æ™‚
    var phase2Timeout = setTimeout(function() {
      console.error('è¼‰å…¥å·¥ä½œè¡¨è³‡è¨Šè¶…æ™‚ (' + APP_CONSTANTS.PHASE2_TIMEOUT_MS + 'ms)');
      self.isLoadingWordCounts = false;
      self.updateSheetLoadingUI(elements, false);
    }, APP_CONSTANTS.PHASE2_TIMEOUT_MS);
    
    for (var i = 0; i < sheetNames.length; i++) {
      (function(name, index) {
        google.script.run
          .withSuccessHandler(function(countResult) {
            if (self.availableSheets[index]) {
              self.availableSheets[index].wordCount = countResult.wordCount;
            }
            self.updateSheetItemCount(index, countResult.wordCount);
            
            completed++;
            self.updateSheetLoadingProgress(completed, total,
              'æ­£åœ¨è¼‰å…¥å·¥ä½œè¡¨è³‡è¨Š ' + completed + '/' + total + '...');
            
            if (completed >= total) {
              clearTimeout(phase2Timeout);
              self.updateSheetLoadingUI(elements, false);
            }
          })
          .withFailureHandler(function(error) {
            console.error('è¼‰å…¥å·¥ä½œè¡¨å–®å­—æ•¸å¤±æ•—:', name, error);
            self.updateSheetItemCount(index, null);
            
            completed++;
            self.updateSheetLoadingProgress(completed, total,
              'æ­£åœ¨è¼‰å…¥å·¥ä½œè¡¨è³‡è¨Š ' + completed + '/' + total + '...');
            
            if (completed >= total) {
              clearTimeout(phase2Timeout);
              self.updateSheetLoadingUI(elements, false);
            }
          })
          .getSheetWordCount(sheetId, name);
      })(sheetNames[i], i);
    }
  };
  
  // æ›´æ–°è¼‰å…¥é€²åº¦æ¢
  FlashcardApp.prototype.updateSheetLoadingProgress = function(completed, total, text) {
    var fillEl = document.getElementById('sheet-loading-fill');
    var textEl = document.getElementById('sheet-loading-text');
    
    if (fillEl) {
      var pct = total > 0 ? Math.round((completed / total) * 100) : 0;
      fillEl.style.width = pct + '%';
    }
    if (textEl) {
      textEl.textContent = text;
    }
  };
  
  // æ›´æ–°å–®ä¸€å·¥ä½œè¡¨çš„å–®å­—æ•¸é¡¯ç¤º
  FlashcardApp.prototype.updateSheetItemCount = function(index, wordCount) {
    var countEl = document.getElementById('sheet-count-' + index);
    if (!countEl) return;
    
    if (wordCount === null || wordCount === undefined) {
      countEl.textContent = '-';
      countEl.style.color = '#888';
    } else {
      countEl.textContent = wordCount + ' å€‹å–®å­—';
      countEl.style.color = '';
    }
  };
  
  FlashcardApp.prototype.validateGoogleScriptEnvironment = function() {
    if (typeof google === 'undefined') {
      console.error('google ç‰©ä»¶æœªå®šç¾©');
      return false;
    }
    if (!google.script || !google.script.run) {
      console.error('Google Apps Script åŠŸèƒ½æœªå¯ç”¨');
      return false;
    }
    return true;
  };
  
  FlashcardApp.prototype.setupSheetRequestTimeout = function(elements) {
    var self = this;
    return setTimeout(function() {
      console.error('è¼‰å…¥å·¥ä½œè¡¨æ¸…å–®è¶…æ™‚ (' + APP_CONSTANTS.PHASE1_TIMEOUT_MS + 'ms)');
      elements.sheetsList.innerHTML = '<div class="error-text">è¼‰å…¥è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥æˆ–é‡è©¦</div>';
      self.updateSheetLoadingUI(elements, false);
    }, APP_CONSTANTS.PHASE1_TIMEOUT_MS);
  };
  
  FlashcardApp.prototype.handleSheetListFailure = function(error, elements, timeout) {
    clearTimeout(timeout);
    console.error('è¼‰å…¥å·¥ä½œè¡¨æ¸…å–®å¤±æ•—:', error);
  
    var errorMessage = error.message || 'æœªçŸ¥éŒ¯èª¤';
    var helpMessage = '';
    
    // æ ¹æ“šä¸åŒéŒ¯èª¤é¡å‹æä¾›å…·é«”çš„å¹«åŠ©è¨Šæ¯
    if (errorMessage.indexOf('æ¬Šé™') !== -1 || errorMessage.indexOf('Permission') !== -1) {
      helpMessage = '<div class="error-help"><strong>è§£æ±ºæ–¹æ¡ˆï¼š</strong><br>1. ç¢ºèªæ‚¨æœ‰å­˜å–æ­¤ Google Sheet çš„æ¬Šé™<br>2. å¦‚æœæ˜¯ç§äºº Sheetï¼Œè«‹ç¢ºä¿æ‚¨å·²ç™»å…¥ç›¸åŒçš„ Google å¸³è™Ÿ<br>3. å˜—è©¦åœ¨ç€è¦½å™¨ä¸­ç›´æ¥é–‹å•Ÿè©² Sheet ç¢ºèªæ¬Šé™</div>';
    } else if (errorMessage.indexOf('æ‰¾ä¸åˆ°') !== -1 || errorMessage.indexOf('ç„¡æ³•é–‹å•Ÿ') !== -1 || errorMessage.indexOf('not found') !== -1) {
      helpMessage = '<div class="error-help"><strong>è§£æ±ºæ–¹æ¡ˆï¼š</strong><br>1. è«‹æª¢æŸ¥ Sheet ID æ˜¯å¦æ­£ç¢º<br>2. ç¢ºèª Sheet æ˜¯å¦å­˜åœ¨ä¸”æœªè¢«åˆªé™¤<br>3. å¦‚æœæ˜¯ URLï¼Œè«‹ç¢ºä¿æ ¼å¼æ­£ç¢º</div>';
    } else if (errorMessage.indexOf('network') !== -1 || errorMessage.indexOf('ç¶²è·¯') !== -1) {
      helpMessage = '<div class="error-help"><strong>è§£æ±ºæ–¹æ¡ˆï¼š</strong><br>1. æª¢æŸ¥ç¶²è·¯é€£æ¥<br>2. ç¨å¾Œé‡è©¦<br>3. ç¢ºèªé˜²ç«ç‰†æœªé˜»æ“‹ Google æœå‹™</div>';
          } else {
      helpMessage = '<div class="error-help"><strong>å¸¸è¦‹è§£æ±ºæ–¹æ¡ˆï¼š</strong><br>1. è«‹åˆ·æ–°é é¢é‡è©¦ï¼ˆæŒ‰ Ctrl+F5 æˆ– Cmd+Shift+Rï¼‰<br>2. ç¢ºèª Google Sheet ID æ ¼å¼æ­£ç¢º<br>3. ç¢ºèªæ‚¨æœ‰è©² Sheet çš„å­˜å–æ¬Šé™<br>4. å˜—è©¦ç›´æ¥åœ¨ç€è¦½å™¨é–‹å•Ÿè©² Sheet</div>';
    }
    
    elements.sheetsList.innerHTML = '<div class="error-text">è¼‰å…¥å¤±æ•—ï¼š' + errorMessage + '</div>' + helpMessage;
    this.updateSheetLoadingUI(elements, false);
  };
  
  FlashcardApp.prototype.renderSheetsList = function() {
    console.log('=== renderSheetsList é–‹å§‹åŸ·è¡Œ ===');
    console.log('å¯ç”¨å·¥ä½œè¡¨æ•¸é‡:', this.availableSheets ? this.availableSheets.length : 0);
    console.log('å·¥ä½œè¡¨è³‡æ–™:', this.availableSheets);
    console.log('ç•¶å‰ Google Sheet åç¨±:', this.currentSpreadsheetName);
    
    var sheetsList = document.getElementById('sheets-list');
    var sheetsGroup = document.getElementById('sheets-selection-group');
    if (!sheetsList || !sheetsGroup) {
      console.error('æ‰¾ä¸åˆ° sheets-list æˆ– sheets-selection-group å…ƒç´ ');
      return;
    }
    
    if (!this.availableSheets || this.availableSheets.length === 0) {
      console.warn('æ²’æœ‰å¯ç”¨çš„å·¥ä½œè¡¨');
      sheetsList.innerHTML = '<div class="error-text">æ²’æœ‰æ‰¾åˆ°å·¥ä½œè¡¨</div>';
      var oldTitle = sheetsGroup.querySelector('.sheet-title');
      if (oldTitle) oldTitle.remove();
        return;
      }
      
    console.log('é–‹å§‹æ¸…ç©ºä¸¦é‡æ–°æ¸²æŸ“å·¥ä½œè¡¨æ¸…å–®');
    sheetsList.innerHTML = '';
    
    // å…ˆç§»é™¤èˆŠçš„æ¨™é¡Œ
    var oldTitle = sheetsGroup.querySelector('.sheet-title');
    if (oldTitle) oldTitle.remove();
    
    // å¦‚æœæœ‰ Google Sheet åç¨±ï¼Œé¡¯ç¤ºåœ¨ sheetsGroup æœ€ä¸Šæ–¹
    if (this.currentSpreadsheetName) {
      var sheetTitle = document.createElement('div');
      sheetTitle.className = 'sheet-title';
      sheetTitle.innerHTML = '<div class="sheet-title-text"><strong>Google Sheet:</strong> ' + this.currentSpreadsheetName + '</div>';
      sheetsGroup.insertBefore(sheetTitle, sheetsGroup.firstChild);
      console.log('é¡¯ç¤º Google Sheet åç¨±:', this.currentSpreadsheetName);
    }
    
    var self = this;
    // Shift+Click é€£çºŒå¤šé¸ï¼šè¨˜éŒ„ä¸Šæ¬¡é»æ“Šçš„ç´¢å¼•
    this._lastClickedSheetIndex = -1;
    
    for (var index = 0; index < this.availableSheets.length; index++) {
      var sheet = this.availableSheets[index];
      console.log('æ¸²æŸ“å·¥ä½œè¡¨ ' + (index + 1) + ':', sheet);
      
      var sheetItem = document.createElement('div');
      sheetItem.className = 'sheet-item';
      sheetItem.setAttribute('data-sheet-index', index);
      
      var checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.value = sheet.name;
      checkbox.setAttribute('data-sheet-index', index);
      
      // æª¢æŸ¥æ˜¯å¦æ‡‰è©²è‡ªå‹•å‹¾é¸
      if (this.sheetSettings.selectedSheets && this.sheetSettings.selectedSheets.includes(sheet.name)) {
        checkbox.checked = true;
        console.log('è‡ªå‹•å‹¾é¸å·²è¼‰å…¥çš„å·¥ä½œè¡¨:', sheet.name);
      }
      
      (function(sheetName, idx) {
        checkbox.addEventListener('change', function() {
          console.log('å·¥ä½œè¡¨é¸æ“‡ç‹€æ…‹æ”¹è®Š:', sheetName, checkbox.checked);
          self._lastClickedSheetIndex = idx;
          self.toggleSheetSelection();
        });
      })(sheet.name, index);
      
      var sheetInfo = document.createElement('div');
      sheetInfo.className = 'sheet-info';
      
      var sheetName = document.createElement('div');
      sheetName.className = 'sheet-name';
      sheetName.textContent = sheet.name;
      
      var sheetCount = document.createElement('div');
      sheetCount.className = 'sheet-count';
      sheetCount.id = 'sheet-count-' + index;
      // å¦‚æœ wordCount ç‚º null æˆ– undefinedï¼Œæ ¹æ“šè¼‰å…¥ç‹€æ…‹é¡¯ç¤ºä¸åŒæ–‡å­—
      if (sheet.wordCount === null || sheet.wordCount === undefined) {
        if (self.isLoadingWordCounts) {
          sheetCount.textContent = 'è¼‰å…¥ä¸­...';
        } else {
          sheetCount.textContent = '-';
        }
        sheetCount.style.color = '#888'; // ä½¿ç”¨ç°è‰²è¡¨ç¤ºç„¡è³‡æ–™æˆ–è¼‰å…¥ä¸­
      } else {
        sheetCount.textContent = sheet.wordCount + ' å€‹å–®å­—';
      }
      
      sheetInfo.appendChild(sheetName);
      sheetInfo.appendChild(sheetCount);
      
      sheetItem.appendChild(checkbox);
      sheetItem.appendChild(sheetInfo);
      
      // é»æ“Šå·¥ä½œè¡¨é …ç›®ï¼šæ”¯æ´ Shift+Click é€£çºŒå¤šé¸
      (function(currentSheet, currentCheckbox, currentIndex) {
        sheetItem.addEventListener('click', function(e) {
          if (e.target === currentCheckbox) return; // checkbox è‡ªèº«è™•ç†
          
          var allCheckboxes = document.querySelectorAll('#sheets-list input[type="checkbox"]');
          
          // Shift+Clickï¼šå¾ä¸Šæ¬¡é»æ“Šä½ç½®åˆ°ç•¶å‰ä½ç½®ï¼Œæ‰¹æ¬¡è¨­å®šç‚ºèˆ‡ç•¶å‰é …ç›®ç›¸åŒç‹€æ…‹
          if (e.shiftKey && self._lastClickedSheetIndex >= 0 && self._lastClickedSheetIndex !== currentIndex) {
            var start = Math.min(self._lastClickedSheetIndex, currentIndex);
            var end = Math.max(self._lastClickedSheetIndex, currentIndex);
            // ç›®æ¨™ç‹€æ…‹ï¼šèˆ‡ç•¶å‰é»æ“Šé …ç›®åˆ‡æ›å¾Œçš„ç‹€æ…‹ä¸€è‡´
            var targetState = !currentCheckbox.checked;
            for (var si = start; si <= end; si++) {
              if (allCheckboxes[si]) {
                allCheckboxes[si].checked = targetState;
              }
            }
            console.log('Shift å¤šé¸ï¼šç´¢å¼• ' + start + ' åˆ° ' + end + 'ï¼Œç‹€æ…‹ï¼š' + targetState);
          } else {
            // ä¸€èˆ¬é»æ“Šï¼šåˆ‡æ›å–®å€‹ checkbox
            currentCheckbox.checked = !currentCheckbox.checked;
          }
          
          self._lastClickedSheetIndex = currentIndex;
          self.toggleSheetSelection();
        });
      })(sheet, checkbox, index);
      
      sheetsList.appendChild(sheetItem);
      console.log('å·¥ä½œè¡¨ ' + sheet.name + ' æ¸²æŸ“å®Œæˆ');
    }
    
    console.log('æ‰€æœ‰å·¥ä½œè¡¨æ¸²æŸ“å®Œæˆï¼Œæ›´æ–°é¸æ“‡è¨ˆæ•¸');
    this.updateSelectedCount();
    
    // æª¢æŸ¥æ˜¯å¦æœ‰å·²å‹¾é¸çš„å·¥ä½œè¡¨ï¼Œå¦‚æœæœ‰å‰‡å•Ÿç”¨è¼‰å…¥æŒ‰éˆ•
    var checkboxes = document.querySelectorAll('#sheets-list input[type="checkbox"]');
    var selectedCount = 0;
    for (var i = 0; i < checkboxes.length; i++) {
      if (checkboxes[i].checked) selectedCount++;
    }
    var saveBtn = document.getElementById('save-sheet-settings');
    if (saveBtn && selectedCount > 0) {
      saveBtn.disabled = false;
      console.log('å•Ÿç”¨è¼‰å…¥å–®å­—æŒ‰éˆ•ï¼Œå·²é¸æ“‡', selectedCount, 'å€‹å·¥ä½œè¡¨');
    }
    
    console.log('=== renderSheetsList åŸ·è¡Œå®Œæˆ ===');
  };
  
  FlashcardApp.prototype.toggleSheetSelection = function() {
    var checkboxes = document.querySelectorAll('#sheets-list input[type="checkbox"]');
    var selectedCount = 0;
    for (var i = 0; i < checkboxes.length; i++) {
      if (checkboxes[i].checked) selectedCount++;
    }
    
    var saveBtn = document.getElementById('save-sheet-settings');
    if (saveBtn) {
      saveBtn.disabled = selectedCount === 0;
    }
    this.updateSelectedCount();
    this.updateSelectAllButtonText();
  };
  
  FlashcardApp.prototype.toggleSelectAll = function() {
    var checkboxes = document.querySelectorAll('#sheets-list input[type="checkbox"]');
    var btn = document.getElementById('toggle-select-all-btn');
    if (!checkboxes.length) return;

    // åˆ¤æ–·ç›®å‰æ˜¯å¦å…¨é¸ï¼šæœ‰ä»»ä½•ä¸€å€‹æœªé¸å°±è¦–ç‚ºã€Œéœ€è¦å…¨é¸ã€
    var allChecked = true;
    for (var i = 0; i < checkboxes.length; i++) {
      if (!checkboxes[i].checked) {
        allChecked = false;
        break;
      }
    }

    // åˆ‡æ›ï¼šå…¨é¸ â†” å–æ¶ˆå…¨é¸
    for (var j = 0; j < checkboxes.length; j++) {
      checkboxes[j].checked = !allChecked;
    }

    // æ›´æ–°æŒ‰éˆ•æ–‡å­—
    if (btn) {
      btn.textContent = !allChecked ? 'å–æ¶ˆå…¨é¸' : 'å…¨é¸';
    }

    this.toggleSheetSelection();
  };

  FlashcardApp.prototype.clearAllSelection = function() {
    var checkboxes = document.querySelectorAll('#sheets-list input[type="checkbox"]');
    for (var i = 0; i < checkboxes.length; i++) {
      checkboxes[i].checked = false;
    }
    this.updateSelectAllButtonText();
    this.toggleSheetSelection();
  };

  FlashcardApp.prototype.updateSelectAllButtonText = function() {
    var checkboxes = document.querySelectorAll('#sheets-list input[type="checkbox"]');
    var btn = document.getElementById('toggle-select-all-btn');
    if (!btn || !checkboxes.length) return;

    var allChecked = true;
    for (var i = 0; i < checkboxes.length; i++) {
      if (!checkboxes[i].checked) {
        allChecked = false;
        break;
      }
    }
    btn.textContent = allChecked ? 'å–æ¶ˆå…¨é¸' : 'å…¨é¸';
  };

  FlashcardApp.prototype.updateSelectedCount = function() {
    var checkboxes = document.querySelectorAll('#sheets-list input[type="checkbox"]');
    var selectedCount = 0;
    for (var i = 0; i < checkboxes.length; i++) {
      if (checkboxes[i].checked) selectedCount++;
    }
    var selectedCountElement = document.getElementById('selected-count');
    if (selectedCountElement) {
      selectedCountElement.textContent = '(å·²é¸ ' + selectedCount + ' å€‹)';
    }
    // æ²’æœ‰é¸æ“‡ä»»ä½•å·¥ä½œè¡¨æ™‚éš±è—æ¸…é™¤æŒ‰éˆ•
    var clearAllBtn = document.getElementById('clear-all-btn');
    if (clearAllBtn) {
      clearAllBtn.style.display = selectedCount > 0 ? '' : 'none';
    }
  };
  
  FlashcardApp.prototype.saveSheetSettingsAndClose = function() {
    var sheetIdInput = document.getElementById('sheet-id-input');
    var input = sheetIdInput.value.trim();
    
    var checkboxes = document.querySelectorAll('#sheets-list input[type="checkbox"]');
    var selectedSheets = [];
    for (var i = 0; i < checkboxes.length; i++) {
      if (checkboxes[i].checked) {
        selectedSheets.push(checkboxes[i].value);
      }
    }
    
    if (!input || selectedSheets.length === 0) {
      alert('è«‹è¼¸å…¥ Google Sheet ID/URL ä¸¦é¸æ“‡è‡³å°‘ä¸€å€‹å·¥ä½œè¡¨');
        return;
      }
      
    try {
      var sheetId = this.extractSheetId(input);
      
      this.sheetSettings.sheetId = sheetId;
      this.sheetSettings.selectedSheets = selectedSheets;
      this.saveSheetSettings();
      
      console.log('å„²å­˜ Sheet è¨­å®š:', this.sheetSettings);
      
      this.closeSheetSettings();
      
      // é¡¯ç¤ºè¼‰å…¥ä¸­è¨Šæ¯
      var loadingDiv = document.getElementById('loading');
      var flashcardDiv = document.getElementById('flashcard');
      if (loadingDiv) loadingDiv.style.display = 'flex';
      if (flashcardDiv) flashcardDiv.style.display = 'none';
      
      // é‡è¨­è¼‰å…¥é€²åº¦æ¢
      this.updateLoadingProgress(0, 1, 'æ­£åœ¨è¼‰å…¥å–®å­—...');
      
      // é‡æ–°è¼‰å…¥å–®å­—
      var self = this;
      this.loadWords(false, function(hasDuplicates) {
        self.setupEventListeners();
        self.applySettings();
        
        if (!hasDuplicates) {
          self.startNewRound();
        }
        
        if (loadingDiv) loadingDiv.style.display = 'none';
        if (flashcardDiv) flashcardDiv.style.display = 'flex';
      });
      
    } catch (error) {
      console.error('å„²å­˜è¨­å®šæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
      alert(error.message);
    }
  };
  
</script>

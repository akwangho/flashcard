<!-- script-quiz.html -->
<script>
  // é˜²æ­¢è¢å¹•é—œé–‰åŠŸèƒ½
  FlashcardApp.prototype.enableKeepScreenAwake = function() {
    console.log('å•Ÿç”¨é˜²æ­¢è¢å¹•é—œé–‰åŠŸèƒ½');
    
    // å˜—è©¦ä½¿ç”¨Wake Lock APIï¼ˆæ–°ç‰ˆç€è¦½å™¨ï¼‰
    if (this.tryWakeLockAPI()) {
      console.log('ä½¿ç”¨Wake Lock APIé˜²æ­¢è¢å¹•é—œé–‰');
      return;
    }
    
    // ä½¿ç”¨NoSleep.jsæ–¹æ³•ï¼ˆæ’­æ”¾ç„¡è²è¦–é »ï¼‰
    if (this.tryNoSleepVideo()) {
      console.log('ä½¿ç”¨ç„¡è²è¦–é »é˜²æ­¢è¢å¹•é—œé–‰');
      return;
    }
    
    // å‚™ç”¨æ–¹æ¡ˆï¼šå®šæœŸåŸ·è¡Œæ“ä½œ
    this.tryKeepAliveMethod();
    console.log('ä½¿ç”¨å®šæœŸåŸ·è¡Œæ“ä½œé˜²æ­¢è¢å¹•é—œé–‰');
  };
  
  // å˜—è©¦ä½¿ç”¨Wake Lock API
  FlashcardApp.prototype.tryWakeLockAPI = function() {
    if ('wakeLock' in navigator) {
      var self = this;
      
      navigator.wakeLock.request('screen').then(function(wakeLock) {
        self.wakeLock = wakeLock;
        console.log('Wake Lock API å·²å•Ÿç”¨');
        
        // ç›£è½é é¢å¯è¦‹æ€§è®ŠåŒ–
        document.addEventListener('visibilitychange', function() {
          if (self.wakeLock !== null && document.visibilityState === 'visible') {
            // é é¢é‡æ–°å¯è¦‹æ™‚é‡æ–°è«‹æ±‚Wake Lock
            navigator.wakeLock.request('screen').then(function(wakeLock) {
              self.wakeLock = wakeLock;
            }).catch(function(error) {
              console.log('é‡æ–°è«‹æ±‚Wake Lockå¤±æ•—:', error);
            });
          }
        });
        
        return true;
      }).catch(function(error) {
        console.log('Wake Lock API è«‹æ±‚å¤±æ•—:', error);
        return false;
      });
      
      return true;
    }
    return false;
  };
  
  // å˜—è©¦ä½¿ç”¨NoSleepè¦–é »æ–¹æ³•
  FlashcardApp.prototype.tryNoSleepVideo = function() {
    try {
      // å‰µå»ºç„¡è²è¦–é »å…ƒç´ 
      var video = document.createElement('video');
      video.setAttribute('muted', '');
      video.setAttribute('playsinline', '');
      video.setAttribute('loop', '');
      video.style.position = 'fixed';
      video.style.top = '0';
      video.style.left = '0';
      video.style.width = '1px';
      video.style.height = '1px';
      video.style.opacity = '0';
      video.style.pointerEvents = 'none';
      video.style.zIndex = '-1';
      
      // å‰µå»ºç„¡è²è¦–é »æ•¸æ“šURLï¼ˆ1x1åƒç´ ï¼Œæ¥µçŸ­çš„ç„¡è²è¦–é »ï¼‰
      var videoDataUrl = 'data:video/mp4;base64,AAAAIGZ0eXBtcDQyAAACAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQAAAr1tZGF0AAACrgYF//+q3EXpvebZSLeWLNgg2SPu73gyNjQgLSBjb3JlIDE0OCByMjYwMSBNIGU5YjVmMzMgLSBILjI2NC9NUEVHLTQgQVZDIGNvZGVjIC0gQ29weWxlZnQgMjAwMy0yMDE2IC0gaHR0cDovL3d3dy52aWRlb2xhbi5vcmcveDI2NC5odG1sIC0gb3B0aW9uczogY2FiYWM9MSByZWY9MyBkZWJsb2NrPTE6MDowIGFuYWx5c2U9MHgzOjB4MTEzIG1lPWhleCBzdWJtZT03IHBzeT0xIHBzeV9yZD0xLjAwOjAuMDAgbWl4ZWRfcmVmPTEgbWVfcmFuZ2U9MTYgY2hyb21hX21lPTEgdHJlbGxpcz0xIDh4OGRjdD0xIGNxbT0wIGRlYWR6b25lPTIxLDExIGZhc3RfcHNraXA9MSBjaHJvbWFfcXBfb2Zmc2V0PS0yIHRocmVhZHM9MSBsb29rYWhlYWRfdGhyZWFkcz0xIHNsaWNlZF90aHJlYWRzPTAgbnI9MCBkZWNpbWF0ZT0xIGludGVybGFjZWQ9MCBibHVyYXlfY29tcGF0PTAgY29uc3RyYWluZWRfaW50cmE9MCBicmFtZXM9MyBiX3B5cmFtaWQ9MiBiX2FkYXB0PTEgYl9iaWFzPTAgZGlyZWN0PTEgd2VpZ2h0Yj0xIG9wZW5fZ29wPTAgd2VpZ2h0cD0yIGtleWludD0yNTAga2V5aW50X21pbj0yNSBzY2VuZWN1dD00MCBpbnRyYV9yZWZyZXNoPTAgcmNfbG9va2FoZWFkPTQwIHJjPWNyZiBtYnRyZWU9MSBjcmY9MjMuMCBxY29tcD0wLjYwIHFwbWluPTAgcXBtYXg9NjkgcXBzdGVwPTQgaXBfcmF0aW89MS40MCBhcT0xOjEuMDAAgAAAAFZliIQL8mKAAKvMnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycH//2Q==';
      
      video.src = videoDataUrl;
      
      // æ·»åŠ åˆ°DOM
      document.body.appendChild(video);
      this.noSleepVideo = video;
      
      // å˜—è©¦æ’­æ”¾
      var self = this;
      video.play().then(function() {
        console.log('NoSleepè¦–é »å·²é–‹å§‹æ’­æ”¾');
        self.keepScreenAwake = true;
      }).catch(function(error) {
        console.log('NoSleepè¦–é »æ’­æ”¾å¤±æ•—:', error);
        // æ¸…ç†å¤±æ•—çš„è¦–é »å…ƒç´ 
        if (self.noSleepVideo && self.noSleepVideo.parentNode) {
          self.noSleepVideo.parentNode.removeChild(self.noSleepVideo);
        }
        self.noSleepVideo = null;
        return false;
      });
      
      return true;
    } catch (error) {
      console.log('å‰µå»ºNoSleepè¦–é »å¤±æ•—:', error);
      return false;
    }
  };
  
  // å‚™ç”¨æ–¹æ¡ˆï¼šå®šæœŸåŸ·è¡Œæ“ä½œ
  FlashcardApp.prototype.tryKeepAliveMethod = function() {
    var self = this;
    
    // æ¯30ç§’åŸ·è¡Œä¸€æ¬¡æ“ä½œä¾†ä¿æŒæ´»å‹•ç‹€æ…‹
    setInterval(function() {
      if (self.keepScreenAwake !== false) {
        // å‰µå»ºä¸€å€‹æ¥µå°çš„éŸ³é »ä¸Šä¸‹æ–‡ä¸¦ç«‹å³é—œé–‰
        try {
          var audioContext = new (window.AudioContext || window.webkitAudioContext)();
          var oscillator = audioContext.createOscillator();
          var gainNode = audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          // è¨­ç½®æ¥µä½çš„éŸ³é‡
          gainNode.gain.value = 0.001;
          
          // æ’­æ”¾æ¥µçŸ­çš„ç„¡è²éŸ³é »
          oscillator.frequency.value = 20000; // äººè€³è½ä¸åˆ°çš„é«˜é »
          oscillator.start();
          oscillator.stop(audioContext.currentTime + 0.001);
          
          // é—œé–‰éŸ³é »ä¸Šä¸‹æ–‡
          setTimeout(function() {
            audioContext.close();
          }, 10);
        } catch (error) {
          // éœé»˜å¿½ç•¥éŒ¯èª¤
        }
        
        // è§¸ç™¼ä¸€å€‹æ¥µå°çš„DOMæ“ä½œ
        try {
          var dummyDiv = document.createElement('div');
          dummyDiv.style.position = 'fixed';
          dummyDiv.style.top = '-1px';
          dummyDiv.style.left = '-1px';
          dummyDiv.style.width = '1px';
          dummyDiv.style.height = '1px';
          dummyDiv.style.opacity = '0';
          document.body.appendChild(dummyDiv);
          
          setTimeout(function() {
            if (dummyDiv.parentNode) {
              dummyDiv.parentNode.removeChild(dummyDiv);
            }
          }, 1);
        } catch (error) {
          // éœé»˜å¿½ç•¥éŒ¯èª¤
        }
      }
    }, 30000); // æ¯30ç§’åŸ·è¡Œä¸€æ¬¡
  };
  
  // ==========================================================================
  // æ¸¬é©—åŠŸèƒ½ç›¸é—œæ–¹æ³• (Quiz Functions)
  // ==========================================================================
  
  // è¨­ç½®æ¸¬é©—æ¨¡æ…‹æ¡†äº‹ä»¶ç›£è½å™¨
  FlashcardApp.prototype.setupQuizListeners = function() {
    var self = this;
    
    // æ¸¬é©—æ¨¡æ…‹æ¡†å…ƒç´ 
    var quizModal = document.getElementById('quiz-modal');
    var closeQuizBtn = document.getElementById('close-quiz');
    var quizStartBtn = document.getElementById('quiz-start');
    var quizNextBtn = document.getElementById('quiz-next');
    var quizRestartBtn = document.getElementById('quiz-restart');
    var quizFinishBtn = document.getElementById('quiz-finish');
    
    // é—œé–‰æŒ‰éˆ•äº‹ä»¶
    if (closeQuizBtn) {
      closeQuizBtn.addEventListener('click', function() { self.closeQuizModal(); });
    }
    
    // æ¸¬é©—æµç¨‹æŒ‰éˆ•äº‹ä»¶
    if (quizStartBtn) {
      quizStartBtn.addEventListener('click', function() { self.beginQuiz(); });
    }
    if (quizNextBtn) {
      quizNextBtn.addEventListener('click', function() { self.nextQuestion(); });
    }
    if (quizRestartBtn) {
      quizRestartBtn.addEventListener('click', function() { self.restartQuiz(); });
    }
    if (quizFinishBtn) {
      quizFinishBtn.addEventListener('click', function() { self.closeQuizModal(); });
    }
    
    // æ¨¡æ…‹æ¡†é»æ“Šå¤–éƒ¨é—œé–‰ï¼ˆä½†åœ¨æ¸¬é©—é€²è¡Œä¸­ç¦ç”¨ï¼‰
    if (quizModal) {
      quizModal.addEventListener('click', function(e) {
        // æª¢æŸ¥æ˜¯å¦åœ¨æ¸¬é©—é€²è¡Œä¸­
        if (self.isQuizInProgress()) {
          console.log('æ¸¬é©—é€²è¡Œä¸­ï¼Œç¦ç”¨èƒŒæ™¯é»æ“Šé—œé–‰');
          return; // æ¸¬é©—é€²è¡Œä¸­ä¸å…è¨±èƒŒæ™¯é»æ“Šé—œé–‰
        }
        
        // æª¢æŸ¥é»æ“Šç›®æ¨™ï¼Œæ’é™¤selectå…ƒç´ åŠå…¶ç›¸é—œå…ƒç´ 
        var target = e.target;
        var isSelectRelated = false;
        
        var element = target;
        while (element && element !== quizModal) {
          if (element.tagName === 'SELECT' || 
              element.tagName === 'OPTION' ||
              element.classList.contains('setting-control')) {
            isSelectRelated = true;
            break;
          }
          element = element.parentElement;
        }
        
        if (e.target === quizModal && !isSelectRelated) {
          console.log('éæ¸¬é©—é€²è¡Œä¸­ï¼Œå…è¨±èƒŒæ™¯é»æ“Šé—œé–‰');
          self.closeQuizModal();
        }
      });
    }
  };
  
  // é–‹å§‹æ¸¬é©—
  FlashcardApp.prototype.startQuiz = function(type) {
    console.log('é–‹å§‹æ¸¬é©—ï¼Œé¡å‹:', type);
    
    // æª¢æŸ¥æ˜¯å¦æœ‰å–®å­—å¯ä»¥æ¸¬é©—
    if (!this.words || this.words.length === 0) {
      alert('æ²’æœ‰å–®å­—å¯ä»¥æ¸¬é©—ï¼è«‹å…ˆè¼‰å…¥å–®å­—ã€‚');
      return;
    }
    
    // æª¢æŸ¥ç•¶å‰å¯ç”¨çš„å–®å­—ï¼ˆè€ƒæ…®ç¯©é¸æ¢ä»¶å’Œæš«æ™‚åˆªé™¤ï¼‰
    var availableWords = this.getCurrentAvailableWords();
    if (availableWords.length === 0) {
      var message = this.getNoWordsMessage();
      alert(message);
      return;
    }
    
    // æª¢æŸ¥å¿«é€Ÿæ¸¬é©—çš„å–®å­—æ•¸é‡
    if (type === 'quick' && availableWords.length < 3) {
      alert('å¯ç”¨å–®å­—å¤ªå°‘ï¼ˆå°‘æ–¼3å€‹ï¼‰ï¼Œç„¡æ³•é€²è¡Œæ¸¬é©—ã€‚è«‹å¢åŠ æ›´å¤šå–®å­—æˆ–èª¿æ•´ç¯©é¸æ¢ä»¶ã€‚');
      return;
    }
    
    // æš«åœé–ƒå¡æ’­æ”¾
    this.pauseTimer();
    
    // è¨­ç½®æ¸¬é©—ç‹€æ…‹
    this.quizState = {
      isActive: true,
      type: type,
      questions: [],
      currentQuestionIndex: 0,
      selectedAnswer: null,
      answers: [],
      score: 0,
      startTime: new Date(),
      endTime: null,
      availableWords: availableWords
    };
    
    // ç”Ÿæˆæ¸¬é©—é¡Œç›®
    this.generateQuestions(type);
    
    // é¡¯ç¤ºæ¸¬é©—æ¨¡æ…‹æ¡†
    this.showQuizModal(type);
  };
  
  // ç²å–ç•¶å‰å¯ç”¨çš„å–®å­—ï¼ˆè€ƒæ…®ç¯©é¸å’Œåˆªé™¤ç‹€æ…‹ï¼‰
  FlashcardApp.prototype.getCurrentAvailableWords = function() {
    // ä½¿ç”¨ currentWordsï¼Œå®ƒå·²ç¶“è€ƒæ…®äº†ï¼š
    // 1. "åªé¡¯ç¤ºä¸ç†Ÿå–®å­—" çš„ç¯©é¸
    // 2. æš«æ™‚åˆªé™¤çš„å–®å­—
    return this.currentWords ? this.currentWords.slice() : [];
  };
  
  // ç²å–æ²’æœ‰å¯ç”¨å–®å­—æ™‚çš„æç¤ºä¿¡æ¯
  FlashcardApp.prototype.getNoWordsMessage = function() {
    if (this.difficultyFilter > 0) {
      return 'æ²’æœ‰ç¬¦åˆä¸ç†Ÿç¨‹åº¦ â˜…' + this.difficultyFilter + ' ä»¥ä¸Šçš„å–®å­—å¯ä»¥æ¸¬é©—ï¼\n\nè«‹èª¿æ•´ç¯©é¸æ¢ä»¶ã€‚';
    } else if (this.currentWords && this.currentWords.length === 0 && this.words && this.words.length > 0) {
      return 'æ‰€æœ‰å–®å­—éƒ½å·²è¢«æš«æ™‚ç§»é™¤ï¼\n\nè«‹é»æ“Šã€Œæ¢å¾©å–®å­—ã€æŒ‰éˆ•æˆ–é‡æ–°è¼‰å…¥å–®å­—ã€‚';
    } else {
      return 'æ²’æœ‰å–®å­—å¯ä»¥æ¸¬é©—ï¼è«‹å…ˆè¼‰å…¥å–®å­—ã€‚';
    }
  };
  
  // ç”Ÿæˆæ¸¬é©—é¡Œç›®
  FlashcardApp.prototype.generateQuestions = function(type) {
    console.log('ç”Ÿæˆæ¸¬é©—é¡Œç›®ï¼Œé¡å‹:', type);
    
    // ä½¿ç”¨ç•¶å‰å¯ç”¨çš„å–®å­—ï¼ˆå·²è€ƒæ…®ç¯©é¸æ¢ä»¶å’Œåˆªé™¤ç‹€æ…‹ï¼‰
    var availableWords = this.quizState.availableWords.slice();
    
    // æ‰€æœ‰æ¸¬é©—é¡å‹éƒ½éš¨æ©ŸåŒ–é †åº
    console.log('æ´—ç‰Œå‰å–®å­—é †åº:', availableWords.map(function(w, i) { return i + ':' + w.english; }).slice(0, 5));
    this.shuffleArray(availableWords);
    console.log('æ´—ç‰Œå¾Œå–®å­—é †åº:', availableWords.map(function(w, i) { return i + ':' + w.english; }).slice(0, 5));
    
    // æ ¹æ“šæ¸¬é©—é¡å‹æ±ºå®šé¡Œç›®æ•¸é‡
    var questionCount = type === 'quick' ? Math.min(10, availableWords.length) : availableWords.length;
    
    // å¿«é€Ÿæ¸¬é©—åªå–å‰Nå€‹ï¼ˆå·²éš¨æ©Ÿæ´—ç‰Œï¼‰
    if (type === 'quick' && availableWords.length > 10) {
      availableWords = availableWords.slice(0, 10);
    }
    
    // ç”Ÿæˆé¡Œç›®
    this.quizState.questions = [];
    for (var i = 0; i < availableWords.length; i++) {
      var word = availableWords[i];
      // ä½¿ç”¨æ‰€æœ‰åŸå§‹å–®å­—ä½œç‚ºé¸é …æ± ï¼ˆç¢ºä¿æœ‰è¶³å¤ çš„éŒ¯èª¤é¸é …ï¼‰
      var question = this.createQuestion(word, this.words);
      if (question) {
        this.quizState.questions.push(question);
      }
    }
    
    console.log('ç”Ÿæˆäº†', this.quizState.questions.length, 'é“é¡Œç›®');
  };
  
  // å‰µå»ºå–®å€‹é¡Œç›®
  FlashcardApp.prototype.createQuestion = function(targetWord, allWords) {
    // éš¨æ©Ÿæ±ºå®šé¡Œå‹ï¼šè‹±è­¯ä¸­ æˆ– ä¸­è­¯è‹±
    var isEnglishToChinese = Math.random() < 0.5;
    
    var question = {
      word: targetWord,
      type: isEnglishToChinese ? 'en-zh' : 'zh-en',
      question: isEnglishToChinese ? targetWord.english : targetWord.chinese,
      correctAnswer: isEnglishToChinese ? targetWord.chinese : targetWord.english,
      options: []
    };
    
    // ç”ŸæˆéŒ¯èª¤é¸é …
    var wrongOptions = [];
    var attempts = 0;
    var maxAttempts = 100;
    
    while (wrongOptions.length < 3 && attempts < maxAttempts) {
      attempts++;
      var randomWord = allWords[Math.floor(Math.random() * allWords.length)];
      var wrongAnswer = isEnglishToChinese ? randomWord.chinese : randomWord.english;
      
      // ç¢ºä¿éŒ¯èª¤é¸é …ä¸é‡è¤‡ä¸”ä¸ç­‰æ–¼æ­£ç¢ºç­”æ¡ˆ
      if (wrongAnswer !== question.correctAnswer && 
          wrongOptions.indexOf(wrongAnswer) === -1) {
        wrongOptions.push(wrongAnswer);
      }
    }
    
    // å¦‚æœæ²’æœ‰è¶³å¤ çš„éŒ¯èª¤é¸é …ï¼Œè£œå……ä¸€äº›é€šç”¨é¸é …
    while (wrongOptions.length < 3) {
      var genericOptions = isEnglishToChinese ? 
        ['æ¡Œå­', 'é›»è…¦', 'æ›¸æœ¬', 'æ°´æœ', 'å‹•ç‰©', 'é¡è‰²', 'å¤©æ°£', 'æ™‚é–“'] :
        ['table', 'computer', 'book', 'fruit', 'animal', 'color', 'weather', 'time'];
      
      for (var i = 0; i < genericOptions.length && wrongOptions.length < 3; i++) {
        var option = genericOptions[i];
        if (option !== question.correctAnswer && wrongOptions.indexOf(option) === -1) {
          wrongOptions.push(option);
        }
      }
      break; // é¿å…ç„¡é™å¾ªç’°
    }
    
    // çµ„åˆæ‰€æœ‰é¸é …ä¸¦æ´—ç‰Œ
    question.options = [question.correctAnswer].concat(wrongOptions);
    this.shuffleArray(question.options);
    
    return question;
  };
  
  // é¡¯ç¤ºæ¸¬é©—æ¨¡æ…‹æ¡†
  FlashcardApp.prototype.showQuizModal = function(type) {
    var modal = document.getElementById('quiz-modal');
    var title = document.getElementById('quiz-title');
    var questionCount = document.getElementById('quiz-question-count');
    var introTitle = document.getElementById('quiz-intro-title');
    var introDescription = document.getElementById('quiz-intro-description');
    var scopeInfo = document.getElementById('quiz-scope-info');
    
    if (modal) {
      modal.style.display = 'flex';
    }
    
    // è¨­ç½®æ¨™é¡Œå’Œèªªæ˜
    if (title) {
      title.textContent = type === 'quick' ? 'ğŸ¯ å¿«é€Ÿæ¸¬é©—' : 'ğŸ“ å®Œæ•´æ¸¬é©—';
    }
    if (questionCount) {
      questionCount.textContent = this.quizState.questions.length;
    }
    if (introTitle) {
      var titleText = type === 'quick' ? 'æº–å‚™é–‹å§‹å¿«é€Ÿæ¸¬é©—ï¼' : 'æº–å‚™é–‹å§‹å®Œæ•´æ¸¬é©—ï¼';
      introTitle.textContent = titleText;
    }
    if (introDescription) {
      var description = type === 'quick' ? 
        'å¿«é€Ÿæª¢æ¸¬ä½ å°è‹±æ–‡å–®å­—çš„æŒæ¡ç¨‹åº¦ï¼' : 
        'å…¨é¢æ¸¬è©¦ä½ å­¸ç¿’çš„è‹±æ–‡å–®å­—ï¼';
      introDescription.textContent = description;
    }
    if (scopeInfo) {
      scopeInfo.textContent = this.getQuizScopeText();
    }
    
    // é¡¯ç¤ºé–‹å§‹ç•«é¢
    this.showQuizScreen('start');
  };
  
  // ç²å–æ¸¬é©—ç¯„åœæ–‡å­—
  FlashcardApp.prototype.getQuizScopeText = function() {
    var questionCount = this.quizState.questions.length;
    var filterLabels = {
      'never': 'å¾æœªè¤‡ç¿’',
      '2weeks': 'è¶…é2é€±æœªè¤‡ç¿’',
      '1month': 'è¶…é1å€‹æœˆæœªè¤‡ç¿’',
      '3months': 'è¶…é3å€‹æœˆæœªè¤‡ç¿’',
      '6months': 'è¶…é6å€‹æœˆæœªè¤‡ç¿’'
    };
    
    var parts = [];
    if (this.difficultyFilter > 0) {
      parts.push('â˜…' + this.difficultyFilter + ' ä»¥ä¸Š');
    }
    if (this.reviewFilter !== 'all') {
      parts.push(filterLabels[this.reviewFilter] || '');
    }
    
    if (parts.length > 0) {
      return 'ğŸ“š æ¸¬é©—ç¯„åœï¼š' + parts.join(' + ') + ' (' + questionCount + ' é¡Œ)';
    } else if (this.currentWords.length < this.words.length) {
      var removedCount = this.words.length - this.currentWords.length;
      return 'ğŸ“– æ¸¬é©—ç¯„åœï¼šå‰©é¤˜å–®å­— (' + questionCount + ' é¡Œï¼Œå·²æ’é™¤ ' + removedCount + ' å€‹)';
    } else {
      return 'ğŸ“— æ¸¬é©—ç¯„åœï¼šæ‰€æœ‰å–®å­— (' + questionCount + ' é¡Œ)';
    }
  };
  
  // é—œé–‰æ¸¬é©—æ¨¡æ…‹æ¡†
  FlashcardApp.prototype.closeQuizModal = function() {
    var modal = document.getElementById('quiz-modal');
    if (modal) {
      modal.style.display = 'none';
    }
    
    // é‡ç½®æ¸¬é©—ç‹€æ…‹
    this.quizState.isActive = false;
    
    // æ¢å¾©é–ƒå¡æ’­æ”¾
    this.resumeTimer();
  };
  
  // é¡¯ç¤ºæ¸¬é©—ç•«é¢
  FlashcardApp.prototype.showQuizScreen = function(screenType) {
    // éš±è—æ‰€æœ‰ç•«é¢
    var screens = ['quiz-start-screen', 'quiz-progress-screen', 'quiz-result-screen'];
    for (var i = 0; i < screens.length; i++) {
      var screen = document.getElementById(screens[i]);
      if (screen) {
        screen.style.display = 'none';
      }
    }
    
    // éš±è—æ‰€æœ‰æŒ‰éˆ•
    var buttons = ['quiz-start', 'quiz-next', 'quiz-restart', 'quiz-finish'];
    for (var i = 0; i < buttons.length; i++) {
      var btn = document.getElementById(buttons[i]);
      if (btn) {
        btn.style.display = 'none';
      }
    }
    
    // é¡¯ç¤ºæŒ‡å®šç•«é¢å’Œç›¸æ‡‰æŒ‰éˆ•
    var targetScreen = document.getElementById('quiz-' + screenType + '-screen');
    if (targetScreen) {
      targetScreen.style.display = 'block';
    }
    
    // æ ¹æ“šç•«é¢é¡å‹é¡¯ç¤ºç›¸æ‡‰æŒ‰éˆ•
    if (screenType === 'start') {
      var startBtn = document.getElementById('quiz-start');
      if (startBtn) {
        startBtn.style.display = 'inline-block';
      }
    } else if (screenType === 'progress') {
      var nextBtn = document.getElementById('quiz-next');
      if (nextBtn) {
        nextBtn.style.display = 'inline-block';
        nextBtn.style.display = 'none'; // åˆå§‹éš±è—ï¼Œç­”é¡Œå¾Œé¡¯ç¤º
      }
    } else if (screenType === 'result') {
      var restartBtn = document.getElementById('quiz-restart');
      var finishBtn = document.getElementById('quiz-finish');
      if (restartBtn) {
        restartBtn.style.display = 'inline-block';
      }
      if (finishBtn) {
        finishBtn.style.display = 'inline-block';
      }
    }
  };
  
  // é–‹å§‹ç­”é¡Œ
  FlashcardApp.prototype.beginQuiz = function() {
    console.log('é–‹å§‹ç­”é¡Œ');
    
    if (this.quizState.questions.length === 0) {
      alert('æ²’æœ‰é¡Œç›®å¯ä»¥æ¸¬é©—ï¼');
      return;
    }
    
    this.quizState.currentQuestionIndex = 0;
    this.quizState.answers = [];
    this.quizState.score = 0;
    
    this.showQuizScreen('progress');
    this.showQuestion();
  };
  
  // é¡¯ç¤ºç•¶å‰é¡Œç›®
  FlashcardApp.prototype.showQuestion = function() {
    var currentQuestion = this.quizState.questions[this.quizState.currentQuestionIndex];
    if (!currentQuestion) return;
    
    console.log('é¡¯ç¤ºé¡Œç›®:', this.quizState.currentQuestionIndex + 1);
    
    // æ›´æ–°é€²åº¦ä¿¡æ¯
    var currentNum = document.getElementById('quiz-current-number');
    var totalNum = document.getElementById('quiz-total-number');
    var currentScore = document.getElementById('quiz-current-score');
    var progressFill = document.getElementById('quiz-progress-fill');
    
    if (currentNum) {
      currentNum.textContent = this.quizState.currentQuestionIndex + 1;
    }
    if (totalNum) {
      totalNum.textContent = this.quizState.questions.length;
    }
    if (currentScore) {
      currentScore.textContent = this.quizState.score;
    }
    if (progressFill) {
      var progress = (this.quizState.currentQuestionIndex / this.quizState.questions.length) * 100;
      progressFill.style.width = progress + '%';
    }
    
    // æ›´æ–°é¡Œç›®å…§å®¹
    var quizWord = document.getElementById('quiz-word');
    
    if (quizWord) {
      quizWord.textContent = currentQuestion.question;
    }
    
    // ç”Ÿæˆé¸é …æŒ‰éˆ•
    this.renderQuizOptions(currentQuestion);
    
    // éš±è—å›é¥‹å’Œä¸‹ä¸€é¡ŒæŒ‰éˆ•
    var feedback = document.getElementById('quiz-feedback');
    var nextBtn = document.getElementById('quiz-next');
    if (feedback) {
      feedback.style.display = 'none';
    }
    if (nextBtn) {
      nextBtn.style.display = 'none';
    }
    
    // é‡ç½®é¸æ“‡ç‹€æ…‹
    this.quizState.selectedAnswer = null;
  };
  
  // æ¸²æŸ“æ¸¬é©—é¸é …
  FlashcardApp.prototype.renderQuizOptions = function(question) {
    var optionsContainer = document.getElementById('quiz-options');
    if (!optionsContainer) return;
    
    optionsContainer.innerHTML = '';
    
    var self = this;
    var letters = ['A', 'B', 'C', 'D'];
    
    for (var i = 0; i < question.options.length; i++) {
      var option = question.options[i];
      var optionBtn = document.createElement('button');
      optionBtn.className = 'quiz-option';
      optionBtn.innerHTML = '<span class="quiz-option-letter">' + letters[i] + '</span>' + option;
      optionBtn.setAttribute('data-answer', option);
      
      (function(answer) {
        optionBtn.addEventListener('click', function() {
          self.selectAnswer(answer);
        });
      })(option);
      
      optionsContainer.appendChild(optionBtn);
    }
  };
  
  // é¸æ“‡ç­”æ¡ˆ
  FlashcardApp.prototype.selectAnswer = function(selectedAnswer) {
    console.log('é¸æ“‡ç­”æ¡ˆ:', selectedAnswer);
    
    if (this.quizState.selectedAnswer !== null) {
      return; // å·²ç¶“é¸æ“‡éç­”æ¡ˆ
    }
    
    this.quizState.selectedAnswer = selectedAnswer;
    
    var currentQuestion = this.quizState.questions[this.quizState.currentQuestionIndex];
    var isCorrect = selectedAnswer === currentQuestion.correctAnswer;
    
    // è¨˜éŒ„ç­”æ¡ˆ
    this.quizState.answers.push({
      question: currentQuestion,
      selectedAnswer: selectedAnswer,
      isCorrect: isCorrect
    });
    
    if (isCorrect) {
      this.quizState.score += 10; // æ¯é¡Œ10åˆ†
    }
    
    // æ›´æ–°é¸é …æ¨£å¼
    this.updateOptionStyles(currentQuestion.correctAnswer, selectedAnswer);
    
    // é¡¯ç¤ºå›é¥‹
    this.showAnswerFeedback(isCorrect, currentQuestion);
    
    // å¦‚æœæ˜¯éŒ¯èª¤ç­”æ¡ˆï¼Œæ¨™è¨˜ç‚ºå›°é›£å–®å­—
    if (!isCorrect) {
      this.markWordAsDifficult(currentQuestion.word);
    }
    
    // é¡¯ç¤ºä¸‹ä¸€é¡ŒæŒ‰éˆ•æˆ–çµæŸæ¸¬é©—
    this.showNextButton();
  };
  
  // æ›´æ–°é¸é …æ¨£å¼
  FlashcardApp.prototype.updateOptionStyles = function(correctAnswer, selectedAnswer) {
    var options = document.querySelectorAll('.quiz-option');
    
    for (var i = 0; i < options.length; i++) {
      var option = options[i];
      var optionAnswer = option.getAttribute('data-answer');
      
      option.classList.add('disabled');
      
      if (optionAnswer === correctAnswer) {
        option.classList.add('correct');
      } else if (optionAnswer === selectedAnswer) {
        option.classList.add('wrong');
      }
    }
  };
  
  // é¡¯ç¤ºç­”æ¡ˆå›é¥‹
  FlashcardApp.prototype.showAnswerFeedback = function(isCorrect, question) {
    var feedback = document.getElementById('quiz-feedback');
    var feedbackResult = document.getElementById('quiz-feedback-result');
    var feedbackExplanation = document.getElementById('quiz-feedback-explanation');
    
    if (!feedback) return;
    
    feedback.className = 'quiz-feedback ' + (isCorrect ? 'correct' : 'wrong');
    feedback.style.display = 'block';
    
    if (feedbackResult) {
      feedbackResult.textContent = isCorrect ? 'âœ… ç­”å°äº†ï¼' : 'âŒ ç­”éŒ¯äº†ï¼';
    }
    
    if (feedbackExplanation) {
      var explanation = question.word.english + ' çš„æ„æ€æ˜¯ã€Œ' + question.word.chinese + 'ã€';
      feedbackExplanation.textContent = explanation;
    }
    
    // æ’­æ”¾èªéŸ³ï¼ˆå¦‚æœæ˜¯è‹±æ–‡å–®å­—ï¼‰
    if (this.voiceSettings.enabled) {
      var self = this;
      setTimeout(function() {
        self.speakWord(question.word.english);
      }, 500);
    }
  };
  
  // é¡¯ç¤ºä¸‹ä¸€é¡ŒæŒ‰éˆ•
  FlashcardApp.prototype.showNextButton = function() {
    var nextBtn = document.getElementById('quiz-next');
    if (nextBtn) {
      var isLastQuestion = this.quizState.currentQuestionIndex >= this.quizState.questions.length - 1;
      nextBtn.textContent = isLastQuestion ? 'æŸ¥çœ‹çµæœ' : 'ä¸‹ä¸€é¡Œ';
      nextBtn.style.display = 'inline-block';
    }
  };
  
  // ä¸‹ä¸€é¡Œæˆ–é¡¯ç¤ºçµæœ
  FlashcardApp.prototype.nextQuestion = function() {
    this.quizState.currentQuestionIndex++;
    
    if (this.quizState.currentQuestionIndex >= this.quizState.questions.length) {
      // æ¸¬é©—çµæŸï¼Œé¡¯ç¤ºçµæœ
      this.showQuizResult();
    } else {
      // é¡¯ç¤ºä¸‹ä¸€é¡Œ
      this.showQuestion();
    }
  };
  
  // é¡¯ç¤ºæ¸¬é©—çµæœ
  FlashcardApp.prototype.showQuizResult = function() {
    console.log('é¡¯ç¤ºæ¸¬é©—çµæœ');
    
    this.quizState.endTime = new Date();
    
    var totalQuestions = this.quizState.questions.length;
    var correctCount = this.quizState.answers.filter(function(a) { return a.isCorrect; }).length;
    var wrongCount = totalQuestions - correctCount;
    var finalScore = Math.round((correctCount / totalQuestions) * 100);
    
    // æ›´æ–°çµæœé¡¯ç¤º
    var resultIcon = document.getElementById('quiz-result-icon');
    var resultTitle = document.getElementById('quiz-result-title');
    var finalScoreElement = document.getElementById('quiz-final-score');
    var correctCountElement = document.getElementById('quiz-correct-count');
    var wrongCountElement = document.getElementById('quiz-wrong-count');
    var resultMessage = document.getElementById('quiz-result-message');
    
    if (resultIcon) {
      if (finalScore >= 90) {
        resultIcon.textContent = 'ğŸ†';
      } else if (finalScore >= 80) {
        resultIcon.textContent = 'ğŸ‰';
      } else if (finalScore >= 70) {
        resultIcon.textContent = 'ğŸ‘';
      } else {
        resultIcon.textContent = 'ğŸ’ª';
      }
    }
    
    if (resultTitle) {
      resultTitle.textContent = 'æ¸¬é©—å®Œæˆï¼';
    }
    
    if (finalScoreElement) {
      finalScoreElement.textContent = finalScore;
    }
    
    if (correctCountElement) {
      correctCountElement.textContent = correctCount;
    }
    
    if (wrongCountElement) {
      wrongCountElement.textContent = wrongCount;
    }
    
    if (resultMessage) {
      var message = this.getResultMessage(finalScore);
      resultMessage.textContent = message;
    }
    
    // é¡¯ç¤ºéŒ¯é¡Œå›é¡§
    this.showWrongReview();
    
    this.showQuizScreen('result');
  };
  
  // ç²å–çµæœè©•èª
  FlashcardApp.prototype.getResultMessage = function(score) {
    if (score >= 90) {
      return 'å¤ªæ£’äº†ï¼ä½ æ˜¯è‹±æ–‡å–®å­—å°é«˜æ‰‹ï¼ğŸ†';
    } else if (score >= 80) {
      return 'å¾ˆå¥½ï¼ä½ çš„è‹±æ–‡å–®å­—æŒæ¡å¾—ä¸éŒ¯ï¼ğŸ‘';
    } else if (score >= 70) {
      return 'ä¸éŒ¯å“¦ï¼ç¹¼çºŒåŠªåŠ›å°±æœƒæ›´æ£’ï¼ğŸ’ª';
    } else if (score >= 60) {
      return 'é‚„å¯ä»¥ï¼å¤šå¤šç·´ç¿’æœƒé€²æ­¥çš„ï¼ğŸ“š';
    } else {
      return 'åŠ æ²¹ï¼å¤šè®€å¤šç·´ç¿’ä¸€å®šæœƒé€²æ­¥çš„ï¼ğŸŒŸ';
    }
  };
  
  // é¡¯ç¤ºéŒ¯é¡Œå›é¡§
  FlashcardApp.prototype.showWrongReview = function() {
    var wrongAnswers = this.quizState.answers.filter(function(a) { return !a.isCorrect; });
    var wrongReview = document.getElementById('quiz-wrong-review');
    var wrongList = document.getElementById('quiz-wrong-list');
    
    if (wrongAnswers.length === 0) {
      if (wrongReview) {
        wrongReview.style.display = 'none';
      }
      return;
    }
    
    if (wrongReview) {
      wrongReview.style.display = 'block';
    }
    
    if (wrongList) {
      wrongList.innerHTML = '';
      
      for (var i = 0; i < wrongAnswers.length; i++) {
        var answer = wrongAnswers[i];
        var item = document.createElement('div');
        item.className = 'quiz-wrong-item';
        
        item.innerHTML = 
          '<div class="quiz-wrong-word">' + answer.question.word.english + '</div>' +
          '<div>' +
            '<div class="quiz-wrong-answer">ä½ çš„ç­”æ¡ˆï¼š' + answer.selectedAnswer + '</div>' +
            '<div class="quiz-wrong-correct">æ­£ç¢ºç­”æ¡ˆï¼š' + answer.question.correctAnswer + '</div>' +
          '</div>';
        
        wrongList.appendChild(item);
      }
    }
  };
  
  // æ¨™è¨˜å–®å­—ç‚ºå›°é›£ï¼ˆæ¸¬é©—ç­”éŒ¯æ™‚å‘¼å«ï¼‰- å¢åŠ ä¸ç†Ÿç¨‹åº¦ +1
  FlashcardApp.prototype.markWordAsDifficult = function(word) {
    var newLevel = Math.min(10, (word.difficultyLevel || 0) + 1);
    word.difficultyLevel = newLevel;
    
    // åŒæ­¥åˆ° words ä¸»é™£åˆ—
    var mainWord = this.words.find(function(w) { return w.id === word.id; });
    if (mainWord) mainWord.difficultyLevel = newLevel;
    
    console.log('æ¸¬é©—ç­”éŒ¯ï¼Œå¢åŠ ä¸ç†Ÿç¨‹åº¦:', word.english, 'â†’ â˜…' + newLevel);
    
    // åŒæ­¥åˆ°å¾Œç«¯
    this.syncDifficultyToBackend(word);
  };
  
  // é‡æ–°é–‹å§‹æ¸¬é©—
  FlashcardApp.prototype.restartQuiz = function() {
    console.log('é‡æ–°é–‹å§‹æ¸¬é©—');
    
    // é‡æ–°ç²å–ç•¶å‰å¯ç”¨çš„å–®å­—ï¼ˆå¯èƒ½å·²ç¶“è®ŠåŒ–ï¼‰
    var availableWords = this.getCurrentAvailableWords();
    if (availableWords.length === 0) {
      var message = this.getNoWordsMessage();
      alert(message);
      this.closeQuizModal();
      return;
    }
    
    // æª¢æŸ¥å¿«é€Ÿæ¸¬é©—çš„å–®å­—æ•¸é‡
    if (this.quizState.type === 'quick' && availableWords.length < 3) {
      alert('å¯ç”¨å–®å­—å¤ªå°‘ï¼ˆå°‘æ–¼3å€‹ï¼‰ï¼Œç„¡æ³•é€²è¡Œæ¸¬é©—ã€‚è«‹å¢åŠ æ›´å¤šå–®å­—æˆ–èª¿æ•´ç¯©é¸æ¢ä»¶ã€‚');
      this.closeQuizModal();
      return;
    }
    
    // æ›´æ–°å¯ç”¨å–®å­—
    this.quizState.availableWords = availableWords;
    
    // é‡æ–°ç”Ÿæˆé¡Œç›®
    this.generateQuestions(this.quizState.type);
    
    // é‡æ–°è¨­ç½®ç‹€æ…‹
    this.quizState.currentQuestionIndex = 0;
    this.quizState.selectedAnswer = null;
    this.quizState.answers = [];
    this.quizState.score = 0;
    this.quizState.startTime = new Date();
    this.quizState.endTime = null;
    
    this.showQuizScreen('start');
  };
  
  // ç¦ç”¨é˜²æ­¢è¢å¹•é—œé–‰åŠŸèƒ½
  FlashcardApp.prototype.disableKeepScreenAwake = function() {
    console.log('ç¦ç”¨é˜²æ­¢è¢å¹•é—œé–‰åŠŸèƒ½');
    this.keepScreenAwake = false;
    
    // é‡‹æ”¾Wake Lock
    if (this.wakeLock) {
      this.wakeLock.release();
      this.wakeLock = null;
    }
    
    // åœæ­¢NoSleepè¦–é »
    if (this.noSleepVideo) {
      this.noSleepVideo.pause();
      if (this.noSleepVideo.parentNode) {
        this.noSleepVideo.parentNode.removeChild(this.noSleepVideo);
      }
      this.noSleepVideo = null;
    }
  };
  
  // å…¨åŸŸè®Šæ•¸
  var app;
  
  // é é¢è¼‰å…¥å®Œæˆå¾Œå•Ÿå‹•
  window.addEventListener('load', function() {
    try {
      console.log('é é¢è¼‰å…¥å®Œæˆï¼Œå•Ÿå‹•FlashcardApp');
      app = new FlashcardApp();
      
      // èªéŸ³åˆ—è¡¨è¼‰å…¥å¾Œå¡«å……èªéŸ³è…”èª¿é¸å–®
    if (window.speechSynthesis) {
        window.speechSynthesis.onvoiceschanged = function() {
          if (app && typeof app.populateVoiceSelect === 'function') {
          app.populateVoiceSelect();
        }
      };
    }
    
    // é é¢å¸è¼‰æ™‚æ¸…ç†è³‡æºä¸¦åŒæ­¥è¤‡ç¿’æ—¥æœŸ
    window.addEventListener('beforeunload', function() {
      if (app) {
        if (typeof app.syncReviewDates === 'function') {
          app.syncReviewDates();
        }
        if (typeof app.disableKeepScreenAwake === 'function') {
          app.disableKeepScreenAwake();
        }
      }
    });
    } catch (error) {
      console.error('æ‡‰ç”¨å•Ÿå‹•å¤±æ•—:', error);
      var loadingDiv = document.getElementById('loading');
      var errorDiv = document.getElementById('error');
      if (loadingDiv) loadingDiv.style.display = 'none';
      if (errorDiv) {
        errorDiv.style.display = 'block';
        errorDiv.innerHTML = '<h2>å•Ÿå‹•å¤±æ•—</h2><p>è«‹é‡æ–°æ•´ç†é é¢ï¼ŒéŒ¯èª¤ï¼š' + error.message + '</p>';
      }
    }
  });
  
  console.log('FlashcardApp ES5å…¼å®¹ç‰ˆæœ¬å·²è¼‰å…¥');
</script>

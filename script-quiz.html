<!-- script-quiz.html -->
<script>
  /**
   * @module script-quiz
   * @description é˜²è¢å¹•ä¼‘çœ èˆ‡æ¸¬é©—æ¨¡çµ„ï¼šå¤šå±¤é˜²è¢å¹•é—œé–‰æ©Ÿåˆ¶ï¼ˆWake Lockã€NoSleep è¦–é »ã€
   *   æŒçºŒéœéŸ³éŸ³é »ã€Keep-aliveï¼‰ï¼Œä»¥åŠå®Œæ•´æ¸¬é©—ç³»çµ±ï¼ˆå¿«é€Ÿ / å®Œæ•´æ¸¬é©—ã€é¡Œç›®ç”Ÿæˆã€
   *   è¨ˆåˆ†ã€éŒ¯é¡Œå›é¡§ï¼‰ã€‚
   *
   * @dependencies script-core.html (FlashcardApp, APP_CONSTANTS)
   * @provides FlashcardApp.prototype: enableKeepScreenAwake, disableKeepScreenAwake,
   *   startQuiz, generateQuestions, createQuestion, selectAnswer, showQuizResult,
   *   markWordAsDifficult, restartQuiz ...
   */

  // ==========================================================================
  // Android èƒŒæ™¯åŸ·è¡Œæ”¯æ´ï¼šWeb Worker è¨ˆæ™‚å™¨ + å¯è¦‹æ€§è£œå„Ÿ
  // ==========================================================================
  
  // æª¢æ¸¬æ˜¯å¦ç‚º Android è£ç½®
  FlashcardApp.prototype._isAndroidDevice = function() {
    return /Android/i.test(navigator.userAgent);
  };
  
  // å»ºç«‹èƒŒæ™¯è¨ˆæ™‚ Web Workerï¼ˆAndroid èƒŒæ™¯åŸ·è¡Œçš„é—œéµï¼‰
  // Web Worker çš„ setTimeout ä¸å—ä¸»åŸ·è¡Œç·’çš„èƒŒæ™¯ç¯€æµé™åˆ¶
  FlashcardApp.prototype._createBackgroundWorker = function() {
    if (this._bgWorker) return;
    
    try {
      var workerCode =
        'var timers = {};' +
        'self.onmessage = function(e) {' +
        '  var d = e.data;' +
        '  if (d.type === "setTimeout") {' +
        '    timers[d.id] = setTimeout(function() {' +
        '      self.postMessage({ type: "timeout", id: d.id });' +
        '      delete timers[d.id];' +
        '    }, d.delay);' +
        '  } else if (d.type === "clearTimeout") {' +
        '    if (timers[d.id]) {' +
        '      clearTimeout(timers[d.id]);' +
        '      delete timers[d.id];' +
        '    }' +
        '  }' +
        '};';
      
      var blob = new Blob([workerCode], { type: 'application/javascript' });
      var workerUrl = URL.createObjectURL(blob);
      this._bgWorker = new Worker(workerUrl);
      
      var self = this;
      this._bgWorker.onmessage = function(e) {
        var data = e.data;
        if (data.type === 'timeout') {
          var entry = self._bgWorkerCallbacks[data.id];
          if (entry && entry.fn) {
            delete self._bgWorkerCallbacks[data.id];
            entry.fn();
          }
        }
      };
      
      this._bgWorker.onerror = function(e) {
        console.log('Web Worker éŒ¯èª¤:', e.message);
      };
      
      console.log('èƒŒæ™¯è¨ˆæ™‚ Web Worker å·²å»ºç«‹');
    } catch (error) {
      console.log('ç„¡æ³•å»ºç«‹èƒŒæ™¯ Web Workerï¼ˆä¸å½±éŸ¿æ­£å¸¸ä½¿ç”¨ï¼‰:', error.message || error);
      this._bgWorker = null;
    }
  };
  
  // â˜… è¨­å®šå¯åœ¨èƒŒæ™¯åŸ·è¡Œçš„é¡¯ç¤ºè¨ˆæ™‚å™¨
  // åŒæ™‚åœ¨ä¸»åŸ·è¡Œç·’å’Œ Web Worker è¨­å®š setTimeoutï¼Œ
  // å“ªå€‹å…ˆè§¸ç™¼å°±åŸ·è¡Œ callback ä¸¦å–æ¶ˆå¦ä¸€å€‹ï¼Œ
  // ç¢ºä¿ Android èƒŒæ™¯æ™‚è¨ˆæ™‚å™¨ä»èƒ½æ­£å¸¸è§¸ç™¼
  FlashcardApp.prototype._setDisplayTimer = function(callback, delay) {
    var self = this;
    
    // å…ˆæ¸…é™¤èˆŠçš„è¨ˆæ™‚å™¨
    this._clearDisplayTimer();
    
    var fired = false;
    
    var execute = function() {
      if (fired) return;
      fired = true;
      self._clearDisplayTimer();
      callback();
    };
    
    // ä¸»åŸ·è¡Œç·’è¨ˆæ™‚å™¨
    this.displayTimer = setTimeout(execute, delay);
    
    // Web Worker èƒŒæ™¯è¨ˆæ™‚å™¨ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    var bgId = null;
    if (this._bgWorker) {
      bgId = this._bgWorkerNextId++;
      this._bgWorkerCallbacks[bgId] = { fn: execute };
      try {
        this._bgWorker.postMessage({ type: 'setTimeout', id: bgId, delay: delay });
      } catch (e) {
        // Worker é€šè¨Šå¤±æ•—ï¼Œåªç”¨ä¸»åŸ·è¡Œç·’è¨ˆæ™‚å™¨
      }
    }
    
    // è¿½è¹¤è¨ˆæ™‚å™¨è³‡è¨Šï¼ˆç”¨æ–¼ visibilitychange è£œå„Ÿï¼‰
    this._activeTimerInfo = {
      setAt: Date.now(),
      delay: delay,
      execute: execute,
      bgId: bgId
    };
  };
  
  // æ¸…é™¤é¡¯ç¤ºè¨ˆæ™‚å™¨ï¼ˆåŒæ™‚æ¸…é™¤ä¸»åŸ·è¡Œç·’å’Œ Worker çš„è¨ˆæ™‚å™¨ï¼‰
  FlashcardApp.prototype._clearDisplayTimer = function() {
    if (this.displayTimer) {
      clearTimeout(this.displayTimer);
      this.displayTimer = null;
    }
    
    // æ¸…é™¤ Web Worker è¨ˆæ™‚å™¨
    if (this._activeTimerInfo && this._activeTimerInfo.bgId && this._bgWorker) {
      try {
        this._bgWorker.postMessage({ type: 'clearTimeout', id: this._activeTimerInfo.bgId });
      } catch (e) {}
      if (this._bgWorkerCallbacks) {
        delete this._bgWorkerCallbacks[this._activeTimerInfo.bgId];
      }
    }
    
    this._activeTimerInfo = null;
  };
  
  // é é¢é‡æ–°å¯è¦‹æ™‚çš„è£œå„Ÿè™•ç†ï¼ˆAndroid èƒŒæ™¯æ¢å¾©çš„å®‰å…¨ç¶²ï¼‰
  // å³ä½¿ Web Worker è¨ˆæ™‚å™¨æœªèƒ½è§¸ç™¼ï¼Œæ­¤æ–¹æ³•ä¹Ÿæœƒåœ¨é é¢é‡æ–°å¯è¦‹æ™‚è£œå„Ÿ
  FlashcardApp.prototype._handleVisibilityResume = function() {
    // å¦‚æœæš«åœä¸­æˆ–æ²’æœ‰æ´»èºè¨ˆæ™‚å™¨ï¼Œä¸è™•ç†
    if (this.isPaused || !this._activeTimerInfo) return;
    
    var elapsed = Date.now() - this._activeTimerInfo.setAt;
    if (elapsed >= this._activeTimerInfo.delay) {
      console.log('èƒŒæ™¯æ¢å¾©ï¼šè¨ˆæ™‚å™¨å·²åˆ°æœŸï¼ˆç¶“é ' + Math.round(elapsed / 1000) + ' ç§’ï¼‰ï¼Œç«‹å³è§¸ç™¼');
      var execute = this._activeTimerInfo.execute;
      if (execute) {
        execute();
      }
    }
    
    // å˜—è©¦æ¢å¾©è¢«æš«åœçš„ SpeechSynthesisï¼ˆAndroid Chrome èƒŒæ™¯æœƒæš«åœèªéŸ³ï¼‰
    try {
      if (this.speechSynthesis && this.speechSynthesis.paused) {
        this.speechSynthesis.resume();
        console.log('SpeechSynthesis å·²æ¢å¾©');
      }
    } catch (e) {}
  };
  
  // é˜²æ­¢è¢å¹•é—œé–‰åŠŸèƒ½
  // åŒæ™‚å˜—è©¦å¤šç¨®æ–¹æ³•ï¼Œä¸¦åœ¨é¦–æ¬¡ç”¨æˆ¶äº’å‹•æ™‚é‡è©¦
  // æ ¸å¿ƒæ–¹æ³•ï¼šAudioContext + MediaStreamDestination + <audio> å…ƒç´ ï¼ˆiOS Safari 11+ æœ‰æ•ˆï¼‰
  FlashcardApp.prototype.enableKeepScreenAwake = function() {
    console.log('å•Ÿç”¨é˜²æ­¢è¢å¹•é—œé–‰åŠŸèƒ½');
    var self = this;
    this.keepScreenAwake = true;
    this._wakeLockAcquired = false;
    this._noSleepVideoPlaying = false;
    this._persistentAudioRunning = false;
    
    // æ–¹æ³• 0ï¼šå»ºç«‹èƒŒæ™¯è¨ˆæ™‚ Web Workerï¼ˆAndroid èƒŒæ™¯åŸ·è¡Œçš„é—œéµï¼‰
    this._createBackgroundWorker();
    
    // æ–¹æ³• 1ï¼šå˜—è©¦ Wake Lock APIï¼ˆç¾ä»£ç€è¦½å™¨ï¼Œå¯èƒ½åœ¨ iframe ä¸­å¤±æ•—ï¼‰
    this._requestWakeLock();
    
    // æ–¹æ³• 2ï¼šæº–å‚™ NoSleep ç„¡è²è¦–é »ï¼ˆèˆŠç‰ˆ iOS åŠ Androidï¼‰
    this._prepareNoSleepVideo();
    
    // æ–¹æ³• 3ï¼šKeep-alive å‚™ç”¨æ–¹æ¡ˆï¼ˆå§‹çµ‚å•Ÿç”¨ï¼‰
    this._startKeepAlive();
    
    // é—œéµï¼šæ¯æ¬¡ç”¨æˆ¶äº’å‹•æ™‚å•Ÿå‹•/æ¢å¾©æŒçºŒéœéŸ³éŸ³é »ï¼ˆiOS Safari å¿…é ˆåœ¨ user gesture ä¸­å•Ÿå‹•ï¼‰
    this._setupWakeGestureActivation();
    
    // å®šæœŸç›£æ§éŸ³é »ç‹€æ…‹ï¼ˆæ¯ 10 ç§’ï¼‰
    this._startAudioWatchdog();
    
    // é é¢é‡æ–°å¯è¦‹æ™‚æ¢å¾©æ‰€æœ‰é˜²è¢å¹•é—œé–‰æ©Ÿåˆ¶ + Android èƒŒæ™¯è¨ˆæ™‚å™¨è£œå„Ÿ
    document.addEventListener('visibilitychange', function() {
      if (document.visibilityState === 'visible') {
        // æ¢å¾©é˜²è¢å¹•é—œé–‰æ©Ÿåˆ¶
        if (self.keepScreenAwake) {
          console.log('é é¢é‡æ–°å¯è¦‹ï¼Œé‡è©¦é˜²è¢å¹•é—œé–‰');
          self._requestWakeLock();
          self._resumePersistentAudio();
          if (self.noSleepVideo && self.noSleepVideo.paused) {
            var playPromise = self.noSleepVideo.play();
            if (playPromise !== undefined) {
              playPromise.then(function() {
                self._noSleepVideoPlaying = true;
              }).catch(function() {});
            }
          }
        }
        // Android èƒŒæ™¯æ¢å¾©ï¼šæª¢æŸ¥è¨ˆæ™‚å™¨ç‹€æ…‹ä¸¦è£œå„Ÿï¼ˆå®‰å…¨ç¶²ï¼‰
        self._handleVisibilityResume();
      }
    });
  };
  
  // å˜—è©¦å–å¾— Wake Lockï¼ˆéåŒæ­¥ï¼Œä¸é˜»æ“‹å…¶ä»–æ–¹æ³•ï¼‰
  FlashcardApp.prototype._requestWakeLock = function() {
    if (!('wakeLock' in navigator)) return;
    var self = this;
    try {
      navigator.wakeLock.request('screen').then(function(wakeLock) {
        self.wakeLock = wakeLock;
        self._wakeLockAcquired = true;
        console.log('Wake Lock API å·²å•Ÿç”¨');
        
        // ç›£è½ Wake Lock è¢«é‡‹æ”¾ï¼ˆä¾‹å¦‚åˆ‡æ›åˆ†é ï¼‰
        wakeLock.addEventListener('release', function() {
          console.log('Wake Lock è¢«é‡‹æ”¾');
          self._wakeLockAcquired = false;
        });
      }).catch(function(error) {
        console.log('Wake Lock API è«‹æ±‚å¤±æ•—:', error.message || error);
        self._wakeLockAcquired = false;
      });
    } catch (error) {
      console.log('Wake Lock API ç•°å¸¸:', error);
    }
  };
  
  // æº–å‚™ NoSleep ç„¡è²è¦–é »ï¼ˆå»ºç«‹å…ƒç´ ä¸¦å˜—è©¦æ’­æ”¾ï¼‰
  FlashcardApp.prototype._prepareNoSleepVideo = function() {
    if (this.noSleepVideo) return; // å·²å»ºç«‹
    try {
      var video = document.createElement('video');
      video.setAttribute('muted', '');
      video.setAttribute('playsinline', '');
      video.setAttribute('webkit-playsinline', '');
      video.setAttribute('loop', '');
      video.muted = true; // åŒæ™‚è¨­å®šå±¬æ€§ï¼Œç¢ºä¿ iOS ç›¸å®¹
      video.style.position = 'fixed';
      video.style.top = '0';
      video.style.left = '0';
      video.style.width = '1px';
      video.style.height = '1px';
      video.style.opacity = '0.01';
      video.style.pointerEvents = 'none';
      video.style.zIndex = '-1';
      
      // 1x1 åƒç´ æ¥µçŸ­ç„¡è² MP4 è¦–é »ï¼ˆdata URLï¼‰
      var videoDataUrl = 'data:video/mp4;base64,AAAAIGZ0eXBtcDQyAAACAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQAAAr1tZGF0AAACrgYF//+q3EXpvebZSLeWLNgg2SPu73gyNjQgLSBjb3JlIDE0OCByMjYwMSBNIGU5YjVmMzMgLSBILjI2NC9NUEVHLTQgQVZDIGNvZGVjIC0gQ29weWxlZnQgMjAwMy0yMDE2IC0gaHR0cDovL3d3dy52aWRlb2xhbi5vcmcveDI2NC5odG1sIC0gb3B0aW9uczogY2FiYWM9MSByZWY9MyBkZWJsb2NrPTE6MDowIGFuYWx5c2U9MHgzOjB4MTEzIG1lPWhleCBzdWJtZT03IHBzeT0xIHBzeV9yZD0xLjAwOjAuMDAgbWl4ZWRfcmVmPTEgbWVfcmFuZ2U9MTYgY2hyb21hX21lPTEgdHJlbGxpcz0xIDh4OGRjdD0xIGNxbT0wIGRlYWR6b25lPTIxLDExIGZhc3RfcHNraXA9MSBjaHJvbWFfcXBfb2Zmc2V0PS0yIHRocmVhZHM9MSBsb29rYWhlYWRfdGhyZWFkcz0xIHNsaWNlZF90aHJlYWRzPTAgbnI9MCBkZWNpbWF0ZT0xIGludGVybGFjZWQ9MCBibHVyYXlfY29tcGF0PTAgY29uc3RyYWluZWRfaW50cmE9MCBicmFtZXM9MyBiX3B5cmFtaWQ9MiBiX2FkYXB0PTEgYl9iaWFzPTAgZGlyZWN0PTEgd2VpZ2h0Yj0xIG9wZW5fZ29wPTAgd2VpZ2h0cD0yIGtleWludD0yNTAga2V5aW50X21pbj0yNSBzY2VuZWN1dD00MCBpbnRyYV9yZWZyZXNoPTAgcmNfbG9va2FoZWFkPTQwIHJjPWNyZiBtYnRyZWU9MSBjcmY9MjMuMCBxY29tcD0wLjYwIHFwbWluPTAgcXBtYXg9NjkgcXBzdGVwPTQgaXBfcmF0aW89MS40MCBhcT0xOjEuMDAAgAAAAFZliIQL8mKAAKvMnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycH//2Q==';
      
      video.src = videoDataUrl;
      
      document.body.appendChild(video);
      this.noSleepVideo = video;
      
      // å˜—è©¦ç«‹å³æ’­æ”¾ï¼ˆiOS ä¸Šå¯èƒ½å› ç¼ºå°‘ user gesture è€Œå¤±æ•—ï¼‰
      var self = this;
      var playPromise = video.play();
      if (playPromise !== undefined) {
        playPromise.then(function() {
          console.log('NoSleep è¦–é »å·²é–‹å§‹æ’­æ”¾');
          self._noSleepVideoPlaying = true;
        }).catch(function(error) {
          console.log('NoSleep è¦–é »éœ€è¦ç”¨æˆ¶äº’å‹•æ‰èƒ½æ’­æ”¾:', error.message || error);
          // ä¸ç§»é™¤è¦–é »å…ƒç´ ï¼Œç¨å¾Œåœ¨ç”¨æˆ¶äº’å‹•æ™‚é‡è©¦
        });
      }
    } catch (error) {
      console.log('å‰µå»º NoSleep è¦–é »å¤±æ•—:', error);
    }
  };
  
  // â˜… æ ¸å¿ƒæ–¹æ³•ï¼šå•Ÿå‹•æŒçºŒéœéŸ³éŸ³é »ï¼ˆiOS Safari é˜²è¢å¹•ä¼‘çœ çš„é—œéµï¼‰
  // åŒæ™‚å•Ÿå‹•å…©ç¨®éŸ³é »è¼¸å‡ºï¼š
  //   A) oscillator â†’ å–‡å­ï¼ˆç›´æ¥éŸ³é »è¼¸å‡ºï¼ŒiOS è¦–ç‚ºæ´»èºéŸ³é »ï¼‰
  //   B) AudioContext â†’ MediaStreamDestination â†’ <audio> å…ƒç´ ï¼ˆiOS 15+ æœ‰æ•ˆï¼‰
  // å¿…é ˆåœ¨ user gesture ä¸­å‘¼å«
  FlashcardApp.prototype._startPersistentAudio = function() {
    var AudioCtx = window.AudioContext || window.webkitAudioContext;
    if (!AudioCtx) {
      console.log('AudioContext ä¸å¯ç”¨');
      return;
    }
    
    try {
      // å¦‚æœå·²æœ‰ AudioContext ä¸”æ²’æœ‰è¢«é—œé–‰ï¼Œå…ˆå˜—è©¦æ¢å¾©
      if (this._persistentAudioContext && this._persistentAudioContext.state !== 'closed') {
        this._resumePersistentAudio();
        return;
      }
      
      var ctx = new AudioCtx();
      this._persistentAudioContext = ctx;
      
      // ===== æ–¹æ³• Aï¼šoscillator ç›´æ¥è¼¸å‡ºåˆ°å–‡å­ =====
      // ä½¿ç”¨è¶…é«˜é »ï¼ˆ20kHzï¼‰+ æ¥µä½éŸ³é‡ï¼Œäººè€³è½ä¸åˆ°ä½† iOS è¦–ç‚ºæ´»èºéŸ³é »
      try {
        var oscillator = ctx.createOscillator();
        var gainNode = ctx.createGain();
        gainNode.gain.value = 0.001;
        oscillator.frequency.value = 20000;
        oscillator.connect(gainNode);
        gainNode.connect(ctx.destination);
        oscillator.start(0);
        this._persistentOscillator = oscillator;
        console.log('æŒçºŒéœéŸ³ oscillator å·²å•Ÿå‹•');
      } catch (oscError) {
        console.log('oscillator å•Ÿå‹•å¤±æ•—:', oscError);
      }
      
      // ===== æ–¹æ³• Bï¼šMediaStream â†’ <audio> å…ƒç´  =====
      if (typeof ctx.createMediaStreamDestination === 'function') {
        try {
          var bufferSize = 2 * ctx.sampleRate;
          var emptyBuffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
          // buffer é è¨­å·²æ˜¯ 0ï¼ˆéœéŸ³ï¼‰ï¼Œä¸éœ€è¦å¡«å……
          
          var source = ctx.createBufferSource();
          source.buffer = emptyBuffer;
          source.loop = true;
          
          var streamDest = ctx.createMediaStreamDestination();
          source.connect(streamDest);
          source.start(0);
          
          var audio = document.createElement('audio');
          audio.style.display = 'none';
          audio.loop = true;
          document.body.appendChild(audio);
          audio.srcObject = streamDest.stream;
          
          var self = this;
          var playPromise = audio.play();
          if (playPromise !== undefined) {
            playPromise.then(function() {
              console.log('MediaStream <audio> å·²å•Ÿå‹•');
            }).catch(function(error) {
              console.log('MediaStream <audio> æ’­æ”¾å¤±æ•—:', error.message || error);
            });
          }
          
          this._persistentAudioElement = audio;
          this._persistentAudioSource = source;
        } catch (msError) {
          console.log('MediaStream æ–¹æ³•å¤±æ•—:', msError);
        }
      }
      
      this._persistentAudioRunning = true;
      console.log('æŒçºŒéœéŸ³éŸ³é »ç³»çµ±å·²å•Ÿå‹•');
      
    } catch (error) {
      console.log('å•Ÿå‹•æŒçºŒéœéŸ³éŸ³é »å¤±æ•—:', error);
    }
  };
  
  // æ¢å¾©æŒçºŒéœéŸ³éŸ³é »ï¼ˆiOS æœƒåœ¨å„ç¨®æƒ…æ³ä¸‹æš«åœ AudioContextï¼‰
  FlashcardApp.prototype._resumePersistentAudio = function() {
    try {
      if (this._persistentAudioContext) {
        var state = this._persistentAudioContext.state;
        if (state === 'suspended' || state === 'interrupted') {
          this._persistentAudioContext.resume();
          console.log('AudioContext å·²æ¢å¾© (åŸç‹€æ…‹: ' + state + ')');
        }
      }
      if (this._persistentAudioElement && this._persistentAudioElement.paused) {
        var playPromise = this._persistentAudioElement.play();
        if (playPromise !== undefined) {
          playPromise.then(function() {
            console.log('æŒçºŒéœéŸ³ <audio> å·²æ¢å¾©æ’­æ”¾');
          }).catch(function() {});
        }
      }
    } catch (error) {
      console.log('æ¢å¾©æŒçºŒéœéŸ³éŸ³é »å¤±æ•—:', error);
    }
  };
  
  // â˜… æ¯æ¬¡ç”¨æˆ¶äº’å‹•æ™‚éƒ½å˜—è©¦å•Ÿå‹•/æ¢å¾©é˜²è¢å¹•é—œé–‰
  // ä¸ç§»é™¤ç›£è½å™¨ â€”â€” iOS å¯èƒ½éš¨æ™‚æš«åœ AudioContextï¼Œéœ€è¦åœ¨ä¸‹æ¬¡æ‰‹å‹¢ä¸­æ¢å¾©
  FlashcardApp.prototype._setupWakeGestureActivation = function() {
    var self = this;
    
    var activateOnGesture = function() {
      if (!self.keepScreenAwake) return;
      
      // å•Ÿå‹•æˆ–æ¢å¾©æŒçºŒéœéŸ³éŸ³é »
      if (!self._persistentAudioRunning) {
        self._startPersistentAudio();
      } else {
        self._resumePersistentAudio();
      }
      
      // å˜—è©¦æ’­æ”¾ NoSleep è¦–é »
      if (self.noSleepVideo && self.noSleepVideo.paused) {
        var playPromise = self.noSleepVideo.play();
        if (playPromise !== undefined) {
          playPromise.then(function() {
            self._noSleepVideoPlaying = true;
          }).catch(function() {});
        }
      }
      
      // è‹¥ Wake Lock å°šæœªå–å¾—ï¼Œé‡è©¦
      if (!self._wakeLockAcquired) {
        self._requestWakeLock();
      }
    };
    
    // â˜… ä¸ç§»é™¤ç›£è½å™¨ â€”â€” æ¯æ¬¡è§¸ç¢°éƒ½å˜—è©¦æ¢å¾©
    document.addEventListener('touchstart', activateOnGesture, true);
    document.addEventListener('touchend', activateOnGesture, true);
    document.addEventListener('click', activateOnGesture, true);
  };
  
  // å®šæœŸç›£æ§ï¼šæ¯ 10 ç§’æª¢æŸ¥éŸ³é »æ˜¯å¦ä»åœ¨é‹è¡Œï¼Œå˜—è©¦æ¢å¾©
  FlashcardApp.prototype._startAudioWatchdog = function() {
    var self = this;
    setInterval(function() {
      if (!self.keepScreenAwake) return;
      if (!self._persistentAudioRunning) return;
      
      try {
        // æª¢æŸ¥ AudioContext æ˜¯å¦è¢«æš«åœ
        if (self._persistentAudioContext) {
          var state = self._persistentAudioContext.state;
          if (state === 'suspended' || state === 'interrupted') {
            console.log('Watchdog: AudioContext ç‹€æ…‹ç•°å¸¸ (' + state + ')ï¼Œå˜—è©¦æ¢å¾©');
            self._persistentAudioContext.resume();
          }
        }
        // æª¢æŸ¥ <audio> å…ƒç´ æ˜¯å¦åœæ­¢æ’­æ”¾
        if (self._persistentAudioElement && self._persistentAudioElement.paused) {
          console.log('Watchdog: <audio> å·²æš«åœï¼Œå˜—è©¦æ¢å¾©');
          var playPromise = self._persistentAudioElement.play();
          if (playPromise !== undefined) {
            playPromise.catch(function() {});
          }
        }
      } catch (error) {
        // éœé»˜å¿½ç•¥
      }
    }, APP_CONSTANTS.AUDIO_WATCHDOG_INTERVAL_MS);
  };
  
  // Keep-alive å‚™ç”¨æ–¹æ¡ˆï¼šå®šæœŸå¾®æ“ä½œ
  FlashcardApp.prototype._startKeepAlive = function() {
    var self = this;
    
    setInterval(function() {
      if (!self.keepScreenAwake) return;
      
      // å‰µå»ºæ¥µçŸ­çš„é«˜é »ç„¡è²éŸ³é »
      try {
        var AudioCtx = window.AudioContext || window.webkitAudioContext;
        if (AudioCtx) {
          var audioContext = new AudioCtx();
          var oscillator = audioContext.createOscillator();
          var gainNode = audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          gainNode.gain.value = 0.001;
          oscillator.frequency.value = 20000; // äººè€³è½ä¸åˆ°
          oscillator.start();
          oscillator.stop(audioContext.currentTime + 0.001);
          
          setTimeout(function() {
            try { audioContext.close(); } catch (e) {}
          }, 10);
        }
      } catch (error) {
        // éœé»˜å¿½ç•¥
      }
      
      // è§¸ç™¼æ¥µå°çš„ DOM æ“ä½œ
      try {
        var dummyDiv = document.createElement('div');
        dummyDiv.style.position = 'fixed';
        dummyDiv.style.top = '-1px';
        dummyDiv.style.left = '-1px';
        dummyDiv.style.width = '1px';
        dummyDiv.style.height = '1px';
        dummyDiv.style.opacity = '0';
        document.body.appendChild(dummyDiv);
        
        setTimeout(function() {
          if (dummyDiv.parentNode) {
            dummyDiv.parentNode.removeChild(dummyDiv);
          }
        }, 1);
      } catch (error) {
        // éœé»˜å¿½ç•¥
      }
    }, APP_CONSTANTS.KEEP_ALIVE_INTERVAL_MS);
  };
  
  // ==========================================================================
  // æ¸¬é©—åŠŸèƒ½ç›¸é—œæ–¹æ³• (Quiz Functions)
  // ==========================================================================
  
  // è¨­ç½®æ¸¬é©—æ¨¡æ…‹æ¡†äº‹ä»¶ç›£è½å™¨
  FlashcardApp.prototype.setupQuizListeners = function() {
    var self = this;
    
    // æ¸¬é©—æ¨¡æ…‹æ¡†å…ƒç´ 
    var quizModal = document.getElementById('quiz-modal');
    var closeQuizBtn = document.getElementById('close-quiz');
    var quizStartBtn = document.getElementById('quiz-start');
    var quizNextBtn = document.getElementById('quiz-next');
    var quizRestartBtn = document.getElementById('quiz-restart');
    var quizFinishBtn = document.getElementById('quiz-finish');
    
    // é—œé–‰æŒ‰éˆ•äº‹ä»¶
    if (closeQuizBtn) {
      closeQuizBtn.addEventListener('click', function() { self.closeQuizModal(); });
    }
    
    // æ¸¬é©—æµç¨‹æŒ‰éˆ•äº‹ä»¶
    if (quizStartBtn) {
      quizStartBtn.addEventListener('click', function() { self.beginQuiz(); });
    }
    if (quizNextBtn) {
      quizNextBtn.addEventListener('click', function() { self.nextQuestion(); });
    }
    if (quizRestartBtn) {
      quizRestartBtn.addEventListener('click', function() { self.restartQuiz(); });
    }
    if (quizFinishBtn) {
      quizFinishBtn.addEventListener('click', function() { self.closeQuizModal(); });
    }
    
    // æ¨¡æ…‹æ¡†é»æ“Šå¤–éƒ¨é—œé–‰ï¼ˆä½†åœ¨æ¸¬é©—é€²è¡Œä¸­ç¦ç”¨ï¼‰
    if (quizModal) {
      quizModal.addEventListener('click', function(e) {
        // æª¢æŸ¥æ˜¯å¦åœ¨æ¸¬é©—é€²è¡Œä¸­
        if (self.isQuizInProgress()) {
          console.log('æ¸¬é©—é€²è¡Œä¸­ï¼Œç¦ç”¨èƒŒæ™¯é»æ“Šé—œé–‰');
          return; // æ¸¬é©—é€²è¡Œä¸­ä¸å…è¨±èƒŒæ™¯é»æ“Šé—œé–‰
        }
        
        // æª¢æŸ¥é»æ“Šç›®æ¨™ï¼Œæ’é™¤selectå…ƒç´ åŠå…¶ç›¸é—œå…ƒç´ 
        var target = e.target;
        var isSelectRelated = false;
        
        var element = target;
        while (element && element !== quizModal) {
          if (element.tagName === 'SELECT' || 
              element.tagName === 'OPTION' ||
              element.classList.contains('setting-control')) {
            isSelectRelated = true;
            break;
          }
          element = element.parentElement;
        }
        
        if (e.target === quizModal && !isSelectRelated) {
          console.log('éæ¸¬é©—é€²è¡Œä¸­ï¼Œå…è¨±èƒŒæ™¯é»æ“Šé—œé–‰');
          self.closeQuizModal();
        }
      });
    }
  };
  
  // é–‹å§‹æ¸¬é©—
  FlashcardApp.prototype.startQuiz = function(type) {
    console.log('é–‹å§‹æ¸¬é©—ï¼Œé¡å‹:', type);
    
    // æª¢æŸ¥æ˜¯å¦æœ‰å–®å­—å¯ä»¥æ¸¬é©—
    if (!this.words || this.words.length === 0) {
      alert('æ²’æœ‰å–®å­—å¯ä»¥æ¸¬é©—ï¼è«‹å…ˆè¼‰å…¥å–®å­—ã€‚');
      return;
    }
    
    // æª¢æŸ¥ç•¶å‰å¯ç”¨çš„å–®å­—ï¼ˆè€ƒæ…®ç¯©é¸æ¢ä»¶å’Œæš«æ™‚åˆªé™¤ï¼‰
    var availableWords = this.getCurrentAvailableWords();
    if (availableWords.length === 0) {
      var message = this.getNoWordsMessage();
      alert(message);
      return;
    }
    
    // æª¢æŸ¥å¿«é€Ÿæ¸¬é©—çš„å–®å­—æ•¸é‡
    if (type === 'quick' && availableWords.length < APP_CONSTANTS.QUIZ_MIN_WORDS) {
      alert('å¯ç”¨å–®å­—å¤ªå°‘ï¼ˆå°‘æ–¼' + APP_CONSTANTS.QUIZ_MIN_WORDS + 'å€‹ï¼‰ï¼Œç„¡æ³•é€²è¡Œæ¸¬é©—ã€‚è«‹å¢åŠ æ›´å¤šå–®å­—æˆ–èª¿æ•´ç¯©é¸æ¢ä»¶ã€‚');
      return;
    }
    
    // æš«åœé–ƒå¡æ’­æ”¾
    this.pauseTimer();
    
    // è¨­ç½®æ¸¬é©—ç‹€æ…‹
    this.quizState = {
      isActive: true,
      type: type,
      questions: [],
      currentQuestionIndex: 0,
      selectedAnswer: null,
      answers: [],
      score: 0,
      startTime: new Date(),
      endTime: null,
      availableWords: availableWords
    };
    
    // ç”Ÿæˆæ¸¬é©—é¡Œç›®
    this.generateQuestions(type);
    
    // é¡¯ç¤ºæ¸¬é©—æ¨¡æ…‹æ¡†
    this.showQuizModal(type);
  };
  
  // ç²å–ç•¶å‰å¯ç”¨çš„å–®å­—ï¼ˆè€ƒæ…®ç¯©é¸å’Œåˆªé™¤ç‹€æ…‹ï¼‰
  FlashcardApp.prototype.getCurrentAvailableWords = function() {
    // ä½¿ç”¨ currentWordsï¼Œå®ƒå·²ç¶“è€ƒæ…®äº†ï¼š
    // 1. "åªé¡¯ç¤ºä¸ç†Ÿå–®å­—" çš„ç¯©é¸
    // 2. æš«æ™‚åˆªé™¤çš„å–®å­—
    return this.currentWords ? this.currentWords.slice() : [];
  };
  
  // ç²å–æ²’æœ‰å¯ç”¨å–®å­—æ™‚çš„æç¤ºä¿¡æ¯
  FlashcardApp.prototype.getNoWordsMessage = function() {
    if (this.difficultyFilter === -1) {
      return 'æ²’æœ‰æ¨™è¨˜ç‚ºã€Œéå¸¸ç†Ÿã€çš„å–®å­—å¯ä»¥æ¸¬é©—ï¼\n\nè«‹èª¿æ•´ç¯©é¸æ¢ä»¶ã€‚';
    } else if (this.difficultyFilter > 0) {
      return 'æ²’æœ‰ç¬¦åˆä¸ç†Ÿç¨‹åº¦ â˜…' + this.difficultyFilter + ' ä»¥ä¸Šçš„å–®å­—å¯ä»¥æ¸¬é©—ï¼\n\nè«‹èª¿æ•´ç¯©é¸æ¢ä»¶ã€‚';
    } else if (this.currentWords && this.currentWords.length === 0 && this.words && this.words.length > 0) {
      return 'æ‰€æœ‰å–®å­—éƒ½å·²è¢«æš«æ™‚ç§»é™¤ï¼\n\nè«‹é»æ“Šã€Œæ¢å¾©å–®å­—ã€æŒ‰éˆ•æˆ–é‡æ–°è¼‰å…¥å–®å­—ã€‚';
    } else {
      return 'æ²’æœ‰å–®å­—å¯ä»¥æ¸¬é©—ï¼è«‹å…ˆè¼‰å…¥å–®å­—ã€‚';
    }
  };
  
  // ç”Ÿæˆæ¸¬é©—é¡Œç›®
  FlashcardApp.prototype.generateQuestions = function(type) {
    console.log('ç”Ÿæˆæ¸¬é©—é¡Œç›®ï¼Œé¡å‹:', type);
    
    // ä½¿ç”¨ç•¶å‰å¯ç”¨çš„å–®å­—ï¼ˆå·²è€ƒæ…®ç¯©é¸æ¢ä»¶å’Œåˆªé™¤ç‹€æ…‹ï¼‰
    var availableWords = this.quizState.availableWords.slice();
    
    // æ‰€æœ‰æ¸¬é©—é¡å‹éƒ½éš¨æ©ŸåŒ–é †åº
    console.log('æ´—ç‰Œå‰å–®å­—é †åº:', availableWords.map(function(w, i) { return i + ':' + w.english; }).slice(0, 5));
    this.shuffleArray(availableWords);
    console.log('æ´—ç‰Œå¾Œå–®å­—é †åº:', availableWords.map(function(w, i) { return i + ':' + w.english; }).slice(0, 5));
    
    // æ ¹æ“šæ¸¬é©—é¡å‹æ±ºå®šé¡Œç›®æ•¸é‡
    var questionCount = type === 'quick' ? Math.min(APP_CONSTANTS.QUIZ_QUICK_COUNT, availableWords.length) : availableWords.length;
    
    // å¿«é€Ÿæ¸¬é©—åªå–å‰Nå€‹ï¼ˆå·²éš¨æ©Ÿæ´—ç‰Œï¼‰
    if (type === 'quick' && availableWords.length > APP_CONSTANTS.QUIZ_QUICK_COUNT) {
      availableWords = availableWords.slice(0, APP_CONSTANTS.QUIZ_QUICK_COUNT);
    }
    
    // ç”Ÿæˆé¡Œç›®
    this.quizState.questions = [];
    for (var i = 0; i < availableWords.length; i++) {
      var word = availableWords[i];
      // ä½¿ç”¨æ‰€æœ‰åŸå§‹å–®å­—ä½œç‚ºé¸é …æ± ï¼ˆç¢ºä¿æœ‰è¶³å¤ çš„éŒ¯èª¤é¸é …ï¼‰
      var question = this.createQuestion(word, this.words);
      if (question) {
        this.quizState.questions.push(question);
      }
    }
    
    console.log('ç”Ÿæˆäº†', this.quizState.questions.length, 'é“é¡Œç›®');
  };
  
  // å‰µå»ºå–®å€‹é¡Œç›®
  FlashcardApp.prototype.createQuestion = function(targetWord, allWords) {
    // éš¨æ©Ÿæ±ºå®šé¡Œå‹ï¼šè‹±è­¯ä¸­ æˆ– ä¸­è­¯è‹±
    var isEnglishToChinese = Math.random() < 0.5;
    
    var question = {
      word: targetWord,
      type: isEnglishToChinese ? 'en-zh' : 'zh-en',
      question: isEnglishToChinese ? targetWord.english : targetWord.chinese,
      correctAnswer: isEnglishToChinese ? targetWord.chinese : targetWord.english,
      options: []
    };
    
    // ç”ŸæˆéŒ¯èª¤é¸é …
    var wrongOptions = [];
    var attempts = 0;
    var maxAttempts = APP_CONSTANTS.QUIZ_MAX_WRONG_OPTION_ATTEMPTS;
    
    while (wrongOptions.length < APP_CONSTANTS.QUIZ_WRONG_OPTIONS_COUNT && attempts < maxAttempts) {
      attempts++;
      var randomWord = allWords[Math.floor(Math.random() * allWords.length)];
      var wrongAnswer = isEnglishToChinese ? randomWord.chinese : randomWord.english;
      
      // ç¢ºä¿éŒ¯èª¤é¸é …ä¸é‡è¤‡ä¸”ä¸ç­‰æ–¼æ­£ç¢ºç­”æ¡ˆ
      if (wrongAnswer !== question.correctAnswer && 
          wrongOptions.indexOf(wrongAnswer) === -1) {
        wrongOptions.push(wrongAnswer);
      }
    }
    
    // å¦‚æœæ²’æœ‰è¶³å¤ çš„éŒ¯èª¤é¸é …ï¼Œè£œå……ä¸€äº›é€šç”¨é¸é …
    while (wrongOptions.length < APP_CONSTANTS.QUIZ_WRONG_OPTIONS_COUNT) {
      var genericOptions = isEnglishToChinese ? 
        APP_CONSTANTS.QUIZ_GENERIC_OPTIONS_ZH :
        APP_CONSTANTS.QUIZ_GENERIC_OPTIONS_EN;
      
      for (var i = 0; i < genericOptions.length && wrongOptions.length < APP_CONSTANTS.QUIZ_WRONG_OPTIONS_COUNT; i++) {
        var option = genericOptions[i];
        if (option !== question.correctAnswer && wrongOptions.indexOf(option) === -1) {
          wrongOptions.push(option);
        }
      }
      break; // é¿å…ç„¡é™å¾ªç’°
    }
    
    // çµ„åˆæ‰€æœ‰é¸é …ä¸¦æ´—ç‰Œ
    question.options = [question.correctAnswer].concat(wrongOptions);
    this.shuffleArray(question.options);
    
    return question;
  };
  
  // é¡¯ç¤ºæ¸¬é©—æ¨¡æ…‹æ¡†
  FlashcardApp.prototype.showQuizModal = function(type) {
    var modal = document.getElementById('quiz-modal');
    var title = document.getElementById('quiz-title');
    var questionCount = document.getElementById('quiz-question-count');
    var introTitle = document.getElementById('quiz-intro-title');
    var introDescription = document.getElementById('quiz-intro-description');
    var scopeInfo = document.getElementById('quiz-scope-info');
    
    if (modal) {
      modal.style.display = 'flex';
    }
    
    // è¨­ç½®æ¨™é¡Œå’Œèªªæ˜
    if (title) {
      title.textContent = type === 'quick' ? 'ğŸ¯ å¿«é€Ÿæ¸¬é©—' : 'ğŸ“ å®Œæ•´æ¸¬é©—';
    }
    if (questionCount) {
      questionCount.textContent = this.quizState.questions.length;
    }
    if (introTitle) {
      var titleText = type === 'quick' ? 'æº–å‚™é–‹å§‹å¿«é€Ÿæ¸¬é©—ï¼' : 'æº–å‚™é–‹å§‹å®Œæ•´æ¸¬é©—ï¼';
      introTitle.textContent = titleText;
    }
    if (introDescription) {
      var description = type === 'quick' ? 
        'å¿«é€Ÿæª¢æ¸¬ä½ å°è‹±æ–‡å–®å­—çš„æŒæ¡ç¨‹åº¦ï¼' : 
        'å…¨é¢æ¸¬è©¦ä½ å­¸ç¿’çš„è‹±æ–‡å–®å­—ï¼';
      introDescription.textContent = description;
    }
    if (scopeInfo) {
      scopeInfo.textContent = this.getQuizScopeText();
    }
    
    // é¡¯ç¤ºé–‹å§‹ç•«é¢
    this.showQuizScreen('start');
  };
  
  // ç²å–æ¸¬é©—ç¯„åœæ–‡å­—
  FlashcardApp.prototype.getQuizScopeText = function() {
    var questionCount = this.quizState.questions.length;
    var filterLabels = {
      'never': 'å¾æœªè¤‡ç¿’',
      '2weeks': 'è¶…é2é€±æœªè¤‡ç¿’',
      '1month': 'è¶…é1å€‹æœˆæœªè¤‡ç¿’',
      '3months': 'è¶…é3å€‹æœˆæœªè¤‡ç¿’',
      '6months': 'è¶…é6å€‹æœˆæœªè¤‡ç¿’'
    };
    
    var parts = [];
    if (this.difficultyFilter === -1) {
      parts.push('éå¸¸ç†Ÿï¼ˆå·²æŒæ¡ï¼‰');
    } else if (this.difficultyFilter > 0) {
      parts.push('â˜…' + this.difficultyFilter + ' ä»¥ä¸Š');
    }
    if (this.reviewFilter !== 'all') {
      parts.push(filterLabels[this.reviewFilter] || '');
    }
    
    if (parts.length > 0) {
      return 'ğŸ“š æ¸¬é©—ç¯„åœï¼š' + parts.join(' + ') + ' (' + questionCount + ' é¡Œ)';
    } else if (this.currentWords.length < this.words.length) {
      var removedCount = this.words.length - this.currentWords.length;
      return 'ğŸ“– æ¸¬é©—ç¯„åœï¼šå‰©é¤˜å–®å­— (' + questionCount + ' é¡Œï¼Œå·²æ’é™¤ ' + removedCount + ' å€‹)';
    } else {
      return 'ğŸ“— æ¸¬é©—ç¯„åœï¼šæ‰€æœ‰å–®å­— (' + questionCount + ' é¡Œ)';
    }
  };
  
  // é—œé–‰æ¸¬é©—æ¨¡æ…‹æ¡†
  FlashcardApp.prototype.closeQuizModal = function() {
    closeModalById(this, 'quiz-modal');
    
    // é‡ç½®æ¸¬é©—ç‹€æ…‹
    this.quizState.isActive = false;
  };
  
  // é¡¯ç¤ºæ¸¬é©—ç•«é¢
  FlashcardApp.prototype.showQuizScreen = function(screenType) {
    // éš±è—æ‰€æœ‰ç•«é¢
    var screens = ['quiz-start-screen', 'quiz-progress-screen', 'quiz-result-screen'];
    for (var i = 0; i < screens.length; i++) {
      var screen = document.getElementById(screens[i]);
      if (screen) {
        screen.style.display = 'none';
      }
    }
    
    // éš±è—æ‰€æœ‰æŒ‰éˆ•
    var buttons = ['quiz-start', 'quiz-next', 'quiz-restart', 'quiz-finish'];
    for (var i = 0; i < buttons.length; i++) {
      var btn = document.getElementById(buttons[i]);
      if (btn) {
        btn.style.display = 'none';
      }
    }
    
    // é¡¯ç¤ºæŒ‡å®šç•«é¢å’Œç›¸æ‡‰æŒ‰éˆ•
    var targetScreen = document.getElementById('quiz-' + screenType + '-screen');
    if (targetScreen) {
      targetScreen.style.display = 'block';
    }
    
    // æ ¹æ“šç•«é¢é¡å‹é¡¯ç¤ºç›¸æ‡‰æŒ‰éˆ•
    if (screenType === 'start') {
      var startBtn = document.getElementById('quiz-start');
      if (startBtn) {
        startBtn.style.display = 'inline-block';
      }
    } else if (screenType === 'progress') {
      var nextBtn = document.getElementById('quiz-next');
      if (nextBtn) {
        nextBtn.style.display = 'inline-block';
        nextBtn.style.display = 'none'; // åˆå§‹éš±è—ï¼Œç­”é¡Œå¾Œé¡¯ç¤º
      }
    } else if (screenType === 'result') {
      var restartBtn = document.getElementById('quiz-restart');
      var finishBtn = document.getElementById('quiz-finish');
      if (restartBtn) {
        restartBtn.style.display = 'inline-block';
      }
      if (finishBtn) {
        finishBtn.style.display = 'inline-block';
      }
    }
  };
  
  // é–‹å§‹ç­”é¡Œ
  FlashcardApp.prototype.beginQuiz = function() {
    console.log('é–‹å§‹ç­”é¡Œ');
    
    if (this.quizState.questions.length === 0) {
      alert('æ²’æœ‰é¡Œç›®å¯ä»¥æ¸¬é©—ï¼');
      return;
    }
    
    this.quizState.currentQuestionIndex = 0;
    this.quizState.answers = [];
    this.quizState.score = 0;
    
    this.showQuizScreen('progress');
    this.showQuestion();
  };
  
  // é¡¯ç¤ºç•¶å‰é¡Œç›®
  FlashcardApp.prototype.showQuestion = function() {
    var currentQuestion = this.quizState.questions[this.quizState.currentQuestionIndex];
    if (!currentQuestion) return;
    
    console.log('é¡¯ç¤ºé¡Œç›®:', this.quizState.currentQuestionIndex + 1);
    
    // æ›´æ–°é€²åº¦ä¿¡æ¯
    var currentNum = document.getElementById('quiz-current-number');
    var totalNum = document.getElementById('quiz-total-number');
    var currentScore = document.getElementById('quiz-current-score');
    var progressFill = document.getElementById('quiz-progress-fill');
    
    if (currentNum) {
      currentNum.textContent = this.quizState.currentQuestionIndex + 1;
    }
    if (totalNum) {
      totalNum.textContent = this.quizState.questions.length;
    }
    if (currentScore) {
      currentScore.textContent = this.quizState.score;
    }
    if (progressFill) {
      var progress = (this.quizState.currentQuestionIndex / this.quizState.questions.length) * 100;
      progressFill.style.width = progress + '%';
    }
    
    // æ›´æ–°é¡Œç›®å…§å®¹
    var quizWord = document.getElementById('quiz-word');
    
    if (quizWord) {
      quizWord.textContent = currentQuestion.question;
    }
    
    // ç”Ÿæˆé¸é …æŒ‰éˆ•
    this.renderQuizOptions(currentQuestion);
    
    // éš±è—å›é¥‹å’Œä¸‹ä¸€é¡ŒæŒ‰éˆ•
    var feedback = document.getElementById('quiz-feedback');
    var nextBtn = document.getElementById('quiz-next');
    if (feedback) {
      feedback.style.display = 'none';
    }
    if (nextBtn) {
      nextBtn.style.display = 'none';
    }
    
    // é‡ç½®é¸æ“‡ç‹€æ…‹
    this.quizState.selectedAnswer = null;
  };
  
  // æ¸²æŸ“æ¸¬é©—é¸é …
  FlashcardApp.prototype.renderQuizOptions = function(question) {
    var optionsContainer = document.getElementById('quiz-options');
    if (!optionsContainer) return;
    
    optionsContainer.innerHTML = '';
    
    var self = this;
    var letters = ['A', 'B', 'C', 'D'];
    
    for (var i = 0; i < question.options.length; i++) {
      var option = question.options[i];
      var optionBtn = document.createElement('button');
      optionBtn.className = 'quiz-option';
      optionBtn.innerHTML = '<span class="quiz-option-letter">' + letters[i] + '</span>' + option;
      optionBtn.setAttribute('data-answer', option);
      
      (function(answer) {
        optionBtn.addEventListener('click', function() {
          self.selectAnswer(answer);
        });
      })(option);
      
      optionsContainer.appendChild(optionBtn);
    }
  };
  
  // é¸æ“‡ç­”æ¡ˆ
  FlashcardApp.prototype.selectAnswer = function(selectedAnswer) {
    console.log('é¸æ“‡ç­”æ¡ˆ:', selectedAnswer);
    
    if (this.quizState.selectedAnswer !== null) {
      return; // å·²ç¶“é¸æ“‡éç­”æ¡ˆ
    }
    
    this.quizState.selectedAnswer = selectedAnswer;
    
    var currentQuestion = this.quizState.questions[this.quizState.currentQuestionIndex];
    var isCorrect = selectedAnswer === currentQuestion.correctAnswer;
    
    // è¨˜éŒ„ç­”æ¡ˆ
    this.quizState.answers.push({
      question: currentQuestion,
      selectedAnswer: selectedAnswer,
      isCorrect: isCorrect
    });
    
    if (isCorrect) {
      this.quizState.score += APP_CONSTANTS.QUIZ_POINTS_PER_QUESTION;
    }
    
    // æ›´æ–°é¸é …æ¨£å¼
    this.updateOptionStyles(currentQuestion.correctAnswer, selectedAnswer);
    
    // é¡¯ç¤ºå›é¥‹
    this.showAnswerFeedback(isCorrect, currentQuestion);
    
    // å¦‚æœæ˜¯éŒ¯èª¤ç­”æ¡ˆï¼Œæ¨™è¨˜ç‚ºå›°é›£å–®å­—
    if (!isCorrect) {
      this.markWordAsDifficult(currentQuestion.word);
    }
    
    // é¡¯ç¤ºä¸‹ä¸€é¡ŒæŒ‰éˆ•æˆ–çµæŸæ¸¬é©—
    this.showNextButton();
  };
  
  // æ›´æ–°é¸é …æ¨£å¼
  FlashcardApp.prototype.updateOptionStyles = function(correctAnswer, selectedAnswer) {
    var options = document.querySelectorAll('.quiz-option');
    
    for (var i = 0; i < options.length; i++) {
      var option = options[i];
      var optionAnswer = option.getAttribute('data-answer');
      
      option.classList.add('disabled');
      
      if (optionAnswer === correctAnswer) {
        option.classList.add('correct');
      } else if (optionAnswer === selectedAnswer) {
        option.classList.add('wrong');
      }
    }
  };
  
  // é¡¯ç¤ºç­”æ¡ˆå›é¥‹
  FlashcardApp.prototype.showAnswerFeedback = function(isCorrect, question) {
    var feedback = document.getElementById('quiz-feedback');
    var feedbackResult = document.getElementById('quiz-feedback-result');
    var feedbackExplanation = document.getElementById('quiz-feedback-explanation');
    
    if (!feedback) return;
    
    feedback.className = 'quiz-feedback ' + (isCorrect ? 'correct' : 'wrong');
    feedback.style.display = 'block';
    
    if (feedbackResult) {
      feedbackResult.textContent = isCorrect ? 'âœ… ç­”å°äº†ï¼' : 'âŒ ç­”éŒ¯äº†ï¼';
    }
    
    if (feedbackExplanation) {
      var explanation = question.word.english + ' çš„æ„æ€æ˜¯ã€Œ' + question.word.chinese + 'ã€';
      feedbackExplanation.textContent = explanation;
    }
    
    // æ’­æ”¾èªéŸ³ï¼ˆå¦‚æœæ˜¯è‹±æ–‡å–®å­—ï¼‰
    if (this.voiceSettings.enabled) {
      var self = this;
      setTimeout(function() {
        self.speakWord(question.word.english);
      }, APP_CONSTANTS.SPEECH_DELAY_MS);
    }
  };
  
  // é¡¯ç¤ºä¸‹ä¸€é¡ŒæŒ‰éˆ•
  FlashcardApp.prototype.showNextButton = function() {
    var nextBtn = document.getElementById('quiz-next');
    if (nextBtn) {
      var isLastQuestion = this.quizState.currentQuestionIndex >= this.quizState.questions.length - 1;
      nextBtn.textContent = isLastQuestion ? 'æŸ¥çœ‹çµæœ' : 'ä¸‹ä¸€é¡Œ';
      nextBtn.style.display = 'inline-block';
    }
  };
  
  // ä¸‹ä¸€é¡Œæˆ–é¡¯ç¤ºçµæœ
  FlashcardApp.prototype.nextQuestion = function() {
    this.quizState.currentQuestionIndex++;
    
    if (this.quizState.currentQuestionIndex >= this.quizState.questions.length) {
      // æ¸¬é©—çµæŸï¼Œé¡¯ç¤ºçµæœ
      this.showQuizResult();
    } else {
      // é¡¯ç¤ºä¸‹ä¸€é¡Œ
      this.showQuestion();
    }
  };
  
  // é¡¯ç¤ºæ¸¬é©—çµæœ
  FlashcardApp.prototype.showQuizResult = function() {
    console.log('é¡¯ç¤ºæ¸¬é©—çµæœ');
    
    this.quizState.endTime = new Date();
    
    var totalQuestions = this.quizState.questions.length;
    var correctCount = this.quizState.answers.filter(function(a) { return a.isCorrect; }).length;
    var wrongCount = totalQuestions - correctCount;
    var finalScore = Math.round((correctCount / totalQuestions) * 100);
    
    // æ›´æ–°çµæœé¡¯ç¤º
    var resultIcon = document.getElementById('quiz-result-icon');
    var resultTitle = document.getElementById('quiz-result-title');
    var finalScoreElement = document.getElementById('quiz-final-score');
    var correctCountElement = document.getElementById('quiz-correct-count');
    var wrongCountElement = document.getElementById('quiz-wrong-count');
    var resultMessage = document.getElementById('quiz-result-message');
    
    if (resultIcon) {
      if (finalScore >= 90) {
        resultIcon.textContent = 'ğŸ†';
      } else if (finalScore >= 80) {
        resultIcon.textContent = 'ğŸ‰';
      } else if (finalScore >= 70) {
        resultIcon.textContent = 'ğŸ‘';
      } else {
        resultIcon.textContent = 'ğŸ’ª';
      }
    }
    
    if (resultTitle) {
      resultTitle.textContent = 'æ¸¬é©—å®Œæˆï¼';
    }
    
    if (finalScoreElement) {
      finalScoreElement.textContent = finalScore;
    }
    
    if (correctCountElement) {
      correctCountElement.textContent = correctCount;
    }
    
    if (wrongCountElement) {
      wrongCountElement.textContent = wrongCount;
    }
    
    if (resultMessage) {
      var message = this.getResultMessage(finalScore);
      resultMessage.textContent = message;
    }
    
    // é¡¯ç¤ºéŒ¯é¡Œå›é¡§
    this.showWrongReview();
    
    this.showQuizScreen('result');
  };
  
  // ç²å–çµæœè©•èª
  FlashcardApp.prototype.getResultMessage = function(score) {
    if (score >= 90) {
      return 'å¤ªæ£’äº†ï¼ä½ æ˜¯è‹±æ–‡å–®å­—å°é«˜æ‰‹ï¼ğŸ†';
    } else if (score >= 80) {
      return 'å¾ˆå¥½ï¼ä½ çš„è‹±æ–‡å–®å­—æŒæ¡å¾—ä¸éŒ¯ï¼ğŸ‘';
    } else if (score >= 70) {
      return 'ä¸éŒ¯å“¦ï¼ç¹¼çºŒåŠªåŠ›å°±æœƒæ›´æ£’ï¼ğŸ’ª';
    } else if (score >= 60) {
      return 'é‚„å¯ä»¥ï¼å¤šå¤šç·´ç¿’æœƒé€²æ­¥çš„ï¼ğŸ“š';
    } else {
      return 'åŠ æ²¹ï¼å¤šè®€å¤šç·´ç¿’ä¸€å®šæœƒé€²æ­¥çš„ï¼ğŸŒŸ';
    }
  };
  
  // é¡¯ç¤ºéŒ¯é¡Œå›é¡§
  FlashcardApp.prototype.showWrongReview = function() {
    var wrongAnswers = this.quizState.answers.filter(function(a) { return !a.isCorrect; });
    var wrongReview = document.getElementById('quiz-wrong-review');
    var wrongList = document.getElementById('quiz-wrong-list');
    
    if (wrongAnswers.length === 0) {
      if (wrongReview) {
        wrongReview.style.display = 'none';
      }
      return;
    }
    
    if (wrongReview) {
      wrongReview.style.display = 'block';
    }
    
    if (wrongList) {
      wrongList.innerHTML = '';
      
      for (var i = 0; i < wrongAnswers.length; i++) {
        var answer = wrongAnswers[i];
        var item = document.createElement('div');
        item.className = 'quiz-wrong-item';
        
        item.innerHTML = 
          '<div class="quiz-wrong-word">' + answer.question.word.english + '</div>' +
          '<div>' +
            '<div class="quiz-wrong-answer">ä½ çš„ç­”æ¡ˆï¼š' + answer.selectedAnswer + '</div>' +
            '<div class="quiz-wrong-correct">æ­£ç¢ºç­”æ¡ˆï¼š' + answer.question.correctAnswer + '</div>' +
          '</div>';
        
        wrongList.appendChild(item);
      }
    }
  };
  
  // æ¨™è¨˜å–®å­—ç‚ºå›°é›£ï¼ˆæ¸¬é©—ç­”éŒ¯æ™‚å‘¼å«ï¼‰- å¢åŠ ä¸ç†Ÿç¨‹åº¦ +1
  FlashcardApp.prototype.markWordAsDifficult = function(word) {
    var newLevel = Math.min(10, (word.difficultyLevel || 0) + 1);
    word.difficultyLevel = newLevel;
    
    // åŒæ­¥åˆ° words ä¸»é™£åˆ—
    var mainWord = this.words.find(function(w) { return w.id === word.id; });
    if (mainWord) mainWord.difficultyLevel = newLevel;
    
    console.log('æ¸¬é©—ç­”éŒ¯ï¼Œå¢åŠ ä¸ç†Ÿç¨‹åº¦:', word.english, 'â†’ â˜…' + newLevel);
    
    // åŒæ­¥åˆ°å¾Œç«¯
    this.syncDifficultyToBackend(word);
  };
  
  // é‡æ–°é–‹å§‹æ¸¬é©—
  FlashcardApp.prototype.restartQuiz = function() {
    console.log('é‡æ–°é–‹å§‹æ¸¬é©—');
    
    // é‡æ–°ç²å–ç•¶å‰å¯ç”¨çš„å–®å­—ï¼ˆå¯èƒ½å·²ç¶“è®ŠåŒ–ï¼‰
    var availableWords = this.getCurrentAvailableWords();
    if (availableWords.length === 0) {
      var message = this.getNoWordsMessage();
      alert(message);
      this.closeQuizModal();
      return;
    }
    
    // æª¢æŸ¥å¿«é€Ÿæ¸¬é©—çš„å–®å­—æ•¸é‡
    if (this.quizState.type === 'quick' && availableWords.length < APP_CONSTANTS.QUIZ_MIN_WORDS) {
      alert('å¯ç”¨å–®å­—å¤ªå°‘ï¼ˆå°‘æ–¼' + APP_CONSTANTS.QUIZ_MIN_WORDS + 'å€‹ï¼‰ï¼Œç„¡æ³•é€²è¡Œæ¸¬é©—ã€‚è«‹å¢åŠ æ›´å¤šå–®å­—æˆ–èª¿æ•´ç¯©é¸æ¢ä»¶ã€‚');
      this.closeQuizModal();
      return;
    }
    
    // æ›´æ–°å¯ç”¨å–®å­—
    this.quizState.availableWords = availableWords;
    
    // é‡æ–°ç”Ÿæˆé¡Œç›®
    this.generateQuestions(this.quizState.type);
    
    // é‡æ–°è¨­ç½®ç‹€æ…‹
    this.quizState.currentQuestionIndex = 0;
    this.quizState.selectedAnswer = null;
    this.quizState.answers = [];
    this.quizState.score = 0;
    this.quizState.startTime = new Date();
    this.quizState.endTime = null;
    
    this.showQuizScreen('start');
  };
  
  // ç¦ç”¨é˜²æ­¢è¢å¹•é—œé–‰åŠŸèƒ½
  FlashcardApp.prototype.disableKeepScreenAwake = function() {
    console.log('ç¦ç”¨é˜²æ­¢è¢å¹•é—œé–‰åŠŸèƒ½');
    this.keepScreenAwake = false;
    this._wakeLockAcquired = false;
    this._noSleepVideoPlaying = false;
    this._persistentAudioRunning = false;
    
    // é‡‹æ”¾ Wake Lock
    if (this.wakeLock) {
      try { this.wakeLock.release(); } catch (e) {}
      this.wakeLock = null;
    }
    
    // åœæ­¢ NoSleep è¦–é »
    if (this.noSleepVideo) {
      this.noSleepVideo.pause();
      if (this.noSleepVideo.parentNode) {
        this.noSleepVideo.parentNode.removeChild(this.noSleepVideo);
      }
      this.noSleepVideo = null;
    }
    
    // åœæ­¢æŒçºŒéœéŸ³éŸ³é »
    if (this._persistentOscillator) {
      try { this._persistentOscillator.stop(); } catch (e) {}
      this._persistentOscillator = null;
    }
    if (this._persistentAudioElement) {
      this._persistentAudioElement.pause();
      if (this._persistentAudioElement.parentNode) {
        this._persistentAudioElement.parentNode.removeChild(this._persistentAudioElement);
      }
      this._persistentAudioElement = null;
    }
    if (this._persistentAudioContext) {
      try { this._persistentAudioContext.close(); } catch (e) {}
      this._persistentAudioContext = null;
    }
    this._persistentAudioSource = null;
    
    // åœæ­¢èƒŒæ™¯è¨ˆæ™‚ Web Worker
    if (this._bgWorker) {
      try { this._bgWorker.terminate(); } catch (e) {}
      this._bgWorker = null;
    }
    this._bgWorkerCallbacks = {};
    this._activeTimerInfo = null;
  };
  
  // å…¨åŸŸè®Šæ•¸
  var app;
  
  // é é¢è¼‰å…¥å®Œæˆå¾Œå•Ÿå‹•
  window.addEventListener('load', function() {
    try {
      console.log('é é¢è¼‰å…¥å®Œæˆï¼Œå•Ÿå‹•FlashcardApp');
      app = new FlashcardApp();
      
      // èªéŸ³åˆ—è¡¨è¼‰å…¥å¾Œå¡«å……èªéŸ³è…”èª¿é¸å–®
    if (window.speechSynthesis) {
        window.speechSynthesis.onvoiceschanged = function() {
          if (app && typeof app.populateVoiceSelect === 'function') {
          app.populateVoiceSelect();
        }
      };
    }
    
    // é é¢å¸è¼‰æ™‚æ¸…ç†è³‡æºä¸¦åŒæ­¥è¤‡ç¿’æ—¥æœŸ
    window.addEventListener('beforeunload', function() {
      if (app) {
        if (typeof app.syncReviewDates === 'function') {
          app.syncReviewDates();
        }
        if (typeof app.disableKeepScreenAwake === 'function') {
          app.disableKeepScreenAwake();
        }
      }
    });
    } catch (error) {
      console.error('æ‡‰ç”¨å•Ÿå‹•å¤±æ•—:', error);
      var loadingDiv = document.getElementById('loading');
      var errorDiv = document.getElementById('error');
      if (loadingDiv) loadingDiv.style.display = 'none';
      if (errorDiv) {
        errorDiv.style.display = 'block';
        errorDiv.innerHTML = '<h2>å•Ÿå‹•å¤±æ•—</h2><p>è«‹é‡æ–°æ•´ç†é é¢ï¼ŒéŒ¯èª¤ï¼š' + error.message + '</p>';
      }
    }
  });
  
  console.log('FlashcardApp ES5å…¼å®¹ç‰ˆæœ¬å·²è¼‰å…¥');
</script>

<!-- script-events.html -->
<script>
  /**
   * @module script-events
   * @description 事件綁定與 UI 互動模組：所有事件監聽器的設置（核心點擊、選單委派、
   *   模態框、鍵盤快捷鍵、進度區、匯出）、舊版瀏覽器語音啟用、
   *   顯示單字、更新進度、開始新回合、自訂確認對話框。
   *
   * @dependencies script-core.html (FlashcardApp, APP_CONSTANTS)
   * @provides FlashcardApp.prototype: setupEventListeners, handleKeyDown,
   *   setupModalListeners, displayCurrentWord, startNewRound, shuffleArray,
   *   toggleMenu, closeMenu, hideLoading, showError, customConfirm ...
   */

  // 設置事件監聽器
  FlashcardApp.prototype.setupEventListeners = function() {
    console.log('設置事件監聽器...');
  
    if (this.listenersSetup) {
      console.log('事件監聽器已設置，跳過重複設置');
        return;
      }
      
    this.setupCoreListeners();
    this.setupMenuListeners();
    this.setupModalListeners();
    this.setupKeyboardListeners();
    this.setupSwipeListeners();
    this.setupProgressAndExportListeners();
  
    this.listenersSetup = true;
    console.log('所有事件監聽器設置完成');
  };
  
  // 核心監聽器
  FlashcardApp.prototype.setupCoreListeners = function() {
    var self = this;
    
    var flashcardDiv = document.getElementById('flashcard');
    var nextBtn = document.getElementById('next-btn');
    var prevBtn = document.getElementById('prev-btn');
    
    // 在整個flashcard區域添加點擊事件，但排除下方區域
    if (flashcardDiv) {
      flashcardDiv.addEventListener('click', function(e) { 
        self.handleFlashcardClick(e); 
      });
    }
    if (nextBtn) {
      nextBtn.addEventListener('click', function() { self.nextWord(); });
    }
    if (prevBtn) {
      prevBtn.addEventListener('click', function() { self.previousWord(); });
    }
    // 移除 restartBtn 的直接事件綁定，因為它已經在選單委派事件中處理了
    
    // 新增按鈕事件監聽器
    var voiceToggleBtn = document.getElementById('voice-toggle-btn');
    var pauseBtn = document.getElementById('pause-btn');
    var restoreBtn = document.getElementById('restore-btn');
    
    if (voiceToggleBtn) {
      voiceToggleBtn.addEventListener('click', function() { self.toggleVoice(); });
    }
    if (pauseBtn) {
      pauseBtn.addEventListener('click', function() { self.togglePause(); });
    }
    if (restoreBtn) {
      restoreBtn.addEventListener('click', function() { self.cancelRemoval(); });
    }
    
    // 為暫停指示器添加點擊事件，讓用戶可以點擊"已暫停"來結束暫停
    var pausedIndicator = document.getElementById('paused-indicator');
    if (pausedIndicator) {
      pausedIndicator.addEventListener('click', function(e) { 
        // 阻止事件冒泡，避免觸發 flashcard 的點擊事件
        if (e.stopPropagation) {
          e.stopPropagation();
        } else {
          e.cancelBubble = true; // IE8 及更早版本
        }
        
        if (self.userPaused) {
          self.togglePause(); 
        }
      });
    }
    
    // 為靜音指示器添加點擊事件，讓用戶可以點擊"已靜音"來切換靜音狀態
    var mutedIndicator = document.getElementById('muted-indicator');
    if (mutedIndicator) {
      mutedIndicator.addEventListener('click', function(e) { 
        // 阻止事件冒泡，避免觸發 flashcard 的點擊事件
        if (e.stopPropagation) {
          e.stopPropagation();
        } else {
          e.cancelBubble = true; // IE8 及更早版本
        }
        
        self.toggleVoice(); 
      });
    }
    

  };
  
  // 選單監聽器
  FlashcardApp.prototype.setupMenuListeners = function() {
    console.log('設定選單事件監聽器...');
    
    var self = this;
    var menuBtn = document.getElementById('menu-btn');
    var menuDropdown = document.getElementById('menu-dropdown');
    
    if (!menuBtn || !menuDropdown) {
      console.error('找不到選單元素');
      return;
    }
    
    // 工具列隱藏後，透過滑鼠離開或觸控重新顯示
    var controlsWrapper = document.querySelector('.controls-wrapper');
    if (controlsWrapper) {
      controlsWrapper.addEventListener('mouseleave', function() {
        controlsWrapper.classList.remove('force-hide');
      });
      controlsWrapper.addEventListener('touchstart', function() {
        controlsWrapper.classList.remove('force-hide');
      });
    }
    
        // 使用委派事件監聽
    document.addEventListener('click', function(e) {
      // 檢查是否點擊了select相關元素，如果是則不處理任何選單邏輯
      var target = e.target;
      var isSelectRelated = false;
      
      // 向上遍歷DOM樹檢查是否點擊了select或其相關元素
      var element = target;
      while (element && element !== document.body) {
        if (element.tagName === 'SELECT' || 
            element.tagName === 'OPTION' ||
            (element.classList && (
              element.classList.contains('modal') ||
              element.classList.contains('modal-content') ||
              element.classList.contains('setting-control') ||
              element.classList.contains('font-preview')))) {
          isSelectRelated = true;
          break;
        }
        element = element.parentElement;
      }
      
      // 如果點擊的是select相關元素，直接返回，不處理選單邏輯
      if (isSelectRelated) {
        console.log('點擊了select相關元素，跳過選單處理');
        return;
      }
      
      // 處理選單按鈕點擊
      if (e.target.id === 'menu-btn' || e.target.closest('#menu-btn')) {
        console.log('選單按鈕被點擊');
        e.stopPropagation();
        self.toggleMenu();
        return;
      }
      
      // 處理選單項目點擊
      if (e.target.closest('#menu-dropdown')) {
        console.log('點擊選單下拉選項');
        e.stopPropagation();

        if (e.target.id === 'restart-btn') {
          console.log('重新開始按鈕被點擊');
          self.closeMenu();
          self.confirmRestart();
        } else if (e.target.id === 'fullscreen-btn') {
          console.log('全螢幕按鈕被點擊');
          self.closeMenu();
          self.toggleFullscreen();
        } else if (e.target.id === 'sheet-settings-btn') {
          console.log('Google Sheet 設定按鈕被點擊');
          self.closeMenu();
          self.openSheetSettings();
        } else if (e.target.id === 'voice-settings-btn') {
          console.log('語音設定按鈕被點擊');
          self.closeMenu();
          self.openVoiceSettings();
        } else if (e.target.id === 'settings-btn') {
          console.log('設定按鈕被點擊');
          self.closeMenu();
          self.openSettings();
        } else if (e.target.id === 'export-btn') {
          console.log('匯出按鈕被點擊');
          self.closeMenu();
          self.openExportModal();
        } else if (e.target.id === 'difficulty-filter-btn') {
          console.log('不熟程度篩選按鈕被點擊');
          self.closeMenu();
          self.openDifficultyFilterModal();
        } else if (e.target.id === 'review-filter-btn') {
          console.log('複習時間篩選按鈕被點擊');
          self.closeMenu();
          self.openReviewFilterModal();
        } else if (e.target.id === 'must-spell-filter-btn') {
          console.log('要會拼篩選按鈕被點擊');
          self.closeMenu();
          self.toggleMustSpellFilter();
        } else if (e.target.id === 'edit-word-btn') {
          console.log('編輯單字按鈕被點擊');
          self.closeMenu();
          self.openEditWordModal();
        } else if (e.target.id === 'srs-review-btn' || (e.target.parentElement && e.target.parentElement.id === 'srs-review-btn')) {
          console.log('快速複習按鈕被點擊');
          self.closeMenu();
          self.openSrsReviewModal();
        } else if (e.target.id === 'quick-quiz-btn') {
          console.log('快速測驗按鈕被點擊');
          self.closeMenu();
          self.startQuiz('quick');
        } else if (e.target.id === 'full-quiz-btn') {
          console.log('完整測驗按鈕被點擊');
          self.closeMenu();
          self.startQuiz('full');
        }
        return;
      }

      // 點擊其他地方關閉選單（但排除select相關元素）
      self.closeMenu();
    });
  
    console.log('選單事件監聽器設定完成');
  };
  

  
  // 顯示語音啟用界面
  FlashcardApp.prototype.showSpeechActivation = function() {
    console.log('顯示語音啟用界面 (舊版瀏覽器)');
    var activationContainer = document.getElementById('speech-activation-container');
    if (activationContainer) {
      activationContainer.style.display = 'block';
    }
    
    // 設置語音啟用按鈕事件
    var activateBtn = document.getElementById('activate-speech-btn');
    var self = this;
    if (activateBtn) {
      activateBtn.addEventListener('click', function() {
        self.activateSpeech();
      });
    }
  };
  
  // 啟用語音功能
  FlashcardApp.prototype.activateSpeech = function() {
    console.log('用戶點擊啟用語音按鈕');
    
    // 測試語音功能是否可用
    try {
      var testUtterance = new SpeechSynthesisUtterance('');
      testUtterance.volume = 0; // 靜音測試
      this.speechSynthesis.speak(testUtterance);
      
      this.speechActivated = true;
      console.log('語音功能已啟用');
      
      // 隱藏語音啟用界面
      var activationContainer = document.getElementById('speech-activation-container');
      if (activationContainer) {
        activationContainer.style.display = 'none';
      }
      
      // 進入主畫面
      this.hideLoading();
      this.applySettings();
      
      if (this.sheetSettings.sheetId && this.sheetSettings.selectedSheets.length > 0) {
        this.startNewRound();
      } else {
        this.openSheetSettings();
      }
      
    } catch (error) {
      console.error('語音啟用失敗:', error);
      alert('語音功能啟用失敗，但程式仍可正常使用');
      this.speechActivated = false;
      
      // 仍然進入主畫面
      var activationContainer = document.getElementById('speech-activation-container');
      if (activationContainer) {
        activationContainer.style.display = 'none';
      }
      this.hideLoading();
      this.applySettings();
      
      if (this.sheetSettings.sheetId && this.sheetSettings.selectedSheets.length > 0) {
        this.startNewRound();
      } else {
        this.openSheetSettings();
      }
    }
  };
  
  // 隱藏載入畫面
  FlashcardApp.prototype.hideLoading = function() {
    var loadingDiv = document.getElementById('loading');
    var flashcardDiv = document.getElementById('flashcard');
    if (loadingDiv) loadingDiv.style.display = 'none';
    if (flashcardDiv) flashcardDiv.style.display = 'flex';
    
    // 更新按鈕狀態
    this.updateVoiceButtonState();
    this.updatePauseButtonState();
    this.updateFullscreenButtonText();
  };
  
  // 顯示錯誤
  FlashcardApp.prototype.showError = function() {
    var loadingDiv = document.getElementById('loading');
    var errorDiv = document.getElementById('error');
    if (loadingDiv) loadingDiv.style.display = 'none';
    if (errorDiv) errorDiv.style.display = 'block';
  };
  
  // 開始新回合
  FlashcardApp.prototype.startNewRound = function() {
    // 結束 SRS 複習模式（如果有的話）
    this.srsReviewActive = false;
    
    this.shuffleArray(this.words);
    this.currentWords = this.applyAllFilters(this.words);
    this.currentIndex = 0;
    this.removedWords = [];
    this.navigationHistory = [];
    this.pendingRemoval = null;
    this.userPaused = false;
    this.isPaused = false;
    this.hideRestoreButton();
          
    if (this.currentWords.length === 0) {
      if (this.difficultyFilter > 0 || this.reviewFilter !== 'all') {
        var filterMsg = '';
        if (this.difficultyFilter > 0 && this.reviewFilter !== 'all') {
          filterMsg = '沒有同時符合「不熟程度」和「複習時間」兩個篩選條件的單字！';
        } else if (this.difficultyFilter > 0) {
          filterMsg = '沒有符合不熟程度 ★' + this.difficultyFilter + ' 以上的單字！';
        } else {
          filterMsg = '沒有符合複習時間篩選條件的單字！';
        }
        alert(filterMsg);
        this.difficultyFilter = 0;
        this.reviewFilter = 'all';
        this.updateDifficultyFilterButtonText();
        this.updateReviewFilterButtonText();
        this.currentWords = this.words.slice();
      }
    }
        
    this.displayCurrentWord();
    this.updateButtonStates();
    this.updateVoiceButtonState();
    this.updatePauseButtonState();
    this.updateFullscreenButtonText();
    this.renderDifficultyLevel();
    this.updateActiveFilterDisplay();
    this.updateSrsBadge();
  };
  
  // 洗牌
  FlashcardApp.prototype.shuffleArray = function(array) {
    for (var i = array.length - 1; i > 0; i--) {
      var j = Math.floor(Math.random() * (i + 1));
      var temp = array[i];
      array[i] = array[j];
      array[j] = temp;
    }
  };
  
  // 顯示當前單字
  FlashcardApp.prototype.displayCurrentWord = function() {
    if (this.currentWords.length === 0) {
      this.startNewRound();
      return;
    }
    
    var currentWord = this.currentWords[this.currentIndex];
    var englishElement = document.getElementById('english-word');
    var chineseElement = document.getElementById('chinese-word');
    this.showingChinese = false;
    this.isTransitioning = false;
    this.isProcessingClick = false;
      this.pendingRemoval = null;
      this.hideRestoreButton();
      
      this._clearDisplayTimer();
      
    // 重置進度條（準備開始新的週期）
    this.resetProgressBar();
      
    englishElement.classList.remove('show');
    chineseElement.classList.remove('show');
    
    englishElement.style.color = '';
    chineseElement.style.color = '';
    
    // 混合模式：每張卡片隨機決定顯示順序
    // 若開關啟用，要會拼的單字強制先顯示中文；其他單字隨機
    if (this.settings.displayMode === 'mixed') {
      var currentWord = this.currentWords[this.currentIndex];
      if (currentWord && currentWord.mustSpell && this.settings.mustSpellChineseFirst) {
        this.currentWordReversed = true;
      } else {
        this.currentWordReversed = Math.random() < 0.5;
      }
    }
    
    // 先清除背景圖片（圖片將在中文翻譯出現時才顯示）
    var flashcardDiv = document.getElementById('flashcard');
    if (flashcardDiv) {
      flashcardDiv.style.backgroundImage = '';
      flashcardDiv.classList.remove('has-image');
    }
    
    // 儲存當前單字到 localStorage（載入畫面用）
    try {
      localStorage.setItem(APP_CONSTANTS.STORAGE_KEYS.LAST_WORD, JSON.stringify({
        english: currentWord.english,
        chinese: currentWord.chinese
      }));
    } catch (e) {}
    
    var self = this;
    setTimeout(function() {
      var firstElement = document.getElementById('english-word');
      
      if (self.isReversedForCurrentWord()) {
        firstElement.textContent = currentWord.chinese;
        // 反向模式：先顯示中文，播放中文語音
        setTimeout(function() {
          self.speakChineseWord(currentWord.chinese);
        }, APP_CONSTANTS.SPEECH_DELAY_MS);
      } else {
        firstElement.textContent = currentWord.english;
        // 只有在未啟用延遲發音時才立即播放語音
        if (!self.settings.delaySpeechInNormalMode) {
          setTimeout(function() {
            self.speakWord(currentWord.english);
          }, APP_CONSTANTS.SPEECH_DELAY_MS);
        }
      }
      firstElement.classList.add('show');
      
      // 預加載當前單字的圖片（如果有的話）
      if (currentWord.image && currentWord.image !== '') {
        self.preloadImage(currentWord.image);
      }
      
      // 預加載下一個單字的圖片（提前準備）
      var nextIndex = (self.currentIndex + 1) % self.currentWords.length;
      var nextWord = self.currentWords[nextIndex];
      if (nextWord && nextWord.image && nextWord.image !== '') {
        self.preloadImage(nextWord.image);
      }
  
      self._setDisplayTimer(function() {
        self.waitForSpeechThenExecute(function() {
          self.showSecondPartAndScheduleNext();
        });
      }, self.settings.delayTime * 1000);
      
      // 進度條第一階段：0% → 50%（到 50% 時顯示翻譯）
      self.startProgressBar(1);
      
    }, 100);
    
    this.renderDifficultyLevel();
    this.renderMustSpellIndicator();
    this.updateProgress();
    this.updateButtonStates();
  };
  
  // 更新進度
  FlashcardApp.prototype.updateProgress = function() {
    var progressText = document.getElementById('progress-text');
    if (progressText) {
      var current = this.currentIndex + 1;
      var total = this.currentWords.length;
      progressText.textContent = current + '/' + total;
    }
  };
  
  // 更新按鈕狀態
  FlashcardApp.prototype.updateButtonStates = function() {
    var prevBtn = document.getElementById('prev-btn');
    if (prevBtn) {
      var isFirstWord = this.currentIndex === 0;
      var hasPendingRemoval = this.pendingRemoval !== null;
      prevBtn.disabled = (isFirstWord && !hasPendingRemoval) || this.navigationHistory.length === 0;
    }
  };
  
  // 切換選單
  FlashcardApp.prototype.toggleMenu = function() {
    console.log('toggleMenu 被調用');
    var menuBtn = document.getElementById('menu-btn');
    var menuDropdown = document.getElementById('menu-dropdown');
    
    if (!menuBtn || !menuDropdown) {
      console.error('選單元素不存在，無法切換');
        return;
      }
      
    var isOpen = menuDropdown.classList.contains('show');
    console.log('選單目前狀態:', isOpen ? '開啟' : '關閉');
    
    if (isOpen) {
      this.closeMenu();
    } else {
      console.log('開啟選單');
      // 開啟選單時移除 force-hide，確保工具列可見
      var controlsWrapper = document.querySelector('.controls-wrapper');
      if (controlsWrapper) {
        controlsWrapper.classList.remove('force-hide');
      }
      // 記住開啟選單前的暫停狀態
      this._wasPausedBeforeMenu = this.userPaused;
      if (!this.userPaused) {
        this.userPaused = true;
        this.pauseTimer();
        this.updatePauseButtonState();
      }
      // 開啟選單時同步複習日期
      this.syncReviewDates();
      menuBtn.classList.add('active');
      menuDropdown.classList.add('show');
      // 捲到選單底部，讓靠近按鈕的項目先顯示
      menuDropdown.scrollTop = menuDropdown.scrollHeight;
    }
  };
  
  // 關閉選單
  FlashcardApp.prototype.closeMenu = function() {
    console.log('closeMenu 被調用');
    var menuBtn = document.getElementById('menu-btn');
    var menuDropdown = document.getElementById('menu-dropdown');
    
    if (menuBtn && menuDropdown) {
      var wasOpen = menuDropdown.classList.contains('show');
      console.log('關閉選單');
      menuBtn.classList.remove('active');
      menuDropdown.classList.remove('show');

      // 只有選單確實是開啟狀態才恢復暫停
      if (wasOpen && !this._wasPausedBeforeMenu) {
        this.userPaused = false;
        this.updatePauseButtonState();
        this.resumeTimer();
      }
      this._wasPausedBeforeMenu = undefined;

      // 選單關閉時隱藏工具列
      if (wasOpen) {
        var controlsWrapper = document.querySelector('.controls-wrapper');
        if (controlsWrapper) {
          controlsWrapper.classList.add('force-hide');
        }
      }
    }
  };
  

  
  // 模態框監聽器
  FlashcardApp.prototype.setupModalListeners = function() {
    this._setupSettingsModalListeners();
    this._setupSheetSettingsModalListeners();
    this._setupVoiceSettingsModalListeners();
    this._setupExportModalListeners();
    this._setupOverwriteModalListeners();
    this._setupSrsModalListeners();
    this.setupQuizListeners();
  };

  // --- 主設定模態框 ---
  FlashcardApp.prototype._setupSettingsModalListeners = function() {
    var self = this;
    var settingsModal = document.getElementById('settings-modal');
    var closeSettings = document.getElementById('close-settings');
    var saveSettings = document.getElementById('save-settings');
    var cancelSettings = document.getElementById('cancel-settings');
    var delaySlider = document.getElementById('delay-setting');
    var fontSizeSlider = document.getElementById('font-size-setting');
    
    if (closeSettings) {
      closeSettings.addEventListener('click', function() { self.closeSettings(); });
    }
    if (saveSettings) {
      saveSettings.addEventListener('click', function() { self.saveSettingsAndClose(); });
    }
    if (cancelSettings) {
      cancelSettings.addEventListener('click', function() { self.closeSettings(); });
    }
    if (settingsModal) {
      settingsModal.addEventListener('click', function(e) {
        var target = e.target;
        var isSelectRelated = false;
        var element = target;
        while (element && element !== settingsModal) {
          if (element.tagName === 'SELECT' || 
              element.tagName === 'OPTION' ||
              element.classList.contains('setting-control') ||
              element.classList.contains('font-preview')) {
            isSelectRelated = true;
            break;
          }
          element = element.parentElement;
        }
        if (e.target === settingsModal && !isSelectRelated) {
          self.closeSettings();
        }
      });
    }
    
    if (delaySlider) {
      delaySlider.addEventListener('input', function(e) {
        var delayValue = document.getElementById('delay-value');
        if (delayValue) {
          var value = parseFloat(e.target.value);
          var step = parseFloat(e.target.step) || 0.5;
          var decimalPlaces = step.toString().indexOf('.') !== -1 ? step.toString().split('.')[1].length : 0;
          var formattedValue = parseFloat(value.toFixed(decimalPlaces));
          delayValue.textContent = formattedValue;
        }
      });
      this.enhanceSliderInteraction(delaySlider, 'delay-value');
    }
    
    if (fontSizeSlider) {
      fontSizeSlider.addEventListener('input', function(e) {
        var fontSizeValue = document.getElementById('font-size-value');
        if (fontSizeValue) {
          fontSizeValue.textContent = e.target.value + 'px';
        }
        var englishWord = document.getElementById('english-word');
        var chineseWord = document.getElementById('chinese-word');
        var previewEnglish = document.querySelector('.preview-english');
        var previewChinese = document.querySelector('.preview-chinese');
        
        if (englishWord) englishWord.style.fontSize = e.target.value + 'px';
        if (chineseWord) chineseWord.style.fontSize = e.target.value + 'px';
        if (previewEnglish) previewEnglish.style.fontSize = Math.max(16, e.target.value * 0.2) + 'px';
        if (previewChinese) previewChinese.style.fontSize = Math.max(14, e.target.value * 0.18) + 'px';
      });
      this.enhanceSliderInteraction(fontSizeSlider, 'font-size-value', 'px');
    }
    
    // 顯示模式 radio 切換時，即時顯示/隱藏「要會拼強制先中文」開關
    var displayModeRadios = document.querySelectorAll('input[name="display-mode"]');
    for (var r = 0; r < displayModeRadios.length; r++) {
      displayModeRadios[r].addEventListener('change', function() {
        var mustSpellGroup = document.getElementById('must-spell-chinese-first-group');
        if (mustSpellGroup) {
          mustSpellGroup.style.display = this.value === 'mixed' ? '' : 'none';
        }
      });
    }
    
    // 字型選擇器事件監聽
    var fontFamilySelect = document.getElementById('font-family-setting');
    if (fontFamilySelect) {
      this.protectSelectElement(fontFamilySelect);
      
      fontFamilySelect.addEventListener('change', function(e) {
        console.log('字型選擇改變:', e.target.value);
        var selectedFont = e.target.value;
        var fontFamily = self.fontFamilyMap[selectedFont] || self.fontFamilyMap['system-default'];
        
        var englishWord = document.getElementById('english-word');
        var chineseWord = document.getElementById('chinese-word');
        if (englishWord) englishWord.style.fontFamily = fontFamily;
        if (chineseWord) chineseWord.style.fontFamily = fontFamily;
        
        var previewEnglish = document.querySelector('.preview-english');
        var previewChinese = document.querySelector('.preview-chinese');
        if (previewEnglish) previewEnglish.style.fontFamily = fontFamily;
        if (previewChinese) previewChinese.style.fontFamily = fontFamily;
      });
    }
  };

  // --- Google Sheet 設定模態框 ---
  FlashcardApp.prototype._setupSheetSettingsModalListeners = function() {
    var self = this;
    var sheetSettingsModal = document.getElementById('sheet-settings-modal');
    var closeSheetSettings = document.getElementById('close-sheet-settings');
    var cancelSheetSettings = document.getElementById('cancel-sheet-settings');
    var saveSheetSettings = document.getElementById('save-sheet-settings');
    var loadSheetsBtn = document.getElementById('load-sheets-btn');
    
    if (closeSheetSettings) {
      closeSheetSettings.addEventListener('click', function() { self.closeSheetSettings(); });
    }
    if (cancelSheetSettings) {
      cancelSheetSettings.addEventListener('click', function() { self.closeSheetSettings(); });
    }
    if (saveSheetSettings) {
      saveSheetSettings.addEventListener('click', function() { self.saveSheetSettingsAndClose(); });
    }
    if (loadSheetsBtn) {
      loadSheetsBtn.addEventListener('click', function() { self.loadSheetsList(); });
    }
    var toggleSelectAllBtn = document.getElementById('toggle-select-all-btn');
    if (toggleSelectAllBtn) {
      toggleSelectAllBtn.addEventListener('click', function(e) {
        e.preventDefault();
        self.toggleSelectAll();
      });
    }
    var clearAllBtn = document.getElementById('clear-all-btn');
    if (clearAllBtn) {
      clearAllBtn.addEventListener('click', function(e) {
        e.preventDefault();
        self.clearAllSelection();
      });
    }
    if (sheetSettingsModal) {
      sheetSettingsModal.addEventListener('click', function(e) {
        var target = e.target;
        var isSelectRelated = false;
        var element = target;
        while (element && element !== sheetSettingsModal) {
          if (element.tagName === 'SELECT' || 
              element.tagName === 'OPTION' ||
              element.classList.contains('setting-control')) {
            isSelectRelated = true;
            break;
          }
          element = element.parentElement;
        }
        if (e.target === sheetSettingsModal && !isSelectRelated) {
          self.closeSheetSettings();
        }
      });
    }
  };

  // --- 語音設定模態框 ---
  FlashcardApp.prototype._setupVoiceSettingsModalListeners = function() {
    var self = this;
    var voiceSettingsModal = document.getElementById('voice-settings-modal');
    var closeVoiceSettings = document.getElementById('close-voice-settings');
    var cancelVoiceSettings = document.getElementById('cancel-voice-settings');
    var saveVoiceSettings = document.getElementById('save-voice-settings');
    var voiceRateSlider = document.getElementById('voice-rate-setting');
    
    if (closeVoiceSettings) {
      closeVoiceSettings.addEventListener('click', function() { self.closeVoiceSettings(); });
    }
    if (cancelVoiceSettings) {
      cancelVoiceSettings.addEventListener('click', function() { self.closeVoiceSettings(); });
    }
    if (saveVoiceSettings) {
      saveVoiceSettings.addEventListener('click', function() { self.saveVoiceSettingsAndClose(); });
    }
    if (voiceSettingsModal) {
      voiceSettingsModal.addEventListener('click', function(e) {
        var target = e.target;
        var isSelectRelated = false;
        var element = target;
        while (element && element !== voiceSettingsModal) {
          if (element.tagName === 'SELECT' || 
              element.tagName === 'OPTION' ||
              element.classList.contains('setting-control')) {
            isSelectRelated = true;
            break;
          }
          element = element.parentElement;
        }
        if (e.target === voiceSettingsModal && !isSelectRelated) {
          self.closeVoiceSettings();
        }
      });
    }
    if (voiceRateSlider) {
      voiceRateSlider.addEventListener('input', function(e) {
        var voiceRateValue = document.getElementById('voice-rate-value');
        if (voiceRateValue) {
          var value = parseFloat(e.target.value);
          var step = parseFloat(e.target.step) || 0.1;
          var decimalPlaces = step.toString().indexOf('.') !== -1 ? step.toString().split('.')[1].length : 0;
          var formattedValue = parseFloat(value.toFixed(decimalPlaces));
          voiceRateValue.textContent = formattedValue;
        }
      });
      voiceRateSlider.addEventListener('change', function(e) {
        var voiceSelect = document.getElementById('voice-select-setting');
        if (voiceSelect && voiceSelect.value) {
          self.previewVoice(voiceSelect.value, 'Hello, this is a sample voice.');
        }
      });
      this.enhanceSliderInteraction(voiceRateSlider, 'voice-rate-value');
    }
  };

  // --- 匯出模態框 ---
  FlashcardApp.prototype._setupExportModalListeners = function() {
    var self = this;
    var exportModal = document.getElementById('export-modal');
    if (exportModal) {
      exportModal.addEventListener('click', function(e) {
        var target = e.target;
        var isSelectRelated = false;
        var element = target;
        while (element && element !== exportModal) {
          if (element.tagName === 'SELECT' || 
              element.tagName === 'OPTION' ||
              element.classList.contains('setting-control')) {
            isSelectRelated = true;
            break;
          }
          element = element.parentElement;
        }
        if (e.target === exportModal && !isSelectRelated) {
          self.closeExportModal();
        }
      });
    }
  };

  // --- 覆寫確認模態框 ---
  FlashcardApp.prototype._setupOverwriteModalListeners = function() {
    var self = this;
    var overwriteModal = document.getElementById('overwrite-confirm-modal');
    if (overwriteModal) {
      overwriteModal.addEventListener('click', function(e) {
        var target = e.target;
        var isSelectRelated = false;
        var element = target;
        while (element && element !== overwriteModal) {
          if (element.tagName === 'SELECT' || 
              element.tagName === 'OPTION' ||
              element.classList.contains('setting-control')) {
            isSelectRelated = true;
            break;
          }
          element = element.parentElement;
        }
        if (e.target === overwriteModal && !isSelectRelated) {
          self.closeOverwriteConfirmModal();
        }
      });
    }
  };

  // --- SRS 複習模態框 ---
  FlashcardApp.prototype._setupSrsModalListeners = function() {
    var self = this;
    var closeSrsModal = document.getElementById('close-srs-modal');
    var srsStartBtn = document.getElementById('srs-start-btn');
    var srsReviewModal = document.getElementById('srs-review-modal');
    
    if (closeSrsModal) {
      closeSrsModal.addEventListener('click', function() { self.closeSrsReviewModal(); });
    }
    if (srsStartBtn) {
      srsStartBtn.addEventListener('click', function() {
        if (self._srsSelectedCount) {
          self.startSrsReview(self._srsSelectedCount);
        }
      });
    }
    if (srsReviewModal) {
      srsReviewModal.addEventListener('click', function(e) {
        if (e.target === srsReviewModal) {
          self.closeSrsReviewModal();
        }
      });
    }
  };
  
    // 鍵盤監聽器 - iPad 4 兼容版本
  FlashcardApp.prototype.setupKeyboardListeners = function() {
    var self = this;
    
    // iPad 4 兼容性改進：確保 body 元素可以接收鍵盤事件
    var body = document.body;
    
    // 設置 tabindex 屬性，讓 body 可以被聚焦
    body.setAttribute('tabindex', '0');
    
    // 自動聚焦到 body 元素
    body.focus();
    
    // 加入點擊事件監聽器，確保點擊後重新聚焦到 body（但排除表單控件）
    body.addEventListener('click', function(e) {
      // 檢查點擊目標是否為表單控件
      var target = e.target;
      if (target && (
          target.tagName === 'SELECT' ||
          target.tagName === 'OPTION' ||
          target.tagName === 'INPUT' ||
          target.tagName === 'TEXTAREA' ||
          target.contentEditable === 'true'
      )) {
        console.log('點擊了表單控件，不重新聚焦到body:', target.tagName);
        return; // 不重新聚焦，讓表單控件保持焦點
      }
      
      // 檢查是否點擊了表單控件的容器
      var element = target;
      while (element && element !== body) {
        if (element.classList && (
            element.classList.contains('setting-control') ||
            element.classList.contains('font-preview')
        )) {
          console.log('點擊了表單控件容器，不重新聚焦到body');
          return;
        }
        element = element.parentElement;
      }
      
      body.focus();
    });
    
      // 鍵盤事件處理函數 - 使用 ES5 兼容語法 + key-action mapping
      //
      // keyMap: 每個條目 = { keyCodes: [...], codes: [...], keys: [...], action: fn }
      // 比對順序：keyCode → code → key（iPad 4 相容）
      var keyMap = [
        // Enter / iPad UIKeyInputUpArrow → 標記不熟
        { keyCodes: [13], codes: ['Enter'], keys: ['UIKeyInputUpArrow'],
          action: function() { self.toggleDifficultCurrentWord(); } },
        // 空格 / iPad UIKeyInputDownArrow → 點擊單字
        { keyCodes: [32], codes: ['Space'], keys: ['UIKeyInputDownArrow'],
          action: function() { self.onWordClick(); } },
        // ← / iPad UIKeyInputLeftArrow → 上一個字
        { keyCodes: [37], codes: ['ArrowLeft'], keys: ['UIKeyInputLeftArrow'],
          action: function() { self.previousWord(); } },
        // ↑ → 上一個字
        { keyCodes: [38], codes: ['ArrowUp'], keys: [],
          action: function() { self.previousWord(); } },
        // → / iPad UIKeyInputRightArrow → 下一個字
        { keyCodes: [39], codes: ['ArrowRight'], keys: ['UIKeyInputRightArrow'],
          action: function() { self.nextWord(); } },
        // ↓ → 下一個字
        { keyCodes: [40], codes: ['ArrowDown'], keys: [],
          action: function() { self.nextWord(); } },
        // Escape → 關閉所有 modal
        { keyCodes: [27], codes: ['Escape'], keys: [],
          action: function() {
            self.cancelMarkVeryFamiliar();
            self.closeSettings();
            self.closeVoiceSettings();
            self.closeExportModal();
            self.closeOverwriteConfirmModal();
            self.closeDuplicateModal();
            self.closeDifficultyFilterModal();
            self.closeEditWordModal();
            self.closeMenu();
          } },
        // F5 / S → 增加不熟程度
        { keyCodes: [116, 83], codes: ['F5', 'KeyS'], keys: [],
          action: function() { self.increaseDifficulty(); } },
        // D → 標記非常熟（需按兩次確認）
        { keyCodes: [68], codes: ['KeyD'], keys: [],
          action: function() { self.handleMarkVeryFamiliar(); } },
        // E → 編輯當前單字（暫停時也可用）
        { keyCodes: [69], codes: ['KeyE'], keys: [],
          action: function() { self.openEditWordModal(); },
          allowWhenPaused: true }
      ];

  function handleKeyDown(e) {
    e = e || window.event;
    var keyCode = e.keyCode || e.which;
    var code = e.code || '';
    var key = e.key || '';
    
    // 焦點在表單控件上時不攔截
    var activeElement = document.activeElement;
    if (activeElement && (
        activeElement.tagName === 'SELECT' ||
        activeElement.tagName === 'INPUT' ||
        activeElement.tagName === 'TEXTAREA' ||
        activeElement.contentEditable === 'true'
    )) {
      return;
    }
    
    // B 鍵 - 暫停/繼續，任何狀態下都能使用
    if (keyCode === 66 || code === 'KeyB') {
      if (e.preventDefault) { e.preventDefault(); } else { e.returnValue = false; }
      self.togglePause();
      return;
    }
    
    // 查找匹配的 action
    var matched = null;
    for (var i = 0; i < keyMap.length; i++) {
      var entry = keyMap[i];
      var hit = false;
      for (var j = 0; j < entry.keyCodes.length; j++) {
        if (keyCode === entry.keyCodes[j]) { hit = true; break; }
      }
      if (!hit) {
        for (var k = 0; k < entry.codes.length; k++) {
          if (code === entry.codes[k]) { hit = true; break; }
        }
      }
      if (!hit && entry.keys) {
        for (var m = 0; m < entry.keys.length; m++) {
          if (key === entry.keys[m]) { hit = true; break; }
        }
      }
      if (hit) { matched = entry; break; }
    }
    
    if (!matched) return;
    
    // 暫停時只允許標記為 allowWhenPaused 的按鍵
    if (self.isPaused && !matched.allowWhenPaused) return;
    
    if (e.preventDefault) { e.preventDefault(); } else { e.returnValue = false; }
    matched.action();
    }
    
    // 監聽整個 document 的鍵盤事件
    document.addEventListener('keydown', handleKeyDown);
    
    console.log('鍵盤事件監聽器已設置 (iPad 4 兼容版本)');
  };
  
  // 觸控滑動手勢監聽器（支援 smartphone, iPhone, Android, iPad）
  FlashcardApp.prototype.setupSwipeListeners = function() {
    var self = this;
    var flashcardDiv = document.getElementById('flashcard');
    if (!flashcardDiv) {
      console.log('找不到 flashcard 元素，跳過滑動手勢設置');
      return;
    }

    var touchStartX = 0;
    var touchStartY = 0;
    var touchStartTime = 0;
    var isSwiping = false;
    var SWIPE_THRESHOLD = 50;      // 最小滑動距離（px）
    var SWIPE_TIME_LIMIT = 500;    // 最大滑動時間（ms）

    flashcardDiv.addEventListener('touchstart', function(e) {
      if (!e.touches || e.touches.length === 0) return;
      var touch = e.touches[0];
      touchStartX = touch.pageX;
      touchStartY = touch.pageY;
      touchStartTime = new Date().getTime();
      isSwiping = false;
    });

    flashcardDiv.addEventListener('touchmove', function(e) {
      // 偵測水平滑動時防止頁面捲動
      if (!e.touches || e.touches.length === 0) return;
      var touch = e.touches[0];
      var deltaX = touch.pageX - touchStartX;
      var deltaY = touch.pageY - touchStartY;

      if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 10) {
        isSwiping = true;
        if (e.preventDefault) {
          e.preventDefault();
        } else {
          e.returnValue = false;
        }
      }
    });

    flashcardDiv.addEventListener('touchend', function(e) {
      if (!e.changedTouches || e.changedTouches.length === 0) return;
      var touch = e.changedTouches[0];
      var deltaX = touch.pageX - touchStartX;
      var deltaY = touch.pageY - touchStartY;
      var deltaTime = new Date().getTime() - touchStartTime;

      // 滑動距離太短或時間太長，不視為滑動
      if (Math.abs(deltaX) < SWIPE_THRESHOLD) return;
      if (deltaTime > SWIPE_TIME_LIMIT) return;

      // 水平滑動距離必須大於垂直滑動距離（避免與上下捲動衝突）
      if (Math.abs(deltaX) < Math.abs(deltaY)) return;

      // 暫停時不處理滑動
      if (self.isPaused) return;

      // 阻止後續的 click 事件（避免滑動同時觸發點擊）
      if (e.preventDefault) {
        e.preventDefault();
      } else {
        e.returnValue = false;
      }

      // 往左滑 → 下一個字（等於按下鍵盤右鍵 →）
      if (deltaX < 0) {
        console.log('偵測到往左滑動，切換到下一個單字');
        self.nextWord();
      }
      // 往右滑 → 上一個字（等於按下鍵盤左鍵 ←）
      else {
        console.log('偵測到往右滑動，切換到上一個單字');
        self.previousWord();
      }
    });

    console.log('觸控滑動手勢監聽器已設置');
  };

  // 進度區和匯出監聽器
  FlashcardApp.prototype.setupProgressAndExportListeners = function() {
    console.log('設置進度區和匯出事件監聽器...');
    var self = this;
  
    // 進度區點擊：增加不熟程度
    var progressArea = document.getElementById('progress-area');
    if (progressArea) {
      var newProgressArea = progressArea.cloneNode(true);
      progressArea.parentNode.replaceChild(newProgressArea, progressArea);
  
      newProgressArea.addEventListener('click', function(e) {
        if (e.target && e.target.id === 'clear-filters-btn') return;
        console.log('進度區被點擊，增加不熟程度');
        self.increaseDifficulty();
      });
      console.log('進度區事件監聽器設置完成');
    } else {
      console.error('找不到 progress-area 元素');
    }

    // 篩選指示器的清除按鈕
    var clearFiltersBtn = document.getElementById('clear-filters-btn');
    if (clearFiltersBtn) {
      clearFiltersBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        self.clearAllFilters();
      });
    }
  
    // 匯出相關事件
    var closeExportModal = document.getElementById('close-export-modal');
    var cancelExport = document.getElementById('cancel-export');
    var confirmExport = document.getElementById('confirm-export');
  
    if (closeExportModal) {
      closeExportModal.addEventListener('click', function() { self.closeExportModal(); });
    }
    if (cancelExport) {
      cancelExport.addEventListener('click', function() { self.closeExportModal(); });
    }
    if (confirmExport) {
      confirmExport.addEventListener('click', function() { self.confirmExport(); });
    }
  
    console.log('匯出相關事件監聽器設置完成');
    
    // 隱藏控制按鈕事件監聽器
    this.setupHiddenControlListeners();
  };
  
  // 設置隱藏控制按鈕監聽器
  FlashcardApp.prototype.setupHiddenControlListeners = function() {
    console.log('設置隱藏控制按鈕事件監聽器...');
    var self = this;
    

    
    
    

    
    console.log('隱藏控制按鈕事件監聽器設置完成');
  };

  // 自訂確認對話框（取代瀏覽器內建 confirm，避免離開全螢幕）
  // options: { title, message, warning, confirmText, cancelText }
  // onConfirm: 確認回呼
  // onCancel: 取消回呼（可選）
  FlashcardApp.prototype.customConfirm = function(options, onConfirm, onCancel) {
    var modal = document.getElementById('custom-confirm-modal');
    var titleEl = document.getElementById('custom-confirm-title');
    var messageEl = document.getElementById('custom-confirm-message');
    var warningEl = document.getElementById('custom-confirm-warning');
    var confirmBtn = document.getElementById('custom-confirm-ok');
    var cancelBtn = document.getElementById('custom-confirm-cancel');

    if (!modal) return;

    // 設定內容
    titleEl.textContent = options.title || '確認';
    messageEl.textContent = options.message || '';
    
    if (options.warning) {
      warningEl.textContent = options.warning;
      warningEl.style.display = 'block';
    } else {
      warningEl.style.display = 'none';
    }

    confirmBtn.textContent = options.confirmText || '確定';
    cancelBtn.textContent = options.cancelText || '取消';

    // 顯示對話框
    modal.style.display = 'flex';

    // 清理函式
    var cleanup = function() {
      modal.style.display = 'none';
      confirmBtn.onclick = null;
      cancelBtn.onclick = null;
      modal.onclick = null;
    };

    // 確認按鈕
    confirmBtn.onclick = function() {
      cleanup();
      if (onConfirm) onConfirm();
    };

    // 取消按鈕
    cancelBtn.onclick = function() {
      cleanup();
      if (onCancel) onCancel();
    };

    // 點擊背景關閉（等同取消）
    modal.onclick = function(e) {
      if (e.target === modal) {
        cleanup();
        if (onCancel) onCancel();
      }
    };
  };

  

  

  

  

  

  
</script>

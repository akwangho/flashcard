<!-- script-core.html -->
<script>
  /**
   * @module script-core
   * @description æ ¸å¿ƒæ¨¡çµ„ï¼šFlashcardApp å»ºæ§‹å‡½å¼ã€åˆå§‹åŒ–æµç¨‹ã€è¨­å®šè¼‰å…¥/å„²å­˜ã€
   *   Sheet æ­·å²è¨˜éŒ„ç®¡ç†ã€é€è¡¨è¼‰å…¥å–®å­—ï¼ˆå«é€²åº¦æ¢ï¼‰ã€å®¢æˆ¶ç«¯é‡è¤‡åµæ¸¬ã€‚
   *   åŒæ™‚å®šç¾©å…¨åŸŸå¸¸æ•¸ APP_CONSTANTS å’Œå…±ç”¨å·¥å…·å‡½å¼ã€‚
   *
   * @dependencies ç„¡å¤–éƒ¨ç›¸ä¾ï¼ˆæ­¤æª”æ¡ˆæœ€å…ˆè¼‰å…¥ï¼‰
   * @provides FlashcardApp, APP_CONSTANTS, formatDateYYYYMMDD,
   *   isModalBackgroundClick, selectVoiceByURIOrLang, applyDifficultyClass,
   *   openModalById, closeModalById
   */

  // =====================================================================
  // å…¨åŸŸå¸¸æ•¸å®šç¾©ï¼ˆé›†ä¸­ç®¡ç†æ‰€æœ‰ magic numbersï¼Œæ–¹ä¾¿ç¶­è­·ï¼‰
  // =====================================================================
  var APP_CONSTANTS = {
    // === è¶…æ™‚è¨­å®šï¼ˆæ¯«ç§’ï¼‰ ===
    LOAD_TIMEOUT_MS: 30000,          // æ•´é«”è¼‰å…¥è¶…æ™‚
    PHASE1_TIMEOUT_MS: 15000,        // Sheet é€£æ¥è¶…æ™‚ï¼ˆPhase 1ï¼‰
    PHASE2_TIMEOUT_MS: 30000,        // Sheet è³‡è¨Šè¼‰å…¥è¶…æ™‚ï¼ˆPhase 2ï¼‰
    SPEECH_WAIT_TIMEOUT_MS: 60000,   // èªéŸ³ç­‰å¾…æœ€é•·æ™‚é–“
    VERY_FAMILIAR_TIMEOUT_MS: 3000,  // D éµé›™æŒ‰ç¢ºèªç­‰å¾…æ™‚é–“
    DUPLICATE_TIMEOUT_MS: 30000,     // é‡è¤‡è™•ç†è¶…æ™‚
    SPEECH_DELAY_MS: 500,            // èªéŸ³æ’­æ”¾å»¶é²
    TRANSITION_DELAY_MS: 300,        // è½‰å ´å‹•ç•«å»¶é²
    IMAGE_PREVIEW_DEBOUNCE_MS: 500,  // åœ–ç‰‡é è¦½é˜²æŠ–
    NOTIFICATION_DURATION_MS: 5000,  // é€šçŸ¥è‡ªå‹•æ¶ˆå¤±æ™‚é–“
    NOTIFICATION_FADE_MS: 300,       // é€šçŸ¥æ·¡å‡ºå‹•ç•«æ™‚é–“
    CHINESE_SPEECH_POLL_MS: 100,     // ä¸­æ–‡èªéŸ³è¼ªè©¢é–“éš”
    SPEECH_WAIT_POLL_MS: 100,        // èªéŸ³ç­‰å¾…è¼ªè©¢é–“éš”
    AUDIO_WATCHDOG_INTERVAL_MS: 10000, // éŸ³é »ç›£æ§é–“éš”
    KEEP_ALIVE_INTERVAL_MS: 30000,   // Keep-alive é–“éš”

    // === ç¯©é¸å¤©æ•¸ ===
    FILTER_DAYS: {
      '2weeks': 14,
      '1month': 30,
      '3months': 90,
      '6months': 180
    },

    // === SRS é–“éš”é‡è¤‡ç³»çµ± ===
    SRS_COUNT_OPTIONS: [10, 20, 30, 50, 100],
    SRS_BOX_INTERVALS: { 1: 1, 2: 3, 3: 7, 4: 14, 5: 30, 6: 60 },
    SRS_MAX_BOX: 6,

    // === æ¸¬é©— ===
    QUIZ_MIN_WORDS: 3,
    QUIZ_QUICK_COUNT: 10,
    QUIZ_POINTS_PER_QUESTION: 10,
    QUIZ_MAX_WRONG_OPTION_ATTEMPTS: 100,
    QUIZ_WRONG_OPTIONS_COUNT: 3,
    QUIZ_GENERIC_OPTIONS_ZH: ['æ¡Œå­', 'é›»è…¦', 'æ›¸æœ¬', 'æ°´æœ', 'å‹•ç‰©', 'é¡è‰²', 'å¤©æ°£', 'æ™‚é–“'],
    QUIZ_GENERIC_OPTIONS_EN: ['table', 'computer', 'book', 'fruit', 'animal', 'color', 'weather', 'time'],

    // === åŒ¯å‡º ===
    EXPORT_BATCH_SIZE: 15,
    EXPORT_BATCH_DELAY_MS: 300,

    // === é è¨­ Sheet ===
    DEFAULT_SHEETS: [
      { id: '1jrpECEaDgtcXawdO9Rl4raHZ_sqmvnUm7x0bJ4IqfRM', name: 'WordGo Data Sheet' },
      { id: '1hX2Ux2__5F-jdhfegmzMBZ7bg3faOt06ARb7ezC8Yzg', name: 'å°å­¸ç”Ÿæ•™è‚²éƒ¨è¦å®š1200å–®å­—' }
    ],

    // === æ­·å²è¨˜éŒ„ ===
    HISTORY_MAX_ITEMS: 10,
    NAV_HISTORY_MAX: 20,

    // === æ’é™¤çš„å·¥ä½œè¡¨ ===
    EXCLUDED_SHEETS: ['è¨˜äº‹'],

    // === è¤‡ç¿’åŒæ­¥ ===
    REVIEW_SYNC_THRESHOLD: 20,

    // === æ™ºæ…§è¨ˆæ™‚å™¨ï¼ˆBetaï¼‰ ===
    SMART_TIMER_BASE_TIME: 1.0,       // åŸºæœ¬è¨˜æ†¶å¸æ”¶æ™‚é–“ï¼ˆç§’ï¼‰
    SMART_TIMER_PER_CHAR_TIME: 0.15,  // æ¯å­—å…ƒé–±è®€æ™‚é–“ï¼ˆç§’ï¼‰
    SMART_TIMER_MIN_TIME: 1.2,        // æœ€çŸ­ç­‰å¾…æ™‚é–“ï¼ˆç§’ï¼‰

    // === localStorage éµå ===
    STORAGE_KEYS: {
      SETTINGS: 'flashcard-settings',
      VOICE_SETTINGS: 'flashcard-voice-settings',
      SHEET_SETTINGS: 'flashcard-sheet-settings',
      SHEET_HISTORY: 'flashcard-sheet-history',
      LAST_WORD: 'flashcard-last-word',
      SRS: 'flashcard-srs'
    }
  };

  // =====================================================================
  // å…±ç”¨å·¥å…·å‡½å¼ï¼ˆæ¶ˆé™¤è·¨æª”æ¡ˆé‡è¤‡ç¨‹å¼ç¢¼ï¼‰
  // =====================================================================

  /**
   * æ ¼å¼åŒ–æ—¥æœŸç‚º YYYY-MM-DD å­—ä¸²ï¼ˆES5 å…¼å®¹ï¼‰
   * @param {Date} [date] - è¦æ ¼å¼åŒ–çš„æ—¥æœŸï¼Œé è¨­ç‚ºä»Šå¤©
   * @returns {string} æ ¼å¼åŒ–å¾Œçš„æ—¥æœŸå­—ä¸²
   */
  function formatDateYYYYMMDD(date) {
    var d = date || new Date();
    var year = d.getFullYear();
    var month = d.getMonth() + 1;
    var day = d.getDate();
    if (month < 10) month = '0' + month;
    if (day < 10) day = '0' + day;
    return year + '-' + month + '-' + day;
  }

  /**
   * åˆ¤æ–· modal èƒŒæ™¯é»æ“Šæ˜¯å¦æ‡‰é—œé–‰ modalï¼ˆæ’é™¤ SELECT ç­‰è¡¨å–®å…ƒç´ ï¼‰
   * @param {Event} e - é»æ“Šäº‹ä»¶
   * @param {HTMLElement} modal - modal å…ƒç´ 
   * @returns {boolean} æ˜¯å¦æ‡‰è©²é—œé–‰ modal
   */
  function isModalBackgroundClick(e, modal) {
    if (e.target !== modal) return false;
    var checkEl = e.target;
    while (checkEl && checkEl !== modal) {
      var tag = checkEl.tagName;
      if (tag === 'SELECT' || tag === 'OPTION' ||
          (checkEl.classList && (
            checkEl.classList.contains('setting-control') ||
            checkEl.classList.contains('font-preview')))) {
        return false;
      }
      checkEl = checkEl.parentElement;
    }
    return true;
  }

  /**
   * å¾èªéŸ³åˆ—è¡¨ä¸­é¸æ“‡èªéŸ³ï¼ˆä¾ voiceURI æˆ–èªç³»å‰ç¶´ï¼‰
   * @param {Array} voices - å¯ç”¨èªéŸ³åˆ—è¡¨
   * @param {string} voiceURI - åå¥½çš„èªéŸ³ URI
   * @param {string} langPrefix - èªç³»å‰ç¶´ï¼ˆå¦‚ 'en-', 'ja-', 'zh-'ï¼‰
   * @returns {Object|null} æ‰¾åˆ°çš„èªéŸ³ç‰©ä»¶
   */
  function selectVoiceByURIOrLang(voices, voiceURI, langPrefix) {
    var found = null;
    for (var i = 0; i < voices.length; i++) {
      if (voices[i].voiceURI === voiceURI) return voices[i];
      if (!found && voices[i].lang.indexOf(langPrefix) === 0) found = voices[i];
    }
    return found;
  }

  /**
   * å¥—ç”¨ä¸ç†Ÿç¨‹åº¦ CSS class åˆ°å…ƒç´ ï¼ˆæ¸…é™¤èˆŠ class å¾ŒåŠ å…¥æ–° classï¼‰
   * @param {HTMLElement} element - ç›®æ¨™å…ƒç´ 
   * @param {number} level - ä¸ç†Ÿç¨‹åº¦ç­‰ç´š (-1 åˆ° 10)
   */
  function applyDifficultyClass(element, level) {
    if (!element) return;
    for (var i = -1; i <= 10; i++) {
      var cls = 'difficulty-level-' + (i === -1 ? 'n1' : i);
      element.className = element.className.replace(new RegExp('\\b' + cls + '\\b', 'g'), '');
    }
    var newCls = 'difficulty-level-' + (level === -1 ? 'n1' : level);
    element.className = (element.className + ' ' + newCls).replace(/\s+/g, ' ').trim();
  }

  /**
   * é€šç”¨ Modal é–‹å•Ÿï¼ˆæš«åœè¨ˆæ™‚å™¨ + é¡¯ç¤ºï¼‰
   * @param {string} modalId - modal å…ƒç´ çš„ ID
   * @returns {HTMLElement|null} modal å…ƒç´ 
   */
  function openModalById(app, modalId) {
    var modal = document.getElementById(modalId);
    if (!modal) return null;
    modal.style.display = 'flex';
    if (app && typeof app.pauseTimer === 'function') app.pauseTimer();
    return modal;
  }

  /**
   * é€šç”¨ Modal é—œé–‰ï¼ˆéš±è— + æ¢å¾©è¨ˆæ™‚å™¨ï¼‰
   * @param {string} modalId - modal å…ƒç´ çš„ ID
   */
  function closeModalById(app, modalId) {
    var modal = document.getElementById(modalId);
    if (modal) modal.style.display = 'none';
    if (app && typeof app.resumeTimer === 'function') app.resumeTimer();
  }

  // å…¨åŸŸ FlashcardApp
  function FlashcardApp() {
    this._initCoreState();
    this._initVoiceState();
    this._initSettingsState();
    this._initFilterState();
    this._initScreenAwakeState();
    this._initQuizState();
    
    // å•Ÿå‹•åˆå§‹åŒ–
    this.init();
  }

  // --- å»ºæ§‹å‡½å¼åˆ†çµ„åˆå§‹åŒ– ---

  /** æ ¸å¿ƒç‹€æ…‹ï¼šå–®å­—ã€ç´¢å¼•ã€è¨ˆæ™‚å™¨ã€å°èˆª */
  FlashcardApp.prototype._initCoreState = function() {
    this.words = [];
    this.currentWords = [];
    this.currentIndex = 0;
    this.showingChinese = false;
    this.isTransitioning = false;
    this.isProcessingClick = false;
    this.displayTimer = null;
    this.removedWords = [];
    this.navigationHistory = [];
    this.pendingRemoval = null;
    this.isPaused = false;
    this.userPaused = false;
    this.pausedTimestamp = null;
    this.remainingTime = 0;
    this._progressPhase = null;
    this._progressDuration = null;
    this._pauseRemainingMs = 0;
    this.progressTimer = null;
    this.currentWordReversed = false;
    this.listenersSetup = false;
  };

  /** èªéŸ³ç›¸é—œç‹€æ…‹ */
  FlashcardApp.prototype._initVoiceState = function() {
    this.speechSynthesis = window.speechSynthesis;
    this.speechActivated = false;
    this.isLegacyBrowser = false;
    this.chineseWaitInterval = null;
    this._speechWaitInterval = null;
    this._speechWaitTimeout = null;
    this._speechSequenceActive = false;
    this.voiceSettings = {
      enabled: true,
      rate: 0.8,
      pitch: 1,
      volume: 1,
      lang: 'en-US',
      voiceURI: '',
      japaneseLang: 'ja-JP',
      japaneseVoiceURI: '',
      spellOutLetters: false,
      chineseEnabled: false,
      chineseLang: 'zh-TW',
      chineseVoiceURI: ''
    };
  };

  /** è¨­å®šã€å­—å‹æ˜ å°„ã€Sheet è¨­å®š */
  FlashcardApp.prototype._initSettingsState = function() {
    this.settings = {
      delayTime: 4.5,
      fontSize: 96,
      displayMode: 'english-first',
      fontFamily: 'system-default',
      delaySpeechInNormalMode: false,
      mustSpellChineseFirst: true,
      showTimerProgressBar: true,
      timerProgressBarOffset: 0,
      smartTimerEnabled: false
    };
    this.fontFamilyMap = {
      'system-default': "'Microsoft JhengHei', 'PingFang TC', 'Helvetica Neue', Arial, sans-serif",
      'microsoft-yahei': "'Microsoft JhengHei', 'Microsoft YaHei', 'SimHei', 'Arial Unicode MS', Arial, sans-serif",
      'songti': "'STSong', 'SimSun', 'Times New Roman', serif",
      'kaiti': "'STKaiti', 'KaiTi', 'BiauKai', 'Times New Roman', serif",
      'arial': "Arial, 'Helvetica Neue', Helvetica, sans-serif",
      'helvetica': "'Helvetica Neue', Helvetica, Arial, sans-serif",
      'times': "'Times New Roman', Times, serif",
      'courier': "'Courier New', Courier, monospace",
      'verdana': "Verdana, Geneva, sans-serif"
    };
    this.sheetSettings = {
      sheetId: '',
      selectedSheets: []
    };
    this.availableSheets = [];
    this.isLoadingWordCounts = false;
    this.currentSpreadsheetName = null;
    this.duplicateWords = [];
    this.currentDuplicateIndex = 0;
    this.duplicateProcessingResults = [];
    this.preloadedImages = {};
    this.currentPreloadingImage = null;
  };

  /** ç¯©é¸ç›¸é—œç‹€æ…‹ï¼ˆé›£åº¦ã€è¤‡ç¿’æ™‚é–“ã€SRSã€è¦æœƒæ‹¼ï¼‰ */
  FlashcardApp.prototype._initFilterState = function() {
    this.difficultyFilter = 0;
    this.mustSpellFilter = false;
    this.reviewFilter = 'all';
    this.reviewedInSession = {};
    this.reviewSyncPending = false;
    this.reviewSyncThreshold = APP_CONSTANTS.REVIEW_SYNC_THRESHOLD;
    this.srsData = {};
    this.srsReviewActive = false;
    this._srsSelectedCount = 10;
  };

  /** é˜²æ­¢è¢å¹•é—œé–‰ç›¸é—œ */
  FlashcardApp.prototype._initScreenAwakeState = function() {
    this.wakeLock = null;
    this.noSleepVideo = null;
    this.keepScreenAwake = false;
    this._wakeLockAcquired = false;
    this._noSleepVideoPlaying = false;
    this._persistentAudioRunning = false;
    this._persistentAudioContext = null;
    this._persistentAudioElement = null;
    this._persistentAudioSource = null;
    this._persistentOscillator = null;
    // èƒŒæ™¯è¨ˆæ™‚ Web Workerï¼ˆAndroid èƒŒæ™¯åŸ·è¡Œæ”¯æ´ï¼‰
    this._bgWorker = null;
    this._bgWorkerCallbacks = {};
    this._bgWorkerNextId = 1;
    this._activeTimerInfo = null;
  };

  /** æ¸¬é©—ç›¸é—œå±¬æ€§ */
  FlashcardApp.prototype._initQuizState = function() {
    this.quizState = {
      isActive: false,
      type: 'quick',
      questions: [],
      currentQuestionIndex: 0,
      selectedAnswer: null,
      answers: [],
      score: 0,
      startTime: null,
      endTime: null
    };
  };
  
  // åˆå§‹åŒ–æ–¹æ³•
  FlashcardApp.prototype.init = function() {
    console.log('=== FlashcardApp åˆå§‹åŒ–é–‹å§‹ (ES5ç‰ˆæœ¬) ===');
    try {
      console.log('è¼‰å…¥åŸºæœ¬è¨­å®š...');
      this.loadSettings();
      this.loadSheetSettings();
      this.loadSrsData();
      
      console.log('Sheet è¨­å®š:', this.sheetSettings);
      
      // æª¢æ¸¬ç€è¦½å™¨æ˜¯å¦éœ€è¦èªéŸ³äº¤äº’
      this.detectLegacyBrowser();
      
      console.log('è¨­å®šäº‹ä»¶ç›£è½å™¨...');
      this.setupEventListeners();
      
      // æª¢æŸ¥æ˜¯å¦æœ‰å·²è¨­å®šçš„ Google Sheet
      if (this.sheetSettings.sheetId && this.sheetSettings.selectedSheets.length > 0) {
        console.log('ç™¼ç¾å·²è¨­å®šçš„ Google Sheetï¼Œè¼‰å…¥å–®å­—...');
        var self = this;
        this.loadWords(true, function(hasDuplicates) {
          self.handleLoadingComplete(hasDuplicates);
        });
        } else {
        console.log('æ²’æœ‰æ‰¾åˆ° Google Sheet è¨­å®šï¼Œé¡¯ç¤ºè¨­å®šç•«é¢');
        this.handleLoadingComplete(false, true);
        return;
      }
      
      console.log('=== FlashcardApp åˆå§‹åŒ–å®Œæˆ ===');
    } catch (error) {
      console.error('åˆå§‹åŒ–éŒ¯èª¤:', error);
      this.showError();
    }
    
    // åˆå§‹åŒ–æŒ‰éˆ•ç‹€æ…‹
    this.updateVoiceButtonState();
    this.updatePauseButtonState();
    
    // å•Ÿç”¨é˜²æ­¢è¢å¹•é—œé–‰åŠŸèƒ½
    this.enableKeepScreenAwake();
  };
  
  // æª¢æ¸¬èˆŠç‰ˆç€è¦½å™¨
  FlashcardApp.prototype.detectLegacyBrowser = function() {
    var userAgent = navigator.userAgent;
    var isIOS = /iPad|iPhone|iPod/.test(userAgent);
    var iosVersion = null;
    var isOldChrome = false;
    
    if (isIOS) {
      var match = userAgent.match(/OS (\d+)_/);
      if (match) {
        iosVersion = parseInt(match[1]);
      }
    }
    
    // æª¢æ¸¬èˆŠç‰ˆChromeï¼ˆç‰ˆæœ¬ä½æ–¼80ï¼‰
    var chromeMatch = userAgent.match(/Chrome\/(\d+)/);
    if (chromeMatch) {
      var chromeVersion = parseInt(chromeMatch[1]);
      isOldChrome = chromeVersion < 80;
    }
    
    // æª¢æ¸¬éœ€è¦ç”¨æˆ¶äº¤äº’æ‰èƒ½æ’­æ”¾èªéŸ³çš„ç€è¦½å™¨ï¼š
    // 1. iPad/iOS 10åŠä»¥ä¸‹ç‰ˆæœ¬
    // 2. èˆŠç‰ˆChromeï¼ˆç‰ˆæœ¬ä½æ–¼80ï¼‰
    // 3. Safari 12åŠä»¥ä¸‹ç‰ˆæœ¬
    this.isLegacyBrowser = (isIOS && iosVersion && iosVersion <= 10) || 
                          isOldChrome ||
                          userAgent.indexOf('Safari') !== -1 && userAgent.indexOf('Chrome') === -1 && 
                          userAgent.match(/Version\/(\d+)/) && parseInt(userAgent.match(/Version\/(\d+)/)[1]) <= 12;
    
    // æ–°ç‰ˆç€è¦½å™¨è‡ªå‹•å•Ÿç”¨èªéŸ³
    if (!this.isLegacyBrowser) {
      this.speechActivated = true;
    }
    
    console.log('ç€è¦½å™¨æª¢æ¸¬çµæœ:', {
      userAgent: userAgent,
      isIOS: isIOS,
      iosVersion: iosVersion,
      isOldChrome: isOldChrome,
      isLegacyBrowser: this.isLegacyBrowser,
      speechActivated: this.speechActivated
    });
  };
  
  // è™•ç†è¼‰å…¥å®Œæˆ
  FlashcardApp.prototype.handleLoadingComplete = function(hasDuplicates, shouldOpenSettings) {
    if (this.isLegacyBrowser && !this.speechActivated) {
      // èˆŠç‰ˆç€è¦½å™¨é¡¯ç¤ºèªéŸ³å•Ÿç”¨æŒ‰éˆ•
      this.showSpeechActivation();
    } else {
      // æ–°ç‰ˆç€è¦½å™¨æˆ–å·²å•Ÿç”¨èªéŸ³ï¼Œç›´æ¥é€²å…¥ä¸»ç•«é¢
      this.hideLoading();
      this.applySettings();
      
      if (shouldOpenSettings) {
        this.openSheetSettings();
      } else if (!hasDuplicates) {
        this.startNewRound();
      }
      
      // æ›´æ–° SRS å¾½ç« 
      this.updateSrsBadge();
    }
  };
  
  // è¼‰å…¥è¨­å®š
  FlashcardApp.prototype.loadSettings = function() {
    try {
      var savedSettings = JSON.parse(localStorage.getItem(APP_CONSTANTS.STORAGE_KEYS.SETTINGS) || '{}');
      
      // å‘å¾Œç›¸å®¹ï¼šå°‡èˆŠç‰ˆ reverseMode (boolean) é·ç§»è‡³æ–°ç‰ˆ displayMode (string)
      if (savedSettings.hasOwnProperty('reverseMode') && !savedSettings.hasOwnProperty('displayMode')) {
        savedSettings.displayMode = savedSettings.reverseMode ? 'chinese-first' : 'english-first';
        delete savedSettings.reverseMode;
      }
      
      for (var key in savedSettings) {
        if (savedSettings.hasOwnProperty(key) && this.settings.hasOwnProperty(key)) {
          this.settings[key] = savedSettings[key];
        }
      }
      
      var savedVoiceSettings = JSON.parse(localStorage.getItem(APP_CONSTANTS.STORAGE_KEYS.VOICE_SETTINGS) || '{}');
      for (var key in savedVoiceSettings) {
        if (savedVoiceSettings.hasOwnProperty(key) && this.voiceSettings.hasOwnProperty(key)) {
          this.voiceSettings[key] = savedVoiceSettings[key];
        }
      }
    } catch (e) {
      console.log('è¼‰å…¥è¨­å®šå¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼');
    }
  };
  
  // è¼‰å…¥Sheetè¨­å®š
  FlashcardApp.prototype.loadSheetSettings = function() {
    try {
      var savedSheetSettings = JSON.parse(localStorage.getItem(APP_CONSTANTS.STORAGE_KEYS.SHEET_SETTINGS) || '{}');
      for (var key in savedSheetSettings) {
        if (savedSheetSettings.hasOwnProperty(key) && this.sheetSettings.hasOwnProperty(key)) {
          this.sheetSettings[key] = savedSheetSettings[key];
        }
      }
    } catch (e) {
      console.log('è¼‰å…¥Sheetè¨­å®šå¤±æ•—');
    }
  };
  
  // å„²å­˜è¨­å®š
  FlashcardApp.prototype.saveSettings = function() {
    localStorage.setItem(APP_CONSTANTS.STORAGE_KEYS.SETTINGS, JSON.stringify(this.settings));
    localStorage.setItem(APP_CONSTANTS.STORAGE_KEYS.VOICE_SETTINGS, JSON.stringify(this.voiceSettings));
  };
  
  // å„²å­˜Sheetè¨­å®š
  FlashcardApp.prototype.saveSheetSettings = function() {
    localStorage.setItem(APP_CONSTANTS.STORAGE_KEYS.SHEET_SETTINGS, JSON.stringify(this.sheetSettings));
  };
  
  // ç²å–é è¨­Sheetåˆ—è¡¨
  FlashcardApp.prototype.getDefaultSheets = function() {
    var result = [];
    for (var i = 0; i < APP_CONSTANTS.DEFAULT_SHEETS.length; i++) {
      var s = APP_CONSTANTS.DEFAULT_SHEETS[i];
      result.push({ id: s.id, name: s.name, isDefault: true });
    }
    return result;
  };
  
  // æª¢æŸ¥æ˜¯å¦ç‚ºé è¨­Sheet
  FlashcardApp.prototype.isDefaultSheet = function(sheetId) {
    var defaultSheets = this.getDefaultSheets();
    for (var i = 0; i < defaultSheets.length; i++) {
      if (defaultSheets[i].id === sheetId) {
        return true;
      }
    }
    return false;
  };
  
  // è¼‰å…¥Sheetæ­·å²è¨˜éŒ„ï¼ˆä¸åŒ…å«é è¨­æª”æ¡ˆï¼‰
  FlashcardApp.prototype.loadSheetHistory = function() {
    try {
      var history = JSON.parse(localStorage.getItem(APP_CONSTANTS.STORAGE_KEYS.SHEET_HISTORY) || '[]');
      
      // éæ¿¾æ‰ä»»ä½•å¯èƒ½æ··å…¥çš„é è¨­æª”æ¡ˆ
      var filteredHistory = [];
      for (var i = 0; i < history.length; i++) {
        if (!this.isDefaultSheet(history[i].id)) {
          filteredHistory.push(history[i]);
        }
      }
      
      return filteredHistory;
    } catch (e) {
      console.log('è¼‰å…¥Sheetæ­·å²è¨˜éŒ„å¤±æ•—ï¼Œè¿”å›ç©ºé™£åˆ—');
      return [];
    }
  };
  
  // å„²å­˜Sheetæ­·å²è¨˜éŒ„
  FlashcardApp.prototype.saveSheetHistory = function(history) {
    try {
      localStorage.setItem(APP_CONSTANTS.STORAGE_KEYS.SHEET_HISTORY, JSON.stringify(history));
    } catch (e) {
      console.error('å„²å­˜Sheetæ­·å²è¨˜éŒ„å¤±æ•—:', e);
    }
  };
  
  // æ·»åŠ åˆ°Sheetæ­·å²è¨˜éŒ„
  FlashcardApp.prototype.addToSheetHistory = function(sheetId, sheetName) {
    try {
      console.log('æ·»åŠ åˆ°æ­·å²è¨˜éŒ„:', sheetId, sheetName);
      
      // æª¢æŸ¥æ˜¯å¦ç‚ºé è¨­æª”æ¡ˆï¼Œå¦‚æœæ˜¯å‰‡ä¸æ·»åŠ 
      if (this.isDefaultSheet(sheetId)) {
        console.log('é€™æ˜¯é è¨­æª”æ¡ˆï¼Œä¸æ·»åŠ åˆ°æ­·å²è¨˜éŒ„');
        return;
      }
      
      var history = this.loadSheetHistory();
      
      // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
      var existingIndex = -1;
      for (var i = 0; i < history.length; i++) {
        if (history[i].id === sheetId) {
          existingIndex = i;
          break;
        }
      }
      
      if (existingIndex !== -1) {
        // å¦‚æœå·²å­˜åœ¨ï¼Œæ›´æ–°åç¨±ä¸¦ç§»åˆ°æœ€å‰é¢
        history[existingIndex].name = sheetName;
        history[existingIndex].lastUsed = new Date().toISOString();
        var item = history.splice(existingIndex, 1)[0];
        history.unshift(item);
      } else {
        // æ–°é …ç›®ï¼Œæ·»åŠ åˆ°æœ€å‰é¢
        history.unshift({
          id: sheetId,
          name: sheetName,
          isDefault: false,
          lastUsed: new Date().toISOString()
        });
      }
      
      // é™åˆ¶æ­·å²è¨˜éŒ„æ•¸é‡
      if (history.length > APP_CONSTANTS.HISTORY_MAX_ITEMS) {
        history = history.slice(0, APP_CONSTANTS.HISTORY_MAX_ITEMS);
      }
      
      this.saveSheetHistory(history);
      console.log('æ­·å²è¨˜éŒ„å·²æ›´æ–°ï¼Œç¸½æ•¸:', history.length);
    } catch (e) {
      console.error('æ·»åŠ åˆ°æ­·å²è¨˜éŒ„å¤±æ•—:', e);
    }
  };
  
  // é¡¯ç¤ºSheetæ­·å²è¨˜éŒ„
  FlashcardApp.prototype.displaySheetHistory = function() {
    // é¡¯ç¤ºé è¨­æª”æ¡ˆ
    this.displayDefaultSheets();
    
    // é¡¯ç¤ºæœ€è¿‘ä½¿ç”¨çš„æª”æ¡ˆ
    this.displayRecentSheets();
  };
  
  // é¡¯ç¤ºé è¨­æª”æ¡ˆåˆ—è¡¨
  FlashcardApp.prototype.displayDefaultSheets = function() {
    var defaultList = document.getElementById('default-sheets-list');
    if (!defaultList) {
      console.error('æ‰¾ä¸åˆ°default-sheets-listå…ƒç´ ');
      return;
    }
    
    var defaultSheets = this.getDefaultSheets();
    console.log('é¡¯ç¤ºé è¨­æª”æ¡ˆï¼Œç¸½æ•¸:', defaultSheets.length);
    
    var html = '';
    for (var i = 0; i < defaultSheets.length; i++) {
      var item = defaultSheets[i];
      
      html += '<div class="sheet-history-item default-sheet" data-sheet-id="' + item.id + '">';
      html += '  <div class="sheet-history-info">';
      html += '    <div class="sheet-history-name">' + item.name + '</div>';
      html += '    <div class="sheet-history-id">' + item.id + '</div>';
      html += '  </div>';
      html += '  <span class="sheet-history-badge">é è¨­</span>';
      html += '</div>';
    }
    
    defaultList.innerHTML = html;
    
    // æ·»åŠ é»æ“Šäº‹ä»¶
    var self = this;
    var items = defaultList.querySelectorAll('.sheet-history-item');
    for (var i = 0; i < items.length; i++) {
      (function(item) {
        item.addEventListener('click', function() {
          var sheetId = item.getAttribute('data-sheet-id');
          self.selectSheetFromHistory(sheetId);
        });
      })(items[i]);
    }
  };
  
  // é¡¯ç¤ºæœ€è¿‘ä½¿ç”¨çš„æª”æ¡ˆåˆ—è¡¨
  FlashcardApp.prototype.displayRecentSheets = function() {
    var recentList = document.getElementById('recent-sheets-list');
    if (!recentList) {
      console.error('æ‰¾ä¸åˆ°recent-sheets-listå…ƒç´ ');
      return;
    }
    
    var history = this.loadSheetHistory();
    console.log('é¡¯ç¤ºæœ€è¿‘ä½¿ç”¨çš„æª”æ¡ˆï¼Œç¸½æ•¸:', history.length);
    
    if (history.length === 0) {
      recentList.innerHTML = '<div class="sheet-history-empty">å°šç„¡ä½¿ç”¨è¨˜éŒ„</div>';
      return;
    }
    
    var html = '';
    for (var i = 0; i < history.length; i++) {
      var item = history[i];
      
      html += '<div class="sheet-history-item recent-sheet" data-sheet-id="' + item.id + '">';
      html += '  <div class="sheet-history-info">';
      html += '    <div class="sheet-history-name">' + item.name + '</div>';
      html += '    <div class="sheet-history-id">' + item.id + '</div>';
      html += '  </div>';
      html += '  <button class="sheet-history-delete" data-sheet-id="' + item.id + '" title="åˆªé™¤">ğŸ—‘ï¸</button>';
      html += '</div>';
    }
    
    recentList.innerHTML = html;
    
    // æ·»åŠ é»æ“Šäº‹ä»¶ï¼ˆé¸æ“‡æª”æ¡ˆï¼‰
    var self = this;
    var items = recentList.querySelectorAll('.sheet-history-item');
    for (var i = 0; i < items.length; i++) {
      (function(item) {
        item.addEventListener('click', function(e) {
          // å¦‚æœé»æ“Šçš„æ˜¯åˆªé™¤æŒ‰éˆ•ï¼Œä¸åŸ·è¡Œé¸æ“‡æ“ä½œ
          if (e.target.classList.contains('sheet-history-delete')) {
            return;
          }
          var sheetId = item.getAttribute('data-sheet-id');
          self.selectSheetFromHistory(sheetId);
        });
      })(items[i]);
    }
    
    // æ·»åŠ åˆªé™¤æŒ‰éˆ•äº‹ä»¶
    var deleteButtons = recentList.querySelectorAll('.sheet-history-delete');
    for (var i = 0; i < deleteButtons.length; i++) {
      (function(button) {
        button.addEventListener('click', function(e) {
          e.stopPropagation(); // é˜²æ­¢è§¸ç™¼çˆ¶å…ƒç´ çš„é»æ“Šäº‹ä»¶
          var sheetId = button.getAttribute('data-sheet-id');
          self.removeFromSheetHistory(sheetId);
        });
      })(deleteButtons[i]);
    }
  };
  
  // å¾æ­·å²è¨˜éŒ„ä¸­åˆªé™¤
  FlashcardApp.prototype.removeFromSheetHistory = function(sheetId) {
    try {
      console.log('å¾æ­·å²è¨˜éŒ„åˆªé™¤:', sheetId);
      
      var history = this.loadSheetHistory();
      var newHistory = [];
      
      for (var i = 0; i < history.length; i++) {
        if (history[i].id !== sheetId) {
          newHistory.push(history[i]);
        }
      }
      
      this.saveSheetHistory(newHistory);
      console.log('å·²åˆªé™¤ï¼Œå‰©é¤˜è¨˜éŒ„æ•¸:', newHistory.length);
      
      // é‡æ–°é¡¯ç¤ºåˆ—è¡¨
      this.displayRecentSheets();
    } catch (e) {
      console.error('åˆªé™¤æ­·å²è¨˜éŒ„å¤±æ•—:', e);
    }
  };
  
  // å¾æ­·å²è¨˜éŒ„é¸æ“‡Sheet
  FlashcardApp.prototype.selectSheetFromHistory = function(sheetId) {
    console.log('å¾æ­·å²è¨˜éŒ„é¸æ“‡Sheet:', sheetId);
    
    var sheetIdInput = document.getElementById('sheet-id-input');
    if (sheetIdInput) {
      sheetIdInput.value = sheetId;
      
      // è‡ªå‹•è¼‰å…¥å·¥ä½œè¡¨æ¸…å–®ï¼ˆéš±è—éå¿…è¦å€å¡Šçš„é‚è¼¯å·²ç§»è‡³ updateSheetLoadingUIï¼‰
      this.loadSheetsList();
    }
  };
  
  // æ‡‰ç”¨è¨­å®š
  FlashcardApp.prototype.applySettings = function() {
    var englishWord = document.getElementById('english-word');
    var chineseWord = document.getElementById('chinese-word');
    var loadingText = document.querySelector('#loading p');
    
    // æ‡‰ç”¨å­—é«”å¤§å°
    if (englishWord) englishWord.style.fontSize = this.settings.fontSize + 'px';
    if (chineseWord) chineseWord.style.fontSize = this.settings.fontSize + 'px';
    if (loadingText) loadingText.style.fontSize = this.settings.fontSize + 'px';
    
    // æ‡‰ç”¨å­—å‹
    this.applyFontFamily();
    
    var delaySlider = document.getElementById('delay-setting');
    var fontSizeSlider = document.getElementById('font-size-setting');
    var fontFamilySelect = document.getElementById('font-family-setting');
    var delaySpeechToggle = document.getElementById('delay-speech-setting');
    var delayValue = document.getElementById('delay-value');
    var fontSizeValue = document.getElementById('font-size-value');
    
    if (delaySlider && delayValue) {
      delaySlider.value = this.settings.delayTime;
      // ä¿®å¾©æµ®é»æ•¸ç²¾åº¦å•é¡Œ
      var step = parseFloat(delaySlider.step) || 0.5;
      var decimalPlaces = step.toString().indexOf('.') !== -1 ? step.toString().split('.')[1].length : 0;
      var formattedDelayTime = parseFloat(this.settings.delayTime.toFixed(decimalPlaces));
      delayValue.textContent = formattedDelayTime;
    }
    if (fontSizeSlider && fontSizeValue) {
      fontSizeSlider.value = this.settings.fontSize;
      fontSizeValue.textContent = this.settings.fontSize + 'px';
    }
    if (fontFamilySelect) {
      fontFamilySelect.value = this.settings.fontFamily;
    }
    // è¨­å®šé¡¯ç¤ºæ¨¡å¼ radio buttons
    var displayModeRadios = document.querySelectorAll('input[name="display-mode"]');
    for (var i = 0; i < displayModeRadios.length; i++) {
      displayModeRadios[i].checked = (displayModeRadios[i].value === this.settings.displayMode);
    }
    if (delaySpeechToggle) delaySpeechToggle.checked = this.settings.delaySpeechInNormalMode;
    
    // è¨­å®šè¦æœƒæ‹¼å¼·åˆ¶å…ˆä¸­æ–‡é–‹é—œï¼ˆåƒ…æ··åˆæ¨¡å¼æ™‚é¡¯ç¤ºï¼‰
    var mustSpellChineseFirstToggle = document.getElementById('must-spell-chinese-first-setting');
    if (mustSpellChineseFirstToggle) mustSpellChineseFirstToggle.checked = this.settings.mustSpellChineseFirst;
    var mustSpellGroup = document.getElementById('must-spell-chinese-first-group');
    if (mustSpellGroup) {
      mustSpellGroup.style.display = this.settings.displayMode === 'mixed' ? '' : 'none';
    }
    
    // è¨­å®šæ™ºæ…§è¨ˆæ™‚é–‹é—œ
    var smartTimerToggle = document.getElementById('smart-timer-setting');
    if (smartTimerToggle) smartTimerToggle.checked = this.settings.smartTimerEnabled;
    
    // è¨­å®šè¨ˆæ™‚é€²åº¦æ¢é–‹é—œ
    var showTimerToggle = document.getElementById('show-timer-progress-setting');
    if (showTimerToggle) showTimerToggle.checked = this.settings.showTimerProgressBar;
    
    // è¨­å®šè¨ˆæ™‚é€²åº¦æ¢åç§»é‡è¼¸å…¥
    var timerOffsetInput = document.getElementById('timer-offset-setting');
    if (timerOffsetInput) timerOffsetInput.value = this.settings.timerProgressBarOffset || 0;
    
    // æ‡‰ç”¨è¨ˆæ™‚é€²åº¦æ¢é¡¯ç¤º/éš±è— + åç§»é‡
    var timerBar = document.getElementById('timer-progress-bar');
    if (timerBar) {
      if (this.settings.showTimerProgressBar) {
        timerBar.className = timerBar.className.replace(/\btimer-bar-hidden\b/g, '').replace(/\s{2,}/g, ' ');
      } else {
        if (timerBar.className.indexOf('timer-bar-hidden') === -1) {
          timerBar.className = (timerBar.className + ' timer-bar-hidden').replace(/^\s+/, '');
        }
      }
      var offset = parseInt(this.settings.timerProgressBarOffset, 10) || 0;
      timerBar.style.top = offset + 'px';
    }
    
    // ä¾é€²åº¦æ¢é–‹é—œé¡¯ç¤º/éš±è—åç§»é‡è¨­å®š
    var timerOffsetGroup = document.getElementById('timer-offset-group');
    if (timerOffsetGroup) {
      timerOffsetGroup.style.display = this.settings.showTimerProgressBar ? '' : 'none';
    }
    
    // æ›´æ–°å­—å‹é è¦½
    this.updateFontPreview();
    
    // æ‡‰ç”¨åœ–ç‰‡ç¸®æ”¾è¨­å®šï¼ˆæ°¸é ä½¿ç”¨ä¸è£åˆ‡æ¨¡å¼ï¼‰
    this.applyImageFitMode();
  };
  
  // æ‡‰ç”¨åœ–ç‰‡ç¸®æ”¾è¨­å®šï¼ˆæ°¸é ä½¿ç”¨ä¸è£åˆ‡æ¨¡å¼ï¼‰
  FlashcardApp.prototype.applyImageFitMode = function() {
    var flashcardDiv = document.getElementById('flashcard');
    if (flashcardDiv) {
      // æ°¸é ä½¿ç”¨containæ¨¡å¼ï¼ˆä¸è£åˆ‡ï¼‰
      flashcardDiv.classList.add('image-fit-contain');
      flashcardDiv.classList.remove('image-fit-cover');
    }
  };
  
  // æ‡‰ç”¨å­—å‹è¨­å®š
  FlashcardApp.prototype.applyFontFamily = function() {
    var fontFamily = this.fontFamilyMap[this.settings.fontFamily] || this.fontFamilyMap['system-default'];
    
    // æ‡‰ç”¨åˆ°ä¸»è¦å…ƒç´ 
    var elements = [
      document.getElementById('english-word'),
      document.getElementById('chinese-word'),
      document.querySelector('#loading p'),
      document.body // æ‡‰ç”¨åˆ°æ•´å€‹bodyä½œç‚ºfallback
    ];
    
    for (var i = 0; i < elements.length; i++) {
      if (elements[i]) {
        elements[i].style.fontFamily = fontFamily;
      }
    }
    
    console.log('å·²æ‡‰ç”¨å­—å‹:', this.settings.fontFamily, 'â†’', fontFamily);
  };
  
  // æ›´æ–°å­—å‹é è¦½
  FlashcardApp.prototype.updateFontPreview = function() {
    var previewEnglish = document.querySelector('.preview-english');
    var previewChinese = document.querySelector('.preview-chinese');
    var fontFamily = this.fontFamilyMap[this.settings.fontFamily] || this.fontFamilyMap['system-default'];
    
    if (previewEnglish) {
      previewEnglish.style.fontFamily = fontFamily;
    }
    if (previewChinese) {
      previewChinese.style.fontFamily = fontFamily;
    }
  };
  
  // åˆ¤æ–·æ˜¯å¦åœ¨æ¸¬é©—é€²è¡Œä¸­
  FlashcardApp.prototype.isQuizInProgress = function() {
    var progressScreen = document.getElementById('quiz-progress-screen');
    return progressScreen && progressScreen.style.display !== 'none';
  };
  
  // ä¿è­·selectå…ƒç´ ä¸å—å…¨åŸŸäº‹ä»¶å¹²æ“¾
  FlashcardApp.prototype.protectSelectElement = function(selectElement) {
    if (!selectElement) return;
    
    console.log('ç‚ºselectå…ƒç´ æ·»åŠ ä¿è­·:', selectElement.id || selectElement.className);
    
    // é˜»æ­¢æ‰€æœ‰å¯èƒ½å°è‡´å•é¡Œçš„äº‹ä»¶å†’æ³¡
    var eventsToProtect = ['click', 'mousedown', 'mouseup', 'focus', 'blur'];
    
    for (var i = 0; i < eventsToProtect.length; i++) {
      var eventType = eventsToProtect[i];
      
      (function(eventName) {
        selectElement.addEventListener(eventName, function(e) {
          console.log('Select ' + eventName + ' äº‹ä»¶ï¼Œé˜»æ­¢å†’æ³¡');
          e.stopPropagation();
          
          // å°æ–¼focusäº‹ä»¶ï¼Œç¢ºä¿selectç²å¾—ç„¦é»
          if (eventName === 'focus') {
            console.log('Selectç²å¾—ç„¦é»');
          }
          // å°æ–¼bluräº‹ä»¶ï¼Œè¨˜éŒ„å¤±å»ç„¦é»
          else if (eventName === 'blur') {
            console.log('Selectå¤±å»ç„¦é»');
          }
        }, true); // ä½¿ç”¨æ•ç²éšæ®µ
      })(eventType);
    }
    
    // ç‰¹åˆ¥è™•ç†éµç›¤äº‹ä»¶
    selectElement.addEventListener('keydown', function(e) {
      console.log('Select keydown äº‹ä»¶:', e.keyCode);
      e.stopPropagation();
      // ä¸èª¿ç”¨preventDefaultï¼Œè®“selectæ­£å¸¸è™•ç†éµç›¤è¼¸å…¥
    }, true);
    
    selectElement.addEventListener('keyup', function(e) {
      e.stopPropagation();
    }, true);
    
    // ç¢ºä¿selectå…ƒç´ æœ‰æ­£ç¢ºçš„æ¨£å¼
    selectElement.style.position = 'relative';
    selectElement.style.zIndex = '2100';
  };
  
  // æ›´æ–°è¼‰å…¥ç•«é¢é€²åº¦æ¢
  FlashcardApp.prototype.updateLoadingProgress = function(completed, total, statusText) {
    var fillEl = document.getElementById('loading-progress-fill');
    var textEl = document.getElementById('loading-status-text');
    var barEl = document.getElementById('loading-progress-bar');
    
    if (fillEl && barEl) {
      if (completed <= 0 && total > 0) {
        // ä¸ç¢ºå®šé€²åº¦ï¼šä½¿ç”¨å‹•ç•«
        barEl.className = 'loading-progress-bar indeterminate';
      } else {
        // ç¢ºå®šé€²åº¦ï¼šé¡¯ç¤ºç™¾åˆ†æ¯”
        barEl.className = 'loading-progress-bar';
        var pct = total > 0 ? Math.round((completed / total) * 100) : 0;
        fillEl.style.width = pct + '%';
      }
    }
    
    if (textEl && statusText) {
      textEl.textContent = statusText;
    }
  };
  
  // å®¢æˆ¶ç«¯ ES5 ç›¸å®¹çš„é‡è¤‡å–®å­—åµæ¸¬èˆ‡è‡ªå‹•è™•ç†
  FlashcardApp.prototype.detectAndHandleDuplicatesInMemory = function(allWords) {
    var duplicatesMap = {};
    var i, j, key, word;
    
    // å»ºç«‹å°å¯«è‹±æ–‡ â†’ å–®å­—é™£åˆ—çš„å°æ‡‰è¡¨
    for (i = 0; i < allWords.length; i++) {
      word = allWords[i];
      key = word.english.toLowerCase().trim();
      if (!duplicatesMap[key]) {
        duplicatesMap[key] = [];
      }
      duplicatesMap[key].push(word);
    }
    
    // æ‰¾å‡ºé‡è¤‡çš„å–®å­—
    var duplicates = [];
    for (key in duplicatesMap) {
      if (duplicatesMap.hasOwnProperty(key) && duplicatesMap[key].length > 1) {
        var wordsList = duplicatesMap[key];
        var firstDef = wordsList[0].chinese.toLowerCase().trim();
        var isSameDefinition = true;
        for (j = 1; j < wordsList.length; j++) {
          if (wordsList[j].chinese.toLowerCase().trim() !== firstDef) {
            isSameDefinition = false;
            break;
          }
        }
        duplicates.push({
          english: wordsList[0].english,
          words: wordsList,
          isSameDefinition: isSameDefinition
        });
      }
    }
    
    if (duplicates.length === 0) {
      return { words: allWords, autoHandled: false, autoResults: null };
    }
    
    // åœ¨è¨˜æ†¶é«”ä¸­è‡ªå‹•è™•ç†é‡è¤‡
    var wordsToRemoveIds = {};
    var wordsToModify = {};
    var successCount = 0;
    
    for (i = 0; i < duplicates.length; i++) {
      var dup = duplicates[i];
      if (dup.isSameDefinition) {
        // ä¸­æ–‡ç›¸åŒï¼šä¿ç•™ç¬¬ä¸€å€‹ï¼Œç§»é™¤å…¶é¤˜
        for (j = 1; j < dup.words.length; j++) {
          wordsToRemoveIds[dup.words[j].id] = true;
        }
        successCount++;
      } else {
        // ä¸­æ–‡ä¸åŒï¼šåˆä½µå®šç¾©åˆ°ç¬¬ä¸€å€‹
        var allDefs = [];
        for (j = 0; j < dup.words.length; j++) {
          allDefs.push((j + 1) + '. ' + dup.words[j].chinese.trim());
        }
        var mergedDef = allDefs.join('\n');
        wordsToModify[dup.words[0].id] = mergedDef;
        for (j = 1; j < dup.words.length; j++) {
          wordsToRemoveIds[dup.words[j].id] = true;
        }
        successCount++;
      }
    }
    
    // å»ºç«‹è™•ç†å¾Œçš„å–®å­—é™£åˆ—
    var processedWords = [];
    for (i = 0; i < allWords.length; i++) {
      word = allWords[i];
      if (wordsToRemoveIds[word.id]) continue;
      if (wordsToModify.hasOwnProperty(String(word.id))) {
        // è¤‡è£½ä¸¦ä¿®æ”¹
        var modifiedWord = {};
        for (var prop in word) {
          if (word.hasOwnProperty(prop)) {
            modifiedWord[prop] = word[prop];
          }
        }
        modifiedWord.chinese = wordsToModify[word.id];
        processedWords.push(modifiedWord);
      } else {
        processedWords.push(word);
      }
    }
    
    var removedCount = allWords.length - processedWords.length;
    console.log('å®¢æˆ¶ç«¯é‡è¤‡åµæ¸¬å®Œæˆï¼šç™¼ç¾', duplicates.length, 'çµ„é‡è¤‡ï¼Œç§»é™¤', removedCount, 'å€‹');
    
    return {
      words: processedWords,
      autoHandled: true,
      autoResults: {
        success: true,
        successCount: successCount,
        totalCount: duplicates.length,
        originalCount: allWords.length,
        processedCount: processedWords.length,
        removedCount: removedCount
      }
    };
  };
  
  // é€è¡¨è¼‰å…¥å–®å­—ï¼ˆå«çœŸå¯¦é€²åº¦æ¢ï¼‰
  FlashcardApp.prototype.loadWordsProgressively = function(callback) {
    var self = this;
    var selectedSheets = this.sheetSettings.selectedSheets;
    var sheetId = this.sheetSettings.sheetId;
    var allWords = [];
    var completed = 0;
    var total = selectedSheets.length;
    
    // é¡¯ç¤ºåˆå§‹é€²åº¦
    this.updateLoadingProgress(0, total, 'æ­£åœ¨é€£æ¥ Google Sheet...');
    
    // æ•´é«”è¶…æ™‚
    var loadTimeout = setTimeout(function() {
      console.error('è¼‰å…¥å–®å­—è¶…æ™‚ (' + APP_CONSTANTS.LOAD_TIMEOUT_MS + 'ms)');
      if (allWords.length > 0) {
        self.finishProgressiveLoading(allWords, callback);
      } else {
        self.handleLoadingComplete(false, true);
      }
    }, APP_CONSTANTS.LOAD_TIMEOUT_MS);
    
    // ä¸¦è¡Œè¼‰å…¥å„å·¥ä½œè¡¨
    for (var i = 0; i < selectedSheets.length; i++) {
      (function(sheetName, index) {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.success && result.words) {
              for (var j = 0; j < result.words.length; j++) {
                allWords.push(result.words[j]);
              }
              console.log('å·¥ä½œè¡¨', sheetName, 'è¼‰å…¥æˆåŠŸï¼Œ', result.words.length, 'å€‹å–®å­—');
            } else {
              console.warn('å·¥ä½œè¡¨', sheetName, 'è¼‰å…¥çµæœç•°å¸¸:', result);
            }
            
            completed++;
            self.updateLoadingProgress(completed, total,
              'è¼‰å…¥å·¥ä½œè¡¨ ' + completed + '/' + total + '...');
            
            if (completed >= total) {
              clearTimeout(loadTimeout);
              self.finishProgressiveLoading(allWords, callback);
            }
          })
          .withFailureHandler(function(error) {
            console.error('è¼‰å…¥å·¥ä½œè¡¨å¤±æ•—:', sheetName, error);
            completed++;
            
            self.updateLoadingProgress(completed, total,
              'è¼‰å…¥å·¥ä½œè¡¨ ' + completed + '/' + total + '...');
            
            if (completed >= total) {
              clearTimeout(loadTimeout);
              if (allWords.length > 0) {
                self.finishProgressiveLoading(allWords, callback);
              } else {
                self.handleLoadingComplete(false, true);
              }
            }
          })
          .getWordsFromSingleSheet(sheetId, sheetName);
      })(selectedSheets[i], i);
    }
  };
  
  // å®Œæˆé€è¡¨è¼‰å…¥å¾Œçš„è™•ç†
  FlashcardApp.prototype.finishProgressiveLoading = function(allWords, callback) {
    // é‡æ–°åˆ†é…å”¯ä¸€ ID
    for (var i = 0; i < allWords.length; i++) {
      allWords[i].id = i;
    }
    
    if (allWords.length === 0) {
      this.handleLoadingComplete(false, true);
      return;
    }
    
    this.updateLoadingProgress(1, 1, 'è™•ç†è³‡æ–™ä¸­...');
    
    // å®¢æˆ¶ç«¯åµæ¸¬ä¸¦è‡ªå‹•è™•ç†é‡è¤‡å–®å­—
    var result = this.detectAndHandleDuplicatesInMemory(allWords);
    this.words = result.words;
    
    if (result.autoHandled && result.autoResults && result.autoResults.successCount > 0) {
      this.showAutoProcessingNotification(result.autoResults);
    }
    
    this.updateLoadingProgress(1, 1, 'è¼‰å…¥å®Œæˆï¼');
    callback(false);
  };
  
  // è¼‰å…¥å–®å­—
  FlashcardApp.prototype.loadWords = function(isInitialLoad, callback) {
    var self = this;
    callback = callback || function() {};
    
    // æ¸…ç†å…ˆå‰é åŠ è¼‰çš„åœ–ç‰‡ç¼“å­˜
    this.preloadedImages = {};
    this.currentPreloadingImage = null;
    
    if (this.sheetSettings.sheetId && this.sheetSettings.selectedSheets.length > 0) {
      if (isInitialLoad) {
        // åˆå§‹è¼‰å…¥ï¼šé€è¡¨è¼‰å…¥ï¼Œé¡¯ç¤ºçœŸå¯¦é€²åº¦
        this.loadWordsProgressively(callback);
        return;
      }
      
      // éåˆå§‹è¼‰å…¥ï¼ˆå¾è¨­å®šé‡æ–°è¼‰å…¥ï¼‰ï¼šä½¿ç”¨å–®æ¬¡å‘¼å«
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('è¼‰å…¥çµæœ:', result);
          
          if (result && result.words && result.words.length > 0) {
            self.words = result.words;
            
            if (result.autoHandled) {
              console.log('é‡è¤‡å–®å­—å·²è‡ªå‹•è™•ç†:', result.autoResults);
              if (result.autoResults && result.autoResults.successCount > 0) {
                self.showAutoProcessingNotification(result.autoResults);
              }
              callback(false);
            } else if (result.hasDuplicates && result.duplicates.length > 0) {
              console.log('ç™¼ç¾é‡è¤‡å–®å­—éœ€è¦æ‰‹å‹•è™•ç†:', result.duplicates);
              self.duplicateWords = result.duplicates;
              self.currentDuplicateIndex = 0;
              self.duplicateProcessingResults = [];
              
              if (document.readyState === 'complete') {
                self.showDuplicateModal();
              } else {
                window.addEventListener('load', function() {
                  self.showDuplicateModal();
                });
              }
              callback(true);
              return;
            } else {
              callback(false);
            }
          } else {
            throw new Error('æ²’æœ‰æ‰¾åˆ°å–®å­—è³‡æ–™');
          }
        })
        .withFailureHandler(function(error) {
          console.error('è¼‰å…¥å–®å­—å¤±æ•—:', error);
          self.handleLoadingComplete(false, true);
        })
        .getWordsFromSheetsWithDuplicateDetection(self.sheetSettings.sheetId, self.sheetSettings.selectedSheets, false);
    } else {
      google.script.run
        .withSuccessHandler(function(words) {
          if (words && words.length > 0) {
            self.words = words;
            callback(false);
          } else {
            throw new Error('æ²’æœ‰æ‰¾åˆ°å–®å­—è³‡æ–™');
          }
        })
        .withFailureHandler(function(error) {
          console.error('è¼‰å…¥å–®å­—å¤±æ•—:', error);
          self.handleLoadingComplete(false, true);
        })
        .getWordsFromSheet();
    }
  };
  
</script>

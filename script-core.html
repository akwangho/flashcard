<!-- script-core.html -->
<script>
  
  // å…¨åŸŸ FlashcardApp
  function FlashcardApp() {
    // åˆå§‹åŒ–å±¬æ€§
    this.words = [];
    this.currentWords = [];
    this.currentIndex = 0;
      this.showingChinese = false;
      this.isTransitioning = false;
      this.isProcessingClick = false;
    this.displayTimer = null;
    this.speechSynthesis = window.speechSynthesis;
    this.removedWords = [];
    this.navigationHistory = [];
      this.pendingRemoval = null;
    this.isPaused = false;
    this.userPaused = false;
    this.pausedTimestamp = null;
    this.remainingTime = 0;
    
    // èªéŸ³å•Ÿç”¨ç‹€æ…‹ï¼ˆé©ç”¨æ–¼èˆŠç‰ˆç€è¦½å™¨ï¼‰
    this.speechActivated = false;
    this.isLegacyBrowser = false;
    
    // ä¸­æ–‡èªéŸ³ç­‰å¾…å®šæ™‚å™¨
    this.chineseWaitInterval = null;
    
    // èªéŸ³æ’­æ”¾å®Œæˆç­‰å¾…è¨ˆæ™‚å™¨ï¼ˆç¢ºä¿èªéŸ³å®Œæ•´æ’­æ”¾å¾Œæ‰åˆ‡æ›ï¼‰
    this._speechWaitInterval = null;
    this._speechWaitTimeout = null;
    
    // è¨­å®š
    this.settings = {
      delayTime: 4.5,
      fontSize: 96,
      displayMode: 'english-first',
      fontFamily: 'system-default',
      delaySpeechInNormalMode: false
    };
    
    // æ··åˆæ¨¡å¼ï¼šç•¶å‰å–®å­—æ˜¯å¦åå‘é¡¯ç¤ºï¼ˆæ¯å¼µå¡ç‰‡éš¨æ©Ÿæ±ºå®šï¼‰
    this.currentWordReversed = false;
    
    // å­—å‹æ˜ å°„è¡¨ï¼ˆiPad 4 å…¼å®¹ï¼‰
    this.fontFamilyMap = {
      'system-default': "'Microsoft JhengHei', 'PingFang TC', 'Helvetica Neue', Arial, sans-serif",
      'microsoft-yahei': "'Microsoft JhengHei', 'Microsoft YaHei', 'SimHei', 'Arial Unicode MS', Arial, sans-serif",
      'songti': "'STSong', 'SimSun', 'Times New Roman', serif",
      'kaiti': "'STKaiti', 'KaiTi', 'BiauKai', 'Times New Roman', serif",
      'arial': "Arial, 'Helvetica Neue', Helvetica, sans-serif",
      'helvetica': "'Helvetica Neue', Helvetica, Arial, sans-serif",
      'times': "'Times New Roman', Times, serif",
      'courier': "'Courier New', Courier, monospace",
      'verdana': "Verdana, Geneva, sans-serif"
    };
    
    this.voiceSettings = {
      enabled: true,
      rate: 0.8,
      pitch: 1,
      volume: 1,
      lang: 'en-US',
      voiceURI: '',
      japaneseLang: 'ja-JP',
      japaneseVoiceURI: '',
      spellOutLetters: false,
      chineseEnabled: false,
      chineseLang: 'zh-TW',
      chineseVoiceURI: ''
    };
    
    this.sheetSettings = {
      sheetId: '',
      selectedSheets: []
    };
    
    // åŠŸèƒ½ç‹€æ…‹
    this.difficultyFilter = 0; // 0=ä¸ç¯©é¸, 1-10=æœ€ä½ä¸ç†Ÿç¨‹åº¦
    this.availableSheets = [];
    this.isLoadingWordCounts = false;
    this.listenersSetup = false;
    this.currentSpreadsheetName = null;
    this.duplicateWords = [];
    this.currentDuplicateIndex = 0;
    this.duplicateProcessingResults = [];
    this.progressTimer = null;
    
    this.mustSpellFilter = false; // false=ä¸ç¯©é¸, true=åªé¡¯ç¤ºè¦æœƒæ‹¼
    
    // è¤‡ç¿’æ™‚é–“ç¯©é¸ç›¸é—œ
    this.reviewFilter = 'all'; // 'all', 'never', '2weeks', '1month', '3months', '6months'
    this.reviewedInSession = {}; // key: "sheetName:rowIndex", value: "YYYY-MM-DD"
    this.reviewSyncPending = false;
    this.reviewSyncThreshold = 20; // æ¯ç´¯ç© 20 å€‹å°±åŒæ­¥ä¸€æ¬¡
    
    // åœ–ç‰‡é åŠ è¼‰ç®¡ç†
    this.preloadedImages = {};
    this.currentPreloadingImage = null;

    // é˜²æ­¢è¢å¹•é—œé–‰ç›¸é—œ
    this.wakeLock = null;
    this.noSleepVideo = null;
    this.keepScreenAwake = false;
    
    // SRS é–“éš”é‡è¤‡ç³»çµ±
    this.srsData = {};
    this.srsReviewActive = false;
    this._srsSelectedCount = 10;
    
    // æ¸¬é©—ç›¸é—œå±¬æ€§
    this.quizState = {
      isActive: false,
      type: 'quick', // 'quick' or 'full'
      questions: [],
      currentQuestionIndex: 0,
      selectedAnswer: null,
      answers: [],
      score: 0,
      startTime: null,
      endTime: null
    };
    
    // å•Ÿå‹•åˆå§‹åŒ–
    this.init();
  }
  
  // åˆå§‹åŒ–æ–¹æ³•
  FlashcardApp.prototype.init = function() {
    console.log('=== FlashcardApp åˆå§‹åŒ–é–‹å§‹ (ES5ç‰ˆæœ¬) ===');
    try {
      console.log('è¼‰å…¥åŸºæœ¬è¨­å®š...');
      this.loadSettings();
      this.loadSheetSettings();
      this.loadSrsData();
      
      console.log('Sheet è¨­å®š:', this.sheetSettings);
      
      // æª¢æ¸¬ç€è¦½å™¨æ˜¯å¦éœ€è¦èªéŸ³äº¤äº’
      this.detectLegacyBrowser();
      
      console.log('è¨­å®šäº‹ä»¶ç›£è½å™¨...');
      this.setupEventListeners();
      
      // æª¢æŸ¥æ˜¯å¦æœ‰å·²è¨­å®šçš„ Google Sheet
      if (this.sheetSettings.sheetId && this.sheetSettings.selectedSheets.length > 0) {
        console.log('ç™¼ç¾å·²è¨­å®šçš„ Google Sheetï¼Œè¼‰å…¥å–®å­—...');
        var self = this;
        this.loadWords(true, function(hasDuplicates) {
          self.handleLoadingComplete(hasDuplicates);
        });
        } else {
        console.log('æ²’æœ‰æ‰¾åˆ° Google Sheet è¨­å®šï¼Œé¡¯ç¤ºè¨­å®šç•«é¢');
        this.handleLoadingComplete(false, true);
        return;
      }
      
      console.log('=== FlashcardApp åˆå§‹åŒ–å®Œæˆ ===');
    } catch (error) {
      console.error('åˆå§‹åŒ–éŒ¯èª¤:', error);
      this.showError();
    }
    
    // åˆå§‹åŒ–æŒ‰éˆ•ç‹€æ…‹
    this.updateVoiceButtonState();
    this.updatePauseButtonState();
    
    // å•Ÿç”¨é˜²æ­¢è¢å¹•é—œé–‰åŠŸèƒ½
    this.enableKeepScreenAwake();
  };
  
  // æª¢æ¸¬èˆŠç‰ˆç€è¦½å™¨
  FlashcardApp.prototype.detectLegacyBrowser = function() {
    var userAgent = navigator.userAgent;
    var isIOS = /iPad|iPhone|iPod/.test(userAgent);
    var iosVersion = null;
    var isOldChrome = false;
    
    if (isIOS) {
      var match = userAgent.match(/OS (\d+)_/);
      if (match) {
        iosVersion = parseInt(match[1]);
      }
    }
    
    // æª¢æ¸¬èˆŠç‰ˆChromeï¼ˆç‰ˆæœ¬ä½æ–¼80ï¼‰
    var chromeMatch = userAgent.match(/Chrome\/(\d+)/);
    if (chromeMatch) {
      var chromeVersion = parseInt(chromeMatch[1]);
      isOldChrome = chromeVersion < 80;
    }
    
    // æª¢æ¸¬éœ€è¦ç”¨æˆ¶äº¤äº’æ‰èƒ½æ’­æ”¾èªéŸ³çš„ç€è¦½å™¨ï¼š
    // 1. iPad/iOS 10åŠä»¥ä¸‹ç‰ˆæœ¬
    // 2. èˆŠç‰ˆChromeï¼ˆç‰ˆæœ¬ä½æ–¼80ï¼‰
    // 3. Safari 12åŠä»¥ä¸‹ç‰ˆæœ¬
    this.isLegacyBrowser = (isIOS && iosVersion && iosVersion <= 10) || 
                          isOldChrome ||
                          userAgent.indexOf('Safari') !== -1 && userAgent.indexOf('Chrome') === -1 && 
                          userAgent.match(/Version\/(\d+)/) && parseInt(userAgent.match(/Version\/(\d+)/)[1]) <= 12;
    
    // æ–°ç‰ˆç€è¦½å™¨è‡ªå‹•å•Ÿç”¨èªéŸ³
    if (!this.isLegacyBrowser) {
      this.speechActivated = true;
    }
    
    console.log('ç€è¦½å™¨æª¢æ¸¬çµæœ:', {
      userAgent: userAgent,
      isIOS: isIOS,
      iosVersion: iosVersion,
      isOldChrome: isOldChrome,
      isLegacyBrowser: this.isLegacyBrowser,
      speechActivated: this.speechActivated
    });
  };
  
  // è™•ç†è¼‰å…¥å®Œæˆ
  FlashcardApp.prototype.handleLoadingComplete = function(hasDuplicates, shouldOpenSettings) {
    if (this.isLegacyBrowser && !this.speechActivated) {
      // èˆŠç‰ˆç€è¦½å™¨é¡¯ç¤ºèªéŸ³å•Ÿç”¨æŒ‰éˆ•
      this.showSpeechActivation();
    } else {
      // æ–°ç‰ˆç€è¦½å™¨æˆ–å·²å•Ÿç”¨èªéŸ³ï¼Œç›´æ¥é€²å…¥ä¸»ç•«é¢
      this.hideLoading();
      this.applySettings();
      
      if (shouldOpenSettings) {
        this.openSheetSettings();
      } else if (!hasDuplicates) {
        this.startNewRound();
      }
      
      // æ›´æ–° SRS å¾½ç« 
      this.updateSrsBadge();
    }
  };
  
  // è¼‰å…¥è¨­å®š
  FlashcardApp.prototype.loadSettings = function() {
    try {
      var savedSettings = JSON.parse(localStorage.getItem('flashcard-settings') || '{}');
      
      // å‘å¾Œç›¸å®¹ï¼šå°‡èˆŠç‰ˆ reverseMode (boolean) é·ç§»è‡³æ–°ç‰ˆ displayMode (string)
      if (savedSettings.hasOwnProperty('reverseMode') && !savedSettings.hasOwnProperty('displayMode')) {
        savedSettings.displayMode = savedSettings.reverseMode ? 'chinese-first' : 'english-first';
        delete savedSettings.reverseMode;
      }
      
      for (var key in savedSettings) {
        if (savedSettings.hasOwnProperty(key) && this.settings.hasOwnProperty(key)) {
          this.settings[key] = savedSettings[key];
        }
      }
      
      var savedVoiceSettings = JSON.parse(localStorage.getItem('flashcard-voice-settings') || '{}');
      for (var key in savedVoiceSettings) {
        if (savedVoiceSettings.hasOwnProperty(key) && this.voiceSettings.hasOwnProperty(key)) {
          this.voiceSettings[key] = savedVoiceSettings[key];
        }
      }
    } catch (e) {
      console.log('è¼‰å…¥è¨­å®šå¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼');
    }
  };
  
  // è¼‰å…¥Sheetè¨­å®š
  FlashcardApp.prototype.loadSheetSettings = function() {
    try {
      var savedSheetSettings = JSON.parse(localStorage.getItem('flashcard-sheet-settings') || '{}');
      for (var key in savedSheetSettings) {
        if (savedSheetSettings.hasOwnProperty(key) && this.sheetSettings.hasOwnProperty(key)) {
          this.sheetSettings[key] = savedSheetSettings[key];
        }
      }
    } catch (e) {
      console.log('è¼‰å…¥Sheetè¨­å®šå¤±æ•—');
    }
  };
  
  // å„²å­˜è¨­å®š
  FlashcardApp.prototype.saveSettings = function() {
    localStorage.setItem('flashcard-settings', JSON.stringify(this.settings));
    localStorage.setItem('flashcard-voice-settings', JSON.stringify(this.voiceSettings));
  };
  
  // å„²å­˜Sheetè¨­å®š
  FlashcardApp.prototype.saveSheetSettings = function() {
    localStorage.setItem('flashcard-sheet-settings', JSON.stringify(this.sheetSettings));
  };
  
  // ç²å–é è¨­Sheetåˆ—è¡¨
  FlashcardApp.prototype.getDefaultSheets = function() {
    return [
      {
        id: '1jrpECEaDgtcXawdO9Rl4raHZ_sqmvnUm7x0bJ4IqfRM',
        name: 'WordGo Data Sheet',
        isDefault: true
      },
      {
        id: '1hX2Ux2__5F-jdhfegmzMBZ7bg3faOt06ARb7ezC8Yzg',
        name: 'å°å­¸ç”Ÿæ•™è‚²éƒ¨è¦å®š1200å–®å­—',
        isDefault: true
      }
    ];
  };
  
  // æª¢æŸ¥æ˜¯å¦ç‚ºé è¨­Sheet
  FlashcardApp.prototype.isDefaultSheet = function(sheetId) {
    var defaultSheets = this.getDefaultSheets();
    for (var i = 0; i < defaultSheets.length; i++) {
      if (defaultSheets[i].id === sheetId) {
        return true;
      }
    }
    return false;
  };
  
  // è¼‰å…¥Sheetæ­·å²è¨˜éŒ„ï¼ˆä¸åŒ…å«é è¨­æª”æ¡ˆï¼‰
  FlashcardApp.prototype.loadSheetHistory = function() {
    try {
      var history = JSON.parse(localStorage.getItem('flashcard-sheet-history') || '[]');
      
      // éæ¿¾æ‰ä»»ä½•å¯èƒ½æ··å…¥çš„é è¨­æª”æ¡ˆ
      var filteredHistory = [];
      for (var i = 0; i < history.length; i++) {
        if (!this.isDefaultSheet(history[i].id)) {
          filteredHistory.push(history[i]);
        }
      }
      
      return filteredHistory;
    } catch (e) {
      console.log('è¼‰å…¥Sheetæ­·å²è¨˜éŒ„å¤±æ•—ï¼Œè¿”å›ç©ºé™£åˆ—');
      return [];
    }
  };
  
  // å„²å­˜Sheetæ­·å²è¨˜éŒ„
  FlashcardApp.prototype.saveSheetHistory = function(history) {
    try {
      localStorage.setItem('flashcard-sheet-history', JSON.stringify(history));
    } catch (e) {
      console.error('å„²å­˜Sheetæ­·å²è¨˜éŒ„å¤±æ•—:', e);
    }
  };
  
  // æ·»åŠ åˆ°Sheetæ­·å²è¨˜éŒ„
  FlashcardApp.prototype.addToSheetHistory = function(sheetId, sheetName) {
    try {
      console.log('æ·»åŠ åˆ°æ­·å²è¨˜éŒ„:', sheetId, sheetName);
      
      // æª¢æŸ¥æ˜¯å¦ç‚ºé è¨­æª”æ¡ˆï¼Œå¦‚æœæ˜¯å‰‡ä¸æ·»åŠ 
      if (this.isDefaultSheet(sheetId)) {
        console.log('é€™æ˜¯é è¨­æª”æ¡ˆï¼Œä¸æ·»åŠ åˆ°æ­·å²è¨˜éŒ„');
        return;
      }
      
      var history = this.loadSheetHistory();
      
      // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
      var existingIndex = -1;
      for (var i = 0; i < history.length; i++) {
        if (history[i].id === sheetId) {
          existingIndex = i;
          break;
        }
      }
      
      if (existingIndex !== -1) {
        // å¦‚æœå·²å­˜åœ¨ï¼Œæ›´æ–°åç¨±ä¸¦ç§»åˆ°æœ€å‰é¢
        history[existingIndex].name = sheetName;
        history[existingIndex].lastUsed = new Date().toISOString();
        var item = history.splice(existingIndex, 1)[0];
        history.unshift(item);
      } else {
        // æ–°é …ç›®ï¼Œæ·»åŠ åˆ°æœ€å‰é¢
        history.unshift({
          id: sheetId,
          name: sheetName,
          isDefault: false,
          lastUsed: new Date().toISOString()
        });
      }
      
      // é™åˆ¶æ­·å²è¨˜éŒ„æ•¸é‡ç‚º10å€‹
      if (history.length > 10) {
        history = history.slice(0, 10);
      }
      
      this.saveSheetHistory(history);
      console.log('æ­·å²è¨˜éŒ„å·²æ›´æ–°ï¼Œç¸½æ•¸:', history.length);
    } catch (e) {
      console.error('æ·»åŠ åˆ°æ­·å²è¨˜éŒ„å¤±æ•—:', e);
    }
  };
  
  // é¡¯ç¤ºSheetæ­·å²è¨˜éŒ„
  FlashcardApp.prototype.displaySheetHistory = function() {
    // é¡¯ç¤ºé è¨­æª”æ¡ˆ
    this.displayDefaultSheets();
    
    // é¡¯ç¤ºæœ€è¿‘ä½¿ç”¨çš„æª”æ¡ˆ
    this.displayRecentSheets();
  };
  
  // é¡¯ç¤ºé è¨­æª”æ¡ˆåˆ—è¡¨
  FlashcardApp.prototype.displayDefaultSheets = function() {
    var defaultList = document.getElementById('default-sheets-list');
    if (!defaultList) {
      console.error('æ‰¾ä¸åˆ°default-sheets-listå…ƒç´ ');
      return;
    }
    
    var defaultSheets = this.getDefaultSheets();
    console.log('é¡¯ç¤ºé è¨­æª”æ¡ˆï¼Œç¸½æ•¸:', defaultSheets.length);
    
    var html = '';
    for (var i = 0; i < defaultSheets.length; i++) {
      var item = defaultSheets[i];
      
      html += '<div class="sheet-history-item default-sheet" data-sheet-id="' + item.id + '">';
      html += '  <div class="sheet-history-info">';
      html += '    <div class="sheet-history-name">' + item.name + '</div>';
      html += '    <div class="sheet-history-id">' + item.id + '</div>';
      html += '  </div>';
      html += '  <span class="sheet-history-badge">é è¨­</span>';
      html += '</div>';
    }
    
    defaultList.innerHTML = html;
    
    // æ·»åŠ é»æ“Šäº‹ä»¶
    var self = this;
    var items = defaultList.querySelectorAll('.sheet-history-item');
    for (var i = 0; i < items.length; i++) {
      (function(item) {
        item.addEventListener('click', function() {
          var sheetId = item.getAttribute('data-sheet-id');
          self.selectSheetFromHistory(sheetId);
        });
      })(items[i]);
    }
  };
  
  // é¡¯ç¤ºæœ€è¿‘ä½¿ç”¨çš„æª”æ¡ˆåˆ—è¡¨
  FlashcardApp.prototype.displayRecentSheets = function() {
    var recentList = document.getElementById('recent-sheets-list');
    if (!recentList) {
      console.error('æ‰¾ä¸åˆ°recent-sheets-listå…ƒç´ ');
      return;
    }
    
    var history = this.loadSheetHistory();
    console.log('é¡¯ç¤ºæœ€è¿‘ä½¿ç”¨çš„æª”æ¡ˆï¼Œç¸½æ•¸:', history.length);
    
    if (history.length === 0) {
      recentList.innerHTML = '<div class="sheet-history-empty">å°šç„¡ä½¿ç”¨è¨˜éŒ„</div>';
      return;
    }
    
    var html = '';
    for (var i = 0; i < history.length; i++) {
      var item = history[i];
      
      html += '<div class="sheet-history-item recent-sheet" data-sheet-id="' + item.id + '">';
      html += '  <div class="sheet-history-info">';
      html += '    <div class="sheet-history-name">' + item.name + '</div>';
      html += '    <div class="sheet-history-id">' + item.id + '</div>';
      html += '  </div>';
      html += '  <button class="sheet-history-delete" data-sheet-id="' + item.id + '" title="åˆªé™¤">ğŸ—‘ï¸</button>';
      html += '</div>';
    }
    
    recentList.innerHTML = html;
    
    // æ·»åŠ é»æ“Šäº‹ä»¶ï¼ˆé¸æ“‡æª”æ¡ˆï¼‰
    var self = this;
    var items = recentList.querySelectorAll('.sheet-history-item');
    for (var i = 0; i < items.length; i++) {
      (function(item) {
        item.addEventListener('click', function(e) {
          // å¦‚æœé»æ“Šçš„æ˜¯åˆªé™¤æŒ‰éˆ•ï¼Œä¸åŸ·è¡Œé¸æ“‡æ“ä½œ
          if (e.target.classList.contains('sheet-history-delete')) {
            return;
          }
          var sheetId = item.getAttribute('data-sheet-id');
          self.selectSheetFromHistory(sheetId);
        });
      })(items[i]);
    }
    
    // æ·»åŠ åˆªé™¤æŒ‰éˆ•äº‹ä»¶
    var deleteButtons = recentList.querySelectorAll('.sheet-history-delete');
    for (var i = 0; i < deleteButtons.length; i++) {
      (function(button) {
        button.addEventListener('click', function(e) {
          e.stopPropagation(); // é˜²æ­¢è§¸ç™¼çˆ¶å…ƒç´ çš„é»æ“Šäº‹ä»¶
          var sheetId = button.getAttribute('data-sheet-id');
          self.removeFromSheetHistory(sheetId);
        });
      })(deleteButtons[i]);
    }
  };
  
  // å¾æ­·å²è¨˜éŒ„ä¸­åˆªé™¤
  FlashcardApp.prototype.removeFromSheetHistory = function(sheetId) {
    try {
      console.log('å¾æ­·å²è¨˜éŒ„åˆªé™¤:', sheetId);
      
      var history = this.loadSheetHistory();
      var newHistory = [];
      
      for (var i = 0; i < history.length; i++) {
        if (history[i].id !== sheetId) {
          newHistory.push(history[i]);
        }
      }
      
      this.saveSheetHistory(newHistory);
      console.log('å·²åˆªé™¤ï¼Œå‰©é¤˜è¨˜éŒ„æ•¸:', newHistory.length);
      
      // é‡æ–°é¡¯ç¤ºåˆ—è¡¨
      this.displayRecentSheets();
    } catch (e) {
      console.error('åˆªé™¤æ­·å²è¨˜éŒ„å¤±æ•—:', e);
    }
  };
  
  // å¾æ­·å²è¨˜éŒ„é¸æ“‡Sheet
  FlashcardApp.prototype.selectSheetFromHistory = function(sheetId) {
    console.log('å¾æ­·å²è¨˜éŒ„é¸æ“‡Sheet:', sheetId);
    
    var sheetIdInput = document.getElementById('sheet-id-input');
    if (sheetIdInput) {
      sheetIdInput.value = sheetId;
      
      // è‡ªå‹•è¼‰å…¥å·¥ä½œè¡¨æ¸…å–®ï¼ˆéš±è—éå¿…è¦å€å¡Šçš„é‚è¼¯å·²ç§»è‡³ updateSheetLoadingUIï¼‰
      this.loadSheetsList();
    }
  };
  
  // æ‡‰ç”¨è¨­å®š
  FlashcardApp.prototype.applySettings = function() {
    var englishWord = document.getElementById('english-word');
    var chineseWord = document.getElementById('chinese-word');
    var loadingText = document.querySelector('#loading p');
    
    // æ‡‰ç”¨å­—é«”å¤§å°
    if (englishWord) englishWord.style.fontSize = this.settings.fontSize + 'px';
    if (chineseWord) chineseWord.style.fontSize = this.settings.fontSize + 'px';
    if (loadingText) loadingText.style.fontSize = this.settings.fontSize + 'px';
    
    // æ‡‰ç”¨å­—å‹
    this.applyFontFamily();
    
    var delaySlider = document.getElementById('delay-setting');
    var fontSizeSlider = document.getElementById('font-size-setting');
    var fontFamilySelect = document.getElementById('font-family-setting');
    var delaySpeechToggle = document.getElementById('delay-speech-setting');
    var delayValue = document.getElementById('delay-value');
    var fontSizeValue = document.getElementById('font-size-value');
    
    if (delaySlider && delayValue) {
      delaySlider.value = this.settings.delayTime;
      // ä¿®å¾©æµ®é»æ•¸ç²¾åº¦å•é¡Œ
      var step = parseFloat(delaySlider.step) || 0.5;
      var decimalPlaces = step.toString().indexOf('.') !== -1 ? step.toString().split('.')[1].length : 0;
      var formattedDelayTime = parseFloat(this.settings.delayTime.toFixed(decimalPlaces));
      delayValue.textContent = formattedDelayTime;
    }
    if (fontSizeSlider && fontSizeValue) {
      fontSizeSlider.value = this.settings.fontSize;
      fontSizeValue.textContent = this.settings.fontSize + 'px';
    }
    if (fontFamilySelect) {
      fontFamilySelect.value = this.settings.fontFamily;
    }
    // è¨­å®šé¡¯ç¤ºæ¨¡å¼ radio buttons
    var displayModeRadios = document.querySelectorAll('input[name="display-mode"]');
    for (var i = 0; i < displayModeRadios.length; i++) {
      displayModeRadios[i].checked = (displayModeRadios[i].value === this.settings.displayMode);
    }
    if (delaySpeechToggle) delaySpeechToggle.checked = this.settings.delaySpeechInNormalMode;
    
    // æ›´æ–°å­—å‹é è¦½
    this.updateFontPreview();
    
    // æ‡‰ç”¨åœ–ç‰‡ç¸®æ”¾è¨­å®šï¼ˆæ°¸é ä½¿ç”¨ä¸è£åˆ‡æ¨¡å¼ï¼‰
    this.applyImageFitMode();
  };
  
  // æ‡‰ç”¨åœ–ç‰‡ç¸®æ”¾è¨­å®šï¼ˆæ°¸é ä½¿ç”¨ä¸è£åˆ‡æ¨¡å¼ï¼‰
  FlashcardApp.prototype.applyImageFitMode = function() {
    var flashcardDiv = document.getElementById('flashcard');
    if (flashcardDiv) {
      // æ°¸é ä½¿ç”¨containæ¨¡å¼ï¼ˆä¸è£åˆ‡ï¼‰
      flashcardDiv.classList.add('image-fit-contain');
      flashcardDiv.classList.remove('image-fit-cover');
    }
  };
  
  // æ‡‰ç”¨å­—å‹è¨­å®š
  FlashcardApp.prototype.applyFontFamily = function() {
    var fontFamily = this.fontFamilyMap[this.settings.fontFamily] || this.fontFamilyMap['system-default'];
    
    // æ‡‰ç”¨åˆ°ä¸»è¦å…ƒç´ 
    var elements = [
      document.getElementById('english-word'),
      document.getElementById('chinese-word'),
      document.querySelector('#loading p'),
      document.body // æ‡‰ç”¨åˆ°æ•´å€‹bodyä½œç‚ºfallback
    ];
    
    for (var i = 0; i < elements.length; i++) {
      if (elements[i]) {
        elements[i].style.fontFamily = fontFamily;
      }
    }
    
    console.log('å·²æ‡‰ç”¨å­—å‹:', this.settings.fontFamily, 'â†’', fontFamily);
  };
  
  // æ›´æ–°å­—å‹é è¦½
  FlashcardApp.prototype.updateFontPreview = function() {
    var previewEnglish = document.querySelector('.preview-english');
    var previewChinese = document.querySelector('.preview-chinese');
    var fontFamily = this.fontFamilyMap[this.settings.fontFamily] || this.fontFamilyMap['system-default'];
    
    if (previewEnglish) {
      previewEnglish.style.fontFamily = fontFamily;
    }
    if (previewChinese) {
      previewChinese.style.fontFamily = fontFamily;
    }
  };
  
  // åˆ¤æ–·æ˜¯å¦åœ¨æ¸¬é©—é€²è¡Œä¸­
  FlashcardApp.prototype.isQuizInProgress = function() {
    var progressScreen = document.getElementById('quiz-progress-screen');
    return progressScreen && progressScreen.style.display !== 'none';
  };
  
  // ä¿è­·selectå…ƒç´ ä¸å—å…¨åŸŸäº‹ä»¶å¹²æ“¾
  FlashcardApp.prototype.protectSelectElement = function(selectElement) {
    if (!selectElement) return;
    
    console.log('ç‚ºselectå…ƒç´ æ·»åŠ ä¿è­·:', selectElement.id || selectElement.className);
    
    // é˜»æ­¢æ‰€æœ‰å¯èƒ½å°è‡´å•é¡Œçš„äº‹ä»¶å†’æ³¡
    var eventsToProtect = ['click', 'mousedown', 'mouseup', 'focus', 'blur'];
    
    for (var i = 0; i < eventsToProtect.length; i++) {
      var eventType = eventsToProtect[i];
      
      (function(eventName) {
        selectElement.addEventListener(eventName, function(e) {
          console.log('Select ' + eventName + ' äº‹ä»¶ï¼Œé˜»æ­¢å†’æ³¡');
          e.stopPropagation();
          
          // å°æ–¼focusäº‹ä»¶ï¼Œç¢ºä¿selectç²å¾—ç„¦é»
          if (eventName === 'focus') {
            console.log('Selectç²å¾—ç„¦é»');
          }
          // å°æ–¼bluräº‹ä»¶ï¼Œè¨˜éŒ„å¤±å»ç„¦é»
          else if (eventName === 'blur') {
            console.log('Selectå¤±å»ç„¦é»');
          }
        }, true); // ä½¿ç”¨æ•ç²éšæ®µ
      })(eventType);
    }
    
    // ç‰¹åˆ¥è™•ç†éµç›¤äº‹ä»¶
    selectElement.addEventListener('keydown', function(e) {
      console.log('Select keydown äº‹ä»¶:', e.keyCode);
      e.stopPropagation();
      // ä¸èª¿ç”¨preventDefaultï¼Œè®“selectæ­£å¸¸è™•ç†éµç›¤è¼¸å…¥
    }, true);
    
    selectElement.addEventListener('keyup', function(e) {
      e.stopPropagation();
    }, true);
    
    // ç¢ºä¿selectå…ƒç´ æœ‰æ­£ç¢ºçš„æ¨£å¼
    selectElement.style.position = 'relative';
    selectElement.style.zIndex = '2100';
  };
  
  // æ›´æ–°è¼‰å…¥ç•«é¢é€²åº¦æ¢
  FlashcardApp.prototype.updateLoadingProgress = function(completed, total, statusText) {
    var fillEl = document.getElementById('loading-progress-fill');
    var textEl = document.getElementById('loading-status-text');
    var barEl = document.getElementById('loading-progress-bar');
    
    if (fillEl && barEl) {
      if (completed <= 0 && total > 0) {
        // ä¸ç¢ºå®šé€²åº¦ï¼šä½¿ç”¨å‹•ç•«
        barEl.className = 'loading-progress-bar indeterminate';
      } else {
        // ç¢ºå®šé€²åº¦ï¼šé¡¯ç¤ºç™¾åˆ†æ¯”
        barEl.className = 'loading-progress-bar';
        var pct = total > 0 ? Math.round((completed / total) * 100) : 0;
        fillEl.style.width = pct + '%';
      }
    }
    
    if (textEl && statusText) {
      textEl.textContent = statusText;
    }
  };
  
  // å®¢æˆ¶ç«¯ ES5 ç›¸å®¹çš„é‡è¤‡å–®å­—åµæ¸¬èˆ‡è‡ªå‹•è™•ç†
  FlashcardApp.prototype.detectAndHandleDuplicatesInMemory = function(allWords) {
    var duplicatesMap = {};
    var i, j, key, word;
    
    // å»ºç«‹å°å¯«è‹±æ–‡ â†’ å–®å­—é™£åˆ—çš„å°æ‡‰è¡¨
    for (i = 0; i < allWords.length; i++) {
      word = allWords[i];
      key = word.english.toLowerCase().trim();
      if (!duplicatesMap[key]) {
        duplicatesMap[key] = [];
      }
      duplicatesMap[key].push(word);
    }
    
    // æ‰¾å‡ºé‡è¤‡çš„å–®å­—
    var duplicates = [];
    for (key in duplicatesMap) {
      if (duplicatesMap.hasOwnProperty(key) && duplicatesMap[key].length > 1) {
        var wordsList = duplicatesMap[key];
        var firstDef = wordsList[0].chinese.toLowerCase().trim();
        var isSameDefinition = true;
        for (j = 1; j < wordsList.length; j++) {
          if (wordsList[j].chinese.toLowerCase().trim() !== firstDef) {
            isSameDefinition = false;
            break;
          }
        }
        duplicates.push({
          english: wordsList[0].english,
          words: wordsList,
          isSameDefinition: isSameDefinition
        });
      }
    }
    
    if (duplicates.length === 0) {
      return { words: allWords, autoHandled: false, autoResults: null };
    }
    
    // åœ¨è¨˜æ†¶é«”ä¸­è‡ªå‹•è™•ç†é‡è¤‡
    var wordsToRemoveIds = {};
    var wordsToModify = {};
    var successCount = 0;
    
    for (i = 0; i < duplicates.length; i++) {
      var dup = duplicates[i];
      if (dup.isSameDefinition) {
        // ä¸­æ–‡ç›¸åŒï¼šä¿ç•™ç¬¬ä¸€å€‹ï¼Œç§»é™¤å…¶é¤˜
        for (j = 1; j < dup.words.length; j++) {
          wordsToRemoveIds[dup.words[j].id] = true;
        }
        successCount++;
      } else {
        // ä¸­æ–‡ä¸åŒï¼šåˆä½µå®šç¾©åˆ°ç¬¬ä¸€å€‹
        var allDefs = [];
        for (j = 0; j < dup.words.length; j++) {
          allDefs.push((j + 1) + '. ' + dup.words[j].chinese.trim());
        }
        var mergedDef = allDefs.join('\n');
        wordsToModify[dup.words[0].id] = mergedDef;
        for (j = 1; j < dup.words.length; j++) {
          wordsToRemoveIds[dup.words[j].id] = true;
        }
        successCount++;
      }
    }
    
    // å»ºç«‹è™•ç†å¾Œçš„å–®å­—é™£åˆ—
    var processedWords = [];
    for (i = 0; i < allWords.length; i++) {
      word = allWords[i];
      if (wordsToRemoveIds[word.id]) continue;
      if (wordsToModify.hasOwnProperty(String(word.id))) {
        // è¤‡è£½ä¸¦ä¿®æ”¹
        var modifiedWord = {};
        for (var prop in word) {
          if (word.hasOwnProperty(prop)) {
            modifiedWord[prop] = word[prop];
          }
        }
        modifiedWord.chinese = wordsToModify[word.id];
        processedWords.push(modifiedWord);
      } else {
        processedWords.push(word);
      }
    }
    
    var removedCount = allWords.length - processedWords.length;
    console.log('å®¢æˆ¶ç«¯é‡è¤‡åµæ¸¬å®Œæˆï¼šç™¼ç¾', duplicates.length, 'çµ„é‡è¤‡ï¼Œç§»é™¤', removedCount, 'å€‹');
    
    return {
      words: processedWords,
      autoHandled: true,
      autoResults: {
        success: true,
        successCount: successCount,
        totalCount: duplicates.length,
        originalCount: allWords.length,
        processedCount: processedWords.length,
        removedCount: removedCount
      }
    };
  };
  
  // é€è¡¨è¼‰å…¥å–®å­—ï¼ˆå«çœŸå¯¦é€²åº¦æ¢ï¼‰
  FlashcardApp.prototype.loadWordsProgressively = function(callback) {
    var self = this;
    var selectedSheets = this.sheetSettings.selectedSheets;
    var sheetId = this.sheetSettings.sheetId;
    var allWords = [];
    var completed = 0;
    var total = selectedSheets.length;
    
    // é¡¯ç¤ºåˆå§‹é€²åº¦
    this.updateLoadingProgress(0, total, 'æ­£åœ¨é€£æ¥ Google Sheet...');
    
    // æ•´é«”è¶…æ™‚ï¼š30 ç§’
    var loadTimeout = setTimeout(function() {
      console.error('è¼‰å…¥å–®å­—è¶…æ™‚ (30ç§’)');
      if (allWords.length > 0) {
        self.finishProgressiveLoading(allWords, callback);
      } else {
        self.showError();
      }
    }, 30000);
    
    // ä¸¦è¡Œè¼‰å…¥å„å·¥ä½œè¡¨
    for (var i = 0; i < selectedSheets.length; i++) {
      (function(sheetName, index) {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.success && result.words) {
              for (var j = 0; j < result.words.length; j++) {
                allWords.push(result.words[j]);
              }
              console.log('å·¥ä½œè¡¨', sheetName, 'è¼‰å…¥æˆåŠŸï¼Œ', result.words.length, 'å€‹å–®å­—');
            } else {
              console.warn('å·¥ä½œè¡¨', sheetName, 'è¼‰å…¥çµæœç•°å¸¸:', result);
            }
            
            completed++;
            self.updateLoadingProgress(completed, total,
              'è¼‰å…¥å·¥ä½œè¡¨ ' + completed + '/' + total + '...');
            
            if (completed >= total) {
              clearTimeout(loadTimeout);
              self.finishProgressiveLoading(allWords, callback);
            }
          })
          .withFailureHandler(function(error) {
            console.error('è¼‰å…¥å·¥ä½œè¡¨å¤±æ•—:', sheetName, error);
            completed++;
            
            self.updateLoadingProgress(completed, total,
              'è¼‰å…¥å·¥ä½œè¡¨ ' + completed + '/' + total + '...');
            
            if (completed >= total) {
              clearTimeout(loadTimeout);
              if (allWords.length > 0) {
                self.finishProgressiveLoading(allWords, callback);
              } else {
                self.showError();
              }
            }
          })
          .getWordsFromSingleSheet(sheetId, sheetName);
      })(selectedSheets[i], i);
    }
  };
  
  // å®Œæˆé€è¡¨è¼‰å…¥å¾Œçš„è™•ç†
  FlashcardApp.prototype.finishProgressiveLoading = function(allWords, callback) {
    // é‡æ–°åˆ†é…å”¯ä¸€ ID
    for (var i = 0; i < allWords.length; i++) {
      allWords[i].id = i;
    }
    
    if (allWords.length === 0) {
      this.showError();
      return;
    }
    
    this.updateLoadingProgress(1, 1, 'è™•ç†è³‡æ–™ä¸­...');
    
    // å®¢æˆ¶ç«¯åµæ¸¬ä¸¦è‡ªå‹•è™•ç†é‡è¤‡å–®å­—
    var result = this.detectAndHandleDuplicatesInMemory(allWords);
    this.words = result.words;
    
    if (result.autoHandled && result.autoResults && result.autoResults.successCount > 0) {
      this.showAutoProcessingNotification(result.autoResults);
    }
    
    this.updateLoadingProgress(1, 1, 'è¼‰å…¥å®Œæˆï¼');
    callback(false);
  };
  
  // è¼‰å…¥å–®å­—
  FlashcardApp.prototype.loadWords = function(isInitialLoad, callback) {
    var self = this;
    callback = callback || function() {};
    
    // æ¸…ç†å…ˆå‰é åŠ è¼‰çš„åœ–ç‰‡ç¼“å­˜
    this.preloadedImages = {};
    this.currentPreloadingImage = null;
    
    if (this.sheetSettings.sheetId && this.sheetSettings.selectedSheets.length > 0) {
      if (isInitialLoad) {
        // åˆå§‹è¼‰å…¥ï¼šé€è¡¨è¼‰å…¥ï¼Œé¡¯ç¤ºçœŸå¯¦é€²åº¦
        this.loadWordsProgressively(callback);
        return;
      }
      
      // éåˆå§‹è¼‰å…¥ï¼ˆå¾è¨­å®šé‡æ–°è¼‰å…¥ï¼‰ï¼šä½¿ç”¨å–®æ¬¡å‘¼å«
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('è¼‰å…¥çµæœ:', result);
          
          if (result && result.words && result.words.length > 0) {
            self.words = result.words;
            
            if (result.autoHandled) {
              console.log('é‡è¤‡å–®å­—å·²è‡ªå‹•è™•ç†:', result.autoResults);
              if (result.autoResults && result.autoResults.successCount > 0) {
                self.showAutoProcessingNotification(result.autoResults);
              }
              callback(false);
            } else if (result.hasDuplicates && result.duplicates.length > 0) {
              console.log('ç™¼ç¾é‡è¤‡å–®å­—éœ€è¦æ‰‹å‹•è™•ç†:', result.duplicates);
              self.duplicateWords = result.duplicates;
              self.currentDuplicateIndex = 0;
              self.duplicateProcessingResults = [];
              
              if (document.readyState === 'complete') {
                self.showDuplicateModal();
              } else {
                window.addEventListener('load', function() {
                  self.showDuplicateModal();
                });
              }
              callback(true);
              return;
            } else {
              callback(false);
            }
          } else {
            throw new Error('æ²’æœ‰æ‰¾åˆ°å–®å­—è³‡æ–™');
          }
        })
        .withFailureHandler(function(error) {
          console.error('è¼‰å…¥å–®å­—å¤±æ•—:', error);
          self.showError();
        })
        .getWordsFromSheetsWithDuplicateDetection(self.sheetSettings.sheetId, self.sheetSettings.selectedSheets, false);
    } else {
      google.script.run
        .withSuccessHandler(function(words) {
          if (words && words.length > 0) {
            self.words = words;
            callback(false);
          } else {
            throw new Error('æ²’æœ‰æ‰¾åˆ°å–®å­—è³‡æ–™');
          }
        })
        .withFailureHandler(function(error) {
          console.error('è¼‰å…¥å–®å­—å¤±æ•—:', error);
          self.showError();
        })
        .getWordsFromSheet();
    }
  };
  
</script>
